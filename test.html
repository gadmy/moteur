<!doctype html>
<html lang="fr">
<!--
================================================================================
                          MOTEUR - CHANGELOG
         "Mais oÃ¹ est-ce qu'il est ce con de perchman ?"
================================================================================

MÃ‰THODE DE TRAVAIL
==================

Ce projet est dÃ©veloppÃ© en collaboration avec Claude (Anthropic).
Ã€ chaque nouvelle conversation :

1. Uploader le fichier 2.1.8
HTML actuel
1. Uploader le fichier HTML actuel
2. Demander Ã  Claude Ã  quelle version on en est
3. Expliquer la fonctionnalitÃ© ou correction souhaitÃ©e
4. Claude indique "CHERCHE/REMPLACE" pour chaque modification
5. Appliquer les modifications Ã©tape par Ã©tape (copier-coller) maximum 150 caractÃ¨res par modifications. 
6. Tester dans le navigateur aprÃ¨s chaque changement
7. Le changement de version est dÃ©cidÃ© par le dÃ©veloppeur uniquement
8. Mettre Ã  jour l'historique rÃ©guliÃ¨rement

================================================================================
                         HISTORIQUE DES VERSIONS
================================================================================
V2.2 - Audit & Corrections (20 FÃ©v. 2026)
  â€¢ Bug fix : Messages.openCompose() (bouton Contacter Univers)
  â€¢ Bug fix : Hub sÃ©lecteur cartes (c.icon â†’ Icons.render)
  â€¢ Bug fix : IDs HTML dupliquÃ©s Contacts (filtres par onglet)
  â€¢ Bug fix : Toast d'erreur sur Ã©chec Store.save
  â€¢ Bug fix : Guard addEventListener keydown
  â€¢ Bug fix : Cleanup canal notifications Supabase
  â€¢ Fix : EmailJS IDs harmonisÃ©s (CONFIG partout)
  â€¢ Fix : URLs harmonisÃ©es moteur.studio
  â€¢ Fix : hideAllViews() complÃ©tÃ© (beatboard, sequencer)
  â€¢ Fix : Fusion scriptMeta/titlePage
  â€¢ Fix : Normalisation email toLowerCase
  â€¢ SÃ©curitÃ© : Ã‰chappement XSS noms groupes/tags
  â€¢ Nettoyage : 7 thÃ¨mes CSS morts supprimÃ©s (~200 lignes)
  â€¢ Nettoyage : Module Help supprimÃ©
  â€¢ Nettoyage : console.log sensibles supprimÃ©s (token, email)
  â€¢ Fix : SDK Supabase version fixÃ©e @2.49.1 (CDN cassÃ©)
  â€¢ Fix : z-index Hub card selector (z-index 1000/999)
  â€¢ Fix : removeChannel async (await dans try/catch)
  â€¢ Robustesse : Gestion d'erreur sur ~20 appels Supabase (I3)
    - messages.delete/update, project_members.insert Ã—2
    - contacts.delete Ã—3, user_profiles.update Ã—2
    - notifications.insert Ã—2, update Ã—2, delete Ã—2
    - app_config.upsert Ã—2, messages.update (marquage lu)
  â€¢ Factorisation : Constantes redÃ©finies centralisÃ©es (N3)
    - SCENE_STATUS_LABELS (5 occurrences â†’ 1 constante)
    - BD_TO_RESOURCE_CAT / RESOURCE_CAT_TO_BD (5 â†’ 2)
    - EXPENSE_STATUS_LABELS (3 â†’ 1)
  â€¢ Factorisation CSS : Styles inline â†’ classes utilitaires (N8)
    - 2 739 styles inline â†’ 1 381 restants (1 358 Ã©liminÃ©s, 49.6%)
    - 212 classes utilitaires crÃ©Ã©es (bloc CSS N8)
    - Patterns â‰¥2Ã— factorisÃ©s : flex, btn, input, avatar, badge, modal, layout
    - Restants : styles uniques (1Ã—), JS dynamique, conditionnels ${...}

V2.1.9 - Beat Board : Lignes de suivi & Mode sombre & Ã‰diteur Synopsis (06-09 FÃ©v. 2026)
  â€¢ Ã‰diteur Synopsis type traitement de texte
    - Zones d'Ã©dition contentEditable format A4 (largeur 210mm, fond blanc, ombre)
    - Barre d'outils : Gras, Italique, SoulignÃ©, BarrÃ©, Listes, Alignement
    - Styles : Titre 1 (bleu soulignÃ©), Titre 2 (bleu), Titre 3 (majuscules gris), Citation
    - Insertion images URL, tableaux, ligne horizontale
    - Collage intelligent, sauvegarde debounce, compatibilitÃ© texte brut
    - Fix scope IIFE (Synopsis.exec â†’ app.Synopsis.exec)
  â€¢ Animations UI subtiles
    - Transition onglets subtleFadeUp, cards Ã©lÃ©vation hover, boutons scale clic
    - Modales scale-in, inputs lueur focus, scrollbar macOS
    - Courbe cubic-bezier(0.4, 0, 0.2, 1)
  â€¢ Nettoyage code synopsis
    - Suppression CSS mortes, fix double font-size h3, suppression _activeType
  â€¢ Mode sombre par dÃ©faut
    - Tous les nouveaux utilisateurs arrivent en dark mode
    - Les utilisateurs ayant choisi le mode clair restent en clair
  â€¢ Lignes de suivi par tag (Beat Board)
    - Nouvelles lignes colorÃ©es reliant les scÃ¨nes d'un mÃªme tag chronologiquement
    - Toggle global "Afficher les lignes de tags" dans le panneau Beat Board
    - Toggles individuels par tag (checkbox + couleur + compteur de scÃ¨nes)
    - Courbes adaptatives sortie droite â†’ entrÃ©e gauche des connecteurs
    - Mise Ã  jour en temps rÃ©el pendant le drag des cartes
  â€¢ Correction fil rouge (Beat Board)
    - Lignes en segments sÃ©parÃ©s (connecteur droit â†’ connecteur gauche)
    - Suppression des boucles noires sur les courbes de BÃ©zier
    - Courbes quadratiques adaptatives pour toutes les positions de cartes
  â€¢ CompatibilitÃ© fichier local (file://)
    - DÃ©sactivation automatique du realtime/websocket en mode local
    - Fix boucle d'authentification Supabase depuis file://
    - Protection contre les events de refresh Ã©chouÃ©s

V2.1.8 - Landing Page & SEO (03 FÃ©v. 2026)
  â€¢ Landing page publique pour le rÃ©fÃ©rencement
    - Hero avec prÃ©sentation de Moteur
    - 6 cartes fonctionnalitÃ©s (Ã‰criture, Storyboard, Casting, Planning, Budget, Univers)
    - Galerie de screenshots (6 captures d'Ã©cran)
    - Call-to-action et footer
    - Design responsive mobile
  â€¢ Optimisation SEO
    - Meta tags optimisÃ©s pour "logiciel Ã©criture scÃ©nario"
    - Open Graph et Twitter Cards mis Ã  jour
    - Keywords ciblÃ©s : scÃ©nario, storyboard, production film
  â€¢ Module Landing
    - Navigation Landing â†” Auth fluide
    - Bouton retour depuis l'Ã©cran de connexion
  â€¢ Fix launchEditor
    - Cache projects-view pour Ã©viter superposition dans les onglets projet

V2.1.7 - Conditions d'utilisation (03 FÃ©v. 2026)
  â€¢ Modal CGU Ã  la premiÃ¨re connexion
    - Conditions de confidentialitÃ© (RGPD, prÃ©-alpha)
    - Clause de non-concurrence et propriÃ©tÃ© intellectuelle
    - RÃ¨gles d'utilisation acceptable
  â€¢ Acceptation obligatoire pour accÃ©der Ã  la plateforme
    - Checkbox + bouton Accepter/Refuser
    - Stockage en base (terms_accepted, terms_accepted_at)
    - Refus = dÃ©connexion automatique

V2.1.6 - Hub Central & Refonte Navigation (03 FÃ©v. 2026)
  â€¢ Nouveau Hub Central (landing page aprÃ¨s connexion)
    - Bienvenue personnalisÃ© : "Bonjour [prÃ©nom] ðŸ‘‹" + type de compte
    - 6 cartes d'accÃ¨s rapide personnalisables (Projets, Univers, Profil, Contacts, Forum, Cours)
    - Bouton âš™ï¸ Personnaliser pour changer les cartes
    - Statistiques en temps rÃ©el : Mes projets, Profils Univers, Sujets Forum, Messages
    - Onboarding pour nouveaux utilisateurs (Ã©tapes : Compte, Profil, Premier projet)
  â€¢ Refonte complÃ¨te de la navigation
    - Fonction centralisÃ©e UI.hideAllViews() pour Ã©viter les superpositions de vues
    - Toutes les vues (Profil, Contacts, Forum, Feed, Cours, Univers, Projets, Admin) utilisent hideAllViews
    - Headers unifiÃ©s sur Univers et Projets (bouton Retour + titre + Mode)
    - Retour systÃ©matique au Hub depuis toutes les sections
  â€¢ Simplification Design & IcÃ´nes
    - 3 designs uniquement : Classique, Lavande, Minimal
    - IcÃ´nes automatiquement liÃ©es au design (Classiqueâ†’emoji, Lavandeâ†’duotone, Minimalâ†’minimal)
    - Suppression des 8 autres designs et styles d'icÃ´nes
    - Hub avec icÃ´nes dynamiques selon le design choisi
  â€¢ Fix doublons Univers
    - Suppression appel redondant Ã  loadMapMarkers() dans init()
    - Nettoyage du patch de dÃ©duplication devenu inutile
  â€¢ Fix statistiques Hub
    - RequÃªte corrigÃ©e : user_profiles avec filtre is_public (au lieu de public_profiles)
  â€¢ Fix Admin
    - Admin.show() cache le hub sans cacher dashboard-view
    - Admin.close() retourne proprement au hub

V2.1.5 - Unification Exports PDF (02 FÃ©v. 2026)
  â€¢ Refonte complÃ¨te Export PDF Profil
    - Header bleu avec photo de profil intÃ©grÃ©e
    - Sections colorÃ©es : Bio, Description physique, CompÃ©tences, Tarif, Contact
    - Support des 4 types : ComÃ©dien, Technicien, Association, Entreprise
    - Galerie photos intÃ©grÃ©e (jusqu'Ã  3 photos)
    - Footer unifiÃ© avec pagination + "GÃ©nÃ©rÃ© par Moteur â€” moteur.studio"
  â€¢ Refonte Export PDF Budget
    - Header bleu unifiÃ© avec titre projet + mode HT/TTC
    - Barre de progression visuelle du budget consommÃ©
    - RÃ©sumÃ© global dans encadrÃ© bleu
    - Statuts colorÃ©s (vert validÃ©, orange attente, rouge dÃ©passement)
    - Ligne de total en bas de chaque tableau
    - Footer paginÃ© unifiÃ©
  â€¢ Refonte des 7 PDFs du ZIP (ScÃ©nario, SÃ©quencier, Ã‰quipe, Budget, Planning, Casting, DÃ©cors)
    - 3 helpers mutualisÃ©s : zipHeader(), zipFooter(), zipSection()
    - ScÃ©nario : page de couverture bleue + en-tÃªtes compacts par page
    - SÃ©quencier : tableau avec alternance de lignes + en-tÃªtes rÃ©pÃ©tÃ©s
    - Ã‰quipe : sections colorÃ©es par dÃ©partement + tableaux comÃ©diens/techniciens
    - Budget : encadrÃ© rÃ©sumÃ© + dÃ©penses avec statuts colorÃ©s
    - Planning : numÃ©ros de jour en bleu + tableau alternance
    - Casting : sections Personnages (violet) + ComÃ©diens (vert)
    - DÃ©cors : cartes encadrÃ©es avec bordures et numÃ©rotation
  â€¢ Charte graphique PDF unifiÃ©e
    - Couleur principale : #2B6EF6 (rgb 43, 110, 246)
    - Headers bleus cohÃ©rents sur tous les exports
    - Footers paginÃ©s "GÃ©nÃ©rÃ© par Moteur â€” moteur.studio" partout
    - Contrats volontairement exclus (format juridique sobre)

V2.1.4 - Dashboard Admin AvancÃ© & Tutoriel & SEO (Jan. 2025)
  â€¢ Graphique d'Ã©volution interactif
    - Courbes avec pÃ©riode sÃ©lectionnable (7j, 30j, 3 mois, 12 mois)
    - Stats principales : Profils, Projets, ComÃ©diens, Connexions, Signalements
    - Stats dÃ©taillÃ©es par mÃ©tier tech (Image, Son, RÃ©gie, etc.)
    - Stats par type d'association et d'entreprise
    - Fix mapping rÃ´les vers dÃ©partements pour stats correctes
  â€¢ Tableau utilisateurs enrichi
    - Colonnes : Email, Nom, Types de profils, Inscription, Projets + dates
    - Liste des projets de chaque utilisateur avec dates de crÃ©ation
  â€¢ Nouveau systÃ¨me de Tutoriel
    - Guide complet sur l'Ã©cran de connexion (ðŸ‘ï¸ Tutoriel)
    - 17 sections couvrant toutes les fonctionnalitÃ©s
    - Remplace l'ancien Guide (code allÃ©gÃ© de ~1300 lignes)
  â€¢ Optimisation SEO complÃ¨te
    - Meta tags (description, keywords, author, robots)
    - Open Graph pour Facebook/LinkedIn
    - Twitter Card pour partages Twitter
    - Favicon emoji ðŸŽ¬ en SVG inline
    - Theme color #3b82f6
    - Canonical URL
  â€¢ Fichiers SEO gÃ©nÃ©rÃ©s
    - sitemap.xml pour rÃ©fÃ©rencement Google
    - robots.txt pour crawlers
    - og-image.png (1200x630) pour partages sociaux
  â€¢ Correction critique Supabase
    - Fix AbortError sur initialisation (Web Locks API)
    - Options auth explicites pour stabilitÃ©
  â€¢ DÃ©duplication vue Liste
    - Les profils et projets ne s'affichent plus en double

V2.1.3 - Admin AmÃ©liorÃ© & Statistiques (Jan. 2025)
  â€¢ Tableau de bord Admin enrichi
    - Onglet Connexions : statistiques jour/semaine/mois avec graphiques
    - Graphiques interactifs (barres) pour visualiser l'activitÃ©
    - Compteurs : aujourd'hui, cette semaine, ce mois, total
  â€¢ Message prÃ©-alpha configurable
    - Modification du titre et message depuis l'onglet Configuration
    - PrÃ©visualisation en temps rÃ©el
    - Sauvegarde en base de donnÃ©es (table app_config)
  â€¢ Logging des connexions utilisateurs
    - Table user_logins pour tracer les connexions
    - Historique complet des connexions

V2.1.2 - PrÃ©-Alpha Ouverte & Administration (Jan. 2025)
  â€¢ Ouverture de la prÃ©-alpha
    - Whitelist dÃ©sactivÃ©e, inscriptions ouvertes au public
    - Limite de 150 utilisateurs maximum
    - Message d'avertissement prÃ©-alpha sur l'Ã©cran de connexion
  â€¢ Tableau de bord Admin (visible uniquement par admin)
    - Statistiques : utilisateurs, projets, profils publics, signalements
    - Onglet Signalements : liste, actions (rÃ©soudre/rejeter/supprimer)
    - Onglet Utilisateurs : liste complÃ¨te avec recherche
    - Onglet Configuration : modifier la limite d'utilisateurs
    - Onglet Emailing : envoi de mails ciblÃ©s aux utilisateurs
  â€¢ SystÃ¨me d'emailing ciblÃ©
    - Filtres intelligents : profil incomplet, pas de profil public, 
      pas de projet, projet inactif, nouveaux inscrits, utilisateurs inactifs
    - Filtres par type de profil : comÃ©diens, techniciens, associations, entreprises
    - Templates d'emails prÃ©dÃ©finis (bienvenue, complÃ©ter profil, rÃ©activation, etc.)
    - PrÃ©visualisation et envoi groupÃ© via EmailJS
  â€¢ SystÃ¨me de signalement
    - Bouton ðŸš© sur les profils et projets dans l'Univers
    - Modale avec choix du motif et dÃ©tails
    - Table Supabase 'reports' pour stocker les signalements
  â€¢ AmÃ©liorations MoodBoard
    - Ã‰diteur de palette ColorWheel pour modifier les palettes existantes
    - Correction du double bouton "Renommer" sur les palettes
  â€¢ Ã‰diteur de dessin
    - Option "Fond transparent" pour exports PNG sans fond blanc
  â€¢ Corrections diverses
    - AmÃ©lioration responsive mobile (base)
    - Fix retour depuis Admin (scroll en haut)

V2.1.1 - Univers & Fiches Projets AmÃ©liorÃ©es (Jan. 2025)
  â€¢ Affichage des projets publics dans l'Univers
    - Projets visibles sur la carte et dans la liste
    - DÃ©duplication automatique des projets
  â€¢ Grande fiche projet complÃ¨te
    - Affiche toutes les infos de l'onglet PrÃ©sentation
    - Localisation, Calendrier (prÃ©-prod/tournage/post-prod/sortie)
    - Ã‰quipe avec budget, Type de production, Partenaires
    - Note d'intention, RÃ´les recherchÃ©s, Postes recherchÃ©s
  â€¢ Synchronisation temps rÃ©el PrÃ©sentation â†” Univers
    - Modification d'une info â†’ mise Ã  jour immÃ©diate sur la carte
    - DÃ©publication â†’ retrait immÃ©diat de la carte
  â€¢ Boutons de visibilitÃ© par section (style Profils)
    - IcÃ´ne ðŸŒðŸ‘ï¸ sur chaque section de PrÃ©sentation
    - ContrÃ´le granulaire de ce qui apparaÃ®t dans l'Univers
    - Sections : Dates, Localisation, Ã‰quipe, Infos lÃ©gales, 
      Type de production, Partenaires, Description, Besoins
  â€¢ Favoris projets
    - Ã‰toile â˜†/â˜… sur la fiche projet dans l'Univers
    - Ajout aux Contacts & Favoris (onglet Projets)
    - Correction upsert pour Ã©viter les doublons
  â€¢ Synchronisation titre projet â†” titre scÃ©nario
  â€¢ Nettoyage dÃ©cors/personnages orphelins aprÃ¨s suppression scÃ¨ne
  â€¢ RafraÃ®chissement dÃ©pouillement aprÃ¨s finalisation scÃ¨ne

V2.1.0 - Correction Structure Profils Publics (Jan. 2025)
  â€¢ RÃ©organisation complÃ¨te du formulaire "Mes Profils Publics"
    - Toutes les sections (Type, IdentitÃ©, ComÃ©dien, Technicien, Association, 
      Entreprise, Tarif, Calendrier, VÃ©hicule, ActualitÃ©, Zone Danger) sont 
      maintenant dans un conteneur unique (profile-all-sections)
    - Correction de l'indentation HTML pour une structure propre
    - Suppression des </div> en trop qui cassaient la hiÃ©rarchie
  â€¢ Affichage corrigÃ© sans profil existant
    - Seul le panneau "Bienvenue ! CrÃ©er mon premier profil" s'affiche
    - Les sections du formulaire sont masquÃ©es jusqu'au clic sur "Nouveau profil"
  â€¢ Clic sur "Nouveau profil" affiche maintenant toutes les sections correctement

V2.0.0 - Supabase Storage & Upload Images (Jan. 2025)
  â€¢ Migration des images vers Supabase Storage
    - Photos de profil uploadÃ©es vers le cloud (plus de base64)
    - Galerie photos comÃ©diens (3 photos max)
    - Galerie photos techniciens (3 photos max)
    - Affiche du projet (onglet PrÃ©sentation)
  â€¢ Buckets sÃ©curisÃ©s avec policies RLS
    - avatars : photos de profil
    - gallery : galeries photos des profils
    - projects : affiche projet et fichiers
  â€¢ Compression automatique des images (800-1200px, qualitÃ© 80-85%)
  â€¢ Suppression automatique des anciennes photos lors du remplacement
  â€¢ Interface amÃ©liorÃ©e : clic direct pour uploader (plus d'URL Ã  copier)
  â€¢ Correctif : sauvegarde des synopsis (Store.save)

V1.9.9.9 - Import PDF AmÃ©liorÃ© (Jan. 2025)
  â€¢ SystÃ¨me d'icÃ´nes modulaire avec 5 styles au choix
    - Classique : emojis traditionnels (ðŸ˜€ðŸ“ðŸŽ¬)
    - ColorÃ© : icÃ´nes SVG sur fonds colorÃ©s par catÃ©gorie
    - Duotone : icÃ´nes colorÃ©es sur fond transparent
    - Minimal : icÃ´nes grises discrÃ¨tes style Notion
    - Gradient : icÃ´nes sur fonds dÃ©gradÃ©s premium
  â€¢ BibliothÃ¨que SVG intÃ©grÃ©e (40+ icÃ´nes vectorielles)
  â€¢ Code couleur par catÃ©gorie (Ã‰criture, Production, Casting, Admin, Social)
  â€¢ SÃ©lecteur dans le menu Design (Dashboard + Projet)
  â€¢ Boutons Ã©diteur avec Ã©tat visuel "actif"
  â€¢ Fusion intelligente des paragraphes
    - Les lignes consÃ©cutives de mÃªme type sont fusionnÃ©es automatiquement
    - Supprime les retours Ã  la ligne artificiels de la mise en page PDF
    - Un paragraphe d'action = un seul bloc (et non plus une ligne par ligne)
  â€¢ Distinction Dialogue / Didascalie
    - Ã‰tape unique pour sÃ©lectionner dialogues et didascalies (mÃªme marge)
    - DÃ©tection automatique par les parenthÃ¨ses : (texte) = didascalie
    - Plus de confusion entre les deux types
  â€¢ Suppression intelligente des numÃ©ros de page
    - SÃ©lectionner un numÃ©ro de page supprime TOUS les numÃ©ros du document
    - DÃ©tection des formats : "1", "1.", "1/20", "- 1 -", "Page 1", "[1]", "(1)"
  â€¢ Wizard simplifiÃ© : 6 Ã©tapes au lieu de 7
  â€¢ Module Cours : images JPEG remplacent les SVG (46 photos professionnelles)
  â€¢ Menus Fichier/Projet/Export : ouverture au survol de la souris
  â€¢ CrÃ©ation de projet simplifiÃ©e (suppression vÃ©rification trial/pricing)
  â€¢ Correction : changement d'onglet navigateur ne quitte plus le projet

V1.9.9.7 - ActualitÃ©s & Limitations PrÃ©-Alpha (Jan. 2025)
  â€¢ SystÃ¨me d'actualitÃ©s de profil
    - Publication d'une actualitÃ© par jour sur son profil
    - Visible par tous sur le profil public (dÃ©filement horizontal)
    - Historique des 5 derniÃ¨res actualitÃ©s dans "Mon Profil"
  â€¢ Limitations prÃ©-alpha
    - Le Fil : limitÃ© Ã  1 publication par semaine (dimanche Ã  dimanche)
    - Invitation par email : limitÃ©e aux utilisateurs whitelist
  â€¢ Correction bug favoris
    - L'Ã©toile sur les profils fonctionne correctement
    - Synchronisation avec la liste des contacts
  â€¢ Nettoyage du code
    - Suppression du code mort (ancien mode flottant Universe)
    - Correction des warnings JavaScript

V1.9.9.6 - Migration Supabase (Jan. 2025)
  â€¢ Migration complÃ¨te Firebase â†’ Supabase
    - Base de donnÃ©es PostgreSQL hÃ©bergÃ©e en Europe (RGPD)
    - Authentification Supabase (inscription, connexion, reset password)
    - 12 tables optimisÃ©es avec Row Level Security (RLS)
  â€¢ Modules migrÃ©s
    - Auth : connexion, inscription, dÃ©connexion, mot de passe oubliÃ©
    - Projets : crÃ©ation, chargement, sauvegarde, suppression, partage
    - Profils utilisateurs : crÃ©ation, mise Ã  jour, photo
    - Messages : envoi, rÃ©ception, notifications
    - Contacts : ajout, suppression, gestion
    - Forum : threads, rÃ©ponses, votes, rÃ©solution
    - Feed (Le Fil) : publications, likes, commentaires
    - Commentaires : sur les scÃ¨nes du sÃ©quencier
    - Invitations : partage de projets, invitations en attente
  â€¢ Avantages Supabase
    - DonnÃ©es hÃ©bergÃ©es en Europe (conformitÃ© RGPD)
    - PostgreSQL robuste et scalable
    - CoÃ»ts rÃ©duits pour la mise Ã  l'Ã©chelle
    - Dashboard d'administration puissant
	
V1.9.9.5 - Forum Communautaire & Mur Social (Jan. 2025)
  â€¢ SystÃ¨me de liste blanche prÃ©-alpha
    - Inscription limitÃ©e aux emails autorisÃ©s
    - Message explicite pour utilisateurs non autorisÃ©s
  â€¢ Forum communautaire complet (8 catÃ©gories)
    - GÃ©nÃ©ral, ComÃ©diens, Techniciens, Retours Site
    - ScÃ©nario, RÃ©alisation, Production, Post-production
    - Votes style Reddit, rÃ©ponses imbriquÃ©es
  â€¢ Mur social (Feed)
    - Publications : Statut, Annonce, Recherche
    - Likes, commentaires, partage
 â€¢ Nouvelle navigation par menus dÃ©roulants
    - Mon Espace : Mon Profil, Mes Projets, Contacts
    - CommunautÃ© : Forum, Le Fil
    - Aide : Guide, Cours
    - Design : 11 thÃ¨mes disponibles
    - Ouverture au survol de la souris
  â€¢ Forum : sous-catÃ©gories Retours Site (17 modules)
    - Ã‰diteur ScÃ©nario, SÃ©quencier, DÃ©pouillement
    - Storyboard, Moodboard, Ã‰quipe, Budget, Contrats
    - Univers, Forum, Le Fil, Guide, Cours
    - Mon Profil, Messages, Design/ThÃ¨mes
  â€¢ Le Fil : nouveau design unifiÃ© avec Forum
    - Champ titre ajoutÃ©
    - Barre d'outils formatage (Gras, Italique, SoulignÃ©, Liste)
    - Upload d'images (max 5 Mo)
  â€¢ Forum : Ã©diteur amÃ©liorÃ©
    - MÃªme barre d'outils que Le Fil
    - Upload d'images dans les sujets

V1.9.9.4 - Beat Board & Mode Focus (Jan. 2025)
  â€¢ Nouveau mode Beat Board dans le SÃ©quencier
    - Basculer entre vue SÃ©quencier classique et vue Beat Board
    - Fiches de scÃ¨nes dÃ©plaÃ§ables librement sur le canvas
    - Fil rouge connectant les scÃ¨nes dans l'ordre du sÃ©quencier
  â€¢ Outils Beat Board
    - Zoom (molette ou boutons +/-), pan (clic droit + glisser)
    - Bouton "Recentrer" pour revenir Ã  la vue d'ensemble
    - LÃ©gende des groupes de couleur visible
  â€¢ Interactions avancÃ©es
    - Drag & drop normal : dÃ©place visuellement la fiche
    - Shift + drag : mode snap, insÃ¨re dans le fil rouge
    - Ctrl + clic : sÃ©lection multiple (outline bleu)
    - Drag multi-sÃ©lection : dÃ©place toutes les fiches sÃ©lectionnÃ©es ensemble
    - Zone "Retirer du fil rouge" pour sortir une scÃ¨ne du fil
  â€¢ ScÃ¨nes hors timeline
    - CrÃ©ation de scÃ¨nes non ordonnÃ©es (bouton "Nouvelle scÃ¨ne")
    - Style en pointillÃ©s + opacitÃ© rÃ©duite + icÃ´ne ðŸ“Œ
    - Shift + drag vers une zone d'insertion pour rejoindre le fil
  â€¢ Synchronisation bidirectionnelle
    - L'ordre du fil rouge = l'ordre du sÃ©quencier
    - Modifications rÃ©percutÃ©es dans les deux vues
  â€¢ Mode Focus (plein Ã©cran onglet)
    - Masque la navigation pour se concentrer sur le contenu
    - Barre d'outils minimaliste avec navigation â—€ â–¶
    - Raccourcis : F11 (activer), Ã‰chap (quitter), â† â†’ (naviguer)
    - Accessible via menu ðŸ“ ou touche F11
  â€¢ Guide d'aide enrichi
    - Nouvelles sections : Synopsis, Page de Titre, MoodBoard, Chat, Rapport de Script
    - Matching intelligent documentÃ© dans Univers
    - Mode Focus documentÃ©

V1.9.9.3 - Navigation ScÃ©nario OptimisÃ©e (Jan. 2025)
  â€¢ Raccourcis clavier directs pour types de paragraphes
    - Ctrl/Alt+1 = Action, Ctrl/Alt+2 = Personnage, Ctrl/Alt+3 = Dialogue
    - Ctrl/Alt+4 = Didascalie, Ctrl/Alt+5 = Transition, Ctrl/Alt+6 = CentrÃ©, Ctrl/Alt+7 = Note
    - Fonctionne dans l'Ã©diteur scÃ¨ne par scÃ¨ne ET continu
  â€¢ Tab contextuel intelligent (toggle)
    - Action â†” Personnage
    - Dialogue â†” Didascalie
    - Transition/CentrÃ©/Note â†’ Action
  â€¢ Shift+Tab pour cycle inverse
  â€¢ Correction perte de focus en Vue Script (re-render Firebase optimisÃ©)
  â€¢ Didascalie/Note : fermeture propre des parenthÃ¨ses/accolades sur EntrÃ©e
  â€¢ Documentation mise Ã  jour dans l'aide

V1.9.9.2 - Contrats Conformes & AccÃ¨s Direct (Jan. 2025)
  â€¢ Nouvelle section "Informations LÃ©gales" dans PrÃ©sentation
    - SIRET, Code APE/NAF, NÂ° Licence entrepreneur spectacle
    - URSSAF de rattachement, NÂ° CongÃ©s Spectacles employeur
    - Adresse complÃ¨te, Email RGPD, QualitÃ© du reprÃ©sentant
    - PrÃ©-remplissage automatique dans tous les contrats
  â€¢ Bouton "ðŸ“ Contrat" sur les fiches
    - AccÃ¨s direct depuis chaque fiche ComÃ©dien (onglet Casting)
    - AccÃ¨s direct depuis chaque fiche Technicien (onglet Ã‰quipe)
    - PrÃ©-sÃ©lection automatique de la personne
  â€¢ Nouveau type : Accord BÃ©nÃ©vole â¤ï¸
    - Engagement moral pour collaborations non rÃ©munÃ©rÃ©es
    - DÃ©fraiements (repas, transport, hÃ©bergement)
    - Engagements mutuels (respect, bienveillance, sÃ©curitÃ©)
    - CrÃ©dits au gÃ©nÃ©rique (choix d'apparaÃ®tre ou non)
    - Cession gracieuse des droits pour le projet
    - Esprit de l'accord (confiance, aventure humaine)
  â€¢ CDDU (IntermittentÂ·eÂ·s) - Mentions lÃ©gales complÃ¨tes
    - PrÃ©ambule avec motif de recours obligatoire (art. D.1242-1)
    - Mention DPAE (DÃ©claration PrÃ©alable Ã  l'Embauche)
    - Code APE, NÂ° Licence entrepreneur spectacle
    - Date/lieu naissance, nationalitÃ© du salariÃ©
    - NÂ° d'objet PÃ´le emploi spectacle
    - Article abattement frais professionnels (avec choix)
    - Article fin de contrat (documents Ã  remettre)
    - Article juridiction compÃ©tente
    - NÂ° affiliation CongÃ©s Spectacles employeur
  â€¢ Droit Ã  l'image - Refonte complÃ¨te conforme RGPD
    - Articles 9 Code civil et 226-1 Code pÃ©nal citÃ©s
    - Gestion des mineurs (case reprÃ©sentant lÃ©gal)
    - Date/lieu naissance, nationalitÃ©, email, tÃ©lÃ©phone
    - Supports d'exploitation dÃ©taillÃ©s (cases Ã  cocher)
    - Ã‰tendue territoriale explicite
    - Engagements du bÃ©nÃ©ficiaire (dignitÃ©, honneur)
    - Clause RGPD complÃ¨te (droits d'accÃ¨s, rectification...)
    - DÃ©clarations du signataire (consentement Ã©clairÃ©)
    - Mention manuscrite Â« Lu et approuvÃ© Â»
  â€¢ Contrat de Prestation (Auto-entrepreneur) enrichi
    - Cla

V1.9.9.1 - Rapport de Script (Jan. 2025)
  â€¢ Nouvel onglet "Rapport" dans Production
    - Fiche de script par plan (navigation scÃ¨ne/plan Ã  gauche)
    - Auto-remplissage : film, dÃ©cor, date, effet (jour/nuit, int/ext)
    - Auto-remplissage : camÃ©ra, objectif depuis l'Ã©quipe et storyboard
    - Extraction automatique des dialogues depuis le scÃ©nario
  â€¢ Gestion des prises
    - NumÃ©ro de prise, NÂ° Son, NÂ° Image
    - QualitÃ© Son/Image/Acting avec notation 1-5 Ã©toiles
    - Notes libres par prise
    - Ã‰toiles Or â˜… et Argent â˜† pour marquer les meilleures prises
  â€¢ Champs de la fiche
    - SON (Sonore/Muet), Supports de sauvegarde
    - NOTE libre, Description du plan, Dialogues
  â€¢ Export PDF professionnel
    - Mise en page soignÃ©e avec en-tÃªte noir
    - Ã‰toiles graphiques colorÃ©es (or/argent) dans le PDF
    - Export individuel ou export de toutes les fiches
  â€¢ Planning : Feuilles de service
    - Acteurs groupÃ©s par type (Casting Principal, RÃ´les Secondaires, Figurants)
    - MÃªme logique de groupement que l'Ã©quipe technique

V1.9.9 - Corrections Exports (Jan. 2025)
  â€¢ MoodBoard : Export PNG/PDF corrigÃ©
    - Toutes les formes SVG (30+) s'exportent correctement
    - Ã‰toiles, flÃ¨ches, bulles, symboles exportÃ©s fidÃ¨lement
    - Conversion SVG â†’ image pour rendu prÃ©cis
  â€¢ Noms de fichiers explicites
    - MoodBoard : "NomProjet_MoodBoard_NomPlanche.pdf/png"
    - Storyboard : "NomProjet_Storyboard.pdf"
  â€¢ Storyboard PDF complet
    - Nom du plan affichÃ© (entre guillemets)
    - Mode camÃ©ra (Objectif, Subjectif, Semi-subjectif, PDV)
    - Direction acteurs (ðŸŽ­) et technique (âš™ï¸) incluses
  â€¢ Export ZIP enrichi
    - Dossier PDF/ avec tous les documents prÃªts Ã  imprimer
    - Dossier CSV/ avec fichiers tableur
    - ScÃ©nario, SÃ©quencier, Casting, Ã‰quipe, DÃ©cors, Budget, Planning
    - README structurÃ© avec instructions de rÃ©import
  â€¢ 11 thÃ¨mes visuels disponibles
    - ðŸŽ¬ Classique (dÃ©faut, sobre et professionnel)
    - âœ¨ Glassmorphism (transparent, flou, dÃ©gradÃ© violet)
    - ðŸ«§ Neumorphism (effet soft extrudÃ©, ombres douces)
    - ðŸŽ¥ Dark Cinema (noir + or, style Hollywood)
    - ðŸ’œ Cyberpunk (nÃ©on cyan/magenta, monospace)
    - ðŸŒ¿ Nature (verts apaisants, organique)
    - ðŸŒ… Sunset (dÃ©gradÃ© orange/rose chaleureux)
    - ðŸŒŠ OcÃ©an (bleus profonds, apaisant)
    - ðŸ’ Lavande (violets doux, arrondi Ã©lÃ©gant)
    - â¬œ Minimal (Ã©purÃ© noir/blanc, sobre)
    - ðŸ’» Terminal (hacker rÃ©tro, vert sur noir)
  â€¢ SÃ©lecteur de design dans le header (bouton ðŸŽ¨ Design)
  â€¢ Sauvegarde automatique du choix utilisateur
  â€¢ Compatible avec le mode clair/sombre (ðŸŒ“)
  â€¢ Corrections de bugs critiques
    - Fermeture manquante des objets Exporter/Expenses
    - Suppression de code markdown accidentel

V1.9.8 - Exports Professionnels (Jan. 2025)
  â€¢ Nouveaux exports PDF dÃ©diÃ©s
    - ðŸ“‹ Rapport de production complet (stats, Ã©quipe, budget, planning)
    - ðŸ“‹ DÃ©pouillement PDF avec rÃ©capitulatif global par catÃ©gorie
    - ðŸŽ¨ Storyboard PDF (grille 2x2, paysage A4)
    - ðŸ‘¥ Ã‰quipe PDF par dÃ©partement avec coordonnÃ©es
  â€¢ Export ZIP complet du projet restructurÃ©
    - ðŸ“ PDF/ : ScÃ©nario, SÃ©quencier, Casting, Ã‰quipe, DÃ©cors, Budget, Planning
    - ðŸ“ CSV/ : Tous les fichiers tableur
    - projet_data.json : Pour rÃ©import dans Moteur
    - scenario.fountain : Format universel
    - README.md : Documentation structurÃ©e avec instructions
  â€¢ MoodBoard exports corrigÃ©s
    - Toutes les formes SVG (30+) s'exportent correctement en PNG/PDF
    - Ã‰toiles, flÃ¨ches, bulles, symboles rendus fidÃ¨lement
    - Conversion SVG â†’ Canvas â†’ Image pour rendu prÃ©cis
  â€¢ Storyboard PDF enrichi
    - Nom du plan affichÃ© entre guillemets
    - Mode camÃ©ra (OBJ, SUBJ, SEMI, PDV)
    - Direction acteurs ðŸŽ­ et technique âš™ï¸ incluses
    - Zone image rÃ©duite (55%) pour plus d'espace texte
  â€¢ Noms de fichiers explicites
    - MoodBoard : "Projet_MoodBoard_Planche.pdf/png"
    - Storyboard : "Projet_Storyboard.pdf"
  â€¢ Menu Export enrichi
    - Nouvelle section "Projet complet"
    - Organisation par catÃ©gories (ScÃ©nario, Budget, Projet)

V1.9.7 - MoodBoard Pro : Roue Chromatique & Formes (Jan. 2025)
  â€¢ GÃ©nÃ©rateur de palettes avec roue chromatique interactive
    - Style Adobe Color avec 8 types d'harmonies
    - Semblable, Nuances, ComplÃ©mentaire, Triade, CarrÃ©, etc.
    - ContrÃ´le de la saturation (centre/extÃ©rieur) et luminositÃ©
    - 5 couleurs gÃ©nÃ©rÃ©es avec codes hex copiables
  â€¢ BibliothÃ¨que de 30+ formes gÃ©omÃ©triques
    - Formes de base : rectangle, cercle, ellipse, triangle, losange
    - Polygones : pentagone, hexagone, octogone, Ã©toiles
    - FlÃ¨ches : droite, gauche, haut, bas, double, chevrons
    - Bulles : parole, ronde, pensÃ©e
    - Symboles : cÅ“ur, croix, check, X, plus, moins
    - Cadres vides : rectangle, arrondi, cercle
  â€¢ Rotation des Ã©lÃ©ments
    - Handle de rotation au survol (cercle bleu â†»)
    - Drag pour tourner librement
    - Maintenir Shift pour snap Ã  15Â°
  â€¢ Personnalisation des formes
    - Couleur noire par dÃ©faut
    - Clic droit â†’ ðŸŽ¨ Couleur pour modifier
    - Palette de 12 couleurs rapides + sÃ©lecteur complet
  â€¢ Palettes amÃ©liorÃ©es
    - Affichage clair avec codes hex lisibles
    - Taille par dÃ©faut 500x200px
    - Clic droit â†’ âœï¸ Renommer la palette
  â€¢ Formats de canvas fonctionnels
    - A4, A3, A2, A0 en portrait et paysage
    - Toast de confirmation au changement
  â€¢ UX amÃ©liorÃ©e
    - Menu des formes repositionnÃ© automatiquement
    - Reste toujours visible dans la fenÃªtre
    - Scrollable si beaucoup de formes

V1.9.6 - MÃ©tÃ©o, Cartes & Feuilles de Service Pro (Jan. 2025)
  â€¢ MÃ©tÃ©o automatique dans les feuilles de service
    - IntÃ©gration Open-Meteo API (100% gratuit, sans clÃ© API)
    - TempÃ©rature, ressenti, conditions mÃ©tÃ©o
    - ProbabilitÃ© de pluie, vent, lever/coucher soleil
    - Champ "MÃ©tÃ©o personnalisÃ©e / Consignes" pour instructions spÃ©ciales
  â€¢ Carte interactive Leaflet/OSM du lieu de tournage
  â€¢ Lien Google Maps pour la navigation GPS
    - Bouton cliquable dans la feuille de service
    - URL en texte visible lors de l'impression PDF
  â€¢ Feuille de Service complÃ¨te et professionnelle
    - Programme du jour avec scÃ¨nes ET plans sÃ©lectionnÃ©s
    - DÃ©pouillement avec responsable par dÃ©partement (ex: "COSTUMES (Sarah)")
    - Contact sur place + tÃ©lÃ©phone + notes d'accÃ¨s
    - Transport avec dÃ©tail "avec qui" pour covoiturage
    - Notes gÃ©nÃ©rales et champs vides affichÃ©s avec mention "Vide"
    - Ordre des sections harmonisÃ© avec la modal de crÃ©ation
  â€¢ Export PDF amÃ©liorÃ©
    - Nom du fichier = "Projet - FDS NomTournage - Date"
    - Mise en page optimisÃ©e pour impression
  â€¢ Synchronisation bidirectionnelle du transport
    - Si Lila "AmÃ¨ne" Sarah â†’ Sarah passe auto en "Part avec" Lila
    - Mise Ã  jour instantanÃ©e des deux cÃ´tÃ©s
  â€¢ Recalcul automatique Ã  la suppression de scÃ¨ne
    - ComÃ©diens non nÃ©cessaires dÃ©cochÃ©s automatiquement
    - Techniciens du dÃ©pouillement mis Ã  jour
    - Transports "avec qui" nettoyÃ©s si personne retirÃ©e
    - AperÃ§u dÃ©pouillement rafraÃ®chi en temps rÃ©el
  â€¢ Corrections
    - Fix bug sauvegarde (null check sur Ã©lÃ©ments supprimÃ©s)
    - Fix parsing des IDs avec underscore (actor_act_xxx)
    - Fix generateFDS (startDate au lieu de date)

V1.9.5 - Ressources & Liaisons Visuelles (Jan. 2025)
  â€¢ RÃ©organisation des onglets
    - Vue CatÃ©gories : Personnages, ComÃ©diens, DÃ©cors, Ressources
    - Vue Classique : 7. ComÃ©diens, 8. DÃ©cors, 9. Ressources
  â€¢ Liaison visuelle dans le DÃ©pouillement
    - Survol mot surlignÃ© â†” tag : les deux s'allument en jaune
    - FlÃ¨che SVG courbe reliant texte et dÃ©pouillement
    - Fonctionne aussi pour DECORS-LIEUX dans le titre
  â€¢ Nouvel onglet Ressources (Accessoires, Costumes, VÃ©hicules)
    - Filtres par catÃ©gorie (Tous, Accessoires, Costumes, VÃ©hicules)
    - Fiches avec photo, description, propriÃ©taire, note, scÃ¨nes liÃ©es
    - PropriÃ©taire : comÃ©dien/technicien du projet OU saisie manuelle (location)
    - CrÃ©ation automatique depuis le dÃ©pouillement
    - Suppression liÃ©e (demande confirmation dÃ©pouillement â†” ressource)
    - Fusion de fiches similaires (garde la plus complÃ¨te)
  â€¢ Drag & drop des sous-onglets en vue CatÃ©gories
    - RÃ©ordonner les sous-onglets par glisser-dÃ©poser
    - DÃ©placer un sous-onglet vers une autre catÃ©gorie
    - Ordre sauvegardÃ© par projet
    - Bouton RÃ©initialiser remet ordre ET couleurs par dÃ©faut
  â€¢ SystÃ¨me Brouillon / Finale pour les scÃ¨nes
    - ScÃ¨ne en brouillon (ðŸ“) : texte modifiable, dÃ©pouillement bloquÃ©
    - ScÃ¨ne finale (âœ…) : texte figÃ©, dÃ©pouillement accessible
    - Bouton "Finaliser" dans SÃ©quencier, ScÃ©nario (Vue ScÃ¨nes + Vue Script)
    - Bouton "Repasser en brouillon" avec alerte suppression dÃ©pouillement
    - Badge visuel sur chaque scÃ¨ne (SÃ©quencier, ScÃ©nario, DÃ©pouillement)
    - Clic-droit bloquÃ© dans DÃ©pouillement si scÃ¨ne non finalisÃ©e

V1.9.3 - DÃ©penses & Contrats SimplifiÃ©s (Jan. 2025)
  â€¢ Pricing et Abonnements
    - Base : 1â‚¬/mois pour le propriÃ©taire
    - 6-15 collaborateurs = 2â‚¬/mois
    - +1â‚¬ par tranche de 10 au-delÃ 
    - 1 collaborateur = 1 fiche comÃ©dien ou technicien
    - Modale d'offre d'essai avec avantages
    - Modale d'abonnement
    - BanniÃ¨re d'essai avec countdown dans le dashboard
    - Widget de facturation avec dÃ©tail par projet
    - Calcul automatique du prix selon projets et membres
  â€¢ DÃ©penses : Mode Simple / AvancÃ©
    - Toggle Simple/AvancÃ© en haut de l'onglet Budget
    - Mode Simple : budget + liste dÃ©penses, statuts Ã€ payer/PayÃ©
    - Mode AvancÃ© : catÃ©gories, enveloppes, responsables, salaires auto
    - CatÃ©gories simplifiÃ©es (6 au lieu de 16)
    - PrÃ©fÃ©rence sauvegardÃ©e par utilisateur
  â€¢ Contrats : rÃ©organisation et alertes
    - Droit Ã  l'image en premier (onglet par dÃ©faut)
    - VÃ©rification des infos manquantes avant gÃ©nÃ©ration
    - Alerte avec liste des champs manquants
    - Bouton "Envoyer rappel" par email
    - Option "GÃ©nÃ©rer quand mÃªme"
  â€¢ Alertes infos manquantes (salaires/contrats)
    - Bouton "VÃ©rifier infos" dans section Salaires
    - Modale listant les personnes incomplÃ¨tes
    - Email de rappel personnalisÃ©
    - Envoi groupÃ© possible

V1.8.5 - Plan de Travail & DÃ©pouillement Intelligent
  â€¢ Voir versions antÃ©rieures dans le fichier complet

V1.8 Ã  V1.8.4 - Budget HiÃ©rarchique & AmÃ©liorations
  â€¢ Voir versions antÃ©rieures dans le fichier complet

V1.7 Ã  V1.7.9 - Storyboard, Univers & Planning
  â€¢ Voir versions antÃ©rieures dans le fichier complet

V1.6 Ã  V1.6.6 - Refonte Univers
  â€¢ Voir versions antÃ©rieures dans le fichier complet

V1.5 Ã  V1.5.1 - Mise en Page
  â€¢ Voir versions antÃ©rieures dans le fichier complet

V1.4 Ã  V1.4.7 - Mode PrÃ©sentation & FonctionnalitÃ©s
  â€¢ Voir versions antÃ©rieures dans le fichier complet

V1.3 Ã  V1.3.1 - Export PDF & Favoris
  â€¢ Voir versions antÃ©rieures dans le fichier complet

V1.2 Ã  V1.2.1 - Responsive Mobile
  â€¢ Voir versions antÃ©rieures dans le fichier complet

V1.1 - Notifications Toast
  â€¢ Remplacement des alert() par notifications Ã©lÃ©gantes
  â€¢ 4 types : success, error, warning, info

V1.0 - Base solide (DÃ©c. 2024)
  â€¢ Authentification Firebase (connexion, inscription, reset)
  â€¢ Profils publics multi-types (ComÃ©dien, Technicien)
  â€¢ Gestion de projets avec rÃ´les et permissions
  â€¢ ScÃ©nario & Breakdown (import PDF/FDX, Ã©diteur, dÃ©composition)
  â€¢ Storyboard avec Ã©diteur de dessin intÃ©grÃ©
  â€¢ Ã‰quipe (Crew) avec dÃ©partements et fiches
  â€¢ Planning et calendrier de tournage
  â€¢ Budget & DÃ©penses par catÃ©gorie
  â€¢ Chat par projet et messagerie interne
  â€¢ Univers (annuaire public des professionnels)
  â€¢ Mode clair / sombre

================================================================================
                              Ã€ FAIRE - ROADMAP
================================================================================

ðŸ’³ PRICING - Ã€ FINALISER
  â€¢ IntÃ©gration Stripe Checkout (paiement rÃ©el) âŒ
  â€¢ Webhooks Stripe â†’ Firebase (confirmation paiement) âŒ
  â€¢ Cloud Functions (cron jobs essais/suppressions) âŒ
  â€¢ Emails automatiques (rappels, expirations) âŒ
  â€¢ SÃ©curitÃ© Firebase Rules (bloquer si impayÃ©) âŒ
  â€¢ Portail client Stripe (gestion abonnement) âŒ

ðŸ“‹ DOCUMENTS NON IMPLÃ‰MENTÃ‰S
  C) Liste des VÃ©hicules nÃ©cessaires
     - RÃ©capitulatif par jour de tournage âŒ
  D) Feuille de ContinuitÃ© / Rapport Scripte
     - Raccords, chronomÃ©trage, notes âœ… (V1.9.9.1)
  E) Listing des Figurants par jour
     - Nombre, costumes, horaires âŒ
  F) RÃ©capitulatif Costumes/Maquillage par personnage âŒ

ðŸ”— LIAISONS MANQUANTES
  1) DÃ©penses â†” CatÃ©gorie dÃ©pouillement
  2) ScÃ¨ne â†’ Version/RÃ©vision (pages colorÃ©es)

ðŸ“Š STATISTIQUES MANQUANTES
  â€¢ CoÃ»t moyen par jour âŒ

ðŸ“¤ EXPORTS
  â€¢ Rapport prod PDF âœ… (V1.9.8)
  â€¢ ZIP complet avec PDFs âœ… (V1.9.9)

âœ… FAIT
  â€¢ Export ZIP avec dossiers PDF/ et CSV/ (V1.9.9)
  â€¢ MoodBoard : export PNG/PDF de toutes les formes SVG (V1.9.9)
  â€¢ Storyboard PDF : nom du plan, mode camÃ©ra, directions acteurs/technique (V1.9.9)
  â€¢ Noms de fichiers explicites pour tous les exports (V1.9.9)
  â€¢ SystÃ¨me Brouillon/Finale scÃ¨nes â†’ DÃ©pouillement bloquÃ© si brouillon (V1.9.5)
  â€¢ Drag & drop sous-onglets entre catÃ©gories (V1.9.5)
  â€¢ Accessoire/Costume/VÃ©hicule â†’ Fiche dÃ©diÃ©e Ressources (V1.9.5)
  â€¢ Liaison visuelle DÃ©pouillement â†” Texte avec flÃ¨che (V1.9.5)
  â€¢ DÃ©penses Mode Simple/AvancÃ© (V1.9.3)
  â€¢ Alertes infos manquantes contrats/salaires (V1.9.3)
  â€¢ Contrats : Droit Ã  l'image par dÃ©faut (V1.9.3)
  â€¢ Pricing Ã  l'usage avec essai 48h (V1.9.3) - en attente Stripe
  â€¢ Types de journÃ©es planning (V1.9.3)
  â€¢ Session unique multi-onglets (V1.9.3)
  â€¢ Langues/Sports avec niveaux (V1.9.3)
  â€¢ Jours de travail par comÃ©dien (V1.9)
  â€¢ Nb scÃ¨nes par lieu (V1.4.3)
  â€¢ Taux d'avancement (V1.4.3)
  â€¢ Nb dialogues par personnage (V1.4.3)
  â€¢ ScÃ©nario PDF | Ã‰quipe PDF | DÃ©pouillement PDF (via impression)
  â€¢ Budget PDF | Budget Excel (V1.8.6)
  â€¢ Storyboard PDF | Feuille service | Plan travail
  â€¢ Liaison Lieu â†” ScÃ¨ne enrichie (V1.8.6)
  â€¢ Fiche Lieu avec adresse, contact, photos (V1.8.6)
  â€¢ Auto-liaison dÃ©pouillement â†’ feuille de service (V1.8.6)
  â€¢ Workflow validation dÃ©penses (V1.8)
  â€¢ Gestion vÃ©hicules Ã©quipe (V1.7.6)
  â€¢ Outils dessin 6 pinceaux (V1.7)
  â€¢ Logs/Historique (V1.4.1)

================================================================================

	OK, pas de terminal. Alors essaie Ã§a dans Firefox :

	Tape dans la barre d'adresse : about:config
	Accepte le risque
	Cherche : security.fileuri.strict_origin_policy
	Passe-le Ã  false

	Recharge ton fichier HTML et teste.
	Si Ã§a marche pas, essaie aussi de chercher privacy.file_unique_origin et le passer Ã  false.

================================================================================
-->
<head>
<meta charset="utf-8">
<title>Moteur - Logiciel d'Ã©criture de scÃ©nario et gestion de production film</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

<!-- SEO Meta Tags -->
<meta name="description" content="Logiciel d'Ã©criture de scÃ©nario et gestion de production audiovisuelle. Ã‰crivez votre scÃ©nario, crÃ©ez storyboard, sÃ©quencier, casting, planning et budget. L'outil complet pour cinÃ©astes et scÃ©naristes.">
<meta name="keywords" content="logiciel Ã©criture scÃ©nario, logiciel scÃ©nario, Ã©crire un scÃ©nario, logiciel cinÃ©ma, gestion production film, storyboard, sÃ©quencier, planning tournage, budget film, casting, court-mÃ©trage, logiciel rÃ©alisateur, screenwriting software, celtx alternative, final draft alternative">
<meta name="author" content="Moteur">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://moteur.studio/">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://moteur.studio/">
<meta property="og:title" content="Moteur - Logiciel d'Ã©criture de scÃ©nario et production film">
<meta property="og:description" content="L'application tout-en-un pour gÃ©rer vos projets de films. ScÃ©nario, casting, planning, budget, storyboard. Gratuit et collaboratif.">
<meta property="og:image" content="https://moteur.studio/og-image.png">
<meta property="og:locale" content="fr_FR">
<meta property="og:site_name" content="Moteur">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="https://moteur.studio/">
<meta name="twitter:title" content="Moteur - Logiciel d'Ã©criture de scÃ©nario et production film">
<meta name="twitter:description" content="L'application tout-en-un pour gÃ©rer vos projets de films. ScÃ©nario, casting, planning, budget, storyboard.">
<meta name="twitter:image" content="https://moteur.studio/og-image.png">

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¬</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¬</text></svg>">

<!-- Theme Color -->
<meta name="theme-color" content="#3b82f6">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1"></script>

<!-- EmailJS SDK pour les invitations -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // iOS Safari 100vh fix
    function setVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      document.documentElement.style.setProperty('--real-vh', `${vh}px`);
    }
    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', function() { setTimeout(setVH, 100); });
    
    // Smooth scroll polyfill check for Safari
    if (!('scrollBehavior' in document.documentElement.style)) {
      window.smoothScrollTo = function(element, options) {
        const start = window.pageYOffset;
        const target = element.getBoundingClientRect().top + start;
        const duration = 300;
        let startTime = null;
        function animation(currentTime) {
          if (startTime === null) startTime = currentTime;
          const timeElapsed = currentTime - startTime;
          const progress = Math.min(timeElapsed / duration, 1);
          const ease = progress < 0.5 ? 2 * progress * progress : 1 - Math.pow(-2 * progress + 2, 2) / 2;
          window.scrollTo(0, start + (target - start) * ease);
          if (timeElapsed < duration) requestAnimationFrame(animation);
        }
        requestAnimationFrame(animation);
      };
    }
</script>

<style>
  /* --- CROSS-BROWSER COMPATIBILITY RESET --- */
  *, *::before, *::after {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
  }
  html {
    -webkit-text-size-adjust: 100%;
    -moz-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  /* iOS Safari 100vh fix */
  :root {
    --vh: 1vh;
  }
  @supports (-webkit-touch-callout: none) {
    :root {
      --vh: calc(var(--real-vh, 1vh));
    }
  }
  /* Smooth scroll with fallback */
  @media (prefers-reduced-motion: no-preference) {
    html {
      scroll-behavior: smooth;
    }
  }
  /* Flexbox gap fallback for older browsers */
  @supports not (gap: 1px) {
    .gap-fallback > * {
      margin: 5px;
    }
  }
  /* Safari sticky fix */
  .sticky-element {
    position: -webkit-sticky;
    position: sticky;
  }
  
  /* --- CSS VARIABLES --- */
  :root { --primary: #2b6ef6; --bg: #f4f6f8; --panel-bg: #ffffff; --text-main: #333333; --text-sec: #666666; --border: #dddddd; --input-bg: #ffffff; --highlight: #fff3cd; --danger: #ff4444; --success: #28a745; --locked: #ff9800; --shadow: rgba(0,0,0,0.05); --radius: 8px; --blur: 0px; --glass-bg: rgba(255,255,255,1); --glass-border: var(--border); }
  body.dark-mode { --primary: #4a90e2; --bg: #121212; --panel-bg: #1e1e1e; --text-main: #e0e0e0; --text-sec: #aaaaaa; --border: #333333; --input-bg: #2d2d2d; --highlight: #4a4a20; --shadow: rgba(0,0,0,0.3); --glass-bg: rgba(30,30,30,1); --glass-border: var(--border); }
  
  /* ===== DESIGN SYSTEM: GLASSMORPHISM ===== */
  
  /* Design dropdown */
  #design-dropdown.show, #design-dropdown-project.show { display:block !important; }
  #design-dropdown div:hover, #design-dropdown-project div:hover { background:var(--primary); color:white; }

  /* ===== DESIGN SYSTEM: NEUMORPHISM ===== */

  /* ===== DESIGN SYSTEM: DARK CINEMA ===== */

  /* ===== DESIGN SYSTEM: CYBERPUNK/NEON ===== */
  body.design-neon { --bg: #0d0d0d; --panel-bg: rgba(20,20,30,0.9); --text-main: #0ff; --text-sec: #f0f; --border: #0ff; --input-bg: rgba(0,255,255,0.05); --primary: #f0f; --shadow: 0 0 20px rgba(0,255,255,0.3); --radius: 0px; }
  body.design-neon * { font-family: 'Courier New', monospace !important; }
  body.design-neon .auth-box, body.design-neon header, body.design-neon .dash-card, body.design-neon .contact-card, body.design-neon .modal-content, body.design-neon .profile-modal-box, body.design-neon .board-sidebar, body.design-neon .sc-panel, body.design-neon .sb-sidebar, body.design-neon .sb-card, body.design-neon .planning-sidebar, body.design-neon .planning-day-card, body.design-neon .expenses-sidebar, body.design-neon .expense-card, body.design-neon .universe-search, body.design-neon .moodboard-sidebar, body.design-neon #quick-nav { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; box-shadow: var(--shadow), inset 0 0 30px rgba(0,255,255,0.05) !important; border-radius: 0 !important; }
  body.design-neon input, body.design-neon select, body.design-neon textarea { background: var(--input-bg) !important; border: 1px solid var(--border) !important; color: var(--text-main) !important; border-radius: 0 !important; }
  body.design-neon button { background: transparent !important; border: 1px solid var(--primary) !important; color: var(--primary) !important; text-transform: uppercase !important; letter-spacing: 2px !important; border-radius: 0 !important; }
  body.design-neon button:hover { background: var(--primary) !important; color: #000 !important; box-shadow: 0 0 20px var(--primary) !important; }
  body.design-neon h1, body.design-neon h2, body.design-neon h3 { text-shadow: 0 0 10px var(--text-main) !important; }

  /* ===== DESIGN SYSTEM: NATURE ===== */

  /* ===== DESIGN SYSTEM: SUNSET ===== */

  /* ===== DESIGN SYSTEM: OCEAN ===== */

  /* ===== DESIGN SYSTEM: LAVENDER ===== */
  body.design-lavender { --bg: #f3e8ff; --panel-bg: #ffffff; --text-main: #4a2c6a; --text-sec: #7c5a9a; --border: #e2d0f0; --input-bg: #faf5ff; --primary: #8b5cf6; --shadow: rgba(139,92,246,0.1); --radius: 20px; }
  body.design-lavender.dark-mode { --bg: #1e1528; --panel-bg: #2a1f38; --text-main: #e8d5ff; --text-sec: #b794d4; --border: #3d2a54; --input-bg: #251a32; }
  body.design-lavender .auth-box, body.design-lavender header, body.design-lavender .dash-card, body.design-lavender .contact-card, body.design-lavender .modal-content, body.design-lavender .profile-modal-box { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; box-shadow: 0 4px 20px var(--shadow) !important; }
  body.design-lavender button { border-radius: 25px !important; }

  /* ===== DESIGN SYSTEM: MINIMAL ===== */
  body.design-minimal { --bg: #ffffff; --panel-bg: #ffffff; --text-main: #111111; --text-sec: #666666; --border: #e5e5e5; --input-bg: #fafafa; --primary: #111111; --shadow: none; --radius: 2px; }
  body.design-minimal.dark-mode { --bg: #111111; --panel-bg: #111111; --text-main: #ffffff; --text-sec: #888888; --border: #333333; --input-bg: #1a1a1a; --primary: #ffffff; }
  body.design-minimal .auth-box, body.design-minimal header, body.design-minimal .dash-card, body.design-minimal .contact-card, body.design-minimal .modal-content, body.design-minimal .profile-modal-box, body.design-minimal .board-sidebar, body.design-minimal .universe-search { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; box-shadow: none !important; }
  body.design-minimal button { border-radius: var(--radius) !important; text-transform: uppercase !important; letter-spacing: 1px !important; font-weight: 400 !important; }
  body.design-minimal h1, body.design-minimal h2, body.design-minimal h3 { font-weight: 300 !important; letter-spacing: -0.5px !important; }

  /* ===== DESIGN SYSTEM: TERMINAL ===== */

  /* Brutalist supprimÃ© */
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text-main); display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; height: 100vh; height: calc(var(--vh, 1vh) * 100); min-height: -webkit-fill-available; overflow: hidden; -webkit-overflow-scrolling: touch; }

  /* --- AUTH & DASHBOARD --- */
  #auth-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  body.dark-mode #auth-view { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); }
  
  /* Spinner de chargement */
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
  .spinner.dark { border-color: rgba(0,0,0,0.2); border-top-color: var(--primary); }
  @keyframes spin { to { transform: rotate(360deg); } }
  .btn-loading { opacity: 0.8; pointer-events: none; }
  
  /* Notifications Toast */
  .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 99999; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; gap: 10px; pointer-events: none; }
  .toast-container > *:not(:last-child) { margin-bottom: 10px; } /* gap fallback */
  .toast { padding: 15px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: -webkit-box; display: -webkit-flex; display: flex; -webkit-align-items: center; align-items: center; gap: 10px; -webkit-animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; pointer-events: auto; max-width: 350px; }
  .toast > *:not(:last-child) { margin-right: 10px; } /* gap fallback */
  .toast.success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
  .toast.error { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
  .toast.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #333; }
  .toast.info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
  .toast-icon { font-size: 1.2rem; }
  .toast-message { flex: 1; }
  .toast-close { background: none; border: none; color: inherit; font-size: 1.2rem; cursor: pointer; opacity: 0.8; }
  .toast-close:hover { opacity: 1; }
  @-webkit-keyframes toastIn { from { -webkit-transform: translateX(100%); transform: translateX(100%); opacity: 0; } to { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; } }
  @keyframes toastIn { from { -webkit-transform: translateX(100%); transform: translateX(100%); opacity: 0; } to { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; } }
  @-webkit-keyframes toastOut { from { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; } to { -webkit-transform: translateX(100%); transform: translateX(100%); opacity: 0; } }
  @keyframes toastOut { from { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; } to { -webkit-transform: translateX(100%); transform: translateX(100%); opacity: 0; } }
  
  /* ===== RESPONSIVE MOBILE ===== */
  @media (max-width: 768px) {
    /* Dashboard */
    #dashboard-view { padding: 15px; }
    .dash-header { flex-direction: column; gap: 15px; align-items: flex-start; }
    .dash-header > div:last-child { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; }
    .dash-header button { flex: 1; min-width: 100px; font-size: 0.85rem; padding: 8px 12px; }
    
    /* Profil public */
    .public-profile-header { padding: 15px; flex-direction: column; gap: 10px; align-items: flex-start; }
    .public-profile-body { padding: 15px; }
    .profile-photo-section { flex-direction: column; align-items: center; text-align: center; }
    .profile-row > * { min-width: 100%; }
    
    /* Contacts */
    .contacts-header { padding: 15px; flex-direction: column; gap: 10px; align-items: flex-start; }
    .contacts-body { padding: 15px; }
    .contacts-tabs { flex-wrap: wrap; }
    .contacts-grid { grid-template-columns: 1fr; }
    
    /* Modales */
    .profile-modal-overlay { padding: 10px; }
    .profile-modal-box { max-width: 100%; }
    .global-search-container { width: 100%; max-width: 100%; }
    .permissions-container { width: 100%; max-width: 100%; }
    
    /* Chat */
    .chat-panel { width: 100%; right: 0; left: 0; border-radius: 12px 12px 0 0; }
    
    /* Toasts */
    .toast-container { left: 10px; right: 10px; bottom: 10px; }
    .toast { max-width: 100%; }
    
    /* DÃ©penses */
    .expenses-container { flex-direction: column; padding: 15px; }
    .expenses-sidebar { width: 100%; }
    .expenses-summary { grid-template-columns: 1fr; }
    
    /* Header projet */
    header { padding: 10px 15px; flex-wrap: wrap; gap: 10px; }
    header input { font-size: 1rem; width: 100%; }
    .project-info { width: 100%; }
    .global-actions { width: 100%; display: flex; flex-wrap: wrap; gap: 5px; }
    .global-actions button { flex: 1; min-width: 80px; font-size: 0.75rem; padding: 6px 8px; }
    .presence-bar { display: none; }
    
    /* Tabs navigation */
    .tabs-nav { padding: 0 10px; gap: 5px; }
    .tab-btn { padding: 10px 8px; font-size: 0.8rem; }
    
    /* Main content */
    main { padding: 15px; padding-right: 15px; }
    #quick-nav { display: none !important; }
    
    /* Sidebar projet (breakdown, etc.) */
    .board-sidebar { position: fixed !important; left: -280px; top: 0; height: 100vh; z-index: 1000; transition: left 0.3s ease; }
    .board-sidebar.mobile-open { left: 0; }
    
    /* Planning */
    .planning-container { flex-direction: column; }
    .planning-sidebar { width: 100%; max-height: 200px; }
    
    /* Tableaux */
    .permissions-table { font-size: 0.75rem; display: block; overflow-x: auto; }
    .permissions-table th, .permissions-table td { padding: 6px 4px; }
    
    /* Bouton menu hamburger */
    .mobile-menu-btn { display: flex !important; }
    
    /* Overlay pour fermer sidebar */
    .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    .mobile-overlay.active { display: block; }
  }
  
  /* Bouton menu hamburger (cachÃ© par dÃ©faut sur desktop) */
  .mobile-menu-btn { display: none; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; cursor: pointer; font-size: 1.2rem; }
  .mobile-menu-btn:hover { background: var(--primary); color: white; }

  /* Responsive petits Ã©crans (phones) */
  @media (max-width: 480px) {
    /* ===== RESET MOBILE ===== */
    * { box-sizing: border-box; max-width: 100vw; }
    body, html { overflow-x: hidden; }
    
    /* ===== AUTH ===== */
    .auth-box { padding: 20px 15px; margin: 10px; width: calc(100% - 20px); }
    button, .auth-btn, .tab-btn { min-height: 44px; }
    input, select, textarea, .profile-input, .auth-input { font-size: 16px !important; padding: 12px; width: 100%; }
    
    /* ===== DASHBOARD MENU ===== */
    .menu-bar { display: flex; flex-wrap: wrap; gap: 5px; padding: 10px; justify-content: center; }
    .menu-item { font-size: 0.75rem; padding: 8px 10px; flex: 0 0 auto; }
    .menu-dropdown { 
      position: fixed !important; 
      left: 10px !important; 
      right: 10px !important; 
      top: auto !important; 
      bottom: 70px !important; 
      max-height: 60vh; 
      overflow-y: auto; 
      z-index: 10001;
      width: auto !important;
    }
    
    /* ===== UNIVERS ===== */
    .universe-container { flex-direction: column; height: auto; }
    .universe-sidebar { 
      width: 100% !important; 
      min-width: 100% !important; 
      max-height: none !important; 
      padding: 10px !important; 
      border-right: none !important;
      border-bottom: 1px solid var(--border);
    }
    .universe-sidebar > div { margin-bottom: 10px; }
    .universe-view-toggle { 
      position: relative !important; 
      top: 0 !important; 
      right: 0 !important; 
      margin: 10px auto; 
      display: flex; 
      justify-content: center;
    }
    .universe-scene { min-height: 400px; width: 100%; }
    #universe-map { min-height: 400px; }
    
    /* ===== PROFILS PUBLICS ===== */
    .profile-section { 
      padding: 12px !important; 
      margin-bottom: 12px !important; 
      overflow: hidden;
    }
    .profile-section h3 { font-size: 0.95rem; }
    .profile-section > div { width: 100%; }
    
    /* Labels avec checkbox - forcer retour ligne */
    .profile-section label { 
      display: flex !important; 
      flex-wrap: wrap !important; 
      align-items: flex-start !important;
      gap: 8px;
      width: 100%;
    }
    .profile-section label input[type="checkbox"] { flex-shrink: 0; margin-top: 3px; }
    .profile-section label span { flex: 1; min-width: 0; word-wrap: break-word; }
    
    /* Grilles matÃ©riel - empiler verticalement */
    .profile-section div[style*="grid-template-columns"] { 
      display: flex !important; 
      flex-direction: column !important; 
      gap: 10px !important; 
    }
    
    /* Boutons collaboration (Pro, Semi-pro, BÃ©nÃ©vole) */
    .profile-section div[style*="display: flex"][style*="gap"] {
      flex-direction: column !important;
      gap: 10px !important;
    }
    .profile-section div[style*="border-radius: 12px"][style*="padding: 15px"] {
      width: 100% !important;
      min-height: auto !important;
    }
    
    /* ===== ONGLETS PROJET ===== */
    .tabs-nav { 
      display: flex !important;
      overflow-x: auto !important; 
      -webkit-overflow-scrolling: touch; 
      flex-wrap: nowrap !important; 
      padding: 5px;
      gap: 3px;
      width: 100%;
    }
    .tabs-nav .tab-btn, .tab-btn { 
      flex-shrink: 0 !important; 
      padding: 8px 10px !important; 
      font-size: 0.7rem !important; 
      white-space: nowrap !important;
      min-width: auto !important;
    }
    .tabs-nav.adaptive { flex-wrap: nowrap !important; }
    .tabs-nav.adaptive .tab-btn { 
      flex: 0 0 auto !important; 
      min-width: auto !important; 
      max-width: none !important;
    }
    
    /* Sous-onglets (Ã‰criture) */
    .sub-tabs, div[style*="border-bottom"] > div[style*="display: flex"] {
      overflow-x: auto !important;
      -webkit-overflow-scrolling: touch;
      flex-wrap: nowrap !important;
    }
    
    /* ===== HEADER PROJET ===== */
    header { 
      padding: 8px !important; 
      flex-wrap: wrap !important; 
      gap: 8px !important; 
    }
    header .project-info { width: 100%; }
    header input[type="text"] { font-size: 0.9rem !important; }
    .global-actions { 
      width: 100%; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 5px;
      justify-content: flex-start;
    }
    .global-actions button, .global-actions .dropdown-btn { 
      padding: 6px 8px !important; 
      font-size: 0.7rem !important; 
      flex: 0 0 auto;
    }
    
    /* ===== SCÃ‰NARIO ===== */
    .board-sidebar { display: none !important; }
    .board-sidebar.mobile-open { 
      display: block !important; 
      position: fixed !important; 
      left: 0 !important; 
      top: 0 !important; 
      width: 80% !important; 
      max-width: 280px !important;
      height: 100vh !important; 
      z-index: 10000 !important;
      background: var(--panel-bg) !important;
    }
    #screenplayEditor { padding: 10px !important; font-size: 14px !important; }
    .screenplay-element { margin: 5px 0; padding: 5px; }
    main { padding: 10px !important; }
    
    /* ===== FORUM ===== */
    .forum-body { flex-direction: column !important; }
    .forum-sidebar { width: 100% !important; min-width: 100% !important; }
    .forum-sort-btn { padding: 8px 12px !important; font-size: 0.75rem !important; }
    
    /* ===== CONTACTS ===== */
    .contacts-header { padding: 10px 15px; flex-direction: row; flex-wrap: wrap; gap: 10px; }
    .contacts-header h1 { font-size: 1rem; width: 100%; }
    .contacts-body { padding: 10px; }
    .contacts-tabs { flex-wrap: wrap; gap: 5px; }
    .contacts-tab { padding: 6px 10px; font-size: 0.7rem; }
    #contacts-sub-tabs { overflow-x: auto; flex-wrap: nowrap; }
    #contacts-sub-tabs .contacts-tab { flex-shrink: 0; white-space: nowrap; }
    
    /* ===== MODALES ===== */
    .profile-modal-overlay, .message-detail-modal { padding: 0 !important; }
    .profile-modal-box, .message-detail-box { 
      border-radius: 0 !important; 
      max-height: 100vh !important; 
      height: 100vh !important; 
      width: 100% !important;
      max-width: 100% !important;
    }
    .profile-modal-header { padding: 15px; }
    .profile-modal-body { padding: 12px; }
    .confirm-modal-box { width: 95% !important; padding: 15px; }
    
    /* ===== CARDS ===== */
    .project-grid { grid-template-columns: 1fr !important; }
    .fan-card { width: calc(50% - 8px); min-width: 120px; padding: 8px; }
    .fan-card .card-photo { width: 45px; height: 45px; }
    .fan-card .card-name { font-size: 0.7rem; }
    
    /* ===== EMPÃŠCHER DÃ‰BORDEMENTS ===== */
    p, span, div, label { word-wrap: break-word; overflow-wrap: break-word; }
    img { max-width: 100%; height: auto; }
    .global-actions .dropdown-btn { padding: 5px 8px; }
    
    /* Planning */
    .planning-day-card { padding: 10px; }
    .planning-scene-mini { padding: 5px; font-size: 0.75rem; }
    
    /* Breakdown */
    .breakdown-section { padding: 10px; }
    .breakdown-item { padding: 8px; font-size: 0.8rem; }
    
    /* ScÃ©nario */
    #screenplayEditor { padding: 10px !important; font-size: 14px !important; }
    .screenplay-element { margin: 5px 0; padding: 5px; }
    
    /* Confirm Modal */
    .confirm-modal-box { padding: 20px; width: 95%; }
    .confirm-modal-btn { padding: 10px 15px; font-size: 0.85rem; min-width: 80px; }
    
    /* Toast */
    .toast { padding: 10px 15px; font-size: 0.85rem; }
    
    /* Messages */
    .messages-tab { padding: 8px 10px; font-size: 0.75rem; }
    .message-item { padding: 10px; }
    
    /* EmpÃªcher dÃ©bordement horizontal */
    body, html { overflow-x: hidden; }
    * { max-width: 100vw; }
  }
  
  /* iPhone SE et petits Ã©crans */
  @media (max-width: 375px) {
    .menu-item { font-size: 0.7rem; padding: 6px 8px; }
    .tab-btn { font-size: 0.7rem; padding: 6px 8px; }
    .fan-card { width: calc(50% - 5px); min-width: 110px; padding: 8px; }
    .fan-card .card-photo { width: 40px; height: 40px; }
    .contacts-tab { padding: 6px 8px; font-size: 0.7rem; }
    #contacts-sub-tabs .contacts-tab { padding: 5px 6px; font-size: 0.65rem; }
    .profile-modal-name { font-size: 1rem; }
    .global-actions button { font-size: 0.65rem; padding: 4px 6px; }
  }

  .auth-box { background: var(--panel-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px var(--shadow); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border); }.global-actions button { font-size: 0.65rem; padding: 4px 6px; }
  }

  .auth-box { background: var(--panel-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px var(--shadow); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border); }
  .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; background: var(--input-bg); color: var(--text-main); }
  .auth-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; }
  .auth-link { display: block; margin-top: 15px; color: var(--text-sec); font-size: 0.85rem; cursor: pointer; text-decoration: underline; }
  .auth-error { color: var(--danger); font-size: 0.85rem; margin-bottom: 15px; display: none; padding: 10px; background: rgba(255, 68, 68, 0.1); border-radius: 4px; }
  .auth-success { color: var(--success); font-size: 0.85rem; margin-bottom: 15px; display: none; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 4px; }

  #dashboard-view { display: none; flex-direction: column; height: 100%; width: 100%; background: var(--bg); padding: 40px; overflow-y: auto; }
  .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; max-width: 1200px; margin-left: auto; margin-right: auto; width: 100%; }
  .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
  
  /* Contacts */
  .contacts-view { display: none; flex-direction: column; width: 100%; height: 100vh; background: var(--bg); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; }
  .contacts-view.active { display: flex; }
  .contacts-header { background: var(--panel-bg); padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .contacts-header h1 { margin: 0; font-size: 1.5rem; }
  .contacts-body { flex: 1; overflow-y: auto; padding: 20px 40px; }
  .contacts-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
  .contacts-tab { padding: 10px 20px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600; }
  .contacts-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
  .contacts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

  /* ===== FORUM COMMUNAUTAIRE ===== */
  .forum-view { display: none; flex-direction: column; width: 100%; height: 100vh; background: var(--bg); }
  .forum-view.active { display: flex; }
  .forum-header { background: var(--panel-bg); padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .forum-header h1 { margin: 0; font-size: 1.5rem; }
  .forum-body { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; gap: 20px; }
  .forum-sidebar { width: 250px; min-width: 250px; }
  .forum-main { flex: 1; }
  .forum-categories { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; }
  .forum-category { padding: 12px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
  .forum-category:hover { background: var(--highlight); }
  .forum-category.active { background: var(--primary); color: white; }
  .forum-category-icon { font-size: 1.2rem; }
  .forum-category-name { font-weight: 600; }
  .forum-category-count { margin-left: auto; font-size: 0.8rem; opacity: 0.7; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; }
  .forum-threads { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; }
  .forum-threads-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .forum-threads-title { font-weight: 700; font-size: 1.1rem; }
  .forum-sort { display: flex; gap: 10px; }
  .forum-sort-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--bg); border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
  .forum-sort-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
  .forum-thread { padding: 15px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
  .forum-thread:hover { background: var(--highlight); }
  .forum-thread:last-child { border-bottom: none; }
  .forum-thread-title { font-weight: 600; font-size: 1rem; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
  .forum-thread-title .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
  .forum-thread-title .badge.resolved { background: #10b981; color: white; }
  .forum-thread-title .badge.pinned { background: #f59e0b; color: white; }
  .forum-thread-meta { font-size: 0.85rem; color: var(--text-sec); display: flex; gap: 15px; }
  .forum-thread-votes { display: flex; align-items: center; gap: 5px; }
  .forum-thread-votes .upvote, .forum-thread-votes .downvote { cursor: pointer; padding: 2px; border-radius: 4px; }
  .forum-thread-votes .upvote:hover { color: #10b981; }
  .forum-thread-votes .downvote:hover { color: #ef4444; }
  .forum-thread-votes .score { font-weight: 600; min-width: 30px; text-align: center; }
  .forum-new-thread { padding: 15px 20px; }
  .forum-new-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; }
  .forum-new-btn:hover { opacity: 0.9; }
  .forum-post { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 15px; }
  .forum-post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
  .forum-post-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
  .forum-post-author { font-weight: 600; }
  .forum-post-date { font-size: 0.85rem; color: var(--text-sec); }
  .forum-post-content { line-height: 1.7; margin-bottom: 15px; }
  .forum-post-actions { display: flex; gap: 15px; font-size: 0.9rem; color: var(--text-sec); }
  .forum-post-action { cursor: pointer; display: flex; align-items: center; gap: 5px; }
  .forum-post-action:hover { color: var(--primary); }
  .forum-replies { margin-left: 30px; border-left: 2px solid var(--border); padding-left: 20px; }
  
  /* ===== MUR SOCIAL (FEED) ===== */
  .feed-view { display: none; flex-direction: column; width: 100%; height: 100vh; background: var(--bg); }
  .feed-view.active { display: flex; }
  .feed-header { background: var(--panel-bg); padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .feed-header h1 { margin: 0; font-size: 1.5rem; }
  .feed-body { flex: 1; overflow-y: auto; padding: 20px 40px; max-width: 700px; margin: 0 auto; width: 100%; }
  .feed-composer { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
  .feed-composer-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
  .feed-composer-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.1rem; }
  .feed-composer-input { flex: 1; }
  .feed-composer-textarea { width: 100%; min-height: 80px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text-main); font-size: 1rem; resize: none; font-family: inherit; }
  .feed-composer-textarea:focus { outline: none; border-color: var(--primary); }
  .feed-composer-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
  .feed-composer-tools { display: flex; gap: 10px; }
  .feed-composer-tool { padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
  .feed-composer-tool:hover { border-color: var(--primary); }
  .feed-composer-submit { padding: 10px 25px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
  .feed-composer-submit:hover { opacity: 0.9; }
  .feed-post { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; overflow: hidden; }
  .feed-post-header { display: flex; align-items: center; gap: 12px; padding: 15px 20px; }
  .feed-post-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
  .feed-post-info { flex: 1; }
  .feed-post-author { font-weight: 600; }
  .feed-post-meta { font-size: 0.85rem; color: var(--text-sec); display: flex; align-items: center; gap: 8px; }
  .feed-post-type { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: var(--highlight); }
  .feed-post-type.annonce { background: #fef3c7; color: #92400e; }
  .feed-post-type.recherche { background: #dbeafe; color: #1e40af; }
  .feed-post-content { padding: 0 20px 15px; line-height: 1.7; }
  .feed-post-image { width: 100%; max-height: 400px; object-fit: cover; }
  .feed-post-actions { display: flex; border-top: 1px solid var(--border); }
  .feed-post-action { flex: 1; padding: 12px; text-align: center; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--text-sec); transition: all 0.2s; }
  .feed-post-action:hover { background: var(--highlight); color: var(--primary); }
  .feed-post-action.liked { color: #ef4444; }
  .feed-post-comments { border-top: 1px solid var(--border); padding: 15px 20px; background: var(--bg); }
  .feed-comment { display: flex; gap: 10px; margin-bottom: 12px; }
  .feed-comment:last-child { margin-bottom: 0; }
  .feed-comment-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
  .feed-comment-content { flex: 1; background: var(--panel-bg); padding: 10px 12px; border-radius: 8px; }
  .feed-comment-author { font-weight: 600; font-size: 0.9rem; }
  .feed-comment-text { font-size: 0.9rem; margin-top: 3px; }
  .feed-comment-input { display: flex; gap: 10px; margin-top: 12px; }
  .feed-comment-input input { flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 20px; background: var(--panel-bg); color: var(--text-main); }
  .feed-comment-input button { padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 20px; cursor: pointer; }
  @media (max-width: 768px) { .forum-body { flex-direction: column; } .forum-sidebar { width: 100%; min-width: 100%; } .feed-body { padding: 15px; } }

  /* Dropdown menus */
  .dropdown-menu.show, #design-dropdown.show { display: block !important; }
  .nav-dropdown .dropdown-menu, #design-dropdown { margin-top: 0 !important; padding-top: 5px; }
  .nav-dropdown .dropdown-menu > div:first-child, #design-dropdown > div:first-child { margin-top: 5px; }

  /* Forum sous-catÃ©gories */
  .forum-category-parent { padding: 12px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: all 0.2s; background: var(--highlight); font-weight: 600; }
  .forum-category-parent:hover { background: var(--border); }
  .forum-category-parent .forum-category-arrow { margin-left: auto; font-size: 0.8rem; transition: transform 0.2s; }
  .forum-category-parent.expanded .forum-category-arrow { transform: rotate(90deg); }
  .forum-subcategories { display: none; margin-left: 15px; border-left: 2px solid var(--border); padding-left: 10px; margin-bottom: 10px; }
  .forum-category-parent.expanded + .forum-subcategories { display: block; }
  .forum-category.sub { padding: 8px 12px; font-size: 0.9rem; }
  .forum-category.sub .forum-category-name { font-size: 0.85rem; }

  /* Barre d'outils d'Ã©dition (Forum & Fil) */
  .editor-toolbar { display: flex; gap: 8px; padding: 10px 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 10px 10px 0 0; flex-wrap: wrap; align-items: center; }
  .editor-toolbar button { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; color: var(--text-main); }
  .editor-toolbar button:hover { background: var(--primary); color: white; border-color: var(--primary); }
  .editor-toolbar button.active { background: var(--primary); color: white; border-color: var(--primary); }

  /* ========== SYSTÃˆME D'ICÃ”NES ========== */
  .moteur-icon { display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; width: 20px; height: 20px; }
  .moteur-icon svg { width: 100%; height: 100%; }
  .moteur-icon .emoji { line-height: 1; }
  
  /* Style: EMOJI (Classique) */
  .icon-style-emoji .moteur-icon { font-size: 1.1rem; }
  .icon-style-emoji .moteur-icon svg { display: none; }
  .icon-style-emoji .moteur-icon .emoji { display: inline; }
  
  
  /* Style: COLORED (Fonds colorÃ©s) */
  .icon-style-colored .moteur-icon { width: 28px; height: 28px; border-radius: 6px; padding: 5px; }
  .icon-style-colored .moteur-icon svg { stroke: white; stroke-width: 2; }
  .icon-style-colored .moteur-icon .emoji { display: none; }
  .icon-style-colored .moteur-icon.cat-writing { background: #3b82f6; }
  .icon-style-colored .moteur-icon.cat-visual { background: #8b5cf6; }
  .icon-style-colored .moteur-icon.cat-casting { background: #f59e0b; }
  .icon-style-colored .moteur-icon.cat-production { background: #10b981; }
  .icon-style-colored .moteur-icon.cat-admin { background: #ef4444; }
  .icon-style-colored .moteur-icon.cat-social { background: #ec4899; }
  .icon-style-colored .moteur-icon.cat-system { background: #64748b; }
  .icon-style-colored .moteur-icon.cat-help { background: #06b6d4; }
  
  /* Style: DUOTONE */
  .icon-style-duotone .moteur-icon { width: 28px; height: 28px; border-radius: 6px; padding: 5px; }
  .icon-style-duotone .moteur-icon svg { stroke-width: 1.75; }
  .icon-style-duotone .moteur-icon .emoji { display: none; }
  .icon-style-duotone .moteur-icon.cat-writing { background: rgba(59, 130, 246, 0.15); }
  .icon-style-duotone .moteur-icon.cat-writing svg { stroke: #3b82f6; }
  .icon-style-duotone .moteur-icon.cat-visual { background: rgba(139, 92, 246, 0.15); }
  .icon-style-duotone .moteur-icon.cat-visual svg { stroke: #8b5cf6; }
  .icon-style-duotone .moteur-icon.cat-casting { background: rgba(245, 158, 11, 0.15); }
  .icon-style-duotone .moteur-icon.cat-casting svg { stroke: #f59e0b; }
  .icon-style-duotone .moteur-icon.cat-production { background: rgba(16, 185, 129, 0.15); }
  .icon-style-duotone .moteur-icon.cat-production svg { stroke: #10b981; }
  .icon-style-duotone .moteur-icon.cat-admin { background: rgba(239, 68, 68, 0.15); }
  .icon-style-duotone .moteur-icon.cat-admin svg { stroke: #ef4444; }
  .icon-style-duotone .moteur-icon.cat-social { background: rgba(236, 72, 153, 0.15); }
  .icon-style-duotone .moteur-icon.cat-social svg { stroke: #ec4899; }
  .icon-style-duotone .moteur-icon.cat-system { background: rgba(100, 116, 139, 0.15); }
  .icon-style-duotone .moteur-icon.cat-system svg { stroke: #64748b; }
  .icon-style-duotone .moteur-icon.cat-help { background: rgba(6, 182, 212, 0.15); }
  .icon-style-duotone .moteur-icon.cat-help svg { stroke: #06b6d4; }
  
  /* Style: MINIMAL */
  .icon-style-minimal .moteur-icon { width: 18px; height: 18px; }
  .icon-style-minimal .moteur-icon svg { stroke: var(--text-sec); stroke-width: 1.5; }
  .icon-style-minimal .moteur-icon .emoji { display: none; }
  .icon-style-minimal *:hover > .moteur-icon svg { stroke: var(--text-main); }
  
  /* Style: GRADIENT */
  .icon-style-gradient .moteur-icon { width: 28px; height: 28px; border-radius: 8px; padding: 5px; }
  .icon-style-gradient .moteur-icon svg { stroke: white; stroke-width: 2; }
  .icon-style-gradient .moteur-icon .emoji { display: none; }
  .icon-style-gradient .moteur-icon.cat-writing { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .icon-style-gradient .moteur-icon.cat-visual { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
  .icon-style-gradient .moteur-icon.cat-casting { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
  .icon-style-gradient .moteur-icon.cat-production { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
  .icon-style-gradient .moteur-icon.cat-admin { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
  .icon-style-gradient .moteur-icon.cat-admin svg { stroke: #333; }
  .icon-style-gradient .moteur-icon.cat-social { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
  .icon-style-gradient .moteur-icon.cat-social svg { stroke: #333; }
  .icon-style-gradient .moteur-icon.cat-system { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
  .icon-style-gradient .moteur-icon.cat-help { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
  .icon-style-gradient .moteur-icon.cat-help svg { stroke: #333; }
  
  /* Sous-menu Design */
  .design-submenu-title { padding: 8px 15px 4px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-sec); border-top: 1px solid var(--border); margin-top: 5px; }
  .editor-toolbar select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text-main); font-size: 0.85rem; height: 32px; }
  .editor-toolbar .separator { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
  .editor-content { width: 100%; min-height: 120px; padding: 15px; border: 1px solid var(--border); border-top: none; border-radius: 0 0 10px 10px; background: var(--bg); color: var(--text-main); font-size: 1rem; line-height: 1.6; outline: none; }
  .editor-content:focus { border-color: var(--primary); }
  .editor-content:empty:before { content: attr(data-placeholder); color: var(--text-sec); pointer-events: none; }
  .editor-box { background: var(--panel-bg); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
  .editor-actions { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--panel-bg); border-top: 1px solid var(--border); }
  .editor-actions-left { display: flex; gap: 10px; align-items: center; }
  .editor-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
  .editor-btn:hover { border-color: var(--primary); color: var(--primary); }
  .editor-btn-primary { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }
  .editor-btn-primary:hover { opacity: 0.9; color: white; }
  .image-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin: 10px 15px; }
  .image-preview-container { position: relative; display: inline-block; margin: 10px 15px; }
  .image-preview-container .remove-image { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

  /* Vue Cours CinÃ©ma */
  .courses-view { display: none; flex-direction: column; width: 100%; height: 100vh; background: var(--bg); }
  .courses-view.active { display: flex; }
  .courses-header { background: var(--panel-bg); padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .courses-header h1 { margin: 0; font-size: 1.5rem; }
  .courses-body { flex: 1; overflow-y: auto; padding: 20px 40px; }
  .courses-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
  .courses-tab { padding: 10px 20px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
  .courses-tab:hover { border-color: var(--primary); }
  .courses-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
  .courses-content { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 30px; }
  .courses-section { margin-bottom: 30px; }
  .courses-section:last-child { margin-bottom: 0; }
  .courses-section h2 { color: var(--primary); margin: 0 0 15px 0; font-size: 1.3rem; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
  .courses-section h3 { color: var(--text-main); margin: 20px 0 10px 0; font-size: 1.1rem; }
  .courses-section p { color: var(--text-main); line-height: 1.7; margin: 10px 0; }
  .courses-section ul { margin: 10px 0; padding-left: 25px; }
  .courses-section li { color: var(--text-main); line-height: 1.8; margin: 5px 0; }
  .courses-tip { background: rgba(99, 102, 241, 0.1); border-left: 4px solid var(--primary); padding: 15px; border-radius: 0 8px 8px 0; margin: 15px 0; }
  .courses-tip strong { color: var(--primary); }
  .courses-warning { background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; padding: 15px; border-radius: 0 8px 8px 0; margin: 15px 0; }
  .courses-warning strong { color: #f59e0b; }
  .courses-term { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin: 10px 0; }
  .courses-term dt { font-weight: bold; color: var(--primary); font-size: 1rem; margin-bottom: 5px; }
  .courses-term dd { margin: 0; color: var(--text-main); line-height: 1.6; }

  /* Infobulles des notions */
  .notion { cursor: help; border-bottom: 1px dotted var(--primary); position: relative; }
  .notion:hover { color: var(--primary); }
  .notion-tooltip { position: fixed; z-index: 100000; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); padding: 20px; max-width: 400px; min-width: 300px; display: none; }
  .notion-tooltip.visible { display: block; }
  .notion-tooltip-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; border-bottom: 2px solid var(--primary); padding-bottom: 8px; }
  .notion-tooltip-content { color: var(--text-main); line-height: 1.7; font-size: 0.95rem; }
  .notion-tooltip-content p { margin: 10px 0; }
  .notion-tooltip-image { margin: 15px 0; text-align: center; }
  .notion-tooltip-image img, .notion-tooltip-image svg { max-width: 100%; height: auto; border-radius: 8px; }
  .notion-tooltip-example { background: var(--bg); border-left: 3px solid var(--primary); padding: 10px 15px; margin: 10px 0; font-style: italic; font-size: 0.9rem; }
  .notion-tooltip-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-sec); }
  .notion-tooltip-close:hover { color: var(--danger); }
  .contact-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; }
  .contact-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .contact-card-photo { width: 50px; height: 50px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden; }
  .contact-card-photo img { width: 100%; height: 100%; object-fit: cover; }
  .contact-card-name { font-weight: bold; font-size: 1rem; }
  .contact-card-role { font-size: 0.85rem; color: var(--text-sec); }
  .contact-card-info { font-size: 0.85rem; color: var(--text-sec); margin-top: 8px; }
  .contact-card-actions { display: flex; gap: 8px; margin-top: 10px; }
  .contact-card-actions button { padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); background: var(--bg); }
  .contact-card-actions button:hover { background: var(--primary); color: white; border-color: var(--primary); }
  .save-contact-btn { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 2px 5px; border-radius: 4px; }
  .save-contact-btn:hover { background: var(--bg); }
  .save-contact-btn.saved { color: var(--success); }

/* Universe - Floating Cards */
.universe-container { position: relative; width: 100%; height: calc(100vh - 180px); height: calc(var(--vh, 1vh) * 100 - 180px); min-height: 500px; overflow: visible; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: row; flex-direction: row; -webkit-align-items: stretch; align-items: stretch; }
@media (max-width: 768px) { .universe-container { flex-direction: column; height: auto; min-height: calc(100vh - 120px); } .universe-container .universe-sidebar { width: 100% !important; min-width: 100% !important; max-height: 300px; border-right: none !important; border-bottom: 1px solid var(--border); } .universe-container .universe-scene { min-height: 400px; } }
.universe-search { display: flex; gap: 10px; padding: 20px; background: var(--panel-bg); border-radius: 12px; box-shadow: 0 4px 20px var(--shadow); z-index: 10; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
.universe-search select, .universe-search input { padding: 10px 15px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); font-size: 0.95rem; min-width: 150px; }
.universe-search button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
.universe-search button:hover { opacity: 0.9; }
.universe-scene { position: relative; flex: 1; width: 100%; }
#universe-map { width: 100%; height: 100%; min-height: 500px; background: #1a1a2e; z-index: 1; }
body:not(.dark-mode) #universe-map { background: #f4f6f8; }
.leaflet-container { background: #1a1a2e; }
body:not(.dark-mode) .leaflet-container { background: #f4f6f8; }
.map-profile-marker { width: 40px; height: 50px; position: relative; cursor: pointer; transition: transform 0.3s ease-out, z-index 0.2s, opacity 0.3s ease-out; animation: markerAppear 0.5s ease-out; }
.map-profile-marker:hover { transform: scale(2.5); z-index: 10000 !important; }
@keyframes markerAppear { 0% { opacity: 0; transform: scale(0.3) translateY(-20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
.leaflet-marker-icon { transition: transform 0.4s ease-out !important; }
.map-profile-marker img { width: 100%; height: 40px; object-fit: cover; border-radius: 6px; border: 2px solid var(--primary); background: var(--panel-bg); }
.map-profile-marker .marker-label { position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 7px; white-space: nowrap; background: rgba(0,0,0,0.8); color: white; padding: 1px 4px; border-radius: 3px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; }
.map-profile-marker.project-marker img { border-color: #e94560; }
.map-profile-marker.actor-marker img { border-color: #4CAF50; }
.map-profile-marker.crew-marker img { border-color: #2196F3; }
.map-profile-marker.association-marker img { border-color: #FF9800; }
.map-profile-marker.enterprise-marker img { border-color: #9C27B0; }
.marker-cluster { background: rgba(110, 204, 57, 0.6); border-radius: 50%; }
.marker-cluster div { background: rgba(110, 204, 57, 0.9); border-radius: 50%; margin: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
.marker-cluster-small { background: rgba(181, 226, 140, 0.6); }
.marker-cluster-small div { background: rgba(110, 204, 57, 0.9); }
.marker-cluster-medium { background: rgba(241, 211, 87, 0.6); }
.marker-cluster-medium div { background: rgba(240, 194, 12, 0.9); }
.marker-cluster-large { background: rgba(253, 156, 115, 0.6); }
.marker-cluster-large div { background: rgba(241, 128, 23, 0.9); }
.map-hover-card { position: fixed; z-index: 20000; pointer-events: none; animation: fadeInCard 0.2s ease; }
@keyframes fadeInCard { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.map-hover-card .fan-card { pointer-events: auto; margin: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
.universe-view-toggle { position: absolute; top: 10px; right: 20px; z-index: 10001; background: var(--panel-bg); border-radius: 8px; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); pointer-events: auto; }
.universe-scene { position: relative; }

/* === TUTORIEL & AIDE CONTEXTUELLE === */
.tuto-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 5px;
}
.tuto-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}
.help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    font-size: 0.7rem;
    cursor: pointer;
    margin-left: 6px;
    transition: all 0.2s;
    vertical-align: middle;
}
.help-icon:hover {
    transform: scale(1.15);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.tuto-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}
.tuto-modal-overlay.show {
    opacity: 1;
    visibility: visible;
}
.tuto-modal {
    background: var(--panel-bg);
    border-radius: 16px;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    transform: scale(0.9);
    transition: transform 0.3s;
}
.tuto-modal-overlay.show .tuto-modal {
    transform: scale(1);
}
.tuto-modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.tuto-modal-header h2 {
    margin: 0;
    font-size: 1.4rem;
}
.tuto-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-sec);
    padding: 5px;
}
.tuto-modal-close:hover {
    color: var(--text-main);
}
.tuto-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    display: flex;
}
.tuto-sidebar {
    width: 220px;
    min-width: 220px;
    background: var(--bg);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 10px 0;
}
.tuto-sidebar-item {
    padding: 10px 15px;
    cursor: pointer;
    font-size: 0.85rem;
    border-left: 3px solid transparent;
    transition: all 0.2s;
}
.tuto-sidebar-item:hover {
    background: var(--highlight);
}
.tuto-sidebar-item.active {
    background: var(--highlight);
    border-left-color: var(--primary);
    font-weight: 600;
}
.tuto-content {
    flex: 1;
    padding: 25px;
    overflow-y: auto;
}
.tuto-content h3 {
    margin: 0 0 15px 0;
    color: var(--primary);
    font-size: 1.2rem;
}
.tuto-content p {
    margin: 0 0 12px 0;
    line-height: 1.6;
    color: var(--text-main);
}
.tuto-tip {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    border-left: 3px solid var(--primary);
    padding: 12px 15px;
    border-radius: 0 8px 8px 0;
    margin: 15px 0;
    font-size: 0.9rem;
}
.tuto-tip strong {
    color: var(--primary);
}
/* Help tooltip popup */
.help-popup {
    position: fixed;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 15px 20px;
    max-width: 350px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 10001;
    font-size: 0.9rem;
    line-height: 1.5;
    display: none;
}
.help-popup.show {
    display: block;
    animation: helpPopIn 0.2s ease;
}
@keyframes helpPopIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
.help-popup-title {
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--primary);
}
.help-popup-close {
    position: absolute;
    top: 8px;
    right: 10px;
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--text-sec);
}
@media (max-width: 768px) {
    .tuto-modal-body { flex-direction: column; }
    .tuto-sidebar { width: 100%; min-width: 100%; border-right: none; border-bottom: 1px solid var(--border); max-height: 150px; }
}
.floating-card { position: absolute; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; width: 160px; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--shadow); }
.floating-card:hover { transform: scale(1.05); box-shadow: 0 8px 30px rgba(43, 110, 246, 0.3); border-color: var(--primary); z-index: 100 !important; }
.floating-card.blurred { filter: blur(3px); opacity: 0.6; }
.floating-card.project-card { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #e94560; }
.floating-card.project-card .card-photo.project-photo { background: linear-gradient(135deg, #e94560 0%, #0f3460 100%); }
.floating-card.project-card .card-name { color: #ffffff; }
.floating-card.project-card .project-type { color: #e94560; font-weight: bold; }
.floating-card.project-card .card-needs { font-size: 0.7rem; color: #ffc107; margin-top: 3px; }
.floating-card.project-card.blurred { filter: blur(2px); opacity: 0.6; }
.floating-card.project-card:hover { border-color: #ff6b6b; box-shadow: 0 8px 25px rgba(233, 69, 96, 0.4); }
.floating-card.main-card { filter: none; opacity: 1; z-index: 50; width: 200px; box-shadow: 0 8px 40px rgba(43, 110, 246, 0.4); border: 2px solid var(--primary); }
.floating-card.search-result { filter: none; opacity: 1; z-index: 40; animation: popIn 0.3s ease; }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.floating-card.blurred { z-index: 1 !important; }
.floating-card.search-result, .floating-card.main-card { z-index: 40 !important; }
.floating-card .card-photo { width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 10px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; border: 2px solid var(--border); }
.floating-card .card-photo img { width: 100%; height: 100%; object-fit: cover; }
.floating-card.main-card .card-photo { width: 90px; height: 90px; border-color: var(--primary); }
.floating-card .card-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.floating-card .card-role { font-size: 0.75rem; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.floating-card .card-city { font-size: 0.7rem; color: var(--primary); margin-top: 3px; }
.universe-empty { text-align: center; color: var(--text-sec); padding: 60px 20px; }
.universe-empty h2 { margin-bottom: 10px; }

/* Universe - Vue Ã‰ventail (Fan View) - Style jeu de cartes */
.universe-fan-container { display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; padding: 30px; gap: 40px; overflow-y: auto; }
.fan-category { width: 100%; max-width: 800px; }
.fan-category-header { text-align: center; margin-bottom: 20px; }
.fan-category-label { font-weight: bold; font-size: 1.1rem; color: var(--primary); background: var(--panel-bg); padding: 8px 20px; border-radius: 20px; border: 1px solid var(--border); display: inline-block; }
.fan-category-count { font-size: 0.85rem; color: var(--text-sec); margin-left: 10px; }
.fan-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
.fan-card { background: var(--panel-bg); border: 2px solid var(--border); border-radius: 12px; padding: 15px; width: 140px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px var(--shadow); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; }
.fan-card:hover { transform: translateY(-8px); border-color: var(--primary); box-shadow: 0 12px 30px rgba(43, 110, 246, 0.3); }
.fan-card .card-photo { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; border: 2px solid var(--border); }
.fan-card .card-photo img { width: 100%; height: 100%; object-fit: cover; }
.fan-card .card-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
.fan-card .card-role { font-size: 0.75rem; color: var(--text-sec); }
.fan-card .card-city { font-size: 0.7rem; color: var(--primary); margin-top: 5px; }
.fan-card.project-card { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #e94560; }
.fan-card.project-card:hover { border-color: #ff6b6b; box-shadow: 0 12px 30px rgba(233, 69, 96, 0.4); }
.universe-view-toggle { display: flex; gap: 5px; background: var(--bg); padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
.universe-view-toggle button { padding: 8px 15px; border: none; background: transparent; color: var(--text-sec); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
.universe-view-toggle button.active { background: var(--primary); color: white; }
.universe-view-toggle button:hover:not(.active) { background: var(--border); }
.profile-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 20px; }
.profile-modal-box { background: var(--panel-bg); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
.profile-modal-header { position: relative; padding: 30px; text-align: center; border-bottom: 1px solid var(--border); }
.profile-modal-photo { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; overflow: hidden; border: 3px solid var(--primary); }
.profile-modal-photo img { width: 100%; height: 100%; object-fit: cover; }
.profile-modal-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
.profile-modal-role { color: var(--primary); font-size: 1rem; margin-bottom: 5px; }
.profile-modal-city { color: var(--text-sec); font-size: 0.9rem; }
.profile-modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); }
.profile-modal-header .favorite-btn { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; }
.profile-modal-body { padding: 20px; }
.profile-modal-section { margin-bottom: 20px; }
.profile-modal-section h4 { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase; }
.profile-modal-section p { line-height: 1.5; }
.profile-modal-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.profile-modal-info-item { background: var(--bg); padding: 10px; border-radius: 6px; }
.profile-modal-info-item label { font-size: 0.75rem; color: var(--text-sec); display: block; margin-bottom: 3px; }
.profile-modal-info-item span { font-weight: 500; }
.profile-modal-actions { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
.profile-modal-actions button { flex: 1; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }

/* Module DÃ©penses/Budget */
.expenses-container { display: flex; height: 100%; gap: 20px; padding: 20px; }
.expenses-sidebar { width: 280px; background: var(--panel-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border); overflow-y: auto; }
.expenses-main { flex: 1; background: var(--panel-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border); overflow-y: auto; }
.expenses-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
.expenses-summary-card { background: var(--bg); padding: 15px; border-radius: 8px; text-align: center; }
.expenses-summary-card .amount { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
.expenses-summary-card .label { font-size: 0.85rem; color: var(--text-sec); margin-top: 5px; }
.expenses-summary-card.danger .amount { color: var(--danger); }
.expenses-summary-card.success .amount { color: var(--success); }
.expenses-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.expenses-filters select, .expenses-filters input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); }
.expense-card { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: all 0.2s; }
.expense-card:hover { border-color: var(--primary); box-shadow: 0 4px 15px var(--shadow); }
.expense-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.expense-card-title { font-weight: 600; font-size: 1rem; }
.expense-card-amount { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
.expense-card-meta { font-size: 0.8rem; color: var(--text-sec); margin-bottom: 10px; }
.expense-card-dept { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; background: rgba(43, 110, 246, 0.1); color: var(--primary); }
.expense-card-status { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; }
.expense-card-status.pending { background: rgba(255, 193, 7, 0.15); color: #f39c12; }
.expense-card-status.approved { background: rgba(40, 167, 69, 0.15); color: var(--success); }
.expense-card-status.rejected { background: rgba(255, 68, 68, 0.15); color: var(--danger); }
.expense-card-status.done { background: rgba(43, 110, 246, 0.15); color: var(--primary); }
.expense-card-photo { width: 80px; height: 80px; border-radius: 6px; overflow: hidden; margin-top: 10px; }
.expense-card-photo img { width: 100%; height: 100%; object-fit: cover; }
.expense-card-actions { display: flex; gap: 8px; margin-top: 12px; }
.expense-card-actions button { padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; font-weight: 500; }
.expense-btn-approve { background: var(--success); color: white; }
.expense-btn-reject { background: var(--danger); color: white; }
.expense-btn-edit { background: var(--border); color: var(--text-main); }
.expense-section-title { font-size: 1.1rem; font-weight: 600; margin: 20px 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
.expense-dept-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
  .salary-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); }
  .salary-item:last-child { border-bottom: none; }
  .salary-item.missing { background: rgba(245, 158, 11, 0.1); border-radius: 6px; margin-bottom: 5px; border: 1px dashed #f59e0b; }
  .salary-info { display: flex; flex-direction: column; gap: 2px; }
  .salary-name { font-weight: 500; }
  .salary-detail { font-size: 0.8rem; color: var(--text-sec); }
  .salary-amount { font-weight: 600; color: var(--success); }
  .salary-fix-btn { padding: 5px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
  .salary-fix-btn:hover { background: #d97706; }
  .salary-section-warning { margin-top: 15px; padding: 10px; background: rgba(245, 158, 11, 0.05); border-radius: 8px; }
.expense-dept-item:hover { background: rgba(43, 110, 246, 0.1); }
.expense-dept-item.active { background: rgba(43, 110, 246, 0.15); border-left: 3px solid var(--primary); }

/* Dropdown multi-select avec checkboxes */
.withwho-dropdown { position: relative; display: inline-block; width: 100%; }
.withwho-btn { width: 100%; padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.85rem; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.withwho-btn:after { content: 'â–¼'; font-size: 0.7rem; margin-left: 5px; }
.withwho-btn.open:after { content: 'â–²'; }
.withwho-list { display: none; position: absolute; top: 100%; left: 0; min-width: 180px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.withwho-list.open { display: block; }
.withwho-item { display: flex; flex-direction: row; align-items: center; padding: 4px 8px; cursor: pointer; font-size: 0.85rem; white-space: nowrap; gap: 6px; }
.withwho-item:hover { background: rgba(43, 110, 246, 0.1); }
.withwho-item input[type="checkbox"] { margin: 0; flex-shrink: 0; width: 14px; height: 14px; }
.withwho-item.selected { background: rgba(43, 110, 246, 0.15); }
.withwho-item label { cursor: pointer; margin: 0; display: inline; overflow: hidden; text-overflow: ellipsis; }

/* Badge de rÃ´le sur avatar */
.presence-bar { position: relative; display: flex; gap: -5px; }
.presence-avatar-wrapper { position: relative; display: inline-block; cursor: pointer; transition: transform 0.2s ease, z-index 0s; }
.presence-avatar-wrapper:hover { transform: scale(1.8); z-index: 100; }
.presence-avatar-wrapper .role-icon { position: absolute; bottom: -2px; right: -2px; font-size: 0.6rem; background: white; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid white; }
.presence-avatar-wrapper.owner .role-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
.presence-avatar-wrapper.budget-manager .role-icon { background: linear-gradient(135deg, #10b981, #059669); }
.presence-avatar-wrapper.dept-manager .role-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.presence-avatar-wrapper .role-icon.extra-role { bottom: -2px; background: var(--panel-bg); border: 1px solid var(--border); font-size: 0.5rem; width: 12px; height: 12px; }
/* Infobulle avatar */
.presence-avatar-wrapper .avatar-tooltip { position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(5px); background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; text-align: center; pointer-events: none; }
.presence-avatar-wrapper:hover .avatar-tooltip { opacity: 1; visibility: visible; }
.avatar-tooltip-name { font-weight: 600; font-size: 0.85rem; color: var(--text-main); }
.avatar-tooltip-role { font-size: 0.75rem; color: var(--text-sec); margin-top: 2px; }

/* Nouveaux statuts et boutons dÃ©penses */
.expense-card.returned { border-left: 3px solid #f59e0b; }
.expense-card.missing-rate { border-left: 3px solid var(--danger); background: rgba(255, 68, 68, 0.03); }
.dept-badge.orange { background: #f59e0b; color: white; }
.expense-card-status.escalated { background: #8b5cf6; color: white; }
.expense-card-status.returned { background: #f59e0b; color: white; }
.expense-btn-escalate { background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
.expense-btn-escalate:hover { background: #7c3aed; }
.expense-btn-return { background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
.expense-btn-return:hover { background: #d97706; }

/* Responsables par dÃ©partement */
.dept-manager-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--bg); border-radius: 6px; margin-bottom: 6px; }
.dept-manager-info { display: flex; flex-direction: column; gap: 2px; }
.dept-manager-dept { font-size: 0.8rem; color: var(--text-sec); }
.dept-manager-name { font-size: 0.9rem; font-weight: 500; color: var(--text-main); }
.dept-manager-actions { display: flex; align-items: center; gap: 8px; }
.dept-manager-actions input[type="checkbox"] { width: 14px; height: 14px; }

/* ParamÃ¨tres financiers */
.finance-params { margin-top: 10px; }
.finance-param-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
.finance-param-row:last-child { border-bottom: none; }
.finance-param-row label { font-size: 0.8rem; color: var(--text-sec); flex: 1; }
.finance-param-input { display: flex; align-items: center; gap: 5px; }
.finance-param-input input { width: 70px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); text-align: right; font-size: 0.85rem; }
.finance-param-input .param-unit { font-size: 0.75rem; color: var(--text-sec); min-width: 40px; }
.finance-param-rates { display: flex; align-items: center; gap: 3px; }
.finance-param-rates input { width: 40px; padding: 6px 4px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); text-align: center; font-size: 0.8rem; }
.finance-param-rates span { font-size: 0.7rem; color: var(--text-sec); }
.expense-dept-item .dept-name { font-weight: 500; }
.expense-dept-item .dept-amount { font-weight: 600; color: var(--primary); }
  .dept-badges { display: flex; gap: 3px; }
  .dept-badge { font-size: 0.65rem; font-weight: 600; padding: 2px 6px; border-radius: 10px; color: white; min-width: 18px; text-align: center; }
  .dept-badge.red { background: var(--danger); }
  .dept-badge.yellow { background: #f59e0b; }
  .dept-badge.green { background: var(--success); }
.expense-auto-section { background: linear-gradient(135deg, rgba(43, 110, 246, 0.05), rgba(139, 92, 246, 0.05)); border: 1px dashed var(--primary); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
.expense-auto-section h4 { margin: 0 0 10px; color: var(--primary); }

/* Galerie photos comÃ©diens */
.actor-gallery { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
.actor-gallery-item { width: 120px; height: 120px; border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; background: var(--bg); transition: all 0.2s; position: relative; }
.actor-gallery-item:hover { border-color: var(--primary); }
.actor-gallery-item img { width: 100%; height: 100%; object-fit: cover; }
.actor-gallery-item .gallery-placeholder { color: var(--text-sec); font-size: 2rem; }
.actor-gallery-item .gallery-remove { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: none; align-items: center; justify-content: center; }
.actor-gallery-item:hover .gallery-remove { display: flex; }
.actor-gallery-input { width: 100%; margin-top: 10px; }

/* Messages Inbox */
.messages-section { margin-top: 20px; }
.messages-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
.messages-tab { padding: 8px 16px; background: none; border: none; cursor: pointer; font-size: 0.9rem; color: var(--text-sec); border-radius: 6px 6px 0 0; }
.messages-tab.active { background: var(--primary); color: white; }
.messages-tab .badge { background: var(--danger); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
.message-list { display: flex; flex-direction: column; gap: 10px; }
.message-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; }
.message-card:hover { border-color: var(--primary); transform: translateX(3px); }
.message-card.unread { border-left: 4px solid var(--primary); background: rgba(43, 110, 246, 0.05); }
.message-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.message-card-title { font-weight: 600; font-size: 1rem; color: var(--text-main); }
.message-card-date { font-size: 0.75rem; color: var(--text-sec); }
.message-card-from { font-size: 0.85rem; color: var(--primary); margin-bottom: 5px; }
.message-card-preview { font-size: 0.85rem; color: var(--text-sec); line-height: 1.4; }
.message-card-type { display: inline-block; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-bottom: 8px; }
.message-card-type.invitation { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
.message-card-type.convocation { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
.message-card-type.info { background: rgba(43, 110, 246, 0.15); color: var(--primary); }
.message-empty { text-align: center; padding: 40px; color: var(--text-sec); }
.message-detail-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10001; }
.message-detail-box { background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
.message-detail-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.message-detail-body { padding: 20px; }
.message-detail-meta { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px; }
.message-detail-content { line-height: 1.6; white-space: pre-wrap; }
.message-detail-actions { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

  /* Profil Public */
  .public-profile-view { display: none; flex-direction: column; width: 100%; height: 100vh; background: var(--bg); }
  .public-profile-view.active { display: flex; }
  .public-profile-header { background: var(--panel-bg); padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .public-profile-header h1 { margin: 0; font-size: 1.5rem; }
  .public-profile-body { flex: 1; overflow-y: auto; padding: 20px 40px; max-width: 900px; margin: 0 auto; width: 100%; }
  .profile-section { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
  .profile-section h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
  .profile-section h3 span.section-title { flex: 1; }
  .visibility-toggles { display: flex; gap: 5px; }
  .visibility-btn { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 3px; transition: all 0.2s; }
  .visibility-btn:hover { background: var(--primary-light, #e3f2fd); }
  .visibility-btn.hidden-section { opacity: 0.7; background: var(--danger-light, #ffebee); border-color: var(--danger, #f44336); }
  .visibility-btn .vis-icon { font-size: 0.85rem; position: relative; display: inline-block; }
  .visibility-btn.hidden-section .vis-icon::after { content: ''; position: absolute; width: 120%; height: 2px; background: var(--danger, #f44336); top: 50%; left: -10%; transform: rotate(-45deg); }
  
  /* Statuts de validation scÃ¨nes */
  .scene-status-container { position: relative; display: inline-block; }
  .scene-status-badge { padding: 2px 6px; border-radius: 8px; font-size: 0.65rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 3px; opacity: 0.8; }
  .scene-status-badge:hover { opacity: 1; }
  .scene-status-badge.not-verified { background: #ffebee; color: #c62828; }
  .scene-status-badge.to-work { background: #fff3e0; color: #e65100; }
  .scene-status-badge.verified { background: #e8f5e9; color: #2e7d32; }
  .scene-status-dropdown { position: fixed; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; min-width: 140px; overflow: visible; display: none; }
  .scene-status-dropdown.visible { display: block; }
  .scene-status-option { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
  .scene-status-option:hover { background: var(--bg); }
  .scene-status-option .status-dot { width: 8px; height: 8px; border-radius: 50%; }
  .scene-status-option .status-dot.not-verified { background: #ef5350; }
  .scene-status-option .status-dot.to-work { background: #ff9800; }
  .scene-status-option .status-dot.verified { background: #4caf50; }

  /* AutocomplÃ©tion adresse */
  .address-autocomplete-container { position: relative; }
  .address-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .address-suggestions.visible { display: block; }
  .address-suggestion { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
  .address-suggestion:last-child { border-bottom: none; }
  .address-suggestion:hover { background: var(--primary-light, #e3f2fd); }
  .address-suggestion-main { font-weight: 500; }
  .address-suggestion-secondary { font-size: 0.8rem; color: var(--text-sec); margin-top: 2px; }
  .address-minimap { width: 100%; height: 150px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border); }
  
  /* MÃ©tÃ©o et Carte dans Feuille de Service */
  .fds-weather-card { display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: center; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px; margin-bottom: 15px; }
  body.dark-mode .fds-weather-card { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); }
  .fds-weather-icon { font-size: 3rem; }
  .fds-weather-main { display: flex; flex-direction: column; gap: 4px; }
  .fds-weather-temp { font-size: 2rem; font-weight: bold; }
  .fds-weather-desc { font-size: 1rem; color: var(--text-sec); text-transform: capitalize; }
  .fds-weather-details { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; text-align: right; }
  .fds-weather-row { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
  .fds-weather-item { display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: rgba(255,255,255,0.5); border-radius: 20px; font-size: 0.85rem; }
  body.dark-mode .fds-weather-item { background: rgba(0,0,0,0.3); }
  .fds-map-container { height: 200px; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 1px solid var(--border); }
  .fds-location-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
  .fds-gmaps-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: #4285f4; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; transition: all 0.2s; }
  .fds-gmaps-btn:hover { background: #3367d6; transform: translateY(-1px); }
  .fds-weather-loading { padding: 20px; text-align: center; color: var(--text-sec); }
  .fds-sun-times { display: flex; gap: 20px; margin-top: 8px; font-size: 0.9rem; }
  .fds-sun-item { display: flex; align-items: center; gap: 5px; }

  .profile-type-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 20px 15px; background: var(--bg); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
  .profile-type-card:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); transform: translateY(-2px); }
  .profile-type-card:has(input:checked) { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
  .profile-type-icon { font-size: 2.5rem; }
  .profile-type-name { font-weight: 600; font-size: 0.95rem; text-align: center; }
  .profile-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
  .profile-row.two-cols { grid-template-columns: repeat(2, 1fr); }
  .profile-row.three-cols { grid-template-columns: repeat(3, 1fr); }
  .profile-row > * { width: 100%; }
  .profile-input { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; background: var(--input-bg); color: var(--text-main); width: 100%; }
  .profile-input:focus { outline: none; border-color: var(--primary); }
  .profile-textarea { min-height: 100px; resize: vertical; }
  .profile-photo-section { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
  .profile-photo-preview { width: 120px; height: 120px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; overflow: hidden; border: 3px solid var(--border); }
  .profile-photo-preview img { width: 100%; height: 100%; object-fit: cover; }
  .profile-status { padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; }
  .profile-status.incomplete { background: rgba(255,150,0,0.1); border: 1px solid orange; color: orange; }
  .profile-status.complete { background: rgba(40,167,69,0.1); border: 1px solid var(--success); color: var(--success); }
  .equipment-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .equipment-tag { background: var(--bg); border: 1px solid var(--border); padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
  .equipment-tag .remove { cursor: pointer; color: var(--danger); }

/* Cartes profils avec badges projets */
.profile-tab-card { display: flex; flex-direction: column; gap: 8px; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; min-width: 150px; }
.profile-tab-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); }
.profile-tab-card.active { background: var(--primary); color: white; border-color: var(--primary); }
.profile-tab-card.active .profile-project-badge { background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3); }
.profile-tab-card.add-profile { border: 2px dashed var(--primary); background: transparent; color: var(--primary); justify-content: center; align-items: center; }
.profile-tab-card.add-profile:hover { background: rgba(43, 110, 246, 0.1); }
.profile-tab-header { font-weight: 600; font-size: 0.95rem; }
.profile-project-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 4px; }
.profile-project-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; font-size: 0.75rem; color: var(--text-sec); cursor: pointer; transition: all 0.2s; white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
.profile-project-badge:hover { background: var(--primary); color: white; border-color: var(--primary); }

/* Responsive profils */
  @media (max-width: 600px) { .profile-row { grid-template-columns: 1fr; } .profile-row.two-cols, .profile-row.three-cols { grid-template-columns: 1fr; } }

  /* Recherche Globale */
  .global-search-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: flex-start; padding-top: 50px; z-index: 10000; overflow-y: auto; }
  .global-search-container { background: var(--panel-bg); border-radius: 12px; width: 95%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; margin-bottom: 50px; }
  .global-search-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .global-search-header h2 { margin: 0; }
  .global-search-filters { padding: 15px 20px; border-bottom: 1px solid var(--border); background: var(--bg); }
  .global-search-filters-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  .global-search-filters-row:last-child { margin-bottom: 0; }
  .global-search-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); }
  .global-search-results { flex: 1; overflow-y: auto; padding: 20px; }
  .global-search-results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
  .global-search-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; transition: border-color 0.2s; }
  .global-search-card:hover { border-color: var(--primary); }
  .global-search-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
  .global-search-card-photo { width: 60px; height: 60px; border-radius: 50%; background: var(--panel-bg); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; overflow: hidden; }
  .global-search-card-photo img { width: 100%; height: 100%; object-fit: cover; }
  .global-search-card-name { font-weight: bold; font-size: 1rem; }
  .global-search-card-meta { font-size: 0.85rem; color: var(--text-sec); }
  .global-search-card-details { font-size: 0.85rem; color: var(--text-sec); margin-top: 8px; }
  .global-search-card-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
  .global-search-card-tag { background: var(--panel-bg); padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; }
  .global-search-card-actions { margin-top: 12px; display: flex; gap: 8px; }
  .global-search-card-actions button { flex: 1; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 500; }
  .global-search-empty { text-align: center; padding: 40px; color: var(--text-sec); }
  .global-search-loading { text-align: center; padding: 40px; color: var(--text-sec); }

  /* Permissions */
  .permissions-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: flex-start; padding-top: 30px; z-index: 10000; overflow-y: auto; }
  .permissions-container { background: var(--panel-bg); border-radius: 12px; width: 95%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; margin-bottom: 30px; }
  .permissions-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .permissions-header h2 { margin: 0; }
  .permissions-body { flex: 1; overflow-y: auto; padding: 20px; }
  .permissions-section { margin-bottom: 25px; }
  .permissions-section h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); font-size: 1rem; }
  .permissions-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .permissions-table th, .permissions-table td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border); }
  .permissions-table th:first-child, .permissions-table td:first-child { text-align: left; }
  .permissions-table th { background: var(--bg); font-weight: 600; position: sticky; top: 0; }
  .permissions-table tr:hover { background: var(--bg); }
  .permissions-user-info { display: flex; align-items: center; gap: 10px; }
  .permissions-user-photo { width: 32px; height: 32px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; overflow: hidden; }
  .permissions-user-photo img { width: 100%; height: 100%; object-fit: cover; }
  .permissions-user-name { font-weight: 500; }
  .permissions-user-role { font-size: 0.75rem; color: var(--text-sec); }
  .perm-select { padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.8rem; cursor: pointer; }
  .perm-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
  .perm-badge.owner { background: #8b5cf6; color: white; }
  .perm-badge.write { background: var(--success); color: white; }
  .perm-badge.read { background: var(--primary); color: white; }
  .perm-badge.none { background: var(--border); color: var(--text-sec); }
  .permissions-presets { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
  .permissions-preset-btn { padding: 8px 15px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); cursor: pointer; font-size: 0.85rem; }
  .permissions-preset-btn:hover { border-color: var(--primary); background: var(--panel-bg); }
  .permissions-preset-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

  /* Chat */
  .chat-panel { position: fixed; bottom: 0; right: 20px; width: 380px; height: 500px; background: var(--panel-bg); border: 1px solid var(--border); border-bottom: none; border-radius: 12px 12px 0 0; display: flex; flex-direction: column; z-index: 9000; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); transition: transform 0.3s ease; }
  .chat-panel.minimized { transform: translateY(calc(100% - 45px)); }
  .chat-header { background: var(--primary); color: white; padding: 12px 15px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  .chat-header h3 { margin: 0; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
  .chat-header-actions { display: flex; gap: 8px; }
  .chat-header-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; }
  .chat-header-btn:hover { background: rgba(255,255,255,0.3); }
  .chat-tabs { display: flex; background: var(--bg); border-bottom: 1px solid var(--border); overflow-x: auto; flex-shrink: 0; }
  .chat-tab { padding: 10px 12px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; color: var(--text-sec); position: relative; }
  .chat-tab:hover { background: var(--panel-bg); }
  .chat-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--panel-bg); }
  .chat-tab .unread-badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 10px; min-width: 16px; text-align: center; }
  .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
  .chat-message { max-width: 85%; padding: 10px 12px; border-radius: 12px; font-size: 0.85rem; line-height: 1.4; }
  .chat-message.own { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
  .chat-message.other { align-self: flex-start; background: var(--bg); color: var(--text-main); border-bottom-left-radius: 4px; }
  .chat-message-sender { font-weight: 600; font-size: 0.75rem; margin-bottom: 4px; opacity: 0.8; }
  .chat-message-time { font-size: 0.7rem; opacity: 0.6; margin-top: 4px; text-align: right; }
  .chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
  .chat-input { flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-main); resize: none; }
  .chat-input:focus { outline: none; border-color: var(--primary); }
  .chat-send-btn { background: var(--primary); color: white; border: none; width: 38px; height: 38px; border-radius: 50%; cursor: pointer; font-size: 1rem; }
  .chat-send-btn:hover { opacity: 0.9; }
  .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .chat-empty { text-align: center; color: var(--text-sec); padding: 40px 20px; font-size: 0.9rem; }
  .chat-date-separator { text-align: center; font-size: 0.75rem; color: var(--text-sec); margin: 10px 0; padding: 5px; background: var(--bg); border-radius: 10px; }
  .chat-typing { font-size: 0.8rem; color: var(--text-sec); font-style: italic; padding: 5px 15px; }
  .chat-members-modal { position: absolute; bottom: 100%; right: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; width: 280px; max-height: 300px; overflow-y: auto; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
  .chat-member-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; }
  .chat-member-item:hover { background: var(--bg); }
  .chat-member-item.selected { background: rgba(43, 110, 246, 0.1); }
  .chat-member-photo { width: 32px; height: 32px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; overflow: hidden; }
  .chat-member-photo img { width: 100%; height: 100%; object-fit: cover; }
  .chat-floating-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(43, 110, 246, 0.4); z-index: 8999; display: none; }
  .chat-floating-btn:hover { transform: scale(1.05); }
  .chat-floating-btn .unread-total { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.75rem; padding: 3px 8px; border-radius: 12px; min-width: 20px; }
  
  .new-project-card { border: 2px dashed var(--border); border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; min-height: 200px; background: rgba(128,128,128,0.05); color: var(--text-sec); transition: all 0.2s; }
  .new-project-card:hover { border-color: var(--primary); color: var(--primary); background: var(--panel-bg); }
  .p-btn-priority { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 5px; border-radius: 4px; transition: background 0.2s; }
  .p-btn-priority:hover { background: var(--bg); }
  
  .import-card { border: 2px dashed var(--success); background: rgba(40, 167, 69, 0.05); color: var(--success); }
  .import-card:hover { background: var(--panel-bg); border-color: var(--success); color: var(--success); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

  .project-card { background: var(--panel-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: space-between; min-height: 200px; cursor: pointer; position: relative; transition: transform 0.3s ease, border-color 0.2s, opacity 0.2s, margin 0.3s ease; }
  .project-card:hover { transform: translateY(-3px); border-color: var(--primary); }
  .project-card.dragging { opacity: 0.4; transform: scale(0.9) rotate(2deg); box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100; }
  .project-card.drag-over { border: 2px dashed var(--primary); transform: translateX(15px); margin-left: 15px; }
  .project-card.drag-over-left { transform: translateX(-15px); margin-right: 15px; }
  .priority-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; margin-left: 10px; vertical-align: middle; }
  .priority-badge.principal { background: #4CAF50; color: white; }
  .priority-badge.secondaire { background: #2196F3; color: white; }
  .priority-badge.en-attente { background: #9E9E9E; color: white; }
  .priority-badge.urgent { background: #f44336; color: white; animation: pulse-urgent 1s infinite; }
  .priority-badge.archive { background: #795548; color: white; }
  .priority-badge.une-idÃ©e { background: #FFEB3B; color: #333; }
  .priority-badge.je-sais-pas-trop { background: #9C27B0; color: white; }
  @keyframes pulse-urgent { 0%, 100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); } 50% { box-shadow: 0 0 0 6px rgba(244, 67, 54, 0); } }
  .priority-menu { position: absolute; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 15px var(--shadow); z-index: 1000; min-width: 150px; overflow: hidden; }
  .priority-menu-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }
  .priority-menu-item:hover { background: var(--bg); }
  .priority-menu-item .dot { width: 10px; height: 10px; border-radius: 50%; }
  .p-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; color: var(--text-main); }
  .p-meta { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px; }
  .p-role-badge { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--bg); border: 1px solid var(--border); text-transform: uppercase; }
  .p-actions { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
  .p-btn-del { background: none; border: none; color: var(--text-sec); cursor: pointer; font-size: 1.2rem; }
  .p-btn-del:hover { color: var(--danger); }.p-btn-del:hover { color: var(--danger); }

  /* â•â•â•â•â•â•â• V2.1.6 â€” HUB CENTRAL â•â•â•â•â•â•â• */
  .hub-main { max-width:1000px; margin:0 auto; padding:40px 30px 60px; }
  .hub-welcome { margin-bottom:30px; }
  .hub-welcome h2 { font-size:1.6rem; font-weight:700; margin:0 0 4px; }
  .hub-welcome h2 span { color:var(--primary); }
  .hub-welcome-sub { color:var(--text-sec); font-size:0.9rem; }
  .hub-onboarding { background:linear-gradient(135deg, rgba(43,110,246,0.08), rgba(139,92,246,0.08)); border:1px solid rgba(43,110,246,0.2); border-radius:12px; padding:20px 24px; margin-bottom:28px; display:flex; align-items:center; gap:18px; }
  .hub-onboarding-icon { font-size:2rem; flex-shrink:0; }
  .hub-onboarding h3 { font-size:1rem; font-weight:700; margin:0 0 4px; }
  .hub-onboarding p { font-size:0.82rem; color:var(--text-sec); margin:0; line-height:1.5; }
  .hub-ob-steps { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .hub-ob-step { font-size:0.78rem; padding:4px 12px; background:var(--panel-bg); border:1px solid var(--border); border-radius:20px; color:var(--text-sec); }
  .hub-ob-step.done { color:var(--success); border-color:var(--success); }
  .hub-ob-dismiss { margin-left:auto; background:none; border:1px solid var(--border); color:var(--text-sec); padding:6px 14px; border-radius:8px; cursor:pointer; font-size:0.8rem; flex-shrink:0; }
  .hub-ob-dismiss:hover { background:var(--panel-bg); color:var(--text-main); }
  .hub-cards { display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:28px; }
  .hub-card { background:var(--panel-bg); border:1px solid var(--border); border-radius:12px; padding:22px 20px; cursor:pointer; transition:all 0.2s; position:relative; }
  .hub-card:hover { border-color:var(--primary); transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,0.1); }
  .hub-card-icon { font-size:1.8rem; margin-bottom:10px; display:block; }
  .hub-card-title { font-size:0.95rem; font-weight:700; margin-bottom:4px; }
  .hub-card-desc { font-size:0.78rem; color:var(--text-sec); line-height:1.4; }
  .hub-card-badge { position:absolute; top:12px; right:12px; background:var(--primary); color:white; font-size:0.7rem; font-weight:700; padding:2px 8px; border-radius:10px; min-width:20px; text-align:center; }
  .hub-card-edit { position:absolute; top:12px; right:12px; background:none; border:none; color:var(--text-sec); cursor:pointer; font-size:0.85rem; opacity:0; transition:opacity 0.2s; }
  .hub-card:hover .hub-card-edit { opacity:1; }
  .hub-stats { display:flex; gap:16px; margin-bottom:28px; }
  .hub-stat { flex:1; background:var(--panel-bg); border:1px solid var(--border); border-radius:10px; padding:16px 18px; text-align:center; }
  .hub-stat-value { font-size:1.4rem; font-weight:800; color:var(--primary); }
  .hub-stat-label { font-size:0.78rem; color:var(--text-sec); margin-top:2px; }
  .hub-section-title { font-size:0.85rem; font-weight:700; color:var(--text-sec); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:12px; }
  .hub-customize-bar { display:flex; justify-content:flex-end; margin-bottom:10px; }
  .hub-customize-btn { background:none; border:1px solid var(--border); color:var(--text-sec); padding:6px 14px; border-radius:8px; cursor:pointer; font-size:0.8rem; display:flex; align-items:center; gap:6px; }
  .hub-customize-btn:hover { background:var(--panel-bg); color:var(--text-main); }
  .hub-card-selector { display:none; position:absolute; top:100%; left:0; right:0; background:var(--panel-bg); border:1px solid var(--border); border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.15); z-index:1000; padding:8px; max-height:200px; overflow-y:auto; }
  .hub-card-selector.show { display:block; }
  .hub-card-option { padding:8px 12px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:10px; font-size:0.85rem; }
  .hub-card-option:hover { background:var(--bg); }
  @media (max-width:768px) { .hub-cards { grid-template-columns:repeat(2, 1fr); } .hub-stats { flex-direction:column; } .hub-onboarding { flex-direction:column; text-align:center; } .hub-ob-dismiss { margin:8px auto 0; } .hub-main { padding:20px 16px 40px; } }
  @media (max-width:480px) { .hub-cards { grid-template-columns:1fr; } }

  /* --- APP HEADER & QUICK NAV --- */
  #app-view { display: none; flex-direction: column; height: 100%; width: 100%; }
  header { background: var(--panel-bg); border-bottom: 1px solid var(--border); padding: 10px 20px; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-justify-content: space-between; justify-content: space-between; -webkit-align-items: center; align-items: center; -webkit-flex-shrink: 0; flex-shrink: 0; }
  
  #quick-nav {
      position: fixed;
      top: 130px;
      right: 0;
      bottom: 0;
      width: 40px;
      background: var(--panel-bg);
      border-left: 1px solid var(--border);
      z-index: 900;
      display: none;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      overflow-y: auto;
      scrollbar-width: none; 
  }
  #quick-nav::-webkit-scrollbar { display: none; }
  /* DÃ©placer quick-nav Ã  gauche quand les onglets sont Ã  droite */
  body.tabs-right #quick-nav {
      right: auto;
      left: 0;
      border-left: none;
      border-right: 1px solid var(--border);
  }
  /* Ajuster quick-nav quand les onglets sont Ã  gauche (dÃ©caler aprÃ¨s la barre d'onglets) */
  body.tabs-left #quick-nav {
      right: 0;
      left: auto;
  }
  .qn-link {
      font-size: 0.7rem;
      color: var(--text-sec);
      text-decoration: none;
      margin-bottom: 8px;
      cursor: pointer;
      font-weight: bold;
      padding: 2px;
  }
  .qn-link:hover { color: var(--primary); transform: scale(1.2); }

  .project-info { display: flex; align-items: center; gap: 10px; }
  header input { font-size: 1.1rem; font-weight: bold; border: 1px solid transparent; padding: 4px; border-radius: 4px; background: transparent; color: var(--text-main); }
  header input:hover { border-color: var(--border); }
  .global-actions button, .theme-btn { font-size: 0.85rem; padding: 6px 10px; margin-left: 5px; cursor: pointer; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); display: inline-flex; align-items: center; gap: 5px; }
  .menu-dropdown-container { position: relative; display: inline-block; }
  .menu-dropdown-btn { font-size: 0.85rem; padding: 8px 12px; cursor: pointer; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); display: inline-flex; align-items: center; gap: 5px; }
  .menu-dropdown-btn:hover { background: var(--bg); }
  .menu-dropdown-separator { height: 1px; background: var(--border); margin: 5px 0; }
  .menu-dropdown-label { font-size: 0.75rem; font-weight: 600; color: var(--text-sec); padding: 8px 15px 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .menu-dropdown { display: none; position: absolute; top: 100%; left: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); min-width: 180px; z-index: 10000; overflow: hidden; }
  .menu-dropdown.visible { display: block; }
  .menu-dropdown.align-right { left: auto; right: 0; }
  .menu-dropdown-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; transition: background 0.2s; }
  .menu-dropdown-item:hover { background: var(--bg); }
  .menu-dropdown-item.danger { color: var(--danger); }
  .menu-dropdown-item.danger:hover { background: #ffebee; }
  .global-actions button:hover { background: var(--bg); border-color: #bbb; }
  .presence-bar { display:flex; gap: -5px; margin-left:15px; }
  .presence-avatar { width:30px; height:30px; border-radius:50%; background:var(--primary); color:white; display:flex; justify-content:center; align-items:center; font-size:0.75rem; font-weight:bold; border:2px solid var(--panel-bg); cursor:help; text-transform:uppercase; }

  /* --- VERSION MANAGER STYLES (NEW V62) --- */
  .ver-list { max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 15px; }
  .ver-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); background: var(--panel-bg); }
  .ver-row:last-child { border-bottom: none; }
  .ver-info { display: flex; flex-direction: column; }
  .ver-name { font-weight: bold; font-size: 0.95rem; color: var(--text-main); }
  .ver-date { font-size: 0.75rem; color: var(--text-sec); }
  .ver-actions button { font-size: 0.8rem; padding: 4px 8px; margin-left: 5px; cursor: pointer; }
  
  /* --- TABS --- */
  .tabs-mode-selector { display: flex; justify-content: flex-end; align-items: center; gap: 10px; padding: 5px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--border); font-size: 0.8rem; color: var(--text-sec); }
  .tabs-mode-selector label { display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 4px 10px; border-radius: 4px; transition: background 0.2s; }
  .tabs-mode-selector label:hover { background: var(--bg); }
  .tabs-mode-selector input[type="radio"] { cursor: pointer; }
  .tabs-reset-order-btn { padding: 4px 10px; font-size: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text-sec); transition: all 0.2s; }
  .tabs-reset-order-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
  .tabs-mode-selector .mode-separator { width: 1px; height: 20px; background: var(--border); margin: 0 5px; }
  
  /* Navigation Ã  2 niveaux - CatÃ©gories */
  .tabs-categories { display: none; background: var(--bg); border-bottom: 1px solid var(--border); padding: 0 20px; gap: 0; flex-shrink: 0; justify-content: center; }
  .tabs-categories.active { display: flex; }
  .tab-category { padding: 12px 24px; cursor: pointer; font-weight: 600; color: var(--text-sec); border: none; background: none; border-bottom: 3px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
  .tab-category:hover { color: var(--text-main); background: var(--panel-bg); }
  .tab-category.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--panel-bg); }
  .tab-category.active::after { content: 'â–¾'; font-size: 0.6rem; margin-left: 4px; opacity: 0.5; }
  .tab-category-icon { font-size: 1.1rem; }
  
  /* Wrapper catÃ©gories + sous-nav */
  .tabs-categories-wrapper { position: relative; }
  
  /* Sous-navigation des catÃ©gories â€” cachÃ©e par dÃ©faut, visible au hover */
  .tabs-subnav { display: none; background: var(--panel-bg); border-bottom: 1px solid var(--border); padding: 0 20px; gap: 5px; flex-shrink: 0; overflow-x: auto; justify-content: center; max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease, padding 0.25s ease; }
  .tabs-subnav.active { display: flex; max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; }
  .tabs-categories-wrapper:hover .tabs-subnav.active,
  .tabs-subnav.active.force-visible { max-height: 50px; opacity: 1; padding-top: 0; padding-bottom: 0; }
  .tab-subbtn { padding: 10px 22px 10px 16px; cursor: pointer; font-weight: 500; color: var(--text-sec); border-bottom: 2px solid transparent; user-select: none; white-space: nowrap; transition: all 0.2s; font-size: 0.85rem; background: none; border-top: none; border-left: none; border-right: none; position: relative; }
  .tab-subbtn:hover { color: var(--text-main); background: var(--bg); }
  .tab-subbtn.active { color: var(--primary); border-bottom-color: var(--primary); }
  
  .tabs-nav { display: -webkit-box; display: -webkit-flex; display: flex; background: var(--panel-bg); border-bottom: 1px solid var(--border); padding: 0 20px; gap: 20px; -webkit-flex-shrink: 0; flex-shrink: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .tabs-nav.hidden-by-categories { display: none; }
  .tab-btn { padding: 12px 15px; cursor: pointer; font-weight: 600; color: var(--text-sec); border-bottom: 3px solid transparent; user-select: none; white-space: nowrap; transition: all 0.3s ease; }
  .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(43, 110, 246, 0.05); }
  .tab-btn.dragging { opacity: 0.5; transform: scale(0.95); }
  .tab-btn.drag-over { border-left: 3px solid var(--primary); }
  
  /* Mode B : Adaptatif */
  .tabs-nav.adaptive { overflow-x: hidden; gap: 2px; }
  .tabs-nav.adaptive .tab-btn { flex: 1; min-width: 0; padding: 12px 5px; font-size: 0.7rem; text-align: center; overflow: hidden; text-overflow: ellipsis; transition: all 0.2s ease; }
  .tabs-nav.adaptive .tab-btn:hover { flex: 3; font-size: 0.85rem; background: rgba(43, 110, 246, 0.08); z-index: 10; }
  .tabs-nav.adaptive .tab-btn.active { flex: 2; font-size: 0.85rem; }
  .tabs-nav.adaptive .tab-btn.active:hover { flex: 3; }
  
  /* Positions des onglets (haut par dÃ©faut) */
  .tabs-nav.position-top { flex-direction: row; border-bottom: 1px solid var(--border); border-right: none; position: relative; height: auto; width: 100%; }
  .tabs-nav.position-bottom { flex-direction: row; border-top: 1px solid var(--border); border-bottom: none; position: fixed; bottom: 0; left: 0; right: 0; height: auto; width: 100%; z-index: 1000; background: var(--panel-bg); }
  .tabs-nav.position-left, .tabs-nav.position-right { 
    flex-direction: column; 
    width: 180px; 
    min-width: 180px;
    max-width: 180px;
    height: calc(100vh - 60px);
    overflow-y: auto; 
    overflow-x: hidden;
    border-bottom: none;
    position: fixed;
    top: 60px;
    z-index: 1000;
    padding: 10px 0;
    gap: 2px;
    background: var(--panel-bg);
  }
  .tabs-nav.position-left { left: 0; border-right: 1px solid var(--border); }
  .tabs-nav.position-right { right: 0; border-left: 1px solid var(--border); }
  .tabs-nav.position-left .tab-btn, .tabs-nav.position-right .tab-btn {
    flex: none;
    width: 100%;
    padding: 12px 15px;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-bottom: none;
    border-left: 3px solid transparent;
    font-size: 0.8rem;
  }
  .tabs-nav.position-left .tab-btn.active, .tabs-nav.position-right .tab-btn.active {
    border-bottom: none;
    border-left-color: var(--primary);
    background: rgba(43, 110, 246, 0.1);
    border-radius: 0;
  }
  .tabs-nav.position-left .tab-btn, .tabs-nav.position-right .tab-btn {
    border-radius: 0;
  }
  .tabs-nav.position-left .tab-btn.drag-over, .tabs-nav.position-right .tab-btn.drag-over {
    border-left: 3px solid var(--primary);
    border-top: none;
  }
  /* Adaptatif sur positions verticales */
  .tabs-nav.adaptive.position-left .tab-btn, .tabs-nav.adaptive.position-right .tab-btn {
    font-size: 0.75rem;
    padding: 10px 12px;
  }
  .tabs-nav.adaptive.position-left .tab-btn.active, .tabs-nav.adaptive.position-right .tab-btn.active {
    font-size: 0.85rem;
    background: rgba(43, 110, 246, 0.15);
  }
  /* Ajustement du main pour les positions latÃ©rales et bas */
  body.tabs-left main { margin-left: 180px; }
  body.tabs-right main { margin-right: 180px; }
  body.tabs-bottom main { margin-bottom: 50px; }
  body.tabs-left .tabs-mode-selector, body.tabs-right .tabs-mode-selector { padding-right: 200px; }
  /* Cacher les options de position quand en mode catÃ©gories */
  body.nav-categories .tabs-mode-selector #classic-mode-options { display: none !important; }
  /* Masquer le toggle MasquÃ©s en position verticale */
  .tabs-nav.position-left .tab-btn-hidden-toggle, .tabs-nav.position-right .tab-btn-hidden-toggle {
    width: 100%;
    text-align: left;
    padding: 10px 15px;
    border-left: 3px solid transparent;
  }
  /* Fix: Retirer le position fixed pour haut */
  .tabs-nav.position-top.adaptive, .tabs-nav.position-top:not(.adaptive) { position: relative; top: auto; left: auto; right: auto; }
  
  /* Menu contextuel couleur onglets */
  .tab-color-menu { position: fixed; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; display: none; }
  .tab-color-menu.visible { display: block; }
  .tab-color-menu-title { font-size: 0.8rem; font-weight: 600; margin-bottom: 10px; color: var(--text-sec); }
  .tab-color-options { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
  .tab-color-option { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
  .tab-color-option:hover { transform: scale(1.15); border-color: var(--text-main); }
  .tab-color-reset { margin-top: 10px; width: 100%; padding: 6px; font-size: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; }
  .tab-color-reset:hover { background: var(--border); }

/* Onglets masquables */
.tab-btn { position: relative; padding-right: 25px; }
.tab-btn .tab-close { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; border-radius: 50%; background: transparent; border: none; color: var(--text-sec); font-size: 12px; cursor: pointer; opacity: 0; transition: all 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1; }
.tab-btn:hover .tab-close { opacity: 0.6; }
.tab-btn .tab-close:hover { opacity: 1; background: var(--danger); color: white; }
.tab-subbtn { position: relative; padding-right: 22px; }
.tab-subbtn .tab-close { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; border-radius: 50%; background: transparent; border: none; color: var(--text-sec); font-size: 10px; cursor: pointer; opacity: 0; transition: all 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1; }
.tab-subbtn:hover .tab-close { opacity: 0.6; }
.tab-subbtn .tab-close:hover { opacity: 1; background: var(--danger); color: white; }
.tab-subbtn[draggable="true"] { cursor: grab; }
.tab-subbtn[draggable="true"]:active { cursor: grabbing; }
.tab-subbtn.dragging { opacity: 0.5; transform: scale(0.95); }
.tab-subbtn.drag-over { border-left: 3px solid var(--primary); }
.tabs-subnav.drag-over-category { background: rgba(43, 110, 246, 0.1); border: 2px dashed var(--primary); }
.hidden-tabs-toggle-cat { padding: 6px 12px; background: var(--bg); border: 1px dashed var(--border); border-radius: 6px; cursor: pointer; font-size: 0.8rem; color: var(--text-sec); transition: all 0.2s; display: none; align-items: center; gap: 5px; }
.hidden-tabs-toggle-cat:hover { background: var(--panel-bg); border-color: var(--primary); }
.hidden-tabs-toggle-cat .hidden-count { background: var(--danger); color: white; border-radius: 10px; padding: 1px 6px; font-size: 0.7rem; margin-left: 3px; }
.tab-category { position: relative; padding-right: 28px; }
.tab-category .cat-close { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; border-radius: 50%; background: transparent; border: none; color: var(--text-sec); font-size: 11px; cursor: pointer; opacity: 0; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.tab-category:hover .cat-close { opacity: 0.6; }
.tab-category .cat-close:hover { opacity: 1; background: var(--danger); color: white; }
.tab-category[draggable="true"] { cursor: grab; }
.tab-category[draggable="true"]:active { cursor: grabbing; }
.tab-category.dragging { opacity: 0.5; transform: scale(0.95); }
.tab-category.drag-over { border-left: 3px solid var(--primary); }
.hidden-categories-toggle { padding: 12px 18px; cursor: pointer; font-weight: 600; color: var(--text-sec); border: none; background: none; border-bottom: 3px solid transparent; transition: all 0.2s; display: none; align-items: center; gap: 8px; font-size: 0.85rem; }
.hidden-categories-toggle:hover { color: var(--text-main); background: var(--panel-bg); }
.hidden-categories-toggle .hidden-count { background: var(--danger); color: white; border-radius: 10px; padding: 2px 8px; font-size: 0.7rem; }

/* Tooltips modernes - style uniforme - positionnÃ©s dynamiquement via JS */
[data-tooltip] { position: relative; }
[data-tooltip]:hover::after { 
    content: attr(data-tooltip); 
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: #1a1a1a; 
    color: #fff; 
    padding: 8px 12px; 
    border-radius: 6px; 
    font-size: 0.75rem; 
    font-weight: 400; 
    z-index: 100002; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.4); 
    max-width: 200px; 
    text-align: center; 
    line-height: 1.4; 
    white-space: normal; 
    pointer-events: none; 
    animation: tooltipFadeIn 0.15s ease;
}
[data-tooltip]:hover::before { content: ''; position: absolute; bottom: calc(100% + 2px); left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #1a1a1a; z-index: 100002; }
[data-tooltip-pos="bottom"]:hover::after { bottom: auto; top: calc(100% + 8px); }
[data-tooltip-pos="bottom"]:hover::before { bottom: auto; top: calc(100% + 2px); border-top-color: transparent; border-bottom-color: #1a1a1a; }
/* Tooltips sur les bords - s'adaptent automatiquement */
[data-tooltip-pos="left"]:hover::after { bottom: auto; top: 50%; left: auto; right: calc(100% + 10px); transform: translateY(-50%); }
[data-tooltip-pos="left"]:hover::before { bottom: auto; top: 50%; left: auto; right: calc(100% + 4px); transform: translateY(-50%); border-top-color: transparent; border-left-color: #1a1a1a; }
@keyframes tooltipFadeIn { from { opacity: 0; transform: translateX(-50%) translateY(4px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

/* Menu position dropdown */
.position-dropdown-menu { animation: fadeIn 0.15s ease; }
.position-menu-item:hover { background: var(--primary); color: white; }
.position-menu-item.active { background: rgba(43, 110, 246, 0.1); font-weight: 600; }
.position-menu-item.active::before { content: 'âœ“ '; }

  /* Modale de confirmation moderne */
  .confirm-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100001; animation: fadeIn 0.2s ease; }
  .confirm-modal-box { background: var(--panel-bg); border-radius: 16px; padding: 25px; max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: scaleIn 0.2s ease; }
  .confirm-modal-icon { font-size: 3rem; text-align: center; margin-bottom: 15px; }
  .confirm-modal-title { font-size: 1.2rem; font-weight: 700; text-align: center; margin-bottom: 10px; color: var(--text-main); }
  .confirm-modal-message { font-size: 0.95rem; text-align: center; color: var(--text-sec); margin-bottom: 20px; line-height: 1.5; white-space: pre-line; }
  .confirm-modal-input { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; background: var(--input-bg); color: var(--text-main); margin-bottom: 20px; transition: border-color 0.2s; }
  .confirm-modal-input:focus { outline: none; border-color: var(--primary); }
  .confirm-modal-buttons { display: flex; gap: 12px; justify-content: center; }
  .confirm-modal-btn { padding: 12px 24px; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; min-width: 100px; }
  .confirm-modal-btn.cancel { background: var(--bg); color: var(--text-main); border: 1px solid var(--border); }
  .confirm-modal-btn.cancel:hover { background: var(--border); }
  .confirm-modal-btn.confirm { background: var(--primary); color: white; }
  .confirm-modal-btn.confirm:hover { background: #1a5cd4; transform: translateY(-1px); }
  .confirm-modal-btn.danger { background: var(--danger); color: white; }
  .confirm-modal-btn.danger:hover { background: #cc3333; transform: translateY(-1px); }
  .confirm-modal-btn.success { background: var(--success); color: white; }
  .confirm-modal-btn.success:hover { background: #1e8e3e; transform: translateY(-1px); }
  @-webkit-keyframes scaleIn { from { -webkit-transform: scale(0.9); transform: scale(0.9); opacity: 0; } to { -webkit-transform: scale(1); transform: scale(1); opacity: 1; } }
  @keyframes scaleIn { from { -webkit-transform: scale(0.9); transform: scale(0.9); opacity: 0; } to { -webkit-transform: scale(1); transform: scale(1); opacity: 1; } }

/* Ã‰diteur Synopsis - Style traitement de texte A4 */
.synopsis-editor-wrapper { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.synopsis-toolbar { display: flex; gap: 3px; padding: 6px 12px; background: var(--bg); border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center; }
.synopsis-toolbar-btn { padding: 5px 9px; border: 1px solid transparent; background: transparent; color: var(--text-main); border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: all 0.15s; min-width: 30px; text-align: center; }
.synopsis-toolbar-btn:hover { background: var(--hover-bg, rgba(0,0,0,0.06)); border-color: var(--border); }
.synopsis-toolbar-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
.synopsis-toolbar-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
.synopsis-toolbar select { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--panel-bg); color: var(--text-main); font-size: 0.8rem; cursor: pointer; }
.synopsis-a4-page { max-width: 210mm; margin: 20px auto; background: white; color: #1a1a1a; box-shadow: 0 2px 12px rgba(0,0,0,0.12); border-radius: 4px; }
.synopsis-editor-box { min-height: 297mm; padding: 25mm 30mm; font-size: 12pt; line-height: 1.8; font-family: 'Georgia', 'Times New Roman', serif; outline: none; }
.synopsis-editor-box:empty::before { content: attr(data-placeholder); color: #999; font-style: italic; pointer-events: none; }
.synopsis-editor-box h1 { font-size: 1.8em; font-weight: 800; margin: 1em 0 0.4em; color: #1a1a1a; letter-spacing: -0.02em; border-bottom: 2px solid #2B6EF6; padding-bottom: 0.3em; }
.synopsis-editor-box h2 { font-size: 1.4em; font-weight: 700; margin: 0.9em 0 0.3em; color: #2B6EF6; }
.synopsis-editor-box h3 { font-size: 1.05em; font-weight: 600; margin: 0.7em 0 0.3em; color: #555; text-transform: uppercase; letter-spacing: 0.03em; }
.synopsis-editor-box p { margin: 0.5em 0; color: #333; }
.synopsis-editor-box ul, .synopsis-editor-box ol { margin: 0.5em 0; padding-left: 1.5em; }
.synopsis-editor-box li { margin: 0.2em 0; }
.synopsis-editor-box blockquote { border-left: 3px solid var(--primary, #2B6EF6); margin: 0.5em 0; padding: 0.5em 1em; background: rgba(43,110,246,0.04); font-style: italic; }
.synopsis-editor-box img { max-width: 100%; height: auto; border-radius: 4px; margin: 0.5em 0; }
.synopsis-editor-box table { width: 100%; border-collapse: collapse; margin: 0.5em 0; }
.synopsis-editor-box table td, .synopsis-editor-box table th { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
.synopsis-editor-box table th { background: #f0f0f0; font-weight: 600; }
.synopsis-editor-box hr { border: none; border-top: 1px solid #ccc; margin: 1em 0; }
#tab-synopsis { background: var(--bg); }
.synopsis-section-wrapper { max-width: 230mm; margin: 0 auto; padding: 20px 10px; }

/* Ã‰tats vides engageants */
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; }
.empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.6; }
.empty-state-title { font-size: 1.3rem; font-weight: 600; color: var(--text-main); margin-bottom: 10px; }
.empty-state-desc { font-size: 0.95rem; color: var(--text-sec); margin-bottom: 25px; max-width: 400px; line-height: 1.5; }
.empty-state-btn { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
.empty-state-btn:hover { background: var(--primary-dark, #1a5cd4); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(43,110,246,0.3); }
.empty-state-tips { margin-top: 30px; padding: 15px 20px; background: var(--bg); border-radius: 8px; font-size: 0.85rem; color: var(--text-sec); }
.empty-state-tips strong { color: var(--text-main); }

/* Ressources */
.resources-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.resource-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; }
.resource-card:hover { box-shadow: 0 4px 15px var(--shadow); transform: translateY(-2px); }
.resource-card-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.resource-card-title { font-weight: 600; font-size: 1.1rem; color: var(--text-main); }
.resource-card-category { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
.resource-card-category.accessoire { background: #e3f2fd; color: #1565c0; }
.resource-card-category.costume { background: #f3e5f5; color: #7b1fa2; }
.resource-card-category.vehicule { background: #fff3e0; color: #ef6c00; }
body.dark-mode .resource-card-category.accessoire { background: #1565c0; color: #e3f2fd; }
body.dark-mode .resource-card-category.costume { background: #7b1fa2; color: #f3e5f5; }
body.dark-mode .resource-card-category.vehicule { background: #ef6c00; color: #fff3e0; }
.resource-card-body { padding: 15px; }
.resource-card-photo { width: 100%; height: 150px; object-fit: cover; background: var(--bg); display: flex; align-items: center; justify-content: center; color: var(--text-sec); font-size: 3rem; }
.resource-card-photo img { width: 100%; height: 100%; object-fit: cover; }
.resource-card-desc { font-size: 0.9rem; color: var(--text-sec); margin: 10px 0; line-height: 1.4; }
.resource-card-info { font-size: 0.85rem; color: var(--text-sec); margin: 5px 0; }
.resource-card-info strong { color: var(--text-main); }
.resource-card-scenes { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
.resource-card-scene { font-size: 0.75rem; padding: 3px 8px; background: var(--bg); border-radius: 4px; color: var(--text-sec); }
.resource-card-actions { padding: 10px 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
.resource-card-actions button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
.res-filter-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--panel-bg); color: var(--text-main); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
.res-filter-btn:hover { background: var(--bg); }
.res-filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

.tabs-nav.adaptive .tab-btn { padding-right: 20px; }
.tabs-nav.adaptive .tab-btn .tab-close { right: 2px; width: 14px; height: 14px; font-size: 10px; }

/* Bouton onglets masquÃ©s */
.tab-btn-hidden-toggle { padding: 12px 15px; cursor: pointer; font-weight: 600; color: var(--primary); border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.2s; background: none; border-left: 1px dashed var(--border); margin-left: auto; }
.tab-btn-hidden-toggle:hover { background: rgba(43, 110, 246, 0.1); }
.tab-btn-hidden-toggle .hidden-count { background: var(--danger); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }

/* Menu onglets masquÃ©s */
.hidden-tabs-menu { position: fixed; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); z-index: 10001; min-width: 220px; display: none; }
.hidden-tabs-menu.visible { display: block; }
.hidden-tabs-menu-header { padding: 12px 15px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.85rem; color: var(--text-sec); display: flex; justify-content: space-between; align-items: center; }
.hidden-tabs-menu-header button { font-size: 0.75rem; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
.hidden-tabs-menu-header button:hover { background: var(--primary-dark, #1d4ed8); }
.hidden-tabs-menu-list { max-height: 300px; overflow-y: auto; }
.hidden-tabs-menu-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
.hidden-tabs-menu-item:hover { background: var(--bg); }
.hidden-tabs-menu-item span { flex: 1; }

/* Vue compacte des fiches (grille de cartes) */
.compact-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 10px 0; }
.compact-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
.compact-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
.compact-card-photo { width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 10px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; border: 3px solid var(--border); }
.compact-card-photo img { width: 100%; height: 100%; object-fit: cover; }
.compact-card-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.compact-card-role { font-size: 0.8rem; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.compact-card-badge { position: absolute; top: 8px; right: 8px; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: var(--primary); color: white; }
.compact-card-actions { position: absolute; top: 8px; left: 8px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; }
.compact-card:hover .compact-card-actions { opacity: 1; }
.compact-card-actions button { width: 26px; height: 26px; border-radius: 50%; border: none; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
.compact-card-actions .edit-btn { background: var(--primary); color: white; }
.compact-card-actions .delete-btn { background: var(--danger); color: white; }

/* Modal d'Ã©dition de fiche */
.card-edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10001; justify-content: center; align-items: center; padding: 20px; }
.card-edit-modal.visible { display: flex; }
.card-edit-modal-content { background: var(--panel-bg); border-radius: 12px; width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.card-edit-modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
.card-edit-modal-header h3 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
.card-edit-modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); padding: 5px; }
.card-edit-modal-close:hover { color: var(--danger); }
.card-edit-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.card-edit-modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: var(--bg); }

/* Toggle vue compacte / dÃ©taillÃ©e */
.view-toggle-bar { display: flex; justify-content: flex-end; gap: 10px; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
.view-toggle-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--bg); border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-sec); transition: all 0.2s; }
.view-toggle-btn:hover { background: var(--panel-bg); }
.view-toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

/* Favoris */
.favorite-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 5px; transition: transform 0.2s; }
.favorite-btn:hover { transform: scale(1.2); }
.favorite-btn.active { color: #f59e0b; }
.favorites-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
.favorites-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
.favorite-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
.favorite-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 4px 15px var(--shadow); }
.favorite-card-photo { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden; }
.favorite-card-photo img { width: 100%; height: 100%; object-fit: cover; }
.favorite-card-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; }
.favorite-card-role { font-size: 0.75rem; color: var(--text-sec); }
.favorite-card-remove { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 0.8rem; cursor: pointer; display: none; }
.favorite-card:hover .favorite-card-remove { display: block; }

/* ===== ANIMATIONS DE TRANSITION ===== */
/* Fade in gÃ©nÃ©ral */
@-webkit-keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  @keyframes progressShimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  /* ========== LOADING SCREEN - Ã‰QUIPE DE TOURNAGE ========== */
  .loading-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    height: calc(var(--vh, 1vh) * 100);
    background: rgba(0, 0, 0, 0.9);
    display: none;
    -webkit-justify-content: center; justify-content: center;
    -webkit-align-items: center; align-items: center;
    z-index: 999999;
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
  }
  .loading-overlay.visible { display: -webkit-flex; display: flex; }
  
  .loading-box {
    background: var(--panel-bg);
    border-radius: 20px;
    padding: 30px 35px;
    text-align: center;
    box-shadow: 0 25px 80px rgba(0,0,0,0.6);
    max-width: 520px;
    width: 94%;
  }
  
  .loading-scene {
    height: 140px;
    position: relative;
    margin-bottom: 20px;
    overflow: hidden;
    border-radius: 14px;
    background: linear-gradient(180deg, 
      #6BB3E0 0%, 
      #87CEEB 30%,
      #B0D4E8 60%,
      #E8D4A8 75%,
      #C9A86C 85%,
      #8B7355 100%);
  }
  
  /* === SOL DÃ‰FILANT === */
  .loading-ground {
    position: absolute;
    bottom: 0; left: 0;
    width: 400%;
    height: 22px;
    background: 
      repeating-linear-gradient(90deg,
        #5D4E37 0px, #5D4E37 6px,
        #6B5B45 6px, #6B5B45 12px,
        #4A3F2F 12px, #4A3F2F 18px,
        #7D6B52 18px, #7D6B52 24px,
        #5D4E37 24px, #5D4E37 30px,
        #8B7B62 30px, #8B7B62 36px
      );
    -webkit-animation: groundScroll 0.6s linear infinite;
    animation: groundScroll 0.6s linear infinite;
  }
  @-webkit-keyframes groundScroll {
    0% { -webkit-transform: translateX(0); }
    100% { -webkit-transform: translateX(-36px); }
  }
  @keyframes groundScroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-36px); }
  }

  /* === Ã‰QUIPE DE TOURNAGE === */
  .loading-crew {
    position: absolute;
    bottom: 22px;
    left: 50%;
    -webkit-transform: translateX(-50%);
    transform: translateX(-50%);
    display: -webkit-flex; display: flex;
    -webkit-align-items: flex-end; align-items: flex-end;
    gap: 2px;
  }

  .pixel-person {
    position: relative;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    -webkit-animation: personBounce 0.25s steps(1) infinite;
    animation: personBounce 0.25s steps(1) infinite;
  }
  @-webkit-keyframes personBounce {
    0%, 100% { -webkit-transform: translateY(0); }
    50% { -webkit-transform: translateY(-4px); }
  }
  @keyframes personBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }

  /* ============================================
     ðŸŽ¤ PERCHMAN - Position 1 (tout Ã  gauche, en retard)
     Gilet fluo, perche folle, cÃ¢ble qui traÃ®ne
     ============================================ */
  .pixel-perch {
    width: 40px;
    height: 70px;
    order: 1;
    margin-right: 20px;
    -webkit-animation: personBounceSlow 0.3s steps(1) infinite;
    animation: personBounceSlow 0.3s steps(1) infinite;
  }
  @-webkit-keyframes personBounceSlow {
    0%, 100% { -webkit-transform: translateY(0); }
    50% { -webkit-transform: translateY(-3px); }
  }
  @keyframes personBounceSlow {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }
  .pixel-perch-body {
    position: absolute;
    bottom: 0;
    left: 8px;
    width: 24px;
    height: 48px;
  }
  .pixel-perch-body::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #5D4037;
    left: 6px; top: 0;
    box-shadow:
      /* Cheveux Ã©bouriffÃ©s */
      4px 0 0 #5D4037, -2px 2px 0 #5D4037, 10px 2px 0 #5D4037,
      /* TÃªte */
      2px 4px 0 #FFDAB9, 6px 4px 0 #FFDAB9, 10px 4px 0 #FFDAB9,
      2px 8px 0 #FFDAB9, 6px 8px 0 #FFDAB9, 10px 8px 0 #FFDAB9,
      6px 12px 0 #FFDAB9,
      /* Yeux fatiguÃ©s */
      4px 6px 0 #333, 10px 6px 0 #333,
      /* Gilet fluo sÃ©curitÃ© */
      -2px 16px 0 #AEEA00, 2px 16px 0 #AEEA00, 6px 16px 0 #AEEA00, 10px 16px 0 #AEEA00, 14px 16px 0 #AEEA00,
      0px 20px 0 #C6FF00, 4px 20px 0 #1a1a1a, 8px 20px 0 #1a1a1a, 12px 20px 0 #C6FF00,
      0px 24px 0 #AEEA00, 4px 24px 0 #AEEA00, 8px 24px 0 #AEEA00, 12px 24px 0 #AEEA00,
      2px 28px 0 #C6FF00, 6px 28px 0 #C6FF00, 10px 28px 0 #C6FF00,
      /* Pantalon cargo */
      2px 32px 0 #5D4037, 6px 32px 0 #5D4037, 10px 32px 0 #5D4037,
      0px 36px 0 #4E342E, 4px 36px 0 #4E342E, 8px 36px 0 #4E342E, 12px 36px 0 #4E342E,
      0px 40px 0 #3E2723, 12px 40px 0 #3E2723,
      /* Grosses boots */
      -2px 44px 0 #1a1a1a, 2px 44px 0 #1a1a1a, 6px 44px 0 #1a1a1a,
      10px 44px 0 #1a1a1a, 14px 44px 0 #1a1a1a;
  }
  /* Bras qui tient la perche en l'air */
  .pixel-perch-body::after {
    content: '';
    position: absolute;
    left: 16px; top: 14px;
    width: 4px; height: 12px;
    background: #FFDAB9;
    -webkit-transform: rotate(-30deg);
    transform: rotate(-30deg);
  }
  /* Perche */
  .pixel-perch-pole {
    position: absolute;
    left: 22px; top: -30px;
    width: 5px; height: 65px;
    background: linear-gradient(180deg, #888 0%, #666 50%, #444 100%);
    border-radius: 2px;
    -webkit-transform-origin: bottom center;
    transform-origin: bottom center;
    -webkit-animation: percheCrazy 0.35s ease-in-out infinite;
    animation: percheCrazy 0.35s ease-in-out infinite;
  }
  @-webkit-keyframes percheCrazy {
    0% { -webkit-transform: rotate(-20deg); }
    20% { -webkit-transform: rotate(25deg); }
    40% { -webkit-transform: rotate(-15deg); }
    60% { -webkit-transform: rotate(30deg); }
    80% { -webkit-transform: rotate(-25deg); }
    100% { -webkit-transform: rotate(-20deg); }
  }
  @keyframes percheCrazy {
    0% { transform: rotate(-20deg); }
    20% { transform: rotate(25deg); }
    40% { transform: rotate(-15deg); }
    60% { transform: rotate(30deg); }
    80% { transform: rotate(-25deg); }
    100% { transform: rotate(-20deg); }
  }
  /* Micro bonette */
  .pixel-perch-mic {
    position: absolute;
    left: 18px; top: -38px;
    width: 20px; height: 14px;
    background: linear-gradient(90deg, #333 0%, #555 50%, #333 100%);
    border-radius: 7px;
    -webkit-transform-origin: 8px 45px;
    transform-origin: 8px 45px;
    -webkit-animation: percheCrazy 0.35s ease-in-out infinite;
    animation: percheCrazy 0.35s ease-in-out infinite;
  }
  .pixel-perch-mic::before {
    content: '';
    position: absolute;
    width: 100%; height: 100%;
    background: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px);
    border-radius: 7px;
  }

  

  /* ============================================
     ðŸŽ­ COMÃ‰DIEN HOMME - Position 2
     Costume Ã©lÃ©gant
     ============================================ */
  .pixel-actor1 {
    width: 28px;
    height: 52px;
    order: 2;
  }
  .pixel-actor1::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #3E2723;
    left: 8px; top: 0;
    box-shadow:
      /* Cheveux coiffÃ©s */
      4px 0 0 #3E2723, 8px 0 0 #3E2723, 4px -2px 0 #3E2723,
      /* TÃªte */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Yeux */
      6px 6px 0 #333, 12px 6px 0 #333,
      /* Sourire */
      8px 10px 0 #c97878,
      /* Veste costume gris */
      2px 16px 0 #455A64, 6px 16px 0 #455A64, 10px 16px 0 #455A64, 14px 16px 0 #455A64,
      0px 20px 0 #546E7A, 4px 20px 0 #37474F, 8px 20px 0 #ECEFF1, 12px 20px 0 #37474F, 16px 20px 0 #546E7A,
      2px 24px 0 #455A64, 6px 24px 0 #455A64, 10px 24px 0 #455A64, 14px 24px 0 #455A64,
      4px 28px 0 #37474F, 8px 28px 0 #37474F, 12px 28px 0 #37474F,
      /* Pantalon */
      4px 32px 0 #263238, 8px 32px 0 #263238, 12px 32px 0 #263238,
      2px 36px 0 #1C313A, 6px 36px 0 #1C313A, 10px 36px 0 #1C313A, 14px 36px 0 #1C313A,
      2px 40px 0 #263238, 14px 40px 0 #263238,
      /* Chaussures cirÃ©es */
      0px 44px 0 #1a1a1a, 4px 44px 0 #1a1a1a,
      12px 44px 0 #1a1a1a, 16px 44px 0 #1a1a1a;
  }

  /* ============================================
     ðŸŽ­ COMÃ‰DIENNE FEMME - Position 3
     Robe Ã©lÃ©gante, talons
     ============================================ */
  .pixel-actor2 {
    width: 26px;
    height: 52px;
    order: 3;
  }
  .pixel-actor2::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #D4A574;
    left: 4px; top: -2px;
    box-shadow:
      /* Cheveux longs blonds */
      4px -2px 0 #D4A574, 8px 0px 0 #D4A574, 12px 0px 0 #D4A574,
      0px 2px 0 #D4A574, 14px 2px 0 #D4A574,
      0px 6px 0 #C49A6C, 14px 6px 0 #C49A6C,
      0px 10px 0 #D4A574, 16px 10px 0 #D4A574,
      /* TÃªte */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Yeux maquillÃ©s */
      6px 6px 0 #1a1a1a, 12px 6px 0 #1a1a1a,
      /* LÃ¨vres */
      8px 10px 0 #E91E63,
      /* Robe rouge Ã©lÃ©gante */
      4px 16px 0 #C62828, 8px 16px 0 #C62828, 12px 16px 0 #C62828,
      2px 20px 0 #D32F2F, 6px 20px 0 #B71C1C, 10px 20px 0 #B71C1C, 14px 20px 0 #D32F2F,
      0px 24px 0 #C62828, 4px 24px 0 #C62828, 8px 24px 0 #C62828, 12px 24px 0 #C62828, 16px 24px 0 #C62828,
      0px 28px 0 #B71C1C, 4px 28px 0 #B71C1C, 8px 28px 0 #B71C1C, 12px 28px 0 #B71C1C, 16px 28px 0 #B71C1C,
      2px 32px 0 #C62828, 6px 32px 0 #C62828, 10px 32px 0 #C62828, 14px 32px 0 #C62828,
      4px 36px 0 #D32F2F, 8px 36px 0 #D32F2F, 12px 36px 0 #D32F2F,
      /* Jambes */
      4px 40px 0 #FFDAB9, 12px 40px 0 #FFDAB9,
      /* Talons hauts */
      2px 44px 0 #1a1a1a, 6px 44px 0 #1a1a1a, 6px 46px 0 #1a1a1a,
      10px 44px 0 #1a1a1a, 14px 44px 0 #1a1a1a, 14px 46px 0 #1a1a1a;
  }

  /* ============================================
     ðŸŽ¥ CAMÃ‰RAMAN - Position 4
     CamÃ©ra Ã©paule, casquette retournÃ©e
     ============================================ */
  .pixel-camera {
    width: 44px;
    height: 52px;
    order: 4;
  }
  .pixel-camera::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #1a1a1a;
    left: 10px; top: 2px;
    box-shadow:
      /* Casquette retournÃ©e */
      4px 0 0 #1a1a1a, 8px 0 0 #1a1a1a, -2px 2px 0 #333,
      /* TÃªte */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Yeux concentrÃ©s */
      6px 6px 0 #333, 12px 6px 0 #333,
      /* Barbe 3 jours */
      4px 10px 0 #8D6E63, 8px 10px 0 #8D6E63, 12px 10px 0 #8D6E63,
      /* T-shirt noir technique */
      2px 16px 0 #212121, 6px 16px 0 #212121, 10px 16px 0 #212121, 14px 16px 0 #212121,
      0px 20px 0 #1a1a1a, 4px 20px 0 #1a1a1a, 8px 20px 0 #1a1a1a, 12px 20px 0 #1a1a1a, 16px 20px 0 #1a1a1a,
      2px 24px 0 #212121, 6px 24px 0 #212121, 10px 24px 0 #212121, 14px 24px 0 #212121,
      /* Bras vers camÃ©ra */
      16px 16px 0 #FFDAB9, 20px 14px 0 #FFDAB9, 24px 12px 0 #FFDAB9,
      /* Pantalon cargo */
      4px 28px 0 #4E342E, 8px 28px 0 #4E342E, 12px 28px 0 #4E342E,
      2px 32px 0 #5D4037, 6px 32px 0 #5D4037, 10px 32px 0 #5D4037, 14px 32px 0 #5D4037,
      2px 36px 0 #4E342E, 14px 36px 0 #4E342E,
      /* Baskets */
      0px 40px 0 #F5F5F5, 4px 40px 0 #E0E0E0, 8px 40px 0 #2196F3,
      12px 40px 0 #F5F5F5, 16px 40px 0 #E0E0E0, 20px 40px 0 #2196F3;
  }
  /* CamÃ©ra sur Ã©paule droite */
  .pixel-camera::after {
    content: '';
    position: absolute;
    right: 0px; top: 6px;
    width: 22px; height: 14px;
    background: linear-gradient(180deg, #1a1a1a 0%, #333 50%, #1a1a1a 100%);
    border-radius: 3px;
    box-shadow:
      /* Objectif */
      22px 3px 0 4px #263238,
      26px 5px 0 2px #1a1a1a,
      /* Viseur */
      -4px -4px 0 0 #333,
      /* LumiÃ¨re rouge REC */
      2px 2px 0 0 #f44336;
  }
  /* LumiÃ¨re REC clignotante */
  .pixel-camera-rec {
    position: absolute;
    right: 18px; top: 8px;
    width: 4px; height: 4px;
    background: #f44336;
    border-radius: 50%;
    -webkit-animation: recBlink 0.8s ease-in-out infinite;
    animation: recBlink 0.8s ease-in-out infinite;
  }
  @-webkit-keyframes recBlink {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px #f44336; }
    50% { opacity: 0.3; box-shadow: none; }
  }
  @keyframes recBlink {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px #f44336; }
    50% { opacity: 0.3; box-shadow: none; }
  }

  /* ============================================
     ðŸ“ SCRIPTE - Position 5
     Femme avec classeur, feuilles qui s'envolent
     ============================================ */
  .pixel-script {
    width: 32px;
    height: 52px;
    order: 5;
    position: relative;
  }
  .pixel-script::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #4E342E;
    left: 8px; top: -2px;
    box-shadow:
      /* Cheveux attachÃ©s chignon */
      4px -2px 0 #4E342E, 8px -2px 0 #4E342E,
      0px 2px 0 #5D4037, 12px 2px 0 #5D4037,
      14px 0px 0 #4E342E, 16px 2px 0 #4E342E,
      /* TÃªte */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Lunettes */
      4px 6px 0 #1a1a1a, 6px 6px 0 #64B5F6, 10px 6px 0 #64B5F6, 12px 6px 0 #1a1a1a,
      /* Chemisier blanc */
      4px 16px 0 #FAFAFA, 8px 16px 0 #FAFAFA, 12px 16px 0 #FAFAFA,
      2px 20px 0 #F5F5F5, 6px 20px 0 #E0E0E0, 10px 20px 0 #E0E0E0, 14px 20px 0 #F5F5F5,
      4px 24px 0 #FAFAFA, 8px 24px 0 #FAFAFA, 12px 24px 0 #FAFAFA,
      /* Gilet gris */
      0px 18px 0 #757575, 16px 18px 0 #757575,
      0px 22px 0 #616161, 16px 22px 0 #616161,
      /* Jupe crayon */
      4px 28px 0 #1a1a1a, 8px 28px 0 #1a1a1a, 12px 28px 0 #1a1a1a,
      4px 32px 0 #212121, 8px 32px 0 #212121, 12px 32px 0 #212121,
      6px 36px 0 #1a1a1a, 10px 36px 0 #1a1a1a,
      /* Jambes */
      6px 40px 0 #FFDAB9, 10px 40px 0 #FFDAB9,
      /* Chaussures plates */
      4px 44px 0 #1a1a1a, 8px 44px 0 #1a1a1a,
      10px 44px 0 #1a1a1a, 14px 44px 0 #1a1a1a;
  }
  /* Classeur tenu devant */
  .pixel-script::after {
    content: '';
    position: absolute;
    left: -4px; top: 18px;
    width: 12px; height: 18px;
    background: linear-gradient(180deg, #ECEFF1 0%, #CFD8DC 100%);
    border: 2px solid #90A4AE;
    border-radius: 2px;
    box-shadow: inset 2px 0 0 #B0BEC5;
  }

  /* ============================================
     ðŸŽ¬ RÃ‰ALISATEUR - Position 6 (tout Ã  droite, en tÃªte)
     Casquette, lunettes, mÃ©gaphone
     ============================================ */
  .pixel-director {
    width: 40px;
    height: 52px;
    order: 6;
    margin-left: 4px;
  }
  .pixel-director::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #1a1a1a;
    left: 6px; top: -2px;
    box-shadow:
      /* Casquette */
      4px -2px 0 #1a1a1a, 8px -2px 0 #1a1a1a, 12px -2px 0 #1a1a1a,
      0px 0px 0 #1a1a1a, 4px 0px 0 #212121, 8px 0px 0 #212121, 12px 0px 0 #212121, 16px 0px 0 #1a1a1a,
      /* VisiÃ¨re */
      16px 2px 0 #1a1a1a, 20px 2px 0 #1a1a1a, 24px 4px 0 #1a1a1a,
      /* TÃªte */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Lunettes de soleil */
      4px 6px 0 #1a1a1a, 6px 6px 0 #1a1a1a, 10px 6px 0 #1a1a1a, 12px 6px 0 #1a1a1a,
      /* Barbe */
      6px 10px 0 #5D4037, 10px 10px 0 #5D4037,
      /* Veste cuir noir */
      2px 16px 0 #212121, 6px 16px 0 #212121, 10px 16px 0 #212121, 14px 16px 0 #212121,
      0px 20px 0 #1a1a1a, 4px 20px 0 #333, 8px 20px 0 #333, 12px 20px 0 #333, 16px 20px 0 #1a1a1a,
      2px 24px 0 #212121, 6px 24px 0 #212121, 10px 24px 0 #212121, 14px 24px 0 #212121,
      4px 28px 0 #1a1a1a, 8px 28px 0 #1a1a1a, 12px 28px 0 #1a1a1a,
      /* Jean */
      4px 32px 0 #1565C0, 8px 32px 0 #1565C0, 12px 32px 0 #1565C0,
      2px 36px 0 #0D47A1, 6px 36px 0 #0D47A1, 10px 36px 0 #0D47A1, 14px 36px 0 #0D47A1,
      2px 40px 0 #1565C0, 14px 40px 0 #1565C0,
      /* Boots */
      0px 44px 0 #3E2723, 4px 44px 0 #4E342E, 8px 44px 0 #3E2723,
      10px 44px 0 #3E2723, 14px 44px 0 #4E342E, 18px 44px 0 #3E2723;
  }
  /* Bras avec mÃ©gaphone */
  .pixel-director-arm {
    position: absolute;
    right: -8px; top: 14px;
    width: 8px; height: 4px;
    background: #FFDAB9;
  }
  /* MÃ©gaphone */
  .pixel-director-mega {
    position: absolute;
    right: -24px; top: 8px;
    width: 24px; height: 16px;
    background: linear-gradient(135deg, #FFC107 0%, #FF9800 50%, #F57C00 100%);
    clip-path: polygon(0% 25%, 0% 75%, 100% 100%, 100% 0%);
    -webkit-animation: megaShake 0.3s ease-in-out infinite;
    animation: megaShake 0.3s ease-in-out infinite;
  }
  @-webkit-keyframes megaShake {
    0%, 100% { -webkit-transform: rotate(-5deg); }
    50% { -webkit-transform: rotate(8deg); }
  }
  @keyframes megaShake {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(8deg); }
  }
  .pixel-director-mega::before {
    content: '';
    position: absolute;
    left: -4px; top: 4px;
    width: 6px; height: 8px;
    background: #E65100;
    border-radius: 2px;
  }
  /* Ondes sonores du mÃ©gaphone */
  .pixel-director-waves {
    position: absolute;
    right: -32px; top: 6px;
    width: 12px; height: 20px;
    opacity: 0.6;
    -webkit-animation: wavePulse 0.4s ease-out infinite;
    animation: wavePulse 0.4s ease-out infinite;
  }
  .pixel-director-waves::before,
  .pixel-director-waves::after {
    content: '';
    position: absolute;
    border: 2px solid #FF9800;
    border-left: none;
    border-radius: 0 50% 50% 0;
  }
  .pixel-director-waves::before {
    width: 6px; height: 12px;
    top: 4px; left: 0;
  }
  .pixel-director-waves::after {
    width: 10px; height: 18px;
    top: 1px; left: 2px;
  }
  @-webkit-keyframes wavePulse {
    0% { opacity: 0.8; -webkit-transform: scaleX(0.8); }
    100% { opacity: 0; -webkit-transform: scaleX(1.2); }
  }
  @keyframes wavePulse {
    0% { opacity: 0.8; transform: scaleX(0.8); }
    100% { opacity: 0; transform: scaleX(1.2); }
  }

  /* ============================================
     ðŸ“„ FEUILLES QUI S'ENVOLENT (depuis la scripte vers la gauche)
     ============================================ */
  .loading-papers {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    overflow: hidden;
  }
  .flying-paper {
    position: absolute;
    width: 14px; height: 18px;
    background: linear-gradient(180deg, #FFFFFF 0%, #F5F5F5 100%);
    border: 1px solid #E0E0E0;
    border-radius: 1px;
    box-shadow: 1px 1px 3px rgba(0,0,0,0.15);
    /* DÃ©part depuis la scripte (position 5, vers la droite) */
    right: 28%; bottom: 55px;
    -webkit-animation: paperFlyLeft 2s ease-out infinite;
    animation: paperFlyLeft 2s ease-out infinite;
  }
  .flying-paper::before {
    content: '';
    position: absolute;
    top: 3px; left: 2px; right: 2px;
    height: 1px;
    background: #BDBDBD;
    box-shadow: 0 3px 0 #BDBDBD, 0 6px 0 #BDBDBD, 0 9px 0 #BDBDBD, 0 12px 0 #BDBDBD;
  }
  
  @-webkit-keyframes paperFlyLeft {
    0% { -webkit-transform: translate(0, 0) rotate(0deg) scale(1); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-120px, -80px) rotate(-400deg) scale(0.5); opacity: 0; }
  }
  @keyframes paperFlyLeft {
    0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-120px, -80px) rotate(-400deg) scale(0.5); opacity: 0; }
  }
  
  .flying-paper:nth-child(1) { -webkit-animation-delay: 0s; animation-delay: 0s; }
  .flying-paper:nth-child(2) { -webkit-animation-delay: 0.35s; animation-delay: 0.35s; -webkit-animation-name: paperFlyLeft2; animation-name: paperFlyLeft2; }
  .flying-paper:nth-child(3) { -webkit-animation-delay: 0.7s; animation-delay: 0.7s; -webkit-animation-name: paperFlyLeft3; animation-name: paperFlyLeft3; }
  .flying-paper:nth-child(4) { -webkit-animation-delay: 1.05s; animation-delay: 1.05s; -webkit-animation-name: paperFlyLeft4; animation-name: paperFlyLeft4; }
  .flying-paper:nth-child(5) { -webkit-animation-delay: 1.4s; animation-delay: 1.4s; -webkit-animation-name: paperFlyLeft5; animation-name: paperFlyLeft5; }
  .flying-paper:nth-child(6) { -webkit-animation-delay: 1.75s; animation-delay: 1.75s; }

  @-webkit-keyframes paperFlyLeft2 {
    0% { -webkit-transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-100px, -95px) rotate(350deg); opacity: 0; }
  }
  @keyframes paperFlyLeft2 {
    0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-100px, -95px) rotate(350deg); opacity: 0; }
  }
  @-webkit-keyframes paperFlyLeft3 {
    0% { -webkit-transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-140px, -60px) rotate(-300deg); opacity: 0; }
  }
  @keyframes paperFlyLeft3 {
    0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-140px, -60px) rotate(-300deg); opacity: 0; }
  }
  @-webkit-keyframes paperFlyLeft4 {
    0% { -webkit-transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-90px, -110px) rotate(420deg); opacity: 0; }
  }
  @keyframes paperFlyLeft4 {
    0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-90px, -110px) rotate(420deg); opacity: 0; }
  }
  @-webkit-keyframes paperFlyLeft5 {
    0% { -webkit-transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-130px, -75px) rotate(-480deg); opacity: 0; }
  }
  @keyframes paperFlyLeft5 {
    0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-130px, -75px) rotate(-480deg); opacity: 0; }
  }

  /* ============================================
     TEXTE ET BARRE DE PROGRESSION
     ============================================ */
  .loading-clap {
    font-size: 2.2rem;
    margin-bottom: 10px;
    -webkit-animation: clapAnim 0.8s ease-in-out infinite;
    animation: clapAnim 0.8s ease-in-out infinite;
  }
  @-webkit-keyframes clapAnim {
    0%, 100% { -webkit-transform: scale(1) rotate(0deg); }
    25% { -webkit-transform: scale(1.15) rotate(-8deg); }
    75% { -webkit-transform: scale(1.05) rotate(4deg); }
  }
  @keyframes clapAnim {
    0%, 100% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.15) rotate(-8deg); }
    75% { transform: scale(1.05) rotate(4deg); }
  }
  .loading-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 6px;
  }
  .loading-message {
    font-size: 0.88rem;
    color: var(--text-sec);
    min-height: 20px;
    font-style: italic;
    -webkit-animation: messageFade 0.5s ease;
    animation: messageFade 0.5s ease;
  }
  @-webkit-keyframes messageFade {
    from { opacity: 0; -webkit-transform: translateY(8px); }
    to { opacity: 1; -webkit-transform: translateY(0); }
  }
  @keyframes messageFade {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .loading-progress {
    margin-top: 16px;
    height: 5px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }
  .loading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), #8b5cf6, #ec4899, var(--primary));
    background-size: 300% 100%;
    border-radius: 3px;
    -webkit-animation: progressShimmer 2s ease-in-out infinite;
    animation: progressShimmer 2s ease-in-out infinite;
    width: 30%;
    transition: width 0.3s ease;
  }
  @-webkit-keyframes progressShimmer {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
  }
  @keyframes progressShimmer {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
  }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
/* scaleIn dÃ©jÃ  dÃ©fini avec prÃ©fixes webkit plus haut */
@keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
@keyframes slideInLeft { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }
@keyframes subtleFadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes subtleScale { from { opacity: 0; transform: scale(0.97); } to { opacity: 1; transform: scale(1); } }

/* ===== ANIMATIONS GLOBALES SUBTILES ===== */

/* Transition entre onglets â€” fondu + lÃ©ger glissement vers le haut */
.tab-content.active { animation: subtleFadeUp 0.25s ease-out; }

/* Boutons d'onglets â€” transition douce hover */
.tab-category, .tab-subbtn, .tab-btn { transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
.tab-category:hover, .tab-subbtn:hover { transform: translateY(-1px); }

/* Header â€” ombre douce au scroll (prÃªte pour JS) */
header { transition: box-shadow 0.3s ease, background 0.3s ease; }

/* Modales â€” apparition douce */
.modal-overlay, .profile-modal-overlay, .terms-modal-overlay { transition: opacity 0.2s ease; }
.modal-content, .profile-modal-box, .terms-modal { animation: subtleScale 0.25s cubic-bezier(0.4, 0, 0.2, 1); }

/* Cards & sections â€” apparition en cascade */
.synopsis-section { animation: subtleFadeUp 0.3s ease-out; }
.synopsis-section:nth-child(2) { animation-delay: 0.05s; animation-fill-mode: both; }
.synopsis-section:nth-child(3) { animation-delay: 0.1s; animation-fill-mode: both; }

/* Boutons â€” micro-rebond au hover */
button, .synopsis-toolbar-btn, .board-mode-btn, .editor-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
.synopsis-toolbar-btn:active, button:active { transform: scale(0.96); }

/* Cards sÃ©quencier / projets â€” Ã©lÃ©vation douce */
.sc-card, .sb-card, .dash-card, .expense-card, .contact-card, .message-card, .new-project-card { transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; }
.sc-card:hover, .sb-card:hover, .dash-card:hover, .expense-card:hover, .contact-card:hover, .message-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.08); }

/* Tooltip â€” fade in subtil */
[data-tooltip]::after, [data-tooltip]::before { transition: opacity 0.15s ease 0.3s, transform 0.15s ease 0.3s; }

/* Inputs â€” focus doux */
input, textarea, select { transition: border-color 0.2s ease, box-shadow 0.2s ease; }
input:focus, textarea:focus, select:focus { box-shadow: 0 0 0 3px rgba(43, 110, 246, 0.1); }

/* Sidebar sÃ©quencier â€” slide doux */

/* Tab-subnav â€” apparition douce quand on change de catÃ©gorie */
.tabs-subnav { animation: subtleFadeUp 0.2s ease-out; }

/* Synopsis A4 page â€” ombre au hover subtile */
.synopsis-a4-page { transition: box-shadow 0.3s ease; }
.synopsis-a4-page:focus-within { box-shadow: 0 4px 20px rgba(0,0,0,0.15); }

/* Ã‰diteur scÃ©nario â€” transitions fluides */
.sc-panel { transition: opacity 0.2s ease; }

/* Chat panel â€” slide up */
.chat-panel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

/* Badges, tags â€” scale subtil */
.scene-status-badge, .profile-project-badge { transition: all 0.15s ease; }
.scene-status-badge:hover, .profile-project-badge:hover { transform: scale(1.05); }

/* Focus mode toolbar â€” slide in depuis le haut */
.focus-toolbar { animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

/* Scrollbar â€” plus discrÃ¨te, style macOS */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.3); border-radius: 10px; border: 2px solid transparent; background-clip: padding-box; }
::-webkit-scrollbar-thumb:hover { background: rgba(128,128,128,0.5); border: 2px solid transparent; background-clip: padding-box; }

/* Modales */
.profile-modal-overlay, .message-detail-modal, .global-search-modal, .permissions-modal { animation: fadeIn 0.2s ease; }
.profile-modal-box, .message-detail-box, .global-search-container, .permissions-container { animation: scaleIn 0.25s ease; }

/* Onglets contenu â€” animation gÃ©rÃ©e par le bloc global */

/* === MODE FOCUS (Plein Ã©cran onglet) === */
body.focus-mode header,
body.focus-mode .tabs-categories,
body.focus-mode .tabs-subnav,
body.focus-mode .tabs-nav,
body.focus-mode #quick-nav { display: none !important; }
body.focus-mode .tab-content { max-width: 100%; padding: 20px 40px 100px; }
body.focus-mode .tab-content.active { padding-top: 60px; }

.focus-toolbar { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: var(--panel-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.focus-toolbar-left { display: flex; align-items: center; gap: 10px; }
.focus-toolbar-center { display: flex; align-items: center; gap: 15px; }
.focus-toolbar-right { display: flex; align-items: center; gap: 10px; }
.focus-toolbar .focus-btn { padding: 8px 14px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
.focus-toolbar .focus-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
.focus-toolbar .focus-btn.nav-btn { padding: 8px 12px; font-size: 1.1rem; }
.focus-toolbar .focus-tab-title { font-weight: 600; font-size: 1rem; color: var(--text-main); }
.focus-toolbar .focus-project-title { font-size: 0.85rem; color: var(--text-sec); margin-left: 10px; }

/* Cards projet dashboard */
.project-card, .new-project-card { animation: slideUp 0.3s ease; }
.project-grid .project-card:nth-child(1) { animation-delay: 0.05s; }
.project-grid .project-card:nth-child(2) { animation-delay: 0.1s; }
.project-grid .project-card:nth-child(3) { animation-delay: 0.15s; }
.project-grid .project-card:nth-child(4) { animation-delay: 0.2s; }
.project-grid .project-card:nth-child(5) { animation-delay: 0.25s; }

/* Floating cards univers */
.floating-card { animation: scaleIn 0.3s ease; }

/* Contact cards */
.contact-card { animation: slideUp 0.3s ease; }

/* Messages */
.message-card { animation: slideInRight 0.3s ease; }

/* Favoris */
.favorite-card { animation: scaleIn 0.25s ease; }

/* Sidebar transitions */
.board-sidebar, .expenses-sidebar, .planning-sidebar { transition: transform 0.3s ease, opacity 0.3s ease; }

/* Boutons hover */
button, .tab-btn, .auth-btn { transition: all 0.2s ease; }

/* Inputs focus */
input, select, textarea { transition: border-color 0.2s ease, box-shadow 0.2s ease; }
input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(43, 110, 246, 0.15); }

/* Modal raccourcis clavier */
.shortcuts-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10002; animation: fadeIn 0.2s ease; }
.shortcuts-box { background: var(--panel-bg); border-radius: 12px; padding: 25px; max-width: 400px; width: 90%; animation: scaleIn 0.25s ease; }
.shortcuts-title { margin: 0 0 20px 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
.shortcuts-list { display: flex; flex-direction: column; gap: 12px; }
.shortcut-item { display: flex; justify-content: space-between; align-items: center; }
.shortcut-keys { display: flex; gap: 5px; }
.shortcut-key { background: var(--bg); border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; }
.shortcut-desc { color: var(--text-sec); font-size: 0.9rem; }
.shortcuts-close { margin-top: 20px; width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

  /* Mini calendrier disponibilitÃ©s */
  .availability-calendar { margin-top: 10px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
  .availability-calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .availability-calendar-header button { background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 5px 10px; cursor: pointer; }
  .availability-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
  .availability-calendar-day-header { text-align: center; font-size: 0.7rem; font-weight: bold; color: var(--text-sec); padding: 5px; }
  .availability-calendar-day { text-align: center; padding: 8px 4px; font-size: 0.75rem; border-radius: 4px; cursor: pointer; user-select: none; background: var(--bg); border: 1px solid transparent; }
  .availability-calendar-day:hover { background: var(--primary); color: white; }
  .availability-calendar-day.selected { background: var(--success); color: white; border-color: var(--success); }
  .availability-calendar-day.available { background: #4CAF50; color: white; border-color: #4CAF50; }
  .availability-calendar-day.unavailable { background: #f44336; color: white; border-color: #f44336; }
  .availability-calendar-day.shooting { background: #FF9800; color: white; border-color: #E65100; position: relative; }
  .availability-calendar-day.shooting::before { content: 'ðŸŽ¬'; font-size: 0.5rem; position: absolute; top: 0; right: 1px; }
  .availability-calendar-day.empty { visibility: hidden; }
  .availability-calendar-day.today { border: 2px solid var(--primary); }

  main { -webkit-box-flex: 1; -webkit-flex-grow: 1; flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px; position: relative; padding-right: 50px; min-height: 0; }
 .tab-content { display: none; max-width: 1400px; margin: 0 auto; padding-bottom: 100px; }
  .tab-content.active { display: block; }

  input, textarea, select { padding: 8px; border: 1px solid var(--border); border-radius: 4px; width: 100%; font-family: inherit; background: var(--input-bg); color: var(--text-main); }
  input:focus, textarea:focus, select:focus { outline: 1px solid var(--primary); border-color: var(--primary); }

  /* --- SCRIPT EDITOR STYLES --- */
  .script-view { min-height: 100%; max-width: 1200px; margin: auto; padding-top: 15px; }
  .script-row { display: flex; border-bottom: 1px solid var(--border); padding: 20px 0; gap: 20px; transition: background 0.2s; position:relative; }
  .script-row.dragging { opacity: 0.5; background: var(--bg); }
  .script-info-col { width: 280px; flex-shrink: 0; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.85rem; color: var(--text-sec); height: fit-content; cursor: context-menu; user-select: none; position: relative; border-left: 5px solid transparent; }
  .script-info-col:active { background: var(--highlight); }
  .script-info-col h3 { display:flex; align-items:center; gap:8px; }
  .script-sidebar-btns { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
  .script-sidebar-btns button { padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 0.8rem; text-align: left; transition: all 0.2s; color: var(--text-main); }
  .script-sidebar-btns button:hover { border-color: var(--primary); background: var(--panel-bg); }
  .scene-nav-indicator { margin: 0 10px; color: var(--text-sec); font-size: 0.85rem; font-weight: 600; }
  .script-write-col { flex-grow: 1; display: flex; flex-direction: column; position: relative; min-width: 0; overflow: hidden; }
  .format-bar { margin-bottom: 10px; display: -webkit-box; display: -webkit-flex; display: flex; gap: 5px; background: var(--bg); padding: 5px; border-radius: 4px; position: -webkit-sticky; position: sticky; top: 0; z-index: 10; -webkit-flex-wrap: nowrap; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid var(--border); }
  .format-bar > *:not(:last-child) { margin-right: 5px; } /* gap fallback */
  .fmt-btn { font-family: sans-serif; font-size: 0.75rem; padding: 6px 12px; cursor: pointer; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 3px; transition: all 0.2s; color: var(--text-main); }
  .fmt-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; }
  .script-editor-box { width: 100%; max-width: 650px; min-height: 300px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; padding: 40px 60px; font-family: 'Courier Prime', 'Courier New', Courier, monospace; font-size: 12pt; line-height: 1.0; outline: none; white-space: pre-wrap; overflow-wrap: break-word; word-wrap: break-word; cursor: text; color: var(--text-main); overflow-x: hidden; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  
  /* Format scÃ©nario professionnel US */
  .sc-action { display: block; text-align: left; width: 100%; margin-top: 12pt; margin-bottom: 12pt; }
  .sc-perso { display: block; margin-top: 12pt; margin-bottom: 0; margin-left: 40%; text-transform: uppercase; font-weight: normal; }
  .sc-dial { display: block; margin-top: 0; margin-bottom: 0; margin-left: 15%; margin-right: 15%; }
  .sc-paren { display: block; margin-top: 0; margin-bottom: 0; margin-left: 25%; margin-right: 25%; }
  .sc-trans { display: block; text-align: right; text-transform: uppercase; margin-top: 12pt; margin-bottom: 12pt; margin-left: 55%; font-weight: normal; }
  .sc-note { display: block; margin-top: 12pt; margin-bottom: 12pt; margin-left: 15%; margin-right: 15%; color: var(--text-sec); font-style: italic; background: var(--bg); padding: 5px; border-radius: 4px; }
  .sc-general { display: block; text-align: left; width: 100%; margin-top: 12pt; margin-bottom: 12pt; font-style: italic; color: var(--text-sec); }
  .sc-centered { display: block; text-align: center; width: 100%; margin-top: 12pt; margin-bottom: 12pt; text-transform: uppercase; }

  /* --- VUE SCRIPT CONTINU --- */
  .script-unified-bar { position: sticky; top: 0; z-index: 150; }
  .script-unified-inner { display: flex; align-items: center; max-width: 1200px; margin: 0 auto; }
  .script-unified-left { display: inline-flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: 8px; }
  .script-unified-left .view-btn { padding: 8px 16px; border: none; background: transparent; color: var(--text-sec); cursor: pointer; border-radius: 6px; font-weight: 500; transition: all 0.2s; font-size: 0.85rem; }
  .script-unified-left .view-btn.active { background: var(--primary); color: white; }
  .script-unified-right { display: inline-flex; gap: 5px; margin-left: 175px; }
  .script-unified-right .fmt-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
  .script-unified-right .fmt-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
  .script-unified-right .fmt-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
  .scene-heading-print { display: none; }
  .script-write-col .scene-heading-print { display: block; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; padding-left: 130px; font-family: 'Courier Prime', 'Courier New', Courier, monospace; font-size: 12pt; color: var(--text-sec); }
  .script-continuous-wrapper { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; }
  .script-continuous-sidebar { width: 300px; -webkit-flex-shrink: 0; flex-shrink: 0; position: -webkit-sticky; position: sticky; top: 60px; height: -webkit-fit-content; height: fit-content; max-height: calc(100vh - 80px); max-height: calc(var(--vh, 1vh) * 100 - 80px); overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .script-continuous-sidebar .script-info-col { margin-bottom: 0; cursor: move; }
  .script-continuous-sidebar .script-info-col.dragging { opacity: 0.5; }
  .script-continuous-main { flex: 1; min-width: 0; overflow: visible; position: relative; }
  .script-continuous-editor { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 0 0 4px 4px; padding: 40px 60px; font-family: 'Courier Prime', 'Courier New', Courier, monospace; font-size: 12pt; line-height: 1.0; max-width: 650px; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 80vh; overflow-x: hidden; overflow-wrap: break-word; word-wrap: break-word; }
  .script-continuous-scene { margin-bottom: 0; outline: none; position: relative; padding: 10px 0; border-left: 3px solid transparent; transition: border-color 0.2s, background 0.2s; }
  .script-continuous-scene.active { border-left-color: var(--primary); background: rgba(59, 130, 246, 0.03); }
  .script-continuous-scene.drag-over { border-left-color: var(--success); background: rgba(34, 197, 94, 0.1); }
  .script-continuous-scene .script-continuous-content { outline: none; overflow-wrap: break-word; word-wrap: break-word; }
  .script-continuous-heading { font-weight: bold; text-transform: uppercase; margin-bottom: 12pt; padding-bottom: 6pt; border-bottom: 1px solid var(--border); color: var(--text-main); cursor: grab; display: flex; align-items: center; }
  .script-continuous-heading:hover { color: var(--primary); }
  .script-continuous-heading:active { cursor: grabbing; }
  .script-continuous-heading .scene-title-text { flex: 1; }
  .script-continuous-heading .scene-title-text:hover { text-decoration: underline; cursor: text; }
  .script-continuous-scene-number { color: var(--text-sec); font-size: 0.9em; margin-right: 10px; cursor: grab; }

  /* --- VISUAL WIZARD STYLES --- */
  .wizard-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
  .wizard-header { width: 100%; max-width: 800px; background: var(--panel-bg); padding: 20px; border-radius: 8px 8px 0 0; text-align: center; border-bottom: 2px solid var(--primary); }
  .wizard-instruction { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
  .wizard-sub-text { font-size: 0.9rem; color: var(--text-sec); }
  
  .wizard-page-container { 
      width: 100%; max-width: 800px; height: 70vh; 
      background: white; color: black;
      overflow-y: auto; padding: 40px; 
      font-family: 'Courier Prime', 'Courier New', monospace; font-size: 14px; line-height: 1.2;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      cursor: text;
      user-select: text;
      position: relative;
  }
  
  .wiz-line { 
      white-space: pre-wrap; min-height: 16px; cursor: pointer; padding: 2px 0; border: 1px solid transparent; 
      transition: background 0.1s; position: relative;
  }
  .wiz-line:hover { background: rgba(43, 110, 246, 0.1); border-color: #ddd; }
  .wiz-line.selected-ref { background: rgba(40, 167, 69, 0.3) !important; border: 1px solid var(--success); }
  
  .wizard-footer {
      width: 100%; max-width: 800px; background: var(--panel-bg); padding: 15px;
      border-radius: 0 0 8px 8px; display: flex; justify-content: space-between; align-items: center;
  }
  
  .wiz-detail-box { 
      background: #f9f9f9; padding: 15px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; display:none; 
      color: #333; text-align: left;
  }
  .wiz-detail-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;}
  .wiz-detail-val { font-weight:bold; font-family: monospace; color: var(--primary); }

  #cleanup-toast {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    padding: 10px 20px;
    border-radius: 30px;
    display: none;
    z-index: 10001;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    font-size: 0.9rem;
    font-weight: bold;
    white-space: nowrap;
    animation: fadeIn 0.2s;
  }
  #cleanup-toast:hover { background: var(--danger); }
  @keyframes fadeIn { from { opacity:0; transform:translateX(-50%) translateY(10px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }

  /* --- OTHER STYLES --- */
  .synopsis-section { margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
  
  .board-layout { display: flex; gap: 20px; }
  .board-sidebar { width: 30%; min-width: 250px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; overflow-y: auto; height: fit-content; max-height: 100%; }
  .sidebar-toggles { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
  .sidebar-content-block { margin-bottom: 20px; display: none; }
  .sidebar-content-block.visible { display: block; }
  .board-main { flex-grow: 1; overflow-y: auto; }
  
  .seq-header-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
  .seq-input-group { display: flex; gap: 5px; flex-grow: 1; align-items: center; }
  #inpPre { width: 100px; text-transform: uppercase; font-weight: bold; text-align: center; }
  #inpLoc { flex-grow: 1; text-transform: uppercase; font-weight: bold; }
  #inpSuff { width: 80px; text-transform: uppercase; font-weight: bold; text-align: center; }
  #inpTime { width: 80px; text-align: center; }
  .card { background: var(--panel-bg); border: 1px solid var(--border); border-left: 5px solid transparent; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 2px var(--shadow); position: relative; cursor: grab; transition: border-left-color 0.3s; }
  .card:active { cursor: grabbing; }
  .card h3 { margin: 0 0 5px; font-size: 1rem; color: var(--text-main); display:flex; align-items:center; gap:8px; }
  .card .meta { font-size: 0.8rem; color: var(--text-sec); font-style: italic; margin-bottom: 8px; }
  .card .resume-text { color: var(--text-main); white-space: pre-wrap; }
  .card-actions { position: absolute; top: 10px; right: 10px; }
  .card-actions button { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; cursor: pointer; color: var(--text-main); font-size: 0.9rem; }
  .card-actions button:hover { background: var(--bg); }

  .group-section { margin-bottom: 30px; }
  .group-header { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid var(--border); color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
  .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
  .data-card { background: var(--panel-bg); padding: 15px; border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; gap: 8px; }
  .data-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
  .data-desc { height: 80px; font-size: 0.9rem; resize: none; }
  .group-select { font-size: 0.8rem; padding: 4px; margin-top: 5px; border-radius: 4px; }
  .actor-link-select { font-size: 0.8rem; padding: 4px; border: 1px solid var(--border); border-radius: 4px; margin-top: 5px; width: 100%; background: var(--input-bg); color: var(--text-main); }
  .actor-input-row { display: flex; gap: 5px; }
  .actor-input { font-size: 0.85rem; padding: 5px; flex-grow: 1; }
  .actor-photo-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid var(--border); margin-right: 10px; }
  .actor-card-header { display: flex; align-items: center; }
  /* --- CREW STYLES --- */
.crew-card { background: var(--panel-bg); padding: 20px; border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; gap: 10px; }
.crew-card-header { display: flex; align-items: center; gap: 15px; }
.crew-photo-preview { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid var(--border); }
.crew-info-main { flex: 1; }
.crew-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 3px; }
.crew-role { color: var(--primary); font-size: 0.9rem; }
.crew-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.crew-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.crew-input { font-size: 0.85rem; padding: 8px; }
.crew-vehicle-section { background: var(--bg); padding: 15px; border-radius: 6px; margin-top: 10px; border: 1px solid var(--border); }
.crew-vehicle-toggle { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; }
.crew-vehicle-toggle input { width: 18px; height: 18px; }
.crew-vehicle-details { display: none; margin-top: 15px; }
.crew-vehicle-details.visible { display: block; }
.crew-rate-row { display: flex; gap: 10px; align-items: center; }
.crew-rate-amount { flex: 1; }
.crew-rate-currency { width: 70px; }
.crew-rate-type { width: 120px; }
.crew-availability-section { margin-top: 10px; }
.crew-calendar { margin-top: 10px; }
.crew-calendar input[type="date"] { padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); }

/* --- PLANNING STYLES --- */
.planning-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
  .planning-header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .planning-actions { display: flex; gap: 10px; flex-wrap: wrap; padding: 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; }
  .planning-action-btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: opacity 0.2s; }
  .planning-action-btn:hover { opacity: 0.85; }
  .planning-action-btn.primary { background: var(--primary); color: white; }
  .planning-action-btn.success { background: var(--success); color: white; }
  .planning-action-btn.secondary { background: var(--bg); color: var(--text-main); border: 1px solid var(--border); }
.planning-nav { display: flex; gap: 10px; align-items: center; }
.planning-nav-btn { padding: 8px 15px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: bold; }
.planning-nav-btn:hover { background: var(--bg); }
.planning-title { font-size: 1.5rem; font-weight: bold; min-width: 200px; text-align: center; }
.planning-view-toggle { display: flex; gap: 5px; }

/* Plan de travail */
/* Plan de travail - Style DOOD Pro */
.workplan-wrapper { background: white; color: #333; padding: 20px; border-radius: 8px; overflow-x: auto; }
.workplan-header-box { border: 2px solid #333; padding: 15px; margin-bottom: 20px; display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: center; }
.workplan-header-title { font-size: 1.4rem; font-weight: bold; text-transform: uppercase; }
.workplan-header-subtitle { font-size: 0.9rem; color: #666; }
.workplan-header-info { font-size: 0.85rem; line-height: 1.6; }
.workplan-header-version { text-align: right; font-size: 0.85rem; }
.workplan-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; background: white; }
.workplan-table th, .workplan-table td { border: 1px solid #999; padding: 4px 6px; text-align: center; vertical-align: middle; height: 28px; }
.workplan-table thead th { background: #f0f0f0; font-weight: 600; position: sticky; top: 0; z-index: 10; }
.workplan-table th.workplan-col-num { width: 30px; background: #e0e0e0; }
.workplan-table th.workplan-col-role { width: 120px; text-align: left; background: #e0e0e0; }
.workplan-table th.workplan-col-actor { width: 130px; text-align: left; background: #e0e0e0; }
.workplan-table th.workplan-col-day { min-width: 35px; max-width: 45px; font-size: 0.7rem; }
.workplan-table th.workplan-col-total { width: 40px; background: #e0e0e0; }
.workplan-table td.workplan-cell-num { background: #f5f5f5; font-weight: 600; }
.workplan-table td.workplan-cell-role { text-align: left; font-weight: 500; background: #fafafa; }
.workplan-table td.workplan-cell-actor { text-align: left; font-size: 0.7rem; color: #555; background: #fafafa; }
.workplan-table td.workplan-cell-total { background: #f5f5f5; font-weight: 600; }
.workplan-bar-T { background: #c0392b !important; color: white; font-weight: bold; }
.workplan-bar-SW { background: #c0392b !important; color: white; font-weight: bold; }
.workplan-bar-W { background: #c0392b !important; color: white; font-weight: bold; }
.workplan-bar-WF { background: #c0392b !important; color: white; font-weight: bold; }
.workplan-bar-H { background: #f39c12 !important; color: white; font-weight: bold; }
.workplan-bar-R { background: #3498db !important; color: white; font-weight: bold; }
.workplan-bar-V { background: #9b59b6 !important; color: white; font-weight: bold; }
.workplan-bar-empty { background: white; }
.workplan-section-row td { background: #d5d5d5 !important; font-weight: 600; text-align: left; font-size: 0.8rem; text-transform: uppercase; }
.workplan-footer { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 6px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; }
.workplan-legend { display: flex; gap: 15px; flex-wrap: wrap; }
.workplan-legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #333; }
.workplan-legend-box { width: 24px; height: 18px; border: 1px solid #999; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
.workplan-actions { display: flex; gap: 10px; }
.workplan-actions button { padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
.workplan-actions button:hover { background: #2980b9; }
.workplan-empty { text-align: center; padding: 60px 20px; }
.workplan-empty-icon { font-size: 4rem; margin-bottom: 20px; }
.workplan-cell-menu { background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 120px; overflow: hidden; }
.workplan-menu-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: #333; }
.workplan-menu-item:hover { background: #f0f0f0; }
.workplan-menu-divider { height: 1px; background: #e0e0e0; margin: 5px 0; }
@media print { .workplan-wrapper { padding: 0; } .workplan-actions { display: none; } .workplan-table { font-size: 0.65rem; } .workplan-table th, .workplan-table td { padding: 2px 4px; } }
.workplan-legend { display: flex; gap: 20px; margin-top: 15px; padding: 10px; background: var(--panel-bg); border-radius: 6px; flex-wrap: wrap; }
.workplan-legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; }
.workplan-legend-color { width: 20px; height: 20px; border-radius: 4px; border: 1px solid var(--border); }
.planning-view-btn { padding: 8px 15px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
.planning-view-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

.planning-calendar { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow: visible; margin-bottom: 50px; }
.planning-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--bg); border-bottom: 1px solid var(--border); }
.planning-weekday { padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; color: var(--text-sec); }
.planning-days { display: grid; grid-template-columns: repeat(7, 1fr); }
.planning-day { min-height: 120px; border: 1px solid var(--border); padding: 8px; cursor: pointer; transition: background 0.2s; }
.planning-day:hover { background: var(--bg); }
.planning-day.other-month { background: var(--bg); opacity: 0.5; }
.planning-day.today { background: rgba(43, 110, 246, 0.1); border-color: var(--primary); }
.planning-day.has-shoot { background: rgba(40, 167, 69, 0.1); }
.planning-day-number { font-weight: bold; margin-bottom: 5px; }
.planning-day-shoot { background: var(--success); color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 3px; cursor: pointer; position: relative; }
.planning-day-shoot:hover { opacity: 0.8; }
.planning-day-shoot .month-resize-handle { position: absolute; top: 0; bottom: 0; width: 8px; cursor: ew-resize; background: rgba(255,255,255,0.3); opacity: 0; }
.planning-day-shoot .month-resize-handle.right { right: 0; border-radius: 0 4px 4px 0; }
.planning-day-shoot .month-resize-handle.left { left: 0; border-radius: 4px 0 0 4px; }
.planning-day-shoot:hover .month-resize-handle { opacity: 1; }
  .planning-day-shoot[draggable="true"] { cursor: grab; }
  .planning-day-shoot[draggable="true"]:active { cursor: grabbing; }
  .planning-week-event[draggable="true"] { cursor: grab; }
  .planning-week-event[draggable="true"]:active { cursor: grabbing; }
  .planning-day.drag-over, .planning-week-cell.drag-over { background: rgba(43, 110, 246, 0.2) !important; }
  .context-menu-item:hover { background: var(--bg); }
.planning-day-availability { display: flex; flex-direction: column; gap: 2px; margin-top: 2px; }
.availability-bar { height: 14px; border-radius: 2px; font-size: 9px; color: #000; padding: 0 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 14px; font-weight: 500; display: flex; align-items: center; }

.planning-week-view { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; }
.planning-week-header { display: grid; grid-template-columns: 80px repeat(7, 1fr); background: var(--bg); border-bottom: 1px solid var(--border); }
.planning-week-header-cell { padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; border-right: 1px solid var(--border); }
.planning-week-body { max-height: 600px; overflow-y: auto; }
.planning-week-row { display: grid; grid-template-columns: 80px repeat(7, 1fr); border-bottom: 1px solid var(--border); }
.planning-week-time { padding: 10px; text-align: center; font-size: 0.8rem; color: var(--text-sec); border-right: 1px solid var(--border); background: var(--bg); }
.planning-week-cell { height: 30px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 0; position: relative; box-sizing: border-box; }
  .planning-week-cell:hover { background: rgba(43, 110, 246, 0.1); }
  .planning-week-body { position: relative; overflow: visible; }
  .planning-week-view { position: relative; overflow: visible; }
  .planning-week-events-overlay { position: absolute; top: 0; left: 60px; right: 0; bottom: 0; pointer-events: none; z-index: 5; }
  .planning-week-header { display: flex; border-bottom: 2px solid var(--border); }
  .planning-week-header-cell { flex: 1; padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; box-sizing: border-box; }
  .planning-week-header-cell:first-child { width: 60px; min-width: 60px; max-width: 60px; flex: none; }
  .planning-week-row { display: flex; }
  .planning-week-time { width: 60px; min-width: 60px; max-width: 60px; flex: none; padding: 5px; text-align: center; font-size: 0.8rem; color: var(--text-sec); border-right: 1px solid var(--border); background: var(--bg); box-sizing: border-box; height: 30px; display: flex; align-items: center; justify-content: center; }
  .planning-week-cell { flex: 1; }
  .planning-week-time { width: 60px; min-width: 60px; max-width: 60px; }
  .planning-week-header-cell:first-child { width: 60px; min-width: 60px; max-width: 60px; }
  .planning-week-event-block { position: absolute; background: linear-gradient(135deg, var(--primary), #1e40af); color: white; border-radius: 6px; padding: 5px 8px; cursor: pointer; pointer-events: auto; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: box-shadow 0.2s; z-index: 10; }
  .planning-week-event-block:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
  .planning-week-event-block[draggable="true"] { cursor: grab; }
  .planning-week-event-block[draggable="true"]:active { cursor: grabbing; }
  .event-block-content { display: flex; flex-direction: column; gap: 2px; font-size: 0.75rem; }
  .event-block-content strong { font-size: 0.9rem; }
  .event-resize-handle-top, .event-resize-handle-bottom { position: absolute; left: 0; right: 0; height: 8px; cursor: ns-resize; pointer-events: auto; }
  .event-resize-handle-top { top: 0; }
  .event-resize-handle-bottom { bottom: 0; }
  .event-resize-handle-top:hover, .event-resize-handle-bottom:hover { background: rgba(255,255,255,0.3); }
  .event-resize-handle-right { position: absolute; top: 0; bottom: 0; right: 0; width: 10px; cursor: ew-resize; pointer-events: auto; }
  .event-resize-handle-right:hover { background: rgba(255,255,255,0.3); border-radius: 0 6px 6px 0; }
  .event-resize-handle-left { position: absolute; top: 0; bottom: 0; left: 0; width: 10px; cursor: ew-resize; pointer-events: auto; }
  .event-resize-handle-left:hover { background: rgba(255,255,255,0.3); border-radius: 6px 0 0 6px; }
  .planning-week-event-block.multi-day { background: linear-gradient(135deg, var(--primary), #3b82f6, #1e40af); min-height: 60px; }
.planning-week-event { background: var(--primary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 2px; cursor: pointer; }

.planning-day-view { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; max-height: 70vh; overflow-y: auto; }
.planning-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border); }
.planning-day-title { font-size: 1.3rem; font-weight: bold; }
.planning-day-meta { color: var(--text-sec); font-size: 0.9rem; }

.shoot-day-card { background: var(--bg); border: 2px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.shoot-day-card h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.shoot-section { margin-bottom: 20px; }
.shoot-section-title { font-weight: bold; margin-bottom: 10px; color: var(--primary); font-size: 0.9rem; text-transform: uppercase; }
.shoot-time-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
.shoot-time-item { display: flex; flex-direction: column; gap: 5px; }
.shoot-time-item label { font-size: 0.85rem; color: var(--text-sec); }
.shoot-time-item input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); }

.shoot-scene-list { display: flex; flex-direction: column; gap: 10px; }
.shoot-scene-item { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; padding: 15px; display: flex; gap: 15px; align-items: center; }
.shoot-scene-time { width: 80px; }
.shoot-scene-info { flex: 1; }
.shoot-scene-title { font-weight: bold; margin-bottom: 5px; }
.shoot-scene-meta { font-size: 0.85rem; color: var(--text-sec); }

.callsheet-table { width: 100%; border-collapse: collapse; }
.callsheet-table th, .callsheet-table td { padding: 10px; text-align: left; border: 1px solid var(--border); }
.callsheet-table th { background: var(--bg); font-weight: bold; font-size: 0.85rem; }
.callsheet-table tr:hover { background: var(--bg); }

.weather-widget { background: linear-gradient(135deg, #4a90e2, #357abd); color: white; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; }
.weather-icon { font-size: 2.5rem; }
.weather-info { flex: 1; }
.weather-temp { font-size: 1.5rem; font-weight: bold; }
.weather-desc { font-size: 0.9rem; opacity: 0.9; }
.weather-details { font-size: 0.8rem; opacity: 0.8; }

.planning-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 40px 20px; }
.planning-modal.active { display: flex; }
.planning-modal-content { background: var(--panel-bg); border-radius: 12px; width: 100%; max-width: 900px; }
.planning-modal-header { padding: 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.planning-modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
.planning-modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

.fds-preview { background: white; color: black; padding: 30px; font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; }
.fds-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 15px; }
.fds-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
.fds-subtitle { font-size: 14px; }
.fds-section { margin-bottom: 15px; }
.fds-section-title { font-weight: bold; background: #eee; padding: 5px; margin-bottom: 10px; }
.fds-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
.fds-table th, .fds-table td { border: 1px solid #333; padding: 5px; text-align: left; }
.fds-table th { background: #ddd; }
  
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
  .stat-card { background: var(--panel-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; box-shadow: 0 2px 5px var(--shadow); }
  .stat-number { font-size: 2.5rem; font-weight: bold; color: var(--primary); margin: 10px 0; }
  .stat-label { color: var(--text-sec); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
  .charts-row { display: flex; gap: 20px; flex-wrap: wrap; }
  .chart-box { flex: 1; min-width: 300px; background: var(--panel-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); max-height: 400px; overflow-y: auto; }
  .chart-title { font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .bar-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.9rem; transition: background 0.2s; padding: 4px; border-radius: 4px; }
.bar-row:hover { background: var(--bg); }
  .bar-label { width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: right; padding-right: 10px; }
  .bar-track { flex-grow: 1; background: var(--bg); height: 12px; border-radius: 6px; overflow: hidden; position: relative; }
  .bar-fill { height: 100%; background: var(--primary); border-radius: 6px; transition: width 1s ease-out; }
  .bar-val { width: 40px; padding-left: 10px; font-weight: bold; font-size: 0.8rem; }
  
  /* --- MOOD BOARD STYLES --- */
  .moodboard-container { display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; height: calc(100vh - 200px); height: calc(var(--vh, 1vh) * 100 - 200px); }
  .moodboard-toolbar { display: flex; gap: 10px; padding: 15px; background: var(--card-bg); border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center; }
  .moodboard-toolbar select, .moodboard-toolbar input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); }
  .moodboard-toolbar button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
  .moodboard-toolbar button.primary { background: var(--primary); color: white; }
  .moodboard-toolbar button.primary:hover { opacity: 0.9; }
  .moodboard-toolbar button.secondary { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); }
  .moodboard-toolbar button.secondary:hover { background: var(--border); }
  .moodboard-boards-list { display: flex; gap: 8px; flex-wrap: wrap; padding: 10px 15px; background: var(--bg); border-bottom: 1px solid var(--border); }
  .moodboard-board-tab { padding: 8px 16px; border-radius: 20px; cursor: pointer; background: var(--card-bg); border: 1px solid var(--border); font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
  .moodboard-board-tab:hover { background: var(--border); }
  .moodboard-board-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
  .moodboard-board-tab .tab-close { opacity: 0.5; font-size: 0.8rem; margin-left: 4px; }
  .moodboard-board-tab .tab-close:hover { opacity: 1; }
  .moodboard-canvas-wrapper { flex: 1; overflow: hidden; position: relative; background: #2a2a2a; }
  .moodboard-canvas { position: absolute; top: 0; left: 0; transform-origin: 0 0; cursor: grab; }
  .moodboard-canvas.dragging { cursor: grabbing; }
  .moodboard-canvas.format-free { width: 5000px; height: 5000px; background: #ffffff; box-shadow: 0 0 0 1px #ccc, 0 4px 20px rgba(0,0,0,0.15); }
  .moodboard-canvas.format-a4-landscape { width: 1190px; height: 842px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a4-portrait { width: 842px; height: 1190px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a3-landscape { width: 1684px; height: 1190px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a3-portrait { width: 1190px; height: 1684px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a2-landscape { width: 2384px; height: 1684px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a2-portrait { width: 1684px; height: 2384px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a0-landscape { width: 4768px; height: 3370px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a0-portrait { width: 3370px; height: 4768px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-element { position: absolute; cursor: move; border: 2px solid transparent; border-radius: 8px; transition: border-color 0.2s, box-shadow 0.2s; min-width: 80px; min-height: 80px; }
  .moodboard-element:hover { border-color: var(--primary); }
  .moodboard-element.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
  .moodboard-element .resize-handle { position: absolute; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; opacity: 0; transition: opacity 0.2s; }
  .moodboard-element:hover .resize-handle, .moodboard-element.selected .resize-handle { opacity: 1; }
  .moodboard-element .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
  .moodboard-element .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
  .moodboard-element .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
  .moodboard-element .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
  .moodboard-element .element-actions { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); display: none; gap: 5px; background: var(--card-bg); padding: 5px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10; }
  .moodboard-element.selected .element-actions { display: flex; }
  .moodboard-element .element-actions button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; background: var(--bg); }
  .moodboard-element .element-actions button:hover { background: var(--border); }
  .moodboard-element .element-actions button.danger:hover { background: #ef4444; color: white; }
  .moodboard-element-image { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; pointer-events: none; }
  .moodboard-element-text { width: 100%; height: 100%; padding: 15px; font-size: 1rem; line-height: 1.5; overflow: auto; background: var(--card-bg); border-radius: 6px; }
  .moodboard-element-palette { display: flex; flex-direction: column; padding: 15px; background: white; border-radius: 10px; width: 100%; height: 100%; box-shadow: 0 2px 15px rgba(0,0,0,0.12); }
  .moodboard-element-palette .palette-title { font-size: 0.9rem; font-weight: 600; text-align: center; padding-bottom: 12px; color: #333; border-bottom: 1px solid #eee; margin-bottom: 12px; }
  .moodboard-element-palette .palette-colors { display: flex; flex: 1; gap: 12px; padding: 0 5px; }
  .moodboard-element-palette .color-swatch { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; min-width: 60px; }
  .moodboard-element-palette .color-swatch-box { width: 100%; flex: 1; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.18); min-height: 60px; }
  .moodboard-element-palette .color-swatch span { font-size: 0.6rem; font-weight: 600; color: #555; font-family: 'Courier New', monospace; white-space: nowrap; }
  .moodboard-element-shape { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
  .moodboard-element-shape svg { width: 100%; height: 100%; }
  .moodboard-shape-submenu { position: fixed; background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); z-index: 2001; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 70vh; overflow-y: auto; }
  .moodboard-shape-option { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 1.5rem; }
  .moodboard-shape-option:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); transform: scale(1.1); }
  .moodboard-element .rotate-handle { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); width: 20px; height: 20px; background: var(--primary); border-radius: 50%; cursor: grab; opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; }
  .moodboard-element:hover .rotate-handle, .moodboard-element.selected .rotate-handle { opacity: 1; }
  .moodboard-element .rotate-handle::before { content: 'â†»'; }
  .moodboard-element-link { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; background: var(--card-bg); border-radius: 6px; text-align: center; width: 100%; height: 100%; }
  .moodboard-element-link .link-icon { font-size: 2rem; margin-bottom: 10px; }
  .moodboard-element-link .link-title { font-weight: 500; margin-bottom: 5px; word-break: break-word; }
  .moodboard-element-link .link-url { font-size: 0.75rem; color: var(--text-sec); word-break: break-all; }
  .moodboard-element-file { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; background: var(--card-bg); border-radius: 6px; text-align: center; width: 100%; height: 100%; cursor: pointer; }
  .moodboard-element-file:hover { background: var(--bg); }
  .moodboard-element-file .file-icon { font-size: 2.5rem; margin-bottom: 10px; }
  .moodboard-element-file .file-name { font-weight: 500; margin-bottom: 5px; word-break: break-word; font-size: 0.85rem; }
  .moodboard-element-file .file-size { font-size: 0.7rem; color: var(--text-sec); }
  .element-linked-badge { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .moodboard-element-palette .palette-title { grid-column: 1 / -1; font-size: 0.7rem; font-weight: 500; text-align: center; padding-bottom: 5px; color: var(--text-sec); }
  .moodboard-element-text { width: 100%; height: 100%; padding: 15px; overflow: auto; background: var(--card-bg); border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; }
  .moodboard-zoom-controls { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 5px; background: var(--card-bg); padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100; }
  .moodboard-zoom-controls button { width: 36px; height: 36px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; background: var(--bg); }
  .moodboard-zoom-controls button:hover { background: var(--border); }
  .moodboard-zoom-controls span { padding: 0 10px; line-height: 36px; font-size: 0.9rem; }
  .moodboard-minimap { position: absolute; bottom: 20px; left: 20px; width: 150px; height: 100px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); overflow: hidden; z-index: 100; }
  .moodboard-minimap-content { width: 100%; height: 100%; position: relative; }
  .moodboard-minimap-viewport { position: absolute; border: 2px solid var(--primary); background: rgba(59, 130, 246, 0.1); cursor: move; }
  .moodboard-info-panel { position: absolute; top: 20px; right: 20px; width: 280px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 15px; display: none; z-index: 100; max-height: calc(100% - 40px); overflow-y: auto; }
  .moodboard-info-panel.active { display: block; }
  .moodboard-info-panel h4 { margin: 0 0 15px 0; display: flex; justify-content: space-between; align-items: center; }
  .moodboard-info-panel .info-row { margin-bottom: 10px; }
  .moodboard-info-panel .info-row label { display: block; font-size: 0.8rem; color: var(--text-sec); margin-bottom: 4px; }
  .moodboard-info-panel .info-row input, .moodboard-info-panel .info-row select, .moodboard-info-panel .info-row textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 0.9rem; }
  .moodboard-info-panel .info-row textarea { min-height: 60px; resize: vertical; }
  .moodboard-main-container { display: flex; flex: 1; overflow: hidden; }
  .moodboard-elements-sidebar { width: 220px; background: var(--card-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
  .moodboard-sidebar-header { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.9rem; }
  .moodboard-elements-count { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
  .moodboard-elements-list { flex: 1; overflow-y: auto; padding: 10px; }
  .moodboard-element-item { padding: 10px 12px; border-radius: 8px; margin-bottom: 6px; cursor: pointer; background: var(--bg); border: 1px solid var(--border); transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
  .moodboard-element-item:hover { border-color: var(--primary); background: var(--panel-bg); }
  .moodboard-element-item.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
  .moodboard-element-item .el-icon { font-size: 1.2rem; flex-shrink: 0; }
  .moodboard-element-item .el-info { flex: 1; overflow: hidden; }
  .moodboard-element-item .el-type { font-size: 0.75rem; color: var(--text-sec); text-transform: uppercase; }
  .moodboard-element-item .el-name { font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .moodboard-element-item .el-linked { font-size: 0.7rem; color: var(--primary); margin-top: 2px; }
  .moodboard-element-item .el-actions { display: none; gap: 4px; flex-shrink: 0; }
  .moodboard-element-item:hover .el-actions { display: flex; }
  .moodboard-element-item .el-actions button { width: 26px; height: 26px; border: none; border-radius: 4px; cursor: pointer; background: var(--bg); font-size: 0.75rem; transition: background 0.2s; }
  .moodboard-element-item .el-actions button:hover { background: var(--border); }
  .moodboard-empty { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sec); text-align: center; padding: 40px; background: #2a2a2a; z-index: 50; }

  /* Menu radial MoodBoard */
  .moodboard-radial-menu { position: fixed; z-index: 1000; pointer-events: none; }
  .moodboard-radial-menu.active { pointer-events: auto; }
  .moodboard-radial-center { position: absolute; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transform: translate(-50%, -50%); box-shadow: 0 4px 20px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s, background 0.2s; }
  .moodboard-radial-center:hover { transform: translate(-50%, -50%) scale(1.1); background: #2563eb; }
  .moodboard-radial-item { position: absolute; width: 50px; height: 50px; border-radius: 50%; background: var(--card-bg); color: var(--text); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; transform: translate(-50%, -50%) scale(0); box-shadow: 0 2px 15px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); border: 2px solid var(--border); }
  .moodboard-radial-menu.active .moodboard-radial-item { transform: translate(-50%, -50%) scale(1); }
  .moodboard-radial-item:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translate(-50%, -50%) scale(1.15) !important; }
  .moodboard-radial-item .radial-tooltip { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
  .moodboard-radial-item:hover .radial-tooltip { opacity: 1; }
  .moodboard-radial-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999; }

  /* Sous-menu palette couleurs */
  .moodboard-palette-submenu { position: absolute; background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); min-width: 280px; z-index: 1001; }
  .color-wheel-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; }
  .color-wheel-container { background: #ffffff; border-radius: 16px; padding: 25px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid #ddd; color: #333; }
  [data-theme="dark"] .color-wheel-container { background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1); color: #fff; }
  .color-wheel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .color-wheel-header h3 { margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
  .color-wheel-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); padding: 5px; }
  .color-wheel-close:hover { color: var(--text); }
  .color-wheel-body { display: flex; gap: 25px; flex-wrap: wrap; }
  .color-wheel-left { flex: 1; min-width: 280px; display: flex; flex-direction: column; align-items: center; }
  .color-wheel-right { flex: 1; min-width: 200px; }
  .color-wheel-canvas-wrap { position: relative; width: 280px; height: 280px; }
  #colorWheelCanvas { border-radius: 50%; cursor: crosshair; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
  .color-wheel-marker { position: absolute; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 0 0 2px rgba(0,0,0,0.2); }
  .color-wheel-marker.main { width: 26px; height: 26px; border-width: 4px; z-index: 10; }
  .color-wheel-marker.draggable { pointer-events: auto; cursor: grab; }
  .color-wheel-marker.draggable:active { cursor: grabbing; }
  .harmony-selector { margin-top: 20px; width: 100%; }
  .harmony-selector label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-sec); font-size: 0.9rem; }
  .harmony-selector select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 0.95rem; cursor: pointer; }
  .harmony-selector select:focus { outline: none; border-color: var(--primary); }
  .generated-colors { display: flex; flex-direction: column; gap: 8px; }
  .generated-color-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
  .generated-color-item:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .generated-color-swatch { width: 50px; height: 50px; border-radius: 8px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
  .generated-color-info { flex: 1; }
  .generated-color-hex { font-family: 'Courier New', monospace; font-weight: 600; font-size: 1rem; }
  .generated-color-rgb { font-size: 0.8rem; color: var(--text-sec); margin-top: 2px; }
  .color-wheel-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid var(--border); }
  .color-wheel-actions button { padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
  .color-wheel-actions .cancel { background: var(--bg); border: 1px solid var(--border); color: var(--text); }
  .color-wheel-actions .cancel:hover { background: var(--border); }
  .color-wheel-actions .confirm { background: var(--primary); border: none; color: white; }
  .color-wheel-actions .confirm:hover { opacity: 0.9; }
  .brightness-slider { margin-top: 15px; width: 100%; }
  .brightness-slider label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--text-sec); }
  .brightness-slider input[type="range"] { width: 100%; cursor: pointer; }
  .moodboard-palette-submenu h4 { margin: 0 0 12px 0; font-size: 0.9rem; color: var(--text-sec); }
  .moodboard-palette-option { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; margin-bottom: 8px; }
  .moodboard-palette-option:hover { background: var(--bg); }
  .moodboard-palette-option:last-child { margin-bottom: 0; }
  .moodboard-palette-preview { display: flex; gap: 3px; }
  .moodboard-palette-preview span { width: 24px; height: 24px; border-radius: 4px; }
  .moodboard-palette-option .palette-name { font-weight: 500; font-size: 0.85rem; }
  .moodboard-palette-option .palette-desc { font-size: 0.75rem; color: var(--text-sec); }

  /* Panneau texte MoodBoard */
  .moodboard-text-panel { position: absolute; background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); min-width: 300px; z-index: 1001; }
  .moodboard-text-panel h4 { margin: 0 0 12px 0; font-size: 0.9rem; }
  .moodboard-text-panel textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); resize: none; margin-bottom: 12px; font-family: inherit; }
  .moodboard-text-panel .text-options { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
  .moodboard-text-panel .text-options select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); flex: 1; min-width: 100px; }
  .moodboard-text-panel .text-actions { display: flex; gap: 8px; justify-content: flex-end; }
  .moodboard-text-panel .text-actions button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
  .moodboard-text-panel .text-actions .btn-cancel { background: var(--bg); color: var(--text); }
  .moodboard-text-panel .text-actions .btn-add { background: var(--primary); color: white; }
  .moodboard-empty-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
  .moodboard-empty h3 { margin: 0 0 10px 0; color: var(--text); }
  .moodboard-empty p { margin: 0 0 20px 0; max-width: 400px; }

  /* --- STORYBOARD STYLES --- */
.storyboard-layout { display: flex; gap: 20px; min-height: 100%; }
.storyboard-scenes { width: 30%; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow-y: auto; }
.storyboard-shots { flex: 1; overflow-y: auto; padding: 20px; }
.sb-scene-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
.sb-scene-item:hover { background: var(--bg); }
.sb-scene-item.active { background: var(--primary); color: white; font-weight: bold; }
.sb-scene-title { font-weight: bold; margin-bottom: 5px; }
.sb-scene-meta { font-size: 0.8rem; opacity: 0.7; }

.shot-card { background: var(--panel-bg); border: 2px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px var(--shadow); }
.shot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.shot-preview { width: 100%; height: 300px; background: #f0f0f0; border: 2px dashed var(--border); border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; position: relative; }
.shot-preview img, .shot-preview canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
.shot-upload-zone { text-align: center; color: var(--text-sec); }
.shot-meta-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
.shot-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); }
.shot-textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); resize: vertical; min-height: 60px; margin-top: 10px; }

/* --- SHOT COMPACT MODE --- */
.shots-compact-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
.shot-compact-card { background: var(--panel-bg); border: 2px solid var(--border); border-radius: 8px; overflow: hidden; cursor: grab; transition: all 0.2s; position: relative; }
.shot-compact-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px var(--shadow); border-color: var(--primary); }
.shot-compact-card.dragging { opacity: 0.5; cursor: grabbing; }
.shot-compact-image { width: 100%; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; }
.shot-compact-image img, .shot-compact-image canvas { width: 100%; height: 100%; object-fit: contain; }
.shot-compact-footer { padding: 10px; background: var(--bg); text-align: center; font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
.shot-compact-delete { background: none; border: none; color: var(--text-sec); cursor: pointer; font-size: 1.1rem; padding: 0; }
.shot-compact-delete:hover { color: var(--danger); }
.shot-compact-name { padding: 5px 10px; font-size: 0.85rem; color: var(--text-main); text-align: center; font-weight: 600; border-top: 1px solid var(--border); }
.shot-compact-tech { padding: 5px 10px; font-size: 0.75rem; color: var(--text-sec); text-align: center; background: var(--bg); }

/* Commentaires */
.comments-panel { position: fixed; top: 0; right: -400px; width: 400px; height: 100%; background: var(--panel-bg); border-left: 1px solid var(--border); z-index: 10000; transition: right 0.3s ease; display: flex; flex-direction: column; box-shadow: -4px 0 20px rgba(0,0,0,0.2); }
.storyboard-preview-panel { position: fixed; top: 0; right: -600px; width: 600px; height: 100%; background: var(--panel-bg); border-left: 1px solid var(--border); z-index: 10000; transition: right 0.3s ease; display: flex; flex-direction: column; box-shadow: -4px 0 20px rgba(0,0,0,0.2); }
.storyboard-preview-panel.open { right: 0; }
.storyboard-preview-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
.storyboard-preview-header h3 { margin: 0; font-size: 1.1rem; }
.storyboard-preview-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main); }
.storyboard-preview-body { flex: 1; overflow-y: auto; padding: 15px; }
.storyboard-preview-body .sb-print-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
.storyboard-preview-body .sb-print-shot { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
.storyboard-preview-body .sb-print-shot:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.storyboard-preview-empty { text-align: center; padding: 40px; color: var(--text-muted); }
.comments-panel.open { right: 0; }
.comments-header { padding: 15px 20px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.comments-header h3 { margin: 0; font-size: 1.1rem; }
.comments-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); }
.comments-body { flex: 1; overflow-y: auto; padding: 15px; }
.comments-footer { padding: 15px; border-top: 1px solid var(--border); background: var(--bg); }
.comment-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; resize: none; font-family: inherit; background: var(--input-bg); color: var(--text-main); }
.comment-submit { width: 100%; margin-top: 10px; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
.comment-item { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); }
.comment-item.resolved { opacity: 0.6; border-left: 3px solid var(--success); }
.comment-author { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.comment-author-name { font-weight: 600; color: var(--primary); }
.comment-date { font-size: 0.75rem; color: var(--text-sec); }
.comment-text { font-size: 0.9rem; line-height: 1.4; color: var(--text-main); white-space: pre-wrap; }
.comment-actions { margin-top: 10px; display: flex; gap: 10px; }
.comment-action-btn { background: none; border: none; font-size: 0.8rem; color: var(--text-sec); cursor: pointer; padding: 2px 5px; }
.comment-action-btn:hover { color: var(--primary); }
.comment-replies { margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--border); }
.comment-reply-input { display: none; margin-top: 10px; }
.comment-reply-input.active { display: block; }
.comment-badge { display: inline-flex; align-items: center; justify-content: center; background: var(--primary); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; cursor: pointer; }
.comment-badge.resolved { background: var(--success); }
.comment-badge:hover { transform: scale(1.1); }
.no-comments { text-align: center; color: var(--text-sec); padding: 30px; font-style: italic; }
.shot-dirty-indicator { position: absolute; top: 5px; right: 5px; background: var(--locked); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }

/* --- SHOT EDIT MODAL --- */
.shot-edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10003; justify-content: center; align-items: center; overflow-y: auto; }
.shot-edit-modal.active { display: flex; }
.shot-edit-container { background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; margin: 20px; }
.shot-edit-header { padding: 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--panel-bg); z-index: 10; }
.shot-edit-content { padding: 30px; }
.shot-edit-save-btn { padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: none; }
.shot-edit-save-btn.visible { display: inline-block; }
.shot-edit-close-btn { padding: 10px 20px; background: var(--border); color: var(--text-main); border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

/* --- STORYBOARD PRINT VIEW --- */
.sb-view-toggle { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
.sb-toggle-btn { padding: 10px 20px; background: var(--panel-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
.sb-toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
.sb-toggle-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow); }

.sb-print-config { position: relative; }
.sb-config-btn { padding: 10px 20px; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: bold; }
.sb-config-panel { display: none; position: absolute; top: 100%; right: 0; margin-top: 10px; background: var(--panel-bg); border: 2px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: 0 4px 15px var(--shadow); z-index: 100; min-width: 250px; }
.sb-config-panel.open { display: block; }
.sb-config-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.sb-config-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.sb-config-item label { cursor: pointer; user-select: none; }

.sb-print-preview { display: none; }
.sb-print-preview.active { display: block; }
.sb-print-page { background: white; width: 100%; max-width: 210mm; margin: 0 auto 30px; padding: 20mm; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #ddd; page-break-after: always; }
.sb-print-page h2 { margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 3px solid #333; font-size: 1.5rem; color: #333; }
.sb-print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.sb-print-shot { background: white; border: 2px solid #333; border-radius: 8px; overflow: hidden; page-break-inside: avoid; }
.sb-print-shot-image { width: 100%; height: 200px; background: #f5f5f5; border-bottom: 2px solid #333; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.sb-print-shot-image img, .sb-print-shot-image canvas { width: 100%; height: 100%; object-fit: contain; }
.sb-print-shot-info { padding: 10px; font-size: 0.85rem; line-height: 1.4; color: #333; }
.sb-print-shot-header { font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
.sb-print-shot-meta { margin-bottom: 3px; color: #555; }
.sb-print-shot-desc { margin-top: 5px; border-top: 1px solid #ddd; padding-top: 5px; }

.sb-fullscreen-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10002; overflow-y: auto; }
.sb-fullscreen-modal.active { display: block; }
.sb-fullscreen-header { position: sticky; top: 0; background: var(--panel-bg); padding: 15px 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
.sb-fullscreen-content { padding: 40px 20px; }

@media print {
  .sb-print-page { box-shadow: none; border: none; margin: 0; padding: 20mm; page-break-after: always; }
  .sb-fullscreen-header, .sb-view-toggle, .sb-toggle-btn, .sb-config-btn, .storyboard-scenes { display: none !important; }
  body { background: white; }
}
/* --- DRAWING EDITOR --- */
.drawing-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99998; justify-content: center; align-items: center; }
.drawing-container { background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column; }
.drawing-header { padding: 15px 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.drawing-toolbar { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 15px; flex-wrap: wrap; background: var(--bg); }
.drawing-workspace { flex: 1; display: flex; overflow: hidden; }
.drawing-sidebar { width: 200px; background: var(--bg); border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; }
.drawing-canvas-area { flex: 1; display: flex; justify-content: center; align-items: center; background: #2a2a2a; position: relative; overflow: auto; }
.drawing-canvas { background: white; cursor: crosshair; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

.tool-group { margin-bottom: 20px; }
.tool-label { font-size: 0.75rem; font-weight: bold; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase; }
.color-palette { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
.color-swatch { width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
.color-swatch.active { border-color: var(--primary); transform: scale(1.1); box-shadow: 0 0 0 2px white; }
.brush-btn { padding: 8px 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; margin-bottom: 5px; text-align: center; font-size: 0.85rem; transition: all 0.2s; }
.brush-btn:hover { background: var(--bg); }
.brush-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
.opacity-slider { width: 100%; margin: 10px 0; }
.layer-item { padding: 8px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.layer-item.active { background: var(--primary); color: white; }
.layer-visibility { cursor: pointer; font-size: 1.2rem; }
  
  .breakdown-layout { display: flex; gap: 20px; min-height: 100%; }
  .breakdown-col { width: 50%; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; max-height: 80vh; overflow-y: auto; }
  .bd-header { padding: 10px; background: var(--bg); border-bottom: 1px solid var(--border); font-weight: bold; text-align: center; flex-shrink: 0; color: var(--text-main); }
  .bd-content { overflow-y: auto; padding: 0; flex-grow: 1; position: relative; }
  .bd-scene-card { border-bottom: 1px solid var(--border); }
  .bd-scene-header { padding: 12px; cursor: pointer; background: var(--panel-bg); display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; color: var(--text-main); }
  .bd-scene-header:hover { background: var(--bg); }
  .bd-scene-header.active { background: var(--bg); border-left: 4px solid var(--primary); }
  .bd-scene-details { display: none; padding: 15px; background: var(--bg); border-top: 1px solid var(--border); }
  .bd-scene-details.open { display: block; }
  .bd-cat-group { margin-bottom: 12px; }
  .bd-cat-name { font-size: 0.75rem; text-transform: uppercase; color: var(--text-sec); font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid var(--border); }
  .bd-tags-container { display: flex; flex-wrap: wrap; gap: 5px; }
  .bd-tag { display: inline-flex; align-items: center; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; padding: 2px 8px; font-size: 0.85rem; color: var(--text-main); }
  .bd-script-text { font-family: 'Courier Prime', 'Courier New', Courier, monospace; font-size: 12pt; line-height: 1.0; padding: 40px 60px; color: var(--text-main); max-width: 650px; margin: 0 auto; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; white-space: pre-wrap; overflow-wrap: break-word; }
  .bd-marked { color: var(--text-sec) !important; text-decoration: line-through !important; background-color: var(--bg) !important; border-radius: 2px; cursor: pointer; transition: all 0.2s ease; }
  .bd-marked.bd-highlight { background-color: #ffd700 !important; color: #333 !important; text-decoration: none !important; box-shadow: 0 0 8px rgba(255, 215, 0, 0.6); }
  .bd-tag { transition: all 0.2s ease; cursor: pointer; }
  .bd-tag.bd-highlight { background-color: #ffd700 !important; color: #333 !important; box-shadow: 0 0 8px rgba(255, 215, 0, 0.6); transform: scale(1.05); }
  #bd-link-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
  #bd-link-svg path { fill: none; stroke: #ffd700; stroke-width: 2; stroke-dasharray: 5,3; }
  .breakdown-layout { position: relative; }

  .lock-overlay { display: none; position: absolute; top: -10px; right: 10px; background: var(--locked); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .script-row.is-locked .lock-overlay { display: block; }
  .script-row.is-locked .script-write-col { opacity: 0.7; pointer-events: none; }
  .script-row.is-locked .script-editor-box { border: 2px solid var(--locked); background: rgba(255, 152, 0, 0.05); }

  #script-ac-list, #breakdown-ctx-menu, #tag-ctx-menu { position: fixed; background: var(--panel-bg); border: 1px solid var(--border); box-shadow: 0 4px 15px var(--shadow); z-index: 9999; max-height: 300px; overflow-y: auto; width: 220px; display: none; border-radius: 4px; }
  #script-ac-list div, #breakdown-ctx-menu div, #tag-ctx-menu div { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
  #script-ac-list div:hover, #breakdown-ctx-menu div:hover, #tag-ctx-menu div:hover { background: var(--bg); color: var(--primary); }
  .tag-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }
  .tag-badge { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; border: 1px solid rgba(0,0,0,0.2); cursor: help; }
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; height: calc(var(--vh, 1vh) * 100); background: rgba(0,0,0,0.5); z-index: 10000; -webkit-justify-content: center; justify-content: center; -webkit-align-items: center; align-items: center; }
  
  /* Modal Conditions d'utilisation */
  .terms-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100002; display: flex; justify-content: center; align-items: center; padding: 20px; }
  .terms-modal { background: var(--panel-bg); border-radius: 16px; max-width: 600px; width: 100%; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 25px 80px rgba(0,0,0,0.5); border: 1px solid var(--border); animation: modalSlideIn 0.3s ease; }
  @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  .terms-modal-header { padding: 24px 24px 16px; border-bottom: 1px solid var(--border); }
  .terms-modal-header h2 { margin: 0; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
  .terms-modal-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
  .terms-modal-body h3 { font-size: 1.1rem; margin: 20px 0 10px; color: var(--accent); }
  .terms-modal-body h3:first-child { margin-top: 0; }
  .terms-modal-body p, .terms-modal-body ul { font-size: 0.95rem; line-height: 1.6; color: var(--text-sec); margin: 0 0 12px; }
  .terms-modal-body ul { padding-left: 20px; }
  .terms-modal-body li { margin-bottom: 6px; }
  .terms-modal-footer { padding: 16px 24px 24px; border-top: 1px solid var(--border); }
  .terms-checkbox-row { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px; cursor: pointer; }
  .terms-checkbox-row input[type="checkbox"] { width: 20px; height: 20px; margin-top: 2px; cursor: pointer; accent-color: var(--accent); }
  .terms-checkbox-row label { font-size: 0.95rem; color: var(--text-main); cursor: pointer; line-height: 1.4; }
  .terms-buttons { display: flex; gap: 12px; justify-content: flex-end; }
  .terms-btn { padding: 12px 24px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .terms-btn-refuse { background: transparent; border: 1px solid var(--border); color: var(--text-sec); }
  .terms-btn-refuse:hover { background: var(--danger); color: white; border-color: var(--danger); }
  .terms-btn-accept { background: #3b82f6; border: none; color: white; opacity: 0.5; pointer-events: none; }
  .terms-btn-accept.enabled { opacity: 1; pointer-events: auto; }
  .terms-btn-accept.enabled:hover { background: #2563eb; }

  /* ==================== LANDING PAGE ==================== */
  #landing-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); z-index: 9998; overflow-y: auto; display: flex; flex-direction: column; }
  .landing-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; position: sticky; top: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .landing-logo { display: flex; align-items: center; gap: 12px; font-size: 1.5rem; font-weight: 700; color: white; }
  .landing-logo img { height: 40px; }
  .landing-nav { display: flex; gap: 20px; align-items: center; }
  .landing-nav a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.95rem; transition: color 0.2s; }
  .landing-nav a:hover { color: white; }
  .landing-btn { padding: 10px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 0.95rem; }
  .landing-btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; }
  .landing-btn-outline:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.5); }
  .landing-btn-primary { background: #3b82f6; color: white; }
  .landing-btn-primary:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(59,130,246,0.3); }
  
  .landing-hero { padding: 80px 40px 60px; text-align: center; max-width: 900px; margin: 0 auto; }
  .landing-hero h1 { font-size: 3.5rem; font-weight: 800; color: white; margin: 0 0 20px; line-height: 1.1; }
  .landing-hero h1 span { background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .landing-hero p { font-size: 1.25rem; color: rgba(255,255,255,0.7); margin: 0 0 40px; line-height: 1.6; }
  .landing-hero-btns { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
  .landing-hero-btns .landing-btn { padding: 14px 32px; font-size: 1.1rem; }
  
  .landing-keywords { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
  .landing-keyword { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; color: rgba(255,255,255,0.8); }
  
  .landing-features { padding: 80px 40px; background: rgba(255,255,255,0.02); }
  .landing-features h2 { text-align: center; font-size: 2.2rem; color: white; margin: 0 0 50px; }
  .landing-features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; }
  .landing-feature-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; transition: all 0.3s; }
  .landing-feature-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-5px); border-color: rgba(59,130,246,0.5); }
  .landing-feature-icon { font-size: 2.5rem; margin-bottom: 15px; }
  .landing-feature-card h3 { color: white; font-size: 1.3rem; margin: 0 0 10px; }
  .landing-feature-card p { color: rgba(255,255,255,0.6); font-size: 0.95rem; line-height: 1.6; margin: 0; }
  
  .landing-screenshots { padding: 80px 40px; }
  .landing-screenshots h2 { text-align: center; font-size: 2.2rem; color: white; margin: 0 0 50px; }
  .landing-screenshots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; max-width: 1400px; margin: 0 auto; }
  .landing-screenshot { border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; cursor: pointer; }
  .landing-screenshot:hover { transform: scale(1.02); border-color: rgba(59,130,246,0.5); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
  .landing-screenshot img { width: 100%; display: block; }
  .landing-screenshot-label { background: rgba(0,0,0,0.8); padding: 12px 16px; color: white; font-size: 0.9rem; font-weight: 500; }
  
  .landing-cta { padding: 80px 40px; text-align: center; background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2)); }
  .landing-cta h2 { font-size: 2.5rem; color: white; margin: 0 0 20px; }
  .landing-cta p { font-size: 1.1rem; color: rgba(255,255,255,0.7); margin: 0 0 30px; }
  
  .landing-footer { padding: 40px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
  .landing-footer p { color: rgba(255,255,255,0.5); font-size: 0.85rem; margin: 0; }
  .landing-footer a { color: rgba(255,255,255,0.7); text-decoration: none; }
  .landing-footer a:hover { color: white; }
  
  @media (max-width: 768px) {
    .landing-header { padding: 15px 20px; }
    .landing-nav { display: none; }
    .landing-hero { padding: 50px 20px 40px; }
    .landing-hero h1 { font-size: 2.2rem; }
    .landing-hero p { font-size: 1rem; }
    .landing-features, .landing-screenshots, .landing-cta { padding: 50px 20px; }
    .landing-features h2, .landing-screenshots h2, .landing-cta h2 { font-size: 1.7rem; }
    .landing-screenshots-grid { grid-template-columns: 1fr; }
  }
  .modal-content { background: var(--panel-bg); border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--border); overflow: hidden; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg); border-bottom: 1px solid var(--border); }
  .modal-header h2 { margin: 0; font-size: 1.2rem; color: var(--text-main); }
  .modal-close { background: var(--border); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-main); transition: background 0.2s; }
  .modal-close:hover { background: var(--danger); color: white; }
  .modal-box { background: var(--panel-bg); padding: 20px; border-radius: 8px; width: 350px; max-width: 90%; box-shadow: 0 4px 15px var(--shadow); border: 1px solid var(--border); color: var(--text-main); }
  .checklist { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .checklist label { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: background 0.2s; }
  .checklist label:hover { background: var(--bg); }
  .checklist input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: var(--primary); flex-shrink: 0; }
  .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
  .autocomplete-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
  .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; border: 1px solid var(--border); z-index: 99; background: var(--panel-bg); max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px var(--shadow); }
  .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); color: var(--text-main); }
  .autocomplete-item:hover, .autocomplete-active { background: var(--bg); }
  .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .autocomplete-dropdown-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); }
  .autocomplete-dropdown-item:last-child { border-bottom: none; }
  .autocomplete-dropdown-item:hover { background: var(--bg); }
  .autocomplete-dropdown-item img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
  .autocomplete-dropdown-item .ac-icon { width: 32px; height: 32px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 1rem; }
  .autocomplete-dropdown-item .ac-info { flex: 1; }
  .autocomplete-dropdown-item .ac-name { font-weight: 600; color: var(--text-main); }
  .autocomplete-dropdown-item .ac-detail { font-size: 0.75rem; color: var(--text-sec); }
  .autocomplete-dropdown-item .ac-source { font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; background: var(--primary); color: white; }
  
  
  /* Kanban */
  .kanban-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
  .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-color: var(--primary); }
  .kanban-card-title { font-weight: 600; margin-bottom: 6px; color: var(--text-main); }
  .kanban-card-info { font-size: 0.8rem; color: var(--text-sec); display: flex; gap: 8px; flex-wrap: wrap; }
  .kanban-card-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--bg); }
  .kanban-card-tag.int { background: #fef3c7; color: #92400e; }
  .kanban-card-tag.ext { background: #dbeafe; color: #1e40af; }
  .kanban-card-tag.jour { background: #fef9c3; color: #854d0e; }
  .kanban-card-tag.nuit { background: #1e1b4b; color: #c7d2fe; }
  .kanban-card-date { font-size: 0.75rem; color: var(--primary); margin-top: 6px; }
  
  /* Mode Compact SÃ©quencier */
  #boardList.compact-mode { display: flex; flex-direction: column; gap: 2px; }
  
  /* ========== BEAT BOARD ========== */
  .beatboard-container { position: relative; width: 100%; height: calc(100vh - 200px); height: calc(var(--vh, 1vh) * 100 - 200px); min-height: 500px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .beatboard-canvas { position: absolute; top: 0; left: 0; width: 3000px; height: 2000px; background-image: radial-gradient(circle, var(--border) 1px, transparent 1px); background-size: 30px 30px; cursor: grab; transform-origin: 0 0; }
  .beatboard-canvas.dragging { cursor: grabbing; }
  .beatboard-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
  .beatboard-line { stroke: #e74c3c; stroke-width: 3; fill: none; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
  .beatboard-line-bg { stroke: rgba(231, 76, 60, 0.2); stroke-width: 12; fill: none; stroke-linecap: round; }
  .beatboard-tag-line { stroke-width: 2.5; fill: none; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 1px 3px rgba(0,0,0,0.15)); }
  .beatboard-tag-line-bg { stroke-width: 10; fill: none; stroke-linecap: round; opacity: 0.15; }
  .beatboard-tag-line-dot { filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
  .beatboard-tag-line-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
  .beatboard-tag-line-item:hover { background: var(--input-bg); }
  .beatboard-tag-line-swatch { width: 24px; height: 4px; border-radius: 2px; flex-shrink: 0; }
  .beatboard-tag-line-count { color: var(--text-sec); font-size: 0.75rem; margin-left: auto; }
  .beatboard-card { position: absolute; width: 180px; min-height: 100px; background: var(--panel-bg); border: 2px solid var(--border); border-radius: 10px; padding: 12px; cursor: move; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: box-shadow 0.2s, transform 0.1s; user-select: none; }
  .beatboard-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.2); transform: scale(1.02); z-index: 100; }
  .beatboard-card.dragging { opacity: 0.8; transform: scale(1.05) rotate(2deg); z-index: 1000; box-shadow: 0 12px 32px rgba(0,0,0,0.3); }
  .beatboard-card-number { position: absolute; top: -10px; left: -10px; width: 28px; height: 28px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; border: 2px solid var(--panel-bg); }
  .beatboard-card-tag { position: absolute; top: 0; left: 0; right: 0; height: 6px; border-radius: 8px 8px 0 0; }
  .beatboard-card-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; margin-top: 4px; line-height: 1.3; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .beatboard-card-meta { font-size: 0.7rem; color: var(--text-sec); margin-bottom: 6px; }
  .beatboard-card-resume { font-size: 0.75rem; color: var(--text-main); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  .beatboard-card-status { position: absolute; bottom: 8px; right: 8px; font-size: 0.7rem; }
  .beatboard-card-connector { position: absolute; width: 14px; height: 14px; background: #e74c3c; border: 2px solid var(--panel-bg); border-radius: 50%; z-index: 20; }
  .beatboard-card-connector.in { top: 50%; left: -9px; transform: translateY(-50%); }
  .beatboard-card-connector.out { top: 50%; right: -9px; transform: translateY(-50%); }
  .beatboard-toolbar { position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; z-index: 1000; flex-wrap: wrap; }
  .beatboard-toolbar button { padding: 8px 14px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
  .beatboard-toolbar button:hover { background: var(--primary); color: white; border-color: var(--primary); }
  .beatboard-toolbar button.active { background: var(--primary); color: white; border-color: var(--primary); }
  .beatboard-zoom { position: absolute; bottom: 10px; right: 10px; display: flex; gap: 5px; z-index: 1000; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 5px; }
  .beatboard-zoom button { width: 32px; height: 32px; border: none; background: transparent; cursor: pointer; border-radius: 4px; font-size: 1.1rem; }
  .beatboard-zoom button:hover { background: var(--bg); }
  .beatboard-zoom span { padding: 0 10px; display: flex; align-items: center; font-size: 0.85rem; color: var(--text-sec); }
  .beatboard-minimap { position: absolute; bottom: 10px; left: 10px; width: 150px; height: 100px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; z-index: 1000; }
  .beatboard-minimap-viewport { position: absolute; border: 2px solid var(--primary); background: rgba(43, 110, 246, 0.1); pointer-events: none; }
  .beatboard-groups { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 1000; }
  .beatboard-group-label { padding: 6px 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; }
  .beatboard-group-dot { width: 10px; height: 10px; border-radius: 50%; }
  .beatboard-card.selected { outline: 3px solid var(--primary); outline-offset: 2px; }
  .beatboard-card.out-of-timeline { opacity: 0.7; border-style: dashed; }
  .beatboard-card.out-of-timeline .beatboard-card-number { display: none; }
  .beatboard-card.out-of-timeline .beatboard-card-connector { background: #999; }
  .beatboard-out-timeline-zone { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); min-width: 300px; min-height: 120px; background: rgba(150, 150, 150, 0.1); border: 2px dashed var(--text-sec); border-radius: 12px; padding: 15px; z-index: 5; }
  .beatboard-out-timeline-label { position: absolute; top: -12px; left: 20px; background: var(--panel-bg); padding: 2px 10px; font-size: 0.75rem; color: var(--text-sec); border-radius: 4px; }
  #boardList.compact-mode .card { padding: 8px 12px; margin: 0; border-radius: 4px; display: flex; align-items: center; gap: 15px; }
  #boardList.compact-mode .card h3 { margin: 0; font-size: 0.9rem; white-space: nowrap; order: 1; }
  #boardList.compact-mode .card h3 small { font-weight: normal; color: var(--text-sec); }
  #boardList.compact-mode .card .meta { margin: 0; font-size: 0.8rem; white-space: nowrap; order: 2; }
  #boardList.compact-mode .card .resume-text { display: none; }
  #boardList.compact-mode .card .card-actions { position: static; opacity: 1; display: flex; gap: 5px; margin-left: auto; order: 3; }
  #boardList.compact-mode .card .card-actions button { padding: 4px 8px; font-size: 0.75rem; }
  #boardList.compact-mode .card .tag-badge { width: 8px; height: 8px; }

  #print-cover, .print-only-title { display: none; }
  @media print {
    @page { size: A4; margin: 25mm 25mm 25mm 35mm; counter-increment: page; @top-right { content: counter(page) "."; font-family: 'Courier Prime', 'Courier', monospace; font-size: 12pt; margin-top: 15mm; } }
    
    body { background: #fff !important; color: #000 !important; height: auto; overflow: visible; font-family: 'Courier Prime', 'Courier', monospace; -webkit-print-color-adjust: exact; }
    main { overflow: visible; padding: 0; margin: 0; }
    
    /* Cacher l'interface */
    #auth-view, #dashboard-view, header, .tabs-nav, .format-bar, .global-actions, .board-sidebar, .bd-header button, .card-actions, .autocomplete-wrapper, .modal-overlay, .lock-overlay, .group-select, .new-project-card, button, .synopsis-history, .controls-row, .sidebar-toggles, .script-info-col, #quick-nav { display: none !important; }

    /* Page de garde */
    #print-cover { display: flex !important; flex-direction: column; justify-content: center; align-items: center; height: 90vh; text-align: center; page-break-after: always; }
    #print-cover h1 { font-size: 36pt; margin-bottom: 10px; text-transform:uppercase; text-decoration:underline; }
    #print-cover p { font-size: 14pt; margin: 10px 0; }
    #print-cover .print-contact { position: absolute; bottom: 0; left: 0; text-align: left; font-size: 12pt; }

    /* Affichage ScÃ©nario */
    body.print-script #tab-script { display: block !important; }
    .script-view { max-width: 100%; width: 100%; font-size: 12pt; line-height: 1; }
    .script-row { display: block; border-bottom: none; padding: 0; margin: 0; page-break-inside: auto; }
    .script-write-col { display: block; width: 100%; margin: 0; }
    .script-editor-box { border: none; padding: 0; background: white; color: black; box-shadow: none; min-height: auto; width: 100%; overflow: visible; }
    
    /* Elements ScÃ©nario Impression */
    .scene-heading-print { display: block !important; font-weight: bold; text-transform: uppercase; margin-top: 24pt; margin-bottom: 12pt; text-decoration: underline; page-break-after: avoid; }
    
    .sc-action { margin: 12pt 0; text-align: left; width: 100%; }
    .sc-perso { margin-top: 12pt; margin-bottom: 0; margin-left: 40%; margin-right: 10%; text-transform: uppercase; page-break-after: avoid; }
    .sc-dial { margin-top: 0; margin-bottom: 0; margin-left: 20%; margin-right: 20%; page-break-inside: auto; widows: 2; orphans: 2; }
    .sc-paren { margin-left: 30%; margin-right: 30%; font-style: italic; margin-bottom: 0; page-break-after: avoid; }
    .sc-trans { text-align: right; margin-left: 60%; margin-top: 12pt; margin-bottom: 12pt; text-transform: uppercase; }
    .sc-note { display: none; }
    .sc-general { font-style: italic; color: #444; margin: 12pt 0; }
    .sc-centered { text-align: center; margin: 24pt 0; text-transform: uppercase; } 
    
    /* Autres onglets impression */
    body.print-synopsis #tab-synopsis { display: block !important; }
    .synopsis-editor h3, .section-label { display: none !important; }
    body.print-board #tab-board { display: block !important; }
    .board-main { width: 100%; }
    .card { border: 1px solid #000; break-inside: avoid; }
    .synopsis-editor-wrapper { box-shadow: none; border: none; }
    .synopsis-a4-page { box-shadow: none; margin: 0; }
    .synopsis-editor-box { min-height: auto; padding: 10mm 0; }
    .synopsis-toolbar { display: none !important; }
    
    body.print-chars #tab-chars { display: block !important; }
    body.print-actors #tab-actors { display: block !important; }
    body.print-locs #tab-locs { display: block !important; }
    body.print-breakdown #tab-breakdown { display: block !important; }
    body.print-stats #tab-stats { display: block !important; }
	body.print-storyboard #tab-storyboard { display: block !important; }
	body.print-storyboard .storyboard-scenes { display: none !important; }
	body.print-storyboard .sb-view-toggle { display: none !important; }
	body.print-storyboard .sb-print-preview { display: block !important; }
	body.print-crew #tab-crew { display: block !important; }
.crew-card { break-inside: avoid; border: 1px solid #ccc; margin-bottom: 15px; }
    .group-section { break-inside: avoid; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
    .data-grid { display: block; }
    .data-card { border-bottom: 1px solid #eee; margin-bottom: 10px; page-break-inside: avoid; }
    .breakdown-col { width: 100%; border: none; }
    #breakdownScriptCol { display: none; }
    .bd-scene-card { break-inside: avoid; border: 1px solid #ccc; margin-bottom: 10px; }
    .bd-scene-details { display: block !important; }
  }

  .script-editor-box, .bd-script-text, .print-only-title, .scene-heading-print { font-family: 'Courier Prime', 'Courier New', Courier, monospace !important; }
  body.dark-mode button, body.dark-mode .theme-btn, body.dark-mode .fmt-btn { background-color: #2d2d2d !important; border-color: #555 !important; color: #e0e0e0 !important; }
  body.dark-mode button:hover, body.dark-mode .theme-btn:hover { background-color: #404040 !important; border-color: #777 !important; }
  body.dark-mode .fmt-btn.active { background-color: var(--primary) !important; color: #fff !important; border-color: var(--primary) !important; }

/* ========== VERSIONS DE SCÃˆNES ========== */
.scene-versions-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10001;
}
.scene-versions-box {
    background: var(--panel-bg);
    border-radius: 12px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.scene-versions-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.scene-versions-header h3 {
    margin: 0;
    font-size: 1.2rem;
}
.scene-versions-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}
.scene-version-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.2s;
}
.scene-version-item:hover {
    border-color: var(--primary);
}
.scene-version-item.current {
    border-color: var(--success);
    background: rgba(40, 167, 69, 0.1);
}
.scene-version-info {
    flex: 1;
}
.scene-version-date {
    font-weight: 600;
    margin-bottom: 4px;
}
.scene-version-preview {
    font-size: 0.85rem;
    color: var(--text-sec);
    max-height: 40px;
    overflow: hidden;
    text-overflow: ellipsis;
}
.scene-version-actions {
    display: flex;
    gap: 8px;
}
.scene-version-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}
.scene-version-btn.restore {
    background: var(--primary);
    color: white;
}
.scene-version-btn.restore:hover {
    opacity: 0.9;
}
.scene-version-btn.preview {
    background: var(--bg);
    border: 1px solid var(--border);
}
.scene-version-btn.preview:hover {
    border-color: var(--primary);
}
.scene-version-btn.delete {
    background: transparent;
    color: var(--danger);
    border: 1px solid var(--danger);
}
.scene-version-btn.delete:hover {
    background: var(--danger);
    color: white;
}
.version-badge {
    background: var(--primary);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    margin-left: 5px;
}

/* Badges statut scÃ¨ne (Brouillon/Finale) */
.scene-status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; margin-left: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.scene-status-badge.draft { background: #fff3e0; color: #ef6c00; border: 1px solid #ffcc80; }
.scene-status-badge.final { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
body.dark-mode .scene-status-badge.draft { background: #4a3000; color: #ffb74d; border-color: #6d4c00; }
body.dark-mode .scene-status-badge.final { background: #1b3d1f; color: #81c784; border-color: #2e5a32; }

.scene-draft-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,152,0,0.03) 10px, rgba(255,152,0,0.03) 20px); pointer-events: none; z-index: 1; border-radius: inherit; }

.card.is-final { border-left: 4px solid var(--success); }
.card.is-draft { border-left: 4px solid #ff9800; }

.script-row.is-final { border-left: 4px solid var(--success); }
.script-row.is-draft { border-left: 4px solid #ff9800; }

.finalize-btn { padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
.finalize-btn:hover { background: #1b5e20; transform: scale(1.02); }

.unfinalize-btn { padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
.unfinalize-btn:hover { background: #e65100; }

.breakdown-blocked { opacity: 0.5; pointer-events: none; position: relative; }
.breakdown-blocked-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel-bg); border: 2px dashed #ff9800; padding: 20px 30px; border-radius: 12px; text-align: center; z-index: 10; box-shadow: 0 4px 20px var(--shadow); }
.breakdown-blocked-msg h4 { margin: 0 0 10px 0; color: #ff9800; }
.breakdown-blocked-msg p { margin: 0; color: var(--text-sec); font-size: 0.9rem; }

/* ========== CALENDRIER VISUEL ========== */
.calendar-container {
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}
.calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}
.calendar-header h3 {
    margin: 0;
    font-size: 1.2rem;
}
.calendar-nav {
    display: flex;
    align-items: center;
    gap: 15px;
}
.calendar-nav-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 15px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
}
.calendar-nav-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
.calendar-month-year {
    font-size: 1.1rem;
    font-weight: bold;
    min-width: 180px;
    text-align: center;
}
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}
.calendar-weekday {
    text-align: center;
    font-weight: bold;
    font-size: 0.85rem;
    color: var(--text-sec);
    padding: 10px 5px;
}
.calendar-day {
    aspect-ratio: 1;
    min-height: 80px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 5px;
    background: var(--bg);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.calendar-day:hover {
    border-color: var(--primary);
}
.calendar-day.other-month {
    opacity: 0.4;
}
.calendar-day.today {
    border: 2px solid var(--primary);
    background: rgba(79, 70, 229, 0.1);
}
.calendar-day.has-shooting {
    background: rgba(76, 175, 80, 0.15);
    border-color: #4CAF50;
}
.calendar-day-number {
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 3px;
}
.calendar-day-events {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.calendar-event {
    font-size: 0.7rem;
    padding: 2px 5px;
    border-radius: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.calendar-event.shooting {
    background: #4CAF50;
    color: white;
}
.calendar-event.availability {
    background: #2196F3;
    color: white;
}
.calendar-event.unavailable {
    background: #f44336;
    color: white;
}
.calendar-legend {
    display: flex;
    gap: 20px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
}
.calendar-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
}
.calendar-legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}
.calendar-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.calendar-export-btn {
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}
.calendar-export-btn:hover {
    opacity: 0.9;
}
.calendar-view-toggle {
    display: flex;
    gap: 5px;
    background: var(--bg);
    padding: 5px;
    border-radius: 8px;
}
.calendar-view-btn {
    padding: 8px 15px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}
.calendar-view-btn.active {
    background: var(--primary);
    color: white;
}

/* ========== BÃ‰NÃ‰VOLAT / TYPE DE COLLABORATION ========== */
.collab-type-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
}
.collab-type-btn {
    padding: 8px 15px;
    border: 2px solid var(--border);
    border-radius: 20px;
    background: var(--bg);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
}
.collab-type-btn:hover {
    border-color: var(--primary);
}
.collab-type-btn.selected {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
}
.collab-type-btn.pro { border-color: #4CAF50; }
.collab-type-btn.pro.selected { background: #4CAF50; border-color: #4CAF50; }
.collab-type-btn.semi-pro { border-color: #FF9800; }
.collab-type-btn.semi-pro.selected { background: #FF9800; border-color: #FF9800; }
.collab-type-btn.benevole { border-color: #E91E63; }
.collab-type-btn.benevole.selected { background: #E91E63; border-color: #E91E63; }

.collab-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}
.collab-badge.pro {
    background: #E8F5E9;
    color: #2E7D32;
}
.collab-badge.semi-pro {
    background: #FFF3E0;
    color: #E65100;
}
.collab-badge.benevole {
    background: #FCE4EC;
    color: #C2185B;
}
.collab-badge.amateur {
    background: #E3F2FD;
    color: #1565C0;
}

.project-type-selector {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}
.project-type-card {
    flex: 1;
    padding: 15px;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: var(--bg);
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
}
.project-type-card:hover {
    border-color: var(--primary);
}
.project-type-card.selected {
    border-width: 3px;
}
.project-type-card.pro.selected {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}
.project-type-card.semi-pro.selected {
    border-color: #FF9800;
    background: rgba(255, 152, 0, 0.1);
}
.project-type-card.benevole.selected {
    border-color: #E91E63;
    background: rgba(233, 30, 99, 0.1);
}
.project-type-card .icon {
    font-size: 2rem;
    margin-bottom: 8px;
}
.project-type-card .label {
    font-weight: bold;
    margin-bottom: 5px;
}
.project-type-card .desc {
    font-size: 0.8rem;
    color: var(--text-sec);
}

/* ========== GESTION DES CONTRATS ========== */
.contracts-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease;
}
.contracts-box {
    background: var(--panel-bg);
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: scaleIn 0.2s ease;
}
.contracts-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.contracts-header h3 {
    margin: 0;
    font-size: 1.3rem;
}
.contracts-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
.contracts-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 15px;
}
.contracts-tab {
    padding: 10px 20px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}
.contracts-tab:hover {
    border-color: var(--primary);
}
.contracts-tab.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
.contract-form {
    display: grid;
    gap: 15px;
}
.contract-form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}
.contract-form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.contract-form-group label {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-sec);
}
.contract-form-group input,
.contract-form-group select,
.contract-form-group textarea {
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--input-bg);
    color: var(--text-main);
    font-size: 0.95rem;
}
.contract-preview {
    background: white;
    color: #333;
    padding: 30px;
    border-radius: 8px;
    border: 1px solid var(--border);
    font-family: 'Times New Roman', serif;
    font-size: 12pt;
    line-height: 1.6;
    max-height: 500px;
    overflow-y: auto;
}
.contract-preview h1 {
    text-align: center;
    font-size: 16pt;
    margin-bottom: 20px;
}
.contract-preview h2 {
    font-size: 12pt;
    margin-top: 20px;
    margin-bottom: 10px;
    border-bottom: 1px solid #333;
}
.contract-preview .signature-zone {
    display: flex;
    justify-content: space-between;
    margin-top: 40px;
}
.contract-preview .signature-box {
    width: 45%;
    text-align: center;
}
.contract-preview .signature-line {
    border-top: 1px solid #333;
    margin-top: 60px;
    padding-top: 5px;
}
.contract-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}
.contract-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.95rem;
    transition: all 0.2s;
}
.contract-btn-primary {
    background: var(--primary);
    color: white;
}
.contract-btn-primary:hover {
    opacity: 0.9;
}
.contract-btn-secondary {
    background: var(--border);
    color: var(--text-main);
}
.contract-btn-secondary:hover {
    background: var(--text-sec);
    color: var(--panel-bg);
}
.person-select-list {
    display: grid;
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
}
.person-select-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.person-select-item:hover {
    border-color: var(--primary);
}
.person-select-item.selected {
    border-color: var(--primary);
    background: rgba(79, 70, 229, 0.1);
}
.person-select-item .status-badge {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 4px;
    background: var(--border);
}
.person-select-item .status-badge.intermittent {
    background: #E3F2FD;
    color: #1565C0;
}
.person-select-item .status-badge.micro-entrepreneur {
    background: #FFF3E0;
    color: #E65100;
}

/* ========== STATISTIQUES AVANCÃ‰ES ========== */
.stats-section-title {
    font-size: 1.2rem;
    font-weight: bold;
    margin: 30px 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--primary);
    color: var(--text-main);
}
.stats-section-title:first-of-type {
    margin-top: 10px;
}
.charts-row-advanced {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.chart-box-advanced {
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
}
.chart-box-advanced .chart-title {
    font-weight: bold;
    margin-bottom: 15px;
    text-align: center;
    color: var(--text-main);
}
.chart-canvas-container {
    position: relative;
    height: 250px;
    width: 100%;
}
.progress-bar-container {
    background: var(--bg);
    border-radius: 10px;
    height: 30px;
    overflow: hidden;
    margin: 10px 0;
}
.progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    transition: width 0.5s ease;
}
.stats-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    margin-top: 15px;
}
.stats-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
}
.stats-legend-color {
    width: 14px;
    height: 14px;
    border-radius: 3px;
}
.budget-comparison {
    display: flex;
    gap: 20px;
    margin-top: 15px;
}
.budget-item {
    flex: 1;
    text-align: center;
    padding: 15px;
    background: var(--bg);
    border-radius: 8px;
}
.budget-item-label {
    font-size: 0.85rem;
    color: var(--text-sec);
    margin-bottom: 5px;
}
.budget-item-value {
    font-size: 1.5rem;
    font-weight: bold;
}
.budget-item-value.positive { color: var(--success); }
.budget-item-value.negative { color: var(--danger); }

/* ========== NOTIFICATIONS ========== */
.notif-wrapper {
    position: relative;
    display: inline-block;
}
.notif-btn {
    background: none;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    padding: 5px 10px;
    position: relative;
}
.notif-badge {
    position: absolute;
    top: 0;
    right: 2px;
    background: var(--danger);
    color: white;
    font-size: 0.7rem;
    font-weight: bold;
    min-width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--panel-bg);
}
.notif-badge.hidden {
    display: none;
}
.notif-panel {
    position: absolute;
    top: 100%;
    right: 0;
    width: 350px;
    max-height: 450px;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 9999;
    display: none;
    flex-direction: column;
    animation: fadeIn 0.2s ease;
}
.notif-panel.visible {
    display: flex;
}
.notif-header {
    padding: 15px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.notif-header h4 {
    margin: 0;
    font-size: 1rem;
}
.notif-mark-all {
    font-size: 0.8rem;
    color: var(--primary);
    cursor: pointer;
    background: none;
    border: none;
}
.notif-mark-all:hover {
    text-decoration: underline;
}
.notif-list {
    flex: 1;
    overflow-y: auto;
    max-height: 350px;
}
.notif-item {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    gap: 12px;
    align-items: flex-start;
}
.notif-item:hover {
    background: var(--bg);
}
.notif-item.unread {
    background: rgba(79, 70, 229, 0.08);
}
.notif-item.unread::before {
    content: '';
    position: absolute;
    left: 5px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    background: var(--primary);
    border-radius: 50%;
}
.notif-icon {
    font-size: 1.3rem;
    flex-shrink: 0;
}
.notif-content {
    flex: 1;
    min-width: 0;
}
.notif-text {
    font-size: 0.9rem;
    color: var(--text-main);
    margin-bottom: 4px;
    line-height: 1.4;
}
.notif-time {
    font-size: 0.75rem;
    color: var(--text-sec);
}
.notif-empty {
    padding: 40px 20px;
    text-align: center;
    color: var(--text-sec);
}

/* ========== HISTORIQUE DES MODIFICATIONS ========== */
.history-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease;
}
.history-box {
    background: var(--panel-bg);
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: scaleIn 0.2s ease;
}
.history-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.history-header h3 {
    margin: 0;
    font-size: 1.3rem;
}
.history-filters {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}
.history-filters select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text-main);
    font-size: 0.9rem;
}
.history-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px 20px;
}
.history-item {
    display: flex;
    gap: 15px;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    transition: all 0.2s;
}
.history-item:hover {
    border-color: var(--primary);
}
.history-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}
.history-icon.add { background: rgba(76, 175, 80, 0.2); }
.history-icon.edit { background: rgba(33, 150, 243, 0.2); }
.history-icon.delete { background: rgba(244, 67, 54, 0.2); }
.history-icon.share { background: rgba(156, 39, 176, 0.2); }
.history-content {
    flex: 1;
}
.history-action {
    font-weight: 500;
    margin-bottom: 4px;
    color: var(--text-main);
}
.history-meta {
    font-size: 0.85rem;
    color: var(--text-sec);
    display: flex;
    gap: 15px;
}
.history-empty {
    text-align: center;
    padding: 40px;
    color: var(--text-sec);
}
.history-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-sec);
    padding: 5px 10px;
    border-radius: 5px;
}
.history-close-btn:hover {
    background: var(--bg);
    color: var(--text-main);
}

/* ========== MODE PRÃ‰SENTATION ========== */
body.presentation-mode {
    overflow: hidden;
}
body.presentation-mode .app-header,
body.presentation-mode #dashboard,
body.presentation-mode #universe-page,
body.presentation-mode #messages-page,
body.presentation-mode .project-header,
body.presentation-mode .project-tabs {
    display: none !important;
}
body.presentation-mode .project-sidebar {
    display: none !important;
}
body.presentation-mode .project-main {
    margin-left: 0 !important;
    height: 100vh !important;
    padding: 0 !important;
}
body.presentation-mode .tab-content {
    height: calc(100vh - 60px) !important;
    overflow-y: auto;
    padding: 30px;
}
body.presentation-mode .tab-content.active {
    display: block !important;
}

/* Barre de contrÃ´le flottante */
.presentation-bar {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: rgba(0,0,0,0.9);
    color: #fff;
    align-items: center;
    justify-content: center;
    gap: 20px;
    z-index: 10000;
    padding: 0 20px;
}
body.presentation-mode .presentation-bar {
    display: flex;
}
.presentation-bar button {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
}
.presentation-bar button:hover {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
}
.presentation-bar .pres-title {
    font-weight: bold;
    font-size: 1.1rem;
    margin-right: auto;
}
.presentation-bar .pres-nav {
    display: flex;
    align-items: center;
    gap: 10px;
}
.presentation-bar .pres-tab-name {
    min-width: 150px;
    text-align: center;
    font-size: 0.95rem;
    color: rgba(255,255,255,0.8);
}
//* === N8 â€” CLASSES UTILITAIRES (factorisation styles inline) === */
.d-none { display: none; }
.w-full-r8 { width: 100%; border-radius: 8px; }
.form-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); }
.form-input-sm { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); }
.form-label { display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px; }
.text-sec-sm { font-size: 0.8rem; color: var(--text-sec); }
.text-sec-sm2 { font-size: 0.85rem; color: var(--text-sec); }
.flex-1 { flex: 1; }
.mb-15 { margin-bottom: 15px; }
.mb-20 { margin-bottom: 20px; }
.mb-10 { margin-bottom: 10px; }
.mt-10 { margin-top: 10px; }
.mt-15 { margin-top: 15px; }
.mt-20 { margin-top: 20px; }
.mt-8 { margin-top: 8px; }
.m-0 { margin: 0; }
.grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.label-bold { display: block; margin-bottom: 5px; font-weight: 600; }
.label-bold-8 { display: block; margin-bottom: 8px; font-weight: 600; }
.label-sec { font-weight: 600; font-size: 0.85rem; color: var(--text-sec); }
.is-disabled { pointer-events: none; opacity: 0.6; }
.flex-row-center { display: flex; align-items: center; gap: 15px; }
.flex-row-gap10 { display: flex; gap: 10px; align-items: center; }
.text-sec { color: var(--text-sec); }
.w-full { width: 100%; }
.bg-base { background: var(--bg); }
.heading-primary { margin: 0; color: var(--primary); }
.form-label-block { font-size: 0.9rem; display: block; margin-bottom: 10px; }
.text-sec-sm-mb10 { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px; }
.text-sec-sm-mb15 { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px; }
.panel-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.d-none-mb15 { display: none; margin-bottom: 15px; }
.flex-row-btn { display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg); }
.info-box { margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border); }
.flex-input { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); }
.nav-item { padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem; }
.td-bordered { padding:10px; border:1px solid #ddd; text-align:left; }
.td-bordered-simple { padding:10px; border:1px solid #ddd; }
.flex-gap10 { display: flex; gap: 10px; }
.btn-secondary { background:var(--border); color:var(--text-main); border:none; padding:8px 15px; border-radius:6px; font-weight:bold; cursor:pointer; }
.text-sec-italic { color: var(--text-sec); font-style: italic; }
.form-input-lg { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); }
.form-label-alt { font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:5px; }
.mb-8 { margin-bottom: 8px; }
.fs-15 { font-size: 1.5rem; }
.mb-15-bg { margin-bottom: 15px; padding: 10px; background: var(--bg); border-radius: 8px; }
.btn-primary { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
.btn-primary-sm { padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; }
.fs-09 { font-size: 0.9rem; }
.flex-link { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem; }
.form-input-r4 { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); }
.pos-relative { position: relative; }
.nav-item-plain { padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; }
.flex-col-gap10 { display: flex; flex-direction: column; gap: 10px; }
.flex-row-click { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px 0; }
.icon-sm { width: 18px; height: 18px; flex-shrink: 0; }
.nowrap { white-space: nowrap; }
.text-center { text-align: center; }
.label-bold-fw { font-weight: 600; margin-bottom: 8px; display: block; }
.flex-wrap-gap10 { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.icon-btn { background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main); }
.hr-subtle { border:none; border-top:1px solid var(--border); margin:8px 0; }
.delete-link { cursor:pointer; color:var(--danger); margin-left:5px; }
.text-sec-xs { color:var(--text-sec); font-size:0.8rem; }
.img-cover { width: 100%; height: 100%; object-fit: cover; }
.box-bg { background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px; }
.th-primary { font-weight: bold; padding: 8px; color: var(--primary); }
.text-muted-center { text-align:center; color:#999; }
.flex-end { display:flex; gap:10px; justify-content:flex-end; }
.ml-10 { margin-left: 10px; }
.btn-tag { display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; background: var(--bg); border-radius: 6px; }
.btn-primary-sm2 { padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; }
.empty-state { text-align: center; color: var(--text-sec); padding: 40px; }
.label-bold-block-5 { font-weight: bold; display: block; margin-bottom: 5px; }
.label-bold-block-10 { font-weight: bold; display: block; margin-bottom: 10px; }
.d-none-col { display: none; flex-direction: column; gap: 10px; }
.flex-gap5 { display: flex; gap: 5px; }
.form-label-xs { font-size: 0.75rem; color: var(--text-sec); display: block; margin-bottom: 4px; }
.btn-sm { padding: 8px 15px; font-size: 0.9rem; }
.fs-085 { font-size: 0.85rem; }
.col-span-2 { grid-column: span 2; }
.br-8 { border-radius: 8px; }
.btn-outline { padding:10px 20px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:6px; cursor:pointer; }
.fw-bold { font-weight: bold; }
.min-w-150 { min-width: 150px; }
.p-10 { padding: 10px; }
.btn-success { padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
.form-input-compact { width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); }
.select-panel { background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; cursor:pointer; }
.flex-gap10-mb10 { display:flex; gap:10px; margin-bottom:10px; }
.tab-btn-panel { padding:10px 20px; border:none; background:var(--panel-bg); color:var(--text-main); border-radius:6px 6px 0 0; cursor:pointer; }
.d-none-panel { display:none; background:var(--panel-bg); border:1px solid var(--border); border-radius:12px; padding:20px; }
.box-bg-center { background:var(--bg); border-radius:8px; padding:15px; text-align:center; }
.flex-click-5 { display:flex; align-items:center; gap:5px; cursor:pointer; }
.mt-15-d-none { margin-top:15px; display:none; }
.text-danger { color:var(--danger); }
.subtitle-sec { margin:0 0 10px; font-size:0.9rem; color:var(--text-sec); }
.btn-border { padding:10px 20px; background:var(--border); color:var(--text-main); border:none; border-radius:6px; cursor:pointer; }
.grid-2col-mb15 { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px; }
.grid-gap20 { display:grid; gap:20px; }
.input-mini { padding:8px; border:1px solid var(--border); border-radius:4px; }
.input-mini-60 { padding:6px; border:1px solid var(--border); border-radius:4px; width:60px; }
.fs-11 { font-size:1.1rem; }
.fw-600 { font-weight:600; }
.text-primary { color:var(--primary); }
.flex-row-gap10 { display:flex; align-items:center; gap:10px; }
.flex-wrap-gap8 { display:flex; flex-wrap:wrap; gap:8px; }
.flex-gap8 { display:flex; gap:8px; }
.flex-col-gap5 { display:flex; flex-direction:column; gap:5px; }
.mt-0 { margin-top:0; }
.section-header-10 { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.text-sec-mb20 { color:var(--text-sec); margin-bottom:20px; }
.label-sec-block { display:block; font-weight:600; margin-bottom:5px; color:var(--text-sec); }
.btn-primary-sm-r6 { background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; }
.btn-outline-r6 { padding:10px 20px; background:var(--bg); border:1px solid var(--border); border-radius:6px; cursor:pointer; }
.btn-outline-compact { padding:10px 20px; background:var(--bg); border:1px solid var(--border); border-radius:6px; cursor:pointer; }
.flex-end-mt20 { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }
.flex-end-compact { display:flex; gap:10px; justify-content:flex-end; }
.fs-2-mb10 { font-size:2rem; margin-bottom:10px; }
.m-0-fs1 { margin:0; font-size:1rem; }
.subtitle-sec-15 { margin:0 0 15px 0; color:var(--text-sec); }
.mb-15-m0 { margin:0 0 15px; }
.text-sec-mb15-alt { margin-bottom:15px; color:var(--text-sec); }.text-sec-mb15-alt { margin-bottom:15px; color:var(--text-sec); }
.btn-panel-bold { padding:8px 15px; cursor:pointer; background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); border-radius:4px; font-weight:bold; }
.btn-primary-r4 { background:var(--primary); color:#fff; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; }
.btn-border-r8 { background:var(--border); color:var(--text-main); border:none; padding:10px 20px; border-radius:8px; cursor:pointer; }
.btn-success-compact { padding:10px 20px; background:var(--success); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.btn-success-compact2 { padding:10px 20px; background:var(--success); color:white; border:none; border-radius:6px; cursor:pointer; }
.modal-panel { background:var(--panel-bg); border-radius:12px; padding:25px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; }
.modal-panel-450 { background:var(--panel-bg); border-radius:12px; padding:25px; width:450px; max-width:90%; }
.icon-btn-sec { background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-sec); }
.flex-gap20-start { display:flex; gap:20px; align-items:flex-start; }
.text-sec-xs-mt8 { font-size:0.75rem; color:var(--text-sec); margin-top:8px; margin-bottom:0; }
.text-sec-sm-mb5 { font-size:0.8rem; color:var(--text-sec); margin-bottom:5px; }
.text-sec-xs-alt { font-size:0.75rem; color:var(--text-sec); }
.heading-border { margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px; }
.pre-wrap { white-space:pre-wrap; font-size:0.85rem; color:var(--text-main); margin-top:5px; }
.title-primary { margin:0 0 10px; font-size:1rem; color:var(--primary); }
.label-500 { display:block; margin-bottom:5px; font-weight:500; }
.text-italic-center { text-align:center; font-style:italic; }
.dropdown-abs { display:none; position:absolute; top:100%; left:0; background:var(--panel-bg); border:1px solid var(--border); border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; min-width:160px; margin-top:5px; }
/* --- N8 batch 2x (50 patterns) --- */
.n8-dropdown-1 { display:none; position:absolute; top:100%; left:0; right:0; background:var(--panel-bg); border:1px solid var(--border); border-radius:6px; max-height:200px; overflow-y:auto; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,0.15); }
.n8-avatar-1 { width:100px; height:100px; border-radius:50%; background:var(--bg); display:flex; align-items:center; justify-content:center; font-size:3rem; margin-bottom:10px; overflow:hidden; border:3px solid var(--border); }
.n8-badge-1 { padding:3px 5px; border:1px solid var(--primary); border-radius:3px; font-family:inherit; font-size:inherit; font-weight:bold; background:var(--panel-bg); color:var(--text-main); text-transform:uppercase; }
.n8-input-1 { width:100%; padding:14px 16px; margin-bottom:15px; border:1px solid var(--border); border-radius:10px; background:var(--bg); color:var(--text-main); font-size:1.1rem; font-weight:600; }
.n8-flex-1 { width:50px; height:50px; background:var(--bg); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; cursor:pointer; border:2px solid var(--border); }
.n8-avatar-2 { width:24px; height:24px; border-radius:50%; background:var(--panel-bg); display:flex; align-items:center; justify-content:center; overflow:hidden; font-size:0.8rem; }
.n8-input-2 { width:100%; height:150px; padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text-main); resize:vertical; margin-bottom:15px; }
.n8-avatar-3 { position:absolute; top:-5px; right:-5px; width:20px; height:20px; border-radius:50%; background:var(--danger); color:white; border:none; cursor:pointer; font-size:12px; }
.n8-flex-2 { display:inline-flex; align-items:center; gap:5px; background:var(--panel-bg); border:1px solid var(--border); padding:5px 10px; border-radius:20px; font-size:0.85rem; }
.n8-badge-2 { padding:8px 15px; background:var(--bg); border:1px dashed var(--primary); border-radius:6px; cursor:pointer; color:var(--primary); font-size:0.9rem; }
.n8-input-3 { width:50px; padding:4px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); text-align:center; }
.n8-input-4 { width:50px; padding:5px; border:1px solid var(--border); border-radius:4px; text-align:center; background:var(--input-bg); color:var(--text-main); }
.n8-badge-3 { width:100%; padding:8px 12px; border:1px solid var(--border); border-radius:6px; background:var(--bg); color:var(--text-main); margin-bottom:8px; }
.n8-input-5 { width:100%; min-height:60px; padding:10px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); }
.n8-input-6 { width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); resize:vertical; }
.n8-avatar-4 { width:80px; height:80px; border-radius:50%; background:var(--bg); display:flex; align-items:center; justify-content:center; font-size:2.5rem; overflow:hidden; }
.n8-badge-4 { margin-bottom:20px; padding:8px 15px; cursor:pointer; background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); border-radius:4px; }
.n8-badge-5 { font-size:0.75rem; padding:2px 8px; background:var(--bg); border:1px solid var(--border); border-radius:3px; cursor:pointer; margin-right:5px; }
.n8-input-7 { width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); margin-bottom:10px; }
.n8-flex-3 { display:inline-flex; align-items:center; gap:8px; background:var(--bg); padding:6px 12px; border-radius:20px; border:1px solid var(--border); }
.n8-input-8 { width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); margin-bottom:15px; }
.n8-input-9 { flex:1; min-width:150px; padding:8px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); }
.n8-input-10 { width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); resize:vertical; }
.n8-input-11 { width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); font-size:1rem; }
.n8-badge-6 { flex:1; padding:8px; background:var(--bg); border:1px solid var(--border); border-radius:6px; cursor:pointer; color:var(--text-main); }
.n8-badge-7 { background:var(--danger); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; }
.n8-badge-8 { background:var(--bg); color:var(--text-main); border:1px solid var(--border); padding:10px 20px; border-radius:6px; cursor:pointer; }
.n8-badge-9 { padding:8px 15px; cursor:pointer; background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); border-radius:4px; }
.n8-badge-10 { padding:8px 15px; background:var(--success); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.n8-badge-11 { font-size:0.75rem; padding:2px 8px; background:var(--bg); border:1px solid var(--border); border-radius:3px; cursor:pointer; }
.n8-input-12 { width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); }
.n8-btn-1 { background:var(--success); color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; }
.n8-input-13 { width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); }
.n8-badge-12 { width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--bg); color:var(--text); }
.n8-flex-4 { padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.n8-flex-5 { padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.n8-badge-13 { background:var(--border); color:var(--text-main); border:none; padding:10px 20px; border-radius:8px; cursor:pointer; }
.n8-input-14 { padding:10px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); }
.n8-flex-6 { padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.n8-badge-14 { padding:8px 12px; background:var(--panel-bg); border:1px solid var(--border); border-radius:4px; cursor:pointer; }
.n8-btn-2 { padding:8px 15px; cursor:pointer; background:var(--success); color:#fff; border:none; border-radius:4px; font-weight:bold; }
.n8-btn-3 { padding:10px 20px; background:var(--border); color:var(--text-main); border:none; border-radius:6px; cursor:pointer; }
.n8-misc-1 { padding:8px 15px; font-size:0.75rem; color:var(--text-sec); font-weight:600; border-bottom:1px solid var(--border); }
.n8-btn-4 { padding:8px 15px; cursor:pointer; background:var(--primary); color:#fff; border:none; border-radius:4px; font-weight:bold; }
.n8-flex-7 { display:flex; gap:4px; background:var(--bg); padding:4px; border-radius:6px; border:1px solid var(--border); }
.n8-badge-15 { padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; }
.n8-badge-16 { background:var(--danger); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; }
.n8-misc-2 { width:36px; height:32px; border:1px solid var(--border); border-radius:4px; cursor:pointer; padding:2px; }
.n8-btn-5 { background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; }
.n8-misc-3 { width:100%; min-height:120px; margin-top:5px; border:1px solid #ccc; border-radius:4px; padding:8px; }
.kanban-body { background:var(--bg); min-height:300px; padding:10px; border-radius:0 0 8px 8px; }
.p-20 { padding:20px; }
.select-outline { background:var(--bg); color:var(--text-main); border:1px solid var(--border); padding:8px 15px; border-radius:4px; cursor:pointer; }
.section-header-20 { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.flex-center-mb10 { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.mt-5 { margin-top:5px; }
.min-w-200 { min-width:200px; }
.empty-state-sm { color:var(--text-sec); text-align:center; padding:20px; }
.badge-panel { background:var(--panel-bg); border:1px solid var(--border); padding:3px 8px; border-radius:4px; font-size:0.85rem; }
.text-muted { color:#666; }
.empty-state-lg { text-align:center; color:#999; padding:50px; }
.td-padded { padding:12px 10px; text-align:left; font-size:0.85rem; }
.flex-wrap-center { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
.btn-primary-r8 { background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; }
.hub-nav-btn { background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:6px; }
.text-muted { color:#666; }
.mt-5 { margin-top:5px; }
.min-w-200 { min-width:200px; }
.fs-11 { font-size:1.1rem; }
</style>
</head>
<body>
<!-- ========== BIBLIOTHÃˆQUE D'ICÃ”NES SVG ========== -->
<svg id="moteur-icons" class="d-none" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <!-- Navigation -->
    <symbol id="ico-user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></symbol>
    <symbol id="ico-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></symbol>
    <symbol id="ico-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></symbol>
    <symbol id="ico-contact" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></symbol>
    <!-- Ã‰criture -->
    <symbol id="ico-file-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></symbol>
    <symbol id="ico-book-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></symbol>
    <symbol id="ico-clapperboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8H4Z"/><path d="m4 11-.88-2.87a2 2 0 0 1 1.33-2.5l11.48-3.5a2 2 0 0 1 2.5 1.32l.87 2.87L4 11Z"/><path d="m6.6 4.99 3.38 4.2"/><path d="m11.86 3.38 3.38 4.2"/></symbol>
    <symbol id="ico-film" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="20" x="2" y="2" rx="2.18" ry="2.18"/><line x1="7" x2="7" y1="2" y2="22"/><line x1="17" x2="17" y1="2" y2="22"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="2" x2="7" y1="7" y2="7"/><line x1="2" x2="7" y1="17" y2="17"/><line x1="17" x2="22" y1="17" y2="17"/><line x1="17" x2="22" y1="7" y2="7"/></symbol>
    <!-- Production -->
    <symbol id="ico-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></symbol>
    <symbol id="ico-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></symbol>
    <symbol id="ico-map-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></symbol>
    <symbol id="ico-box" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></symbol>
    <!-- Visuel -->
    <symbol id="ico-palette" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.555C21.965 6.012 17.461 2 12 2z"/></symbol>
    <symbol id="ico-image" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></symbol>
    <symbol id="ico-grid" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></symbol>
    <!-- Casting -->
    <symbol id="ico-theater" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 10s3-3 10-3 10 3 10 3"/><path d="M2 14s3 3 10 3 10-3 10-3"/><circle cx="8" cy="12" r="2"/><circle cx="16" cy="12" r="2"/></symbol>
    <symbol id="ico-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></symbol>
    <!-- Admin -->
    <symbol id="ico-wallet" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></symbol>
    <symbol id="ico-file-signature" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 19.5v.5a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8.5L18 5.5"/><path d="M16 2v4a2 2 0 0 0 2 2h4"/><path d="M8 18h1"/><path d="m11.5 18 2.5-6 2.5 6"/></symbol>
    <symbol id="ico-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></symbol>
    <!-- Social -->
    <symbol id="ico-message" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></symbol>
    <symbol id="ico-rss" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></symbol>
    <symbol id="ico-mail" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></symbol>
    <symbol id="ico-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></symbol>
    <symbol id="ico-globe" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></symbol>
    <!-- Aide -->
    <symbol id="ico-help" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></symbol>
    <symbol id="ico-graduation" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></symbol>
    <symbol id="ico-book" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></symbol>
    <!-- Interface -->
    <symbol id="ico-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></symbol>
    <symbol id="ico-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></symbol>
    <symbol id="ico-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></symbol>
    <symbol id="ico-maximize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></symbol>
    <symbol id="ico-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></symbol>
    <symbol id="ico-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></symbol>
    <symbol id="ico-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></symbol>
    <symbol id="ico-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></symbol>
    <symbol id="ico-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></symbol>
    <symbol id="ico-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></symbol>
    <symbol id="ico-upload" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></symbol>
    <symbol id="ico-save" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></symbol>
    <symbol id="ico-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></symbol>
    <symbol id="ico-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></symbol>
    <symbol id="ico-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></symbol>
    <symbol id="ico-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></symbol>
    <symbol id="ico-keyboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2" ry="2"/><path d="M6 8h.001"/><path d="M10 8h.001"/><path d="M14 8h.001"/><path d="M18 8h.001"/><path d="M8 12h.001"/><path d="M12 12h.001"/><path d="M16 12h.001"/><path d="M7 16h10"/></symbol>
    <symbol id="ico-layers" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></symbol>
    <symbol id="ico-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></symbol>
    <symbol id="ico-share" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></symbol>
    <symbol id="ico-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></symbol>
    <symbol id="ico-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></symbol>
    <symbol id="ico-monitor" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></symbol>
    <symbol id="ico-car" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></symbol>
    <symbol id="ico-shirt" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></symbol>
  </defs>
</svg>

<!-- Conteneur des notifications Toast -->
<div id="toast-container" class="toast-container"></div>

<!-- Loading Screen CinÃ©ma -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-box">
        <div class="loading-scene">
            <div class="loading-ground"></div>
            
            <!-- L'Ã©quipe de tournage qui court (gauche â†’ droite) -->
            <div class="loading-crew">
                <!-- 1. Perchman en retard Ã  gauche -->
                <div class="pixel-person pixel-perch">
                    <div class="pixel-perch-body"></div>
                    <div class="pixel-perch-pole"></div>
                    <div class="pixel-perch-mic"></div>
                </div>
                <!-- 2. ComÃ©dien -->
                <div class="pixel-person pixel-actor1"></div>
                <!-- 3. ComÃ©dienne -->
                <div class="pixel-person pixel-actor2"></div>
                <!-- 4. CamÃ©raman -->
                <div class="pixel-person pixel-camera">
                    <div class="pixel-camera-rec"></div>
                </div>
                <!-- 5. Scripte avec classeur -->
                <div class="pixel-person pixel-script"></div>
                <!-- 6. RÃ©alisateur en tÃªte Ã  droite -->
                <div class="pixel-person pixel-director">
                    <div class="pixel-director-arm"></div>
                    <div class="pixel-director-mega"></div>
                    <div class="pixel-director-waves"></div>
                </div>
            </div>
            <!-- Feuilles qui volent depuis la scripte -->
            <div class="loading-papers">
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
            </div>
        </div>
        <div class="loading-clap">ðŸŽ¬</div>
        <div class="loading-title">Chargement du projet...</div>
        <div id="loading-message" class="loading-message">PrÃ©paration du plateau...</div>
        <div class="loading-progress">
            <div id="loading-progress-bar" class="loading-progress-bar"></div>
        </div>
    </div>
</div>

<!-- Barre de contrÃ´le Mode PrÃ©sentation -->
<div class="presentation-bar" id="presentationBar">
    <span class="pres-title">ðŸŽ¬ Mode PrÃ©sentation</span>
    <div class="pres-nav">
        <button onclick="app.PresentMode.prevTab()" data-tooltip="Onglet prÃ©cÃ©dent">â¬…ï¸ PrÃ©cÃ©dent</button>
        <span class="pres-tab-name" id="presTabName">Synopsis</span>
        <button onclick="app.PresentMode.nextTab()" data-tooltip="Onglet suivant">Suivant âž¡ï¸</button>
    </div>
    <button onclick="app.PresentMode.exit()" data-tooltip="Quitter (Ã‰chap)">âœ–ï¸ Quitter</button>
</div>

<!-- ==================== LANDING PAGE ==================== -->
<div id="landing-view">
  <header class="landing-header">
    <div class="landing-logo">
      <span>ðŸŽ¬</span> Moteur
    </div>
    <nav class="landing-nav">
      <a href="#features">FonctionnalitÃ©s</a>
      <a href="#screenshots">AperÃ§u</a>
      <a href="https://github.com/gadmy/moteur" target="_blank">GitHub</a>
      <button class="landing-btn landing-btn-outline" onclick="app.Landing.showAuth()">Se connecter</button>
      <button class="landing-btn landing-btn-primary" onclick="app.Landing.showAuth('signup')">S'inscrire</button>
    </nav>
  </header>

  <section class="landing-hero">
    <h1>Le logiciel <span>tout-en-un</span> pour Ã©crire votre scÃ©nario et gÃ©rer votre production</h1>
    <p>Moteur est l'outil tout-en-un pour les cinÃ©astes, rÃ©alisateurs et scÃ©naristes. Ã‰crivez votre scÃ©nario, crÃ©ez votre storyboard, gÃ©rez casting, planning et budget â€” en ligne et collaboratif.</p>
    <div class="landing-hero-btns">
      <button class="landing-btn landing-btn-primary" onclick="app.Landing.showAuth('signup')">ðŸš€ Commencer maintenant</button>
      <button class="landing-btn landing-btn-outline" onclick="app.Landing.showAuth()">J'ai dÃ©jÃ  un compte</button>
    </div>
    <div class="landing-keywords">
      <span class="landing-keyword">âœï¸ Ã‰criture scÃ©nario</span>
      <span class="landing-keyword">ðŸŽ¬ SÃ©quencier</span>
      <span class="landing-keyword">ðŸŽ¨ Storyboard</span>
      <span class="landing-keyword">ðŸŽ­ Casting</span>
      <span class="landing-keyword">ðŸ“… Planning</span>
      <span class="landing-keyword">ðŸ’° Budget</span>
      <span class="landing-keyword">ðŸŒ RÃ©seau pro</span>
    </div>
  </section>

  <section class="landing-features" id="features">
    <h2>Tout ce dont vous avez besoin pour votre film</h2>
    <div class="landing-features-grid">
      <div class="landing-feature-card">
        <div class="landing-feature-icon">âœï¸</div>
        <h3>Ã‰criture & ScÃ©nario</h3>
        <p>Ã‰crivez votre scÃ©nario avec un Ã©diteur professionnel. Synopsis, sÃ©quencier, format Fountain, import PDF. Export vers Final Draft.</p>
      </div>
      <div class="landing-feature-card">
        <div class="landing-feature-icon">ðŸŽ¨</div>
        <h3>Storyboard & Moodboard</h3>
        <p>Visualisez vos scÃ¨nes avec le storyboard intÃ©grÃ©. CrÃ©ez des planches d'inspiration avec le moodboard et les palettes de couleurs.</p>
      </div>
      <div class="landing-feature-card">
        <div class="landing-feature-icon">ðŸŽ­</div>
        <h3>Casting & Personnages</h3>
        <p>GÃ©rez vos personnages et trouvez vos comÃ©diens. Fiches dÃ©taillÃ©es, photos, disponibilitÃ©s et matching automatique.</p>
      </div>
      <div class="landing-feature-card">
        <div class="landing-feature-icon">ðŸ“…</div>
        <h3>Planning & Calendrier</h3>
        <p>Planifiez votre tournage jour par jour. Calendrier, feuilles de service, plan de travail et export ICS.</p>
      </div>
      <div class="landing-feature-card">
        <div class="landing-feature-icon">ðŸ’°</div>
        <h3>Budget & DÃ©penses</h3>
        <p>Suivez votre budget en temps rÃ©el. CatÃ©gories de dÃ©penses, statuts de paiement et graphiques de suivi.</p>
      </div>
      <div class="landing-feature-card">
        <div class="landing-feature-icon">ðŸŒ</div>
        <h3>Univers & RÃ©seau</h3>
        <p>Trouvez des collaborateurs prÃ¨s de chez vous. Carte interactive des comÃ©diens, techniciens et projets.</p>
      </div>
    </div>
  </section>

  <section class="landing-screenshots" id="screenshots">
    <h2>DÃ©couvrez l'interface</h2>
    <div class="landing-screenshots-grid">
      <div class="landing-screenshot">
        <img src="images/landing/hub.png" alt="Dashboard Moteur - Hub central">
        <div class="landing-screenshot-label">ðŸ  Hub â€” Votre tableau de bord</div>
      </div>
      <div class="landing-screenshot">
        <img src="images/landing/ecriture.png" alt="Ã‰criture scÃ©nario - SÃ©quencier">
        <div class="landing-screenshot-label">âœï¸ Ã‰criture â€” SÃ©quencier et scÃ©nario</div>
      </div>
      <div class="landing-screenshot">
        <img src="images/landing/casting.png" alt="Casting et personnages">
        <div class="landing-screenshot-label">ðŸŽ­ Casting â€” Personnages et comÃ©diens</div>
      </div>
      <div class="landing-screenshot">
        <img src="images/landing/production.png" alt="Planning de production">
        <div class="landing-screenshot-label">ðŸ“… Production â€” Planning de tournage</div>
      </div>
      <div class="landing-screenshot">
        <img src="images/landing/univers.png" alt="Univers - Carte des profils">
        <div class="landing-screenshot-label">ðŸŒ Univers â€” Trouvez des collaborateurs</div>
      </div>
      <div class="landing-screenshot">
        <img src="images/landing/administration.png" alt="Administration et statistiques">
        <div class="landing-screenshot-label">ðŸ“Š Admin â€” Statistiques et budget</div>
      </div>
    </div>
  </section>

  <section class="landing-cta">
    <h2>PrÃªt Ã  donner vie Ã  votre projet ?</h2>
    <p>Rejoignez la communautÃ© des cinÃ©astes qui utilisent Moteur.</p>
    <button class="landing-btn landing-btn-primary" onclick="app.Landing.showAuth('signup')" style="padding: 16px 40px; font-size: 1.2rem;">ðŸŽ¬ CrÃ©er mon compte</button>
  </section>

  <footer class="landing-footer">
    <p>Â© 2026 Moteur â€” Fait avec â¤ï¸ pour les cinÃ©astes â€” <a href="https://github.com/gadmy/moteur" target="_blank">GitHub</a></p>
  </footer>
</div>

<div id="auth-view" class="d-none">
    <div style="position:absolute; top:20px; right:20px;">
        <button class="theme-btn" onclick="app.UI.toggleTheme()">ðŸŒ“ Mode</button>
        <button class="theme-btn ml-10" onclick="app.Landing.show()">â† Retour</button>
    </div>
    <div class="auth-box">
      <h1>ðŸŽ¬ Moteur</h1>
      <p style="font-size: 0.9rem; color: var(--text-sec); margin-top: -10px; font-style: italic;">"Mais oÃ¹ est-ce qu'il est ce con de perchman ?"</p>
      <p>v2.3</p>
      <button class="tuto-btn" onclick="app.Tutorial.open()" style="margin: 10px 0;">ðŸ‘ï¸ Tutoriel</button>
      
      <div id="prealpha-banner" style="margin: 15px 0; padding: 12px; background: linear-gradient(135deg, rgba(255,152,0,0.15), rgba(255,87,34,0.15)); border: 1px solid rgba(255,152,0,0.4); border-radius: 8px;">
        <p id="prealpha-title" style="font-size: 0.8rem; color: #ff9800; font-weight: bold; margin: 0 0 5px;">âš ï¸ VERSION PRÃ‰-ALPHA</p>
        <p id="prealpha-message" style="font-size: 0.75rem; color: var(--text-sec); margin: 0; line-height: 1.4;">
          Cette version est en cours de dÃ©veloppement. Des bugs peuvent survenir et certaines fonctionnalitÃ©s sont incomplÃ¨tes. 
          Vos donnÃ©es peuvent Ãªtre perdues ou modifiÃ©es sans prÃ©avis. Utilisez cette version Ã  des fins de test uniquement.
        </p>
      </div>
      
      <form id="login-form" onsubmit="event.preventDefault(); app.Auth.login()">
        <input type="email" id="login-email" name="email" class="auth-input" placeholder="Email" autocomplete="username">
        <input type="password" id="login-pass" name="password" class="auth-input" placeholder="Mot de passe" autocomplete="current-password">
        <div id="login-error" class="auth-error">Identifiants incorrects.</div>
        <div id="login-success" class="auth-success"></div>
        <button type="submit" class="auth-btn">Se connecter</button>
        <div style="margin-top:15px; display:flex; justify-content:space-between; font-size:0.85rem">
            <span class="auth-link m-0" onclick="app.Auth.toggleForgot()">Mot de passe oubliÃ© ?</span>
            <span class="auth-link m-0" onclick="app.Auth.toggleMode('signup')">CrÃ©er un compte</span>
        </div>
      </form>

      <form id="signup-form" class="d-none" onsubmit="event.preventDefault(); app.Auth.signup()">
        <input type="email" id="signup-email" name="email" class="auth-input" placeholder="Email" autocomplete="username">
        <input type="password" id="signup-pass" name="new-password" class="auth-input" placeholder="Mot de passe" autocomplete="new-password">
        <input type="password" id="signup-confirm" name="confirm-password" class="auth-input" placeholder="Confirmer mot de passe" autocomplete="new-password">
       
	   <div style="margin: 15px 0; padding: 12px; background: var(--bg); border-radius: 8px; text-align: center;">
            <span style="font-size: 1.2rem;">ðŸŽ¬</span>
            <p style="font-size: 0.85rem; color: var(--text-sec); margin: 5px 0 0;">Vous pourrez crÃ©er vos profils (comÃ©dien, technicien...) aprÃ¨s inscription.</p>
        </div>


        <div id="signup-error" class="auth-error">Erreur de crÃ©ation.</div>
        <button type="submit" class="auth-btn">CrÃ©er mon compte</button>
        <div class="auth-link" onclick="app.Auth.toggleMode('login')">Se connecter</div>
      </form>

      <div id="forgot-form" class="d-none">
        <h3>RÃ©initialisation</h3>
        <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:15px">Entrez votre email pour recevoir un lien.</p>
        <input type="email" id="forgot-email" class="auth-input" placeholder="Email du compte">
        <div id="forgot-error" class="auth-error">Email introuvable.</div>
        <div id="forgot-success" class="auth-success">Email envoyÃ© ! VÃ©rifiez vos spams.</div>
        <button class="auth-btn" onclick="app.Auth.resetPassword()">Envoyer le lien</button>
        <div class="auth-link" onclick="app.Auth.toggleMode('login')">Retour connexion</div>
      </div>
    </div>
  </div>
  
  <!-- Popup Tutoriel Principal -->
  <div class="tuto-modal-overlay" id="tuto-modal-overlay" onclick="if(event.target === this) app.Tutorial.close()">
    <div class="tuto-modal">
      <div class="tuto-modal-header">
        <h2>ðŸ“š Guide de Moteur</h2>
        <button class="tuto-modal-close" onclick="app.Tutorial.close()">Ã—</button>
      </div>
      <div class="tuto-modal-body">
        <div class="tuto-sidebar" id="tuto-sidebar"></div>
        <div class="tuto-content" id="tuto-content"></div>
      </div>
    </div>
  </div>
  
  <!-- Popup Aide Contextuelle -->
  <div class="help-popup" id="help-popup">
    <button class="help-popup-close" onclick="app.Tutorial.closeHelp()">Ã—</button>
    <div class="help-popup-title" id="help-popup-title"></div>
    <div class="help-popup-content" id="help-popup-content"></div>
  </div>
  
  <div id="dashboard-view">
    <div class="dash-header">
      <div class="dash-title">
        <h1>ðŸŽ¬ Moteur</h1>
        <p id="user-welcome">Bienvenue</p>
      </div>
      <div class="flex-row-gap10">
      <!-- Mon Espace -->
      <divclass="nav-dropdown pos-relative" onmouseenter="this.querySelector('.dropdown-menu').classList.add('show')" onmouseleave="this.querySelector('.dropdown-menu').classList.remove('show')">
        <button class="hub-nav-btn"><span class="moteur-icon cat-system"><span class="emoji">ðŸ‘¤</span><svg><use href="#ico-user"/></svg></span> Mon Espace â–¾</button>
        <div class="dropdown-menu dropdown-abs">
          <div onclick="app.Admin.close(); app.PublicProfile.open()" style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; border-radius:6px 6px 0 0;" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''"><span class="moteur-icon cat-system"><span class="emoji">ðŸ‘¤</span><svg><use href="#ico-user"/></svg></span> Mon Profil</div>
          <div onclick="app.Admin.close(); app.Universe.showProjects()" style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''"><span class="moteur-icon cat-system"><span class="emoji">ðŸ“</span><svg><use href="#ico-folder"/></svg></span> Mes Projets</div>
          <div onclick="app.Admin.close(); app.Contacts.open()" style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; border-radius:0 0 6px 6px;" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''"><span class="moteur-icon cat-system"><span class="emoji">ðŸ“‡</span><svg><use href="#ico-contact"/></svg></span> Contacts</div>
        </div>
      </div>
      <!-- CommunautÃ© -->
      <divclass="nav-dropdown pos-relative" onmouseenter="this.querySelector('.dropdown-menu').classList.add('show')" onmouseleave="this.querySelector('.dropdown-menu').classList.remove('show')">
        <button class="hub-nav-btn"><span class="moteur-icon cat-social"><span class="emoji">ðŸŒ</span><svg><use href="#ico-globe"/></svg></span> CommunautÃ© â–¾</button>
        <div class="dropdown-menu dropdown-abs">
          <div onclick="app.Universe.openFromMenu()" style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; border-radius:6px 6px 0 0;" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''"><span class="moteur-icon cat-social"><span class="emoji">ðŸ—ºï¸</span><svg><use href="#ico-globe"/></svg></span> Univers</div>
          <div onclick="app.Forum.open()" style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''"><span class="moteur-icon cat-social"><span class="emoji">ðŸ’¬</span><svg><use href="#ico-message"/></svg></span> Forum</div>
          <div onclick="app.Feed.open()" style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; border-radius:0 0 6px 6px;" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''"><span class="moteur-icon cat-social"><span class="emoji">ðŸ“°</span><svg><use href="#ico-rss"/></svg></span> Le Fil</div>
        </div>
      </div>
      <!-- Aide -->
      <divclass="nav-dropdown pos-relative" onmouseenter="this.querySelector('.dropdown-menu').classList.add('show')" onmouseleave="this.querySelector('.dropdown-menu').classList.remove('show')">
        <button class="hub-nav-btn"><span class="moteur-icon cat-help"><span class="emoji">â“</span><svg><use href="#ico-help"/></svg></span> Aide â–¾</button>
        <div class="dropdown-menu dropdown-abs">
          <div onclick="app.Tutorial.open()" style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; border-radius:6px 6px 0 0;" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''"><span class="moteur-icon cat-help"><span class="emoji">ðŸ“–</span><svg><use href="#ico-book"/></svg></span> Guide</div>
          <div onclick="app.Courses.open()" style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; border-radius:0 0 6px 6px;" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''"><span class="moteur-icon cat-help"><span class="emoji">ðŸŽ“</span><svg><use href="#ico-graduation"/></svg></span> Cours</div>
        </div>
      </div>
      <!-- Design -->
      <divclass="nav-dropdown pos-relative" onmouseenter="document.getElementById('design-dropdown').classList.add('show')" onmouseleave="document.getElementById('design-dropdown').classList.remove('show')">
        <button class="hub-nav-btn"><span class="moteur-icon cat-visual"><span class="emoji">ðŸŽ¨</span><svg><use href="#ico-palette"/></svg></span> Design â–¾</button>
        <div id="design-dropdown" style="display:none; position:absolute; top:100%; right:0; background:var(--panel-bg); border:1px solid var(--border); border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; min-width:150px; margin-top:5px;">
          <div onclick="app.UI.setDesign('classic')" class="nav-item-plain" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''">ðŸŽ¬ Classique</div>
          <div onclick="app.UI.setDesign('lavender')" class="nav-item-plain" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''">ðŸ’ Lavande</div>
          <div onclick="app.UI.setDesign('minimal')" class="nav-item-plain" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''">â¬œ Minimal</div>
        </div>
      </div>
      <!-- Mode -->
      <button onclick="app.UI.toggleTheme()" class="hub-nav-btn">ðŸŒ“</button>
        <div class="notif-wrapper">
            <button class="notif-btn" onclick="app.Notifications.togglePanel()" data-tooltip="Notifications" data-tooltip-pos="bottom">ðŸ””<span id="notif-badge" class="notif-badge hidden">0</span></button>
            <div class="notif-panel" id="notif-panel">
                <div class="notif-header">
                    <h4>ðŸ”” Notifications</h4>
                    <button class="notif-mark-all" onclick="app.Notifications.markAllRead()">Tout marquer lu</button>
                </div>
                <div class="notif-list" id="notif-list">
                    <div class="notif-empty">Aucune notification</div>
                </div>
            </div>
        </div>
        <button id="admin-btn" onclick="app.Admin.show()" style="display:none; background:linear-gradient(135deg, #e94560, #8b5cf6); color:white; border:none; padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer; margin-right: 10px;">ðŸ›¡ï¸ Admin</button>
        <button onclick="app.Auth.logout()" style="background:var(--border); color:var(--text-main); border:none; padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer">DÃ©connexion</button>
      </div>
    </div>
    
    <!-- Vue Admin -->
    <div id="admin-view" style="display:none; flex-direction: column; height: 100%; width: 100%; background: var(--bg); padding: 40px; overflow-y: auto;">
        <div style="max-width: 1400px; margin: 0 auto; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h1 style="margin: 0; display: flex; align-items: center; gap: 10px;">ðŸ›¡ï¸ Tableau de bord Admin</h1>
                <button onclick="app.Admin.close()" style="background:var(--border); color:var(--text-main); border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer">â† Retour</button>
            </div>
            
            <!-- Stats avec graphique d'Ã©volution -->
            <div id="admin-stats" style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="margin: 0 0 10px 0;">ðŸ“Š Ã‰volution des statistiques</h3>
                        <div class="flex-wrap-gap8" id="stats-toggles">
                            <!-- GÃ©nÃ©ral -->
                            <label class="btn-tag fs-085">
                                <input type="checkbox" checked data-stat="profiles" onchange="app.Admin.updateStatsChart()" style="accent-color: #3b82f6;">
                                <span style="color: #3b82f6;">ðŸ‘¥ Profils</span>
                                <strong id="stat-profiles-total" style="color: #3b82f6;">0</strong>
                            </label>
                            <label class="btn-tag fs-085">
                                <input type="checkbox" checked data-stat="projects" onchange="app.Admin.updateStatsChart()" style="accent-color: #10b981;">
                                <span style="color: #10b981;">ðŸŽ¬ Projets</span>
                                <strong id="stat-projects-total" style="color: #10b981;">0</strong>
                            </label>
                            <label class="btn-tag fs-085">
                                <input type="checkbox" data-stat="actors" onchange="app.Admin.updateStatsChart()" style="accent-color: #8b5cf6;">
                                <span style="color: #8b5cf6;">ðŸŽ­ ComÃ©diens</span>
                                <strong id="stat-actors-total" style="color: #8b5cf6;">0</strong>
                            </label>
                            <label class="btn-tag fs-085">
                                <input type="checkbox" data-stat="connections" onchange="app.Admin.updateStatsChart()" style="accent-color: #06b6d4;">
                                <span style="color: #06b6d4;">ðŸ”— Connexions</span>
                                <strong id="stat-connections-total" style="color: #06b6d4;">0</strong>
                            </label>
                            <label class="btn-tag fs-085">
                                <input type="checkbox" data-stat="reports" onchange="app.Admin.updateStatsChart()" style="accent-color: #ef4444;">
                                <span style="color: #ef4444;">ðŸš© Signalements</span>
                                <strong id="stat-reports-total" style="color: #ef4444;">0</strong>
                            </label>
                        </div>
                        <!-- DÃ©tail par catÃ©gorie -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                            <div class="flex-gap10-mb10">
                                <button onclick="app.Admin.toggleStatCategory('crew')" class="stat-cat-btn" id="stat-cat-crew" style="padding: 5px 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); border-radius: 6px; cursor: pointer; font-size: 0.8rem;">ðŸŽ¥ MÃ©tiers tech</button>
                                <button onclick="app.Admin.toggleStatCategory('asso')" class="stat-cat-btn" id="stat-cat-asso" style="padding: 5px 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); border-radius: 6px; cursor: pointer; font-size: 0.8rem;">ðŸ›ï¸ Associations</button>
                                <button onclick="app.Admin.toggleStatCategory('ent')" class="stat-cat-btn" id="stat-cat-ent" style="padding: 5px 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); border-radius: 6px; cursor: pointer; font-size: 0.8rem;">ðŸ¢ Entreprises</button>
                            </div>
                            <div id="stats-detail-toggles" style="display: flex; flex-wrap: wrap; gap: 6px; max-height: 120px; overflow-y: auto;">
                                <!-- Rempli dynamiquement par JS -->
                            </div>
                        </div>
                    </div>
                    <div class="flex-row-gap10">
                        <select id="stats-period" onchange="app.Admin.updateStatsChart()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text-main);">
                            <option value="7">7 derniers jours</option>
                            <option value="30" selected>30 derniers jours</option>
                            <option value="90">3 derniers mois</option>
                            <option value="365">12 derniers mois</option>
                        </select>
                        <button onclick="app.Admin.loadStats()" class="btn-primary-sm2">ðŸ”„</button>
                    </div>
                </div>
                <canvas id="admin-stats-chart" style="width: 100%; height: 250px;"></canvas>
            </div>
            
            <!-- Onglets Admin -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 10px; flex-wrap: wrap;">
                <button class="admin-tab active" data-tab="reports" onclick="app.Admin.switchTab('reports')" style="padding: 10px 20px; border: none; background: var(--primary); color: white; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: bold;">ðŸš© Signalements</button>
                <button class="admin-tab tab-btn-panel" data-tab="users" onclick="app.Admin.switchTab('users')">ðŸ‘¥ Utilisateurs</button>
                <button class="admin-tab tab-btn-panel" data-tab="emailing" onclick="app.Admin.switchTab('emailing')">ðŸ“§ Emailing</button>
                <button class="admin-tab tab-btn-panel" data-tab="config" onclick="app.Admin.switchTab('config')">âš™ï¸ Configuration</button>
                <button class="admin-tab tab-btn-panel" data-tab="analytics" onclick="app.Admin.switchTab('analytics')">ðŸ“ˆ Connexions</button>
            </div>
            
            <!-- Contenu onglet Signalements -->
            <div id="admin-tab-reports" class="admin-tab-content panel-card">
                <div class="section-header">
                    <h3 class="m-0">ðŸš© Signalements en attente</h3>
                    <button onclick="app.Admin.loadReports()" class="btn-primary-sm2">ðŸ”„ Actualiser</button>
                </div>
                <div id="admin-reports-list" class="flex-col-gap10">
                    <div class="empty-state">Chargement...</div>
                </div>
            </div>
            
            <!-- Contenu onglet Utilisateurs -->
            <div id="admin-tab-users" class="admin-tab-content d-none-panel">
                <div class="section-header">
                    <h3 class="m-0">ðŸ‘¥ Utilisateurs inscrits</h3>
                    <input type="text" id="admin-user-search" placeholder="Rechercher..." oninput="app.Admin.filterUsers(this.value)" style="padding: 8px 15px; border: 1px solid var(--border); border-radius: 6px; width: 250px;">
                </div>
                <div id="admin-users-list" style="max-height: 500px; overflow-y: auto;">
                    <div class="empty-state">Chargement...</div>
                </div>
            </div>
            
            <!-- Contenu onglet Configuration -->
            <div id="admin-tab-config" class="admin-tab-content d-none-panel">
                <h3 style="margin: 0 0 20px 0;">âš™ï¸ Configuration prÃ©-alpha</h3>
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Limite utilisateurs -->
                    <div class="flex-row-center">
                        <label style="min-width: 200px; font-weight: bold;">Limite d'utilisateurs :</label>
                        <input type="number" id="config-max-users" value="150" style="padding: 10px; border: 1px solid var(--border); border-radius: 6px; width: 100px;">
                        <button onclick="app.Admin.updateMaxUsers()" style="padding: 10px 15px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer;">Appliquer</button>
                    </div>
                    <div style="padding: 15px; background: var(--bg); border-radius: 8px; color: var(--text-sec); font-size: 0.9rem;">
                        ðŸ’¡ La limite actuelle est de <strong id="config-current-limit">150</strong> utilisateurs. Il y a actuellement <strong id="config-current-users">-</strong> inscrits.
                    </div>
                    
                    <!-- Message prÃ©-alpha -->
                    <div style="border-top: 1px solid var(--border); padding-top: 20px;">
                        <h4 style="margin: 0 0 15px 0;">ðŸ“ Message d'accueil prÃ©-alpha</h4>
                        <div class="flex-col-gap10">
                            <div>
                                <label class="label-bold-block-5">Titre :</label>
                                <input type="text" id="config-prealpha-title" value="âš ï¸ VERSION PRÃ‰-ALPHA" style="padding: 10px; border: 1px solid var(--border); border-radius: 6px; width: 100%; max-width: 400px; background: var(--input-bg); color: var(--text-main);">
                            </div>
                            <div>
                                <label class="label-bold-block-5">Message :</label>
                                <textarea id="config-prealpha-message" rows="4" style="padding: 10px; border: 1px solid var(--border); border-radius: 6px; width: 100%; resize: vertical; background: var(--input-bg); color: var(--text-main);">Cette version est en cours de dÃ©veloppement. Des bugs peuvent survenir et certaines fonctionnalitÃ©s sont incomplÃ¨tes. Vos donnÃ©es peuvent Ãªtre perdues ou modifiÃ©es sans prÃ©avis. Utilisez cette version Ã  des fins de test uniquement.</textarea>
                            </div>
                            <div class="flex-gap10">
                                <button onclick="app.Admin.savePrealphaMessage()" class="btn-success">ðŸ’¾ Enregistrer</button>
                                <button onclick="app.Admin.previewPrealphaMessage()" class="n8-badge-15">ðŸ‘ï¸ PrÃ©visualiser</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contenu onglet Statistiques Connexions -->
            <div id="admin-tab-analytics" class="admin-tab-content d-none-panel">
                <div class="section-header-20">
                    <h3 class="m-0">ðŸ“ˆ Statistiques de connexion</h3>
                    <button onclick="app.Admin.loadConnectionStats()" class="btn-primary-sm2">ðŸ”„ Actualiser</button>
                </div>
                
                <!-- Stats rÃ©sumÃ© -->
                <div id="analytics-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div class="box-bg-center">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #3b82f6;" id="stat-today">-</div>
                        <div class="text-sec-sm2">Aujourd'hui</div>
                    </div>
                    <div class="box-bg-center">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #8b5cf6;" id="stat-week">-</div>
                        <div class="text-sec-sm2">Cette semaine</div>
                    </div>
                    <div class="box-bg-center">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #10b981;" id="stat-month">-</div>
                        <div class="text-sec-sm2">Ce mois</div>
                    </div>
                    <div class="box-bg-center">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #f59e0b;" id="stat-total-logins">-</div>
                        <div class="text-sec-sm2">Total connexions</div>
                    </div>
                </div>
                
                <!-- Graphiques -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <div style="background: var(--bg); border-radius: 8px; padding: 20px;">
                        <h4 class="subtitle-sec-15">ðŸ“… 7 derniers jours</h4>
                        <canvas id="chart-daily" style="width: 100%; height: 200px;"></canvas>
                    </div>
                    <div style="background: var(--bg); border-radius: 8px; padding: 20px;">
                        <h4 class="subtitle-sec-15">ðŸ“† 4 derniÃ¨res semaines</h4>
                        <canvas id="chart-weekly" style="width: 100%; height: 200px;"></canvas>
                    </div>
                </div>
                
                <div style="background: var(--bg); border-radius: 8px; padding: 20px; margin-top: 20px;">
                    <h4 class="subtitle-sec-15">ðŸ“Š 12 derniers mois</h4>
                    <canvas id="chart-monthly" style="width: 100%; height: 200px;"></canvas>
                </div>
            </div>
            
            <!-- Contenu onglet Emailing -->
            <div id="admin-tab-emailing" class="admin-tab-content d-none-panel">
                <h3 style="margin: 0 0 20px 0;">ðŸ“§ Emailing ciblÃ©</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Colonne gauche : Filtres -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <h4 class="heading-primary">ðŸŽ¯ SÃ©lectionner les destinataires</h4>
                        
                        <!-- Filtres prÃ©dÃ©finis -->
                        <div style="background: var(--bg); border-radius: 8px; padding: 15px;">
                            <label class="label-bold-block-10">Filtres rapides :</label>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <label class="flex-row-click">
                                    <input type="checkbox" id="filter-incomplete-profile" onchange="app.Admin.updateEmailFilter()" class="icon-sm">
                                    <span class="nowrap">ðŸ‘¤ Profil incomplet (&lt;50%)</span>
                                </label>
                                <label class="flex-row-click">
                                    <input type="checkbox" id="filter-no-public-profile" onchange="app.Admin.updateEmailFilter()" class="icon-sm">
                                    <span class="nowrap">ðŸ”’ Aucun profil public</span>
                                </label>
                                <label class="flex-row-click">
                                    <input type="checkbox" id="filter-no-project" onchange="app.Admin.updateEmailFilter()" class="icon-sm">
                                    <span class="nowrap">ðŸ“ Aucun projet crÃ©Ã©</span>
                                </label>
                                <label class="flex-row-click">
                                    <input type="checkbox" id="filter-inactive-project" onchange="app.Admin.updateEmailFilter()" class="icon-sm">
                                    <span class="nowrap">ðŸ’¤ Projet inactif (&gt;30 jours)</span>
                                </label>
                                <label class="flex-row-click">
                                    <input type="checkbox" id="filter-new-users" onchange="app.Admin.updateEmailFilter()" class="icon-sm">
                                    <span class="nowrap">ðŸ†• Nouveaux inscrits (&lt;7 jours)</span>
                                </label>
                                <label class="flex-row-click">
                                    <input type="checkbox" id="filter-inactive-users" onchange="app.Admin.updateEmailFilter()" class="icon-sm">
                                    <span class="nowrap">ðŸ˜´ Utilisateurs inactifs (&gt;30 jours)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Filtre par type de profil -->
                        <div style="background: var(--bg); border-radius: 8px; padding: 15px;">
                            <label class="label-bold-block-10">Par type de profil :</label>
                            <div class="flex-wrap-gap8">
                                <label class="flex-click-5">
                                    <input type="checkbox" id="filter-type-actor" onchange="app.Admin.updateEmailFilter()">
                                    <span>ðŸŽ­ ComÃ©diens</span>
                                </label>
                                <label class="flex-click-5">
                                    <input type="checkbox" id="filter-type-crew" onchange="app.Admin.updateEmailFilter()">
                                    <span>ðŸŽ¥ Techniciens</span>
                                </label>
                                <label class="flex-click-5">
                                    <input type="checkbox" id="filter-type-association" onchange="app.Admin.updateEmailFilter()">
                                    <span>ðŸ›ï¸ Associations</span>
                                </label>
                                <label class="flex-click-5">
                                    <input type="checkbox" id="filter-type-enterprise" onchange="app.Admin.updateEmailFilter()">
                                    <span>ðŸ¢ Entreprises</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- RÃ©sultat filtres -->
                        <div style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)); border: 1px solid var(--primary); border-radius: 8px; padding: 15px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="email-recipients-count">0</div>
                            <div class="text-sec">destinataires sÃ©lectionnÃ©s</div>
                            <button onclick="app.Admin.showRecipientsList()" style="margin-top: 10px; padding: 8px 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.85rem;">ðŸ‘ï¸ Voir la liste</button>
                        </div>
                    </div>
                    
                    <!-- Colonne droite : Composition du mail -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <h4 class="heading-primary">âœï¸ Composer le message</h4>
                        
                        <div>
                            <label class="label-bold-block-5">Objet :</label>
                            <input type="text" id="email-subject" placeholder="Objet de l'email..." style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg);">
                        </div>
                        
                        <div>
                            <label class="label-bold-block-5">Message :</label>
                            <textarea id="email-body" placeholder="Bonjour {nom},&#10;&#10;Votre message ici...&#10;&#10;L'Ã©quipe Moteur" style="width: 100%; height: 250px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); resize: vertical; font-family: inherit;"></textarea>
                            <div style="margin-top: 5px; font-size: 0.8rem; color: var(--text-sec);">
                                ðŸ’¡ Variables disponibles : <code>{nom}</code>, <code>{email}</code>, <code>{date_inscription}</code>
                            </div>
                        </div>
                        
                        <!-- Templates rapides -->
                        <div>
                            <label class="label-bold-block-5">Templates :</label>
                            <select id="email-template" onchange="app.Admin.loadEmailTemplate(this.value)" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg);">
                                <option value="">-- Choisir un template --</option>
                                <option value="welcome">ðŸ‘‹ Bienvenue</option>
                                <option value="complete-profile">ðŸ‘¤ ComplÃ©ter son profil</option>
                                <option value="reactivation">ðŸ”„ RÃ©activation</option>
                                <option value="new-feature">ðŸ†• Nouvelle fonctionnalitÃ©</option>
                                <option value="feedback">ðŸ’¬ Demande de feedback</option>
                            </select>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="app.Admin.previewEmail()" style="flex: 1; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: bold;">ðŸ‘ï¸ PrÃ©visualiser</button>
                            <button onclick="app.Admin.sendEmails()" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ðŸ“¤ Envoyer</button>
                        </div>
                        
                        <div style="padding: 10px; background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 6px; font-size: 0.85rem; color: #f59e0b;">
                            âš ï¸ Les emails seront envoyÃ©s via EmailJS. VÃ©rifiez votre quota avant l'envoi.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<input type="file" id="importInput" accept=".fdx,.xml,.pdf" class="d-none" onchange="app.Importer.handleFileSelect(event)">

    <!-- HUB CENTRAL -->
    <div id="hub-content" class="hub-main">
      <div class="hub-welcome">
        <h2 id="hub-welcome-title">Bienvenue</h2>
        <p class="hub-welcome-sub" id="hub-welcome-sub"></p>
      </div>
      <div class="hub-onboarding d-none" id="hub-onboarding">
        <div class="hub-onboarding-icon">ðŸŽ¬</div>
        <div>
          <h3>Bienvenue sur Moteur !</h3>
          <p>ComplÃ©tez votre profil pour apparaÃ®tre dans l'Univers et crÃ©ez votre premier projet.</p>
          <div class="hub-ob-steps">
            <span class="hub-ob-step done">âœ“ Compte crÃ©Ã©</span>
            <span class="hub-ob-step" id="hub-ob-profile">â—‹ Profil complÃ©tÃ©</span>
            <span class="hub-ob-step" id="hub-ob-project">â—‹ Premier projet</span>
          </div>
        </div>
        <button class="hub-ob-dismiss" onclick="document.getElementById('hub-onboarding').style.display='none'; app.PreferencesSync.save('moteur_ob_dismissed','1')">Masquer</button>
      </div>
      <div class="hub-customize-bar"><button class="hub-customize-btn" onclick="app.Hub.toggleCustomize()">âš™ï¸ Personnaliser</button></div>
      <div class="hub-cards" id="hub-cards"></div>
      <div class="hub-section-title">ðŸ“Š Statistiques</div>
      <div class="hub-stats" id="hub-stats">
        <div class="hub-stat"><div class="hub-stat-value" id="hub-stat-projects">-</div><div class="hub-stat-label">Mes projets</div></div>
        <div class="hub-stat"><div class="hub-stat-value" id="hub-stat-profiles">-</div><div class="hub-stat-label">Profils Univers</div></div>
        <div class="hub-stat"><div class="hub-stat-value" id="hub-stat-forum">-</div><div class="hub-stat-label">Sujets Forum</div></div>
        <div class="hub-stat"><div class="hub-stat-value" id="hub-stat-messages">-</div><div class="hub-stat-label">Messages</div></div>
      </div>
    </div>
  </div>

    <!-- Univers (sortie du dashboard, vue indÃ©pendante) -->
    <div id="universe-view" style="display:none; flex-direction:column; height:100%; width:100%;">
        <div class="forum-header">
            <div class="flex-row-center">
                <button onclick="app.Universe.closeToHub()" class="btn-secondary">â¬… Retour</button>
                <h1>ðŸ—ºï¸ Univers</h1>
            </div>
            <div class="flex-row-gap10">
                <button class="theme-btn" onclick="app.UI.toggleTheme()">ðŸŒ“ Mode</button>
            </div>
        </div>
        <div class="universe-container flex-1">
        <!-- Sidebar Filtres -->
        <div class="universe-sidebar" style="width: 280px; min-width: 280px; background: var(--panel-bg); border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
            
            <!-- Matching intelligent -->
            <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(236,72,153,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; padding: 12px;">
                <h4 style="margin: 0 0 8px 0; font-size: 0.95rem; color: #8b5cf6;">ðŸŽ¯ Projets pour moi</h4>
                <select id="universe-my-profile" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); margin-bottom: 8px; font-size: 0.85rem;">
                    <option value="">-- Mon profil --</option>
                </select>
                <button onclick="app.MatchingEngine.findProjectsForMe()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.85rem;">ðŸŽ¯ Matcher</button>
                <div id="matching-results-count" style="display: none; margin-top: 6px; text-align: center; font-size: 0.8rem; color: var(--text-sec);"></div>
            </div>
            
            <h3 style="margin: 0; font-size: 1.1rem; color: var(--primary);">ðŸ” Recherche</h3>
            
            <div class="flex-col-gap10">
                <select id="universe-type" onchange="app.Universe.onTypeChange()" data-tooltip="SÃ©lectionnez une catÃ©gorie pour filtrer instantanÃ©ment la carte" class="form-input">
                    <option value="">-- Tous --</option>
                    <option value="actor">ðŸŽ­ ComÃ©diens</option>
                    <option value="crew">ðŸŽ¥ Techniciens</option>
                    <option value="association">ðŸ›ï¸ Associations</option>
                    <option value="enterprise">ðŸ¢ Entreprises</option>
                    <option value="project">ðŸŽ¬ Projets</option>
                </select>
                
                <input type="text" id="universe-city" placeholder="ðŸ“ Ville..." class="form-input">
                
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="text-sec-sm2">Distance:</span>
                    <input type="range" id="universe-distance" min="0" max="500" value="50" class="flex-1" onchange="document.getElementById('universe-distance-label').textContent = this.value == 500 ? 'âˆž' : this.value + ' km'">
                    <span id="universe-distance-label" style="min-width: 45px; font-size: 0.85rem;">50 km</span>
                </div>
            </div>
            
            <!-- Filtres Techniciens -->
            <div id="universe-filters-crew" class="d-none-col">
                <div class="label-sec">Filtres Techniciens</div>
                <select id="universe-department" onchange="app.Universe.onDepartmentChange()" class="form-input-sm">
                    <option value="">-- DÃ©partement --</option>
                </select>
                <select id="universe-crew-role" class="form-input-sm">
                    <option value="">-- Fonction --</option>
                </select>
            </div>
            
            <!-- Filtres ComÃ©diens -->
            <div id="universe-filters-actor" class="d-none-col">
                <div class="label-sec">Filtres ComÃ©diens</div>
                <select id="universe-actor-gender" class="form-input-sm">
                    <option value="">-- Sexe --</option>
                    <option value="homme">Homme</option>
                    <option value="femme">Femme</option>
                    <option value="non-binaire">Non-binaire</option>
                </select>
                <div class="flex-gap5">
                    <input type="number" id="universe-actor-age-min" placeholder="Ã‚ge min" class="flex-input">
                    <input type="number" id="universe-actor-age-max" placeholder="Ã‚ge max" class="flex-input">
                </div>
                <div class="flex-gap5">
                    <input type="number" id="universe-actor-height-min" placeholder="Taille min (cm)" class="flex-input">
                    <input type="number" id="universe-actor-height-max" placeholder="Taille max (cm)" class="flex-input">
                </div>
                <div class="flex-gap5">
                    <input type="number" id="universe-actor-weight-min" placeholder="Poids min (kg)" class="flex-input">
                    <input type="number" id="universe-actor-weight-max" placeholder="Poids max (kg)" class="flex-input">
                </div>
                <select id="universe-actor-eyes" class="form-input-sm">
                    <option value="">-- Couleur des yeux --</option>
                    <option value="marron">Marron</option>
                    <option value="bleu">Bleu</option>
                    <option value="vert">Vert</option>
                    <option value="gris">Gris</option>
                    <option value="noisette">Noisette</option>
                    <option value="noir">Noir</option>
                </select>
                <select id="universe-actor-hair" class="form-input-sm">
                    <option value="">-- Couleur cheveux --</option>
                    <option value="noir">Noir</option>
                    <option value="brun">Brun</option>
                    <option value="chatain">ChÃ¢tain</option>
                    <option value="blond">Blond</option>
                    <option value="roux">Roux</option>
                    <option value="gris">Gris</option>
                    <option value="blanc">Blanc</option>
                    <option value="chauve">Chauve</option>
                </select>
                <select id="universe-actor-hair-length" class="form-input-sm">
                    <option value="">-- Longueur cheveux --</option>
                    <option value="chauve">Chauve</option>
                    <option value="rase">RasÃ©</option>
                    <option value="court">Court</option>
                    <option value="mi-long">Mi-long</option>
                    <option value="long">Long</option>
                </select>
                <select id="universe-actor-ethnicity" class="form-input-sm">
                    <option value="">-- Origine ethnique --</option>
                    <option value="caucasien">Caucasien</option>
                    <option value="africain">Africain / Afro-descendant</option>
                    <option value="asiatique">Asiatique</option>
                    <option value="latino">Latino / Hispanique</option>
                    <option value="maghrebin">MaghrÃ©bin</option>
                    <option value="moyenorient">Moyen-Orient</option>
                    <option value="indien">Indien / Sud-asiatique</option>
                    <option value="metis">MÃ©tis</option>
                    <option value="autre">Autre</option>
                </select>
                <select id="universe-actor-corpulence" class="form-input-sm">
                    <option value="">-- Corpulence --</option>
                    <option value="mince">Mince</option>
                    <option value="normal">Normal</option>
                    <option value="athletique">AthlÃ©tique</option>
                    <option value="muscle">MusclÃ©</option>
                    <option value="rond">Rond</option>
                    <option value="fort">Fort / Costaud</option>
                </select>
                <input type="text" id="universe-actor-sports" placeholder="ðŸƒ Sports (Ã©quitation...)" class="form-input-sm">
                <input type="text" id="universe-actor-languages" placeholder="ðŸ—£ï¸ Langues (anglais...)" class="form-input-sm">
            </div>
            
            <!-- Filtres Associations -->
            <div id="universe-filters-association" class="d-none-col">
                <div class="label-sec">Filtres Associations</div>
                <select id="universe-association-type" class="form-input-sm">
                    <option value="">-- Type d'association --</option>
                </select>
            </div>
            
            <!-- Filtres Entreprises -->
            <div id="universe-filters-enterprise" class="d-none-col">
                <div class="label-sec">Filtres Entreprises</div>
                <select id="universe-enterprise-type" class="form-input-sm">
                    <option value="">-- Type d'entreprise --</option>
                </select>
            </div>
            
            <!-- Filtre Type de collaboration (commun acteurs/techniciens) -->
            <div id="universe-filters-collab" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px;">
                <div class="label-sec">Type de collaboration</div>
                <select id="universe-collab-type" class="form-input-sm">
                    <option value="">-- Tous --</option>
                    <option value="pro">ðŸŽ¬ Pro uniquement</option>
                    <option value="semi-pro">âš¡ Semi-pro</option>
                    <option value="benevole">â¤ï¸ BÃ©nÃ©vole</option>
                </select>
                <select id="universe-status-type" class="form-input-sm">
                    <option value="">-- Tous statuts --</option>
                    <option value="intermittent">IntermittentÂ·e</option>
                    <option value="micro-entrepreneur">Micro-entrepreneurÂ·e</option>
                    <option value="amateur">AmateurÂ·rice</option>
                </select>
            </div>
            
            <!-- Filtre vÃ©hicule (commun) -->
            <div id="universe-filters-vehicle" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="universe-has-vehicle">
                    ðŸš— Avec vÃ©hicule
                </label>
            </div>
            
            <!-- Filtre Type de production (pour projets) -->
            <div id="universe-filters-production-type" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px;">
                <div class="label-sec">Type de production</div>
                <select id="universe-production-type" class="form-input-sm">
                    <option value="">-- Tous --</option>
                    <option value="pro">ðŸŽ¬ Production Pro</option>
                    <option value="semi-pro">âš¡ Production Semi-pro</option>
                    <option value="benevole">â¤ï¸ Production BÃ©nÃ©vole</option>
                </select>
            </div>
            
            <!-- Filtres Projets -->
            <div id="universe-filters-project" class="d-none-col">
                <div class="label-sec">Filtres Projets</div>
                <select id="universe-project-type" class="form-input-sm">
                    <option value="">-- Type de projet --</option>
                    <option value="court-metrage">Court-mÃ©trage</option>
                    <option value="long-metrage">Long-mÃ©trage</option>
                    <option value="serie">SÃ©rie / Web-sÃ©rie</option>
                    <option value="documentaire">Documentaire</option>
                    <option value="clip">Clip musical</option>
                    <option value="pub">PublicitÃ©</option>
                    <option value="corporate">Film corporate</option>
                </select>
                <select id="universe-project-genre" class="form-input-sm">
                    <option value="">-- Genre --</option>
                    <option value="drame">Drame</option>
                    <option value="comedie">ComÃ©die</option>
                    <option value="thriller">Thriller</option>
                    <option value="horreur">Horreur</option>
                    <option value="sf">Science-Fiction</option>
                    <option value="fantastique">Fantastique</option>
                    <option value="action">Action</option>
                    <option value="romance">Romance</option>
                </select>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="universe-project-has-actor-needs">
                    Cherche comÃ©diens
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="universe-project-has-crew-needs">
                    Cherche techniciens
                </label>
            </div>
            
            <!-- Boutons -->
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button onclick="app.Universe.search()" data-tooltip="Applique tous les filtres dÃ©taillÃ©s (Ã¢ge, physique, compÃ©tences...)" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">ðŸ” Rechercher</button>
                <button onclick="app.Universe.reset()" data-tooltip="Efface tous les filtres et affiche tous les profils" style="width: 100%; padding: 10px; background: var(--bg); color: var(--text-main); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">â†º RÃ©initialiser</button>
            </div>
            
            </div>
        
        <!-- Zone des cartes flottantes -->
        <div class="universe-view-toggle" id="universe-view-toggle">
            <button onclick="app.Universe.setViewMode('map')" id="view-mode-map" class="active" style="padding:8px 12px; border:none; background:var(--primary); color:white; border-radius:6px 0 0 6px; cursor:pointer;">ðŸ—ºï¸ Carte</button>
            <button onclick="app.Universe.setViewMode('fan')" id="view-mode-fan" style="padding:8px 12px; border:none; background:var(--bg); color:var(--text-main); border-radius:0 6px 6px 0; cursor:pointer; border:1px solid var(--border);">ðŸ“‡ Liste</button>
        </div>
        <div class="universe-scene" id="universe-scene" style="flex: 1; position: relative;">
            <div id="universe-map"></div>
            <div id="map-hover-card" class="map-hover-card d-none"></div>
            <!-- Les cartes flottantes apparaÃ®tront ici -->
        </div>
    </div>
    </div>

  <div id="projects-view" style="display:none; flex-direction:column; height:100%; width:100%; background:var(--bg); overflow-y:auto;">
    <div class="forum-header">
        <div class="flex-row-center">
            <button onclick="app.Universe.closeProjects()" class="btn-secondary">â¬… Retour</button>
            <h1>ðŸ“ Mes Projets</h1>
        </div>
        <div class="flex-row-gap10">
            <button class="theme-btn" onclick="app.UI.toggleTheme()">ðŸŒ“ Mode</button>
        </div>
    </div>
    <div style="padding:40px; overflow-y:auto;">
      <div id="project-list" class="project-grid"></div>
    </div>
  </div>
  
  <div id="public-profile-view" class="public-profile-view">
    <div class="public-profile-header">
        <div class="flex-row-center">
            <button onclick="app.PublicProfile.close()" class="btn-secondary">â¬… Retour</button>
            <div class="messages-tabs" style="margin:0; border:none; padding:0;">
                <button class="messages-tab active" onclick="app.PublicProfile.showTab('profile')" id="profile-tab-btn">ðŸ‘¤ Mes Profils</button>
                <button class="messages-tab" onclick="app.PublicProfile.showTab('messages')" id="messages-tab-btn">ðŸ“¬ Messages <span class="badge d-none" id="messages-badge">0</span></button>
            </div>
            <h1 id="profile-title">ðŸŽ­ Mes Profils Publics</h1>
        </div>
        <div class="flex-row-gap10">
            <button onclick="app.PublicProfile.saveCurrentProfile()" style="background:var(--success); color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer">ðŸ’¾ Sauvegarder</button>
            <button class="theme-btn" onclick="app.UI.toggleTheme()">ðŸŒ“ Mode</button>
        </div>
    </div>
    <div class="public-profile-body">
        <!-- Conteneur Profil -->
        <div id="profile-content">
        
        <!-- Onglets de profils -->
        <div class="mb-20">
            <div id="profile-tabs-container" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px;">
                <!-- Les onglets seront gÃ©nÃ©rÃ©s dynamiquement -->
            </div>
            <p class="text-sec-sm2">ðŸ’¡ Vous pouvez crÃ©er plusieurs profils (comÃ©dien, technicien...). Chaque profil apparaÃ®tra comme une carte distincte dans l'Univers. Nous recommandons 2 profils maximum.</p>
        </div>
        
        <!-- Contenu du profil sÃ©lectionnÃ© (cachÃ© jusqu'au chargement) -->
        <div id="current-profile-content" class="d-none">
            <!-- Section profils Ã  revendiquer -->
            <div id="pending-claims-section" style="display: none; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">ðŸŽ</span> Profils crÃ©Ã©s pour vous
                    </h3>
                    <p style="margin: 0 0 15px 0; opacity: 0.9; font-size: 0.9rem;">Des porteurs de projets ont crÃ©Ã© ces profils Ã  votre nom. Revendiquez-les pour les complÃ©ter et apparaÃ®tre dans l'Univers !</p>
                    <div id="pending-claims-list" class="flex-col-gap10"></div>
                </div>
            </div>
            
            <!-- Message si aucun profil -->
            <div id="no-profile-message" style="display: none; text-align: center; padding: 60px 20px; background: var(--panel-bg); border: 2px dashed var(--border); border-radius: 12px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">ðŸ‘¤</div>
                <h2 class="mb-10">Bienvenue !</h2>
                <p class="text-sec-mb20">CrÃ©ez votre premier profil pour apparaÃ®tre dans l'Univers et Ãªtre trouvÃ© par les productions.</p>
                <button onclick="app.PublicProfile.createNewProfile()" style="padding: 15px 30px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">âž• CrÃ©er mon premier profil</button>
            </div>
            
            <!-- Formulaire de profil (cachÃ© par dÃ©faut) -->
            <div id="profile-form-container" class="d-none">
            </div>
            
            <!-- Toutes les sections du profil (masquÃ©es si aucun profil) -->
            <div id="profile-all-sections" class="d-none">
                <div id="profile-status" class="profile-status incomplete">
                    âš ï¸ Ce profil est incomplet. Remplissez les champs obligatoires pour apparaÃ®tre dans les recherches.
                </div>
                
                <!-- Choix du type de profil -->
                <div class="profile-section">
                    <h3>ðŸŽ¯ Type de profil</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <label class="profile-type-card" id="profile-type-actor-label">
                            <input type="radio" name="profile-type" value="actor" id="profile-type-actor" onchange="app.PublicProfile.onProfileTypeChange()" class="d-none">
                            <span class="profile-type-icon">ðŸŽ­</span>
                            <span class="profile-type-name">ComÃ©dien.ne</span>
                        </label>
                        <label class="profile-type-card" id="profile-type-crew-label">
                            <input type="radio" name="profile-type" value="crew" id="profile-type-crew" onchange="app.PublicProfile.onProfileTypeChange()" class="d-none">
                            <span class="profile-type-icon">ðŸŽ¥</span>
                            <span class="profile-type-name">Technicien.ne</span>
                        </label>
                        <label class="profile-type-card" id="profile-type-association-label">
                            <input type="radio" name="profile-type" value="association" id="profile-type-association" onchange="app.PublicProfile.onProfileTypeChange()" class="d-none">
                            <span class="profile-type-icon">ðŸ›ï¸</span>
                            <span class="profile-type-name">Association</span>
                        </label>
                        <label class="profile-type-card" id="profile-type-enterprise-label">
                            <input type="radio" name="profile-type" value="enterprise" id="profile-type-enterprise" onchange="app.PublicProfile.onProfileTypeChange()" class="d-none">
                            <span class="profile-type-icon">ðŸ¢</span>
                            <span class="profile-type-name">Entreprise</span>
                        </label>
                    </div>
                </div>
                
                <!-- Section IdentitÃ© -->
                <div class="profile-section" data-section="identity">
                    <h3>
                        <span class="section-title">ðŸ‘¤ IdentitÃ©</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="identity" data-scope="public" onclick="app.PublicProfile.toggleVisibility('identity', 'public')" data-tooltip="Visible dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="identity" data-scope="project" onclick="app.PublicProfile.toggleVisibility('identity', 'project')" data-tooltip="Visible par l'Ã©quipe">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <div class="profile-photo-section">
                        <div class="profile-photo-preview" id="profile-photo-preview">ðŸ‘¤</div>
                        <div class="flex-1">
                            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                                <button type="button" onclick="document.getElementById('profile-photo-input').click()" class="profile-input" style="background:var(--primary); color:white; cursor:pointer; padding:10px 20px; border:none; font-weight:600;">ðŸ“· Choisir une photo</button>
                                <input type="file" id="profile-photo-input" accept="image/*" class="d-none" onchange="app.PublicProfile.handlePhotoUpload(event)">
                                <span id="profile-photo-status" class="text-sec-sm2"></span>
                            </div>
                            <input type="hidden" id="profile-photo" value="">
                            <p style="font-size:0.8rem; color:var(--text-sec);">Formats acceptÃ©s : JPG, PNG, GIF (max 2 Mo, redimensionnÃ© Ã  800px)</p>
                        </div>
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-name" placeholder="Nom complet *">
                        <select class="profile-input" id="profile-gender">
                            <option value="">-- Sexe * --</option>
                            <option value="homme">Homme</option>
                            <option value="femme">Femme</option>
                            <option value="non-binaire">Non-binaire</option>
                            <option value="non-precise">Ne souhaite pas prÃ©ciser</option>
                        </select>
                    </div>
                    <div class="profile-row">
                        <input type="email" class="profile-input" id="profile-email" placeholder="Email *" readonly>
                        <input type="tel" class="profile-input" id="profile-phone" placeholder="TÃ©lÃ©phone *">
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-city" placeholder="Ville / RÃ©gion *">
                        <input type="text" class="profile-input" id="profile-website" placeholder="Site web / Portfolio">
                    </div>
                    <div class="profile-row">
                        <div class="address-autocomplete-container" style="flex: 1; position: relative;">
                            <input type="text" class="profile-input" id="profile-address" placeholder="Adresse complÃ¨te * (pour la gÃ©olocalisation)" autocomplete="off" oninput="app.PublicProfile.searchAddress(this.value)">
                            <div id="profile-address-suggestions" class="address-suggestions"></div>
                        </div>
                    </div>
                    <div id="profile-address-privacy" class="profile-row" style="display: none; flex-direction: column; gap: 8px; background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 5px;">
                        <div class="text-sec-sm2">ðŸ”’ ConfidentialitÃ© de l'adresse</div>
                        <label id="profile-hide-address-label" style="display: none; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="profile-hide-address">
                            <span>Masquer mon adresse rÃ©elle sur la carte (afficher une position approximative)</span>
                        </label>
                        <label id="profile-hide-address-projects-label" style="display: none; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="profile-hide-address-projects">
                            <span>Masquer aussi mon adresse dans les projets (visible uniquement par moi)</span>
                        </label>
                        <div id="profile-address-info" style="display: none; font-size: 0.8rem; color: var(--text-sec); font-style: italic; margin-top: 5px;">
                            â„¹ï¸ Pour les comÃ©dienÂ·nes et technicienÂ·nes, l'adresse exacte n'est jamais affichÃ©e publiquement dans l'Univers (seulement la ville).
                        </div>
                    </div>
                    <textarea class="profile-input profile-textarea" id="profile-bio" placeholder="Bio / PrÃ©sentation"></textarea>
                </div>

                <!-- Section ComÃ©dien - Description Physique (visible si actor) -->
                <div class="profile-section d-none" id="profile-actor-physical-section" data-section="physical">
                    <h3>
                        <span class="section-title">ðŸ“ Description Physique</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="physical" data-scope="public" onclick="app.PublicProfile.toggleVisibility('physical', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="physical" data-scope="project" onclick="app.PublicProfile.toggleVisibility('physical', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <div class="profile-row">
                        <input type="number" class="profile-input" id="profile-height" placeholder="Taille (cm)">
                        <input type="number" class="profile-input" id="profile-weight" placeholder="Poids (kg)">
                        <input type="number" class="profile-input" id="profile-age" placeholder="Ã‚ge">
                    </div>
                    <div class="profile-row">
                        <select class="profile-input" id="profile-eyes">
                            <option value="">-- Couleur des yeux --</option>
                            <option value="marron">Marron</option>
                            <option value="bleu">Bleu</option>
                            <option value="vert">Vert</option>
                            <option value="gris">Gris</option>
                            <option value="noisette">Noisette</option>
                            <option value="noir">Noir</option>
                        </select>
                        <select class="profile-input" id="profile-hair-color">
                          <option value="">-- Couleur cheveux --</option>
                            <option value="noir">Noir</option>
                            <option value="brun">Brun</option>
                            <option value="chatain">ChÃ¢tain</option>
                            <option value="blond">Blond</option>
                            <option value="roux">Roux</option>
                            <option value="gris">Gris / Poivre et sel</option>
                            <option value="blanc">Blanc</option>
                            <option value="chauve">Chauve</option>
                        </select>
                        <select class="profile-input" id="profile-hair-length">
                            <option value="">-- Longueur cheveux --</option>
                            <option value="chauve">Chauve</option>
                            <option value="rase">RasÃ© / TrÃ¨s court</option>
                            <option value="court">Court</option>
                            <option value="mi-long">Mi-long</option>
                            <option value="long">Long</option>
                        </select>
                   </div>
                    <div class="profile-row">
                        <select class="profile-input" id="profile-ethnicity">
                            <option value="">-- Apparence ethnique --</option>
                            <option value="caucasien">Caucasien / EuropÃ©en</option>
                            <option value="africain">Africain / Afro-descendant</option>
                            <option value="maghrebin">MaghrÃ©bin / Moyen-Oriental</option>
                            <option value="asiatique">Asiatique</option>
                            <option value="latino">Latino / Hispanique</option>
                            <option value="indien">Indien / Sud-Asiatique</option>
                            <option value="metis">MÃ©tis / Mixte</option>
                            <option value="autre">Autre</option>
                        </select>
                        <select class="profile-input" id="profile-corpulence">
                            <option value="">-- Corpulence --</option>
                            <option value="mince">Mince</option>
                            <option value="normale">Normale</option>
                            <option value="athletique">AthlÃ©tique</option>
                            <option value="ronde">Ronde</option>
                            <option value="forte">Forte</option>
                        </select>
                    </div>
                    <!-- Langues avec niveaux -->
                    <div class="mt-15">
                        <label class="label-bold-block-10">ðŸ—£ï¸ Langues parlÃ©es</label>
                        <div id="profile-languages-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                        <div class="flex-gap8">
                            <select class="profile-input flex-1" id="profile-language-select">
                                <option value="">-- Ajouter une langue --</option>
                                <option value="FranÃ§ais">FranÃ§ais</option>
                                <option value="Anglais">Anglais</option>
                                <option value="Espagnol">Espagnol</option>
                                <option value="Allemand">Allemand</option>
                                <option value="Italien">Italien</option>
                                <option value="Portugais">Portugais</option>
                                <option value="Arabe">Arabe</option>
                                <option value="Chinois">Chinois</option>
                                <option value="Japonais">Japonais</option>
                                <option value="Russe">Russe</option>
                                <option value="NÃ©erlandais">NÃ©erlandais</option>
                                <option value="Polonais">Polonais</option>
                                <option value="Turc">Turc</option>
                                <option value="CorÃ©en">CorÃ©en</option>
                                <option value="Hindi">Hindi</option>
                                <option value="__custom__">Autre...</option>
                            </select>
                            <select class="profile-input" id="profile-language-level" style="width: auto;">
                                <option value="notions">Notions</option>
                                <option value="intermediaire">IntermÃ©diaire</option>
                                <option value="courant" selected>Courant</option>
                                <option value="bilingue">Bilingue</option>
                                <option value="maternelle">Maternelle</option>
                            </select>
                            <button type="button" onclick="app.PublicProfile.addLanguage()" class="btn-primary-sm2">+</button>
                        </div>
                    </div>
    
                    <!-- Sports avec niveaux -->
                    <div class="mt-15">
                        <label class="label-bold-block-10">ðŸƒ Sports & CompÃ©tences</label>
                        <div id="profile-sports-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
                        <div class="flex-gap8">
                            <select class="profile-input flex-1" id="profile-sport-select">
                                <option value="">-- Ajouter un sport --</option>
                                <option value="Ã‰quitation">Ã‰quitation</option>
                                <option value="Natation">Natation</option>
                                <option value="Arts martiaux">Arts martiaux</option>
                                <option value="Danse">Danse</option>
                                <option value="Yoga">Yoga</option>
                                <option value="Tennis">Tennis</option>
                                <option value="Football">Football</option>
                                <option value="Basketball">Basketball</option>
                                <option value="Boxe">Boxe</option>
                                <option value="Escalade">Escalade</option>
                                <option value="Ski">Ski</option>
                                <option value="Surf">Surf</option>
                                <option value="Cyclisme">Cyclisme</option>
                                <option value="Course Ã  pied">Course Ã  pied</option>
                                <option value="Gymnastique">Gymnastique</option>
                                <option value="Escrime">Escrime</option>
                                <option value="Tir">Tir</option>
                                <option value="Conduite sportive">Conduite sportive</option>
                                <option value="Moto">Moto</option>
                                <option value="PlongÃ©e">PlongÃ©e</option>
                                <option value="__custom__">Autre...</option>
                            </select>
                            <select class="profile-input" id="profile-sport-level" style="width: auto;">
                                <option value="debutant">DÃ©butant</option>
                                <option value="amateur">Amateur</option>
                                <option value="confirme" selected>ConfirmÃ©</option>
                                <option value="competition">CompÃ©tition</option>
                                <option value="professionnel">Professionnel</option>
                            </select>
                            <button type="button" onclick="app.PublicProfile.addSport()" class="btn-primary-sm2">+</button>
                        </div>
                    </div>
                    <!-- Champs cachÃ©s pour compatibilitÃ© -->
                    <input type="hidden" id="profile-sports">
                    <input type="hidden" id="profile-languages">
                </div>

                <!-- Section ComÃ©dien - Galerie Photos (visible si actor) -->
                <div class="profile-section d-none" id="profile-actor-section" data-section="gallery">
                    <h3>
                        <span class="section-title">ðŸ“¸ Galerie Photos</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="gallery" data-scope="public" onclick="app.PublicProfile.toggleVisibility('gallery', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="gallery" data-scope="project" onclick="app.PublicProfile.toggleVisibility('gallery', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <p class="text-sec-sm-mb10">Ajoutez jusqu'Ã  3 photos pour votre book (format carrÃ© recommandÃ©)</p>
                    <div class="actor-gallery" id="actor-gallery">
                        <div class="actor-gallery-item" id="gallery-item-0" onclick="document.getElementById('gallery-file-0').click()">
                            <span class="gallery-placeholder">+</span>
                        </div>
                        <div class="actor-gallery-item" id="gallery-item-1" onclick="document.getElementById('gallery-file-1').click()">
                            <span class="gallery-placeholder">+</span>
                        </div>
                        <div class="actor-gallery-item" id="gallery-item-2" onclick="document.getElementById('gallery-file-2').click()">
                            <span class="gallery-placeholder">+</span>
                        </div>
                    </div>
                    <input type="file" id="gallery-file-0" accept="image/*" class="d-none" onchange="app.PublicProfile.uploadGalleryPhoto(0, event)">
                    <input type="file" id="gallery-file-1" accept="image/*" class="d-none" onchange="app.PublicProfile.uploadGalleryPhoto(1, event)">
                    <input type="file" id="gallery-file-2" accept="image/*" class="d-none" onchange="app.PublicProfile.uploadGalleryPhoto(2, event)">
                    <input type="hidden" id="gallery-input-0" value="">
                    <input type="hidden" id="gallery-input-1" value="">
                    <input type="hidden" id="gallery-input-2" value="">
                </div>

                <!-- Section ComÃ©dien - Bande DÃ©mo (visible si actor) -->
                <div class="profile-section d-none" id="profile-actor-demoreel-section" data-section="demoreel">
                    <h3>
                        <span class="section-title">ðŸŽ¬ Bande DÃ©mo</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="demoreel" data-scope="public" onclick="app.PublicProfile.toggleVisibility('demoreel', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="demoreel" data-scope="project" onclick="app.PublicProfile.toggleVisibility('demoreel', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <p class="text-sec-sm-mb10">Ajoutez le lien vers votre bande dÃ©mo (YouTube, Vimeo, etc.)</p>
                    <input type="url" class="profile-input" id="profile-demoreel" placeholder="https://www.youtube.com/watch?v=...">
                    <div id="demoreel-preview" class="mt-15-d-none">
                        <iframe id="demoreel-iframe" width="100%" height="315" frameborder="0" allowfullscreen class="br-8"></iframe>
                    </div>
                </div>
        
                <!-- Section Technicien (visible si crew) -->
                <div class="profile-section d-none" id="profile-crew-section" data-section="skills">
                    <h3>
                        <span class="section-title">ðŸŽ¬ MÃ©tier & CompÃ©tences</span>
                <div class="visibility-toggles">
                    <button type="button" class="visibility-btn" data-section="skills" data-scope="public" onclick="app.PublicProfile.toggleVisibility('skills', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                    <button type="button" class="visibility-btn" data-section="skills" data-scope="project" onclick="app.PublicProfile.toggleVisibility('skills', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                </div>
            </h3>
            <div class="profile-row">
             <select class="profile-input" id="profile-department" onchange="app.PublicProfile.updateRoleOptions()">
    <option value="">-- DÃ©partement * --</option>
    <option value="gc1">ðŸ“¹ Image</option>
    <option value="gc2">ðŸ’¡ LumiÃ¨re</option>
    <option value="gc3">ðŸŽ¬ RÃ©alisation</option>
    <option value="gc4">ðŸŽ¤ Son</option>
    <option value="gc5">ðŸŽ¨ DÃ©coration</option>
    <option value="gc6">ðŸ‘— Costumes</option>
    <option value="gc7">ðŸ’„ Maquillage/Coiffure</option>
    <option value="gc8">ðŸ“ Script/ContinuitÃ©</option>
    <option value="gc9">ðŸŽ­ RÃ©gie</option>
    <option value="gc10">ðŸ’¼ Production</option>
    <option value="gc11">ðŸ´ Catering</option>
    <option value="gc12">ðŸš— Transport/Logistique</option>
    <option value="gc13">ðŸŽžï¸ Post-production</option>
    <option value="gc14">âœï¸ ScÃ©nario/Ã‰criture</option>
    <option value="gc15">ðŸŽµ Musique</option>
    <option value="gc16">ðŸ¦º Cascades/Stunts</option>
    <option value="gc17">âž• Autre</option>
</select>
<select class="profile-input" id="profile-role" onchange="app.PublicProfile.onRoleChange()">
    <option value="">-- Fonction * --</option>
</select>
<input type="text" class="profile-input d-none" id="profile-role-custom" placeholder="PrÃ©cisez votre fonction...">
            </div>
            
<h3 class="mt-20">ðŸ”§ Mon MatÃ©riel</h3>
            <p class="text-sec-sm-mb10">Le matÃ©riel affichÃ© correspond Ã  votre dÃ©partement. Cochez ci-dessous pour voir d'autres catÃ©gories.</p>
            
            <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
                <label class="flex-link">
                    <input type="checkbox" id="show-equip-camera" onchange="app.PublicProfile.toggleEquipmentSection('camera')"> ðŸ“· CamÃ©ras
                </label>
                <label class="flex-link">
                    <input type="checkbox" id="show-equip-lens" onchange="app.PublicProfile.toggleEquipmentSection('lens')"> ðŸ”­ Objectifs
                </label>
                <label class="flex-link">
                    <input type="checkbox" id="show-equip-light" onchange="app.PublicProfile.toggleEquipmentSection('light')"> ðŸ’¡ LumiÃ¨re
                </label>
                <label class="flex-link">
                    <input type="checkbox" id="show-equip-sound" onchange="app.PublicProfile.toggleEquipmentSection('sound')"> ðŸŽ¤ Son
                </label>
                <label class="flex-link">
                    <input type="checkbox" id="show-equip-grip" onchange="app.PublicProfile.toggleEquipmentSection('grip')"> ðŸŽ¬ Machinerie
                </label>
                <label class="flex-link">
                    <input type="checkbox" id="show-equip-makeup" onchange="app.PublicProfile.toggleEquipmentSection('makeup')"> ðŸ’„ Maquillage
                </label>
                <label class="flex-link">
                    <input type="checkbox" id="show-equip-other" onchange="app.PublicProfile.toggleEquipmentSection('other')"> âž• Autre
                </label>
            </div>
            
            <!-- CamÃ©ras -->
            <div id="equip-section-camera" class="d-none-mb15">
                <div class="profile-row">
                    <select class="profile-input" id="profile-camera-select">
                        <option value="">-- Ajouter une camÃ©ra --</option>
                        <optgroup label="CinÃ©ma">
                            <option value="ARRI Alexa Mini">ARRI Alexa Mini</option>
                            <option value="ARRI Alexa Mini LF">ARRI Alexa Mini LF</option>
                            <option value="ARRI Alexa 35">ARRI Alexa 35</option>
                            <option value="RED V-Raptor">RED V-Raptor</option>
                            <option value="RED Komodo">RED Komodo</option>
                            <option value="Sony Venice">Sony Venice</option>
                            <option value="Sony Venice 2">Sony Venice 2</option>
                            <option value="Blackmagic URSA Mini Pro 12K">Blackmagic URSA Mini Pro 12K</option>
                            <option value="Canon C500 Mark II">Canon C500 Mark II</option>
                            <option value="Canon C300 Mark III">Canon C300 Mark III</option>
                        </optgroup>
                        <optgroup label="Semi-Pro / Hybride">
                            <option value="Sony FX9">Sony FX9</option>
                            <option value="Sony FX6">Sony FX6</option>
                            <option value="Sony FX3">Sony FX3</option>
                            <option value="Sony A7S III">Sony A7S III</option>
                            <option value="Panasonic S1H">Panasonic S1H</option>
                            <option value="Blackmagic Pocket 6K Pro">Blackmagic Pocket 6K Pro</option>
                            <option value="Canon R5 C">Canon R5 C</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('camera')" class="btn-primary-sm">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="camera-list"></div>
            </div>
            
            <!-- Objectifs -->
            <div id="equip-section-lens" class="d-none-mb15">
                <div class="profile-row">
                    <select class="profile-input" id="profile-lens-select">
                        <option value="">-- Ajouter un objectif --</option>
                        <optgroup label="CinÃ©ma - Primes">
                            <option value="Zeiss Master Prime">Zeiss Master Prime</option>
                            <option value="Zeiss Supreme Prime">Zeiss Supreme Prime</option>
                            <option value="Zeiss CP.3">Zeiss CP.3</option>
                            <option value="Cooke S4/i">Cooke S4/i</option>
                            <option value="ARRI Signature Prime">ARRI Signature Prime</option>
                        </optgroup>
                        <optgroup label="CinÃ©ma - Zooms">
                            <option value="AngÃ©nieux EZ-1 30-90">AngÃ©nieux EZ-1 30-90</option>
                            <option value="AngÃ©nieux Optimo 24-290">AngÃ©nieux Optimo 24-290</option>
                            <option value="Fujinon Premista 28-100">Fujinon Premista 28-100</option>
                        </optgroup>
                        <optgroup label="Photo / Hybride">
                            <option value="Canon RF 24-70 f/2.8">Canon RF 24-70 f/2.8</option>
                            <option value="Sony GM 24-70 f/2.8">Sony GM 24-70 f/2.8</option>
                            <option value="Sigma Art 24-70 f/2.8">Sigma Art 24-70 f/2.8</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('lens')" class="btn-primary-sm">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="lens-list"></div>
            </div>
            
            <!-- LumiÃ¨re -->
            <div id="equip-section-light" class="d-none-mb15">
                <div class="profile-row">
                    <select class="profile-input" id="profile-light-select">
                        <option value="">-- Ajouter un projecteur --</option>
                        <optgroup label="LED">
                            <option value="ARRI SkyPanel S60">ARRI SkyPanel S60</option>
                            <option value="ARRI SkyPanel S120">ARRI SkyPanel S120</option>
                            <option value="ARRI Orbiter">ARRI Orbiter</option>
                            <option value="Aputure 600d Pro">Aputure 600d Pro</option>
                            <option value="Aputure 300d II">Aputure 300d II</option>
                            <option value="Aputure Nova P300c">Aputure Nova P300c</option>
                            <option value="Nanlite Forza 500">Nanlite Forza 500</option>
                            <option value="Litepanels Astra 6X">Litepanels Astra 6X</option>
                            <option value="Litepanels Gemini 2x1">Litepanels Gemini 2x1</option>
                        </optgroup>
                        <optgroup label="HMI / TungstÃ¨ne">
                            <option value="ARRI M18">ARRI M18</option>
                            <option value="ARRI M40">ARRI M40</option>
                            <option value="ARRI True Blue T1">ARRI True Blue T1</option>
                            <option value="ARRI True Blue T5">ARRI True Blue T5</option>
                        </optgroup>
                        <optgroup label="Tubes / Flex">
                            <option value="Astera Titan Tube">Astera Titan Tube</option>
                            <option value="Quasar Science Rainbow 2">Quasar Science Rainbow 2</option>
                            <option value="Nanlite PavoTube II">Nanlite PavoTube II</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('light')" class="btn-primary-sm">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="light-list"></div>
            </div>
            
            <!-- Son -->
            <div id="equip-section-sound" class="d-none-mb15">
                <div class="profile-row">
                    <select class="profile-input" id="profile-sound-select">
                        <option value="">-- Ajouter du matÃ©riel son --</option>
                        <optgroup label="Enregistreurs">
                            <option value="Sound Devices MixPre-10 II">Sound Devices MixPre-10 II</option>
                            <option value="Sound Devices 833">Sound Devices 833</option>
                            <option value="Sound Devices 888">Sound Devices 888</option>
                            <option value="Zoom F8n Pro">Zoom F8n Pro</option>
                            <option value="Zoom F6">Zoom F6</option>
                        </optgroup>
                        <optgroup label="Micros">
                            <option value="Sennheiser MKH 416">Sennheiser MKH 416</option>
                            <option value="Sennheiser MKH 8060">Sennheiser MKH 8060</option>
                            <option value="Schoeps CMIT 5U">Schoeps CMIT 5U</option>
                            <option value="Rode NTG5">Rode NTG5</option>
                            <option value="DPA 4017B">DPA 4017B</option>
                        </optgroup>
                        <optgroup label="HF / Lavaliers">
                            <option value="Sennheiser EW 500 G4">Sennheiser EW 500 G4</option>
                            <option value="Lectrosonics SMWB">Lectrosonics SMWB</option>
                            <option value="Sony UWP-D21">Sony UWP-D21</option>
                            <option value="Rode Wireless GO II">Rode Wireless GO II</option>
                            <option value="DPA 4060">DPA 4060</option>
                            <option value="Sanken COS-11D">Sanken COS-11D</option>
                        </optgroup>
                        <optgroup label="Perches">
                            <option value="K-Tek KE-110">K-Tek KE-110</option>
                            <option value="Ambient QP 5100">Ambient QP 5100</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('sound')" class="btn-primary-sm">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="sound-list"></div>
            </div>
            
            <!-- Machinerie -->
            <div id="equip-section-grip" class="d-none-mb15">
                <div class="profile-row">
                    <select class="profile-input" id="profile-grip-select">
                        <option value="">-- Ajouter du matÃ©riel machinerie --</option>
                        <optgroup label="Stabilisateurs">
                            <option value="DJI Ronin 2">DJI Ronin 2</option>
                            <option value="DJI RS 3 Pro">DJI RS 3 Pro</option>
                            <option value="Freefly MÅVI Pro">Freefly MÅVI Pro</option>
                        </optgroup>
                        <optgroup label="Slider / Dolly">
                            <option value="Slider motorisÃ© 120cm">Slider motorisÃ© 120cm</option>
                            <option value="Dana Dolly">Dana Dolly</option>
                            <option value="Doorway Dolly">Doorway Dolly</option>
                        </optgroup>
                        <optgroup label="TÃªtes / Pieds">
                            <option value="O'Connor 2575">O'Connor 2575</option>
                            <option value="Sachtler Video 18">Sachtler Video 18</option>
                            <option value="Ronford-Baker">Ronford-Baker</option>
                        </optgroup>
                        <optgroup label="Drones">
                            <option value="DJI Inspire 3">DJI Inspire 3</option>
                            <option value="DJI Mavic 3 Pro Cine">DJI Mavic 3 Pro Cine</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('grip')" class="btn-primary-sm">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="grip-list"></div>
            </div>
            
            <!-- Maquillage -->
            <div id="equip-section-makeup" class="d-none-mb15">
                <div class="profile-row">
                    <select class="profile-input" id="profile-makeup-select">
                        <option value="">-- Ajouter du matÃ©riel maquillage --</option>
                        <optgroup label="AÃ©rographe">
                            <option value="Kit AÃ©rographe Iwata">Kit AÃ©rographe Iwata</option>
                            <option value="Kit AÃ©rographe Temptu">Kit AÃ©rographe Temptu</option>
                            <option value="Compresseur silencieux">Compresseur silencieux</option>
                        </optgroup>
                        <optgroup label="Ã‰clairage">
                            <option value="Ring Light Pro">Ring Light Pro</option>
                            <option value="Miroir LED Hollywood">Miroir LED Hollywood</option>
                        </optgroup>
                        <optgroup label="Mallettes">
                            <option value="Mallette Zuca Pro">Mallette Zuca Pro</option>
                            <option value="Trolley maquillage XXL">Trolley maquillage XXL</option>
                        </optgroup>
                        <optgroup label="FX / ProthÃ¨ses">
                            <option value="Kit prothÃ¨ses silicone">Kit prothÃ¨ses silicone</option>
                            <option value="Kit cicatrices/blessures">Kit cicatrices/blessures</option>
                            <option value="Kit vieillissement">Kit vieillissement</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('makeup')" class="btn-primary-sm">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="makeup-list"></div>
            </div>
            
            <!-- Autre -->
            <div id="equip-section-other" class="d-none-mb15">
                <div class="profile-row">
                    <input type="text" class="profile-input" id="profile-other-equipment" placeholder="Autre matÃ©riel (moniteur, transmission vidÃ©o...)">
                    <button onclick="app.PublicProfile.addEquipment('other')" class="btn-primary-sm">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="other-equipment-list"></div>
            </div>
        </div>
        
                <!-- Section Technicien - Galerie Photos (visible si crew) -->
                <div class="profile-section d-none" id="profile-crew-gallery-section" data-section="crew-gallery">
                    <h3>
                        <span class="section-title">ðŸ“¸ Galerie Photos</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="crew-gallery" data-scope="public" onclick="app.PublicProfile.toggleVisibility('crew-gallery', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="crew-gallery" data-scope="project" onclick="app.PublicProfile.toggleVisibility('crew-gallery', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <p class="text-sec-sm-mb10">Ajoutez jusqu'Ã  3 photos de vos rÃ©alisations ou de vous en situation de travail</p>
                    <div class="actor-gallery" id="crew-gallery">
                        <div class="actor-gallery-item" id="crew-gallery-item-0" onclick="document.getElementById('crew-gallery-file-0').click()">
                            <span class="gallery-placeholder">+</span>
                        </div>
                        <div class="actor-gallery-item" id="crew-gallery-item-1" onclick="document.getElementById('crew-gallery-file-1').click()">
                            <span class="gallery-placeholder">+</span>
                        </div>
                        <div class="actor-gallery-item" id="crew-gallery-item-2" onclick="document.getElementById('crew-gallery-file-2').click()">
                            <span class="gallery-placeholder">+</span>
                        </div>
                    </div>
                    <input type="file" id="crew-gallery-file-0" accept="image/*" class="d-none" onchange="app.PublicProfile.uploadCrewGalleryPhoto(0, event)">
                    <input type="file" id="crew-gallery-file-1" accept="image/*" class="d-none" onchange="app.PublicProfile.uploadCrewGalleryPhoto(1, event)">
                    <input type="file" id="crew-gallery-file-2" accept="image/*" class="d-none" onchange="app.PublicProfile.uploadCrewGalleryPhoto(2, event)">
                    <input type="hidden" id="crew-gallery-input-0" value="">
                    <input type="hidden" id="crew-gallery-input-1" value="">
                    <input type="hidden" id="crew-gallery-input-2" value="">
                </div>
        
				<!-- Section Technicien - Bande DÃ©mo (visible si crew avec mÃ©tier visuel) -->
                <div class="profile-section d-none" id="profile-crew-demoreel-section" data-section="crew-demoreel">
                    <h3>
                        <span class="section-title">ðŸŽ¬ Bande DÃ©mo / Showreel</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="crew-demoreel" data-scope="public" onclick="app.PublicProfile.toggleVisibility('crew-demoreel', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="crew-demoreel" data-scope="project" onclick="app.PublicProfile.toggleVisibility('crew-demoreel', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <p class="text-sec-sm-mb10">Montrez votre travail (rÃ©alisation, image, montage, VFX, musique...)</p>
                    <input type="url" class="profile-input" id="profile-crew-demoreel" placeholder="https://www.youtube.com/watch?v=... ou https://vimeo.com/...">
                    <div id="crew-demoreel-preview" class="mt-15-d-none">
                        <iframe id="crew-demoreel-iframe" width="100%" height="315" frameborder="0" allowfullscreen class="br-8"></iframe>
                    </div>
                </div>
        
				<!-- Section Association (visible si association) -->
                <div class="profile-section d-none" id="profile-association-section">
                    <h3>ðŸ›ï¸ Informations Association</h3>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-asso-name" placeholder="Nom de l'association *">
                        <select class="profile-input" id="profile-asso-type">
                            <option value="">-- Type d'association * --</option>
                        </select>
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-asso-siret" placeholder="NÂ° SIRET / RNA (optionnel)">
                        <input type="number" class="profile-input" id="profile-asso-members" placeholder="Nombre de membres">
                    </div>
                    <div class="profile-row">
                        <input type="number" class="profile-input" id="profile-asso-year" placeholder="AnnÃ©e de crÃ©ation">
                        <input type="text" class="profile-input" id="profile-asso-president" placeholder="PrÃ©sident(e)">
                    </div>
                    <textarea class="profile-input profile-textarea" id="profile-asso-mission" placeholder="Mission / Objectifs de l'association *"></textarea>
                    <textarea class="profile-input profile-textarea" id="profile-asso-activities" placeholder="ActivitÃ©s principales (ateliers, formations, Ã©vÃ©nements...)"></textarea>
                    
                    <h4 class="mt-20">ðŸŽ¯ Services proposÃ©s</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        <label class="flex-row-btn">
                            <input type="checkbox" id="asso-service-formation"> ðŸ“š Formations
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="asso-service-ateliers"> ðŸŽ¬ Ateliers pratiques
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="asso-service-networking"> ðŸ¤ Networking
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="asso-service-casting"> ðŸŽ­ Casting
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="asso-service-materiel"> ðŸ“¦ PrÃªt de matÃ©riel
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="asso-service-production"> ðŸŽ¥ Aide Ã  la production
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="asso-service-diffusion"> ðŸ“½ï¸ Diffusion / Festivals
                        </label>
                    </div>
                    
                    <h4 class="mt-20">ðŸ’» PrÃ©sence en ligne</h4>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-asso-facebook" placeholder="Page Facebook">
                        <input type="text" class="profile-input" id="profile-asso-instagram" placeholder="Instagram">
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-asso-youtube" placeholder="ChaÃ®ne YouTube">
                        <input type="text" class="profile-input" id="profile-asso-linkedin" placeholder="Page LinkedIn">
                    </div>
                    
                    <h4 class="mt-20">ðŸŽ¬ Showreel / VidÃ©o de prÃ©sentation</h4>
                    <input type="url" class="profile-input" id="profile-asso-demoreel" placeholder="https://www.youtube.com/watch?v=... ou https://vimeo.com/...">
                    <div id="asso-demoreel-preview" class="mt-15-d-none">
                        <iframe id="asso-demoreel-iframe" width="100%" height="315" frameborder="0" allowfullscreen class="br-8"></iframe>
                    </div>
                </div>
        
				<!-- Section Entreprise (visible si enterprise) -->
                <div class="profile-section d-none" id="profile-enterprise-section">
                    <h3>ðŸ¢ Informations Entreprise</h3>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-ent-name" placeholder="Nom de l'entreprise *">
                        <select class="profile-input" id="profile-ent-type">
                            <option value="">-- Type d'entreprise * --</option>
                        </select>
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-ent-siret" placeholder="NÂ° SIRET *">
                        <select class="profile-input" id="profile-ent-legal">
                            <option value="">-- Forme juridique --</option>
                            <option value="sarl">SARL</option>
                            <option value="sas">SAS</option>
                            <option value="eurl">EURL</option>
                            <option value="sasu">SASU</option>
                            <option value="sa">SA</option>
                            <option value="micro">Micro-entreprise</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="profile-row">
                        <input type="number" class="profile-input" id="profile-ent-year" placeholder="AnnÃ©e de crÃ©ation">
                        <input type="number" class="profile-input" id="profile-ent-employees" placeholder="Nombre d'employÃ©s">
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-ent-director" placeholder="GÃ©rant / Directeur">
                        <input type="text" class="profile-input" id="profile-ent-contact" placeholder="Contact commercial">
                    </div>
                    <textarea class="profile-input profile-textarea" id="profile-ent-description" placeholder="Description de l'entreprise *"></textarea>
                    <textarea class="profile-input profile-textarea" id="profile-ent-services" placeholder="Services proposÃ©s (dÃ©taillez vos prestations)"></textarea>
                    
                    <h4 class="mt-20">ðŸŽ¯ SpÃ©cialitÃ©s</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        <label class="flex-row-btn">
                            <input type="checkbox" id="ent-spec-fiction"> ðŸŽ¬ Fiction
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="ent-spec-doc"> ðŸ“¹ Documentaire
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="ent-spec-pub"> ðŸ“º PublicitÃ©
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="ent-spec-corporate"> ðŸ’¼ Corporate
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="ent-spec-clip"> ðŸŽµ Clip musical
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="ent-spec-event"> ðŸŽª Ã‰vÃ©nementiel
                        </label>
                        <label class="flex-row-btn">
                            <input type="checkbox" id="ent-spec-web"> ðŸŒ Web / RÃ©seaux sociaux
                        </label>
                    </div>
                    
                    <h4 class="mt-20">ðŸ’» PrÃ©sence en ligne</h4>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-ent-facebook" placeholder="Page Facebook">
                        <input type="text" class="profile-input" id="profile-ent-instagram" placeholder="Instagram">
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-ent-youtube" placeholder="ChaÃ®ne YouTube">
                        <input type="text" class="profile-input" id="profile-ent-linkedin" placeholder="Page LinkedIn">
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-ent-vimeo" placeholder="Vimeo / Portfolio">
                        <input type="text" class="profile-input" id="profile-ent-imdb" placeholder="Page IMDb">
                    </div>
                    
                    <h4 class="mt-20">ðŸŽ¬ Showreel / VidÃ©o de prÃ©sentation</h4>
                    <input type="url" class="profile-input" id="profile-ent-demoreel" placeholder="https://www.youtube.com/watch?v=... ou https://vimeo.com/...">
                    <div id="ent-demoreel-preview" class="mt-15-d-none">
                        <iframe id="ent-demoreel-iframe" width="100%" height="315" frameborder="0" allowfullscreen class="br-8"></iframe>
                    </div>
                </div>
        
				<!-- Section Tarif & Collaboration (pour tous) -->
                <div class="profile-section" data-section="tarif">
                    <h3>
                        <span class="section-title">ðŸ’° Tarif & Collaboration</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="tarif" data-scope="public" onclick="app.PublicProfile.toggleVisibility('tarif', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="tarif" data-scope="project" onclick="app.PublicProfile.toggleVisibility('tarif', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <div class="profile-row">
                        <input type="number" class="profile-input" id="profile-rate" placeholder="Tarif journalier">
                        <select class="profile-input" id="profile-currency">
                            <option value="â‚¬">â‚¬ Euro</option>
                            <option value="$">$ Dollar</option>
                            <option value="Â£">Â£ Livre</option>
                            <option value="CHF">CHF Franc suisse</option>
                        </select>
                    </div>
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin: 10px 0;">
                        <input type="checkbox" id="profile-rate-negotiable" style="width:18px; height:18px;">
                        <span>ðŸ¤ Tarif nÃ©gociable selon le projet</span>
                    </label>
                    <textarea class="profile-input profile-textarea" id="profile-availability" placeholder="Vos disponibilitÃ©s gÃ©nÃ©rales (ex: Disponible les weekends, Libre Ã  partir de mars 2025...)"></textarea>
                    
                    <div class="mt-15">
                        <label class="label-bold-block-10">ðŸ¤ Type de collaboration acceptÃ©e</label>
                        <p class="text-sec-sm-mb10">Cochez les types de projets qui vous intÃ©ressent (plusieurs choix possibles)</p>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 15px; border:2px solid #4CAF50; border-radius:20px; background:var(--bg);" id="label-collab-pro">
                                <input type="checkbox" id="profile-collab-pro" onchange="app.PublicProfile.updateCollabLabel('pro')">
                                <span>ðŸŽ¬ Pro</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 15px; border:2px solid #FF9800; border-radius:20px; background:var(--bg);" id="label-collab-semi">
                                <input type="checkbox" id="profile-collab-semi" onchange="app.PublicProfile.updateCollabLabel('semi')">
                                <span>âš¡ Semi-pro</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 15px; border:2px solid #E91E63; border-radius:20px; background:var(--bg);" id="label-collab-benevole">
                                <input type="checkbox" id="profile-collab-benevole" onchange="app.PublicProfile.updateCollabLabel('benevole')">
                                <span>â¤ï¸ BÃ©nÃ©vole</span>
                            </label>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-sec); margin-top: 8px;">
                            ðŸŽ¬ Pro = Contrats et tarifs standards | âš¡ Semi-pro = Flexible mais payÃ© | â¤ï¸ BÃ©nÃ©vole = DÃ©fraiement uniquement
                        </p>
                    </div>
                </div>
        
				<!-- Section Calendrier (pour tous) -->
                <div class="profile-section" data-section="calendar">
                    <h3>
                        <span class="section-title">ðŸ“… Calendrier des disponibilitÃ©s</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="calendar" data-scope="public" onclick="app.PublicProfile.toggleVisibility('calendar', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="calendar" data-scope="project" onclick="app.PublicProfile.toggleVisibility('calendar', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <p class="text-sec-sm-mb15">Clic gauche = disponible ðŸŸ¢ | Clic droit = indisponible ðŸ”´</p>
                    <div id="profile-availability-calendar"></div>
                    <!-- Les listes de pÃ©riodes sont masquÃ©es car dÃ©jÃ  visibles dans le calendrier -->
                    <div id="profile-avail-dates-list" class="d-none"></div>
                    <div id="profile-unavail-dates-list" class="d-none"></div>
                </div>
        
                <!-- Section VÃ©hicule -->
                <div class="profile-section" data-section="vehicle">
                    <h3>
                        <span class="section-title">ðŸš— VÃ©hicule</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="vehicle" data-scope="public" onclick="app.PublicProfile.toggleVisibility('vehicle', 'public')" title="VisibilitÃ© publique (Univers)">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
                            <button type="button" class="visibility-btn" data-section="vehicle" data-scope="project" onclick="app.PublicProfile.toggleVisibility('vehicle', 'project')" title="VisibilitÃ© projet (Ã©quipe)">ðŸŽ¬ <span class="vis-icon">ðŸ‘ï¸</span></button>
                        </div>
                    </h3>
                    <div class="profile-row">
                        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="profile-has-vehicle" onchange="document.getElementById('profile-vehicle-details').style.display = this.checked ? 'block' : 'none';">
                            <span>Je possÃ¨de un vÃ©hicule</span>
                        </label>
                    </div>
                    <div id="profile-vehicle-details" style="display:none; margin-top:15px; padding:20px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                        <div class="profile-row">
                            <div>
                                <label class="form-label">Type de vÃ©hicule</label>
                                <input type="text" class="profile-input" id="profile-vehicle-type" placeholder="Ex: CitroÃ«n C3, Renault Kangoo...">
                            </div>
                            <div>
                                <label class="form-label">Immatriculation</label>
                                <input type="text" class="profile-input" id="profile-vehicle-plate" placeholder="AA-123-BB">
                            </div>
                        </div>
                        <div class="profile-row">
                            <div>
                                <label class="form-label">Places disponibles</label>
                                <input type="number" class="profile-input" id="profile-vehicle-seats" placeholder="Nombre de places" min="1" max="9">
                            </div>
                            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:12px; background:var(--panel-bg); border-radius:6px; height:fit-content; margin-top:auto;">
                                <input type="checkbox" id="profile-vehicle-trunk" style="width:18px; height:18px;">
                                <span>ðŸ“¦ Coffre disponible pour matÃ©riel</span>
                            </label>
                        </div>
                        <div class="profile-row mt-10">
                            <textarea class="profile-input" id="profile-vehicle-notes" placeholder="Notes vÃ©hicule (climatisation, GPS, attelage...)" style="min-height:60px; resize:vertical;"></textarea>
                        </div>
                    </div>
                </div>
        
				<!-- Section ActualitÃ© du profil -->
                <div class="profile-section" data-section="actualite">
                    <h3>
                        <span class="section-title">ðŸ“° Mon ActualitÃ©</span>
                    </h3>
                    <p class="text-sec-sm-mb15">
                        Publiez une actualitÃ© visible sur votre profil public. LimitÃ©e Ã  1 publication par jour.
                    </p>
                    <div id="profile-actualite-status" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
                    <textarea class="profile-input" id="profile-actualite-content" placeholder="Partagez une actualitÃ©, une disponibilitÃ©, un projet en cours..." style="min-height: 80px; resize: vertical; margin-bottom: 10px;"></textarea>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <button type="button" onclick="app.PublicProfile.publishActualite()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ðŸ“¤ Publier mon actualitÃ©</button>
                        <span class="text-sec-sm">Visible sur votre profil pendant 24h</span>
                    </div>
                    <div id="profile-my-actualites" class="mt-20"></div>
                </div>
        
				<!-- Zone Danger - Suppression profil et compte -->
                <div class="profile-section" style="border-color: var(--danger); margin-top: 30px;">
                    <h3 class="text-danger">âš ï¸ Zone Danger</h3>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <p class="text-sec-sm-mb10">
                                Supprimer ce profil de l'Univers. Vos autres profils ne seront pas affectÃ©s.
                            </p>
                            <button onclick="app.PublicProfile.deleteCurrentProfile()" class="n8-badge-7">
                                ðŸ—‘ï¸ Supprimer ce profil
                            </button>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <p class="text-sec-sm-mb10">
                                Supprimer votre compte et tous vos projets. Action irrÃ©versible.
                            </p>
                            <button onclick="app.PublicProfile.deleteAccount()" class="n8-badge-7">
                                ðŸ—‘ï¸ Supprimer mon compte
                            </button>
                        </div>
                    </div>
                </div>
            </div><!-- Fin profile-all-sections -->
        </div><!-- Fin current-profile-content -->
        </div><!-- Fin profile-content -->
        
        <!-- Conteneur Messages -->
        <div id="messages-content" class="d-none">
            <div class="messages-section">
                <div style="margin-bottom: 15px; padding: 15px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="messages-filter-profile" onchange="app.Messages.applyFilters()" class="n8-input-9">
                            <option value="">ðŸ“¬ Tous les profils</option>
                        </select>
                        <select id="messages-filter-type" onchange="app.Messages.applyFilters()" class="n8-input-9">
                            <option value="">ðŸ“‹ Tous les types</option>
                            <option value="invitation">ðŸŽ¬ Invitations</option>
                            <option value="convocation">ðŸ“… Convocations</option>
                            <option value="info">â„¹ï¸ Informations</option>
                        </select>
                        <select id="messages-filter-status" onchange="app.Messages.applyFilters()" style="flex: 1; min-width: 120px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                            <option value="">ðŸ“¨ Tous</option>
                            <option value="unread">ðŸ”´ Non lus</option>
                            <option value="read">âœ… Lus</option>
                        </select>
                    </div>
                </div>
                <div class="message-list" id="messages-list">
                    <div class="message-empty">ðŸ“­ Aucun message pour le moment.</div>
                </div>
            </div>
        </div>
    </div>
  </div>
  
  <!-- Modal profil complet -->
<div id="profile-modal-overlay" class="profile-modal-overlay d-none">
  <div class="profile-modal-box">
    <div class="profile-modal-header">
      <button class="profile-modal-close" onclick="app.Universe.closeProfileModal()">âœ–</button>
      <button class="favorite-btn" id="pm-favorite-btn" onclick="app.Universe.toggleFavorite()" data-tooltip="Ajouter aux favoris">â˜†</button>
      <button class="report-btn" id="pm-report-btn" onclick="app.Universe.reportProfile()" data-tooltip="Signaler ce profil" style="position: absolute; top: 15px; right: 90px; background: transparent; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.6; transition: opacity 0.2s;">ðŸš©</button>
      <div class="profile-modal-photo" id="pm-photo">ðŸ‘¤</div>
      <div class="profile-modal-name" id="pm-name">Nom</div>
      <div class="profile-modal-role" id="pm-role">MÃ©tier</div>
      <div class="profile-modal-city" id="pm-city">ðŸ“ Ville</div>
    </div>
    <div class="profile-modal-body">
      <div class="profile-modal-section" id="pm-bio-section">
        <h4>Bio</h4>
        <p id="pm-bio"></p>
      </div>
      <div class="profile-modal-section">
        <h4>Informations</h4>
        <div class="profile-modal-info" id="pm-info"></div>
      </div>
      <div class="profile-modal-section" id="pm-contact-section">
        <h4>Contact</h4>
        <div class="profile-modal-info" id="pm-contact"></div>
      </div>
      <div class="profile-modal-section d-none" id="pm-shooting-section">
        <h4>ðŸŽ¬ Prochains tournages</h4>
        <div id="pm-shooting-dates"></div>
      </div>
      <div class="profile-modal-section d-none" id="pm-demoreel-section">
        <h4>ðŸŽ¬ Bande DÃ©mo</h4>
        <div id="pm-demoreel"></div>
      </div>
      <div class="profile-modal-section d-none" id="pm-actualite-section">
        <h4>ðŸ“° ActualitÃ©</h4>
        <div id="pm-actualite" style="overflow-x: auto; white-space: nowrap; padding: 10px 0;">
          <p class="text-sec-italic">Aucune actualitÃ© publiÃ©e</p>
        </div>
      </div>
    </div>
    <div class="profile-modal-actions">
      <button onclick="app.Universe.closeProfileModal()" style="background: var(--border); color: var(--text-main); border: none;">Fermer</button>
      <button onclick="app.Universe.contactProfile()" style="background: #e94560; color: white; border: none;">ðŸ“§ Contacter</button>
      <button onclick="app.Universe.exportProfilePDF()" style="background: var(--success); color: white; border: none;">ðŸ“„ Export PDF</button>
      <button onclick="app.Universe.addToProject()" style="background: var(--primary); color: white; border: none;">ðŸ“ Ajouter Ã  un projet</button>
    </div>
  </div>
</div>

<!-- Modal sÃ©lection projet -->
<div id="select-project-modal" class="profile-modal-overlay d-none">
  <div class="profile-modal-box" style="max-width: 400px;">
    <div class="profile-modal-header p-20">
      <button class="profile-modal-close" onclick="document.getElementById('select-project-modal').style.display='none'">âœ–</button>
      <h3 class="m-0">ðŸ“ Ajouter Ã  un projet</h3>
    </div>
    <div class="profile-modal-body">
      <p style="color: var(--text-sec); margin-bottom: 15px;">SÃ©lectionnez le projet auquel vous souhaitez ajouter cette personne :</p>
      <div id="select-project-list" class="flex-col-gap10"></div>
    </div>
  </div>
</div>
  
  <!-- Modal ajout/Ã©dition dÃ©pense -->
<div id="expense-modal" class="modal-overlay d-none">
    <div class="modal-box" style="max-width: 550px;">
        <h3 id="expense-modal-title">âž• Nouvelle DÃ©pense</h3>
        <input type="hidden" id="expense-edit-id">
        
        <input type="text" id="expense-title" class="profile-input mb-10" placeholder="Titre de la dÃ©pense *">
        
        <!-- CatÃ©gorie CNC + Sous-catÃ©gorie -->
        <div class="flex-gap10-mb10">
            <select id="expense-category" class="profile-input flex-1" onchange="app.Expenses.onCategoryChange()">
                <option value="">-- CatÃ©gorie CNC * --</option>
            </select>
            <select id="expense-subcategory" class="profile-input flex-1">
                <option value="">-- Sous-catÃ©gorie --</option>
            </select>
        </div>
        
        <!-- Montants HT / TVA / TTC -->
        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 2;">
                    <label class="form-label-xs">ðŸ’° Montant HT *</label>
                    <input type="number" id="expense-amount-ht" class="profile-input" placeholder="0.00" step="0.01" oninput="app.Expenses.calculateTTCFromHT()">
                </div>
                <div class="flex-1">
                    <label class="form-label-xs">TVA</label>
                    <select id="expense-vat-rate" class="profile-input" onchange="app.Expenses.calculateTTCFromHT()">
                        <option value="0">0%</option>
                        <option value="5.5">5.5%</option>
                        <option value="10">10%</option>
                        <option value="20" selected>20%</option>
                    </select>
                </div>
                <div style="flex: 2;">
                    <label class="form-label-xs">ðŸ’¶ Montant TTC</label>
                    <input type="number" id="expense-amount-ttc" class="profile-input" placeholder="0.00" step="0.01" oninput="app.Expenses.calculateHTFromTTC()">
                </div>
            </div>
        </div>
        
        <textarea id="expense-description" class="profile-input" placeholder="Description / Justification..." style="height: 60px; margin-bottom: 10px; resize: vertical;"></textarea>
        
        <div class="flex-gap10-mb10">
            <div class="flex-1">
                <label class="form-label-xs">ðŸ’³ PayÃ© par</label>
                <select id="expense-paid-by" class="profile-input w-full">
                    <option value="">-- Production --</option>
                </select>
            </div>
            <div class="flex-1">
                <label class="form-label-xs">ðŸ“… Date</label>
                <input type="date" id="expense-date" class="profile-input w-full">
            </div>
        </div>
        
        <div class="flex-gap10-mb10">
            <select id="expense-status" class="profile-input flex-1">
                <option value="pending">â³ En attente de validation</option>
                <option value="approved">âœ… ValidÃ©</option>
                <option value="done">ðŸ’° DÃ©jÃ  payÃ©</option>
            </select>
        </div>
        
        <!-- Justificatifs -->
        <div class="mb-15">
            <label style="font-size: 0.85rem; color: var(--text-sec); display: block; margin-bottom: 5px;">ðŸ“Ž Justificatifs (facture, ticket...)</label>
            <div class="flex-row-gap10">
                <input type="text" id="expense-attachment-url" class="profile-input flex-1" placeholder="URL du fichier ou glisser une image">
                <label style="padding: 8px 15px; background: var(--primary); color: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                    ðŸ“· Photo
                    <input type="file" id="expense-attachment-file" accept="image/*" class="d-none" onchange="app.Expenses.handleFileUpload(this)">
                </label>
            </div>
            <div id="expense-attachments-list" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>
        
        <!-- Champ cachÃ© pour rÃ©trocompatibilitÃ© -->
        <input type="hidden" id="expense-photo">
        <input type="hidden" id="expense-dept">
        <input type="hidden" id="expense-amount">
        
        <div class="modal-btns">
            <button onclick="document.getElementById('expense-modal').style.display='none'" class="n8-badge-8">Annuler</button>
            <button onclick="app.Expenses.saveExpense()" class="n8-btn-1">ðŸ’¾ Enregistrer</button>
        </div>
    </div>
</div>

<!-- Modal validation dÃ©pense -->
<div id="expense-validate-modal" class="modal-overlay d-none">
    <div class="modal-box" style="max-width: 450px;">
        <h3>âœ… Valider la dÃ©pense</h3>
        <div id="expense-validate-content"></div>
        <textarea id="expense-validate-comment" class="profile-input" placeholder="Commentaire (optionnel)..." style="height: 60px; margin: 15px 0; resize: vertical;"></textarea>
        <div class="modal-btns">
            <button onclick="app.Expenses.rejectExpense()" style="background:var(--danger); color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">âŒ Refuser</button>
            <button onclick="document.getElementById('expense-validate-modal').style.display='none'" class="n8-badge-8">Annuler</button>
            <button onclick="app.Expenses.approveExpense()" class="n8-btn-1">âœ… Valider</button>
        </div>
    </div>
</div>
  
  <!-- Modal dÃ©tail message -->
  <div id="message-detail-modal" class="message-detail-modal d-none">
    <div class="message-detail-box">
        <div class="message-detail-header">
            <h3 id="message-detail-title">Titre du message</h3>
            <button onclick="app.Messages.closeDetail()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âœ–</button>
        </div>
        <div class="message-detail-body">
            <div class="message-detail-meta" id="message-detail-meta"></div>
            <div class="message-detail-content" id="message-detail-content"></div>
        </div>
        <div id="message-detail-quick-actions" style="display:none; padding: 15px 20px; background: var(--bg); border-top: 1px solid var(--border);"></div>
        <div class="message-detail-actions">
            <button onclick="app.Messages.deleteMessage()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">ðŸ—‘ï¸ Supprimer</button>
            <button onclick="app.Messages.closeDetail()" class="btn-primary-sm-r6">Fermer</button>
        </div>
    </div>
  </div>
  
  <div id="contacts-view" class="contacts-view">
    <div class="contacts-header">
        <div class="flex-row-center">
            <button onclick="app.Contacts.close()" class="btn-secondary">â¬… Retour</button>
            <h1 id="contacts-title">ðŸ“‡ Mes Contacts</h1>
        </div>
        <div class="flex-row-gap10">
            <button class="theme-btn" onclick="app.UI.toggleTheme()">ðŸŒ“ Mode</button>
        </div>
    </div>
    <div class="contacts-body">
        <div class="contacts-tabs mb-10">
            <div class="contacts-tab active" onclick="app.Contacts.switchMode('favorites')">â­ Mes Favoris</div>
            <div class="contacts-tab btn-sm" onclick="app.Contacts.switchMode('directory')">ðŸŒ Annuaire</div>
        </div>
        <div id="contacts-sub-tabs" class="contacts-tabs" style="margin-bottom:15px; flex-wrap: wrap;">
            <div class="contacts-tab active btn-sm" onclick="app.Contacts.switchTab('actors')">ðŸŽ­ ComÃ©dien.nes</div>
            <div class="contacts-tab btn-sm" onclick="app.Contacts.switchTab('crew')">ðŸŽ¥ Technicien.nes</div>
            <div class="contacts-tab btn-sm" onclick="app.Contacts.switchTab('projects')">ðŸŽ¬ Projets</div>
            <div class="contacts-tab btn-sm" onclick="app.Contacts.switchTab('associations')">ðŸ›ï¸ Associations</div>
            <div class="contacts-tab btn-sm" onclick="app.Contacts.switchTab('enterprises')">ðŸ¢ Entreprises</div>
        </div>
        <div id="contacts-filters" style="display:none; margin-bottom:15px; padding:15px; background:var(--panel-bg); border:1px solid var(--border); border-radius:8px;"></div>
        <div id="contacts-list" class="contacts-grid"></div>
    </div>
  </div>

  <!-- VUE FORUM COMMUNAUTAIRE -->
  <div id="forum-view" class="forum-view">
    <div class="forum-header">
        <div class="flex-row-center">
            <button onclick="app.Forum.close()" class="btn-secondary">â¬… Retour</button>
            <h1>ðŸ’¬ Forum Communautaire</h1>
        </div>
        <div class="flex-row-gap10">
            <button class="theme-btn" onclick="app.UI.toggleTheme()">ðŸŒ“ Mode</button>
        </div>
    </div>
    <div class="forum-body">
        <div class="forum-sidebar">
            <div class="forum-categories">
                <div class="forum-category active" onclick="app.Forum.switchCategory('general')" data-category="general">
                    <span class="forum-category-icon">ðŸ’¬</span>
                    <span class="forum-category-name">GÃ©nÃ©ral</span>
                    <span class="forum-category-count" id="forum-count-general">0</span>
                </div>
                <div class="forum-category" onclick="app.Forum.switchCategory('comediens')" data-category="comediens">
                    <span class="forum-category-icon">ðŸŽ­</span>
                    <span class="forum-category-name">ComÃ©diens</span>
                    <span class="forum-category-count" id="forum-count-comediens">0</span>
                </div>
                <div class="forum-category" onclick="app.Forum.switchCategory('techniciens')" data-category="techniciens">
                    <span class="forum-category-icon">ðŸŽ¥</span>
                    <span class="forum-category-name">Techniciens</span>
                    <span class="forum-category-count" id="forum-count-techniciens">0</span>
                </div>
                <div class="forum-category-parent" onclick="this.classList.toggle('expanded')">
                    <span class="forum-category-icon">ðŸ›</span>
                    <span class="forum-category-name">Retours Site</span>
                    <span class="forum-category-arrow">â–¶</span>
                </div>
                <div class="forum-subcategories">
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_general')" data-category="retours_general">
                        <span class="forum-category-name">ðŸ› GÃ©nÃ©ral</span>
                        <span class="forum-category-count" id="forum-count-retours_general">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_editeur')" data-category="retours_editeur">
                        <span class="forum-category-name">ðŸ“ Ã‰diteur ScÃ©nario</span>
                        <span class="forum-category-count" id="forum-count-retours_editeur">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_sequencier')" data-category="retours_sequencier">
                        <span class="forum-category-name">ðŸŽ¬ SÃ©quencier</span>
                        <span class="forum-category-count" id="forum-count-retours_sequencier">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_depouillement')" data-category="retours_depouillement">
                        <span class="forum-category-name">ðŸ“‹ DÃ©pouillement</span>
                        <span class="forum-category-count" id="forum-count-retours_depouillement">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_storyboard')" data-category="retours_storyboard">
                        <span class="forum-category-name">ðŸŽ¨ Storyboard</span>
                        <span class="forum-category-count" id="forum-count-retours_storyboard">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_moodboard')" data-category="retours_moodboard">
                        <span class="forum-category-name">ðŸ–¼ï¸ Moodboard</span>
                        <span class="forum-category-count" id="forum-count-retours_moodboard">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_equipe')" data-category="retours_equipe">
                        <span class="forum-category-name">ðŸ‘¥ Ã‰quipe</span>
                        <span class="forum-category-count" id="forum-count-retours_equipe">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_budget')" data-category="retours_budget">
                        <span class="forum-category-name">ðŸ’° Budget</span>
                        <span class="forum-category-count" id="forum-count-retours_budget">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_contrats')" data-category="retours_contrats">
                        <span class="forum-category-name">ðŸ“„ Contrats</span>
                        <span class="forum-category-count" id="forum-count-retours_contrats">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_univers')" data-category="retours_univers">
                        <span class="forum-category-name">ðŸŒ Univers</span>
                        <span class="forum-category-count" id="forum-count-retours_univers">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_forum')" data-category="retours_forum">
                        <span class="forum-category-name">ðŸ’¬ Forum</span>
                        <span class="forum-category-count" id="forum-count-retours_forum">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_fil')" data-category="retours_fil">
                        <span class="forum-category-name">ðŸ“° Le Fil</span>
                        <span class="forum-category-count" id="forum-count-retours_fil">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_guide')" data-category="retours_guide">
                        <span class="forum-category-name">â“ Guide</span>
                        <span class="forum-category-count" id="forum-count-retours_guide">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_cours')" data-category="retours_cours">
                        <span class="forum-category-name">ðŸŽ“ Cours</span>
                        <span class="forum-category-count" id="forum-count-retours_cours">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_profil')" data-category="retours_profil">
                        <span class="forum-category-name">ðŸ‘¤ Mon Profil</span>
                        <span class="forum-category-count" id="forum-count-retours_profil">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_messages')" data-category="retours_messages">
                        <span class="forum-category-name">âœ‰ï¸ Messages</span>
                        <span class="forum-category-count" id="forum-count-retours_messages">0</span>
                    </div>
                    <div class="forum-category sub" onclick="app.Forum.switchCategory('retours_design')" data-category="retours_design">
                        <span class="forum-category-name">ðŸŽ¨ Design/ThÃ¨mes</span>
                        <span class="forum-category-count" id="forum-count-retours_design">0</span>
                    </div>
                </div>
                <div class="forum-category" onclick="app.Forum.switchCategory('scenario')" data-category="scenario">
                    <span class="forum-category-icon">ðŸ“</span>
                    <span class="forum-category-name">ScÃ©nario</span>
                    <span class="forum-category-count" id="forum-count-scenario">0</span>
                </div>
                <div class="forum-category" onclick="app.Forum.switchCategory('realisation')" data-category="realisation">
                    <span class="forum-category-icon">ðŸŽ¬</span>
                    <span class="forum-category-name">RÃ©alisation</span>
                    <span class="forum-category-count" id="forum-count-realisation">0</span>
                </div>
                <div class="forum-category" onclick="app.Forum.switchCategory('production')" data-category="production">
                    <span class="forum-category-icon">ðŸ’¼</span>
                    <span class="forum-category-name">Production</span>
                    <span class="forum-category-count" id="forum-count-production">0</span>
                </div>
                <div class="forum-category" onclick="app.Forum.switchCategory('postprod')" data-category="postprod">
                    <span class="forum-category-icon">âœ‚ï¸</span>
                    <span class="forum-category-name">Post-production</span>
                    <span class="forum-category-count" id="forum-count-postprod">0</span>
                </div>
            </div>
        </div>
        <div class="forum-main">
            <div class="forum-threads">
                <div class="forum-threads-header">
                    <span class="forum-threads-title" id="forum-category-title">ðŸ’¬ GÃ©nÃ©ral</span>
                    <div class="forum-sort">
                        <button class="forum-sort-btn active" onclick="app.Forum.sort('recent')">ðŸ• RÃ©cent</button>
                        <button class="forum-sort-btn" onclick="app.Forum.sort('popular')">ðŸ”¥ Populaire</button>
                        <button class="forum-sort-btn" onclick="app.Forum.sort('unresolved')">â“ Non rÃ©solu</button>
                    </div>
                </div>
                <div class="forum-new-thread">
                    <button class="forum-new-btn" onclick="app.Forum.openNewThread()">âž• Nouveau sujet</button>
                </div>
                <div id="forum-threads-list"></div>
            </div>
        </div>
    </div>
  </div>

  <!-- VUE MUR SOCIAL (FEED) -->
  <div id="feed-view" class="feed-view">
    <div class="feed-header">
        <div class="flex-row-center">
            <button onclick="app.Feed.close()" class="btn-secondary">â¬… Retour</button>
            <h1>ðŸ“° Le Fil</h1>
        </div>
        <div class="flex-row-gap10">
            <button class="theme-btn" onclick="app.UI.toggleTheme()">ðŸŒ“ Mode</button>
        </div>
    </div>
    <div class="feed-body">
        <div style="max-width:700px; width:100%; margin:0 auto;">
            <input type="text" id="feed-post-title" placeholder="Titre de votre publication" class="n8-input-1">
            <div class="editor-box">
                <div class="editor-toolbar">
                    <button data-command="bold" onclick="app.Editor.format('bold')" title="Gras"><b>G</b></button>
                    <button data-command="italic" onclick="app.Editor.format('italic')" title="Italique"><i>I</i></button>
                    <button data-command="underline" onclick="app.Editor.format('underline')" title="SoulignÃ©"><u>S</u></button>
                    <div class="separator"></div>
                    <button data-command="insertUnorderedList" onclick="app.Editor.format('insertUnorderedList')" title="Liste Ã  puces">â€¢</button>
                </div>
                <div class="editor-content" id="feed-post-text" contenteditable="true" data-placeholder="Votre message..." onkeyup="app.Editor.updateToolbarState()" onmouseup="app.Editor.updateToolbarState()"></div>
                <div id="feed-image-preview"></div>
                <div class="editor-actions">
                    <div class="editor-actions-left">
                        <button class="editor-btn" onclick="app.Feed.selectImage()">ðŸ–¼ï¸ Image</button>
                        <input type="file" id="feed-image-input" accept="image/*" class="d-none" onchange="app.Feed.handleImageSelect(event)">
                        <select id="feed-post-type" class="editor-btn" style="padding:8px 12px;">
                            <option value="statut">ðŸ’­ Statut</option>
                            <option value="annonce">ðŸ“¢ Annonce</option>
                            <option value="recherche">ðŸ” Recherche</option>
                        </select>
                    </div>
                    <button class="editor-btn editor-btn-primary" onclick="app.Feed.publish()">ðŸ“¤ Publier</button>
                </div>
            </div>
        </div>
        <div id="feed-posts"></div>
    </div>
  </div>

  <!-- VUE COURS CINÃ‰MA -->
  <div id="courses-view" class="courses-view">
    <div class="courses-header">
        <div class="flex-row-center">
            <button onclick="app.Courses.close()" class="btn-secondary">â¬… Retour</button>
            <h1>ðŸŽ“ Cours CinÃ©ma</h1>
        </div>
        <div class="flex-row-gap10">
            <button class="theme-btn" onclick="app.UI.toggleTheme()">ðŸŒ“ Mode</button>
        </div>
    </div>
    <div class="courses-body">
        <div class="courses-tabs" id="courses-tabs">
            <div class="courses-tab active" onclick="app.Courses.switchTab('scenario')">ðŸ“ ScÃ©nario</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('realisation')">ðŸŽ¬ RÃ©alisation</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('image')">ðŸ“· Image</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('son')">ðŸŽ¤ Son</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('montage')">âœ‚ï¸ Montage</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('production')">ðŸ’¼ Production</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('glossaire')">ðŸ“– Glossaire</div>
        </div>
        <div id="courses-content" class="courses-content"></div>
    </div>
  </div>
  
  <div id="app-view">
    <header>
      <div class="project-info">
        <button onclick="app.UI.showDashboard()" style="background:var(--border); color:var(--text-main); border:none; padding:5px 10px; border-radius:4px; margin-right:10px; font-weight:bold; cursor:pointer">â¬… Dashboard</button>
        <input id="projectTitle" type="text" value="Mon Film">
        <span id="sync-indicator" data-tooltip="Synchronisation" data-tooltip-pos="bottom" style="margin-left:8px; font-size:1rem; opacity:0.4; transition: all 0.3s;">â˜ï¸</span>
        <span id="role-badge" style="margin-left:10px; font-size:0.8rem; padding:4px 8px; background:var(--highlight); border-radius:4px; color:var(--text-main); border:1px solid var(--border)">PROPRIÃ‰TAIRE</span>
        <div id="presence-list" class="presence-bar"></div>
      </div>
      <div class="global-actions">
        <div class="menu-dropdown-container" onmouseenter="app.UI.showDropdown('fichier')" onmouseleave="app.UI.hideDropdown('fichier')">
          <button class="menu-dropdown-btn" data-tooltip="Ouvrir, sauvegarder, rÃ©initialiser" data-tooltip-pos="bottom"><span class="moteur-icon cat-system"><span class="emoji">ðŸ“</span><svg><use href="#ico-folder"/></svg></span> Fichier â–¾</button>
          <div id="dropdown-fichier" class="menu-dropdown">
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); document.getElementById('btnLoad').click()"><span class="moteur-icon cat-system"><span class="emoji">ðŸ“‚</span><svg><use href="#ico-folder"/></svg></span> Ouvrir un projet</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Actions.openVersionModal()"><span class="moteur-icon cat-system"><span class="emoji">ðŸ’¾</span><svg><use href="#ico-save"/></svg></span> Sauvegardes</div>
            <div class="menu-dropdown-separator"></div>
            <div class="menu-dropdown-item danger" onclick="app.UI.closeAllDropdowns(); document.getElementById('btnClear').click()"><span class="moteur-icon cat-admin"><span class="emoji">ðŸ—‘ï¸</span><svg><use href="#ico-trash"/></svg></span> Reset projet</div>
          </div>
        </div>
        <div class="menu-dropdown-container" onmouseenter="app.UI.showDropdown('projet')" onmouseleave="app.UI.hideDropdown('projet')">
          <button class="menu-dropdown-btn" data-tooltip="Partager, accÃ¨s, prÃ©sentation" data-tooltip-pos="bottom"><span class="moteur-icon cat-production"><span class="emoji">ðŸŽ¬</span><svg><use href="#ico-clapperboard"/></svg></span> Projet â–¾</button>
          <div id="dropdown-projet" class="menu-dropdown">
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Actions.openShareModal()"><span class="moteur-icon cat-social"><span class="emoji">ðŸ‘¥</span><svg><use href="#ico-users"/></svg></span> Partager</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Permissions.openModal()"><span class="moteur-icon cat-admin"><span class="emoji">ðŸ”</span><svg><use href="#ico-settings"/></svg></span> GÃ©rer les accÃ¨s</div>
            <div class="menu-dropdown-separator"></div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.PresentMode.start()"><span class="moteur-icon cat-visual"><span class="emoji">ðŸŽ¥</span><svg><use href="#ico-monitor"/></svg></span> Mode prÃ©sentation</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.History.openModal()"><span class="moteur-icon cat-writing"><span class="emoji">ðŸ“‹</span><svg><use href="#ico-clipboard"/></svg></span> Journal des modifications</div>
          </div>
        </div>
        <div class="menu-dropdown-container" onmouseenter="app.UI.showDropdown('export')" onmouseleave="app.UI.hideDropdown('export')">
          <button class="menu-dropdown-btn" data-tooltip="Exporter scÃ©nario, budget, PDF" data-tooltip-pos="bottom"><span class="moteur-icon cat-system"><span class="emoji">ðŸ“¤</span><svg><use href="#ico-download"/></svg></span> Export â–¾</button>
          <div id="dropdown-export" class="menu-dropdown align-right">
            <div class="menu-dropdown-label">ScÃ©nario</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.ScriptExport.toFountain()"><span class="moteur-icon cat-writing"><span class="emoji">ðŸ“œ</span><svg><use href="#ico-file-text"/></svg></span> Fountain (.fountain)</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.ScriptExport.toFDX()"><span class="moteur-icon cat-writing"><span class="emoji">ðŸŽ¬</span><svg><use href="#ico-clapperboard"/></svg></span> Final Draft (.fdx)</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Actions.openExportModal()"><span class="moteur-icon cat-writing"><span class="emoji">ðŸ–¨ï¸</span><svg><use href="#ico-download"/></svg></span> PDF / Imprimer</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Breakdown.exportPDF()"><span class="moteur-icon cat-production"><span class="emoji">ðŸ“‹</span><svg><use href="#ico-clipboard"/></svg></span> DÃ©pouillement PDF</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Storyboard.exportPDF()"><span class="moteur-icon cat-visual"><span class="emoji">ðŸŽ¨</span><svg><use href="#ico-grid"/></svg></span> Storyboard PDF</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Crew.exportPDF()"><span class="moteur-icon cat-production"><span class="emoji">ðŸ‘¥</span><svg><use href="#ico-users"/></svg></span> Ã‰quipe PDF</div>
            <div class="menu-dropdown-separator"></div>
            <div class="menu-dropdown-label">Budget</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Expenses.exportPDF()"><span class="moteur-icon cat-admin"><span class="emoji">ðŸ’°</span><svg><use href="#ico-wallet"/></svg></span> Budget PDF</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Expenses.exportExcel()"><span class="moteur-icon cat-admin"><span class="emoji">ðŸ“Š</span><svg><use href="#ico-chart"/></svg></span> Budget Excel (CSV)</div>
            <div class="menu-dropdown-divider"></div>
            <div class="menu-dropdown-label"><span class="moteur-icon cat-system"><span class="emoji">ðŸ“</span><svg><use href="#ico-folder"/></svg></span> Projet complet</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Exporter.productionReport()"><span class="moteur-icon cat-production"><span class="emoji">ðŸ“‹</span><svg><use href="#ico-clipboard"/></svg></span> Rapport de production</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Exporter.exportZIP()"><span class="moteur-icon cat-system"><span class="emoji">ðŸ“¦</span><svg><use href="#ico-box"/></svg></span> Export ZIP complet</div>
            <div class="menu-dropdown-separator"></div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Contracts.openModal()"><span class="moteur-icon cat-admin"><span class="emoji">ðŸ“</span><svg><use href="#ico-file-signature"/></svg></span> Contrats</div>
          </div>
        </div>
        <div class="tabs-position-dropdown" style="position:relative; display:inline-block;">
            <button class="theme-btn" onclick="app.UI.togglePositionMenu()" data-tooltip="Options d'affichage" data-tooltip-pos="bottom">ðŸ“</button>
            <div id="tabs-position-menu" class="position-dropdown-menu" style="display:none; position:absolute; top:100%; right:0; margin-top:5px; background:var(--panel-bg); border:1px solid var(--border); border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.2); z-index:10000; min-width:180px;">
                <div class="position-menu-item nav-item" onclick="app.FocusMode.toggle()" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem; border-bottom:1px solid var(--border); background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; font-weight: 600;">ðŸ–¥ï¸ Mode Focus (F11)</div>
                <div class="n8-misc-1">NAVIGATION</div>
                <div class="position-menu-item nav-item" onclick="app.UI.setNavModeFromMenu('classic')" data-nav="classic">ðŸ“‹ Classique</div>
                <div class="position-menu-item nav-item" onclick="app.UI.setNavModeFromMenu('categories')" data-nav="categories">ðŸ“ CatÃ©gories</div>
                <div id="position-section-label" style="padding:8px 15px; font-size:0.75rem; color:var(--text-sec); font-weight:600; border-bottom:1px solid var(--border); border-top:1px solid var(--border); margin-top:5px;">POSITION <span id="position-disabled-hint" style="display:none; font-weight:400; font-style:italic;">(Classique uniquement)</span></div>
                <div class="position-menu-item nav-item" onclick="app.UI.setTabsPosition('top')" data-pos="top">â¬†ï¸ Haut</div>
                <div class="position-menu-item nav-item" onclick="app.UI.setTabsPosition('bottom')" data-pos="bottom">â¬‡ï¸ Bas</div>
                <div class="position-menu-item nav-item" onclick="app.UI.setTabsPosition('left')" data-pos="left">â¬…ï¸ Gauche</div>
                <div class="position-menu-item nav-item" onclick="app.UI.setTabsPosition('right')" data-pos="right">âž¡ï¸ Droite</div>
                <div id="tabs-mode-section" style="border-top:1px solid var(--border); margin-top:5px;">
                    <div class="n8-misc-1">MODE</div>
                    <div class="position-menu-item nav-item" onclick="app.UI.setTabsModeFromMenu('scroll')" data-mode="scroll">â†”ï¸ DÃ©filant</div>
                    <div class="position-menu-item nav-item" onclick="app.UI.setTabsModeFromMenu('adaptive')" data-mode="adaptive">âš–ï¸ Adaptatif</div>
                </div>
                <div style="border-top:1px solid var(--border); margin-top:5px; padding:10px 15px;">
                    <button onclick="app.UI.resetTabsOrder(); app.UI.togglePositionMenu();" style="width:100%; padding:8px; background:var(--bg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:0.8rem;">â†©ï¸ RÃ©initialiser</button>
                </div>
            </div>
        </div>
        <div style="position:relative; display:inline-block;" onmouseenter="document.getElementById('design-dropdown-project').classList.add('show')" onmouseleave="document.getElementById('design-dropdown-project').classList.remove('show')">
          <button class="theme-btn" data-tooltip="Changer le design" data-tooltip-pos="bottom">ðŸŽ¨</button>
          <div id="design-dropdown-project" style="display:none; position:absolute; top:100%; right:0; background:var(--panel-bg); border:1px solid var(--border); border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:10000; min-width:150px; padding-top:5px;">
            <div onclick="app.UI.setDesign('classic')" class="nav-item-plain" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''">ðŸŽ¬ Classique</div>
            <div onclick="app.UI.setDesign('lavender')" class="nav-item-plain" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''">ðŸ’ Lavande</div>
            <div onclick="app.UI.setDesign('minimal')" class="nav-item-plain" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''">â¬œ Minimal</div>
          </div>
        </div>
        <button class="theme-btn" onclick="app.UI.toggleTheme()" data-tooltip="Changer le thÃ¨me clair/sombre" data-tooltip-pos="bottom">ðŸŒ“</button>
        <button id="btnSave" class="d-none">â˜ï¸ Sync</button>
        <button id="btnLoad" class="d-none">ðŸ“‚ Ouvrir</button>
        <button id="btnClear" class="d-none">ðŸ—‘ï¸ Reset</button>
      </div>
      <input type="file" id="fileInput" accept=".json" class="d-none">
    </header>

    <!-- Toolbar Mode Focus -->
    <div id="focus-toolbar" class="focus-toolbar d-none">
        <div class="focus-toolbar-left">
            <button class="focus-btn" onclick="app.FocusMode.exit()" data-tooltip="Quitter le mode focus (Ã‰chap)">âœ• Quitter</button>
        </div>
        <div class="focus-toolbar-center">
            <button class="focus-btn nav-btn" onclick="app.FocusMode.prevTab()" data-tooltip="Onglet prÃ©cÃ©dent (â†)">â—€</button>
            <span class="focus-tab-title" id="focus-tab-title">Onglet</span>
            <button class="focus-btn nav-btn" onclick="app.FocusMode.nextTab()" data-tooltip="Onglet suivant (â†’)">â–¶</button>
        </div>
        <div class="focus-toolbar-right">
            <span class="focus-project-title" id="focus-project-title"></span>
        </div>
    </div>

    <div id="quick-nav"></div>

    <!-- SÃ©lecteur de mode supprimÃ© - dÃ©placÃ© dans le menu ðŸ“ du header -->
    
    <!-- Navigation par catÃ©gories (niveau 1 + 2) -->
    <div class="tabs-categories-wrapper" id="tabsCategoriesWrapper">
    <nav class="tabs-categories" id="tabsCategories">
        <button class="tab-category active" draggable="true" data-category="ecriture" onclick="app.UI.switchCategory('ecriture')">
            <span class="tab-category-icon"><span class="moteur-icon cat-writing"><span class="emoji">ðŸ“</span><svg><use href="#ico-file-text"/></svg></span></span> Ã‰criture
            <span class="cat-close" onclick="event.stopPropagation(); app.UI.hideCategory('ecriture')">Ã—</span>
        </button>
        <button class="tab-category" draggable="true" data-category="casting" onclick="app.UI.switchCategory('casting')">
            <span class="tab-category-icon"><span class="moteur-icon cat-casting"><span class="emoji">ðŸŽ­</span><svg><use href="#ico-theater"/></svg></span></span> Casting & DÃ©cors
            <span class="cat-close" onclick="event.stopPropagation(); app.UI.hideCategory('casting')">Ã—</span>
        </button>
        <button class="tab-category" draggable="true" data-category="production" onclick="app.UI.switchCategory('production')">
            <span class="tab-category-icon"><span class="moteur-icon cat-production"><span class="emoji">ðŸŽ¬</span><svg><use href="#ico-clapperboard"/></svg></span></span> Production
            <span class="cat-close" onclick="event.stopPropagation(); app.UI.hideCategory('production')">Ã—</span>
        </button>
        <button class="tab-category" draggable="true" data-category="admin" onclick="app.UI.switchCategory('admin')">
            <span class="tab-category-icon"><span class="moteur-icon cat-admin"><span class="emoji">ðŸ“Š</span><svg><use href="#ico-chart"/></svg></span></span> Admin
            <span class="cat-close" onclick="event.stopPropagation(); app.UI.hideCategory('admin')">Ã—</span>
        </button>
        <button class="hidden-categories-toggle" id="hiddenCategoriesToggle" onclick="app.UI.toggleHiddenCategoriesMenu(event)" data-tooltip="Restaurer les Ã©lÃ©ments masquÃ©s" data-tooltip-pos="bottom">
            âŠ• MasquÃ©s <span class="hidden-count" id="hiddenCategoriesCount">0</span>
        </button>
    </nav>
    
    <!-- Sous-navigation par catÃ©gorie (niveau 2) -->
    <nav class="tabs-subnav active" id="tabsSubnav" data-category="ecriture">
        <button class="tab-subbtn active" data-tab="synopsis" onclick="app.UI.switchTab('synopsis')">Synopsis</button>
         <button class="tab-subbtn" data-tab="board" onclick="app.UI.switchTab('board')">SÃ©quencier / BB</button>
        <button class="tab-subbtn" data-tab="titlepage" onclick="app.UI.switchTab('titlepage')">Titre</button>
        <button class="tab-subbtn" data-tab="script" onclick="app.UI.switchTab('script')">ScÃ©nario</button>
        <button class="tab-subbtn" data-tab="moodboard" onclick="app.UI.switchTab('moodboard')">Mood Board</button>
        <button class="tab-subbtn" data-tab="storyboard" onclick="app.UI.switchTab('storyboard')">Storyboard</button>
    </nav>
    </div>
    
    <!-- Menu contextuel couleur onglet -->
    <div id="tab-color-menu" class="tab-color-menu">
        <div class="tab-color-menu-title">ðŸŽ¨ Couleur de l'onglet</div>
        <div class="tab-color-options">
            <div class="tab-color-option" style="background: #ef4444;" onclick="app.UI.setTabColor('#ef4444')"></div>
            <div class="tab-color-option" style="background: #f97316;" onclick="app.UI.setTabColor('#f97316')"></div>
            <div class="tab-color-option" style="background: #eab308;" onclick="app.UI.setTabColor('#eab308')"></div>
            <div class="tab-color-option" style="background: #22c55e;" onclick="app.UI.setTabColor('#22c55e')"></div>
            <div class="tab-color-option" style="background: #14b8a6;" onclick="app.UI.setTabColor('#14b8a6')"></div>
            <div class="tab-color-option" style="background: #3b82f6;" onclick="app.UI.setTabColor('#3b82f6')"></div>
            <div class="tab-color-option" style="background: #8b5cf6;" onclick="app.UI.setTabColor('#8b5cf6')"></div>
            <div class="tab-color-option" style="background: #ec4899;" onclick="app.UI.setTabColor('#ec4899')"></div>
            <div class="tab-color-option" style="background: #6b7280;" onclick="app.UI.setTabColor('#6b7280')"></div>
            <div class="tab-color-option" style="background: #1f2937;" onclick="app.UI.setTabColor('#1f2937')"></div>
        </div>
        <button class="tab-color-reset" onclick="app.UI.setTabColor(null)">â†© RÃ©initialiser</button>
        <hr style="margin: 10px 0; border: none; border-top: 1px solid var(--border);">
        <button class="tab-color-reset" onclick="app.UI.openTabHelp()" style="background: var(--primary);">â“ Aide sur cet onglet</button>
    </div>
    
    <nav class="tabs-nav adaptive" id="tabsNav">
    <div class="tab-btn active" draggable="true" data-tab="presentation" onclick="app.UI.switchTab('presentation')"><span>1. PRÃ‰SENTATION</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('presentation')" data-tooltip="Masquer">Ã—</button></div>
        <div class="tab-btn" draggable="true" data-tab="synopsis" onclick="app.UI.switchTab('synopsis')"><span>2. SYNOPSIS</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('synopsis')" data-tooltip="Masquer cet onglet" data-tooltip-pos="bottom">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="board" onclick="app.UI.switchTab('board')"><span>3. SÃ‰QUENCIER / BB</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('board')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="titlepage" onclick="app.UI.switchTab('titlepage')"><span>4. TITRE</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('titlepage')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="script" onclick="app.UI.switchTab('script')"><span>4. SCÃ‰NARIO</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('script')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="moodboard" onclick="app.UI.switchTab('moodboard')"><span>5. MOOD BOARD</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('moodboard')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="storyboard" onclick="app.UI.switchTab('storyboard')"><span>6. STORYBOARD</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('storyboard')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="chars" onclick="app.UI.switchTab('chars')"><span>7. PERSONNAGES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('chars')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="actors" onclick="app.UI.switchTab('actors')"><span>8. COMÃ‰DIEN.NES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('actors')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="locs" onclick="app.UI.switchTab('locs')"><span>9. DÃ‰CORS</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('locs')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="resources" onclick="app.UI.switchTab('resources')"><span>10. RESSOURCES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('resources')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="crew" onclick="app.UI.switchTab('crew')"><span>11. Ã‰QUIPES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('crew')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="breakdown" onclick="app.UI.switchTab('breakdown')"><span>12. DÃ‰POUILLEMENT</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('breakdown')" title="Masquer cet onglet">Ã—</button></div>
      <div class="tab-btn" draggable="true" data-tab="stats" onclick="app.UI.switchTab('stats')"><span>13. STATISTIQUES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('stats')" title="Masquer cet onglet">Ã—</button></div>
     <div class="tab-btn" draggable="true" data-tab="planning" onclick="app.UI.switchTab('planning')"><span>14. PLANNING</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('planning')" title="Masquer cet onglet">Ã—</button></div>
<div class="tab-btn" draggable="true" data-tab="scriptreport" onclick="app.UI.switchTab('scriptreport')"><span>15. RAPPORT</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('scriptreport')" title="Masquer cet onglet">Ã—</button></div>
<div class="tab-btn" draggable="true" data-tab="expenses" onclick="app.UI.switchTab('expenses')"><span>16. DÃ‰PENSES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('expenses')" title="Masquer cet onglet">Ã—</button></div>
<div class="tab-btn" draggable="true" data-tab="chat" onclick="app.UI.switchTab('chat')"><span>17. CHAT</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('chat')" title="Masquer cet onglet">Ã—</button></div>
<div class="tab-btn-hidden-toggle d-none" id="hiddenTabsToggle" onclick="app.UI.toggleHiddenTabsMenu(event)">âŠ• MasquÃ©s<span class="hidden-count" id="hiddenTabsCount">0</span></div>
<div class="hidden-tabs-menu" id="hiddenTabsMenu"></div>
    </nav>

    <main>
      <div id="print-cover">
          <h1 id="pc-title">TITRE</h1>
          <p id="pc-author">Auteur</p>
          <div class="print-contact" id="pc-contact"></div>
      </div>

<div id="tab-presentation" class="tab-content active">
          <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
            <h2 style="margin-bottom: 20px; color: var(--primary);">ðŸ“‹ PrÃ©sentation du Projet</h2>
            
            <!-- Image et infos de base -->
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 30px; margin-bottom: 30px;">
              <div class="text-center">
                <div id="project-image-placeholder" onclick="document.getElementById('project-image-file').click()" style="width: 200px; height: 280px; background: var(--bg); border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 3rem; color: var(--text-sec);">ðŸŽ¬</div>
                <img id="project-image-preview" src="" onclick="document.getElementById('project-image-file').click()" style="width: 200px; height: 280px; object-fit: cover; border-radius: 8px; display: none; cursor: pointer;">
                <input type="file" id="project-image-file" accept="image/*" class="d-none" onchange="app.Presentation.uploadImage(event)">
                <input type="hidden" id="project-image-input" value="">
                <div id="project-image-status" style="font-size: 0.8rem; color: var(--text-sec); margin-top: 5px;"></div>
              </div>
              <div>
                <div class="mb-15">
                  <label class="label-sec-block">Titre du projet</label>
                  <div id="project-title-display" style="font-size: 1.5rem; font-weight: bold; color: var(--text-main);"></div>
                </div>
                <div class="grid-2col">
                  <div>
                    <label class="label-sec-block">Type de projet</label>
                    <select id="project-type" class="form-input" onchange="app.Presentation.save()">
                      <option value="">-- SÃ©lectionner --</option>
                      <option value="court-metrage">Court-mÃ©trage</option>
                      <option value="long-metrage">Long-mÃ©trage</option>
                      <option value="serie">SÃ©rie / Web-sÃ©rie</option>
                      <option value="documentaire">Documentaire</option>
                      <option value="clip">Clip musical</option>
                      <option value="pub">PublicitÃ©</option>
                      <option value="corporate">Film corporate</option>
                      <option value="autre">Autre</option>
                    </select>
                  </div>
                  <div>
                    <label class="label-sec-block">Genre</label>
                    <select id="project-genre" class="form-input" onchange="app.Presentation.save()">
                      <option value="">-- SÃ©lectionner --</option>
                      <option value="drame">Drame</option>
                      <option value="comedie">ComÃ©die</option>
                      <option value="thriller">Thriller</option>
                      <option value="horreur">Horreur</option>
                      <option value="sf">Science-Fiction</option>
                      <option value="fantastique">Fantastique</option>
                      <option value="action">Action</option>
                      <option value="romance">Romance</option>
                      <option value="animation">Animation</option>
                      <option value="experimental">ExpÃ©rimental</option>
                      <option value="autre">Autre</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Dates -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">ðŸ“… Dates du Projet</h3>
                <button type="button" class="visibility-btn" id="project-vis-btn-dates" data-section="dates" onclick="app.Presentation.toggleSectionVisibility('dates')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              
              <!-- PrÃ©-production -->
              <div class="mb-15">
                <h4 class="subtitle-sec">ðŸ“ PrÃ©-production</h4>
                <div class="grid-2col">
                  <div>
                    <label class="form-label">DÃ©but</label>
                    <input type="date" id="project-date-preprod-start" class="form-input" onchange="app.Presentation.save()">
                  </div>
                  <div>
                    <label class="form-label">Fin</label>
                    <input type="date" id="project-date-preprod-end" class="form-input" onchange="app.Presentation.save()">
                  </div>
                </div>
              </div>
              
              <!-- Tournage -->
              <div class="mb-15">
                <h4 class="subtitle-sec">ðŸŽ¬ Tournage</h4>
                <div class="grid-2col">
                  <div>
                    <label class="form-label">DÃ©but</label>
                    <input type="date" id="project-date-shooting-start" class="form-input" onchange="app.Presentation.save()">
                  </div>
                  <div>
                    <label class="form-label">Fin</label>
                    <input type="date" id="project-date-shooting-end" class="form-input" onchange="app.Presentation.save()">
                  </div>
                </div>
              </div>
              
              <!-- Post-production -->
              <div class="mb-15">
                <h4 class="subtitle-sec">ðŸŽžï¸ Post-production</h4>
                <div class="grid-2col">
                  <div>
                    <label class="form-label">DÃ©but</label>
                    <input type="date" id="project-date-postprod-start" class="form-input" onchange="app.Presentation.save()">
                  </div>
                  <div>
                    <label class="form-label">Fin</label>
                    <input type="date" id="project-date-postprod-end" class="form-input" onchange="app.Presentation.save()">
                  </div>
                </div>
              </div>
              
              <!-- Distribution -->
              <div>
                <h4 class="subtitle-sec">ðŸŽ­ Distribution</h4>
                <div class="grid-2col">
                  <div>
                    <label class="form-label">Sortie PrÃ©vue</label>
                    <input type="date" id="project-date-release" class="form-input" onchange="app.Presentation.save()">
                  </div>
                  <div>
                    <label class="form-label">Fin Distribution</label>
                    <input type="date" id="project-date-distribution-end" class="form-input" onchange="app.Presentation.save()">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Localisation -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">ðŸ“ Localisation</h3>
                <button type="button" class="visibility-btn" id="project-vis-btn-location" data-section="location" onclick="app.Presentation.toggleSectionVisibility('location')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                  <label class="form-label">Ville</label>
                  <input type="text" id="project-city" placeholder="Paris, Lyon, Marseille..." class="form-input" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label class="form-label">RÃ©gion</label>
                  <input type="text" id="project-region" placeholder="ÃŽle-de-France, PACA..." class="form-input" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label class="form-label">Pays</label>
                  <input type="text" id="project-country" value="France" class="form-input" onchange="app.Presentation.save()">
                </div>
              </div>
            </div>
            
            <!-- Ã‰quipe actuelle -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">ðŸ‘¥ Ã‰quipe Actuelle</h3>
                <button type="button" class="visibility-btn" id="project-vis-btn-team" data-section="team" onclick="app.Presentation.toggleSectionVisibility('team')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              <p class="text-sec-sm-mb15">Ajoutez les membres clÃ©s de votre Ã©quipe.</p>
              
              <!-- Budget -->
              <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                <label class="form-label">ðŸ’° Budget prÃ©vu (â‚¬)</label>
                <input type="number" id="project-budget" placeholder="Ex: 50000" style="width: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
              </div>
              
              <!-- Liste des membres -->
              <div id="project-team-list" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;"></div>
              
              <!-- Bouton ajouter -->
              <button onclick="app.Presentation.openTeamMemberModal()" style="padding: 10px 20px; background: var(--bg); border: 1px dashed var(--primary); border-radius: 6px; cursor: pointer; color: var(--primary); font-size: 0.9rem; width: 100%;">
                âž• Ajouter un membre Ã  l'Ã©quipe
              </button>
            </div>
            
            <!-- Modal ajout membre Ã©quipe -->
            <div id="team-member-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
              <div style="background: var(--panel-bg); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div class="section-header-20">
                  <h3 class="heading-primary">ðŸ‘¤ Ajouter un membre</h3>
                  <button onclick="app.Presentation.closeTeamMemberModal()" class="icon-btn">âœ•</button>
                </div>
                
                <!-- RÃ´le -->
                <div class="mb-15">
                  <label class="form-label">RÃ´le dans le projet *</label>
                  <select id="team-member-role" class="form-input">
                    <option value="">-- SÃ©lectionner un rÃ´le --</option>
                    <optgroup label="Production">
                      <option value="ProducteurÂ·rice">ProducteurÂ·rice</option>
                      <option value="ProducteurÂ·rice exÃ©cutifÂ·ve">ProducteurÂ·rice exÃ©cutifÂ·ve</option>
                      <option value="DirecteurÂ·rice de production">DirecteurÂ·rice de production</option>
                      <option value="ChargÃ©Â·e de production">ChargÃ©Â·e de production</option>
                    </optgroup>
                    <optgroup label="RÃ©alisation">
                      <option value="RÃ©alisateurÂ·rice">RÃ©alisateurÂ·rice</option>
                      <option value="1erÂ·Ã¨re assistantÂ·e rÃ©alisateurÂ·rice">1erÂ·Ã¨re assistantÂ·e rÃ©alisateurÂ·rice</option>
                      <option value="ScÃ©nariste">ScÃ©nariste</option>
                    </optgroup>
                    <optgroup label="Image">
                      <option value="DirecteurÂ·rice photo">DirecteurÂ·rice photo</option>
                      <option value="CadreurÂ·se">CadreurÂ·se</option>
                    </optgroup>
                    <optgroup label="Son">
                      <option value="IngÃ©nieurÂ·e son">IngÃ©nieurÂ·e son</option>
                      <option value="Perchiste">Perchiste</option>
                    </optgroup>
                    <optgroup label="Autres">
                      <option value="Autre">Autre (prÃ©ciser)</option>
                    </optgroup>
                  </select>
                </div>
                
                <!-- RÃ´le personnalisÃ© -->
                <div id="team-member-custom-role-div" class="d-none-mb15">
                  <label class="form-label">PrÃ©ciser le rÃ´le</label>
                  <input type="text" id="team-member-custom-role" placeholder="Ex: Coordinateur cascades" class="form-input">
                </div>
                
                <!-- Recherche personne existante -->
                <div class="mb-15">
                  <label class="form-label">Rechercher une personne existante</label>
                  <input type="text" id="team-member-search" placeholder="ðŸ” Nom, email..." class="form-input" oninput="app.Presentation.searchTeamMember(this.value)">
                  <div id="team-member-search-results" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
                </div>
                
                <!-- Ou crÃ©er nouveau -->
                <div style="text-align: center; margin: 15px 0; color: var(--text-sec);">â€” ou â€”</div>
                
                <div class="mb-15">
                  <label class="form-label">CrÃ©er une nouvelle personne</label>
                  <input type="text" id="team-member-new-name" placeholder="Nom complet" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); margin-bottom: 10px;">
                  <input type="email" id="team-member-new-email" placeholder="Email (optionnel)" class="form-input">
                </div>
                
                <!-- Boutons -->
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                  <button onclick="app.Presentation.closeTeamMemberModal()" class="btn-border">Annuler</button>
                  <button onclick="app.Presentation.addTeamMember()" class="btn-primary">âœ“ Ajouter</button>
                </div>
              </div>
            </div>
            
            <!-- Informations lÃ©gales employeur (pour contrats) -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">âš–ï¸ Informations LÃ©gales (Contrats)</h3>
                <button type="button" class="visibility-btn hidden-section" id="project-vis-btn-legal" data-section="legal" onclick="app.Presentation.toggleSectionVisibility('legal')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              <p class="text-sec-sm-mb15">Ces informations seront prÃ©-remplies dans les contrats gÃ©nÃ©rÃ©s (CDDU, Prestation, Droit Ã  l'image).</p>
              
              <div class="grid-2col-mb15">
                <div>
                  <label class="form-label">Nom / Raison sociale *</label>
                  <input type="text" id="project-producer" placeholder="Nom de la sociÃ©tÃ© ou producteur" class="form-input" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label class="form-label">ReprÃ©sentant lÃ©gal *</label>
                  <input type="text" id="project-director" placeholder="Nom du reprÃ©sentant" class="form-input" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <div class="grid-2col-mb15">
                <div>
                  <label class="form-label">NÂ° SIRET</label>
                  <input type="text" id="project-siret" placeholder="123 456 789 00012" class="form-input" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label class="form-label">Code APE/NAF</label>
                  <input type="text" id="project-ape" placeholder="5911A" class="form-input" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <div class="grid-2col-mb15">
                <div>
                  <label class="form-label">NÂ° Licence entrepreneur spectacle</label>
                  <input type="text" id="project-licence" placeholder="PLATESV-..." class="form-input" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label class="form-label">URSSAF de rattachement</label>
                  <input type="text" id="project-urssaf" placeholder="Ex: URSSAF ÃŽle-de-France" class="form-input" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <div class="grid-2col-mb15">
                <div>
                  <label class="form-label">NÂ° CongÃ©s Spectacles employeur</label>
                  <input type="text" id="project-conges-spectacles" placeholder="NÂ° affiliation" class="form-input" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label class="form-label">Email contact (RGPD)</label>
                  <input type="email" id="project-email-legal" placeholder="contact@production.fr" class="form-input" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <div class="grid-2col">
                <div>
                  <label class="form-label">Adresse complÃ¨te</label>
                  <input type="text" id="project-address-legal" placeholder="Adresse du siÃ¨ge social" class="form-input" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label class="form-label">QualitÃ© du reprÃ©sentant</label>
                  <input type="text" id="project-director-title" placeholder="Ex: GÃ©rant, PrÃ©sident, Producteur dÃ©lÃ©guÃ©" class="form-input" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <p style="font-size: 0.8rem; color: var(--text-sec); margin-top: 15px; font-style: italic;">ðŸ’¡ Ces informations sont optionnelles mais recommandÃ©es pour gÃ©nÃ©rer des contrats complets et conformes.</p>
            </div>
            
            <!-- Type de Production -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">ðŸ¤ Type de production</h3>
                <button type="button" class="visibility-btn" id="project-vis-btn-productionType" data-section="productionType" onclick="app.Presentation.toggleSectionVisibility('productionType')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              <p class="text-sec-sm-mb15">Indiquez le type de collaboration recherchÃ©e pour ce projet.</p>
              <div class="project-type-selector" id="project-type-selector">
                <div class="project-type-card pro" data-type="pro" onclick="app.Presentation.setProductionType('pro')">
                  <div class="icon">ðŸŽ¬</div>
                  <div class="label">Production Pro</div>
                  <div class="desc">Contrats, horaires et tarifs standards</div>
                </div>
                <div class="project-type-card semi-pro" data-type="semi-pro" onclick="app.Presentation.setProductionType('semi-pro')">
                  <div class="icon">âš¡</div>
                  <div class="label">Production Semi-pro</div>
                  <div class="desc">Ã‰quipe payÃ©e, conditions flexibles</div>
                </div>
                <div class="project-type-card benevole" data-type="benevole" onclick="app.Presentation.setProductionType('benevole')">
                  <div class="icon">â¤ï¸</div>
                  <div class="label">Production BÃ©nÃ©vole</div>
                  <div class="desc">DÃ©fraiement uniquement (repas + transport)</div>
                </div>
              </div>
            </div>
            
            <!-- Partenaires (Associations & Entreprises) -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">ðŸ¤ Partenaires du Projet</h3>
                <button type="button" class="visibility-btn" id="project-vis-btn-partners" data-section="partners" onclick="app.Presentation.toggleSectionVisibility('partners')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              <p class="text-sec-sm-mb15">Ajoutez les associations et entreprises partenaires de votre projet.</p>
              
              <!-- Associations -->
              <div class="mb-20">
                <h4 style="margin: 0 0 10px; color: var(--text-main); font-size: 0.95rem;">ðŸ›ï¸ Associations</h4>
                <div id="project-associations-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>
                <button onclick="app.Presentation.openPartnerSearch('association')" class="n8-badge-2">
                  âž• Ajouter une association
                </button>
              </div>
              
              <!-- Entreprises -->
              <div>
                <h4 style="margin: 0 0 10px; color: var(--text-main); font-size: 0.95rem;">ðŸ¢ Entreprises</h4>
                <div id="project-enterprises-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>
                <button onclick="app.Presentation.openPartnerSearch('enterprise')" class="n8-badge-2">
                  âž• Ajouter une entreprise
                </button>
              </div>
            </div>
            
            <!-- Description -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">ðŸ“ Note d'intention / Description</h3>
                <button type="button" class="visibility-btn" id="project-vis-btn-description" data-section="description" onclick="app.Presentation.toggleSectionVisibility('description')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              <textarea id="project-description" placeholder="DÃ©crivez votre projet, son univers, son intention artistique..." style="width: 100%; min-height: 150px; padding: 15px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); resize: vertical; font-family: inherit;" onchange="app.Presentation.save()"></textarea>
            </div>
            
            <!-- Besoins Techniciens -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">ðŸŽ¬ Besoins Techniciens</h3>
                <button type="button" class="visibility-btn" id="project-vis-btn-crew" data-section="crew" onclick="app.Presentation.toggleSectionVisibility('crew')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              <p class="text-sec-sm-mb15">Cochez les postes dont vous avez besoin et indiquez le nombre de personnes recherchÃ©es.</p>
              <div id="needs-crew-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;"></div>
              <button onclick="app.Presentation.addCustomCrewNeed()" style="margin-top: 15px; padding: 8px 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">âž• Ajouter un autre poste</button>
            </div>
            
            <!-- Besoins ComÃ©diens -->
            <div class="panel-card">
              <div class="section-header">
                <h3 class="heading-primary">ðŸŽ­ Besoins ComÃ©diens / Casting</h3>
                <button type="button" class="visibility-btn" id="project-vis-btn-casting" data-section="casting" onclick="app.Presentation.toggleSectionVisibility('casting')" title="VisibilitÃ© dans l'Univers">ðŸŒ <span class="vis-icon">ðŸ‘ï¸</span></button>
              </div>
              <p class="text-sec-sm-mb15">DÃ©finissez les rÃ´les que vous recherchez pour le casting.</p>
              <div id="needs-actors-list"></div>
              <button onclick="app.Presentation.addActorNeed()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">âž• Ajouter un rÃ´le Ã  caster</button>
            </div>
            
            <!-- VisibilitÃ© -->
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid var(--border); border-radius: 12px; padding: 20px; color: white;">
              <h3 style="margin: 0 0 15px; color: #e94560;">ðŸŒ VisibilitÃ© dans l'Univers</h3>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="project-public" style="width: 20px; height: 20px;" onchange="app.Presentation.save()">
                <span class="fw-600">Rendre ce projet visible dans l'Univers</span>
              </label>
              <p style="margin: 10px 0 0; font-size: 0.85rem; opacity: 0.8;">Les comÃ©diens et techniciens pourront voir votre projet et vous contacter. Utilisez les boutons <span style="background: var(--bg); color: var(--text-main); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">ðŸŒ ðŸ‘ï¸</span> sur chaque section pour contrÃ´ler ce qui est visible publiquement.</p>
            </div>
          </div>
        </div>

      <div id="tab-synopsis" class="tab-content">
        <h1 class="print-only-title">SYNOPSIS & RÃ‰SUMÃ‰S</h1>
        <div class="synopsis-section-wrapper">

          <!-- SYNOPSIS -->
          <div class="synopsis-section">
            <span class="section-label">Synopsis</span>
            <div class="synopsis-editor-wrapper">
              <div class="synopsis-toolbar" id="synopsisToolbar">
                <select onchange="app.Synopsis.formatBlock(this.value, 'synopsis'); this.selectedIndex=0;" title="Style">
                  <option value="">Styleâ€¦</option>
                  <option value="p">Paragraphe</option>
                  <option value="h1">Titre 1</option>
                  <option value="h2">Titre 2</option>
                  <option value="h3">Titre 3</option>
                  <option value="blockquote">Citation</option>
                </select>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('bold')" title="Gras"><b>G</b></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('italic')" title="Italique"><i>I</i></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('underline')" title="SoulignÃ©"><u>S</u></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('strikeThrough')" title="BarrÃ©"><s>B</s></button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('insertUnorderedList')" title="Liste Ã  puces">â€¢ â€”</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('insertOrderedList')" title="Liste numÃ©rotÃ©e">1.</button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('justifyLeft')" title="Aligner gauche">â«·</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('justifyCenter')" title="Centrer">â˜°</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('justifyRight')" title="Aligner droite">â«¸</button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.insertImage('synopsis')" title="InsÃ©rer image">ðŸ–¼ï¸</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.insertTable('synopsis')" title="InsÃ©rer tableau">â–¦</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('insertHorizontalRule')" title="Ligne horizontale">â€•</button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('removeFormat')" title="Effacer formatage">âœ•</button>
              </div>
              <div class="synopsis-a4-page">
                <div class="synopsis-editor-box" id="synopsisEditor" contenteditable="true" data-placeholder="Ã‰crivez votre synopsis iciâ€¦" data-type="synopsis"></div>
              </div>
            </div>
          </div>

          <!-- RÃ‰SUMÃ‰ COURT -->
          <div class="synopsis-section">
            <span class="section-label">RÃ©sumÃ© Court</span>
            <div class="synopsis-editor-wrapper">
              <div class="synopsis-toolbar" id="shortToolbar">
                <select onchange="app.Synopsis.formatBlock(this.value, 'short'); this.selectedIndex=0;" title="Style">
                  <option value="">Styleâ€¦</option>
                  <option value="p">Paragraphe</option>
                  <option value="h1">Titre 1</option>
                  <option value="h2">Titre 2</option>
                  <option value="h3">Titre 3</option>
                  <option value="blockquote">Citation</option>
                </select>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('bold')" title="Gras"><b>G</b></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('italic')" title="Italique"><i>I</i></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('underline')" title="SoulignÃ©"><u>S</u></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('strikeThrough')" title="BarrÃ©"><s>B</s></button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('insertUnorderedList')" title="Liste Ã  puces">â€¢ â€”</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('insertOrderedList')" title="Liste numÃ©rotÃ©e">1.</button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.insertImage('short')" title="InsÃ©rer image">ðŸ–¼ï¸</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.insertTable('short')" title="InsÃ©rer tableau">â–¦</button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('removeFormat')" title="Effacer formatage">âœ•</button>
              </div>
              <div class="synopsis-a4-page">
                <div class="synopsis-editor-box" id="shortEditor" contenteditable="true" data-placeholder="Pitch / RÃ©sumÃ© courtâ€¦" data-type="short"></div>
              </div>
            </div>
          </div>

          <!-- RÃ‰SUMÃ‰ LONG -->
          <div class="synopsis-section" style="border-bottom:none;">
            <span class="section-label">RÃ©sumÃ© Long</span>
            <div class="synopsis-editor-wrapper">
              <div class="synopsis-toolbar" id="longToolbar">
                <select onchange="app.Synopsis.formatBlock(this.value, 'long'); this.selectedIndex=0;" title="Style">
                  <option value="">Styleâ€¦</option>
                  <option value="p">Paragraphe</option>
                  <option value="h1">Titre 1</option>
                  <option value="h2">Titre 2</option>
                  <option value="h3">Titre 3</option>
                  <option value="blockquote">Citation</option>
                </select>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('bold')" title="Gras"><b>G</b></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('italic')" title="Italique"><i>I</i></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('underline')" title="SoulignÃ©"><u>S</u></button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('strikeThrough')" title="BarrÃ©"><s>B</s></button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('insertUnorderedList')" title="Liste Ã  puces">â€¢ â€”</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('insertOrderedList')" title="Liste numÃ©rotÃ©e">1.</button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.insertImage('long')" title="InsÃ©rer image">ðŸ–¼ï¸</button>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.insertTable('long')" title="InsÃ©rer tableau">â–¦</button>
                <span class="synopsis-toolbar-sep"></span>
                <button class="synopsis-toolbar-btn" onmousedown="event.preventDefault()" onclick="app.Synopsis.exec('removeFormat')" title="Effacer formatage">âœ•</button>
              </div>
              <div class="synopsis-a4-page">
                <div class="synopsis-editor-box" id="longEditor" contenteditable="true" data-placeholder="Traitement / RÃ©sumÃ© longâ€¦" data-type="long"></div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div id="tab-board" class="tab-content">
        <h1 class="print-only-title">SÃ‰QUENCIER</h1>
        <div class="board-layout">
            <div class="board-sidebar">
                <h4 class="heading-border">Vue</h4>
                <div class="mb-15">
                    <label class="label-bold-fw">Type de vue</label>
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <button id="view-mode-sequencer" onclick="app.BeatBoard.setViewMode('sequencer')" class="board-mode-btn active" style="flex: 1; padding: 10px 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--primary); color: white; font-size: 0.85rem;">ðŸ“‹ SÃ©quencier</button>
                        <button id="view-mode-beatboard" onclick="app.BeatBoard.setViewMode('beatboard')" class="board-mode-btn" style="flex: 1; padding: 10px 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main); font-size: 0.85rem;">ðŸŽ¯ Beat Board</button>
                    </div>
                </div>
                <div id="sequencer-options">
                <h4 class="heading-border">Affichage</h4>
                <div class="mb-15">
                    <label class="label-bold-fw">Mode d'affichage</label>
                    <div class="flex-gap5">
                        <button id="board-mode-normal" onclick="app.UI.setBoardMode('normal')" class="board-mode-btn active" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--primary); color: white;">ðŸ“‹ Normal</button>
                        <button id="board-mode-compact" onclick="app.UI.setBoardMode('compact')" class="board-mode-btn" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main);">ðŸ“‘ Compact</button>
                    </div>
                </div>
                <div class="sidebar-toggles">
                    <label><input type="checkbox" id="toggleSynop" checked onchange="app.UI.toggleSidebarContent()"> Synopsis</label>
                    <label><input type="checkbox" id="toggleShort" onchange="app.UI.toggleSidebarContent()"> RÃ©sumÃ© Court</label>
                    <label><input type="checkbox" id="toggleLong" onchange="app.UI.toggleSidebarContent()"> RÃ©sumÃ© Long</label>
                </div>
                <div id="boardSynopBlock" class="sidebar-content-block visible">
                    <strong>SYNOPSIS</strong>
                    <p id="boardSynopsisDisplay" class="pre-wrap"></p>
                </div>
                <div id="boardShortBlock" class="sidebar-content-block">
                    <strong>RÃ‰SUMÃ‰ COURT</strong>
                    <p id="boardShortDisplay" class="pre-wrap"></p>
                </div>
                <div id="boardLongBlock" class="sidebar-content-block">
                    <strong>RÃ‰SUMÃ‰ LONG</strong>
                    <p id="boardLongDisplay" class="pre-wrap"></p>
                </div>
                <hr>
                <div style="font-size:0.8rem; color:var(--text-sec); margin-top:20px">Astuce: Clic-droit sur une carte pour gÃ©rer les Tags/Couleurs.</div>
                </div><!-- fin sequencer-options -->
                <div id="beatboard-options" class="d-none">
                    <h4 class="heading-border">Beat Board</h4>
                    <div class="mb-15">
                        <label class="label-bold-fw">Disposition</label>
                        <div class="flex-col-gap5">
                            <button onclick="app.BeatBoard.autoLayout('horizontal')" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main); font-size: 0.8rem;">â†”ï¸ Ligne horizontale</button>
                            <button onclick="app.BeatBoard.autoLayout('grid')" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main); font-size: 0.8rem;">âŠž Grille</button>
                            <button onclick="app.BeatBoard.autoLayout('byTag')" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main); font-size: 0.8rem;">ðŸ·ï¸ Par groupe/tag</button>
                        </div>
                    </div>
                    <div class="mb-15">
                        <label class="label-bold-fw">Fil rouge</label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
                            <input type="checkbox" id="beatboard-show-line" checked onchange="app.BeatBoard.toggleLine()">
                            Afficher le fil rouge
                        </label>
                    </div>
                    <div class="mb-15">
                        <label class="label-bold-fw">Groupes (Tags)</label>
                        <div id="beatboard-tag-list" class="flex-col-gap5"></div>
                    </div>
                    <div class="mb-15">
                        <label class="label-bold-fw">ðŸ§µ Lignes de suivi</label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer; margin-bottom: 8px;">
                            <input type="checkbox" id="beatboard-show-tag-lines" onchange="app.BeatBoard.toggleTagLines()">
                            Afficher les lignes de tags
                        </label>
                        <div id="beatboard-tag-lines-list" style="display: flex; flex-direction: column; gap: 3px; max-height: 200px; overflow-y: auto;"></div>
                        <div style="font-size:0.75rem; color:var(--text-sec); margin-top:6px;">Chaque ligne relie les scÃ¨nes d'un mÃªme tag dans l'ordre chronologique.</div>
                    </div>
                    <hr style="border:none; border-top:1px solid var(--border); margin: 15px 0;">
                    <button onclick="app.BeatBoard.createScene()" style="width:100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem;">âž• Nouvelle scÃ¨ne</button>
                    <div style="font-size:0.8rem; color:var(--text-sec); margin-top:15px">
                        ðŸ’¡ <strong>Drag</strong> = dÃ©placer visuellement<br>
                        ðŸ’¡ <strong>Shift+Drag</strong> = rÃ©ordonner dans le fil rouge<br>
                        ðŸ’¡ <strong>Ctrl+Clic</strong> = sÃ©lection multiple
                    </div>
                </div>
            </div>
            <div class="board-main" id="sequencer-view">
                <div id="edit-scene-form" class="controls-row" style="background:var(--panel-bg); padding:15px; border-radius:8px; border:1px solid var(--border); margin-bottom:15px; display:block">
                  <div class="seq-header-row">
                      <div class="seq-input-group">
                          <input id="inpPre" placeholder="INT"><span>.</span><input id="inpLoc" placeholder="LIEU"><span>-</span><input id="inpSuff" placeholder="JOUR">
                      </div>
                      <input id="inpTime" placeholder="DurÃ©e (min)">
                  </div>
                  <div class="autocomplete-wrapper"><input id="inpPerso" placeholder="Personnages..."><div id="autocomplete-list" class="autocomplete-list"></div></div>
                  <textarea id="inpResume" rows="2" placeholder="RÃ©sumÃ©..."></textarea>
                  <div style="margin-top:10px"><button onclick="app.Actions.addScene()" style="width:100%; padding:10px; background:var(--primary); color:#fff; border:none; border-radius:4px; font-weight:bold; cursor:pointer">âž• Ajouter ScÃ¨ne</button></div>
                </div>
                <div id="boardList"></div>
            </div>
            <div id="beatboard-view" class="board-main" style="display:none; padding: 0;">
                <div class="beatboard-container" id="beatboardContainer">
                    <div class="beatboard-canvas" id="beatboardCanvas">
                        <svg class="beatboard-svg" id="beatboardSvg"></svg>
                    </div>
                    <div class="beatboard-zoom">
                        <button onclick="app.BeatBoard.zoomOut()" title="Zoom -">âž–</button>
                        <span id="beatboardZoomLevel">100%</span>
                        <button onclick="app.BeatBoard.zoomIn()" title="Zoom +">âž•</button>
                        <button onclick="app.BeatBoard.zoomReset()" title="RÃ©initialiser">ðŸ”„</button>
                        <button onclick="app.BeatBoard.fitToView()" title="Ajuster Ã  la vue">â›¶</button>
                    </div>
                    <div class="beatboard-minimap" id="beatboardMinimap">
                        <div class="beatboard-minimap-viewport" id="beatboardMinimapViewport"></div>
                    </div>
                </div>
            </div>
        </div>
      </div>
	  
      <div id="tab-titlepage" class="tab-content">
        <div style="max-width: 700px; margin: 0 auto; padding: 40px 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="font-size: 1.5rem; margin-bottom: 10px;">ðŸ“ Page de titre</h2>
            <p class="text-sec">Ces informations apparaÃ®tront sur la page de titre lors de l'export PDF, Fountain ou Final Draft.</p>
          </div>
          
          <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 30px;">
            <div class="grid-gap20">
              <div>
                <label class="label-bold-8">Titre du scÃ©nario</label>
                <input type="text" id="tp-title" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); font-size: 1.1rem;" placeholder="Titre du film" oninput="app.TitlePage.save()">
              </div>
              
              <div class="grid-2col">
                <div>
                  <label class="label-bold-8">Auteur</label>
                  <input type="text" id="tp-author" class="form-input-lg" placeholder="PrÃ©nom Nom" oninput="app.TitlePage.save()">
                </div>
                <div>
                  <label class="label-bold-8">Co-auteur (optionnel)</label>
                  <input type="text" id="tp-coauthor" class="form-input-lg" placeholder="PrÃ©nom Nom" oninput="app.TitlePage.save()">
                </div>
              </div>
              
              <div>
                <label class="label-bold-8">Contact</label>
                <input type="text" id="tp-contact" class="form-input-lg" placeholder="email@exemple.com ou tÃ©lÃ©phone" oninput="app.TitlePage.save()">
              </div>
              
              <div class="grid-2col">
                <div>
                  <label class="label-bold-8">Version / Draft</label>
                  <select id="tp-draft" class="form-input-lg" onchange="app.TitlePage.save()">
                    <option value="">-- SÃ©lectionner --</option>
                    <option value="Premier jet">Premier jet</option>
                    <option value="DeuxiÃ¨me jet">DeuxiÃ¨me jet</option>
                    <option value="TroisiÃ¨me jet">TroisiÃ¨me jet</option>
                    <option value="Version de tournage">Version de tournage</option>
                    <option value="Version finale">Version finale</option>
                  </select>
                </div>
                <div>
                  <label class="label-bold-8">Date</label>
                  <input type="date" id="tp-date" class="form-input-lg" oninput="app.TitlePage.save()">
                </div>
              </div>
              
              <div>
                <label class="label-bold-8">BasÃ© sur (optionnel)</label>
                <input type="text" id="tp-source" class="form-input-lg" placeholder="Ex: le roman de Victor Hugo" oninput="app.TitlePage.save()">
              </div>
              
              <div>
                <label class="label-bold-8">Copyright (optionnel)</label>
                <input type="text" id="tp-copyright" class="form-input-lg" placeholder="Â© 2026 Nom ou SociÃ©tÃ©" oninput="app.TitlePage.save()">
              </div>
              
              <div>
                <label class="label-bold-8">Notes (optionnel)</label>
                <textarea id="tp-notes" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); resize: vertical;" placeholder="Notes supplÃ©mentaires..." oninput="app.TitlePage.save()"></textarea>
              </div>
            </div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center; color: var(--text-sec); font-size: 0.85rem;">
              ðŸ’¾ Sauvegarde automatique
            </div>
          </div>
        </div>
      </div>

      <div id="tab-script" class="tab-content">
          <h1 class="print-only-title">SCÃ‰NARIO</h1>
          
          <!-- BARRE UNIFIÃ‰E -->
          <div class="script-unified-bar">
              <div class="script-unified-inner">
                  <div class="script-unified-left">
                      <button id="script-view-scenes" class="view-btn active" onclick="app.ScriptEditor.setViewMode('scenes')">ðŸ“‘ Vue ScÃ¨nes</button>
                      <button id="script-view-continuous" class="view-btn" onclick="app.ScriptEditor.setViewMode('continuous')">ðŸ“œ Vue Script</button>
                  </div>
                  <div class="script-unified-right" id="continuous-toolbar">
                      <button class="fmt-btn active" data-type="sc-action" onclick="app.ScriptEditor.formatContinuous('sc-action', event)" onmousedown="event.preventDefault()">Action</button>
                      <button class="fmt-btn" data-type="sc-perso" onclick="app.ScriptEditor.formatContinuous('sc-perso', event)" onmousedown="event.preventDefault()">Perso</button>
                      <button class="fmt-btn" data-type="sc-dial" onclick="app.ScriptEditor.formatContinuous('sc-dial', event)" onmousedown="event.preventDefault()">Dial</button>
                      <button class="fmt-btn" data-type="sc-paren" onclick="app.ScriptEditor.formatContinuous('sc-paren', event)" onmousedown="event.preventDefault()">Didas</button>
                      <button class="fmt-btn" data-type="sc-trans" onclick="app.ScriptEditor.formatContinuous('sc-trans', event)" onmousedown="event.preventDefault()">Trans</button>
                      <button class="fmt-btn" data-type="sc-centered" onclick="app.ScriptEditor.formatContinuous('sc-centered', event)" onmousedown="event.preventDefault()">CentrÃ©</button>
                      <button class="fmt-btn" data-type="sc-note" onclick="app.ScriptEditor.formatContinuous('sc-note', event)" onmousedown="event.preventDefault()">Note</button>
                  </div>
              </div>
          </div>
          
          <!-- Vue ScÃ¨nes -->
          <div class="script-view" id="scriptContainer"></div>
          
          <!-- Vue Script Continu -->
          <div class="script-continuous-wrapper d-none" id="scriptContinuousContainer">
              <div class="script-continuous-sidebar" id="scriptContinuousSidebar"></div>
              <div class="script-continuous-main">
                  <div class="script-continuous-editor" id="scriptContinuousEditor"></div>
              </div>
          </div>
      </div>
      
      <!-- TAB MOOD BOARD -->
      <div id="tab-moodboard" class="tab-content">
        <div class="moodboard-container">
          <!-- Toolbar -->
       <div class="moodboard-toolbar">
            <button class="primary" onclick="app.MoodBoard.createBoard()">+ Nouvelle planche</button>
            <div style="border-left: 1px solid var(--border); height: 30px; margin: 0 10px;"></div>
            <span class="text-sec-sm2">ðŸ’¡ Clic droit sur le canvas pour ajouter des Ã©lÃ©ments</span>
            <div style="border-left: 1px solid var(--border); height: 30px; margin: 0 10px;"></div>
            <select id="moodboardFormat" onchange="app.MoodBoard.changeFormat(this.value)">
              <option value="free">ðŸ“ Libre (infini)</option>
              <option value="a4-landscape">A4 Paysage</option>
              <option value="a4-portrait">A4 Portrait</option>
              <option value="a3-landscape">A3 Paysage</option>
              <option value="a3-portrait">A3 Portrait</option>
              <option value="a2-landscape">A2 Paysage</option>
              <option value="a2-portrait">A2 Portrait</option>
              <option value="a0-landscape">A0 Paysage</option>
              <option value="a0-portrait">A0 Portrait</option>
            </select>
            <div style="margin-left: auto; display: flex; gap: 10px;">
              <button class="secondary" onclick="app.MoodBoard.exportPNG()">ðŸ“· Export PNG</button>
              <button class="secondary" onclick="app.MoodBoard.exportPDF()">ðŸ“„ Export PDF</button>
              <button class="secondary" onclick="app.MoodBoard.toggleInfoPanel()">â„¹ï¸ Infos</button>
            </div>
          </div>
          
          <!-- Liste des planches -->
          <div class="moodboard-boards-list" id="moodboardBoardsList">
            <!-- Planches gÃ©nÃ©rÃ©es dynamiquement -->
          </div>
          
          <!-- Conteneur principal avec sidebar + canvas -->
          <div class="moodboard-main-container">
            <!-- Colonne gauche : liste des Ã©lÃ©ments -->
            <div class="moodboard-elements-sidebar" id="moodboardElementsSidebar">
              <div class="moodboard-sidebar-header">
                <span>ðŸ“‹ Ã‰lÃ©ments</span>
                <span class="moodboard-elements-count" id="moodboardElementsCount">0</span>
              </div>
              <div class="moodboard-elements-list" id="moodboardElementsList">
                <p style="color: var(--text-sec); text-align: center; padding: 20px; font-size: 0.85rem;">Aucun Ã©lÃ©ment</p>
              </div>
            </div>
            
            <!-- Zone de travail -->
            <div class="moodboard-canvas-wrapper" id="moodboardCanvasWrapper">
            <div class="moodboard-canvas format-free" id="moodboardCanvas">
              <!-- Ã‰lÃ©ments du mood board -->
            </div>
            
            <!-- ContrÃ´les de zoom -->
            <div class="moodboard-zoom-controls">
              <button onclick="app.MoodBoard.zoomOut()">âˆ’</button>
              <span id="moodboardZoomLevel">100%</span>
              <button onclick="app.MoodBoard.zoomIn()">+</button>
              <button onclick="app.MoodBoard.zoomReset()">âŸ²</button>
            </div>
            
            <!-- Minimap -->
            <div class="moodboard-minimap" id="moodboardMinimap">
              <div class="moodboard-minimap-content" id="moodboardMinimapContent">
                <div class="moodboard-minimap-viewport" id="moodboardMinimapViewport"></div>
              </div>
            </div>
            
            <!-- Panneau d'info Ã©lÃ©ment/planche -->
            <div class="moodboard-info-panel" id="moodboardInfoPanel">
              <h4>
                <span id="moodboardInfoTitle">PropriÃ©tÃ©s</span>
                <button onclick="app.MoodBoard.toggleInfoPanel()" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;">Ã—</button>
              </h4>
              <div id="moodboardInfoContent">
                <!-- Contenu dynamique -->
              </div>
            </div>
            
            <!-- Ã‰tat vide -->
            <div class="moodboard-empty" id="moodboardEmpty">
              <div class="moodboard-empty-icon">ðŸŽ¨</div>
              <h3>Mood Board</h3>
              <p>CrÃ©ez des planches d'inspiration pour dÃ©finir l'univers visuel de votre film. Images, palettes de couleurs, rÃ©fÃ©rences...</p>
              <button class="primary" onclick="app.MoodBoard.createBoard()" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">+ CrÃ©er ma premiÃ¨re planche</button>
            </div>
          </div>
          </div><!-- Fin moodboard-main-container -->
        </div>
      </div>

	  <div id="tab-storyboard" class="tab-content">
    <h1 class="print-only-title">STORYBOARD</h1>
    
    <div class="sb-view-toggle">
        <button class="sb-toggle-btn active" onclick="app.Storyboard.switchView('edit')">ðŸ“ Ã‰dition</button>
        <button class="sb-toggle-btn" onclick="app.Storyboard.switchView('preview')">ðŸ‘ï¸ Mini AperÃ§u</button>
        <button class="sb-toggle-btn" onclick="app.Storyboard.openFullscreen()">ðŸ–¨ï¸ AperÃ§u Plein Ã‰cran</button>
        
        <div class="sb-print-config" style="margin-left: auto;">
            <button class="sb-config-btn" onclick="app.Storyboard.toggleConfig()">âš™ï¸ Configuration Print</button>
            <div class="sb-config-panel" id="sbConfigPanel">
                <h4 style="margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">Ã‰lÃ©ments Ã  imprimer</h4>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-shot-number" checked>
                    <label for="cfg-shot-number">NumÃ©ro de plan</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-shot-type" checked>
                    <label for="cfg-shot-type">Type de plan</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-camera-move" checked>
                    <label for="cfg-camera-move">Mouvement camÃ©ra</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-camera-mode" checked>
                    <label for="cfg-camera-mode">Mode camÃ©ra</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-description" checked>
                    <label for="cfg-description">Description</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-actor-direction" checked>
                    <label for="cfg-actor-direction">Direction acteurs</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-tech-direction" checked>
                    <label for="cfg-tech-direction">Direction technique</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-scene-title" checked>
                    <label for="cfg-scene-title">Titre de scÃ¨ne</label>
                </div>
                <button onclick="app.Storyboard.applyConfig()" style="width: 100%; margin-top: 15px; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Appliquer</button>
            </div>
        </div>
    </div>
    
    <div class="storyboard-layout" id="sbEditView">
        <div class="storyboard-scenes" id="sbScenesList"></div>
        <div class="storyboard-shots">
            <div id="sbNoScene" style="text-align: center; color: var(--text-sec); margin-top: 50px;">
                SÃ©lectionnez une scÃ¨ne Ã  gauche
            </div>
            <div id="sbShotsContainer" class="d-none">
                <button onclick="app.Storyboard.addShot()" style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px;">
                    âž• Ajouter un Plan
                </button>
                <div id="sbShotsList"></div>
            </div>
        </div>
    </div>
    
    <div class="sb-print-preview" id="sbPrintPreview"></div>
</div>

<div class="sb-fullscreen-modal" id="sbFullscreenModal">
    <div class="sb-fullscreen-header">
        <h2 class="m-0">AperÃ§u Impression Storyboard</h2>
        <div class="flex-gap10">
            <button onclick="window.print()" class="btn-primary">ðŸ–¨ï¸ Imprimer</button>
            <button onclick="app.Storyboard.closeFullscreen()" style="padding: 10px 20px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">âœ– Fermer</button>
        </div>
    </div>
    <div class="sb-fullscreen-content" id="sbFullscreenContent"></div>
</div>
	  
      <div id="tab-chars" class="tab-content">
          <h1 class="print-only-title">PERSONNAGES</h1>
          <button onclick="app.Actions.addGroup('perso')" class="n8-badge-4">âž• Nouveau Groupe</button>
          <div id="charContainer"></div>
      </div>
      
      <div id="tab-actors" class="tab-content">
          <h1 class="print-only-title">COMÃ‰DIEN.NES</h1>
          <div style="display:flex; gap:10px; margin-bottom:20px;">
              <button onclick="app.Actions.addGroup('actor')" class="n8-badge-9">âž• Nouveau Groupe</button>
              <button onclick="app.Actions.addActor()" style="padding:8px 15px;cursor:pointer;background:var(--primary);color:#fff;border:none;border-radius:4px;font-weight:bold;">âž• Ajouter ComÃ©dien.ne</button>
              <button onclick="app.Contacts.importToProject('actors')" class="btn-panel-bold">ðŸ“‡ Mes contacts</button>
              <button onclick="app.GlobalSearch.openActors()" class="n8-btn-2">ðŸ” Rechercher un.e comÃ©dien.ne</button>
              <button onclick="app.ActorSearch.toggleFilters()" class="btn-panel-bold">âš™ï¸ Filtrer projet</button>
          </div>
          <div id="actor-filters" style="display:none; margin-top:15px; padding:15px; background:var(--panel-bg); border:1px solid var(--border); border-radius:8px;">
              <div class="flex-wrap-gap10">
                  <input type="text" id="filter-name" placeholder="ðŸ” Rechercher par nom..." style="padding:8px; border:1px solid var(--border); border-radius:4px; min-width:200px;" oninput="app.ActorSearch.applyFilters()">
                  <select id="filter-gender" class="input-mini" onchange="app.ActorSearch.applyFilters()">
                      <option value="">Tous les sexes</option>
                      <option value="homme">Homme</option>
                      <option value="femme">Femme</option>
                      <option value="non-binaire">Non-binaire</option>
                  </select>
                  <select id="filter-ethnicity" class="input-mini" onchange="app.ActorSearch.applyFilters()">
                      <option value="">Toutes origines</option>
                      <option value="caucasien">Caucasien</option>
                      <option value="africain">Africain</option>
                      <option value="asiatique">Asiatique</option>
                      <option value="latino">Latino</option>
                      <option value="maghrebin">MaghrÃ©bin</option>
                      <option value="moyenorient">Moyen-Orient</option>
                      <option value="indien">Indien</option>
                      <option value="metis">MÃ©tis</option>
                  </select>
                  <select id="filter-hair" class="input-mini" onchange="app.ActorSearch.applyFilters()">
                      <option value="">Tous cheveux</option>
                      <option value="noir">Noir</option>
                      <option value="brun">Brun</option>
                      <option value="chatain">ChÃ¢tain</option>
                      <option value="blond">Blond</option>
                      <option value="roux">Roux</option>
                      <option value="gris">Gris</option>
                      <option value="chauve">Chauve</option>
                  </select>
                  <select id="filter-eyes" class="input-mini" onchange="app.ActorSearch.applyFilters()">
                      <option value="">Tous yeux</option>
                      <option value="marron">Marron</option>
                      <option value="bleu">Bleu</option>
                      <option value="vert">Vert</option>
                      <option value="gris">Gris</option>
                      <option value="noisette">Noisette</option>
                      <option value="noir">Noir</option>
                  </select>
              </div>
              <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px;">
                  <div style="display:flex; align-items:center; gap:5px;">
                      <label class="fs-085">Ã‚ge:</label>
                      <input type="number" id="filter-age-min" placeholder="Min" class="input-mini-60" oninput="app.ActorSearch.applyFilters()">
                      <span>-</span>
                      <input type="number" id="filter-age-max" placeholder="Max" class="input-mini-60" oninput="app.ActorSearch.applyFilters()">
                  </div>
                  <div style="display:flex; align-items:center; gap:5px;">
                      <label class="fs-085">Taille (cm):</label>
                      <input type="number" id="filter-height-min" placeholder="Min" class="input-mini-60" oninput="app.ActorSearch.applyFilters()">
                      <span>-</span>
                      <input type="number" id="filter-height-max" placeholder="Max" class="input-mini-60" oninput="app.ActorSearch.applyFilters()">
                  </div>
                  <input type="text" id="filter-sports" placeholder="Sport (ex: Ã©quitation)" style="padding:8px; border:1px solid var(--border); border-radius:4px; width:150px;" oninput="app.ActorSearch.applyFilters()">
                  <input type="text" id="filter-languages" placeholder="Langue (ex: anglais)" style="padding:8px; border:1px solid var(--border); border-radius:4px; width:150px;" oninput="app.ActorSearch.applyFilters()">
                  <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer;">
                      <input type="checkbox" id="filter-vehicle" onchange="app.ActorSearch.applyFilters()"> ðŸš— VÃ©hicule
                  </label>
                  <button onclick="app.ActorSearch.resetFilters()" style="padding:6px 12px; background:var(--danger); color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.85rem;">âœ– RÃ©initialiser</button>
              </div>
              <div id="filter-results-count" style="margin-top:10px; font-size:0.85rem; color:var(--text-sec);"></div>
          </div>
          <div id="actorContainer"></div>
      </div>

      <div id="tab-locs" class="tab-content">
          <h1 class="print-only-title">DÃ‰CORS</h1>
          <button onclick="app.Actions.addGroup('lieu')" class="n8-badge-4">âž• Nouveau Groupe</button>
          <div id="locContainer"></div>
      </div>
      
      <div id="tab-resources" class="tab-content">
          <h1 class="print-only-title">RESSOURCES</h1>
          <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center;">
              <button onclick="app.Resources.add()" class="n8-btn-4">âž• Nouvelle Ressource</button>
              <div style="display:flex; gap:5px; margin-left:auto;">
                  <button class="res-filter-btn active" data-filter="all" onclick="app.Resources.filter('all')">Tous</button>
                  <button class="res-filter-btn" data-filter="accessoire" onclick="app.Resources.filter('accessoire')">ðŸŽ­ Accessoires</button>
                  <button class="res-filter-btn" data-filter="costume" onclick="app.Resources.filter('costume')">ðŸ‘” Costumes</button>
                  <button class="res-filter-btn" data-filter="vehicule" onclick="app.Resources.filter('vehicule')">ðŸš— VÃ©hicules</button>
              </div>
          </div>
          <div id="resourcesContainer" class="resources-grid"></div>
          <div id="resourcesEmpty" class="empty-state d-none">
              <div class="empty-icon">ðŸ“¦</div>
              <h3>Aucune ressource</h3>
              <p>Ajoutez vos accessoires, costumes et vÃ©hicules pour les lier aux scÃ¨nes via le dÃ©pouillement.</p>
              <button onclick="app.Resources.add()" class="empty-action">âž• Ajouter une ressource</button>
          </div>
      </div>

	<div id="tab-crew" class="tab-content">
		<h1 class="print-only-title">Ã‰QUIPES</h1>
		<div style="display:flex; gap:10px; margin-bottom:20px;">
			<button onclick="app.Actions.addGroup('crew')" class="n8-badge-9">âž• Nouveau DÃ©partement</button>
			<button onclick="app.Crew.addMember()" class="n8-btn-4">âž• Ajouter Technicien</button>
            <button onclick="app.Contacts.importToProject('crew')" class="btn-panel-bold">ðŸ“‡ Mes contacts</button>
            <button onclick="app.GlobalSearch.openCrew()" class="n8-btn-2">ðŸ” Rechercher un.e technicien.ne</button>
		</div>
		<div id="crewContainer"></div>
	</div>
	  
<div id="tab-stats" class="tab-content">
    <h1 class="print-only-title">STATISTIQUES</h1>
    
    <!-- Cartes rÃ©sumÃ© -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total ScÃ¨nes</div>
            <div class="stat-number" id="stat-total-scenes">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Dialogues</div>
            <div class="stat-number" id="stat-total-dials">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">DurÃ©e EstimÃ©e</div>
            <div class="stat-number" id="stat-total-time">0 min</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Plans</div>
            <div class="stat-number" id="stat-total-shots">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Ã‰quipe Technique</div>
            <div class="stat-number" id="stat-total-crew">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Budget Ã‰quipe</div>
            <div class="stat-number" id="stat-total-budget" style="font-size: 1.8rem;">0 â‚¬</div>
        </div>
    </div>

    <!-- Section Avancement -->
    <div class="stats-section-title">ðŸ“ˆ Avancement du projet</div>
    <div class="charts-row-advanced">
        <div class="chart-box-advanced">
            <div class="chart-title">ScÃ¨nes planifiÃ©es</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progress-scenes-planned" style="width: 0%; background: linear-gradient(90deg, #4CAF50, #8BC34A);">0%</div>
            </div>
            <div class="stats-legend" id="legend-scenes-planned"></div>
        </div>
        <div class="chart-box-advanced">
            <div class="chart-title">RÃ©partition INT / EXT</div>
            <div class="chart-canvas-container">
                <canvas id="chart-int-ext"></canvas>
            </div>
        </div>
        <div class="chart-box-advanced">
            <div class="chart-title">RÃ©partition JOUR / NUIT</div>
            <div class="chart-canvas-container">
                <canvas id="chart-jour-nuit"></canvas>
            </div>
        </div>
    </div>

    <!-- Section Budget -->
    <div class="stats-section-title">ðŸ’° Budget</div>
    <div class="charts-row-advanced">
        <div class="chart-box-advanced">
            <div class="chart-title">DÃ©penses par catÃ©gorie</div>
            <div class="chart-canvas-container">
                <canvas id="chart-budget-cat"></canvas>
            </div>
        </div>
        <div class="chart-box-advanced">
            <div class="chart-title">Budget vs DÃ©penses</div>
            <div class="budget-comparison">
                <div class="budget-item">
                    <div class="budget-item-label">Budget prÃ©vu</div>
                    <div class="budget-item-value" id="budget-prevu">0 â‚¬</div>
                </div>
                <div class="budget-item">
                    <div class="budget-item-label">DÃ©pensÃ©</div>
                    <div class="budget-item-value" id="budget-depense">0 â‚¬</div>
                </div>
                <div class="budget-item">
                    <div class="budget-item-label">Reste</div>
                    <div class="budget-item-value" id="budget-reste">0 â‚¬</div>
                </div>
            </div>
            <div class="progress-bar-container mt-15">
                <div class="progress-bar-fill" id="progress-budget" style="width: 0%; background: linear-gradient(90deg, #2196F3, #03A9F4);">0%</div>
            </div>
        </div>
    </div>

    <!-- Section Temps -->
    <div class="stats-section-title">â±ï¸ Temps par Tag/Acte</div>
    <div class="charts-row-advanced">
        <div class="chart-box-advanced col-span-2">
            <div class="chart-title">DurÃ©e estimÃ©e par Tag</div>
            <div class="chart-canvas-container" style="height: 300px;">
                <canvas id="chart-time-tags"></canvas>
            </div>
        </div>
    </div>

    <!-- Graphiques existants -->
    <div class="stats-section-title">ðŸ‘¥ Personnages & Lieux</div>
    <div class="charts-row">
        <div class="chart-box">
            <div class="chart-title">Personnages (Nombre de mots)</div>
            <div id="chart-chars"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">RÃ©partition par Axe (Tags)</div>
            <div id="chart-tags"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">Lieux (Nombre de scÃ¨nes)</div>
            <div id="chart-lieux"></div>
        </div>
    </div>

    <div class="stats-section-title">ðŸŽ¬ Ã‰quipe & Storyboard</div>
    <div class="charts-row">
        <div class="chart-box">
            <div class="chart-title">Ã‰quipe par DÃ©partement</div>
            <div id="chart-crew"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">Plans par Type</div>
            <div id="chart-shots"></div>
        </div>
    </div>

    <div class="stats-section-title">ðŸŽ­ Jours de Tournage par ComÃ©dien</div>
    <div class="charts-row">
        <div class="chart-box col-span-2">
            <div class="chart-title">Jours planifiÃ©s par comÃ©dien</div>
            <div id="chart-actor-days"></div>
        </div>
    </div>
</div>

<div id="tab-breakdown" class="tab-content">
          <h1 class="print-only-title">DÃ‰POUILLEMENT</h1>
          <div class="breakdown-layout">
              <svg id="bd-link-svg"></svg>
              <div class="breakdown-col" id="breakdownScriptCol">
                  <div class="bd-header">SCÃ‰NARIO</div>
                  <div class="bd-content" id="bdScriptContent" oncontextmenu="app.Breakdown.handleRightClick(event)">
                      <div style="color:var(--text-sec);text-align:center;margin-top:20px">SÃ©lectionnez une scÃ¨ne Ã  droite.</div>
                  </div>
              </div>
              <div class="breakdown-col">
                  <div class="bd-header">DÃ‰POUILLEMENT PAR SCÃˆNE</div>
                  <div class="bd-content" id="bdRightContent" style="padding:0"></div>
              </div>
          </div>
      </div>

<div id="tab-chat" class="tab-content">
    <div style="display: flex; height: calc(100vh - 200px); gap: 20px; padding: 20px;">
        <!-- Liste des canaux -->
        <div style="width: 280px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                <h3 class="m-0-fs1">ðŸ’¬ Canaux</h3>
            </div>
            <div id="chat-channels-list" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
            <div style="padding: 10px; border-top: 1px solid var(--border);">
                <button onclick="app.Chat.createCustomChannel()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">âž• Nouveau groupe</button>
            </div>
        </div>
        
        <!-- Zone de chat principale -->
        <div style="flex: 1; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column;">
            <div id="chat-main-header" class="n8-flex-4">
                <h3 class="m-0-fs1" id="chat-channel-title">ðŸ“¢ SÃ©lectionnez un canal</h3>
                <div>
                    <button id="chat-members-btn" onclick="app.Chat.toggleMembersPanel()" style="padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; display: none;">ðŸ‘¥ Membres</button>
                </div>
            </div>
            <div id="chat-messages-container" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;">
                <div class="chat-empty">
                    <p class="fs-2-mb10">ðŸ’¬</p>
                    <p>SÃ©lectionnez un canal pour commencer Ã  discuter</p>
                </div>
            </div>
            <div id="chat-input-container" style="padding: 15px; border-top: 1px solid var(--border); display: none;">
                <div class="flex-gap10">
                    <input type="text" id="chat-message-input" class="chat-input" placeholder="Ã‰crivez votre message..." onkeypress="if(event.key === 'Enter') app.Chat.sendMessage()">
                    <button onclick="app.Chat.sendMessage()" class="chat-send-btn">âž¤</button>
                </div>
            </div>
        </div>
        
        <!-- Panel des membres (cachÃ© par dÃ©faut) -->
        <div id="chat-members-panel" style="width: 250px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; display: none; flex-direction: column;">
            <div class="n8-flex-4">
                <h3 class="m-0-fs1">ðŸ‘¥ Membres</h3>
                <button onclick="app.Chat.toggleMembersPanel()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">âœ–</button>
            </div>
            <div id="chat-members-list" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
            <div id="chat-add-member-section" style="padding: 10px; border-top: 1px solid var(--border); display: none;">
                <button onclick="app.Chat.showAddMemberModal()" style="width: 100%; padding: 8px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer;">âž• Ajouter un membre</button>
            </div>
        </div>
    </div>
</div>

<div id="tab-planning" class="tab-content">
    <h1 class="print-only-title">PLANNING DE TOURNAGE</h1>
    
    <div class="planning-availability-panel" style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-start;">
            <!-- ComÃ©diens -->
            <div style="flex: 1; min-width: 280px;">
                <strong style="display: block; margin-bottom: 8px;">ðŸŽ­ ComÃ©dien.nes</strong>
                <div class="pos-relative">
                    <input type="text" id="planning-actors-search" placeholder="ðŸ” Rechercher un comÃ©dien..." 
                           oninput="app.Planning.filterAvailabilityList('actors')"
                           class="n8-badge-3">
                    <div id="planning-actors-dropdown" class="n8-dropdown-1"></div>
                </div>
                <div id="planning-actors-tags" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 32px;"></div>
            </div>
            <!-- Techniciens -->
            <div style="flex: 1; min-width: 280px;">
                <strong style="display: block; margin-bottom: 8px;">ðŸŽ¥ Technicien.nes</strong>
                <div class="pos-relative">
                    <input type="text" id="planning-crew-search" placeholder="ðŸ” Rechercher un technicien..." 
                           oninput="app.Planning.filterAvailabilityList('crew')"
                           class="n8-badge-3">
                    <div id="planning-crew-dropdown" class="n8-dropdown-1"></div>
                </div>
                <div id="planning-crew-tags" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 32px;"></div>
            </div>
        </div>
    </div>
    
    <div class="planning-header">
        <div class="planning-header-row">
            <div class="planning-nav">
                <button class="planning-nav-btn" onclick="app.Planning.prev()">â—€ PrÃ©cÃ©dent</button>
                <div class="planning-title" id="planningTitle">Juin 2025</div>
                <button class="planning-nav-btn" onclick="app.Planning.next()">Suivant â–¶</button>
                <div class="planning-view-toggle" id="calendar-view-toggle">
                    <button class="planning-view-btn active" onclick="app.Planning.setView('month')">Mois</button>
                    <button class="planning-view-btn" onclick="app.Planning.setView('week')">Semaine</button>
                    <button class="planning-view-btn" onclick="app.Planning.setView('day')">Jour</button>
                </div>
                <button class="planning-nav-btn" onclick="app.Planning.goToday()">Aujourd'hui</button>
            </div>
            
            <div class="planning-view-toggle">
                <button class="planning-view-btn active" id="planning-mode-calendar" onclick="app.Planning.setMode('calendar')">ðŸ“… Calendrier</button>
                <button class="planning-view-btn" id="planning-mode-kanban" onclick="app.Planning.setMode('kanban')">ðŸ“Š Kanban</button>
                <button class="planning-view-btn" id="planning-mode-workplan" onclick="app.Planning.setMode('workplan')">ðŸ“‹ Plan de travail</button>
            </div>
        </div>
        
        <div class="planning-actions" style="justify-content: center;">
            <button class="planning-action-btn primary" onclick="app.Planning.addShootDay()">âž• Ajouter Jour</button>
            <button class="planning-action-btn success" onclick="app.Planning.openCallSheets()">ðŸ“„ Feuilles de Service</button>
            <button class="planning-action-btn secondary" onclick="app.Planning.exportICS()">ðŸ“… Export .ICS</button>
            <button class="planning-action-btn secondary" onclick="app.Planning.showAvailabilityView()">ðŸ‘¥ DisponibilitÃ©s</button>
        </div>
    </div>
    
    <div id="planningContainer"></div>
    
    <!-- Vue Plan de Travail (DOOD) -->
    <div id="workplanContainer" class="d-none">
        <div id="workplanContent"></div>
    </div>
    
    <!-- Vue Kanban -->
    <div id="kanbanContainer" class="d-none">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
            <div class="flex-row-gap10">
                <span style="color: var(--text-sec); font-size: 0.9rem;">ðŸ“Š Filtrer par type :</span>
                <select id="kanban-type-filter" onchange="app.Planning.renderKanban()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="all">Tous les types</option>
                    <option value="tournage">ðŸŽ¬ Tournage</option>
                    <option value="repetition">ðŸŽ­ RÃ©pÃ©tition</option>
                    <option value="reperage">ðŸ” RepÃ©rage</option>
                    <option value="essai-costume">ðŸ‘— Essai costume</option>
                    <option value="essai-maquillage">ðŸ’„ Essai maquillage</option>
                    <option value="formation">ðŸ“š Formation</option>
                    <option value="reunion">ðŸ“‹ RÃ©union</option>
                    <option value="autre">ðŸ“Œ Autre</option>
                </select>
            </div>
            <button onclick="app.Planning.renderKanban()" style="padding: 8px 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-main);">ðŸ”„ RafraÃ®chir</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px 0;">
            <div class="kanban-column" id="kanban-todo">
                <div class="kanban-column-header" style="background: var(--bg); padding: 12px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #6b7280;">
                    <span class="fs-11">ðŸ“ Ã€ faire</span>
                    <span class="kanban-count" id="kanban-count-todo" style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
                </div>
                <div class="kanban-column-body kanban-body" id="kanban-body-todo"></div>
            </div>
            <div class="kanban-column" id="kanban-planned">
                <div class="kanban-column-header" style="background: var(--bg); padding: 12px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #3b82f6;">
                    <span class="fs-11">ðŸ“… PlanifiÃ©</span>
                    <span class="kanban-count" id="kanban-count-planned" style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
                </div>
                <div class="kanban-column-body kanban-body" id="kanban-body-planned"></div>
            </div>
            <div class="kanban-column" id="kanban-shooting">
                <div class="kanban-column-header" style="background: var(--bg); padding: 12px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #f59e0b;">
                    <span class="fs-11">ðŸŽ¬ En tournage</span>
                    <span class="kanban-count" id="kanban-count-shooting" style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
                </div>
                <div class="kanban-column-body kanban-body" id="kanban-body-shooting"></div>
            </div>
            <div class="kanban-column" id="kanban-done">
                <div class="kanban-column-header" style="background: var(--bg); padding: 12px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #10b981;">
                    <span class="fs-11">âœ… TerminÃ©</span>
                    <span class="kanban-count" id="kanban-count-done" style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
                </div>
                <div class="kanban-column-body kanban-body" id="kanban-body-done"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal DisponibilitÃ©s croisÃ©es -->
    <div id="availability-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
        <div style="background:var(--panel-bg); border-radius:12px; width:95%; max-width:1200px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
            <div class="n8-flex-6">
                <h2 class="m-0">ðŸ‘¥ DisponibilitÃ©s de l'Ã©quipe</h2>
                <button onclick="document.getElementById('availability-modal').style.display='none'" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âœ•</button>
            </div>
            <div style="padding:20px; overflow-y:auto; flex:1;">
                <div class="calendar-nav mb-20">
                    <button class="calendar-nav-btn" onclick="app.Planning.prevAvailMonth()">â—€</button>
                    <span class="calendar-month-year" id="avail-month-year">DÃ©cembre 2024</span>
                    <button class="calendar-nav-btn" onclick="app.Planning.nextAvailMonth()">â–¶</button>
                </div>
                <div id="availability-calendar-container"></div>
                <div class="calendar-legend mt-20">
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background:#4CAF50;"></div>
                        <span>Jour de tournage prÃ©vu</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background:#2196F3;"></div>
                        <span>Disponible</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background:#f44336;"></div>
                        <span>Indisponible</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Feuilles de Service -->
<div id="callsheets-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
    <div style="background:var(--panel-bg); border-radius:12px; width:90%; max-width:900px; max-height:90vh; overflow-y:auto;">
        <div class="n8-flex-6">
            <h2 class="m-0">ðŸ“„ Feuilles de Service</h2>
            <button onclick="app.Planning.closeCallSheets()" class="icon-btn">âœ–</button>
        </div>
        <div id="callsheets-list" class="p-20"></div>
    </div>
</div>

<!-- ONGLET RAPPORT DE SCRIPT / CONTINUITÃ‰ -->
<div id="tab-scriptreport" class="tab-content">
    <h1 class="print-only-title">RAPPORT DE SCRIPT</h1>
    
    <style>
        .sr-container { display: flex; gap: 20px; height: calc(100vh - 180px); }
        .sr-sidebar { width: 280px; min-width: 280px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow-y: auto; }
        .sr-main { flex: 1; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow-y: auto; padding: 20px; }
        .sr-scene-item { padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .sr-scene-item:hover { background: var(--bg); }
        .sr-scene-item.active { background: var(--primary); color: white; }
        .sr-scene-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; }
        .sr-shot-list { padding-left: 15px; }
        .sr-shot-item { padding: 6px 10px; margin: 3px 0; border-radius: 4px; font-size: 0.85rem; cursor: pointer; background: var(--bg); border: 1px solid transparent; }
        .sr-shot-item:hover { border-color: var(--primary); }
        .sr-shot-item.active { background: var(--primary); color: white; }
        .sr-shot-item.has-report { border-left: 3px solid var(--success); }
        .sr-sheet { border: 2px solid #333; background: white; color: #333; font-family: 'Courier Prime', monospace; }
        .sr-sheet-header { display: grid; grid-template-columns: 1fr auto; border-bottom: 2px solid #333; }
        .sr-sheet-row { display: grid; border-bottom: 1px solid #333; }
        .sr-sheet-cell { padding: 8px 10px; border-right: 1px solid #333; }
        .sr-sheet-cell:last-child { border-right: none; }
        .sr-sheet-cell input, .sr-sheet-cell select, .sr-sheet-cell textarea { 
            width: 100%; border: none; background: transparent; font-family: inherit; font-size: inherit; padding: 0; color: inherit;
        }
        .sr-sheet-cell input:focus, .sr-sheet-cell select:focus, .sr-sheet-cell textarea:focus { outline: 2px solid var(--primary); }
        .sr-takes-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .sr-takes-table th, .sr-takes-table td { border: 1px solid #333; padding: 6px 8px; text-align: left; font-size: 0.85rem; }
        .sr-takes-table th { background: #f0f0f0; font-weight: 600; }
        .sr-nav-reports { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .sr-nav-btn { padding: 6px 12px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); cursor: pointer; font-size: 0.8rem; }
        .sr-nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .sr-quality-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .sr-quality-label { width: 60px; font-weight: 600; font-size: 0.8rem; }
        .sr-quality-select { flex: 0 0 120px; padding: 4px; border: 1px solid #333; font-size: 0.8rem; }
        .sr-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-sec); text-align: center; padding: 40px; }
        .sr-empty-icon { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }
        @media (max-width: 900px) { .sr-container { flex-direction: column; height: auto; } .sr-sidebar { width: 100%; max-height: 300px; } }
    </style>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <h2 class="m-0">ðŸ“‹ Rapport de Script</h2>
        <div class="flex-gap10">
            <button onclick="app.ScriptReport.exportCurrentPDF()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">ðŸ“„ Export PDF</button>
            <button onclick="app.ScriptReport.exportAllPDF()" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">ðŸ“¦ Export Tous</button>
        </div>
    </div>
    
    <div class="sr-container">
        <!-- Sidebar : Liste des scÃ¨nes et plans -->
        <div class="sr-sidebar">
            <div style="padding: 15px; border-bottom: 1px solid var(--border); background: var(--bg);">
                <strong>ðŸŽ¬ ScÃ¨nes & Plans</strong>
            </div>
            <div id="sr-scenes-list"></div>
        </div>
        
        <!-- Zone principale : Fiche de script -->
        <div class="sr-main">
            <div id="sr-sheet-container">
                <div class="sr-empty">
                    <div class="sr-empty-icon">ðŸ“‹</div>
                    <h3>Fiche de Script</h3>
                    <p>SÃ©lectionnez un plan dans la liste de gauche pour remplir sa fiche de script.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tab-expenses" class="tab-content">
    <h1 class="print-only-title">BUDGET & DÃ‰PENSES</h1>
    
    <!-- Toggle Mode Simple / AvancÃ© -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; gap: 5px;">
        <button id="expenses-mode-simple" onclick="app.Expenses.setMode('simple')" style="padding: 8px 16px; border: 1px solid var(--primary); border-radius: 6px 0 0 6px; cursor: pointer; font-weight: 500; background: var(--primary); color: white;">ðŸ“‹ Simple</button>
        <button id="expenses-mode-advanced" onclick="app.Expenses.setMode('advanced')" style="padding: 8px 16px; border: 1px solid var(--border); border-radius: 0 6px 6px 0; cursor: pointer; font-weight: 500; background: var(--bg); color: var(--text-main);">âš™ï¸ AvancÃ©</button>
    </div>
    
    <div class="expenses-container">
        <!-- Sidebar gauche (Mode AvancÃ© uniquement) -->
        <div class="expenses-sidebar" id="expenses-sidebar-advanced">
            <h3 style="margin-top: 0; margin-bottom: 15px;">ðŸ’° Budget PrÃ©visionnel</h3>
            
            <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div class="section-header-10">
                    <label class="text-sec-sm2">Budget Total</label>
                    <div class="flex-gap5">
                        <button id="vat-mode-ht" onclick="app.Expenses.setVatMode('HT')" style="padding: 4px 10px; border: 1px solid var(--primary); border-radius: 4px 0 0 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; background: var(--primary); color: white;">HT</button>
                        <button id="vat-mode-ttc" onclick="app.Expenses.setVatMode('TTC')" style="padding: 4px 10px; border: 1px solid var(--border); border-radius: 0 4px 4px 0; cursor: pointer; font-size: 0.75rem; font-weight: 600; background: var(--bg); color: var(--text-main);">TTC</button>
                    </div>
                </div>
                <input type="number" id="expenses-budget-total" class="profile-input" placeholder="0" style="font-size: 1.2rem; font-weight: bold;" onchange="app.Expenses.saveBudget()" readonly title="CalculÃ© automatiquement depuis les catÃ©gories">
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <select id="expenses-currency" class="flex-input" onchange="app.Expenses.saveBudget()">
                        <option value="â‚¬">â‚¬ Euro</option>
                        <option value="$">$ Dollar</option>
                        <option value="Â£">Â£ Livre</option>
                        <option value="CHF">CHF Franc Suisse</option>
                    </select>
                    <select id="expenses-default-vat" class="flex-input" onchange="app.Expenses.saveDefaultVat()" title="TVA par dÃ©faut">
                        <option value="0">TVA 0%</option>
                        <option value="5.5">TVA 5.5%</option>
                        <option value="10">TVA 10%</option>
                        <option value="20" selected>TVA 20%</option>
                    </select>
                </div>
            </div>
            
            <!-- Alertes budget -->
            <div style="background: var(--bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-sec);">
                    <span>âš ï¸ Alertes Ã </span>
                    <input type="number" id="alert-threshold-warning" value="80" class="n8-input-3" onchange="app.Expenses.saveAlertThresholds()">
                    <span>% et</span>
                    <input type="number" id="alert-threshold-danger" value="100" class="n8-input-3" onchange="app.Expenses.saveAlertThresholds()">
                    <span>%</span>
                </div>
            </div>
            
            <div class="expense-section-title">ðŸ‘¤ Responsable Budget Global</div>
            <select id="expenses-manager" class="profile-input w-full" onchange="app.Expenses.saveManager()">
                <option value="">-- Choisir --</option>
            </select>
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; margin-bottom: 15px; font-size: 0.85rem; color: var(--text-sec); cursor: pointer;">
                <input type="checkbox" id="manager-email-notif" onchange="app.Expenses.saveManagerEmailPref()" checked>
                ðŸ“§ Recevoir les emails
            </label>
            
            <div class="expense-section-title">ðŸ“Š CatÃ©gories CNC</div>
            <div style="font-size: 0.75rem; color: var(--text-sec); margin-bottom: 10px;">Cliquez sur âš™ï¸ pour dÃ©finir le budget prÃ©visionnel</div>
            <div id="expenses-dept-list" style="max-height: 300px; overflow-y: auto;"></div>
            
            <div class="expense-section-title mt-20">âš™ï¸ ParamÃ¨tres financiers</div>
            <div class="finance-params">
                <div class="finance-param-row">
                    <label>ðŸš— IndemnitÃ© km</label>
                    <div class="finance-param-input">
                        <input type="number" id="param-km-rate" step="0.01" placeholder="0.55" onchange="app.Expenses.saveFinanceParams()">
                        <span class="param-unit">â‚¬/km</span>
                    </div>
                </div>
                <div class="finance-param-row">
                    <label>ðŸ½ï¸ Per diem repas</label>
                    <div class="finance-param-input">
                        <input type="number" id="param-perdiem-meal" placeholder="19" onchange="app.Expenses.saveFinanceParams()">
                        <span class="param-unit">â‚¬/jour</span>
                    </div>
                </div>
                <div class="finance-param-row">
                    <label>ðŸ¨ Per diem hÃ©berg.</label>
                    <div class="finance-param-input">
                        <input type="number" id="param-perdiem-hotel" placeholder="80" onchange="app.Expenses.saveFinanceParams()">
                        <span class="param-unit">â‚¬/nuit</span>
                    </div>
                </div>
                <div class="finance-param-row">
                    <label>â° Seuil heures sup</label>
                    <div class="finance-param-input">
                        <input type="number" id="param-overtime-threshold" placeholder="8" onchange="app.Expenses.saveFinanceParams()">
                        <span class="param-unit">heures</span>
                    </div>
                </div>
                <div class="finance-param-row">
                    <label>ðŸ“ˆ Majorations HS</label>
                    <div class="finance-param-rates">
                        <input type="number" id="param-overtime-1" placeholder="25" title="PremiÃ¨re tranche" onchange="app.Expenses.saveFinanceParams()"><span>%</span>
                        <input type="number" id="param-overtime-2" placeholder="50" title="DeuxiÃ¨me tranche" onchange="app.Expenses.saveFinanceParams()"><span>%</span>
                        <input type="number" id="param-overtime-3" placeholder="100" title="TroisiÃ¨me tranche" onchange="app.Expenses.saveFinanceParams()"><span>%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Zone principale -->
        <div class="expenses-main">
            <!-- RÃ©sumÃ© simplifiÃ© (Mode Simple) -->
            <div id="expenses-simple-header" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-size: 0.85rem; color: var(--text-sec); display: block; margin-bottom: 5px;">ðŸ’° Budget Total</label>
                        <input type="number" id="expenses-budget-simple" class="profile-input" placeholder="0" style="font-size: 1.1rem; font-weight: bold;" onchange="app.Expenses.saveBudgetSimple()">
                    </div>
                    <div style="text-align: center; padding: 15px 25px; background: var(--bg); border-radius: 8px;">
                        <div style="font-size: 1.3rem; font-weight: bold;" id="expenses-spent-simple">0 â‚¬</div>
                        <div class="text-sec-sm">DÃ©pensÃ©</div>
                    </div>
                    <div style="text-align: center; padding: 15px 25px; background: var(--success); color: white; border-radius: 8px;" id="expenses-remaining-simple-card">
                        <div style="font-size: 1.3rem; font-weight: bold;" id="expenses-remaining-simple">0 â‚¬</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Restant</div>
                    </div>
                </div>
            </div>
            
            <!-- RÃ©sumÃ© complet (Mode AvancÃ©) -->
            <div class="expenses-summary" id="expenses-summary-advanced">
                <div class="expenses-summary-card">
                    <div class="amount" id="expenses-total-budget">0 â‚¬</div>
                    <div class="label">Budget Total</div>
                </div>
                <div class="expenses-summary-card">
                    <div class="amount" id="expenses-total-spent">0 â‚¬</div>
                    <div class="label">DÃ©pensÃ© / EngagÃ©</div>
                </div>
                <div class="expenses-summary-card success">
                    <div class="amount" id="expenses-total-remaining">0 â‚¬</div>
                    <div class="label">Restant</div>
                </div>
            </div>
            
            <!-- Filtres (Mode AvancÃ©) -->
            <div class="expenses-filters" id="expenses-filters-advanced">
                <select id="expenses-filter-dept" onchange="app.Expenses.applyFilters()">
                    <option value="">Toutes les catÃ©gories</option>
                </select>
                <select id="expenses-filter-status" onchange="app.Expenses.applyFilters()">
                    <option value="">Tous les statuts</option>
                    <option value="pending">â³ En attente</option>
                    <option value="approved">âœ… ValidÃ©</option>
                    <option value="rejected">âŒ RefusÃ©</option>
                    <option value="done">ðŸ’° PayÃ©</option>
                </select>
                <input type="text" id="expenses-filter-search" placeholder="Rechercher..." onkeyup="app.Expenses.applyFilters()">
                <button onclick="app.Expenses.openAddModal()" class="n8-badge-10">âž• Ajouter</button>
            </div>
            
            <!-- Filtres simplifiÃ©s (Mode Simple) -->
            <div id="expenses-filters-simple" class="d-none-mb15">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <select id="expenses-filter-status-simple" onchange="app.Expenses.applyFilters()" style="padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                        <option value="">Tous</option>
                        <option value="unpaid">â³ Ã€ payer</option>
                        <option value="paid">âœ… PayÃ©</option>
                    </select>
                    <input type="text" id="expenses-filter-search-simple" placeholder="ðŸ” Rechercher..." onkeyup="app.Expenses.applyFilters()" style="flex: 1; min-width: 150px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <button onclick="app.Expenses.openAddModal()" class="btn-success">âž• Nouvelle dÃ©pense</button>
                </div>
            </div>
            
<!-- Section salaires auto (Mode AvancÃ© uniquement) -->
            <div class="expense-auto-section" id="expenses-salaries-section">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div>
                        <h4 class="m-0">ðŸ’¼ Salaires (calculÃ©s automatiquement)</h4>
                        <p style="font-size: 0.85rem; color: var(--text-sec); margin: 5px 0 0 0;">BasÃ© sur le planning et les tarifs journaliers/horaires</p>
                    </div>
                    <div class="flex-gap8">
                        <button onclick="app.Expenses.checkMissingInfo()" style="padding: 8px 15px; background: var(--warning, #FF9800); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">ðŸ” VÃ©rifier infos</button>
                        <button onclick="app.Expenses.deleteSalaryExpenses()" style="padding: 8px 15px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">ðŸ—‘ï¸ Supprimer</button>
                        <button onclick="app.Expenses.generateSalaryExpenses()" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">ðŸ“ GÃ©nÃ©rer</button>
                    </div>
                </div>
                <div id="expenses-salaries-list"></div>
                <div style="text-align: right; margin-top: 10px; font-weight: bold;">
                    Total Salaires : <span id="expenses-salaries-total">0 â‚¬</span>
                </div>
            </div>
            
            <!-- Liste des dÃ©penses -->
            <div class="expense-section-title">ðŸ“ DÃ©penses</div>
            <div id="expenses-list"></div>
        </div>
    </div>
</div>

    </main>
  </div> 
  
  <div id="script-ac-list"></div>
  
  <!-- Modal Rechercher/Remplacer -->
  <div id="search-replace-modal" style="display: none; position: fixed; top: 20px; right: 20px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0; width: 350px; z-index: 10001; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
      <div id="search-replace-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg); border-radius: 12px 12px 0 0; cursor: move; user-select: none; border-bottom: 1px solid var(--border);">
          <h3 class="heading-primary">ðŸ” Rechercher / Remplacer</h3>
          <button onclick="app.ScriptEditor.closeSearchReplace()" style="background: none; border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-sec);">âœ•</button>
      </div>
      <div class="p-20">
      <div style="margin-bottom: 12px;">
          <label class="form-label">Rechercher :</label>
          <input type="text" id="search-input" placeholder="Texte Ã  rechercher..." class="form-input" oninput="app.ScriptEditor.searchInScript()">
      </div>
      <div style="margin-bottom: 12px;">
          <label class="form-label">Remplacer par :</label>
          <input type="text" id="replace-input" placeholder="Nouveau texte..." class="form-input">
      </div>
      <div class="mb-15">
          <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-main); cursor: pointer;">
              <input type="checkbox" id="search-case-sensitive"> Respecter la casse
          </label>
          <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-main); cursor: pointer; margin-top: 5px;">
              <input type="checkbox" id="search-whole-word"> Mot entier uniquement
          </label>
      </div>
      <div id="search-results-info" style="margin-bottom: 12px; padding: 8px; background: var(--bg); border-radius: 6px; font-size: 0.85rem; color: var(--text-sec); text-align: center;">
          Tapez pour rechercher...
      </div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="app.ScriptEditor.searchPrev()" class="n8-badge-6">â—€ PrÃ©c.</button>
          <button onclick="app.ScriptEditor.searchNext()" class="n8-badge-6">Suiv. â–¶</button>
          <button onclick="app.ScriptEditor.replaceOne()" style="flex: 1; padding: 8px; background: var(--primary); border: none; border-radius: 6px; cursor: pointer; color: white;">Remplacer</button>
      </div>
      <button onclick="app.ScriptEditor.replaceAll()" style="width: 100%; margin-top: 8px; padding: 10px; background: var(--success); border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600;">ðŸ”„ Tout remplacer</button>
      <button id="undo-replace-btn" onclick="app.ScriptEditor.undoReplace()" style="width: 100%; margin-top: 8px; padding: 10px; background: var(--danger); border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; display: none;">â†©ï¸ Annuler le remplacement</button>
      </div>
  </div>
  <div id="breakdown-ctx-menu"></div>
  <div id="tag-ctx-menu"></div>

  <div id="tag-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>CrÃ©er un Tag</h3>
        <input type="text" id="tag-new-name" placeholder="Nom du tag (ex: Ennemis)" class="mb-10">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
            <label>Couleur :</label>
            <input type="color" id="tag-new-color" value="#ff0000" style="width:50px; height:40px; padding:0; border:none; cursor:pointer;">
        </div>
        <div class="modal-btns">
            <button onclick="document.getElementById('tag-modal').style.display='none'" class="select-outline">Annuler</button>
            <button onclick="app.Actions.saveNewTag()" class="btn-primary-r4">CrÃ©er</button>
        </div>
    </div>
  </div>

<div id="drawing-modal" class="drawing-modal">
    <div class="drawing-container">
        <div class="drawing-header">
            <h3 class="m-0">Ã‰diteur de Dessin</h3>
            <div class="flex-gap10">
                <button onclick="app.DrawingEditor.saveVersion()" style="padding: 8px 15px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">ðŸ’¾ Sauvegarder Version</button>
                <button onclick="app.DrawingEditor.close()" style="padding: 8px 15px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">âœ– Fermer</button>
            </div>
        </div>
        <div class="drawing-toolbar">
            <button onclick="app.DrawingEditor.undo()" class="n8-badge-14">â†¶ Annuler</button>
            <button onclick="app.DrawingEditor.redo()" class="n8-badge-14">â†· Refaire</button>
            <button onclick="app.DrawingEditor.clear()" style="padding: 8px 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">ðŸ—‘ï¸ Effacer Tout</button>
            <label style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                <input type="checkbox" id="drawTransparentBg" onchange="app.DrawingEditor.toggleTransparent(this.checked)">
                ðŸ”² Fond transparent
            </label>
            <select id="drawBrushSize" onchange="app.DrawingEditor.setBrushSize(this.value)" style="padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
                <option value="2">TrÃ¨s fin</option>
                <option value="5">Fin</option>
                <option value="10" selected>Moyen</option>
                <option value="20">Ã‰pais</option>
                <option value="40">TrÃ¨s Ã©pais</option>
            </select>
        </div>
        <div class="drawing-workspace">
            <div class="drawing-sidebar">
                <div class="tool-group">
                    <div class="tool-label">Couleurs</div>
                    <div class="color-palette" id="colorPalette"></div>
                </div>
                <div class="tool-group">
                    <div class="tool-label">Outils</div>
                    <div class="brush-btn active" onclick="app.DrawingEditor.setTool('pencil')">âœï¸ Crayon</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('pen')">ðŸ–Šï¸ Stylo</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('marker')">ðŸ–Œï¸ Feutre</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('highlighter')">ðŸŸ¨ Stabilo</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('brush')">ðŸŽ¨ Pinceau</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('airbrush')">ðŸ’¨ AÃ©rographe</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('eraser')">ðŸ§¹ Gomme</div>
                </div>
                <div class="tool-group">
                    <div class="tool-label">OpacitÃ©</div>
                    <input type="range" min="0" max="100" value="100" class="opacity-slider" id="opacitySlider" oninput="app.DrawingEditor.setOpacity(this.value)">
                    <div style="text-align: center; font-size: 0.9rem; color: var(--text-sec);" id="opacityValue">100%</div>
                </div>
                <div class="tool-group">
                    <div class="tool-label">Calques</div>
                    <button onclick="app.DrawingEditor.addLayer()" style="width: 100%; padding: 6px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; font-size: 0.85rem;">+ Nouveau</button>
                    <div id="layersList"></div>
                </div>
            </div>
            <div class="drawing-canvas-area">
                <canvas id="drawingCanvas" class="drawing-canvas" width="800" height="600"></canvas>
            </div>
        </div>
    </div>
</div>




<div id="planning-modal" class="planning-modal">
    <div class="planning-modal-content">
        <div class="planning-modal-header">
            <h2 class="m-0" id="planningModalTitle">Jour de Tournage</h2>
            <button onclick="app.Planning.closeModal()" class="icon-btn">âœ–</button>
        </div>
        <div class="planning-modal-body" id="planningModalBody"></div>
        <div class="planning-modal-footer">
            <button onclick="app.Planning.closeModal()" class="btn-border">Annuler</button>
            <button onclick="app.Planning.saveShootDay()" class="btn-success">ðŸ’¾ Sauvegarder</button>
            <button onclick="app.Planning.generateFDS()" class="btn-primary">ðŸ“„ Feuille de Service</button>
        </div>
    </div>
</div>

<div id="fds-modal" class="planning-modal">
    <div class="planning-modal-content" style="max-width: 800px;">
        <div class="planning-modal-header">
            <h2 class="m-0">Feuille de Service</h2>
            <button onclick="document.getElementById('fds-modal').classList.remove('active')" class="icon-btn">âœ–</button>
        </div>
        <div class="planning-modal-body" id="fdsContent"></div>
        <div class="planning-modal-footer">
            <button onclick="document.getElementById('fds-modal').classList.remove('active')" class="btn-border">Fermer</button>
            <button onclick="app.Planning.sendFDS()" class="btn-success">ðŸ“§ Envoyer</button>
            <button onclick="app.Planning.printFDS()" class="btn-primary">ðŸ–¨ï¸ Imprimer</button>
        </div>
    </div>
</div>

<!-- Modal Feuille de Service Publique -->
<div id="public-callsheet-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:99999; overflow-y:auto;">
    <div style="max-width:800px; margin:0 auto; padding:20px;">
        <div class="section-header-20">
            <h1 class="heading-primary">ðŸŽ¬ Feuille de Service</h1>
            <div class="flex-gap10">
                <button onclick="window.print()" class="btn-primary">ðŸ–¨ï¸ Imprimer / PDF</button>
                <button onclick="document.getElementById('public-callsheet-modal').style.display='none'; window.history.pushState({}, '', window.location.pathname);" class="n8-btn-3">âœ• Fermer</button>
            </div>
        </div>
        <div id="public-callsheet-content" style="background:white; color:#333; padding:30px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1);">
            <p>Chargement...</p>
        </div>
        <div style="text-align:center; margin-top:30px; padding:20px; color:var(--text-sec);">
            <p>PropulsÃ© par <strong>Moteur</strong> - Gestion de production audiovisuelle</p>
            <a href="https://moteur.studio" class="text-primary">moteur.studio</a>
        </div>
    </div>
</div>

<div id="shot-edit-modal" class="shot-edit-modal">
    <div class="shot-edit-container">
        <div class="shot-edit-header">
            <h2 class="m-0" id="shotEditTitle">Ã‰dition du Plan</h2>
            <div class="flex-gap10">
                <button class="shot-edit-save-btn" id="shotEditSaveBtn" onclick="app.Storyboard.saveCurrentShot()">ðŸ’¾ Sauvegarder</button>
                <button class="shot-edit-close-btn" onclick="app.Storyboard.closeEditModal()">âœ– Fermer</button>
            </div>
        </div>
        <div class="shot-edit-content" id="shotEditContent"></div>
    </div>
</div>

  <div id="export-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>Exporter / Imprimer</h3>
        <input type="text" id="exp-author" placeholder="Auteur (ex: Jean Dupont)" class="mb-10">
        <input type="text" id="exp-phone" placeholder="TÃ©lÃ©phone" class="mb-10">
        <input type="text" id="exp-web" placeholder="Site Internet" class="mb-10">
        <input type="text" id="exp-reg" placeholder="NumÃ©ro de DÃ©pÃ´t" style="margin-bottom:15px">
        
        <div class="checklist">
            <label><input type="checkbox" id="exp-synop" checked><span>Synopsis</span></label>
            <label><input type="checkbox" id="exp-board" checked><span>SÃ©quencier</span></label>
            <label><input type="checkbox" id="exp-script" checked><span>ScÃ©nario</span></label>
            <label><input type="checkbox" id="exp-chars" checked><span>Personnages</span></label>
            <label><input type="checkbox" id="exp-actors" checked><span>ComÃ©diens</span></label>
            <label><input type="checkbox" id="exp-locs" checked><span>Lieux</span></label>
            <label><input type="checkbox" id="exp-storyboard"><span>Storyboard</span></label>
            <label><input type="checkbox" id="exp-crew"><span>Ã‰quipes</span></label>
            <label><input type="checkbox" id="exp-breakdown"><span>DÃ©pouillement</span></label>
            <label><input type="checkbox" id="exp-stats"><span>Statistiques</span></label>
        </div>
        <div class="modal-btns">
            <button onclick="document.getElementById('export-modal').style.display='none'" class="select-outline">Annuler</button>
            <button onclick="app.Actions.confirmExport()" class="btn-primary-r4">Confirmer</button>
        </div>
    </div>
  </div>

  <div id="share-modal" class="modal-overlay">
    <div class="modal-box" style="max-width:450px">
        <h3>ðŸ“¤ Partager ce projet</h3>
        <input type="email" id="share-email" placeholder="Email (ex: ami@gmail.com)" class="mb-10" oninput="app.Invitations.checkEmail(this.value)">
        <div id="share-email-status" style="font-size:0.85rem; margin-bottom:10px; padding:8px; border-radius:4px; display:none;"></div>
        <select id="share-role" style="width:100%; padding:8px; margin-bottom:15px; border-radius:4px; border:1px solid var(--border); background:var(--input-bg); color:var(--text-main)">
            <option value="viewer">ðŸ‘ï¸ Lecture Seule</option>
            <option value="editor">âœï¸ Ã‰diteur (peut modifier)</option>
        </select>
        <div id="share-message-section" style="display:none; margin-bottom:15px;">
            <label class="form-label-alt">Message personnalisÃ© (optionnel) :</label>
            <textarea id="share-message" placeholder="Ex: Salut ! Je t'invite Ã  collaborer sur mon projet..." style="width:100%; height:60px; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); resize:none;"></textarea>
        </div>
        <div class="modal-btns">
            <button onclick="document.getElementById('share-modal').style.display='none'" class="select-outline">Annuler</button>
            <button id="share-confirm-btn" onclick="app.Invitations.sendInvitation()" class="btn-primary-r4">ðŸ“§ Inviter</button>
        </div>
    </div>
  </div>

  <div id="visual-wizard" class="wizard-overlay">
    <div class="wizard-header">
        <div id="wiz-step-title" class="wizard-instruction">Assistant d'Importation</div>
        <div id="wiz-step-desc" class="wizard-sub-text">Suivez les instructions pour calibrer l'import.</div>
        
        <div id="wiz-scene-breakdown" class="wiz-detail-box">
             <p style="margin:0 0 10px 0; font-size:0.85rem;">Surlignez les Ã©lÃ©ments demandÃ©s dans le texte ci-dessous :</p>
             <div id="wiz-bd-sample" style="font-size:1.1rem; padding:10px; background:white; border:1px solid #ccc; margin-bottom:10px; cursor:text;"></div>
             <div class="wiz-detail-row"><span>PrÃ©fixe (INT/EXT) :</span> <span id="wiz-val-pre" class="wiz-detail-val">-</span></div>
             <div class="wiz-detail-row"><span>DÃ©cor :</span> <span id="wiz-val-loc" class="wiz-detail-val">-</span></div>
             <div class="wiz-detail-row"><span>Suffixe (JOUR/NUIT) :</span> <span id="wiz-val-suff" class="wiz-detail-val">-</span></div>
             <button id="btn-valid-breakdown" style="width:100%; margin-top:5px; padding:5px; background:var(--success); color:white; border:none; cursor:pointer; display:none;">Valider ce dÃ©coupage</button>
        </div>
    </div>

    <div id="wizard-page-view" class="wizard-page-container">
        </div>
    
    <div id="cleanup-toast">ðŸ—‘ï¸ Supprimer les occurrences sÃ©lectionnÃ©es ?</div>

    <div class="wizard-footer">
        <button onclick="app.Importer.cancel()" style="background:transparent; border:none; color:var(--danger); cursor:pointer">Annuler</button>
        <button id="wiz-skip-btn" onclick="app.Importer.nextStep(true)" style="background:var(--border); border:none; padding:8px 15px; border-radius:4px; cursor:pointer">Sauter cette Ã©tape</button>
    </div>
  </div>

  <div id="version-modal" class="modal-overlay">
    <div class="modal-box" style="width:500px">
        <h3>ðŸ“œ Historique des sauvegardes</h3>
        <p style="color:var(--text-sec); font-size:0.85rem; margin-bottom:15px;">Les sauvegardes sont crÃ©Ã©es automatiquement. Vous pouvez restaurer une version prÃ©cÃ©dente si nÃ©cessaire.</p>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <label style="font-size:0.8rem; font-weight:bold; color:var(--text-sec)">SAUVEGARDES RÃ‰CENTES</label>
            <button onclick="app.Actions.createManualSnapshot()" style="background:var(--primary); color:#fff; border:none; padding:6px 12px; border-radius:4px; font-size:0.8rem; cursor:pointer;">ðŸ’¾ Sauvegarder maintenant</button>
        </div>
        <div id="version-list" class="ver-list" style="max-height:400px; overflow-y:auto;">
            <div style="padding:20px; text-align:center; color:var(--text-sec)">Aucune sauvegarde.</div>
        </div>

        <div class="modal-btns">
            <button onclick="document.getElementById('version-modal').style.display='none'" class="select-outline">Fermer</button>
        </div>
    </div>
  </div>
  
  <script>
const app = (function(){

  // --- CONFIGURATION SUPABASE ---
  const SUPABASE_URL = 'https://txjuniuzqxpxghubluxm.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_Y4nYJdwgru-KimLbMpwQPQ_onREt1lD';
  
  var supabase;
  function initSupabase() {
      return new Promise((resolve) => {
          function tryInit() {
              if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
                  const isFileProtocol = window.location.protocol === 'file:';
                  const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                      auth: {
                          storageKey: 'moteur-auth-token',
                          flowType: 'pkce',
                          detectSessionInUrl: true,
                          persistSession: true,
                          autoRefreshToken: !isFileProtocol
                      },
                      global: {
                          headers: { 'x-application-name': 'moteur' }
                      }
                  });
                  supabase = client;
                  window.supabase = client;
                  if(isFileProtocol) {
                      console.log('ðŸ“ Mode fichier local dÃ©tectÃ©');
                      supabase.realtime.disconnect();
                      supabase.removeAllChannels();
                      // EmpÃªcher toute reconnexion websocket
                      supabase.realtime.connect = () => {};
                      supabase.realtime.reconnect = () => {};
                      supabase.channel = () => ({ on: function(){return this;}, subscribe: function(){return this;}, track: function(){return this;}, send: function(){return this;} });
                  }
                  console.log("Supabase initialisÃ© avec succÃ¨s", typeof supabase.auth);
                  resolve(true);
              } else {
                  console.log("Attente de Supabase...");
                  setTimeout(tryInit, 100);
              }
          }
          tryInit();
      });
  }
  initSupabase();
  
const CONFIG = { 
    themeKey: 'fmp_theme_pref',
    // ========== ADMIN ==========
    adminEmails: ['ga.dmy@ikmail.com'],  // Emails ayant accÃ¨s au tableau de bord admin
    
    // ========== PRÃ‰-ALPHA OUVERTE ==========
    // Inscriptions ouvertes Ã  tous (avec limite)
    preAlpha: {
        enabled: false,  // false = inscriptions ouvertes Ã  tous
        maxUsers: 150,   // Limite maximum d'utilisateurs pour la prÃ©-alpha
        whitelist: [
            // Ajouter ici les emails des testeurs autorisÃ©s (en minuscules)
            // 'exemple@gmail.com',
            'ga.dmy@ikmail.com',
            'contact@quentin-etienne.com',
			'ga.demauroy@gmail.com',
			'martinez.jeanremy@gmail.com',
        ]
    },
    // EmailJS Configuration - Ã€ CONFIGURER avec ton compte emailjs.com
    emailJS: {
        publicKey: 'EyiCAN9DrTUYEiEfu',      // Remplacer aprÃ¨s crÃ©ation compte
        serviceId: 'service_4cnbskn',       // Remplacer aprÃ¨s crÃ©ation compte  
        templateId: 'template_jmkggb7'      // Remplacer aprÃ¨s crÃ©ation compte
    },
    // Types de journÃ©es de travail
    dayTypes: {
        'tournage': { label: 'ðŸŽ¬ Tournage', color: '#4CAF50', bgColor: '#E8F5E9' },
        'repetition': { label: 'ðŸŽ­ RÃ©pÃ©tition', color: '#2196F3', bgColor: '#E3F2FD' },
        'reperage': { label: 'ðŸ“ RepÃ©rage', color: '#FF9800', bgColor: '#FFF3E0' },
        'essai_costume': { label: 'ðŸ‘— Essai costume', color: '#9C27B0', bgColor: '#F3E5F5' },
        'formation': { label: 'ðŸ“š Formation', color: '#607D8B', bgColor: '#ECEFF1' },
        'reunion': { label: 'ðŸ’¼ RÃ©union', color: '#795548', bgColor: '#EFEBE9' }
    },
    	 bdCategories: ["TECHNICIENS", "COMEDIENS", "PERSONNAGES", "DECORS-LIEUX", "FIGURATION", "ACCESSOIRES", "COSTUMES", "MAQUILLAGE-COIFFURE", "VEHICULES", "ANIMAUX", "SON-MUSIQUE", "EFFETS SPECIAUX (SFX)", "EFFETS VISUELS (VFX)", "LUMIERE", "MACHINERIE", "LOGISTIQUE"],
     shotTypes: ["Gros plan (GP)", "Plan moyen (PM)", "Plan amÃ©ricain (PA)", "Plan large (PL)", "Plan d'ensemble (PE)", "TrÃ¨s gros plan (TGP)", "Plan rapprochÃ© (PR)", "Plan italien (PI)"],
    cameraMoves: ["Fixe (FX)", "Travelling avant (TAV)", "Travelling arriÃ¨re (TAR)", "Travelling latÃ©ral (TL)", "Panoramique horizontal (PH)", "Panoramique vertical (PV)", "Zoom avant (ZA)", "Zoom arriÃ¨re (ZR)", "Plan-sÃ©quence (PS)"],
    cameraModes: ["Pied (PD)", "Ã‰paule (EP)", "Steadicam (STD)", "Drone (DR)", "Dolly (DY)", "Grue (GR)", "Gimbal (GM)", "CamÃ©ra portÃ©e (CP)", "Voiture (VT)", "Rail (RL)"],
    // Mapping groupe technicien â†’ catÃ©gories dÃ©pouillement
    crewToBreakdownMap: {
    'gc5': ['ACCESSOIRES', 'DECORS-LIEUX'],      // DÃ©coration
    'gc6': ['COSTUMES'],                          // Costumes
    'gc7': ['MAQUILLAGE-COIFFURE'],              // Maquillage/Coiffure
    'gc12': ['VEHICULES', 'LOGISTIQUE'],         // Transport/Logistique
    'gc4': ['SON-MUSIQUE'],                       // Son
    'gc2': ['LUMIERE'],                           // LumiÃ¨re
    'gc9': ['FIGURATION', 'ANIMAUX'],            // RÃ©gie
    'gc16': ['EFFETS SPECIAUX (SFX)'],           // Cascades/Stunts
    'gc13': ['EFFETS VISUELS (VFX)'],            // Post-production (VFX)
},
crewGroups: [
    {id: 'gc1', name: 'ðŸ“¹ Image', type: 'crew'},
    {id: 'gc2', name: 'ðŸ’¡ LumiÃ¨re', type: 'crew'},
    {id: 'gc3', name: 'ðŸŽ¬ RÃ©alisation', type: 'crew'},
    {id: 'gc4', name: 'ðŸŽ¤ Son', type: 'crew'},
    {id: 'gc5', name: 'ðŸŽ¨ DÃ©coration', type: 'crew'},
    {id: 'gc6', name: 'ðŸ‘— Costumes', type: 'crew'},
    {id: 'gc7', name: 'ðŸ’„ Maquillage/Coiffure', type: 'crew'},
    {id: 'gc8', name: 'ðŸ“ Script/ContinuitÃ©', type: 'crew'},
    {id: 'gc9', name: 'ðŸŽ­ RÃ©gie', type: 'crew'},
    {id: 'gc10', name: 'ðŸ’¼ Production', type: 'crew'},
    {id: 'gc11', name: 'ðŸ´ Catering', type: 'crew'},
    {id: 'gc12', name: 'ðŸš— Transport/Logistique', type: 'crew'},
    {id: 'gc13', name: 'ðŸŽžï¸ Post-production', type: 'crew'},
    {id: 'gc14', name: 'âœï¸ ScÃ©nario/Ã‰criture', type: 'crew'},
    {id: 'gc15', name: 'ðŸŽµ Musique', type: 'crew'},
    {id: 'gc16', name: 'ðŸ¦º Cascades/Stunts', type: 'crew'},
    {id: 'gc17', name: 'âž• Autre', type: 'crew'}
],
// Types d'associations
associationTypes: [
    {id: 'asso_video', name: 'ðŸŽ¬ VidÃ©o / CinÃ©ma'},
    {id: 'asso_comediens', name: 'ðŸŽ­ ComÃ©diens / Acteurs'},
    {id: 'asso_realisateurs', name: 'ðŸŽ¥ RÃ©alisateurs'},
    {id: 'asso_techniciens', name: 'ðŸ”§ Techniciens'},
    {id: 'asso_scenaristes', name: 'âœï¸ ScÃ©naristes / Auteurs'},
    {id: 'asso_producteurs', name: 'ðŸ’¼ Producteurs'},
    {id: 'asso_figurants', name: 'ðŸ‘¥ Figurants'},
    {id: 'asso_court_metrage', name: 'ðŸŽžï¸ Court-mÃ©trage'},
    {id: 'asso_documentaire', name: 'ðŸ“¹ Documentaire'},
    {id: 'asso_animation', name: 'ðŸŽ¨ Animation'},
    {id: 'asso_musique', name: 'ðŸŽµ Musique / Clip'},
    {id: 'asso_theatre', name: 'ðŸŽª ThÃ©Ã¢tre'},
    {id: 'asso_formation', name: 'ðŸ“š Formation'},
    {id: 'asso_autre', name: 'âž• Autre'}
],
// Types d'entreprises
enterpriseTypes: [
    {id: 'ent_production', name: 'ðŸŽ¬ Production'},
    {id: 'ent_postprod', name: 'ðŸŽžï¸ Post-production'},
    {id: 'ent_montage', name: 'âœ‚ï¸ Montage'},
    {id: 'ent_vfx', name: 'âœ¨ Effets spÃ©ciaux / VFX'},
    {id: 'ent_doublage', name: 'ðŸŽ™ï¸ Doublage / Voix-off'},
    {id: 'ent_son', name: 'ðŸ”Š Son / Mixage'},
    {id: 'ent_musique', name: 'ðŸŽµ Musique / Composition'},
    {id: 'ent_location', name: 'ðŸ“¦ Location de matÃ©riel'},
    {id: 'ent_vente', name: 'ðŸ›’ Vente de matÃ©riel'},
    {id: 'ent_studio', name: 'ðŸ¢ Studio / Plateau'},
    {id: 'ent_casting', name: 'ðŸŽ­ Casting'},
    {id: 'ent_distribution', name: 'ðŸ“½ï¸ Distribution'},
    {id: 'ent_technique', name: 'ðŸ”§ Services techniques'},
    {id: 'ent_formation', name: 'ðŸ“š Formation'},
    {id: 'ent_autre', name: 'âž• Autre'}
],
crewRoles: {
    'gc1': ['DirecteurÂ·rice de la photographie', 'CadreurÂ·euse', 'AssistantÂ·e camÃ©ra', '1erÂ·Ã¨re assistantÂ·e opÃ©rateurÂ·rice', '2Ã¨me assistantÂ·e opÃ©rateurÂ·rice', 'ChefÂ·fe Ã©lectro', 'Steadicamer', 'Pilote drone', 'DIT', 'Photographe plateau', 'Autre'],
    'gc2': ['ChefÂ·fe Ã©lectricienÂ·ne', 'Ã‰lectricienÂ·ne', 'Groupiste', 'Best Boy/Girl', 'PupitreurÂ·euse', 'Autre'],
    'gc3': ['RÃ©alisateurÂ·rice', 'RÃ©alisateurÂ·rice 2Ã¨me Ã©quipe', '1erÂ·Ã¨re assistantÂ·e rÃ©alisateurÂ·rice', '2Ã¨me assistantÂ·e rÃ©alisateurÂ·rice', '3Ã¨me assistantÂ·e rÃ©alisateurÂ·rice', 'DirecteurÂ·rice de casting', 'Coach acting', 'Autre'],
    'gc4': ['ChefÂ·fe opÃ©rateurÂ·rice son', 'Perchiste', 'AssistantÂ·e son', 'Sound designer', 'IngÃ©nieurÂ·e du son', 'Autre'],
    'gc5': ['ChefÂ·fe dÃ©corateurÂ·rice', 'EnsemblierÂ·Ã¨re', 'Accessoiriste', 'ConstructeurÂ·rice', 'Peintre', 'TapissierÂ·Ã¨re', 'StaffeurÂ·euse', 'RÃ©gisseurÂ·euse d\'extÃ©rieurs', 'Autre'],
    'gc6': ['ChefÂ·fe costumierÂ·Ã¨re', 'CostumierÂ·Ã¨re', 'HabilleurÂ·euse', 'CouturierÂ·Ã¨re', 'Autre'],
    'gc7': ['ChefÂ·fe maquilleurÂ·euse', 'MaquilleurÂ·euse', 'ChefÂ·fe coiffeurÂ·euse', 'CoiffeurÂ·euse', 'ProthÃ©siste', 'SFX Makeup', 'Autre'],
    'gc8': ['Scripte', 'AssistantÂ·e scripte', 'Autre'],
    'gc9': ['RÃ©gisseurÂ·euse gÃ©nÃ©ralÂ·e', 'RÃ©gisseurÂ·euse adjointÂ·e', 'AssistantÂ·e rÃ©gisseurÂ·euse', 'RÃ©gisseurÂ·euse d\'extÃ©rieurs', 'Runner', 'Stagiaire rÃ©gie', 'Autre'],
    'gc10': ['ProducteurÂ·rice', 'ProducteurÂ·rice exÃ©cutifÂ·ve', 'DirecteurÂ·rice de production', 'AdministrateurÂ·rice de production', 'Comptable', 'AssistantÂ·e de production', 'CoordinateurÂ·rice', 'ChargÃ©Â·e de figuration', 'Autre'],
    'gc11': ['ChefÂ·fe cuisinierÂ·Ã¨re', 'CuisinierÂ·Ã¨re', 'ServeurÂ·euse', 'Responsable craft', 'Autre'],
    'gc12': ['ChefÂ·fe transport', 'ChauffeurÂ·euse', 'ChauffeurÂ·euse camion', 'Responsable logistique', 'Autre'],
    'gc13': ['MonteurÂ·euse', 'AssistantÂ·e monteurÂ·euse', 'Ã‰talonneurÂ·euse', 'MixeurÂ·euse', 'Sound designer', 'CompositeurÂ·rice', 'SuperviseurÂ·euse VFX', 'Graphiste VFX', 'ConformateurÂ·rice', 'Infographiste', 'Autre'],
    'gc14': ['ScÃ©nariste', 'Co-scÃ©nariste', 'Dialoguiste', 'Script doctor', 'AdaptateurÂ·rice', 'ConsultantÂ·e scÃ©nario', 'Story-boarder', 'Autre'],
    'gc15': ['CompositeurÂ·rice', 'DirecteurÂ·rice musicalÂ·e', 'SuperviseurÂ·euse musicalÂ·e', 'ArrangeurÂ·euse', 'MusicienÂ·ne', 'Autre'],
    'gc16': ['CoordinateurÂ·rice cascades', 'CascadeurÂ·euse', 'Doublure cascade', 'MaÃ®treÂ·sse d\'armes', 'PyrotechnicienÂ·ne', 'Autre'],
    'gc17': ['Autre']
},
    
    // Permissions par dÃ©faut selon le rÃ´le
    // Niveaux: 'none' = pas d'accÃ¨s, 'read' = lecture seule, 'write' = modification
    defaultPermissions: {
        // PropriÃ©taire du projet - accÃ¨s total
        'owner': {
            synopsis: 'write', scenario: 'write', sequencier: 'write', storyboard: 'write',
            personnages: 'write', lieux: 'write', comediens: 'write', equipe: 'write',
            depouillement: 'write', planning: 'write', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'write'
        },
        // RÃ©alisateur
        'RÃ©alisateurÂ·rice': {
            synopsis: 'write', scenario: 'write', sequencier: 'write', storyboard: 'write',
            personnages: 'write', lieux: 'read', comediens: 'read', equipe: 'read',
            depouillement: 'write', planning: 'read', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'write'
        },
        // 1er Assistant RÃ©alisateur
        '1erÂ·Ã¨re assistantÂ·e rÃ©alisateurÂ·rice': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'read', lieux: 'read', comediens: 'read', equipe: 'read',
            depouillement: 'write', planning: 'write', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'write'
        },
        // 2Ã¨me Assistant RÃ©alisateur
        '2Ã¨me assistantÂ·e rÃ©alisateurÂ·rice': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'read', lieux: 'read', comediens: 'read', equipe: 'read',
            depouillement: 'read', planning: 'write', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'read'
        },
        // Directeur de casting
        'DirecteurÂ·rice de casting': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'none',
            personnages: 'write', lieux: 'none', comediens: 'write', equipe: 'none',
            depouillement: 'read', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'none', chat_comediens: 'write'
        },
        // Directeur de la photographie
        'DirecteurÂ·rice de la photographie': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'write',
            personnages: 'none', lieux: 'read', comediens: 'none', equipe: 'read',
            depouillement: 'write', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'none'
        },
        // Chefs de poste (par dÃ©faut)
        'chef_de_poste': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'none', lieux: 'read', comediens: 'none', equipe: 'read',
            depouillement: 'read', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'none'
        },
        // Scripte
        'Scripte': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'read', lieux: 'read', comediens: 'read', equipe: 'none',
            depouillement: 'write', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'read'
        },
        // Producteur
        'ProducteurÂ·rice': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'read', lieux: 'read', comediens: 'read', equipe: 'write',
            depouillement: 'read', planning: 'write', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'read', chat_comediens: 'read'
        },
        // RÃ©gisseur gÃ©nÃ©ral
        'RÃ©gisseurÂ·euse gÃ©nÃ©ralÂ·e': {
            synopsis: 'none', scenario: 'none', sequencier: 'read', storyboard: 'none',
            personnages: 'none', lieux: 'write', comediens: 'read', equipe: 'read',
            depouillement: 'read', planning: 'write', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'read'
        },
        // Technicien standard
        'technicien': {
            synopsis: 'none', scenario: 'none', sequencier: 'none', storyboard: 'none',
            personnages: 'none', lieux: 'none', comediens: 'none', equipe: 'none',
            depouillement: 'none', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'none', chat_technique: 'write', chat_comediens: 'none'
        },
        // ComÃ©dien
        'comedien': {
            synopsis: 'none', scenario: 'read', sequencier: 'none', storyboard: 'none',
            personnages: 'none', lieux: 'none', comediens: 'none', equipe: 'none',
            depouillement: 'none', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'none', chat_technique: 'none', chat_comediens: 'write'
        }
    },
    
    // Liste des sections avec leurs labels
    permissionSections: [
        { id: 'synopsis', label: 'ðŸ“ Synopsis' },
        { id: 'scenario', label: 'ðŸ“œ ScÃ©nario' },
        { id: 'sequencier', label: 'ðŸŽ¬ SÃ©quencier' },
        { id: 'storyboard', label: 'ðŸŽ¨ Storyboard' },
        { id: 'personnages', label: 'ðŸ‘¥ Personnages' },
        { id: 'lieux', label: 'ðŸ“ Lieux' },
        { id: 'comediens', label: 'ðŸŽ­ ComÃ©diens' },
        { id: 'equipe', label: 'ðŸŽ¥ Technicien.nes' },
        { id: 'depouillement', label: 'ðŸ“‹ DÃ©pouillement' },
        { id: 'planning', label: 'ðŸ“… Planning' },
        { id: 'stats', label: 'ðŸ“Š Statistiques' }
    ],
    currencies: ['â‚¬', '$', 'Â£', 'CHF'],
    
    // IcÃ´nes pour groupes et chats
    icons: [
        // CinÃ©ma & Tournage
        'ðŸŽ¬', 'ðŸŽ¥', 'ðŸ“½ï¸', 'ðŸŽžï¸', 'ðŸ“¹', 'ðŸŽ¦', 'ðŸŽ­', 'ðŸŽª', 'ðŸŽ¨', 'ðŸ–¼ï¸',
        'ðŸ“·', 'ðŸ“¸', 'ðŸ”¦', 'ðŸ’¡', 'ðŸŽ¤', 'ðŸŽ§', 'ðŸŽµ', 'ðŸŽ¶', 'ðŸŽ¼', 'ðŸŽ¹',
        'ðŸŽ¸', 'ðŸ¥', 'ðŸŽº', 'ðŸŽ»', 'ðŸª—', 'ðŸ“º', 'ðŸ“»', 'ðŸ”Š', 'ðŸ”‰', 'ðŸ”ˆ',
        // Personnes & RÃ´les
        'ðŸ‘¤', 'ðŸ‘¥', 'ðŸ§‘', 'ðŸ‘¨', 'ðŸ‘©', 'ðŸ§”', 'ðŸ‘´', 'ðŸ‘µ', 'ðŸ‘¶', 'ðŸ§’',
        'ðŸ¦¸', 'ðŸ¦¹', 'ðŸ§™', 'ðŸ§›', 'ðŸ§Ÿ', 'ðŸ¤´', 'ðŸ‘¸', 'ðŸ¤µ', 'ðŸ‘°', 'ðŸ¥·',
        'ðŸ‘®', 'ðŸ•µï¸', 'ðŸ’‚', 'ðŸ‘·', 'ðŸ§‘â€ðŸŽ¨', 'ðŸ§‘â€ðŸŽ¤', 'ðŸ§‘â€ðŸ’¼', 'ðŸ§‘â€ðŸ”§', 'ðŸ§‘â€ðŸ³', 'ðŸ§‘â€âš•ï¸',
        // Lieux & DÃ©cors
        'ðŸ ', 'ðŸ¡', 'ðŸ¢', 'ðŸ£', 'ðŸ¤', 'ðŸ¥', 'ðŸ¦', 'ðŸ¨', 'ðŸ©', 'ðŸª',
        'ðŸ«', 'ðŸ¬', 'ðŸ­', 'ðŸ¯', 'ðŸ°', 'â›ª', 'ðŸ•Œ', 'ðŸ•', 'â›©ï¸', 'ðŸ•‹',
        'ðŸŒƒ', 'ðŸŒ†', 'ðŸŒ‡', 'ðŸŒ‰', 'ðŸŒŒ', 'ðŸ™ï¸', 'ðŸŒ„', 'ðŸŒ…', 'ðŸ–ï¸', 'ðŸ•ï¸',
        'ðŸœï¸', 'ðŸï¸', 'ðŸžï¸', 'ðŸŒ‹', 'â›°ï¸', 'ðŸ”ï¸', 'ðŸ—»', 'ðŸŒ²', 'ðŸŒ³', 'ðŸŒ´',
        // Transport & VÃ©hicules
        'ðŸš—', 'ðŸš•', 'ðŸš™', 'ðŸšŒ', 'ðŸšŽ', 'ðŸŽï¸', 'ðŸš“', 'ðŸš‘', 'ðŸš’', 'ðŸš',
        'ðŸ›»', 'ðŸšš', 'ðŸš›', 'ðŸšœ', 'ðŸï¸', 'ðŸ›µ', 'ðŸš²', 'ðŸ›´', 'âœˆï¸', 'ðŸš',
        'ðŸ›¸', 'ðŸš€', 'ðŸ›¶', 'â›µ', 'ðŸš¤', 'ðŸ›¥ï¸', 'ðŸš¢', 'ðŸš‚', 'ðŸšƒ', 'ðŸš„',
        // Objets & Accessoires
        'ðŸ’¼', 'ðŸ‘œ', 'ðŸŽ’', 'ðŸ‘“', 'ðŸ•¶ï¸', 'ðŸ¥½', 'ðŸ‘’', 'ðŸŽ©', 'ðŸ§¢', 'â›‘ï¸',
        'ðŸ’„', 'ðŸ’', 'ðŸ’Ž', 'ðŸ‘‘', 'âŒš', 'ðŸ“±', 'ðŸ’»', 'ðŸ–¥ï¸', 'ðŸ–¨ï¸', 'âŒ¨ï¸',
        'ðŸ–±ï¸', 'ðŸ’¾', 'ðŸ’¿', 'ðŸ“€', 'ðŸ“¼', 'ðŸ“ž', 'â˜Žï¸', 'ðŸ“Ÿ', 'ðŸ“ ', 'ðŸ”Œ',
        // Nature & MÃ©tÃ©o
        'â˜€ï¸', 'ðŸŒ™', 'â­', 'ðŸŒŸ', 'âœ¨', 'âš¡', 'ðŸ”¥', 'ðŸ’§', 'ðŸŒŠ', 'â„ï¸',
        'ðŸŒˆ', 'â˜ï¸', 'â›…', 'ðŸŒ§ï¸', 'â›ˆï¸', 'ðŸŒ©ï¸', 'ðŸŒ¨ï¸', 'ðŸ’¨', 'ðŸŒªï¸', 'ðŸŒ«ï¸',
        // Actions & Symboles
        'â¤ï¸', 'ðŸ’”', 'ðŸ’•', 'ðŸ’–', 'ðŸ’—', 'ðŸ’˜', 'ðŸ’', 'ðŸ’ž', 'ðŸ’Ÿ', 'â£ï¸',
        'âš”ï¸', 'ðŸ›¡ï¸', 'ðŸ”«', 'ðŸ’£', 'ðŸ”ª', 'ðŸ—¡ï¸', 'âš°ï¸', 'ðŸ†', 'ðŸ¥‡', 'ðŸ¥ˆ',
        'ðŸŽ¯', 'ðŸŽ²', 'ðŸŽ®', 'ðŸ•¹ï¸', 'ðŸŽ°', 'ðŸ§©', 'â™Ÿï¸', 'ðŸŽ³', 'ðŸŽ±', 'ðŸ”®',
        // Nourriture (pour catering)
        'ðŸ½ï¸', 'ðŸ´', 'ðŸ¥„', 'ðŸ•', 'ðŸ”', 'ðŸŸ', 'ðŸŒ­', 'ðŸ¿', 'ðŸ¥¤', 'â˜•'
    ],
    rateTypes: ['Jour', 'Semaine', 'Forfait', 'Heure'],
    availabilityColors: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b', '#8e44ad', '#27ae60'],
	 defaultTags: [ {id: 't1', name: 'Standard', color: 'transparent'} ],
      defaultGroups: [
          {id: 'gp1', name: 'Protagonistes', type: 'perso'},
          {id: 'gp2', name: 'Antagonistes', type: 'perso'},
          {id: 'gp3', name: 'Secondaires', type: 'perso'},
          {id: 'ga1', name: 'Casting Principal', type: 'actor'},
          {id: 'ga2', name: 'RÃ´les Secondaires', type: 'actor'},
          {id: 'gl1', name: 'IntÃ©rieurs', type: 'lieu'},
          {id: 'gl2', name: 'ExtÃ©rieurs', type: 'lieu'}
      ]
  };

  // === CONSTANTES PARTAGÃ‰ES ===
  const SCENE_STATUS_LABELS = { 'not-verified': 'ðŸ”´', 'to-work': 'ðŸŸ¡', 'verified': 'ðŸŸ¢' };
  const RESOURCE_CAT_TO_BD = { accessoire: 'ACCESSOIRES', costume: 'COSTUMES', vehicule: 'VEHICULES' };
  const BD_TO_RESOURCE_CAT = { 'ACCESSOIRES': 'accessoire', 'COSTUMES': 'costume', 'VEHICULES': 'vehicule' };
  const EXPENSE_STATUS_LABELS = { pending: 'En attente', approved: 'ValidÃ©', rejected: 'RefusÃ©', done: 'PayÃ©', escalated: 'RemontÃ©', returned: 'RenvoyÃ©' };

  let state = { 
      data: null, 
      currentUser: null, 
      currentProjectId: null, 
      currentRole: 'viewer', 
      currentEditingId: null, 
      activeBdSceneId: null, 
      scriptAC: { active: false, index: -1, items: [] }, 
      dbListener: null, 
      presenceRef: null, 
      locksListener: null, 
      locksChannel: null,
      activeLocks: {}, 
      contextSceneId: null,
      contacts: { actors: [], crew: [] },
      userProfile: null
  };
  
  const els = {
    authView: document.getElementById('auth-view'), dashboardView: document.getElementById('dashboard-view'), appView: document.getElementById('app-view'), projectList: document.getElementById('project-list'), contactsView: document.getElementById('contacts-view'), contactsList: document.getElementById('contacts-list'), publicProfileView: document.getElementById('public-profile-view'),
    loginForm: document.getElementById('login-form'), signupForm: document.getElementById('signup-form'), forgotForm: document.getElementById('forgot-form'),
    loginEmail: document.getElementById('login-email'), loginPass: document.getElementById('login-pass'), signupEmail: document.getElementById('signup-email'), signupPass: document.getElementById('signup-pass'), signupConfirm: document.getElementById('signup-confirm'), forgotEmail: document.getElementById('forgot-email'),
    loginError: document.getElementById('login-error'), loginSuccess: document.getElementById('login-success'), signupError: document.getElementById('signup-error'), forgotError: document.getElementById('forgot-error'), forgotSuccess: document.getElementById('forgot-success'),
    
    title: document.getElementById('projectTitle'), roleBadge: document.getElementById('role-badge'), presenceList: document.getElementById('presence-list'),
    synopsisEditor: document.getElementById('synopsisEditor'),
    shortEditor: document.getElementById('shortEditor'),
    longEditor: document.getElementById('longEditor'),
    
    boardList: document.getElementById('boardList'), boardSynopsis: document.getElementById('boardSynopsisDisplay'), boardShort: document.getElementById('boardShortDisplay'), boardLong: document.getElementById('boardLongDisplay'),
    toggleSynop: document.getElementById('toggleSynop'), toggleShort: document.getElementById('toggleShort'), toggleLong: document.getElementById('toggleLong'), blockSynop: document.getElementById('boardSynopBlock'), blockShort: document.getElementById('boardShortBlock'), blockLong: document.getElementById('boardLongBlock'),
    
    scriptContainer: document.getElementById('scriptContainer'), charContainer: document.getElementById('charContainer'), actorContainer: document.getElementById('actorContainer'), locContainer: document.getElementById('locContainer'),
    bdScriptContent: document.getElementById('bdScriptContent'), bdRightContent: document.getElementById('bdRightContent'), bdCtxMenu: document.getElementById('breakdown-ctx-menu'), tagCtxMenu: document.getElementById('tag-ctx-menu'),
    btnSave: document.getElementById('btnSave'), fileInput: document.getElementById('fileInput'), importInput: document.getElementById('importInput'), 
    inpPre: document.getElementById('inpPre'), inpLoc: document.getElementById('inpLoc'), inpSuff: document.getElementById('inpSuff'), inpPerso: document.getElementById('inpPerso'), inpTime: document.getElementById('inpTime'), inpResume: document.getElementById('inpResume'),
    acList: document.getElementById('autocomplete-list'), scriptACList: document.getElementById('script-ac-list'),
    exportModal: document.getElementById('export-modal'), shareModal: document.getElementById('share-modal'), tagModal: document.getElementById('tag-modal'),
    
    visualWizard: document.getElementById('visual-wizard'),
    wizPageView: document.getElementById('wizard-page-view'),
    wizTitle: document.getElementById('wiz-step-title'),
    wizDesc: document.getElementById('wiz-step-desc'),
    wizSkip: document.getElementById('wiz-skip-btn'),
    wizSceneBox: document.getElementById('wiz-scene-breakdown'),
    cleanupToast: document.getElementById('cleanup-toast'),
    quickNav: document.getElementById('quick-nav'),
    editSceneForm: document.getElementById('edit-scene-form'),
    
    // NOUVEAUX ELEMENTS V62
    versionModal: document.getElementById('version-modal'),
    versionList: document.getElementById('version-list')
  };

  // Module de confirmation/prompt moderne
  const ConfirmModal = {
      // Affiche une modale de confirmation
      show: (options) => {
          return new Promise((resolve) => {
              const { title = 'Confirmation', message = 'ÃŠtes-vous sÃ»r ?', icon = 'â“', confirmText = 'Confirmer', cancelText = 'Annuler', type = 'confirm', inputPlaceholder = '', inputValue = '', dangerous = false } = options;
              
              const overlay = document.createElement('div');
              overlay.className = 'confirm-modal-overlay';
              overlay.onclick = (e) => { if(e.target === overlay) { overlay.remove(); resolve(type === 'prompt' ? null : false); } };
              
              const btnClass = dangerous ? 'danger' : 'confirm';
              const inputHtml = type === 'prompt' ? `<input type="text" class="confirm-modal-input" id="confirm-modal-input" placeholder="${inputPlaceholder}" value="${inputValue}">` : '';
              
              overlay.innerHTML = `
                  <div class="confirm-modal-box">
                      <div class="confirm-modal-icon">${icon}</div>
                      <div class="confirm-modal-title">${title}</div>
                      <div class="confirm-modal-message">${message}</div>
                      ${inputHtml}
                      <div class="confirm-modal-buttons">
                          <button class="confirm-modal-btn cancel" id="confirm-modal-cancel">${cancelText}</button>
                          <button class="confirm-modal-btn ${btnClass}" id="confirm-modal-ok">${confirmText}</button>
                      </div>
                  </div>
              `;
              
              document.body.appendChild(overlay);
              
              const input = overlay.querySelector('#confirm-modal-input');
              const okBtn = overlay.querySelector('#confirm-modal-ok');
              const cancelBtn = overlay.querySelector('#confirm-modal-cancel');
              
              if(input) { input.focus(); input.select(); input.onkeydown = (e) => { if(e.key === 'Enter') okBtn.click(); if(e.key === 'Escape') cancelBtn.click(); }; }
              
              okBtn.onclick = () => { overlay.remove(); resolve(type === 'prompt' ? (input ? input.value : true) : true); };
              cancelBtn.onclick = () => { overlay.remove(); resolve(type === 'prompt' ? null : false); };
              
              // Focus sur le bouton OK si pas d'input
              if(!input) okBtn.focus();
          });
      },
      
      // Raccourci pour confirmation simple
      confirm: (message, title = 'Confirmation', dangerous = false) => {
          return ConfirmModal.show({ title, message, icon: dangerous ? 'âš ï¸' : 'â“', dangerous, confirmText: dangerous ? 'Supprimer' : 'Confirmer' });
      },
      
      // Raccourci pour confirmation de suppression
      confirmDelete: (message, title = 'Supprimer ?') => {
          return ConfirmModal.show({ title, message, icon: 'ðŸ—‘ï¸', dangerous: true, confirmText: 'Supprimer' });
      },
      
      // Raccourci pour prompt
      prompt: (message, title = 'Saisie', placeholder = '', defaultValue = '') => {
          return ConfirmModal.show({ title, message, icon: 'âœï¸', type: 'prompt', inputPlaceholder: placeholder, inputValue: defaultValue, confirmText: 'OK' });
      },
      
      // Raccourci pour alerte (juste OK)
      alert: (message, title = 'Information', icon = 'â„¹ï¸') => {
          return new Promise((resolve) => {
              const overlay = document.createElement('div');
              overlay.className = 'confirm-modal-overlay';
              overlay.onclick = (e) => { if(e.target === overlay) { overlay.remove(); resolve(); } };
              
              overlay.innerHTML = `
                  <div class="confirm-modal-box">
                      <div class="confirm-modal-icon">${icon}</div>
                      <div class="confirm-modal-title">${title}</div>
                      <div class="confirm-modal-message">${message}</div>
                      <div class="confirm-modal-buttons">
                          <button class="confirm-modal-btn confirm" id="confirm-modal-ok">OK</button>
                      </div>
                  </div>
              `;
              
              document.body.appendChild(overlay);
              const okBtn = overlay.querySelector('#confirm-modal-ok');
              okBtn.onclick = () => { overlay.remove(); resolve(); };
              okBtn.focus();
          });
      }
  };

  // ========== LOADING SCREEN ==========
  // ðŸŽ¬ SECRET: Triple-clic sur le titre "Moteur" dans le header pour tester le loader !
  const LoadingScreen = {
      messages: [
          "PrÃ©paration du plateau...",
          "Le perchman s'est encore perdu...",
          "Chargement des vÃ©hicules de rÃ©gie...",
          "Les comÃ©diens se maquillent...",
          "Le rÃ©alisateur cherche sa vision...",
          "CafÃ© pour l'Ã©quipe technique â˜•",
          "On attend le soleil... â˜€ï¸",
          "Silence, on tourne ! ðŸ¤«",
          "VÃ©rification des raccords costume...",
          "Le chef op' rÃ¨gle les lumiÃ¨res...",
          "Moteur demandÃ©... ðŸŽ¬",
          "Le script court aprÃ¨s les feuilles...",
          "CÃ¢blage en cours... ðŸ”Œ",
          "Le HMC fait des miracles ðŸ’„",
          "Briefing de l'Ã©quipe...",
          "Installation du combo vidÃ©o...",
          "Les figurants arrivent en retard...",
          "On cherche le clap... ðŸŽ¬",
          "Le directeur photo mÃ©dite...",
          "Pause syndicale obligatoire â°",
          "Le stagiaire fait le cafÃ©...",
          "RepÃ©rage des axes camÃ©ra...",
          "DÃ©chargement du camion lumiÃ¨re...",
          "La scripte note tout... ðŸ“",
          "On refait une prise pour la route !",
          "Le steadicamer s'Ã©chauffe ðŸƒ",
          "Derniers rÃ©glages son...",
          "Le producteur compte les heures sup...",
          "Installation de la dolly...",
          "C'est bon pour moi ! ðŸ‘",
          "VÃ©rification de la gate...",
          "On enchaÃ®ne ! â­ï¸",
          "Le 1er assistant gÃ¨re le planning...",
          "Distribution des feuilles de service...",
          "Le machino installe les rails...",
          "Raccord maquillage entre deux prises...",
          "Le rÃ©gisseur gÃ¨re les repas ðŸ½ï¸",
          "Check de la camÃ©ra...",
          "On attend que l'avion passe... âœˆï¸",
          "Le DA ajuste le dÃ©cor...",
		      "RÃ©bellion sur le plateau ! ðŸ”¥",
    "Le rÃ©alisateur se cache pour pleurer ðŸ˜¢",
    "Les techniciens et les acteurs font un poker ðŸƒ",
    "L'acteur principal a encore une idÃ©e de rÃ©alisation... ðŸ™„",
      ],
      interval: null,
      currentIndex: 0,
      
      show: (title = "Chargement du projet...") => {
          const overlay = document.getElementById('loading-overlay');
          const titleEl = overlay.querySelector('.loading-title');
          const progressBar = document.getElementById('loading-progress-bar');
          
          titleEl.textContent = title;
          progressBar.style.width = '10%';
          overlay.classList.add('visible');
          
          // Message initial alÃ©atoire
          LoadingScreen.currentIndex = Math.floor(Math.random() * LoadingScreen.messages.length);
          LoadingScreen.updateMessage();
          
          // Changer le message toutes les 1.5 secondes
          LoadingScreen.interval = setInterval(() => {
              LoadingScreen.currentIndex = (LoadingScreen.currentIndex + 1) % LoadingScreen.messages.length;
              LoadingScreen.updateMessage();
              // Progression simulÃ©e
              const current = parseFloat(progressBar.style.width) || 10;
              if(current < 90) {
                  progressBar.style.width = Math.min(current + Math.random() * 15, 90) + '%';
              }
          }, 1500);
      },
      
      updateMessage: () => {
          const msgEl = document.getElementById('loading-message');
          if(msgEl) {
              msgEl.style.animation = 'none';
              msgEl.offsetHeight; // Trigger reflow
              msgEl.style.animation = 'messageFade 0.5s ease';
              msgEl.textContent = LoadingScreen.messages[LoadingScreen.currentIndex];
          }
      },
      
      setProgress: (percent) => {
          const progressBar = document.getElementById('loading-progress-bar');
          if(progressBar) {
              progressBar.style.width = Math.min(percent, 100) + '%';
          }
      },
      
      hide: () => {
          const overlay = document.getElementById('loading-overlay');
          const progressBar = document.getElementById('loading-progress-bar');
          
          // ComplÃ©ter la barre
          if(progressBar) progressBar.style.width = '100%';
          
          // ArrÃªter les messages
          if(LoadingScreen.interval) {
              clearInterval(LoadingScreen.interval);
              LoadingScreen.interval = null;
          }
          
          // Cacher aprÃ¨s un court dÃ©lai pour voir la barre Ã  100%
          setTimeout(() => {
              overlay.classList.remove('visible');
          }, 300);
      }
  };

  const Utils = {
      sanitizeEmail: (email) => email.replace(/\./g, ','),
      escape: (s) => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'),
      generateUniqueId: () => Date.now() + '_' + Math.random().toString(36).slice(2, 11),
      
      // Formatage relatif du temps (il y a X minutes, etc.)
      timeAgo: (dateString) => {
          const date = new Date(dateString);
          const now = new Date();
          const seconds = Math.floor((now - date) / 1000);
          if(seconds < 60) return 'Ã  l\'instant';
          const minutes = Math.floor(seconds / 60);
          if(minutes < 60) return `il y a ${minutes} min`;
          const hours = Math.floor(minutes / 60);
          if(hours < 24) return `il y a ${hours}h`;
          const days = Math.floor(hours / 24);
          if(days < 7) return `il y a ${days} jour${days > 1 ? 's' : ''}`;
          const weeks = Math.floor(days / 7);
          if(weeks < 4) return `il y a ${weeks} sem.`;
          const months = Math.floor(days / 30);
          if(months < 12) return `il y a ${months} mois`;
          const years = Math.floor(months / 12);
          return `il y a ${years} an${years > 1 ? 's' : ''}`;
      },
      
      // Notifications Toast
      notifyImpact: (sourceTab, targetTabs, action = 'modifiÃ©') => {
          const tabNames = { synopsis: 'Synopsis', board: 'SÃ©quencier', titlepage: 'Page de titre', script: 'ScÃ©nario', breakdown: 'DÃ©pouillement', storyboard: 'Storyboard', chars: 'Personnages', actors: 'ComÃ©diens', locs: 'DÃ©cors', planning: 'Planning' };
          const targets = Array.isArray(targetTabs) ? targetTabs : [targetTabs];
          const targetLabels = targets.map(t => tabNames[t] || t).join(', ');
          Utils.toast(`ðŸ”— ${targetLabels} mis Ã  jour`, 'info', 3000);
      },
      toast: (message, type = 'info', duration = 3000) => {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = 'toast ' + type;
          const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
          toast.innerHTML = `
              <span class="toast-icon">${icons[type] || icons.info}</span>
              <span class="toast-message">${message}</span>
              <button class="toast-close" onclick="this.parentElement.remove()">âœ–</button>
          `;
          container.appendChild(toast);
          setTimeout(() => { if(toast.parentElement) toast.remove(); }, duration);
      },
      
      showIconPicker: (callback) => {
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10002;';
          modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
          
          let iconsHtml = '';
          CONFIG.icons.forEach(icon => {
              iconsHtml += `<div class="icon-picker-item" onclick="event.stopPropagation();" data-icon="${icon}" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;border-radius:8px;transition:background 0.2s;">${icon}</div>`;
          });
          
          modal.innerHTML = `
              <div style="background:var(--panel-bg);border-radius:12px;padding:20px;max-width:450px;width:90%;max-height:80vh;display:flex;flex-direction:column;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                      <h3 class="m-0">ðŸŽ¨ Choisir une icÃ´ne</h3>
                      <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;">âœ–</button>
                  </div>
                  <div style="flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(8,1fr);gap:8px;padding:10px;">
                      ${iconsHtml}
                  </div>
              </div>
          `;
          
          document.body.appendChild(modal);
          
          // Ajouter les listeners aprÃ¨s insertion
          modal.querySelectorAll('.icon-picker-item').forEach(item => {
              item.onmouseover = () => item.style.background = 'var(--bg)';
              item.onmouseout = () => item.style.background = 'transparent';
              item.onclick = (e) => {
                  e.stopPropagation();
                  const icon = item.dataset.icon;
                  modal.remove();
                  if(callback) callback(icon);
              };
          });
      },
	  getDragAfterElement: (container, y, selector) => { const els = [...container.querySelectorAll(selector + ':not(.dragging)')]; return els.reduce((closest, child)=>{ const box = child.getBoundingClientRect(); const offset=y-box.top-box.height/2; return (offset<0 && offset>closest.offset)?{offset:offset,element:child}:closest; }, {offset:Number.NEGATIVE_INFINITY}).element; },
      debounce: (func, wait) => { let timeout; return function(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; },
      getInitials: (email) => email.substring(0,2).toUpperCase(),
      getColor: (str) => { const colors = ['#f44336', '#E91E63', '#9C27B0', '#3F51B5', '#2196F3', '#009688', '#FF9800', '#795548']; let hash = 0; for(let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); return colors[Math.abs(hash) % colors.length]; },
      
      setupAutocomplete: (inp) => { 
          let currentFocus = -1; 
          inp.addEventListener("input", function(e) { 
              const val = this.value; Utils.closeAllLists(); 
              if (!val) return false; 
              const terms = val.split(';'); 
              const currentTerm = terms[terms.length - 1].trim().toLowerCase(); 
              if(currentTerm.length < 1) return; 
              currentFocus = -1; els.acList.innerHTML = ''; 
              const matches = state.data.characters.filter(c => c.name.toLowerCase().startsWith(currentTerm)); 
              if(matches.length === 0) return; 
              matches.forEach(match => { 
                  const div = document.createElement("div"); div.className = "autocomplete-item"; 
                  div.innerHTML = "<strong>" + match.name.substring(0, currentTerm.length) + "</strong>" + match.name.substring(currentTerm.length); 
                  div.innerHTML += "<input type='hidden' value='" + match.name + "'>"; 
                  div.addEventListener("click", function(e) { 
                      terms[terms.length - 1] = " " + this.getElementsByTagName("input")[0].value; 
                      inp.value = terms.join(';').trim() + '; '; 
                      Utils.closeAllLists(); inp.focus(); 
                  }); 
                  els.acList.appendChild(div); 
              }); 
          }); 
          inp.addEventListener("keydown", function(e) { 
              let x = els.acList.getElementsByTagName("div"); 
              if (e.key === "ArrowDown") { currentFocus++; addActive(x); } 
              else if (e.key === "ArrowUp") { currentFocus--; addActive(x); } 
              else if (e.key === "Enter") { 
                  if (currentFocus > -1) { e.preventDefault(); if (x) x[currentFocus].click(); } 
                  else { Utils.closeAllLists(); } 
              } 
          }); 
          function addActive(x) { 
              if (!x) return false; removeActive(x); 
              if (currentFocus >= x.length) currentFocus = 0; 
              if (currentFocus < 0) currentFocus = (x.length - 1); 
              x[currentFocus].classList.add("autocomplete-active"); 
          } 
          function removeActive(x) { for (let i = 0; i < x.length; i++) x[i].classList.remove("autocomplete-active"); } 
      },
      closeAllLists: () => { while (els.acList.firstChild) els.acList.removeChild(els.acList.firstChild); },
      setupEnterNav: () => { 
          els.inpPre.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); els.inpLoc.focus(); } }); 
          els.inpLoc.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); els.inpSuff.focus(); } }); 
          els.inpSuff.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); els.inpTime.focus(); } }); 
          els.inpTime.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); els.inpPerso.focus(); } }); 
          els.inpPerso.addEventListener('keydown', e => { if(e.key==='Enter' && els.acList.children.length === 0){ e.preventDefault(); els.inpResume.focus(); } }); 
          els.inpResume.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); Actions.addScene(); } }); 
      },
      estimateTime: (htmlContent) => {
          if(!htmlContent) return "0";
          const tmp = document.createElement("DIV");
          tmp.innerHTML = htmlContent;
          const text = tmp.textContent || tmp.innerText || "";
          const wordCount = text.trim().split(/\s+/).length;
          if(wordCount === 0) return "0";
          const minutes = (wordCount / 250); 
          return minutes < 0.2 ? "0.2" : minutes.toFixed(1);
      }
  };

  // ========== PROFILE RENDERER - Fonction commune pour le rendu des profils ==========
  const ProfileRenderer = {
      // Options pour les selects
      selectOptions: {
          gender: [
              {value: '', label: '-- Sexe --'},
              {value: 'homme', label: 'Homme'},
              {value: 'femme', label: 'Femme'},
              {value: 'non-binaire', label: 'Non-binaire'},
              {value: 'non-precise', label: 'Ne souhaite pas prÃ©ciser'}
          ],
          eyeColor: [
              {value: '', label: '-- Yeux --'},
              {value: 'marron', label: 'Marron'},
              {value: 'bleu', label: 'Bleu'},
              {value: 'vert', label: 'Vert'},
              {value: 'gris', label: 'Gris'},
              {value: 'noisette', label: 'Noisette'},
              {value: 'noir', label: 'Noir'}
          ],
          hairColor: [
              {value: '', label: '-- Cheveux (couleur) --'},
              {value: 'noir', label: 'Noir'},
              {value: 'brun', label: 'Brun'},
              {value: 'chatain', label: 'ChÃ¢tain'},
              {value: 'blond', label: 'Blond'},
              {value: 'roux', label: 'Roux'},
              {value: 'gris', label: 'Gris'},
              {value: 'blanc', label: 'Blanc'},
              {value: 'chauve', label: 'Chauve'}
          ],
          hairLength: [
              {value: '', label: '-- Cheveux (longueur) --'},
              {value: 'chauve', label: 'Chauve'},
              {value: 'rase', label: 'RasÃ©'},
              {value: 'court', label: 'Court'},
              {value: 'mi-long', label: 'Mi-long'},
              {value: 'long', label: 'Long'}
          ],
          corpulence: [
              {value: '', label: '-- Corpulence --'},
              {value: 'mince', label: 'Mince'},
              {value: 'normal', label: 'Normal'},
              {value: 'athletique', label: 'AthlÃ©tique'},
              {value: 'muscle', label: 'MusclÃ©'},
              {value: 'rond', label: 'Rond'},
              {value: 'fort', label: 'Fort / Costaud'}
          ],
          ethnicity: [
              {value: '', label: '-- Origine ethnique --'},
              {value: 'caucasien', label: 'Caucasien'},
              {value: 'africain', label: 'Africain / Afro-descendant'},
              {value: 'asiatique', label: 'Asiatique'},
              {value: 'latino', label: 'Latino / Hispanique'},
              {value: 'maghrebin', label: 'MaghrÃ©bin'},
              {value: 'moyenorient', label: 'Moyen-Orient'},
              {value: 'indien', label: 'Indien / Sud-asiatique'},
              {value: 'metis', label: 'MÃ©tis'},
              {value: 'autre', label: 'Autre'}
          ],
          professionalStatus: [
              {value: '', label: '-- Statut --'},
              {value: 'intermittent', label: 'IntermittentÂ·e du spectacle'},
              {value: 'micro-entrepreneur', label: 'Micro-entrepreneurÂ·e'},
              {value: 'amateur', label: 'AmateurÂ·rice (pas de statut)'}
          ]
      },

      // GÃ©nÃ¨re un select HTML
      renderSelect: (fieldName, currentValue, options, onChange, disabled = false) => {
          const opts = (ProfileRenderer.selectOptions[fieldName] || options || [])
              .map(o => `<option value="${o.value}" ${currentValue === o.value ? 'selected' : ''}>${o.label}</option>`)
              .join('');
          return `<select class="profile-input" onchange="${onChange}" ${disabled ? 'disabled' : ''}>${opts}</select>`;
      },

      // GÃ©nÃ¨re un input HTML
      renderInput: (type, placeholder, value, onChange, disabled = false, extra = '') => {
          return `<input type="${type}" class="profile-input" placeholder="${placeholder}" value="${value || ''}" onchange="${onChange}" ${disabled ? 'disabled' : ''} ${extra}>`;
      },

      // GÃ©nÃ¨re un textarea HTML
      renderTextarea: (placeholder, value, onChange, disabled = false, style = '') => {
          return `<textarea class="profile-input" placeholder="${placeholder}" onchange="${onChange}" ${disabled ? 'disabled' : ''} style="${style}">${value || ''}</textarea>`;
      },

      // Section Description Physique (pour comÃ©diens)
      renderPhysicalSection: (profile, onChange, disabled = false) => {
          const change = (field) => onChange.replace('{field}', field);
          return `
          <div class="profile-section-block info-box">
              <strong class="form-label-block">ðŸ“ Description physique</strong>
              <div class="profile-row mb-8">
                  ${ProfileRenderer.renderInput('number', 'Taille (cm)', profile.height, change('height'), disabled)}
                  ${ProfileRenderer.renderInput('number', 'Poids (kg)', profile.weight, change('weight'), disabled)}
                  ${ProfileRenderer.renderInput('number', 'Ã‚ge', profile.age, change('age'), disabled)}
              </div>
              <div class="profile-row mb-8">
                  ${ProfileRenderer.renderSelect('eyeColor', profile.eyeColor, null, change('eyeColor'), disabled)}
                  ${ProfileRenderer.renderSelect('hairColor', profile.hairColor, null, change('hairColor'), disabled)}
                  ${ProfileRenderer.renderSelect('hairLength', profile.hairLength, null, change('hairLength'), disabled)}
              </div>
              <div class="profile-row mb-8">
                  ${ProfileRenderer.renderSelect('corpulence', profile.corpulence, null, change('corpulence'), disabled)}
                  ${ProfileRenderer.renderSelect('ethnicity', profile.ethnicity, null, change('ethnicity'), disabled)}
              </div>
              <div class="profile-row">
                  ${ProfileRenderer.renderInput('text', 'Sports pratiquÃ©s (Ã©quitation, natation...)', profile.sports, change('sports'), disabled)}
                  ${ProfileRenderer.renderInput('text', 'Langues parlÃ©es (franÃ§ais, anglais...)', profile.languages, change('languages'), disabled)}
              </div>
          </div>`;
      },

      // Section VÃ©hicule
      renderVehicleSection: (profile, onChange, toggleFn, disabled = false, idPrefix = 'vehicle') => {
          const change = (field) => onChange.replace('{field}', field);
          return `
          <div class="profile-section-block mt-15">
              <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                  <input type="checkbox" ${profile.hasVehicle ? 'checked' : ''} onchange="${toggleFn}" ${disabled ? 'disabled' : ''}>
                  <strong>ðŸš— PossÃ¨de un vÃ©hicule</strong>
              </label>
              <div id="${idPrefix}-details" style="display:${profile.hasVehicle ? 'block' : 'none'}; margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                  <div class="profile-row mb-10">
                      ${ProfileRenderer.renderInput('text', 'Type de vÃ©hicule', profile.vehicleType, change('vehicleType'), disabled)}
                      ${ProfileRenderer.renderInput('text', 'Immatriculation', profile.vehiclePlate, change('vehiclePlate'), disabled)}
                  </div>
                  <div class="profile-row mb-10">
                      ${ProfileRenderer.renderInput('number', 'Nb places dispo', profile.vehicleSeats, change('vehicleSeats'), disabled, 'min="1" max="9"')}
                      <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px; background:var(--panel-bg); border-radius:6px;">
                          <input type="checkbox" ${profile.vehicleTrunk ? 'checked' : ''} onchange="${change('vehicleTrunk')}" ${disabled ? 'disabled' : ''}>
                          <span>ðŸ“¦ Coffre disponible</span>
                      </label>
                  </div>
                  ${ProfileRenderer.renderTextarea('Notes vÃ©hicule (climatisation, GPS, attelage...)', profile.vehicleNotes, change('vehicleNotes'), disabled, 'min-height:60px;')}
              </div>
          </div>`;
      },

      // Section Tarif & Collaboration
      renderRateSection: (profile, onChange, disabled = false) => {
          const change = (field) => onChange.replace('{field}', field);
          const currencies = (CONFIG.currencies || ['â‚¬', '$', 'Â£', 'CHF']).map(c => ({value: c, label: c}));
          const rateTypes = (CONFIG.rateTypes || ['Jour', 'Semaine', 'Forfait', 'Heure']).map(t => ({value: t, label: t}));
          
          return `
          <div class="profile-section-block info-box">
              <strong class="form-label-block">ðŸ’° Tarif</strong>
              <div class="profile-row">
                  ${ProfileRenderer.renderInput('number', 'Tarif', profile.dailyRate, change('dailyRate'), disabled)}
                  ${ProfileRenderer.renderSelect('currency', profile.rateCurrency || 'â‚¬', currencies, change('rateCurrency'), disabled)}
                  ${ProfileRenderer.renderSelect('rateType', profile.rateType || 'Jour', rateTypes, change('rateType'), disabled)}
              </div>
          </div>`;
      },

      // Section Statut Professionnel
      renderProfessionalStatus: (profile, onChange, onStatusChange, disabled = false) => {
          const change = (field) => onChange.replace('{field}', field);
          return `
          <div class="profile-section-block info-box">
              <strong class="form-label-block">ðŸ“‹ Statut professionnel</strong>
              <div class="profile-row mb-10">
                  ${ProfileRenderer.renderSelect('professionalStatus', profile.professionalStatus, null, onStatusChange, disabled)}
              </div>
              ${profile.professionalStatus === 'intermittent' ? `
              <div class="profile-row">
                  ${ProfileRenderer.renderInput('text', 'NÂ° SÃ©curitÃ© Sociale', profile.numSecu, change('numSecu'), disabled)}
                  ${ProfileRenderer.renderInput('text', 'NÂ° CongÃ©s Spectacles', profile.numCongesSpectacles, change('numCongesSpectacles'), disabled)}
              </div>` : ''}
              ${profile.professionalStatus === 'micro-entrepreneur' ? `
              <div class="profile-row">
                  ${ProfileRenderer.renderInput('text', 'NÂ° SIRET', profile.siret, change('siret'), disabled)}
              </div>` : ''}
          </div>`;
      },

      // Section Type de Collaboration (Pro/Semi-pro/BÃ©nÃ©vole)
      renderCollabType: (profile, onSelect, disabled = false) => {
          const collabDesc = {
              'pro': 'ðŸ’¼ Contrat classique, horaires et tarifs standards',
              'semi-pro': 'ðŸ¤ Flexible sur les conditions mais rÃ©munÃ©rÃ©Â·e',
              'benevole': 'ðŸŽ Pas de rÃ©munÃ©ration, dÃ©fraiement repas + transport'
          };
          return `
          <div class="profile-section-block mt-15">
              <strong class="form-label-block">ðŸ¤ Type de collaboration</strong>
              <div class="collab-type-selector">
                  <div class="collab-type-btn pro ${profile.collabType === 'pro' ? 'selected' : ''}" onclick="${onSelect.replace('{type}', 'pro')}" ${disabled ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                      ðŸŽ¬ Pro
                  </div>
                  <div class="collab-type-btn semi-pro ${profile.collabType === 'semi-pro' ? 'selected' : ''}" onclick="${onSelect.replace('{type}', 'semi-pro')}" ${disabled ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                      âš¡ Semi-pro
                  </div>
                  <div class="collab-type-btn benevole ${profile.collabType === 'benevole' ? 'selected' : ''}" onclick="${onSelect.replace('{type}', 'benevole')}" ${disabled ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                      â¤ï¸ BÃ©nÃ©vole
                  </div>
              </div>
              <p class="text-sec-xs-mt8">
                  ${collabDesc[profile.collabType] || 'SÃ©lectionnez votre type de collaboration prÃ©fÃ©rÃ©'}
              </p>
          </div>`;
      },

      // Section Bande DÃ©mo
      renderDemoReel: (profile, onChange, disabled = false, idPrefix = 'demoreel') => {
          return `
          <div class="profile-section-block info-box">
              <strong class="form-label-block">ðŸŽ¬ Bande DÃ©mo</strong>
              <input type="url" class="profile-input" placeholder="https://www.youtube.com/watch?v=... ou https://vimeo.com/..." value="${profile.demoreel || ''}" onchange="${onChange}" ${disabled ? 'disabled' : ''}>
              ${profile.demoreel ? `<div class="mt-10"><iframe src="${ProfileRenderer.getEmbedUrl(profile.demoreel)}" width="100%" height="200" frameborder="0" allowfullscreen class="br-8"></iframe></div>` : ''}
          </div>`;
      },

      // Convertit URL YouTube/Vimeo en URL embed
      getEmbedUrl: (url) => {
          if(!url) return '';
          // YouTube
          const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
          if(ytMatch) return `https://www.youtube.com/embed/${ytMatch[1]}`;
          // Vimeo
          const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
          if(vimeoMatch) return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
          return url;
      }
  };

  // ========== PREFERENCES SYNC ==========
  // Synchronise les prÃ©fÃ©rences UI (localStorage â†” Supabase user_profiles.preferences)
  const PreferencesSync = {
      SYNC_KEYS: [
          'fmp_theme_pref', 'fmp_design', 'fmp_nav_mode', 'fmp_tabs_mode',
          'fmp_tabs_position', 'fmp_board_mode', 'fmp_script_view_mode',
          'fmp_card_view_mode', 'moteur_icon_style', 'moteur_hub_cards',
          'moteur_ob_dismissed'
      ],
      _pushTimer: null,

      load: async () => {
          if (!state.currentUser?.email) return;
          try {
              const { data, error } = await supabase
                  .from('user_profiles')
                  .select('preferences')
                  .eq('email', state.currentUser.email.toLowerCase())
                  .single();
              if (error) { console.warn('[PreferencesSync] load error:', error.message); return; }
              const remote = data?.preferences;
              if (remote && Object.keys(remote).length > 0) {
                  PreferencesSync.SYNC_KEYS.forEach(key => {
                      if (remote[key] !== undefined) {
                          try { localStorage.setItem(key, remote[key]); } catch(e) {}
                      }
                  });
              } else {
                  await PreferencesSync.pushAll();
              }
          } catch(e) { console.warn('[PreferencesSync] load exception:', e); }
      },

      save: (key, value) => {
          try { localStorage.setItem(key, value); } catch(e) {}
          clearTimeout(PreferencesSync._pushTimer);
          PreferencesSync._pushTimer = setTimeout(() => PreferencesSync.pushAll(), 2000);
      },

      pushAll: async () => {
          if (!state.currentUser?.email) return;
          const prefs = {};
          PreferencesSync.SYNC_KEYS.forEach(key => {
              try {
                  const val = localStorage.getItem(key);
                  if (val !== null) prefs[key] = val;
              } catch(e) {}
          });
          try {
              const { error } = await supabase
                  .from('user_profiles')
                  .update({ preferences: prefs })
                  .eq('email', state.currentUser.email.toLowerCase());
              if (error) console.warn('[PreferencesSync] push error:', error.message);
          } catch(e) { console.warn('[PreferencesSync] push exception:', e); }
      }
  };

  // ========== SESSION MANAGER ==========
  // GÃ¨re la session unique par compte (multi-onglets OK, multi-ordinateurs bloquÃ©)
  const SessionManager = {
      sessionToken: null,
      tabId: null,
      channel: null,
      heartbeatInterval: null,
      isLeaderTab: false,
      
      init: () => {
          // GÃ©nÃ©rer un ID unique pour cet onglet
          SessionManager.tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
          
          // Initialiser BroadcastChannel pour la communication entre onglets
          if(typeof BroadcastChannel !== 'undefined') {
              SessionManager.channel = new BroadcastChannel('moteur_session');
              SessionManager.channel.onmessage = SessionManager.handleChannelMessage;
          }
          
          // Ã‰lection du leader (premier onglet ouvert)
          SessionManager.electLeader();
      },
      
      // Communication entre onglets du mÃªme navigateur
      handleChannelMessage: (event) => {
          const { type, tabId, data } = event.data;
          
          switch(type) {
              case 'NEW_TAB':
                  // Un nouvel onglet s'annonce, lui envoyer l'Ã©tat actuel
                  if(SessionManager.isLeaderTab) {
                      SessionManager.broadcast('SYNC_STATE', { 
                          projectId: state.currentProjectId,
                          projectData: state.data 
                      });
                  }
                  break;
                  
              case 'SYNC_STATE':
                  // Recevoir l'Ã©tat synchronisÃ©
                  if(data.projectId === state.currentProjectId && data.projectData) {
                      state.data = data.projectData;
                      if(typeof UI !== 'undefined' && UI.renderAll) {
                          UI.renderAll();
                      }
                  }
                  break;
                  
              case 'DATA_UPDATED':
                  // Un autre onglet a modifiÃ© les donnÃ©es
                  if(data.projectId === state.currentProjectId) {
                      Store.loadFromSupabase(state.currentProjectId);
                  }
                  break;
                  
              case 'LEADER_CHECK':
                  // RÃ©pondre pour confirmer qu'on est actif
                  if(SessionManager.isLeaderTab) {
                      SessionManager.broadcast('LEADER_ALIVE', {});
                  }
                  break;
                  
              case 'LOGOUT':
                  // DÃ©connexion depuis un autre onglet
                  supabase.auth.signOut().then(() => location.reload());
                  break;
          }
      },
      
      broadcast: (type, data) => {
          if(SessionManager.channel) {
              SessionManager.channel.postMessage({
                  type: type,
                  tabId: SessionManager.tabId,
                  data: data
              });
          }
      },
      
      electLeader: () => {
          // Le premier onglet devient leader
          const leaderKey = 'moteur_leader_tab';
          const existingLeader = localStorage.getItem(leaderKey);
          
          if(!existingLeader) {
              localStorage.setItem(leaderKey, SessionManager.tabId);
              SessionManager.isLeaderTab = true;
          }
          
          // VÃ©rifier pÃ©riodiquement si le leader est toujours actif
          setInterval(() => {
              const currentLeader = localStorage.getItem(leaderKey);
              if(currentLeader === SessionManager.tabId) {
                  // Mettre Ã  jour le timestamp
                  localStorage.setItem('moteur_leader_timestamp', Date.now().toString());
              } else {
                  // VÃ©rifier si le leader est mort (pas de mise Ã  jour depuis 5s)
                  const lastTimestamp = parseInt(localStorage.getItem('moteur_leader_timestamp') || '0');
                  if(Date.now() - lastTimestamp > 5000) {
                      // Prendre le leadership
                      localStorage.setItem(leaderKey, SessionManager.tabId);
                      SessionManager.isLeaderTab = true;
                  }
              }
          }, 2000);
          
          // Nettoyer Ã  la fermeture
          window.addEventListener('beforeunload', () => {
              if(SessionManager.isLeaderTab) {
                  localStorage.removeItem(leaderKey);
                  localStorage.removeItem('moteur_leader_timestamp');
              }
          });
      },
      
      // VÃ©rifier la session (simplifiÃ© pour Supabase)
      startSessionCheck: async (userId) => {
          // GÃ©nÃ©rer un token de session unique pour cet ordinateur/navigateur
          let browserToken = localStorage.getItem('moteur_browser_token');
          if(!browserToken) {
              browserToken = 'browser_' + Date.now() + '_' + Math.random().toString(36).slice(2, 15);
              localStorage.setItem('moteur_browser_token', browserToken);
          }
          SessionManager.sessionToken = browserToken;
          
          // Pour Supabase, on simplifie la gestion de session
          // La gestion multi-appareils sera gÃ©rÃ©e par les tokens JWT de Supabase
          
          // Nettoyer Ã  la fermeture
          window.addEventListener('beforeunload', () => {
              if(SessionManager.heartbeatInterval) {
                  clearInterval(SessionManager.heartbeatInterval);
              }
          });
          
          return true;
      },
      
      showKickedModal: () => {
          // CrÃ©er une modale bloquante
          const overlay = document.createElement('div');
          overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:99999;display:flex;align-items:center;justify-content:center;';
          overlay.innerHTML = `
              <div style="background:var(--panel-bg, #fff);padding:40px;border-radius:12px;text-align:center;max-width:400px;">
                  <div style="font-size:4rem;margin-bottom:20px;">ðŸ”</div>
                  <h2 style="margin-bottom:15px;color:var(--text-main, #333);">Session terminÃ©e</h2>
                  <p style="color:var(--text-sec, #666);margin-bottom:25px;">Votre compte s'est connectÃ© depuis un autre appareil. Cette session a Ã©tÃ© dÃ©connectÃ©e.</p>
                  <button onclick="location.reload()" style="padding:12px 30px;background:var(--primary, #007bff);color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:bold;">ðŸ”„ Reconnecter</button>
              </div>
          `;
          document.body.appendChild(overlay);
      },
      
      // Notifier les autres onglets d'une modification
      notifyDataUpdate: () => {
          SessionManager.broadcast('DATA_UPDATED', { 
              projectId: state.currentProjectId 
          });
      },
      
      // DÃ©connexion globale (tous les onglets)
      logoutAll: () => {
          SessionManager.broadcast('LOGOUT', {});
          Auth.logout();
      },
      
      cleanup: () => {
          if(SessionManager.channel) {
              SessionManager.channel.close();
          }
          if(SessionManager.heartbeatInterval) {
              clearInterval(SessionManager.heartbeatInterval);
          }
      }
  };

  const Auth = {
      init: async () => { 
          try {
              const theme = localStorage.getItem(CONFIG.themeKey); 
              if(theme !== 'light') document.body.classList.add('dark-mode');
              // Initialiser le design
              const savedDesign = localStorage.getItem('fmp_design');
              if(savedDesign && savedDesign !== 'classic') document.body.classList.add('design-' + savedDesign);
              setTimeout(() => { const sel = document.getElementById('design-selector'); if(sel && savedDesign) sel.value = savedDesign; }, 100);
          } catch(e) { /* Navigation privÃ©e - localStorage indisponible */ } 
          // Initialiser le gestionnaire de session
          SessionManager.init();
          
          // Fix file:// : limiter les refresh tokens pour Ã©viter les boucles
          if(window.location.protocol === 'file:') {
              supabase.auth.startAutoRefresh = () => {};
              console.log('ðŸ“ Mode fichier local dÃ©tectÃ© - auto-refresh dÃ©sactivÃ©');
          }
          
          // ðŸŽ¬ SECRET: Triple-clic sur l'indicateur sync (â˜ï¸) pour tester le loader !
          let moteurClicks = 0;
          let moteurClickTimer = null;
          document.addEventListener('click', (e) => {
              const syncIndicator = e.target.closest('#sync-indicator');
              const roleBadge = e.target.closest('#role-badge');
              if(syncIndicator || roleBadge) {
                  moteurClicks++;
                  if(moteurClicks === 3) {
                      moteurClicks = 0;
                      clearTimeout(moteurClickTimer);
                      // Afficher le loader pendant 8 secondes en dÃ©mo
                      LoadingScreen.show("ðŸŽ¬ Mode dÃ©mo loader !");
                      setTimeout(() => LoadingScreen.hide(), 8000);
                      console.log('ðŸŽ¬ Easter egg: Loader de test activÃ© !');
                  } else {
                      clearTimeout(moteurClickTimer);
                      moteurClickTimer = setTimeout(() => { moteurClicks = 0; }, 500);
                  }
              }
          });
          
		  // Attendre que Supabase soit initialisÃ©
          if(!supabase || !supabase.auth) {
              console.log('â³ Attente initialisation Supabase...');
              await initSupabase();
              if(!supabase || !supabase.auth) supabase = window.supabaseInitialized;
              console.log('Supabase client:', supabase?.auth ? 'âœ… OK' : 'âŒ FAIL');
          }
		  
		  
          // Ã‰couter les changements d'authentification Supabase
          supabase.auth.onAuthStateChange(async (event, session) => { 
              if (session && session.user) { 
                  state.currentUser = session.user;
                  
                  // Logger la connexion (seulement sur SIGNED_IN, pas les refresh)
                  if (event === 'SIGNED_IN') {
                      try {
                          await supabase.from('user_logins').insert({ user_email: session.user.email.toLowerCase() });
                      } catch(e) { console.log('Login log error:', e); }
                  }
                  state.currentUser.email = session.user.email.toLowerCase();
                  state.currentUser.uid = session.user.id;
                  state.currentUser.emailVerified = session.user.email_confirmed_at !== null;
                  // Ne pas rediriger si dÃ©jÃ  dans un projet ou sur le dashboard
                  if(els.appView.style.display === 'flex' || els.dashboardView.style.display === 'flex') {
                      return;
                  }
                  // VÃ©rifier la session unique
                  const sessionOk = await SessionManager.startSessionCheck(session.user.id);
                  if(sessionOk) {
                      Auth.showDashboard(); 
                  }
              } 
              else { 
                  // En file://, ignorer les events de refresh Ã©chouÃ©s si dÃ©jÃ  connectÃ©
                  if(window.location.protocol === 'file:' && (els.dashboardView.style.display === 'flex' || els.appView.style.display === 'flex')) {
                      console.log('ðŸ“ Event auth ignorÃ© (dÃ©jÃ  connectÃ© en mode local)');
                      return;
                  }
                  state.currentUser = null; 
                  SessionManager.cleanup();
                  Auth.showAuth(); 
              } 
          });
          
          // Charger le message prÃ©-alpha depuis la config
          Admin.loadPrealphaConfig();
          
          // VÃ©rifier s'il y a dÃ©jÃ  une session active
          const { data: { session } } = await supabase.auth.getSession();
          if (session && session.user) {
              state.currentUser = session.user;
              state.currentUser.email = session.user.email.toLowerCase();
              state.currentUser.uid = session.user.id;
              state.currentUser.emailVerified = session.user.email_confirmed_at !== null;
              Auth.showDashboard();
          } else {
              Auth.showAuth();
          }
      },
      showAuth: () => { Landing.show(); els.dashboardView.style.display = 'none'; els.appView.style.display = 'none'; if(Notifications._channel) { try { supabase.removeChannel(Notifications._channel); } catch(e) {} Notifications._channel = null; } },
showDashboard: async () => { 
    els.authView.style.display = 'none'; 
    // Charger le profil utilisateur depuis Supabase
    try {
        const { data, error } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('email', state.currentUser.email.toLowerCase())
            .single();
        
        if (data) {
            state.userProfile = data;
            state.userProfile.accountType = data.profile_type || 'producer';
        } else {
            state.userProfile = { accountType: 'producer' };
        }
    } catch(e) {
        state.userProfile = { accountType: 'producer' };
    }
    // S1: Charger les prÃ©fÃ©rences synchronisÃ©es
    await PreferencesSync.load();
    // Raccourcis clavier globaux pour le mode Focus
    if(!state.focusKeyListenerAttached) { state.focusKeyListenerAttached = true;
    document.addEventListener('keydown', (e) => {
        // F11 = Toggle Focus Mode
        if(e.key === 'F11') {
            e.preventDefault();
            FocusMode.toggle();
            return;
        }
        
        // En mode Focus uniquement
        if(FocusMode.isActive) {
            if(e.key === 'Escape') {
                FocusMode.exit();
            } else if(e.key === 'ArrowLeft' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                // Ne pas interfÃ©rer si on est dans un input/textarea
                if(!['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) && !document.activeElement.isContentEditable) {
                    e.preventDefault();
                    FocusMode.prevTab();
                }
            } else if(e.key === 'ArrowRight' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                if(!['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) && !document.activeElement.isContentEditable) {
                    e.preventDefault();
                    FocusMode.nextTab();
                }
            }
        }
    });
    } // fin guard focusKeyListenerAttached

    // V84: VÃ©rifier les invitations en attente
    Invitations.checkPendingInvitations();
    // V1.4.2: Initialiser les notifications
    Notifications.init();
    // V2.1.2: Initialiser module Admin
    Admin.init();
    
    // VÃ©rifier si l'utilisateur a acceptÃ© les conditions
    const termsAccepted = await Terms.check();
    if(!termsAccepted) {
        Terms.show();
        return; // Bloquer l'accÃ¨s au dashboard
    }
    
    UI.showDashboard(); 
},
      toggleMode: (mode) => { 
          document.querySelectorAll('.auth-error, .auth-success').forEach(e => e.style.display='none');
          if(mode === 'signup') { els.loginForm.style.display = 'none'; els.signupForm.style.display = 'block'; els.forgotForm.style.display = 'none'; } 
          else if(mode === 'login') { els.loginForm.style.display = 'block'; els.signupForm.style.display = 'none'; els.forgotForm.style.display = 'none'; }
      },
      toggleForgot: () => {
          document.querySelectorAll('.auth-error, .auth-success').forEach(e => e.style.display='none');
          els.loginForm.style.display = 'none'; els.signupForm.style.display = 'none'; els.forgotForm.style.display = 'block';
      },
      login: async () => { 
          const email = els.loginEmail.value.trim(); const pass = els.loginPass.value.trim(); 
          if(!email || !pass) return;
          const btn = els.loginForm.querySelector('button[type="submit"]');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner"></span>Connexion...';
          btn.classList.add('btn-loading');
          els.loginError.style.display = 'none';
          
          const { data, error } = await supabase.auth.signInWithPassword({
              email: email,
              password: pass
          });
          
          if (error) {
              let message = error.message;
              if (message.includes('Invalid login')) message = "Email ou mot de passe incorrect.";
              if (message.includes('Email not confirmed')) message = "Veuillez valider votre email avant de vous connecter.";
              els.loginError.innerText = message;
              els.loginError.style.display = 'block';
              btn.innerHTML = originalText;
              btn.classList.remove('btn-loading');
          } else if (data.user && !data.user.email_confirmed_at) {
              await supabase.auth.signOut();
              els.loginError.innerText = "Veuillez valider votre email avant de vous connecter.";
              els.loginError.style.display = 'block';
              btn.innerHTML = originalText;
              btn.classList.remove('btn-loading');
          } else if (data.user) {
              // Login rÃ©ussi - cacher immÃ©diatement l'Ã©cran d'auth
              els.authView.style.display = 'none';
              btn.innerHTML = originalText;
              btn.classList.remove('btn-loading');
          }
      },
      signup: async () => { 
          const email = els.signupEmail.value.trim(); const pass = els.signupPass.value.trim(); const confirm = els.signupConfirm.value.trim(); 
          const accountType = 'new'; // Pas de type par dÃ©faut, l'utilisateur crÃ©era ses profils ensuite
          if(!email || !pass) return; 
          if(pass !== confirm) { els.signupError.innerText = "Mots de passe non identiques"; els.signupError.style.display = 'block'; return; }
          
          // ========== VÃ‰RIFICATION LISTE BLANCHE PRÃ‰-ALPHA ==========
          if(CONFIG.preAlpha.enabled) {
              const emailLower = email.toLowerCase();
              if(!CONFIG.preAlpha.whitelist.includes(emailLower)) {
                  els.signupError.innerHTML = "ðŸ”’ <strong>AccÃ¨s PrÃ©-Alpha RÃ©servÃ©</strong><br><br>Moteur est actuellement en phase de test privÃ©e.<br><br>Seuls les testeurs invitÃ©s peuvent crÃ©er un compte pour le moment.<br><br>Contactez l'Ã©quipe Moteur si vous souhaitez participer Ã  la prÃ©-alpha !";
                  els.signupError.style.display = 'block';
                  return;
              }
          }
          
          // ========== VÃ‰RIFICATION LIMITE UTILISATEURS PRÃ‰-ALPHA ==========
          if(CONFIG.preAlpha.maxUsers) {
              try {
                  const { count, error } = await supabase.from('user_profiles').select('*', { count: 'exact', head: true });
                  if(!error && count >= CONFIG.preAlpha.maxUsers) {
                      els.signupError.innerHTML = "ðŸš« <strong>Limite atteinte</strong><br><br>La prÃ©-alpha de Moteur a atteint sa limite de " + CONFIG.preAlpha.maxUsers + " utilisateurs.<br><br>Les inscriptions reprendront bientÃ´t. Merci de votre patience !";
                      els.signupError.style.display = 'block';
                      return;
                  }
              } catch(e) {
                  console.error('Erreur vÃ©rification limite:', e);
              }
          }
          
          const btn = els.signupForm.querySelector('button[type="submit"]');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner"></span>CrÃ©ation...';
          btn.classList.add('btn-loading');
          els.signupError.style.display = 'none';
          
          const { data, error } = await supabase.auth.signUp({
              email: email,
              password: pass
          });
          
          if (error) {
              let message = error.message;
              if (message.includes('already registered')) message = "Cet email est dÃ©jÃ  utilisÃ©.";
              els.signupError.innerText = message;
              els.signupError.style.display = 'block';
              btn.innerHTML = originalText;
              btn.classList.remove('btn-loading');
              return;
          }
          
          // CrÃ©er le profil utilisateur dans la table user_profiles
          const { error: profileError } = await supabase.from('user_profiles').insert({
              email: email.toLowerCase(),
              name: '',
              profile_type: accountType,
              created_at: new Date().toISOString(),
              is_public: false
          });
          
          if (profileError) {
              console.error('Erreur crÃ©ation profil:', profileError);
          }
          
          btn.innerHTML = originalText;
          btn.classList.remove('btn-loading');
          Auth.toggleMode('login');
          els.loginSuccess.innerText = "ðŸŽ‰ Bienvenue dans la prÃ©-alpha ! Un lien de validation a Ã©tÃ© envoyÃ© Ã  " + email;
          els.loginSuccess.style.display = 'block';
          await supabase.auth.signOut();
      },
      resetPassword: async () => {
          const email = els.forgotEmail.value.trim();
          if(!email) { els.forgotError.innerText = "Veuillez entrer votre email."; els.forgotError.style.display = 'block'; return; }
          
          const { error } = await supabase.auth.resetPasswordForEmail(email, {
              redirectTo: window.location.origin
          });
          
          if (error) {
              els.forgotError.innerText = error.message;
              els.forgotError.style.display = 'block';
              els.forgotSuccess.style.display = 'none';
          } else {
              els.forgotSuccess.style.display = 'block';
              els.forgotError.style.display = 'none';
          }
      },
      logout: async () => { 
          await supabase.auth.signOut();
          location.reload();
      }
  };
  
  // ========== PRICING ==========
  // Gestion des plans et limites d'utilisation
  // ========== PRICING - ModÃ¨le Ã  l'usage ==========
  const Pricing = {
      // Configuration
      config: {
          trialDurationHours: 48,
          trialGraceDays: 7,
          readOnlyGraceDays: 30
      },
      
      // VÃ©rifier si l'utilisateur a un abonnement actif
      hasActiveSubscription: () => {
          const sub = state.userProfile?.subscription;
          if(!sub || !sub.active) return false;
          if(sub.expiresAt && new Date(sub.expiresAt) < new Date()) return false;
          return true;
      },
      
      // VÃ©rifier si l'utilisateur est en pÃ©riode d'essai
      isInTrial: () => {
          const trial = state.userProfile?.trial;
          if(!trial || !trial.startedAt) return false;
          const trialEnd = new Date(trial.startedAt);
          trialEnd.setHours(trialEnd.getHours() + Pricing.config.trialDurationHours);
          return new Date() < trialEnd;
      },
      
      // VÃ©rifier si l'essai a Ã©tÃ© utilisÃ©
      hasUsedTrial: () => {
          return state.userProfile?.trial?.used === true;
      },
      
      // Temps restant de l'essai (en ms)
      getTrialTimeRemaining: () => {
          const trial = state.userProfile?.trial;
          if(!trial || !trial.startedAt) return 0;
          const trialEnd = new Date(trial.startedAt);
          trialEnd.setHours(trialEnd.getHours() + Pricing.config.trialDurationHours);
          return Math.max(0, trialEnd - new Date());
      },
      
      // Formater le temps restant
      formatTimeRemaining: (ms) => {
          if(ms <= 0) return 'ExpirÃ©';
          const hours = Math.floor(ms / (1000 * 60 * 60));
          const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
          if(hours > 0) return `${hours}h ${minutes}min`;
          return `${minutes} minutes`;
      },
      
      // Compter les collaborateurs d'un projet
      // Un collaborateur = une fiche acteur OU technicien (pas par email unique)
      countCollaborators: (projectData) => {
          if(!projectData) return 0;
          
          // Compter les fiches acteurs avec un nom
          const actorCount = (projectData.actors || []).filter(a => a.name).length;
          
          // Compter les fiches techniciens avec un nom
          const crewCount = (projectData.crew || []).filter(c => c.name).length;
          
          return actorCount + crewCount;
      },
      
      // Calculer le prix mensuel d'un projet
      // 1-5 collaborateurs = 1â‚¬, 6-15 = 2â‚¬, puis +1â‚¬ par tranche de 10
      calculateProjectPrice: (projectData) => {
          const collaborators = Pricing.countCollaborators(projectData);
          
          let price = 0;
          let detail = '';
          
          if(collaborators === 0) {
              price = 0;
              detail = 'Aucun collaborateur';
          } else if(collaborators <= 5) {
              price = 1;
              detail = '1-5 collaborateurs';
          } else if(collaborators <= 15) {
              price = 2;
              detail = '6-15 collaborateurs';
          } else {
              // 16+ : 2â‚¬ de base + 1â‚¬ par tranche de 10 au-delÃ  de 15
              const extra = Math.ceil((collaborators - 15) / 10);
              price = 2 + extra;
              detail = `16+ collaborateurs (+${extra}â‚¬)`;
          }
          
          return {
              collaborators: collaborators,
              price: price,
              detail: detail,
              total: price
          };
      },
      
      // Calculer le prix total mensuel (tous les projets)
      calculateTotalMonthlyPrice: async () => {
          const projects = await Store.getProjectsList();
          const ownedProjects = projects.filter(p => p.role === 'owner');
          
          let totalMonthly = 0;
          const details = [];
          
          for(const project of ownedProjects) {
              const { data: projectRow } = await supabase
                  .from('projects')
                  .select('data')
                  .eq('id', project.id)
                  .single();
              const projectData = projectRow?.data;
              const price = Pricing.calculateProjectPrice(projectData);
              
              totalMonthly += price.total;
              details.push({
                  id: project.id,
                  title: project.title,
                  ...price
              });
          }
          
          return {
              projectCount: ownedProjects.length,
              totalMonthly,
              details
          };
      },
      
      // VÃ©rifier si l'utilisateur peut crÃ©er un projet
      canCreateProject: async () => {
          // Si abonnement actif, OK
          if(Pricing.hasActiveSubscription()) {
              return { allowed: true };
          }
          
          // Si en pÃ©riode d'essai, vÃ©rifier qu'il n'a pas dÃ©jÃ  un projet
          if(Pricing.isInTrial()) {
              const projects = await Store.getProjectsList();
              const ownedProjects = projects.filter(p => p.role === 'owner');
              if(ownedProjects.length >= 1) {
                  return { 
                      allowed: false, 
                      reason: 'Votre essai est limitÃ© Ã  1 projet. Souscrivez un abonnement pour crÃ©er plus de projets.',
                      showSubscribe: true
                  };
              }
              return { allowed: true, isTrial: true };
          }
          
          // Si essai non utilisÃ©, proposer l'essai
          if(!Pricing.hasUsedTrial()) {
              return { 
                  allowed: false, 
                  reason: 'trial_available',
                  showTrialOffer: true
              };
          }
          
          // Essai expirÃ©, pas d'abonnement
          return { 
              allowed: false, 
              reason: 'Votre pÃ©riode d\'essai est terminÃ©e. Souscrivez un abonnement pour continuer.',
              showSubscribe: true
          };
      },
      
      // DÃ©marrer l'essai gratuit
      startTrial: async () => {
          if(Pricing.hasUsedTrial()) {
              Utils.toast('Vous avez dÃ©jÃ  utilisÃ© votre essai gratuit', 'error');
              return false;
          }
          
          const myEmail = state.currentUser.email.toLowerCase();
          
          // Mettre Ã  jour le profil avec les infos d'essai
          const { error } = await supabase
              .from('user_profiles')
              .update({
                  trial_used: true,
                  trial_started_at: new Date().toISOString()
              })
              .eq('email', myEmail);
          
          if (error) {
              console.error('Erreur activation essai:', error);
              return false;
          }
          
          // Recharger le profil
          const { data: profile } = await supabase
              .from('user_profiles')
              .select('*')
              .eq('email', myEmail)
              .single();
          
          state.userProfile = profile;
          
          Utils.toast('ðŸŽ¬ Essai gratuit activÃ© ! Vous avez 48h pour tester.', 'success');
          return true;
      },
      
      // Afficher la modale d'offre d'essai
      showTrialOfferModal: () => {
          const modal = document.createElement('div');
          modal.id = 'trial-offer-modal';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:16px; padding:30px; max-width:500px; width:100%; text-align:center;">
                  <div style="font-size:4rem; margin-bottom:15px;">ðŸŽ¬</div>
                  <h2 class="mb-15-m0">CrÃ©ez votre premier projet !</h2>
                  <p style="color:var(--text-sec); margin-bottom:25px;">
                      Testez Moteur gratuitement pendant <strong>48 heures</strong> avec toutes les fonctionnalitÃ©s.
                  </p>
                  <div style="background:var(--bg); border-radius:12px; padding:20px; margin-bottom:25px; text-align:left;">
                      <div class="flex-center-mb10">
                          <span class="fs-15">âœ…</span>
                          <span>1 projet complet</span>
                      </div>
                      <div class="flex-center-mb10">
                          <span class="fs-15">âœ…</span>
                          <span>Toutes les fonctionnalitÃ©s</span>
                      </div>
                      <div class="flex-center-mb10">
                          <span class="fs-15">âœ…</span>
                          <span>Aucune carte bancaire requise</span>
                      </div>
                      <div class="flex-row-gap10">
                          <span class="fs-15">â±ï¸</span>
                          <span>48h puis 30 jours en lecture seule</span>
                      </div>
                  </div>
                  <div style="display:flex; gap:10px; justify-content:center;">
                      <button onclick="document.getElementById('trial-offer-modal').remove()" style="padding:12px 25px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:8px; cursor:pointer;">
                          Plus tard
                      </button>
                      <button onclick="app.Pricing.acceptTrialOffer()" style="padding:12px 25px; background:var(--success); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                          ðŸš€ Commencer l'essai
                      </button>
                  </div>
                  <p style="margin-top:20px; font-size:0.85rem; color:var(--text-sec);">
                      Ensuite : Ã  partir de <strong>1â‚¬/mois</strong> par projet
                  </p>
                  <div style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; text-align:left; font-size:0.8rem; color:var(--text-sec);">
                      <strong>ðŸ“‹ ModalitÃ©s :</strong><br>
                      â€¢ 1 essai de 48h par adresse email<br>
                      â€¢ AprÃ¨s l'essai : 30 jours en lecture seule<br>
                      â€¢ Sans abonnement : projet supprimÃ© aprÃ¨s 30 jours<br>
                      â€¢ Vos profils publics restent toujours accessibles
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
      },
      
      // Accepter l'offre d'essai et crÃ©er le projet
      acceptTrialOffer: async () => {
          document.getElementById('trial-offer-modal')?.remove();
          const started = await Pricing.startTrial();
          if(started) {
              Store.showOwnerRoleModal();
          }
      },
      
      // Afficher la modale d'abonnement
      showSubscribeModal: (reason) => {
          const modal = document.createElement('div');
          modal.id = 'subscribe-modal';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:16px; padding:30px; max-width:600px; width:100%;">
                  <div class="section-header-20">
                      <h2 class="m-0">ðŸ’³ Abonnement Moteur</h2>
                      <button onclick="document.getElementById('subscribe-modal').remove()" class="icon-btn">âœ•</button>
                  </div>
                  
                  ${reason ? `<div style="background:#FFF3E0; border:1px solid #FF9800; border-radius:8px; padding:15px; margin-bottom:20px; color:#E65100;">
                      <strong>âš ï¸ ${reason}</strong>
                  </div>` : ''}
                  
                  <p style="color:var(--text-sec); margin-bottom:25px;">
                      Un tarif simple et transparent, adaptÃ© Ã  vos besoins.
                  </p>
                  
                  <div style="background:var(--bg); border-radius:12px; padding:20px; margin-bottom:25px;">
                      <h4 class="mb-15-m0">ðŸ’° Tarification par projet</h4>
                      <div style="color:var(--text-sec); font-size:0.9rem;">
                          <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);">
                              <span>1-5 collaborateurs</span>
                              <strong>1â‚¬/mois</strong>
                          </div>
                          <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);">
                              <span>6-15 collaborateurs</span>
                              <strong>2â‚¬/mois</strong>
                          </div>
                          <div style="display:flex; justify-content:space-between; padding:8px 0;">
                              <span>+10 collaborateurs</span>
                              <strong>+1â‚¬/mois</strong>
                          </div>
                      </div>
                      <p style="margin:15px 0 0; font-size:0.8rem; color:var(--text-sec);">
                          ðŸ’¡ 1 collaborateur = 1 fiche comÃ©dien ou technicien
                      </p>
                  </div>
                  
                  <div style="display:flex; gap:10px; justify-content:center;">
                      <button onclick="app.Pricing.subscribe('monthly')" style="flex:1; padding:15px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                          ðŸ’³ S'abonner
                      </button>
                  </div>
                  
                  <p style="text-align:center; margin-top:15px; font-size:0.8rem; color:var(--text-sec);">
                      ðŸ’³ Paiement sÃ©curisÃ© par Stripe â€¢ Annulation Ã  tout moment
                  </p>
                  
                  <div style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; font-size:0.8rem; color:var(--text-sec);">
                      <strong>ðŸ“‹ ModalitÃ©s :</strong><br>
                      â€¢ RÃ©siliation possible Ã  tout moment<br>
                      â€¢ Sans renouvellement : 30 jours en lecture seule pour tÃ©lÃ©charger<br>
                      â€¢ Projet supprimÃ© aprÃ¨s 30 jours sans abonnement<br>
                      â€¢ Vos profils publics restent toujours accessibles
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
      },
      
      // Souscrire (prÃ©paration Stripe)
      subscribe: async () => {
          // TODO: IntÃ©grer Stripe Checkout
          Utils.toast('ðŸš§ Paiement Stripe bientÃ´t disponible', 'info');
          document.getElementById('subscribe-modal')?.remove();
      },
      
      // Afficher la banniÃ¨re d'essai dans le dashboard
      getTrialBanner: () => {
          if(!Pricing.isInTrial()) return '';
          
          const remaining = Pricing.getTrialTimeRemaining();
          const formattedTime = Pricing.formatTimeRemaining(remaining);
          const isUrgent = remaining < 6 * 60 * 60 * 1000; // < 6h
          
          return `
              <div style="background:${isUrgent ? 'linear-gradient(135deg, #ff6b6b, #ee5a24)' : 'linear-gradient(135deg, #667eea, #764ba2)'}; border-radius:12px; padding:15px 20px; margin-bottom:20px; color:white; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                  <div>
                      <strong>â±ï¸ PÃ©riode d'essai</strong> - Il vous reste <strong>${formattedTime}</strong>
                  </div>
                  <button onclick="app.Pricing.showSubscribeModal()" style="padding:8px 20px; background:white; color:${isUrgent ? '#ee5a24' : '#667eea'}; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">
                      ðŸ’³ S'abonner maintenant
                  </button>
              </div>
          `;
      },
      
      // Afficher le rÃ©sumÃ© de facturation dans le dashboard
      getBillingWidget: async () => {
          if(!Pricing.hasActiveSubscription() && !Pricing.isInTrial()) {
              return '';
          }
          
          const billing = await Pricing.calculateTotalMonthlyPrice();
          
          if(billing.projectCount === 0) {
              return '';
          }
          
          return `
              <div style="background:var(--bg); border-radius:12px; padding:20px; margin-bottom:20px;">
                  <h4 style="margin:0 0 15px; display:flex; align-items:center; gap:10px;">
                      ðŸ’° Votre abonnement
                      <span style="font-size:0.8rem; color:var(--text-sec); font-weight:normal;">(estimation)</span>
                  </h4>
                  <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border);">
                      <span>${billing.projectCount} projet${billing.projectCount > 1 ? 's' : ''}</span>
                      <span>${billing.totalMonthly}â‚¬/mois</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; font-weight:bold; font-size:1.1rem;">
                      <span>Total</span>
                      <span class="text-primary">${billing.totalMonthly}â‚¬/mois</span>
                  </div>
                  <button onclick="app.Pricing.showBillingDetails()" style="width:100%; padding:10px; background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); border-radius:6px; cursor:pointer; font-size:0.9rem;">
                      ðŸ“Š Voir le dÃ©tail
                  </button>
              </div>
          `;
      },
      
      // Afficher le dÃ©tail de facturation
      showBillingDetails: async () => {
          const billing = await Pricing.calculateTotalMonthlyPrice();
          
          let detailsHtml = billing.details.map(p => `
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--bg); border-radius:8px; margin-bottom:8px;">
                  <div>
                      <strong>${Utils.escape(p.title)}</strong>
                      <div class="text-sec-sm2">${p.collaborators} collaborateur${p.collaborators > 1 ? 's' : ''} â€¢ ${p.detail}</div>
                  </div>
                  <div style="text-align:right; font-weight:bold;">
                      ${p.price}â‚¬/mois
                  </div>
              </div>
          `).join('');
          
          const modal = document.createElement('div');
          modal.id = 'billing-details-modal';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:16px; padding:30px; max-width:500px; width:100%; max-height:80vh; overflow-y:auto;">
                  <div class="section-header-20">
                      <h2 class="m-0">ðŸ“Š DÃ©tail de facturation</h2>
                      <button onclick="document.getElementById('billing-details-modal').remove()" class="icon-btn">âœ•</button>
                  </div>
                  
                  <div style="background:var(--bg); border-radius:8px; padding:15px; margin-bottom:20px; font-size:0.85rem; color:var(--text-sec);">
                      <strong>Tarification :</strong><br>
                      â€¢ 1-5 collaborateurs = 1â‚¬/mois<br>
                      â€¢ 6-15 collaborateurs = 2â‚¬/mois<br>
                      â€¢ +1â‚¬ par tranche de 10 au-delÃ 
                  </div>
                  
                  <div class="mb-20">
                      ${detailsHtml}
                  </div>
                  
                  <div style="background:var(--primary); color:white; border-radius:12px; padding:20px; text-align:center;">
                      <div style="font-size:0.9rem; opacity:0.9;">Total mensuel</div>
                      <div style="font-size:2.5rem; font-weight:bold;">${billing.totalMonthly}â‚¬</div>
                  </div>
                  
                  <p style="text-align:center; margin-top:15px; font-size:0.8rem; color:var(--text-sec);">
                      ðŸ’¡ Un collaborateur = une fiche comÃ©dien ou technicien dans le projet.
                  </p>
              </div>
          `;
          document.body.appendChild(modal);
      }
  };
  
  const Store = {
      // V62: Initialisation du tableau snapshots
      getEmpty: () => ({ title: "Nouveau Film", filmId: 'film_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11), synopsis: "", synopsisShort: "", synopsisLong: "", scriptMeta: { author: "", coAuthor: "", contact: "", copyright: "", draft: "Premier jet", draftDate: "", source: "", notes: "" }, snapshots: [], scenes: [], characters: [], actors: [], locations: [], resources: [], crew: [], shootingDays: [], tags: CONFIG.defaultTags, groups: [...CONFIG.defaultGroups, ...CONFIG.crewGroups], shots: [], counter: 1, uiConfig: { tabColors: {}, categoryColors: {}, subColors: {}, tabsOrder: [], categoriesOrder: [], hiddenTabs: [] }, budget: { total: 0, currency: 'â‚¬', manager: '', managerEmailNotif: true, envelopes: {}, deptManagers: {} }, expenses: [], presentation: { title: '', genre: '', format: '', duration: '', productionType: '', description: '', team: [], associations: [], enterprises: [], needsCrew: {}, needsActors: [], image: '' }, memberPermissions: {}, chatChannels: [], chatExtraMembers: [], workplanOverrides: {}, scriptReports: {} }),
      getProjectsList: async () => { 
          if(!state.currentUser) return []; 
          const myEmail = state.currentUser.email.toLowerCase();
          
          // RÃ©cupÃ©rer les projets dont je suis membre
          const { data: memberships, error: memberError } = await supabase
              .from('project_members')
              .select('project_id, role')
              .eq('email', myEmail);
          
          if (memberError || !memberships || memberships.length === 0) {
              // VÃ©rifier aussi les projets dont je suis owner
              const { data: ownedProjects, error: ownedError } = await supabase
                  .from('projects')
                  .select('id, title, created_at, owner_email')
                  .eq('owner_email', myEmail);
              
              if (ownedError || !ownedProjects) return [];
              return ownedProjects.map(p => ({ id: p.id, title: p.title, date: new Date(p.created_at).toLocaleDateString(), owner: p.owner_email, role: 'owner' }));
          }
          
          const projectIds = memberships.map(m => m.project_id);
          const { data: projects, error: projError } = await supabase
              .from('projects')
              .select('id, title, created_at, owner_email')
              .in('id', projectIds);
          
          if (projError || !projects) return [];
          
          return projects.map(p => {
              const membership = memberships.find(m => m.project_id === p.id);
              return { id: p.id, title: p.title, date: new Date(p.created_at).toLocaleDateString(), owner: p.owner_email, role: membership?.role || 'member' };
          });
      },
      createNewProject: async () => { 
          if(!state.currentUser) return; 
          Store.showOwnerRoleModal(); 
      },
      doCreateProject: async (selectedProfiles) => {
          const myEmail = state.currentUser.email.toLowerCase();
          const empty = Store.getEmpty();
          
          const ownerName = state.userProfile?.displayName || state.userProfile?.name || myEmail.split('@')[0];
          const ownerRoles = []; // Pour les badges sur l'avatar
          
          // Ajouter chaque profil sÃ©lectionnÃ© dans la bonne section
          selectedProfiles.forEach((profile, idx) => {
              if(profile.type === 'actor') {
                  const actorEntry = {
                      id: 'actor_owner_' + Date.now() + '_' + idx,
                      name: profile.data.name || ownerName,
                      email: myEmail,
                      photo: profile.data.photo || '',
                      phone: profile.data.phone || '',
                      gender: profile.data.gender || '',
                      age: profile.data.age || '',
                      height: profile.data.height || '',
                      city: profile.data.city || '',
                      languages: profile.data.languages || '',
                      skills: profile.data.skills || '',
                      experience: profile.data.experience || '',
                      notes: profile.data.notes || '',
                      isOwner: true,
                      publicProfileId: profile.data.id || myEmail,
                      claimedAt: new Date().toISOString(),
                      claimedBy: myEmail,
                      createdAt: new Date().toISOString()
                  };
                  empty.actors.push(actorEntry);
                  ownerRoles.push({ icon: profile.icon, name: profile.name });
              } else if(profile.type === 'crew') {
                  const crewEntry = {
                      id: 'crew_owner_' + Date.now() + '_' + idx,
                      name: profile.data.name || ownerName,
                      email: myEmail,
                      role: profile.data.role || profile.name,
                      photo: profile.data.photo || '',
                      phone: profile.data.phone || '',
                      department: profile.data.department || '',
                      rate: profile.data.rate || '',
                      notes: profile.data.notes || '',
                      isOwner: true,
                      publicProfileId: profile.data.id || myEmail,
                      claimedAt: new Date().toISOString(),
                      claimedBy: myEmail,
                      createdAt: new Date().toISOString()
                  };
                  empty.crew.push(crewEntry);
                  ownerRoles.push({ icon: profile.icon, name: profile.name });
              }
          });
          
          if(selectedProfiles.length === 0) {
              empty.crew.push({
                  id: 'crew_owner_' + Date.now(),
                  name: ownerName,
                  email: myEmail,
                  role: 'Porteur de projet',
                  phone: state.userProfile?.phone || '',
                  photo: state.userProfile?.photo || '',
                  isOwner: true,
                  ownerRoles: [],
                  createdAt: new Date().toISOString()
              });
          } else {
              const firstCrew = empty.crew.find(c => c.isOwner);
              if(firstCrew) {
                  firstCrew.ownerRoles = ownerRoles;
              }
          }
          
          // CrÃ©er le projet dans Supabase
          const { data: newProject, error } = await supabase
              .from('projects')
              .insert({
                  owner_email: myEmail,
                  title: empty.title,
                  description: '',
                  type: 'film',
                  status: 'draft',
                  data: empty
              })
              .select()
              .single();
          
          if (error) {
              console.error('Erreur crÃ©ation projet:', error);
              alert('Erreur lors de la crÃ©ation du projet');
              return;
          }
          
          // Ajouter le propriÃ©taire comme membre
          const {error: memErr} = await supabase.from('project_members').insert({
              project_id: newProject.id,
              email: myEmail,
              role: 'owner'
          });
          if(memErr) { console.error('Erreur ajout membre:', memErr); Toast.show('Erreur ajout membre', 'error'); }
          
          Store.loadProject(newProject.id);
          History.log('ADD', 'CrÃ©ation du projet');
      },
      showOwnerRoleModal: async () => {
          // RÃ©cupÃ©rer les vrais profils du porteur depuis Supabase
          const myEmail = state.currentUser.email.toLowerCase();
          
          let userProfiles = [];
          try {
              // Charger le profil utilisateur depuis Supabase
              const { data: userData, error } = await supabase
                  .from('user_profiles')
                  .select('*')
                  .eq('email', myEmail)
                  .single();
              
              if (userData) {
                  state.userProfile = userData;
                  
                  // Les profils sont stockÃ©s dans acting_styles et technical_skills
                  if (userData.profile_type === 'actor' || (userData.acting_styles && userData.acting_styles.length > 0)) {
                      userProfiles.push({
                          type: 'actor',
                          icon: 'ðŸŽ­',
                          name: userData.name || 'ComÃ©dienÂ·ne',
                          data: { ...userData, email: myEmail }
                      });
                  }
                  if (userData.profile_type === 'crew' || (userData.technical_skills && userData.technical_skills.length > 0)) {
                      userProfiles.push({
                          type: 'crew',
                          icon: 'ðŸŽ¬',
                          name: userData.name || 'Technicien',
                          data: { ...userData, email: myEmail }
                      });
                  }
              }
          } catch(e) {
              console.log('Erreur chargement profils:', e);
          }
          
          const modal = document.createElement('div');
          modal.id = 'owner-role-modal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
          
          let contentHtml = '';
          if(userProfiles.length === 0) {
              // Pas de profil crÃ©Ã©
              contentHtml = `
                  <p class="text-sec-mb20">Vous n'avez pas encore crÃ©Ã© de profil mÃ©tier.</p>
                  <p style="color:var(--text-sec); margin-bottom:20px; font-size:0.9rem;">Le projet sera crÃ©Ã© et vous pourrez ajouter vos rÃ´les plus tard via "Mon Profil".</p>
              `;
          } else {
              contentHtml = `
                  <p style="color:var(--text-sec); margin-bottom:15px; font-size:0.9rem;">SÃ©lectionnez le(s) profil(s) que vous utiliserez sur ce projet :</p>
                  <div style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto; padding:5px;">
              `;
              userProfiles.forEach((p, idx) => {
                  contentHtml += `
                      <label style="display:flex; align-items:center; gap:12px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid var(--border); background:var(--bg); transition: all 0.2s;">
                          <input type="checkbox" class="owner-profile-checkbox" data-index="${idx}" style="width:18px; height:18px;">
                          <span class="fs-15">${p.icon}</span>
                          <div>
                              <div class="fw-600">${Utils.escape(p.name)}</div>
                              <div style="font-size:0.8rem; color:var(--text-sec);">${p.type === 'actor' ? 'Fiche comÃ©dien' : 'Fiche Ã©quipe technique'}</div>
                          </div>
                      </label>
                  `;
              });
              contentHtml += '</div>';
          }
          
          modal.innerHTML = `
              <div class="modal-panel-450">
                  <h3 style="margin:0 0 15px; color:var(--text-main);">ðŸŽ¬ Nouveau Projet</h3>
                  <p class="mb-10">Vous serez <strong class="text-primary">ðŸ‘‘ PropriÃ©taire</strong> de ce projet.</p>
                  
                  ${contentHtml}
                  
                  <div class="flex-end-mt20">
                      <button onclick="document.getElementById('owner-role-modal').remove()" class="btn-outline">Annuler</button>
                      <button onclick="app.Store.confirmOwnerRole()" class="btn-success-compact">âœ“ CrÃ©er le projet</button>
                  </div>
              </div>
          `;
          
          document.body.appendChild(modal);
          
          // Stocker les profils pour confirmOwnerRole
          modal.userProfiles = userProfiles;
          
          // Style visuel pour les sÃ©lectionnÃ©s
          modal.querySelectorAll('.owner-profile-checkbox').forEach(cb => {
              cb.addEventListener('change', () => {
                  cb.closest('label').style.background = cb.checked ? 'rgba(43, 110, 246, 0.1)' : 'var(--bg)';
                  cb.closest('label').style.borderColor = cb.checked ? 'var(--primary)' : 'var(--border)';
              });
          });
      },
      confirmOwnerRole: () => {
          const modal = document.getElementById('owner-role-modal');
          const userProfiles = modal.userProfiles || [];
          const checked = modal.querySelectorAll('.owner-profile-checkbox:checked');
          
          const selectedProfiles = [];
          checked.forEach(cb => {
              const idx = parseInt(cb.dataset.index);
              if(userProfiles[idx]) {
                  selectedProfiles.push(userProfiles[idx]);
              }
          });
          
          modal.remove();
          Store.doCreateProject(selectedProfiles);
      },
      createNewProjectFromImport: async (importedData) => {
          if(!state.currentUser) return;
          const myEmail = state.currentUser.email.toLowerCase();
          
          if(!importedData.groups || importedData.groups.length === 0) importedData.groups = CONFIG.defaultGroups;
          if(!importedData.tags || importedData.tags.length === 0) importedData.tags = CONFIG.defaultTags;
          if(!importedData.actors) importedData.actors = [];
          if(!importedData.snapshots) importedData.snapshots = [];
          
          // CrÃ©er le projet dans Supabase
          const { data: newProject, error } = await supabase
              .from('projects')
              .insert({
                  owner_email: myEmail,
                  title: importedData.title,
                  description: '',
                  type: 'film',
                  status: 'draft',
                  data: importedData
              })
              .select()
              .single();
          
          if (error) {
              console.error('Erreur import:', error);
              Utils.toast("Erreur lors de l'importation", "error");
              return;
          }
          
          // Ajouter le propriÃ©taire comme membre
          const {error: memErr2} = await supabase.from('project_members').insert({
              project_id: newProject.id,
              email: myEmail,
              role: 'owner'
          });
          if(memErr2) { console.error('Erreur ajout membre:', memErr2); Toast.show('Erreur ajout membre', 'error'); }
          
          Utils.toast("Importation Wizard rÃ©ussie !", "success");
          Store.loadProject(newProject.id);
      },
      loadProject: async (id) => {
          if(!state.currentUser) return;
          LoadingScreen.show("Ouverture du projet...");
          try {
              const myEmail = state.currentUser.email.toLowerCase();
              
              // VÃ©rifier l'accÃ¨s au projet
              const { data: membership } = await supabase
                  .from('project_members')
                  .select('role')
                  .eq('project_id', id)
                  .eq('email', myEmail)
                  .single();
              
              // VÃ©rifier si owner
              const { data: project, error: projError } = await supabase
                  .from('projects')
                  .select('*')
                  .eq('id', id)
                  .single();
              
              if (projError || !project) throw new Error("Projet introuvable");
              
              let role = membership?.role;
              if (!role && project.owner_email === myEmail) role = 'owner';
              if (!role) throw new Error("AccÃ¨s refusÃ©.");
              state.currentRole = role;
              
              const parsed = project.data;
              if(!parsed) throw new Error("Projet vide ou introuvable");
              const safeData = { ...Store.getEmpty(), ...parsed };
              
              if(!safeData.actors) safeData.actors = [];
              if(!safeData.snapshots) safeData.snapshots = []; // V62 Security
			  if(!safeData.shots) safeData.shots = [];
			  if(!safeData.crew) safeData.crew = [];
			  if(!safeData.shootingDays) safeData.shootingDays = [];
// Ajouter les groupes crew manquants
CONFIG.crewGroups.forEach(defaultGrp => {
    if(!safeData.groups.some(g => g.id === defaultGrp.id)) {
        safeData.groups.push(defaultGrp);
    }
});
              if(!safeData.groups.some(g => g.type === 'actor')) { safeData.groups.push({id: 'ga1', name: 'Casting Principal', type: 'actor'}); safeData.groups.push({id: 'ga2', name: 'RÃ´les Secondaires', type: 'actor'}); }
              if(!safeData.tags || safeData.tags.length === 0) safeData.tags = CONFIG.defaultTags;
              ['scenes', 'characters', 'locations'].forEach(k => { if(!Array.isArray(safeData[k])) safeData[k] = []; });
              
              // GÃ©nÃ©rer un filmId si absent (anciens projets)
              if(!safeData.filmId) {
                  safeData.filmId = 'film_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);
                  console.log('FilmId gÃ©nÃ©rÃ© pour ancien projet:', safeData.filmId);
              }
              
              state.data = safeData; state.currentProjectId = id;
              LoadingScreen.setProgress(95);
              UI.launchEditor(); Store.startRealtimeListener(id); Store.initPresence(id); Store.initLocks(id);
              LoadingScreen.hide();
          } catch(e) { LoadingScreen.hide(); Utils.toast("Erreur: " + e.message, "error"); console.error(e); UI.showDashboard(); }
      },
      startRealtimeListener: (id) => {
          // Pas de realtime en mode fichier local
          if(window.location.protocol === 'file:') return;
          // Supabase Realtime - Ã©couter les changements sur le projet
          if(state.dbListener) {
              supabase.removeChannel(state.dbListener);
          }
          
          state.dbListener = supabase
              .channel('project_' + id)
              .on('postgres_changes', 
                  { event: 'UPDATE', schema: 'public', table: 'projects', filter: 'id=eq.' + id },
                  (payload) => {
                      const val = payload.new.data;
                      if(!val) return;
                      state.data = { ...state.data, ...val };
                      if(document.activeElement !== els.title) els.title.value = state.data.title;
                      Synopsis.renderTree('synopsis');
                      Synopsis.renderTree('short');
                      Synopsis.renderTree('long');
                      if(els.boardSynopsis) els.boardSynopsis.innerText = state.data.synopsis || "(Vide)";
                      if(els.boardShort) els.boardShort.innerText = state.data.synopsisShort || "(Vide)";
                      if(els.boardLong) els.boardLong.innerText = state.data.synopsisLong || "(Vide)";
                      const activeId = document.activeElement && document.activeElement.closest('.script-row') ? parseInt(document.activeElement.closest('.script-row').dataset.id) : null;
                      const activeContinuous = document.activeElement && document.activeElement.closest('.script-continuous-content');
                      if(state.currentRole !== 'viewer') { 
                          const activeTab = document.querySelector('.tab-content.active').id; 
                          if(activeTab === 'tab-board') UI.renderBoard(); 
                          if(activeTab === 'tab-script' && !activeId && !activeContinuous) UI.renderScript();
                          if(activeTab === 'tab-stats') Stats.render();
                          if(els.versionModal.style.display === 'flex') UI.renderVersionList();
                          if(activeTab === 'tab-actors') UI.renderDataTab('actors', els.actorContainer);
                      } else { UI.renderAll(); }
                  }
              )
              .subscribe();
      },
      
      loadFromSupabase: async (projectId) => {
          const { data: project } = await supabase
              .from('projects')
              .select('data')
              .eq('id', projectId)
              .single();
          if(project && project.data) {
              state.data = { ...state.data, ...project.data };
              UI.renderAll();
          }
      },
      initPresence: (id) => { 
          // Pas de presence en mode fichier local
          if(window.location.protocol === 'file:') return;
          // Supabase Realtime Presence
          const email = state.currentUser.email;
          
          if(state.presenceChannel) {
              supabase.removeChannel(state.presenceChannel);
          }
          
          state.presenceChannel = supabase.channel('presence_' + id, {
              config: { presence: { key: email } }
          });
          
          state.presenceChannel
              .on('presence', { event: 'sync' }, () => {
                  const presenceState = state.presenceChannel.presenceState();
                  els.presenceList.innerHTML = '';
                  
                  Object.keys(presenceState).forEach(key => {
                      const users = presenceState[key];
                      users.forEach(u => {
                          const userEmail = u.email || key;
                          const initials = Utils.getInitials(userEmail);
                          const bg = Utils.getColor(userEmail);
                          const wrapper = document.createElement('div');
                          wrapper.className = 'presence-avatar-wrapper';
                          const roleInfo = Store.getUserRoleInfo(userEmail);
                          const personInfo = Store.getPersonInfo(userEmail);
                          if(roleInfo.class) wrapper.classList.add(roleInfo.class);
                          const div = document.createElement('div');
                          div.className = 'presence-avatar';
                          div.style.backgroundColor = bg;
                          div.innerText = initials;
                          wrapper.appendChild(div);
                          if(roleInfo.icon) {
                              const badge = document.createElement('span');
                              badge.className = 'role-icon';
                              badge.innerText = roleInfo.icon;
                              wrapper.appendChild(badge);
                          }
                          if(roleInfo.extraRoles && roleInfo.extraRoles.length > 0) {
                              roleInfo.extraRoles.forEach((r, idx) => {
                                  const extraBadge = document.createElement('span');
                                  extraBadge.className = 'role-icon extra-role';
                                  extraBadge.style.right = (-2 + (idx + 1) * 12) + 'px';
                                  extraBadge.innerText = r.icon;
                                  wrapper.appendChild(extraBadge);
                              });
                          }
                          const tooltip = document.createElement('div');
                          tooltip.className = 'avatar-tooltip';
                          let tooltipHtml = '<div class="avatar-tooltip-name">' + Utils.escape(personInfo.name || userEmail.split('@')[0]) + '</div>';
                          if(roleInfo.text) tooltipHtml += '<div class="avatar-tooltip-role">' + Utils.escape(roleInfo.text) + '</div>';
                          if(roleInfo.extraRoles && roleInfo.extraRoles.length > 0) {
                              roleInfo.extraRoles.forEach(r => {
                                  tooltipHtml += '<div class="avatar-tooltip-role">' + r.icon + ' ' + Utils.escape(r.name) + '</div>';
                              });
                          }
                          tooltip.innerHTML = tooltipHtml;
                          wrapper.appendChild(tooltip);
                          els.presenceList.innerHTML = '';
                          els.presenceList.appendChild(wrapper);
                      });
                  });
              })
              .subscribe(async (status) => {
                  if (status === 'SUBSCRIBED') {
                      await state.presenceChannel.track({ email: email, time: Date.now() });
                  }
              });
      },
      getPersonInfo: (email) => {
          let ownerRoles = [];
          // Chercher dans l'Ã©quipe technique
          if(state.data?.crew) {
              const member = state.data.crew.find(c => c.email === email);
              if(member) {
                  if(member.ownerRoles) ownerRoles = member.ownerRoles;
                  return { name: member.name, role: member.role, ownerRoles: ownerRoles, type: 'crew', isOwner: member.isOwner };
              }
          }
          // Chercher dans les comÃ©diens
          if(state.data?.actors) {
              const actor = state.data.actors.find(a => a.email === email);
              if(actor) return { name: actor.name, role: 'ComÃ©dien(ne)', ownerRoles: [], type: 'actor', isOwner: actor.isOwner };
          }
          // Retourner l'email par dÃ©faut
          return { name: email.split('@')[0], role: '', ownerRoles: [], type: '' };
      },
      getUserRoleInfo: (email) => {
          let text = '', icon = '', roleClass = '', extraRoles = [];
          
          // Chercher les infos de la personne
          const personInfo = Store.getPersonInfo(email);
          
          // PropriÃ©taire
          const isOwner = personInfo.isOwner || (state.currentRole === 'owner' && email === state.currentUser?.email);
          if(isOwner) {
              text = 'PropriÃ©taire';
              icon = 'ðŸ‘‘';
              roleClass = 'owner';
              // Ajouter les rÃ´les supplÃ©mentaires depuis ownerRoles
              if(personInfo.ownerRoles && personInfo.ownerRoles.length > 0) {
                  extraRoles = personInfo.ownerRoles.map(r => ({ icon: r.icon, name: r.name }));
              }
              return { text, icon, class: roleClass, extraRoles };
          }
          // Responsable budget global
          if(state.data?.budget?.manager === email) {
              return { text: 'Resp. Budget', icon: 'ðŸ’°', class: 'budget-manager', extraRoles: [] };
          }
          // Responsable dÃ©partement
          const deptManagers = state.data?.budget?.deptManagers || {};
          const depts = [{id:'image',name:'Image',icon:'ðŸ“¹'},{id:'lumiere',name:'LumiÃ¨re',icon:'ðŸ’¡'},{id:'son',name:'Son',icon:'ðŸŽ¤'},{id:'realisation',name:'RÃ©alisation',icon:'ðŸŽ¬'},{id:'decoration',name:'DÃ©coration',icon:'ðŸŽ¨'},{id:'costumes',name:'Costumes',icon:'ðŸ‘—'},{id:'maquillage',name:'Maquillage',icon:'ðŸ’„'},{id:'regie',name:'RÃ©gie',icon:'ðŸŽ­'},{id:'production',name:'Production',icon:'ðŸ’¼'},{id:'transport',name:'Transport',icon:'ðŸš—'},{id:'catering',name:'Catering',icon:'ðŸ´'},{id:'postprod',name:'Post-prod',icon:'ðŸŽžï¸'},{id:'location',name:'Locations',icon:'ðŸ '},{id:'assurance',name:'Assurance',icon:'ðŸ“‹'}];
          for(const [deptId, manager] of Object.entries(deptManagers)) {
              if(manager.email === email) {
                  const dept = depts.find(d => d.id === deptId);
                  return { text: 'Resp. ' + (dept?.name || deptId), icon: dept?.icon || 'ðŸ“‹', class: 'dept-manager', extraRoles: [] };
              }
          }
          // RÃ´le Ã©quipe (avec rÃ´les multiples)
          if(state.data?.crew) {
              const member = state.data.crew.find(c => c.email === email);
              if(member) {
                  const extraRoles = member.roles ? member.roles.map(r => ({ icon: r.icon, name: r.name })) : [];
                  return { text: member.role || '', icon: 'ðŸŽ¬', class: '', extraRoles };
              }
          }
          return { text: '', icon: '', class: '', extraRoles: [] };
      },
      initLocks: (id) => { 
          // Pas de locks en mode fichier local
          if(window.location.protocol === 'file:') return;
          // Supabase Realtime Broadcast pour synchroniser les locks entre collaborateurs
          if(state.locksChannel) {
              supabase.removeChannel(state.locksChannel);
          }
          
          state.activeLocks = {};
          
          state.locksChannel = supabase.channel('locks_' + id);
          
          // Ã‰couter les changements de locks des autres utilisateurs
          state.locksChannel
              .on('broadcast', { event: 'lock_acquired' }, (payload) => {
                  const { sceneId, lock } = payload.payload;
                  state.activeLocks[sceneId] = lock;
                  UI.applyLocks();
              })
              .on('broadcast', { event: 'lock_released' }, (payload) => {
                  const { sceneId } = payload.payload;
                  delete state.activeLocks[sceneId];
                  UI.applyLocks();
              })
              .on('presence', { event: 'leave' }, (payload) => {
                  // Nettoyer les locks de l'utilisateur qui part
                  const leftUserIds = payload.leftPresences?.map(p => p.uid) || [];
                  let changed = false;
                  Object.keys(state.activeLocks).forEach(sceneId => {
                      if(leftUserIds.includes(state.activeLocks[sceneId]?.uid)) {
                          delete state.activeLocks[sceneId];
                          changed = true;
                      }
                  });
                  if(changed) UI.applyLocks();
              })
              .subscribe(async (status) => {
                  if(status === 'SUBSCRIBED') {
                      await state.locksChannel.track({ 
                          uid: state.currentUser.uid, 
                          email: state.currentUser.email 
                      });
                  }
              });
          
          UI.applyLocks();
      },
      acquireLock: async (sceneId) => { 
          if(state.currentRole === 'viewer') return; 
          
          const existingLock = state.activeLocks[sceneId];
          if (existingLock && existingLock.uid !== state.currentUser.uid) {
              Utils.toast(`ScÃ¨ne dÃ©jÃ  Ã©ditÃ©e par ${existingLock.user.split('@')[0]}`, 'warning');
              return;
          }
          
          const lock = { 
              user: state.currentUser.email, 
              uid: state.currentUser.uid, 
              timestamp: Date.now() 
          };
          state.activeLocks[sceneId] = lock;
          
          if(state.locksChannel) {
              await state.locksChannel.send({
                  type: 'broadcast',
                  event: 'lock_acquired',
                  payload: { sceneId, lock }
              });
          }
          UI.applyLocks();
      },
      releaseLock: async (sceneId) => { 
          if(state.currentRole === 'viewer') return; 
          const lock = state.activeLocks[sceneId]; 
          if(lock && lock.uid === state.currentUser.uid) { 
              delete state.activeLocks[sceneId];
              
              if(state.locksChannel) {
                  await state.locksChannel.send({
                      type: 'broadcast',
                      event: 'lock_released',
                      payload: { sceneId }
                  });
              }
              UI.applyLocks();
          } 
      },
      cleanupLocks: async () => {
          if(state.locksChannel) {
              const myLocks = Object.keys(state.activeLocks).filter(
                  sceneId => state.activeLocks[sceneId]?.uid === state.currentUser?.uid
              );
              for(const sceneId of myLocks) {
                  await state.locksChannel.send({
                      type: 'broadcast',
                      event: 'lock_released',
                      payload: { sceneId }
                  });
              }
              supabase.removeChannel(state.locksChannel);
              state.locksChannel = null;
          }
          state.activeLocks = {};
      },
	  
      updateScene: Utils.debounce(async (sceneId, content) => { 
          if(!state.currentProjectId || state.currentRole === 'viewer') return; 
          const idx = state.data.scenes.findIndex(s => s.id === sceneId); 
          if(idx > -1) { 
              const newTime = Utils.estimateTime(content);
              state.data.scenes[idx].scriptContent = content;
              state.data.scenes[idx].time = newTime;
              await supabase.from('projects').update({ data: state.data }).eq('id', state.currentProjectId);
          } 
      }, 500),
      updateTitle: Utils.debounce(async (val) => { 
          if(!state.currentProjectId || state.currentRole === 'viewer') return; 
          state.data.title = val;
          const {error: e1} = await supabase.from('projects').update({ title: val, data: state.data }).eq('id', state.currentProjectId);
          if(e1) Utils.toast('Erreur sauvegarde titre', 'error');
      }, 1000),
      updateTextField: Utils.debounce(async (field, val) => { 
          if(!state.currentProjectId || state.currentRole === 'viewer') return; 
          state.data[field] = val;
          const {error: e2} = await supabase.from('projects').update({ data: state.data }).eq('id', state.currentProjectId);
          if(e2) Utils.toast('Erreur sauvegarde champ', 'error');
      }, 1000),
      migrateShootingDays: () => {
        // Migrer les jours de tournage vers le nouveau format (startDate/endDate)
        if(!state.data.shootingDays) return;
        
        state.data.shootingDays.forEach(day => {
            // Si ancien format (date), convertir vers nouveau format
            if(day.date && !day.startDate) {
                day.startDate = day.date;
                day.endDate = day.date;
                delete day.date;
            }
            
            // GÃ©nÃ©rer un nom basÃ© sur les scÃ¨nes si pas de nom
            if(!day.name) {
                if(day.scenes && day.scenes.length > 0 && state.data.scenes) {
                    const sceneInfos = day.scenes.map(sc => {
                        const sceneId = typeof sc === 'string' ? sc : sc.sceneId;
                        const sceneIndex = state.data.scenes.findIndex(s => s.id === sceneId);
                        const selectedShots = sc.selectedShots || [];
                        const shotCount = selectedShots.length;
                        return sceneIndex >= 0 ? { num: sceneIndex + 1, shots: shotCount } : null;
                    }).filter(Boolean);
                    
                    if(sceneInfos.length === 1) {
                        // Une seule scÃ¨ne : Sc.3 (5 pl.)
                        const info = sceneInfos[0];
                        day.name = `Sc.${info.num}` + (info.shots > 0 ? ` (${info.shots} pl.)` : '');
                    } else if(sceneInfos.length > 1) {
                        // Plusieurs scÃ¨nes : Sc.3(3pl);5(5pl)
                        day.name = 'Sc.' + sceneInfos.map(info => 
                            info.shots > 0 ? `${info.num}(${info.shots}pl)` : `${info.num}`
                        ).join(';');
                    } else {
                        day.name = `Tournage ${day.startDate || ''}`;
                    }
                } else {
                    day.name = `Tournage ${day.startDate || ''}`;
                }
            }
        });
    },
    
    migrateBreakdownKeys: () => {
          // Migrer les anciennes clÃ©s DÃ‰CORS/LIEUX vers DECORS-LIEUX
          if(state.data.scenes) {
              state.data.scenes.forEach(scene => {
                  if(scene.breakdown && scene.breakdown["DÃ‰CORS/LIEUX"]) {
                      scene.breakdown["DECORS-LIEUX"] = scene.breakdown["DECORS-LIEUX"] || [];
                      scene.breakdown["DECORS-LIEUX"] = [...new Set([...scene.breakdown["DECORS-LIEUX"], ...scene.breakdown["DÃ‰CORS/LIEUX"]])];
                      delete scene.breakdown["DÃ‰CORS/LIEUX"];
                  }
              });
          }
      },
      save: async () => { 
          if(!state.currentProjectId || !state.currentUser || state.currentRole === 'viewer') return;
          
          // Marquer qu'une sauvegarde est en cours
          state.savingInProgress = true; 
          
          // CrÃ©er un snapshot auto si plus de 5 min depuis le dernier
          if(Actions.shouldAutoSnapshot()) {
              Actions.createAutoSnapshot('Auto');
          }
          
          // Indicateur de sync : en cours
          const syncIndicator = document.getElementById('sync-indicator');
          if(syncIndicator) {
              syncIndicator.textContent = 'ðŸ”„';
              syncIndicator.style.opacity = '1';
          }
          
          Store.migrateBreakdownKeys();
          Store.migrateShootingDays(); 
          
          // Nettoyer les valeurs undefined
          const cleanData = JSON.parse(JSON.stringify(state.data, (key, value) => value === undefined ? null : value));
          
          const id = state.currentProjectId; 
          
          // Sauvegarder dans Supabase
          const { error } = await supabase
              .from('projects')
              .update({ 
                  data: cleanData,
                  title: state.data.title,
                  updated_at: new Date().toISOString()
              })
              .eq('id', id);
          
          if (error) {
              console.error('Erreur sauvegarde:', error); Utils.toast('Erreur de sauvegarde. VÃ©rifiez votre connexion.', 'error');
              if(syncIndicator) {
                  syncIndicator.textContent = 'âŒ';
                  setTimeout(() => {
                      syncIndicator.textContent = 'â˜ï¸';
                      syncIndicator.style.opacity = '0.4';
                  }, 3000);
              }
              state.savingInProgress = false;
              return;
          }
          
          // Indicateur de sync : terminÃ©
          if(syncIndicator) {
              syncIndicator.textContent = 'âœ…';
              setTimeout(() => {
                  syncIndicator.textContent = 'â˜ï¸';
                  syncIndicator.style.opacity = '0.4';
              }, 2000);
          }
          
          // Marquer que la sauvegarde est terminÃ©e
          state.savingInProgress = false;
          
          // Notifier les autres onglets de la modification
          if(typeof SessionManager !== 'undefined') {
              SessionManager.notifyDataUpdate();
          }
      },
      deleteProject: async (id, role, e) => { 
          if(e) e.stopPropagation(); 
          if(role === 'viewer') return; 
          if(await ConfirmModal.confirmDelete("Cette action est irrÃ©versible.", "Supprimer ce projet ?")) { 
              // Supprimer le projet dans Supabase (les membres seront supprimÃ©s en cascade)
              const {error: delErr} = await supabase.from('projects').delete().eq('id', id);
              if(delErr) { Utils.toast('Erreur suppression projet', 'error'); return; }
              await UI.renderDashboard(); 
          } 
      },
      shareProject: async (email, role) => { 
          if(!state.currentProjectId) return; 
          const pid = state.currentProjectId; 
          const emailLower = email.toLowerCase();
          
          // Ajouter le membre au projet dans Supabase
          const { error } = await supabase.from('project_members').upsert({
              project_id: pid,
              email: emailLower,
              role: role
          }, { onConflict: 'project_id,email' });
          
          if (error) {
              console.error('Erreur partage:', error);
              Utils.toast('Erreur lors du partage', 'error');
              return;
          }
          
          History.log('SHARE', `Partage projet avec ${email} (${role})`); 
          Notifications.send(email, 'invite', `${state.currentUser.email} vous a invitÃ© au projet "${state.data.title}"`, pid); 
          Utils.toast('InvitÃ© !', 'success'); 
          els.shareModal.style.display = 'none'; 
      },
      clearCurrent: async () => { if(state.currentRole === 'viewer') return; if(await ConfirmModal.confirmDelete("Toutes les donnÃ©es du projet seront effacÃ©es.", "Vider tout ?")){ state.data = Store.getEmpty(); Store.save(); UI.renderAll(); } },
      importJSON: (e) => { if(state.currentRole === 'viewer') return; const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ try{ state.data = JSON.parse(ev.target.result); Store.save(); UI.renderAll(); UI.switchTab('synopsis'); Utils.toast('Import rÃ©ussi !', 'success'); } catch(x){ Utils.toast('Erreur fichier.', 'error'); } }; r.readAsText(f); e.target.value=''; }
  };
  
  // ==================== MODULE ICONS ====================
  const Icons = {
      currentStyle: localStorage.getItem('moteur_icon_style') || 'emoji',
      
      map: {
          // Navigation
          'user':         { svg: 'ico-user', emoji: 'ðŸ‘¤', cat: 'system' },
          'users':        { svg: 'ico-users', emoji: 'ðŸ‘¥', cat: 'casting' },
          'folder':       { svg: 'ico-folder', emoji: 'ðŸ“', cat: 'system' },
          'contact':      { svg: 'ico-contact', emoji: 'ðŸ“‡', cat: 'system' },
          // Ã‰criture
          'scenario':     { svg: 'ico-file-text', emoji: 'ðŸ“', cat: 'writing' },
          'synopsis':     { svg: 'ico-book-open', emoji: 'ðŸ“–', cat: 'writing' },
          'sequencer':    { svg: 'ico-clapperboard', emoji: 'ðŸŽ¬', cat: 'writing' },
          'title-page':   { svg: 'ico-film', emoji: 'ðŸŽžï¸', cat: 'writing' },
          // Visuel
          'storyboard':   { svg: 'ico-grid', emoji: 'ðŸŽ¨', cat: 'visual' },
          'moodboard':    { svg: 'ico-image', emoji: 'ðŸ–¼ï¸', cat: 'visual' },
          'palette':      { svg: 'ico-palette', emoji: 'ðŸŽ¨', cat: 'visual' },
          // Casting
          'casting':      { svg: 'ico-theater', emoji: 'ðŸŽ­', cat: 'casting' },
          'actor':        { svg: 'ico-star', emoji: 'â­', cat: 'casting' },
          // Production
          'breakdown':    { svg: 'ico-clipboard', emoji: 'ðŸ“‹', cat: 'production' },
          'planning':     { svg: 'ico-calendar', emoji: 'ðŸ“…', cat: 'production' },
          'location':     { svg: 'ico-map-pin', emoji: 'ðŸ“', cat: 'production' },
          'crew':         { svg: 'ico-users', emoji: 'ðŸ‘¥', cat: 'production' },
          'resources':    { svg: 'ico-box', emoji: 'ðŸ“¦', cat: 'production' },
          'report':       { svg: 'ico-clipboard', emoji: 'ðŸ“‹', cat: 'production' },
          // Admin
          'expenses':     { svg: 'ico-wallet', emoji: 'ðŸ’°', cat: 'admin' },
          'contract':     { svg: 'ico-file-signature', emoji: 'ðŸ“„', cat: 'admin' },
          'stats':        { svg: 'ico-chart', emoji: 'ðŸ“Š', cat: 'admin' },
          'presentation': { svg: 'ico-monitor', emoji: 'ðŸ–¥ï¸', cat: 'admin' },
          'settings':     { svg: 'ico-settings', emoji: 'âš™ï¸', cat: 'system' },
          // Social
          'forum':        { svg: 'ico-message', emoji: 'ðŸ’¬', cat: 'social' },
          'feed':         { svg: 'ico-rss', emoji: 'ðŸ“°', cat: 'social' },
          'message':      { svg: 'ico-mail', emoji: 'âœ‰ï¸', cat: 'social' },
          'notification': { svg: 'ico-bell', emoji: 'ðŸ””', cat: 'social' },
          'community':    { svg: 'ico-globe', emoji: 'ðŸŒ', cat: 'social' },
          'universe':     { svg: 'ico-globe', emoji: 'ðŸŒ', cat: 'social' },
          'chat':         { svg: 'ico-message', emoji: 'ðŸ’¬', cat: 'social' },
          'collaboration':{ svg: 'ico-users', emoji: 'ðŸ¤', cat: 'social' },
          // Aide
          'help':         { svg: 'ico-help', emoji: 'â“', cat: 'help' },
          'guide':        { svg: 'ico-book', emoji: 'ðŸ“–', cat: 'help' },
          'course':       { svg: 'ico-graduation', emoji: 'ðŸŽ“', cat: 'help' },
          // Interface
          'design':       { svg: 'ico-palette', emoji: 'ðŸŽ¨', cat: 'system' },
          'theme-light':  { svg: 'ico-sun', emoji: 'â˜€ï¸', cat: 'system' },
          'theme-dark':   { svg: 'ico-moon', emoji: 'ðŸŒ™', cat: 'system' },
          'focus':        { svg: 'ico-maximize', emoji: 'ðŸ–¥ï¸', cat: 'system' },
          'search':       { svg: 'ico-search', emoji: 'ðŸ”', cat: 'system' },
          'plus':         { svg: 'ico-plus', emoji: 'âž•', cat: 'system' },
          'close':        { svg: 'ico-x', emoji: 'âœ–ï¸', cat: 'system' },
          'check':        { svg: 'ico-check', emoji: 'âœ…', cat: 'system' },
          'back':         { svg: 'ico-arrow-left', emoji: 'â¬…ï¸', cat: 'system' },
          'download':     { svg: 'ico-download', emoji: 'ðŸ“¥', cat: 'system' },
          'upload':       { svg: 'ico-upload', emoji: 'ðŸ“¤', cat: 'system' },
          'export':       { svg: 'ico-download', emoji: 'ðŸ“¤', cat: 'system' },
          'save':         { svg: 'ico-save', emoji: 'ðŸ’¾', cat: 'system' },
          'delete':       { svg: 'ico-trash', emoji: 'ðŸ—‘ï¸', cat: 'system' },
          'edit':         { svg: 'ico-edit', emoji: 'âœï¸', cat: 'system' },
          'view':         { svg: 'ico-eye', emoji: 'ðŸ‘ï¸', cat: 'system' },
          'shortcuts':    { svg: 'ico-keyboard', emoji: 'âŒ¨ï¸', cat: 'system' },
          'interface':    { svg: 'ico-layers', emoji: 'ðŸ“', cat: 'system' },
          'link':         { svg: 'ico-link', emoji: 'ðŸ”—', cat: 'system' },
          'share':        { svg: 'ico-share', emoji: 'ðŸ”—', cat: 'social' },
          'heart':        { svg: 'ico-heart', emoji: 'â¤ï¸', cat: 'social' },
          'clock':        { svg: 'ico-clock', emoji: 'ðŸ•', cat: 'system' },
          'home':         { svg: 'ico-home', emoji: 'ðŸ ', cat: 'system' },
          'car':          { svg: 'ico-car', emoji: 'ðŸš—', cat: 'production' },
          'costume':      { svg: 'ico-shirt', emoji: 'ðŸ‘—', cat: 'production' },
      },
      
      styles: {
          'emoji':    { name: 'Classique', emoji: 'ðŸ˜€' },
          'duotone':  { name: 'Duotone', emoji: 'â—' },
          'minimal':  { name: 'Minimal', emoji: 'â€”' }
      },
      
      setStyle: (styleName, silent = false) => {
          if(!Icons.styles[styleName]) styleName = 'emoji';
          Icons.currentStyle = styleName;
          PreferencesSync.save('moteur_icon_style', styleName);
          document.body.classList.remove('icon-style-emoji', 'icon-style-colored', 'icon-style-duotone', 'icon-style-minimal', 'icon-style-gradient');
          document.body.classList.add(`icon-style-${styleName}`);
          if(!silent) Utils.toast(`IcÃ´nes : ${Icons.styles[styleName].name}`, 'success');
      },
      
      init: () => {
          const saved = localStorage.getItem('moteur_icon_style') || 'emoji';
          Icons.currentStyle = saved;
          document.body.classList.add(`icon-style-${saved}`);
      },
      
      render: (name, options = {}) => {
          const ico = Icons.map[name];
          if(!ico) return `<span class="moteur-icon"><span class="emoji">â“</span></span>`;
          const cat = options.cat || ico.cat || 'system';
          const cls = options.class || '';
          return `<span class="moteur-icon cat-${cat} ${cls}"><span class="emoji">${ico.emoji}</span><svg><use href="#${ico.svg}"/></svg></span>`;
      },
      
      emoji: (name) => {
          const ico = Icons.map[name];
          return ico ? ico.emoji : 'â“';
      }
  };

  const UI = {
      toggleTheme: () => { document.body.classList.toggle('dark-mode'); PreferencesSync.save(CONFIG.themeKey, document.body.classList.contains('dark-mode') ? 'dark' : 'light'); if(Universe.map) Universe.updateMapTheme(); },
      
      // SystÃ¨me de Design
      designs: [
          { id: 'classic', name: 'Classique', icon: 'ðŸŽ¬', iconStyle: 'emoji' },
          { id: 'lavender', name: 'Lavande', icon: 'ðŸ’', iconStyle: 'duotone' },
          { id: 'minimal', name: 'Minimal', icon: 'â¬œ', iconStyle: 'minimal' }
      ],
      currentDesign: 'classic',
      
      setDesign: (designId) => {
          // Retirer tous les designs
          UI.designs.forEach(d => document.body.classList.remove('design-' + d.id));
          // Appliquer le nouveau (sauf classic qui est le dÃ©faut)
          if(designId !== 'classic') {
              document.body.classList.add('design-' + designId);
          }
          UI.currentDesign = designId;
          PreferencesSync.save('fmp_design', designId);
          // Appliquer le style d'icÃ´nes associÃ©
          const design = UI.designs.find(d => d.id === designId);
          if(design && design.iconStyle) {
              Icons.setStyle(design.iconStyle, true); // true = silencieux
          }
          // Fermer les dropdowns
          const dropdown = document.getElementById('design-dropdown');
          if(dropdown) dropdown.classList.remove('show');
          const dropdown2 = document.getElementById('design-dropdown-project');
          if(dropdown2) dropdown2.classList.remove('show');
          // Re-render le hub si visible
          if(document.getElementById('dashboard-view')?.style.display === 'flex') Hub.renderCards();
          Utils.toast('Design ' + (design?.name || designId) + ' appliquÃ© !', 'success');
      },
      
      cycleDesign: () => {
          const currentIndex = UI.designs.findIndex(d => d.id === UI.currentDesign);
          const nextIndex = (currentIndex + 1) % UI.designs.length;
          UI.setDesign(UI.designs[nextIndex].id);
      },
      
      initDesign: () => {
          try {
              const saved = localStorage.getItem('fmp_design');
              if(saved && UI.designs.find(d => d.id === saved)) {
                  UI.currentDesign = saved;
                  if(saved !== 'classic') document.body.classList.add('design-' + saved);
              }
          } catch(e) {}
      },
      
      toggleDropdown: (name) => {
          // Fermer tous les autres dropdowns
          document.querySelectorAll('.menu-dropdown.visible').forEach(d => {
              if(d.id !== 'dropdown-' + name) d.classList.remove('visible');
          });
          
          const dropdown = document.getElementById('dropdown-' + name);
          dropdown.classList.toggle('visible');
          
          if(dropdown.classList.contains('visible')) {
              setTimeout(() => {
                  const closeHandler = (e) => {
                      if(!e.target.closest('.menu-dropdown-container')) {
                          document.querySelectorAll('.menu-dropdown.visible').forEach(d => d.classList.remove('visible'));
                          document.removeEventListener('click', closeHandler);
                      }
                  };
                  document.addEventListener('click', closeHandler);
              }, 10);
          }
      },
      
      showDropdown: (name) => {
          // Fermer tous les autres dropdowns
          document.querySelectorAll('.menu-dropdown.visible').forEach(d => {
              if(d.id !== 'dropdown-' + name) d.classList.remove('visible');
          });
          const dropdown = document.getElementById('dropdown-' + name);
          if(dropdown) dropdown.classList.add('visible');
      },
      
      hideDropdown: (name) => {
          const dropdown = document.getElementById('dropdown-' + name);
          if(dropdown) dropdown.classList.remove('visible');
      },
      
      closeAllDropdowns: () => {
          document.querySelectorAll('.menu-dropdown.visible').forEach(d => d.classList.remove('visible'));
      },
      
      // Menu mobile
      toggleMobileSidebar: () => {
          const sidebar = document.querySelector('.board-sidebar');
          const overlay = document.getElementById('mobile-overlay');
          if(sidebar) {
              sidebar.classList.toggle('mobile-open');
              overlay.classList.toggle('active');
          }
      },
      closeMobileSidebar: () => {
          const sidebar = document.querySelector('.board-sidebar');
          const overlay = document.getElementById('mobile-overlay');
          if(sidebar) {
              sidebar.classList.remove('mobile-open');
              overlay.classList.remove('active');
          }
      },
      
      showShortcuts: () => {
          const modal = document.createElement('div');
          modal.className = 'shortcuts-modal';
          modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
          modal.innerHTML = `
              <div class="shortcuts-box">
                  <h3 class="shortcuts-title">âŒ¨ï¸ Raccourcis clavier</h3>
                  <div class="shortcuts-list">
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Sauvegarder</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">S</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Fermer modal</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ã‰chap</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Onglet suivant</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">â†’</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Onglet prÃ©cÃ©dent</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">â†</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Types de bloc (scÃ©nario)</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">1-6</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Tab intelligent / inverse</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Tab</span><span class="shortcut-key">â‡§Tab</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Quitter prÃ©sentation</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ã‰chap</span></div>
                      </div>
                  </div>
                  <button class="shortcuts-close" onclick="this.closest('.shortcuts-modal').remove()">Fermer</button>
              </div>
          `;
          document.body.appendChild(modal);
      },
      
      // Mode d'affichage des onglets
      setTabsMode: (mode) => {
          const tabsNav = document.getElementById('tabsNav');
          if(mode === 'adaptive') {
              tabsNav.classList.add('adaptive');
          } else {
              tabsNav.classList.remove('adaptive');
          }
          PreferencesSync.save('fmp_tabs_mode', mode);
      },
      
      // Position des onglets (haut, bas, gauche, droite)
      setTabsPosition: (position) => {
          const tabsNav = document.getElementById('tabsNav');
          const body = document.body;
          const main = document.querySelector('main');
          
          // Retirer toutes les classes de position
          tabsNav.classList.remove('position-top', 'position-bottom', 'position-left', 'position-right');
          body.classList.remove('tabs-left', 'tabs-right', 'tabs-bottom');
          
          // Reset des marges du main
          if(main) {
              main.style.marginLeft = '';
              main.style.marginRight = '';
              main.style.marginBottom = '';
          }
          
          // Appliquer la nouvelle position
          tabsNav.classList.add('position-' + position);
          if(position === 'left') body.classList.add('tabs-left');
          if(position === 'right') body.classList.add('tabs-right');
          if(position === 'bottom') body.classList.add('tabs-bottom');
          
          // En position latÃ©rale, forcer le mode DÃ©filant (pas d'Adaptatif)
          if(position === 'left' || position === 'right') {
              tabsNav.classList.remove('adaptive');
              PreferencesSync.save('fmp_tabs_mode', 'scroll');
          }
          
          // Mettre Ã  jour l'Ã©tat du menu
          UI.updatePositionMenuState();
          
          PreferencesSync.save('fmp_tabs_position', position);
      },
      
      togglePositionMenu: () => {
          const menu = document.getElementById('tabs-position-menu');
          if(menu) {
              const isVisible = menu.style.display !== 'none';
              menu.style.display = isVisible ? 'none' : 'block';
              
              // Mettre Ã  jour les Ã©tats actifs
              if(!isVisible) {
                  UI.updatePositionMenuState();
                  setTimeout(() => {
                      const closeHandler = (e) => {
                          if(!e.target.closest('.tabs-position-dropdown')) {
                              menu.style.display = 'none';
                              document.removeEventListener('click', closeHandler);
                          }
                      };
                      document.addEventListener('click', closeHandler);
                  }, 10);
              }
          }
      },
      
      updatePositionMenuState: () => {
          // Mettre Ã  jour Navigation
          const currentNav = (() => { try { return localStorage.getItem('fmp_nav_mode') || 'categories'; } catch(e) { return 'categories'; } })();
          document.querySelectorAll('.position-menu-item[data-nav]').forEach(item => {
              item.classList.toggle('active', item.getAttribute('data-nav') === currentNav);
          });
          
          // VÃ©rifier si on est en mode CatÃ©gories
          const isCategories = currentNav === 'categories';
          
          // Mettre Ã  jour Position (griser si CatÃ©gories)
          const currentPos = (() => { try { return localStorage.getItem('fmp_tabs_position') || 'top'; } catch(e) { return 'top'; } })();
          document.querySelectorAll('.position-menu-item[data-pos]').forEach(item => {
              item.classList.toggle('active', item.getAttribute('data-pos') === currentPos && !isCategories);
              item.classList.toggle('disabled', isCategories);
              item.style.opacity = isCategories ? '0.4' : '1';
              item.style.pointerEvents = isCategories ? 'none' : 'auto';
          });
          
          // Mettre Ã  jour Mode (griser si CatÃ©gories)
          const currentMode = (() => { try { return localStorage.getItem('fmp_tabs_mode') || 'adaptive'; } catch(e) { return 'adaptive'; } })();
          document.querySelectorAll('.position-menu-item[data-mode]').forEach(item => {
              item.classList.toggle('active', item.getAttribute('data-mode') === currentMode && !isCategories);
              item.classList.toggle('disabled', isCategories);
              item.style.opacity = isCategories ? '0.4' : '1';
              item.style.pointerEvents = isCategories ? 'none' : 'auto';
          });
          
          // Afficher/masquer section Mode selon la position (seulement pour haut/bas en mode Classique)
          const modeSection = document.getElementById('tabs-mode-section');
          if(modeSection) {
              const showMode = !isCategories && (currentPos === 'top' || currentPos === 'bottom');
              modeSection.style.display = showMode ? 'block' : 'none';
          }
          
          // Griser aussi le titre de section Position si CatÃ©gories
          const positionLabel = document.getElementById('position-section-label');
          if(positionLabel) {
              positionLabel.style.opacity = isCategories ? '0.4' : '1';
          }
          const positionHint = document.getElementById('position-disabled-hint');
          if(positionHint) {
              positionHint.style.display = isCategories ? 'inline' : 'none';
          }
      },
      
      setNavModeFromMenu: (mode) => {
          UI.setNavMode(mode);
          UI.updatePositionMenuState();
      },
      
      setTabsModeFromMenu: (mode) => {
          UI.setTabsMode(mode);
          UI.updatePositionMenuState();
      },
      
      initTabsMode: () => {
          // Init position des onglets (doit Ãªtre fait en premier)
          const savedPosition = (() => { try { return localStorage.getItem('fmp_tabs_position') || 'top'; } catch(e) { return 'top'; } })();
          UI.setTabsPosition(savedPosition);
          
          // Init mode (seulement si position haut/bas, sinon forcer dÃ©filant)
          const savedMode = (() => { try { return localStorage.getItem('fmp_tabs_mode') || 'adaptive'; } catch(e) { return 'adaptive'; } })();
          if(savedPosition === 'top' || savedPosition === 'bottom') {
              UI.setTabsMode(savedMode);
          } else {
              UI.setTabsMode('scroll');
          }
          
          // Positionnement dynamique des tooltips pour Ã©viter qu'ils sortent de l'Ã©cran
          document.addEventListener('mouseover', (e) => {
              const el = e.target.closest('[data-tooltip]');
              if(el) {
                  const rect = el.getBoundingClientRect();
                  const tooltip = el.querySelector('::after');
                  // Utiliser CSS custom properties pour positionner
                  const tooltipX = Math.min(Math.max(rect.left + rect.width/2, 100), window.innerWidth - 100);
                  const tooltipY = rect.bottom + 10;
                  el.style.setProperty('--tooltip-x', tooltipX + 'px');
                  el.style.setProperty('--tooltip-y', tooltipY + 'px');
              }
          });
          
          // Init mode navigation (classique ou catÃ©gories) - CatÃ©gories par dÃ©faut
          const savedNavMode = (() => { try { return localStorage.getItem('fmp_nav_mode') || 'categories'; } catch(e) { return 'categories'; } })();
          UI.setNavMode(savedNavMode, true);
          
          // Charger et appliquer les catÃ©gories masquÃ©es
          UI.loadHiddenCategories();
          UI.applyHiddenCategories();
          
          // Init CardModal
          CardModal.init();
      },
      
      // Mode de navigation (classique ou catÃ©gories)
      currentCategory: 'ecriture',
      categoryTabs: {
          ecriture: ['synopsis', 'board', 'titlepage', 'script', 'moodboard', 'storyboard'],
          casting: ['chars', 'actors', 'locs', 'resources'],
          production: ['presentation', 'crew', 'breakdown', 'planning', 'scriptreport'],
          admin: ['stats', 'expenses', 'chat']
      },
      categoryLabels: {
          ecriture: { synopsis: 'Synopsis', board: 'SÃ©quencier', titlepage: 'Titre', script: 'ScÃ©nario', moodboard: 'Mood Board', storyboard: 'Storyboard' },
          casting: { chars: 'Personnages', actors: 'ComÃ©dien.nes', locs: 'DÃ©cors', resources: 'Ressources' },
          production: { presentation: 'PrÃ©sentation', crew: 'Ã‰quipes', breakdown: 'DÃ©pouillement', planning: 'Planning', scriptreport: 'Rapport' },
          admin: { stats: 'Statistiques', expenses: 'DÃ©penses', chat: 'Chat' }
      },
      
      setNavMode: (mode, init = false) => {
          const tabsNav = document.getElementById('tabsNav');
          const tabsCategories = document.getElementById('tabsCategories');
          const tabsSubnav = document.getElementById('tabsSubnav');
          const classicOptions = document.getElementById('classic-mode-options');
          
          if(mode === 'categories') {
              tabsNav.classList.add('hidden-by-categories');
              tabsCategories.classList.add('active');
              tabsSubnav.classList.add('active');
              if(classicOptions) classicOptions.style.display = 'none';
              if(!init) UI.switchCategory(UI.currentCategory);
          } else {
              tabsNav.classList.remove('hidden-by-categories');
              tabsCategories.classList.remove('active');
              tabsSubnav.classList.remove('active');
              if(classicOptions) classicOptions.style.display = '';
          }
          PreferencesSync.save('fmp_nav_mode', mode);
          
          // RafraÃ®chir le bouton "MasquÃ©s" pour synchroniser entre les vues
          UI.applyHiddenTabs();
      },
      
      switchCategory: (category) => {
          UI.currentCategory = category;
          
          // Mettre Ã  jour les boutons catÃ©gorie
          document.querySelectorAll('.tab-category').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.category === category);
          });
          
          // Mettre Ã  jour la sous-navigation
          const subnav = document.getElementById('tabsSubnav');
          const tabs = UI.categoryTabs[category] || [];
          const labels = UI.categoryLabels[category] || {};
          
          // Filtrer les onglets masquÃ©s
          const visibleTabs = tabs.filter(t => !UI.hiddenTabs.includes(t));
          const hiddenInCategory = tabs.filter(t => UI.hiddenTabs.includes(t));
          
          let subnavHtml = visibleTabs.map(tab => {
              const isActive = document.getElementById('tab-' + tab)?.classList.contains('active');
              return `<button class="tab-subbtn${isActive ? ' active' : ''}" draggable="true" data-tab="${tab}" onclick="app.UI.switchTab('${tab}')">${labels[tab] || tab}<span class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('${tab}')" title="Masquer cet onglet">Ã—</span></button>`;
          }).join('');
          
          subnav.innerHTML = subnavHtml;
          subnav.dataset.category = category;
          
          // Afficher la subnav temporairement aprÃ¨s un changement de catÃ©gorie
          subnav.classList.add('force-visible');
          clearTimeout(UI._subnavTimer);
          UI._subnavTimer = setTimeout(() => subnav.classList.remove('force-visible'), 2000);
          
          // RÃ©appliquer les couleurs sauvegardÃ©es sur les sous-onglets (depuis le projet)
          const subColors = state.data?.uiConfig?.subColors || {};
          Object.keys(subColors).forEach(tabName => {
              const tab = subnav.querySelector(`.tab-subbtn[data-tab="${tabName}"]`);
              if(tab) {
                  tab.style.background = subColors[tabName];
                  tab.style.color = '#ffffff';
                  tab.style.borderRadius = '6px 6px 0 0';
              }
          });
          
          // RÃ©attacher les Ã©vÃ©nements contextmenu
          UI.initSubnavContextMenu();
          
          // Si aucun onglet visible de cette catÃ©gorie n'est actif, activer le premier visible
          const activeInCategory = visibleTabs.some(tab => document.getElementById('tab-' + tab)?.classList.contains('active'));
          if(!activeInCategory && visibleTabs.length > 0) {
              UI.switchTab(visibleTabs[0]);
          }
          
          try { localStorage.setItem('fmp_current_category', category); } catch(e) {}
      },
      
      // Trouver la catÃ©gorie d'un onglet
      getCategoryForTab: (tabName) => {
          for(const [cat, tabs] of Object.entries(UI.categoryTabs)) {
              if(tabs.includes(tabName)) return cat;
          }
          return 'ecriture';
      },
      
      // Couleur des onglets (clic droit)
      currentTabTarget: null,
      
      openTabColorMenu: (e, tab) => {
          e.preventDefault();
          UI.currentTabTarget = tab;
          UI.currentTabType = tab.classList.contains('tab-category') ? 'category' : 
                              tab.classList.contains('tab-subbtn') ? 'subbtn' : 'classic';
          const menu = document.getElementById('tab-color-menu');
          menu.classList.add('visible');
          
          // Calculer la position pour ne pas sortir de l'Ã©cran
          const menuRect = menu.getBoundingClientRect();
          const viewportW = window.innerWidth;
          const viewportH = window.innerHeight;
          
          let left = e.clientX;
          let top = e.clientY;
          
          // Ajuster si le menu sort Ã  droite
          if(left + menuRect.width > viewportW - 10) {
              left = viewportW - menuRect.width - 10;
          }
          // Ajuster si le menu sort en bas
          if(top + menuRect.height > viewportH - 10) {
              top = viewportH - menuRect.height - 10;
          }
          // Ne pas sortir Ã  gauche ou en haut
          if(left < 10) left = 10;
          if(top < 10) top = 10;
          
          menu.style.left = left + 'px';
          menu.style.top = top + 'px';
      },
      
      closeTabColorMenu: () => {
          const menu = document.getElementById('tab-color-menu');
          menu.classList.remove('visible');
          UI.currentTabTarget = null;
      },
      
      setTabColor: (color) => {
          if(UI.currentTabTarget) {
              const tabName = UI.currentTabTarget.getAttribute('data-tab') || UI.currentTabTarget.getAttribute('data-category');
              const isCategory = UI.currentTabType === 'category';
              
              // Initialiser uiConfig si nÃ©cessaire
              if(!state.data.uiConfig) state.data.uiConfig = { tabColors: {}, categoryColors: {}, subColors: {}, tabsOrder: [], categoriesOrder: [], hiddenTabs: [] };
              if(!state.data.uiConfig.tabColors) state.data.uiConfig.tabColors = {};
              if(!state.data.uiConfig.subColors) state.data.uiConfig.subColors = {};
              if(!state.data.uiConfig.categoryColors) state.data.uiConfig.categoryColors = {};
              
              // Appliquer le style visuellement
              const applyStyle = (el, col) => {
                  if(col) {
                      el.style.background = col;
                      el.style.color = '#ffffff';
                      el.style.borderRadius = '6px 6px 0 0';
                  } else {
                      el.style.background = '';
                      el.style.color = '';
                      el.style.borderRadius = '';
                  }
              };
              
              applyStyle(UI.currentTabTarget, color);
              
              if(isCategory) {
                  // C'est une catÃ©gorie - sauvegarder dans categoryColors
                  if(color) {
                      state.data.uiConfig.categoryColors[tabName] = color;
                  } else {
                      delete state.data.uiConfig.categoryColors[tabName];
                  }
              } else {
                  // C'est un onglet - synchroniser tabColors ET subColors
                  if(color) {
                      state.data.uiConfig.tabColors[tabName] = color;
                      state.data.uiConfig.subColors[tabName] = color;
                  } else {
                      delete state.data.uiConfig.tabColors[tabName];
                      delete state.data.uiConfig.subColors[tabName];
                  }
                  // Appliquer aussi Ã  l'Ã©quivalent dans l'autre vue
                  const classicTab = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
                  const subTab = document.querySelector(`.tab-subbtn[data-tab="${tabName}"]`);
                  if(classicTab) applyStyle(classicTab, color);
                  if(subTab) applyStyle(subTab, color);
              }
              Store.save();
          }
          UI.closeTabColorMenu();
      },
      
      openTabHelp: () => {
          const tabToHelp = {
              'presentation': 'dashboard',
              'synopsis': 'scenario',
              'board': 'sequencier',
              'script': 'scenario',
              'storyboard': 'storyboard',
              'chars': 'equipe',
              'locs': 'breakdown',
              'actors': 'equipe',
              'crew': 'equipe',
              'breakdown': 'breakdown',
              'planning': 'planning',
              'expenses': 'depenses',
              'budget': 'depenses',
              'chat': 'collaboration'
          };
          if(UI.currentTabTarget) {
              const tabName = UI.currentTabTarget.getAttribute('data-tab');
              UI.closeTabColorMenu();
              // Ouvrir l'aide contextuelle pour cet onglet
              if(Tutorial.helpTexts[tabName]) {
                  const rect = UI.currentTabTarget.getBoundingClientRect();
                  Tutorial.showHelp(tabName, { target: UI.currentTabTarget, stopPropagation: () => {} });
              } else {
                  Tutorial.open();
              }
          }
      },
      
      loadTabColors: () => {
          // RÃ©initialiser tous les styles d'abord
          document.querySelectorAll('.tab-btn, .tab-category, .tab-subbtn').forEach(tab => {
              tab.style.background = '';
              tab.style.color = '';
              tab.style.borderRadius = '';
          });
          
          // Charger depuis le projet (ou vide si pas de config)
          const uiConfig = state.data?.uiConfig || {};
          
          // Onglets classiques
          const tabColors = uiConfig.tabColors || {};
          Object.keys(tabColors).forEach(tabName => {
              const tab = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
              if(tab) {
                  tab.style.background = tabColors[tabName];
                  tab.style.color = '#ffffff';
                  tab.style.borderRadius = '6px 6px 0 0';
              }
          });
          // CatÃ©gories
          const categoryColors = uiConfig.categoryColors || {};
          Object.keys(categoryColors).forEach(catName => {
              const tab = document.querySelector(`.tab-category[data-category="${catName}"]`);
              if(tab) {
                  tab.style.background = categoryColors[catName];
                  tab.style.color = '#ffffff';
                  tab.style.borderRadius = '6px 6px 0 0';
              }
          });
          // Sous-onglets
          const subColors = uiConfig.subColors || {};
          Object.keys(subColors).forEach(tabName => {
              const tab = document.querySelector(`.tab-subbtn[data-tab="${tabName}"]`);
              if(tab) {
                  tab.style.background = subColors[tabName];
                  tab.style.color = '#ffffff';
                  tab.style.borderRadius = '6px 6px 0 0';
              }
          });
      },
      
      initTabsContextMenu: () => {
          // Onglets classiques
          document.querySelectorAll('.tab-btn').forEach(tab => {
              tab.addEventListener('contextmenu', (e) => UI.openTabColorMenu(e, tab));
          });
          // CatÃ©gories (mode catÃ©gories)
          document.querySelectorAll('.tab-category').forEach(tab => {
              tab.addEventListener('contextmenu', (e) => UI.openTabColorMenu(e, tab));
          });
          // Sous-onglets (mode catÃ©gories)
          document.querySelectorAll('.tab-subbtn').forEach(tab => {
              tab.addEventListener('contextmenu', (e) => UI.openTabColorMenu(e, tab));
          });
          // Fermer le menu au clic ailleurs
          document.addEventListener('click', (e) => {
              if(!e.target.closest('.tab-color-menu')) {
                  UI.closeTabColorMenu();
              }
              // Fermer le panneau notifications si clic en dehors
              if(!e.target.closest('.notif-wrapper')) {
                  Notifications.closePanel();
              }
          });
      },
      
      // RÃ©attacher les Ã©vÃ©nements aprÃ¨s rebuild de la sous-nav
      initSubnavContextMenu: () => {
          document.querySelectorAll('.tab-subbtn').forEach(tab => {
              tab.addEventListener('contextmenu', (e) => UI.openTabColorMenu(e, tab));
          });
          // Initialiser le drag & drop des sous-onglets
          UI.initSubnavDragDrop();
      },
      
      // Drag & drop des sous-onglets entre catÃ©gories
      subnavDraggedTab: null,
      subnavDraggedCategory: null,
      
      initSubnavDragDrop: () => {
          const subnav = document.getElementById('tabsSubnav');
          if(!subnav) return;
          
          subnav.querySelectorAll('.tab-subbtn').forEach(tab => {
              tab.addEventListener('dragstart', (e) => {
                  UI.subnavDraggedTab = tab;
                  UI.subnavDraggedCategory = UI.currentCategory;
                  tab.classList.add('dragging');
                  e.dataTransfer.effectAllowed = 'move';
                  e.dataTransfer.setData('text/plain', tab.dataset.tab);
              });
              
              tab.addEventListener('dragend', () => {
                  tab.classList.remove('dragging');
                  subnav.querySelectorAll('.tab-subbtn').forEach(t => t.classList.remove('drag-over'));
                  document.querySelectorAll('.tab-category').forEach(c => c.classList.remove('drag-over'));
                  UI.subnavDraggedTab = null;
                  UI.subnavDraggedCategory = null;
              });
              
              tab.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  if(UI.subnavDraggedTab && UI.subnavDraggedTab !== tab) {
                      tab.classList.add('drag-over');
                  }
              });
              
              tab.addEventListener('dragleave', () => {
                  tab.classList.remove('drag-over');
              });
              
              tab.addEventListener('drop', (e) => {
                  e.preventDefault();
                  tab.classList.remove('drag-over');
                  if(UI.subnavDraggedTab && UI.subnavDraggedTab !== tab) {
                      const allTabs = [...subnav.querySelectorAll('.tab-subbtn')];
                      const draggedIdx = allTabs.indexOf(UI.subnavDraggedTab);
                      const targetIdx = allTabs.indexOf(tab);
                      
                      if(draggedIdx < targetIdx) {
                          tab.after(UI.subnavDraggedTab);
                      } else {
                          tab.before(UI.subnavDraggedTab);
                      }
                      
                      // Sauvegarder le nouvel ordre
                      UI.saveSubnavOrder();
                  }
              });
          });
          
          // Permettre le drop sur les catÃ©gories pour changer de catÃ©gorie
          document.querySelectorAll('.tab-category').forEach(catBtn => {
              catBtn.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  if(UI.subnavDraggedTab && catBtn.dataset.category !== UI.subnavDraggedCategory) {
                      catBtn.classList.add('drag-over');
                  }
              });
              
              catBtn.addEventListener('dragleave', () => {
                  catBtn.classList.remove('drag-over');
              });
              
              catBtn.addEventListener('drop', (e) => {
                  e.preventDefault();
                  catBtn.classList.remove('drag-over');
                  
                  if(UI.subnavDraggedTab && catBtn.dataset.category !== UI.subnavDraggedCategory) {
                      const tabName = UI.subnavDraggedTab.dataset.tab;
                      const fromCategory = UI.subnavDraggedCategory;
                      const toCategory = catBtn.dataset.category;
                      
                      // DÃ©placer l'onglet vers la nouvelle catÃ©gorie
                      UI.moveTabToCategory(tabName, fromCategory, toCategory);
                  }
              });
          });
      },
      
      saveSubnavOrder: () => {
          const subnav = document.getElementById('tabsSubnav');
          const category = UI.currentCategory;
          const newOrder = [...subnav.querySelectorAll('.tab-subbtn')].map(t => t.dataset.tab);
          
          // Mettre Ã  jour categoryTabs
          UI.categoryTabs[category] = newOrder;
          
          // Sauvegarder dans le projet
          if(state.data && state.data.uiConfig) {
              if(!state.data.uiConfig.categoryTabsOrder) state.data.uiConfig.categoryTabsOrder = {};
              state.data.uiConfig.categoryTabsOrder[category] = newOrder;
              Store.save();
          }
          
          Utils.toast('Ordre des onglets sauvegardÃ©', 'success');
      },
      
      moveTabToCategory: (tabName, fromCategory, toCategory) => {
          // Retirer de l'ancienne catÃ©gorie
          UI.categoryTabs[fromCategory] = UI.categoryTabs[fromCategory].filter(t => t !== tabName);
          
          // Ajouter Ã  la nouvelle catÃ©gorie
          if(!UI.categoryTabs[toCategory].includes(tabName)) {
              UI.categoryTabs[toCategory].push(tabName);
          }
          
          // Ajouter le label si pas dÃ©jÃ  prÃ©sent
          if(!UI.categoryLabels[toCategory][tabName]) {
              UI.categoryLabels[toCategory][tabName] = UI.categoryLabels[fromCategory][tabName];
          }
          
          // Sauvegarder dans le projet
          if(state.data && state.data.uiConfig) {
              if(!state.data.uiConfig.categoryTabsOrder) state.data.uiConfig.categoryTabsOrder = {};
              state.data.uiConfig.categoryTabsOrder[fromCategory] = UI.categoryTabs[fromCategory];
              state.data.uiConfig.categoryTabsOrder[toCategory] = UI.categoryTabs[toCategory];
              
              if(!state.data.uiConfig.categoryLabelsCustom) state.data.uiConfig.categoryLabelsCustom = {};
              if(!state.data.uiConfig.categoryLabelsCustom[toCategory]) state.data.uiConfig.categoryLabelsCustom[toCategory] = {};
              state.data.uiConfig.categoryLabelsCustom[toCategory][tabName] = UI.categoryLabels[fromCategory][tabName];
              
              Store.save();
          }
          
          // RafraÃ®chir la vue - aller Ã  la nouvelle catÃ©gorie
          UI.switchCategory(toCategory);
          Utils.toast(`"${UI.categoryLabels[toCategory][tabName]}" dÃ©placÃ© vers ${toCategory}`, 'success');
      },
      
      // RÃ©initialiser l'ordre des onglets
      resetTabsOrder: () => {
          // RÃ©initialiser les onglets classiques
          const tabsNav = document.getElementById('tabsNav');
          const defaultOrder = [
              'presentation', 'synopsis', 'board', 'titlepage', 'script', 'storyboard', 
              'chars', 'actors', 'locs', 'resources', 'crew', 'breakdown', 
              'stats', 'planning', 'expenses', 'chat'
          ];
          const tabs = Array.from(tabsNav.querySelectorAll('.tab-btn'));
          
          defaultOrder.forEach(tabName => {
              const tab = tabs.find(t => t.getAttribute('data-tab') === tabName);
              if(tab) tabsNav.appendChild(tab);
          });
          
          // RÃ©initialiser les catÃ©gories
          const catsNav = document.getElementById('tabsCategories');
          const defaultCatsOrder = ['ecriture', 'casting', 'production', 'admin'];
          const toggle = document.getElementById('hiddenCategoriesToggle');
          
          defaultCatsOrder.forEach(catName => {
              const cat = catsNav.querySelector(`.tab-category[data-category="${catName}"]`);
              if(cat) catsNav.insertBefore(cat, toggle);
          });
          
          // RÃ©initialiser les sous-onglets par catÃ©gorie (ordre par dÃ©faut)
          const defaultCategoryTabs = {
              ecriture: ['synopsis', 'board', 'titlepage', 'script', 'storyboard'],
              casting: ['chars', 'actors', 'locs', 'resources'],
              production: ['presentation', 'crew', 'breakdown', 'planning', 'scriptreport'],
              admin: ['stats', 'expenses', 'chat']
          };
          const defaultCategoryLabels = {
              ecriture: { synopsis: 'Synopsis', board: 'SÃ©quencier', titlepage: 'Titre', script: 'ScÃ©nario', storyboard: 'Storyboard' },
              casting: { chars: 'Personnages', actors: 'ComÃ©dien.nes', locs: 'DÃ©cors', resources: 'Ressources' },
              production: { presentation: 'PrÃ©sentation', crew: 'Ã‰quipes', breakdown: 'DÃ©pouillement', planning: 'Planning', scriptreport: 'Rapport' },
              admin: { stats: 'Statistiques', expenses: 'DÃ©penses', chat: 'Chat' }
          };
          
          // Restaurer les valeurs par dÃ©faut
          UI.categoryTabs = JSON.parse(JSON.stringify(defaultCategoryTabs));
          UI.categoryLabels = JSON.parse(JSON.stringify(defaultCategoryLabels));
          
          // RÃ©initialiser dans le projet
          if(state.data.uiConfig) {
              state.data.uiConfig.tabsOrder = [];
              state.data.uiConfig.categoriesOrder = [];
              state.data.uiConfig.categoryTabsOrder = {};
              state.data.uiConfig.categoryLabelsCustom = {};
              state.data.uiConfig.tabColors = {};
              state.data.uiConfig.categoryColors = {};
              state.data.uiConfig.subColors = {};
              Store.save();
          }
          
          // RÃ©initialiser les couleurs visuellement
          document.querySelectorAll('.tab-btn').forEach(tab => {
              tab.style.background = '';
              tab.style.color = '';
              tab.style.borderRadius = '';
          });
          document.querySelectorAll('.tab-category').forEach(cat => {
              cat.style.background = '';
              cat.style.color = '';
              cat.style.borderRadius = '';
          });
          document.querySelectorAll('.tab-subbtn').forEach(sub => {
              sub.style.background = '';
              sub.style.color = '';
              sub.style.borderRadius = '';
          });
          
          // RafraÃ®chir la vue catÃ©gories si active
          const tabsCategories = document.getElementById('tabsCategories');
          if(tabsCategories && tabsCategories.classList.contains('active')) {
              UI.switchCategory(UI.currentCategory);
          }
          
          Utils.toast('Ordre et couleurs rÃ©initialisÃ©s', 'success');
      },
      hideAllViews: () => {
          document.getElementById('dashboard-view').style.display = 'none';
          document.getElementById('universe-view').style.display = 'none';
          document.getElementById('projects-view').style.display = 'none';
          document.getElementById('app-view').style.display = 'none';
          const adminV = document.getElementById('admin-view');
          if(adminV) adminV.style.display = 'none';
          document.getElementById('public-profile-view').classList.remove('active');
          document.getElementById('contacts-view').classList.remove('active');
          document.getElementById('forum-view').classList.remove('active');
          document.getElementById('feed-view').classList.remove('active');
          document.getElementById('courses-view').classList.remove('active');
          const bbv = document.getElementById('beatboard-view'); if(bbv) bbv.style.display = 'none';
          const sqv = document.getElementById('sequencer-view'); if(sqv) sqv.style.display = 'none';
      },
      showDashboard: async () => { 
          UI.hideAllViews();
          els.authView.style.display = 'none'; 
          els.dashboardView.style.display = 'flex';
          
          // Nettoyer le chat
          if(typeof Chat !== 'undefined') Chat.cleanup();
          // Nettoyer les locks de scÃ¨ne
          if(typeof Store !== 'undefined' && Store.cleanupLocks) await Store.cleanupLocks();
          const accountType = state.userProfile?.accountType || 'producer';
          const typeLabel = accountType === 'actor' ? 'ðŸŽ­ ComÃ©dien.ne' : (accountType === 'crew' ? 'ðŸŽ¥ Technicien.ne' : 'ðŸŽ¬ RÃ©alisateur');
          document.getElementById('user-welcome').innerText = typeLabel + " â€¢ " + (state.currentUser ? state.currentUser.email : ""); 
          
          // Mettre Ã  jour le bouton profil
          const profileBtn = document.getElementById('btn-my-profile');
          if(profileBtn) {
              const profileComplete = state.userProfile?.profileComplete;
              profileBtn.innerHTML = profileComplete ? 'ðŸ‘¤ Mon Profil' : 'âš ï¸ ComplÃ©ter mon profil';
              profileBtn.style.background = 'var(--panel-bg)';
          }
          
          await UI.renderDashboard(); 
          
          // Timer pour mettre Ã  jour le countdown de l'essai
          if(UI.trialTimer) clearInterval(UI.trialTimer);
          if(Pricing.isInTrial()) {
              UI.trialTimer = setInterval(() => {
                  if(Pricing.isInTrial()) {
                      UI.renderProjectList();
                  } else {
                      clearInterval(UI.trialTimer);
                      UI.renderProjectList(); // Afficher que l'essai est terminÃ©
                  }
              }, 60000); // Mise Ã  jour toutes les minutes
          }
      },
      toggleSidebarContent: () => { if(els.toggleSynop.checked) els.blockSynop.classList.add('visible'); else els.blockSynop.classList.remove('visible'); if(els.toggleShort.checked) els.blockShort.classList.add('visible'); else els.blockShort.classList.remove('visible'); if(els.toggleLong.checked) els.blockLong.classList.add('visible'); else els.blockLong.classList.remove('visible'); },
      
      boardMode: 'normal',
      
      setBoardMode: (mode) => {
          UI.boardMode = mode;
          
          // Mettre Ã  jour les boutons
          document.getElementById('board-mode-normal').classList.toggle('active', mode === 'normal');
          document.getElementById('board-mode-normal').style.background = mode === 'normal' ? 'var(--primary)' : 'var(--bg)';
          document.getElementById('board-mode-normal').style.color = mode === 'normal' ? 'white' : 'var(--text-main)';
          
          document.getElementById('board-mode-compact').classList.toggle('active', mode === 'compact');
          document.getElementById('board-mode-compact').style.background = mode === 'compact' ? 'var(--primary)' : 'var(--bg)';
          document.getElementById('board-mode-compact').style.color = mode === 'compact' ? 'white' : 'var(--text-main)';
          
          // Appliquer le mode
          const boardList = document.getElementById('boardList');
          if(mode === 'compact') {
              boardList.classList.add('compact-mode');
          } else {
              boardList.classList.remove('compact-mode');
          }
          
          // Sauvegarder la prÃ©fÃ©rence
          PreferencesSync.save('fmp_board_mode', mode);
      },
      
      loadBoardMode: () => {
          try {
              const saved = localStorage.getItem('fmp_board_mode');
              if(saved) UI.setBoardMode(saved);
          } catch(e) {}
      },

      renderDashboard: async () => { 
          // V2.1.6 : Hub central au dÃ©marrage
          Hub.render();
      },
      
      showPriorityMenu: (e, projectId) => {
          e.stopPropagation();
          // Fermer menu existant
          const existing = document.querySelector('.priority-menu');
          if(existing) existing.remove();
          
          const priorities = [
              { label: 'Principal', class: 'principal', color: '#4CAF50' },
              { label: 'Secondaire', class: 'secondaire', color: '#2196F3' },
              { label: 'Urgent', class: 'urgent', color: '#f44336' },
              { label: 'En attente', class: 'en-attente', color: '#9E9E9E' },
              { label: 'Une idÃ©e', class: 'une-idee', color: '#FF9800' },
              { label: 'Je sais pas trop', class: 'je-sais-pas-trop', color: '#9C27B0' },
              { label: 'ArchivÃ©', class: 'archive', color: '#795548' },
              { label: 'Aucune', class: '', color: 'transparent' }
          ];
          
          const menu = document.createElement('div');
          menu.className = 'priority-menu';
          menu.innerHTML = priorities.map(p => `
              <div class="priority-menu-item" onclick="app.UI.setPriority('${projectId}', '${p.label === 'Aucune' ? '' : p.label}')">
                  <span class="dot" style="background:${p.color}"></span>
                  ${p.label}
              </div>
          `).join('');
          
          const rect = e.target.getBoundingClientRect();
          menu.style.position = 'fixed';
          menu.style.top = (rect.bottom + 5) + 'px';
          menu.style.left = rect.left + 'px';
          
          document.body.appendChild(menu);
          
          // Fermer au clic ailleurs
          setTimeout(() => {
              document.addEventListener('click', function closeMenu(ev) {
                  if(!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('click', closeMenu); }
              });
          }, 10);
      },
      
      setPriority: async (projectId, priority) => {
          const menu = document.querySelector('.priority-menu');
          if(menu) menu.remove();
          
          try {
              // Charger les donnÃ©es actuelles du projet
              const { data: project } = await supabase
                  .from('projects')
                  .select('data')
                  .eq('id', projectId)
                  .single();
              
              if (project) {
                  const updatedData = { ...project.data, priority: priority || null };
                  await supabase.from('projects').update({ data: updatedData }).eq('id', projectId);
              }
              
              Utils.toast(priority ? `PrioritÃ© "${priority}" dÃ©finie` : 'PrioritÃ© supprimÃ©e', 'success');
              UI.renderProjectList();
          } catch(e) {
              Utils.toast('Erreur lors de la mise Ã  jour', 'error');
          }
      },
      
      reorderProjects: async (draggedId, targetId) => {
          const list = await Store.getProjectsList();
          
          // Trouver les index
          const draggedIdx = list.findIndex(p => p.id === draggedId);
          const targetIdx = list.findIndex(p => p.id === targetId);
          
          if(draggedIdx === -1 || targetIdx === -1) return;
          
          // Capturer les positions actuelles des cartes
          const cards = Array.from(document.querySelectorAll('.project-card'));
          const oldPositions = new Map();
          cards.forEach(card => {
              const rect = card.getBoundingClientRect();
              oldPositions.set(card.dataset.projectId, { left: rect.left, top: rect.top });
          });
          
          // RÃ©organiser
          const [dragged] = list.splice(draggedIdx, 1);
          list.splice(targetIdx, 0, dragged);
          
          // Sauvegarder l'ordre pour chaque projet
          try {
              for (let idx = 0; idx < list.length; idx++) {
                  const p = list[idx];
                  const { data: proj } = await supabase.from('projects').select('data').eq('id', p.id).single();
                  if (proj) {
                      const updatedData = { ...proj.data, order: idx };
                      await supabase.from('projects').update({ data: updatedData }).eq('id', p.id);
                  }
              }
              
              // Reconstruire la liste
              await UI.renderProjectList();
              
              // Animer vers les nouvelles positions (FLIP animation)
              const newCards = Array.from(document.querySelectorAll('.project-card'));
              newCards.forEach(card => {
                  const projectId = card.dataset.projectId;
                  const oldPos = oldPositions.get(projectId);
                  if(oldPos) {
                      const newRect = card.getBoundingClientRect();
                      const deltaX = oldPos.left - newRect.left;
                      const deltaY = oldPos.top - newRect.top;
                      
                      if(deltaX !== 0 || deltaY !== 0) {
                          card.style.transition = 'none';
                          card.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                          
                          requestAnimationFrame(() => {
                              requestAnimationFrame(() => {
                                  card.style.transition = 'transform 0.7s cubic-bezier(0.25, 0.1, 0.25, 1)';
                                  card.style.transform = 'translate(0, 0)';
                              });
                          });
                          
                          // Nettoyer aprÃ¨s l'animation
                          setTimeout(() => {
                              card.style.transition = '';
                              card.style.transform = '';
                          }, 750);
                      }
                  }
              });
              
          } catch(e) {
              Utils.toast('Erreur lors du rÃ©ordonnancement', 'error');
          }
      },

      renderProjectList: async () => {
          els.projectList.innerHTML = '<div style="padding:20px; color:#999">Chargement...</div>'; 
          const list = await Store.getProjectsList(); 
          els.projectList.innerHTML = ''; 
          
          const accountType = state.userProfile?.accountType || 'crew';
          
          // BanniÃ¨re d'essai (si en pÃ©riode d'essai)
          const trialBanner = Pricing.getTrialBanner();
          if(trialBanner) {
              const bannerDiv = document.createElement('div');
              bannerDiv.style.cssText = 'grid-column: 1 / -1;';
              bannerDiv.innerHTML = trialBanner;
              els.projectList.appendChild(bannerDiv);
          }
          
          // Widget de facturation (si abonnÃ© avec des projets)
          const billingWidget = await Pricing.getBillingWidget();
          if(billingWidget) {
              const billingDiv = document.createElement('div');
              billingDiv.style.cssText = 'grid-column: 1 / -1;';
              billingDiv.innerHTML = billingWidget;
              els.projectList.appendChild(billingDiv);
          }
          
          // Carte nouveau projet (tout le monde peut crÃ©er un projet)
          const newCard = document.createElement('div'); 
          newCard.className = 'new-project-card'; 
          newCard.innerHTML = `<span>+</span><div>Nouveau Projet</div>`; 
          newCard.onclick = Store.createNewProject; 
          els.projectList.appendChild(newCard); 
          
          const importCard = document.createElement('div');
          importCard.className = 'new-project-card import-card';
          importCard.innerHTML = `<span>ðŸ“‚</span><div>Importer (PDF / FDX)</div>`;
          importCard.onclick = () => els.importInput.click();
          els.projectList.appendChild(importCard);
          
         

          // Liste des projets
          if(list.length > 0) {
              // Trier par ordre personnalisÃ© puis par date
              list.sort((a, b) => {
                  const orderA = a.order !== undefined ? a.order : 9999;
                  const orderB = b.order !== undefined ? b.order : 9999;
                  if(orderA !== orderB) return orderA - orderB;
                  return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
              });
              
              list.forEach((p, idx) => { 
                  const card = document.createElement('div'); 
                  card.className = 'project-card'; 
                  card.draggable = true;
                  card.dataset.projectId = p.id;
                  card.dataset.index = idx;
                  let badgeColor = p.role==='owner'?'var(--primary)':(p.role==='editor'?'orange':'gray'); 
                  let badgeText = p.role==='owner'?'PROPRIÃ‰TAIRE':(p.role==='editor'?'Ã‰DITEUR':'LECTEUR');
                  const priorityClass = p.priority ? p.priority.replace(/\s+/g, '-').toLowerCase() : '';
                  const priorityBadge = p.priority ? `<span class="priority-badge ${priorityClass}">${p.priority}</span>` : '';
                  card.innerHTML = `<span class="p-role-badge" style="color:${badgeColor}; border-color:${badgeColor}">${badgeText}</span><div><div class="p-title">${Utils.escape(p.title)}</div><div class="p-meta">ModifiÃ© : ${p.date} ${priorityBadge}</div></div><div class="p-actions"><button class="p-btn-priority" onclick="app.UI.showPriorityMenu(event, '${p.id}')" title="PrioritÃ©">ðŸ·ï¸</button><button class="p-btn-del" onclick="app.Store.deleteProject('${p.id}', '${p.role}', event)">ðŸ—‘ï¸</button></div>`; 
                  card.onclick = (e) => { if(!e.target.closest('.p-actions')) Store.loadProject(p.id); };
                  
                  // Drag & drop events
                  card.addEventListener('dragstart', (e) => { 
                      card.classList.add('dragging'); 
                      e.dataTransfer.setData('text/plain', p.id);
                      e.dataTransfer.effectAllowed = 'move';
                      setTimeout(() => card.style.visibility = 'hidden', 0);
                  });
                  card.addEventListener('dragend', () => { 
                      card.classList.remove('dragging'); 
                      card.style.visibility = 'visible';
                      document.querySelectorAll('.project-card').forEach(c => { c.classList.remove('drag-over'); c.classList.remove('drag-over-left'); }); 
                  });
                  card.addEventListener('dragover', (e) => { 
                      e.preventDefault(); 
                      if(!card.classList.contains('dragging')) {
                          document.querySelectorAll('.project-card').forEach(c => { if(c !== card) { c.classList.remove('drag-over'); c.classList.remove('drag-over-left'); }});
                          card.classList.add('drag-over');
                      }
                  });
                  card.addEventListener('dragleave', (e) => { 
                      if(!card.contains(e.relatedTarget)) {
                          card.classList.remove('drag-over'); 
                          card.classList.remove('drag-over-left'); 
                      }
                  });
                  card.addEventListener('drop', (e) => { e.preventDefault(); card.classList.remove('drag-over'); card.classList.remove('drag-over-left'); const draggedId = e.dataTransfer.getData('text/plain'); if(draggedId !== p.id) UI.reorderProjects(draggedId, p.id); });
                  
                  els.projectList.appendChild(card); 
              });
          }
      },
      
      launchEditor: () => { 
          els.dashboardView.style.display = 'none'; 
          document.getElementById('projects-view').style.display = 'none';
          els.appView.style.display = 'flex';
          
          // Appliquer les permissions sur les onglets visibles
          UI.applyTabPermissions(); 
          let roleTxt = state.currentRole === 'owner' ? 'PROPRIÃ‰TAIRE' : (state.currentRole === 'editor' ? 'Ã‰DITEUR' : 'LECTEUR');
          
          // Afficher le rÃ´le mÃ©tier si disponible
          const userEmail = state.currentUser?.email;
          if(userEmail && state.currentRole !== 'owner') {
              const crew = state.data?.crew?.find(c => c.email === userEmail);
              const actor = state.data?.actors?.find(a => a.email === userEmail);
              if(crew && crew.role) {
                  roleTxt = crew.role;
              } else if(actor) {
                  roleTxt = 'ComÃ©dien.ne';
              }
          }
          
          els.roleBadge.innerText = roleTxt; 
          if(state.currentRole === 'viewer') { document.body.classList.add('read-only'); els.title.disabled = true; } else { document.body.classList.remove('read-only'); els.title.disabled = false; }
          
          // Appliquer les permissions sur les champs synopsis
          const canEditSynopsis = state.currentRole === 'owner' || Permissions.canEdit('synopsis');
          // Synopsis en mode chapitres - permissions gÃ©rÃ©es diffÃ©remment
          state.canEditSynopsis = canEditSynopsis;
          
          if(!canEditSynopsis) {
              // Synopsis en mode chapitres
          } else {
              // Synopsis en mode chapitres
          } 
          
          if(!window.appListenersAttached) { 
              els.title.addEventListener('input', () => { 
                  state.data.title = els.title.value; 
                  Store.updateTitle(els.title.value); 
                  // Synchroniser avec le titre du scÃ©nario
                  if(!state.data.titlePage) state.data.titlePage = {};
                  state.data.titlePage.title = els.title.value;
                  const tpTitleEl = document.getElementById('tp-title');
                  if(tpTitleEl) tpTitleEl.value = els.title.value;
              }); 
              // Synopsis en mode chapitres - Ã©vÃ©nements gÃ©rÃ©s par le module Synopsis 
              document.getElementById('btnSave').addEventListener('click', Store.save);
          
          // Protection contre la fermeture pendant une sauvegarde
          window.addEventListener('beforeunload', (e) => {
              if(state.savingInProgress) {
                  e.preventDefault();
                  e.returnValue = 'Une sauvegarde est en cours. Voulez-vous vraiment quitter ?';
                  return e.returnValue;
              }
          }); 
              document.getElementById('btnLoad').addEventListener('click', () => els.fileInput.click()); 
              els.fileInput.addEventListener('change', Store.importJSON); 
              document.getElementById('btnClear').addEventListener('click', Store.clearCurrent); 
              Utils.setupEnterNav(); Utils.setupAutocomplete(els.inpPerso); 
              els.boardList.addEventListener('dragover', e => UI.handleDragOver(e, els.boardList, '.card')); 
              els.scriptContainer.addEventListener('dragover', e => UI.handleDragOver(e, els.scriptContainer, '.script-row')); 
              document.addEventListener('click', (e) => { 
                  if(state.scriptAC.active && !els.scriptACList.contains(e.target)) ScriptEditor.hideAC(); 
                  if(els.bdCtxMenu.style.display === 'block' && !els.bdCtxMenu.contains(e.target)) els.bdCtxMenu.style.display = 'none'; 
                  if(els.tagCtxMenu.style.display === 'block' && !els.tagCtxMenu.contains(e.target)) els.tagCtxMenu.style.display = 'none'; 
              }); 
              window.appListenersAttached = true; 
          } 
          UI.renderAll(); UI.initHiddenTabs(); UI.switchTab('synopsis'); UI.initTabsDragDrop(); UI.initCategoriesDragDrop(); UI.loadCategoriesOrder(); UI.loadCategoryTabsOrder(); UI.initTabsMode(); UI.loadTabColors(); UI.initTabsContextMenu(); Synopsis.init();
          // Mettre Ã  jour les notifications et le badge de rÃ´le
          Notifications.updateBadge();
          Notifications.updateRoleBadge();
      },
      
      renderAll: () => { 
          if(!state.data.titlePage) state.data.titlePage = state.data.scriptMeta;
          els.title.value = state.data.title || ""; 
          // Synopsis avec Ã©diteur riche
          Synopsis.load('synopsis');
          Synopsis.load('short');
          Synopsis.load('long');
          if(els.boardSynopsis) els.boardSynopsis.innerText = state.data.synopsis || "(Vide)";
          if(els.boardShort) els.boardShort.innerText = state.data.synopsisShort || "(Vide)";
          if(els.boardLong) els.boardLong.innerText = state.data.synopsisLong || "(Vide)";
          UI.renderBoard(); UI.renderScript(); ScriptEditor.initViewMode(); UI.renderDataTab('characters', els.charContainer); UI.renderDataTab('actors', els.actorContainer); UI.renderDataTab('locations', els.locContainer); 
      },
      
      // V62: Affichage de la liste des snapshots dans la modale
      renderVersionList: () => {
          els.versionList.innerHTML = '';
          const snaps = state.data.snapshots || [];
          if(snaps.length === 0) {
              els.versionList.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sec)">Aucune sauvegarde disponible.<br><small>Les sauvegardes sont crÃ©Ã©es automatiquement.</small></div>';
              return;
          }
          
          snaps.forEach((snap, idx) => {
              const row = document.createElement('div');
              row.className = 'ver-row';
              const triggerIcon = snap.trigger === 'Manuel' ? 'ðŸ’¾' : 'ðŸ”„';
              const userShort = snap.user ? snap.user.split('@')[0] : 'Inconnu';
              row.innerHTML = `
                  <div class="ver-info">
                      <span class="ver-name">${triggerIcon} ${snap.dateDisplay || snap.date}</span>
                      <span class="ver-date">par ${Utils.escape(userShort)} ${snap.trigger === 'Manuel' ? '(manuel)' : '(auto)'}</span>
                  </div>
                  <div class="ver-actions">
                      <button onclick="app.Actions.restoreSnapshot(${idx})" style="color:var(--primary); border-color:var(--primary)">Restaurer</button>
                      <button onclick="app.Actions.deleteSnapshot(${idx})" style="color:var(--danger); border-color:var(--danger)">ðŸ—‘ï¸</button>
                  </div>
              `;
              els.versionList.appendChild(row);
          });
      },

      // Onglets masquÃ©s (par utilisateur en localStorage, pas partagÃ© entre membres)
      hiddenTabs: [],
      hiddenCategories: [],
      
      getUIStorageKey: (suffix) => {
          // ClÃ© unique par projet et par utilisateur
          const projectId = state.currentProjectId || 'default';
          return `fmp_ui_${projectId}_${suffix}`;
      },
      
      initHiddenTabs: () => {
          // Charger depuis localStorage (prÃ©fÃ©rence utilisateur, pas projet)
          try {
              const saved = localStorage.getItem(UI.getUIStorageKey('hiddenTabs'));
              UI.hiddenTabs = saved ? JSON.parse(saved) : [];
          } catch(e) {
              UI.hiddenTabs = [];
          }
          UI.applyHiddenTabs();
      },
      
      saveHiddenTabs: () => {
          // Sauvegarder en localStorage (par utilisateur)
          try {
              localStorage.setItem(UI.getUIStorageKey('hiddenTabs'), JSON.stringify(UI.hiddenTabs));
          } catch(e) {}
      },
      
      saveHiddenCategories: () => {
          // Sauvegarder en localStorage (par utilisateur)
          try {
              localStorage.setItem(UI.getUIStorageKey('hiddenCategories'), JSON.stringify(UI.hiddenCategories));
          } catch(e) {}
      },
      
      loadHiddenCategories: () => {
          // Charger depuis localStorage (prÃ©fÃ©rence utilisateur)
          try {
              const saved = localStorage.getItem(UI.getUIStorageKey('hiddenCategories'));
              UI.hiddenCategories = saved ? JSON.parse(saved) : [];
          } catch(e) {
              UI.hiddenCategories = [];
          }
      },
      
      hideTab: (tabName) => {
          if(UI.hiddenTabs.includes(tabName)) return;
          
          // EmpÃªcher de masquer le dernier onglet visible
          const allTabs = ['presentation', 'synopsis', 'board', 'titlepage', 'script', 'storyboard', 'chars', 'actors', 'locs', 'resources', 'crew', 'breakdown', 'stats', 'planning', 'expenses', 'chat'];
          const visibleTabs = allTabs.filter(t => !UI.hiddenTabs.includes(t) && t !== tabName);
          if(visibleTabs.length === 0) {
              Utils.toast('Impossible de masquer tous les onglets !', 'warning');
              return;
          }
          
          UI.hiddenTabs.push(tabName);
          
          // VÃ©rifier si tous les onglets d'une catÃ©gorie sont maintenant cachÃ©s
          for(const [cat, tabs] of Object.entries(UI.categoryTabs)) {
              const allTabsHidden = tabs.every(t => UI.hiddenTabs.includes(t));
              if(allTabsHidden && !UI.hiddenCategories.includes(cat)) {
                  UI.hiddenCategories.push(cat);
              }
          }
          
          UI.saveHiddenTabs();
          UI.saveHiddenCategories();
          UI.applyHiddenTabs();
          UI.applyHiddenCategories();
          
          // RafraÃ®chir la sous-navigation en mode catÃ©gories
          const navMode = (() => { try { return localStorage.getItem('fmp_nav_mode') || 'classic'; } catch(e) { return 'classic'; } })();
          if(navMode === 'categories') {
              if(UI.currentCategory) UI.switchCategory(UI.currentCategory);
          }
          
          // Si l'onglet masquÃ© Ã©tait actif, basculer vers le premier visible
          const activeTab = document.querySelector('.tab-btn.active');
          if(activeTab && activeTab.getAttribute('data-tab') === tabName) {
              UI.switchTab(visibleTabs[0]);
          }
          
          Utils.toast('Onglet masquÃ©', 'info');
      },
      
      toggleHiddenTabsCatMenu: (event, category) => {
          event.stopPropagation();
          const tabs = UI.categoryTabs[category] || [];
          const labels = UI.categoryLabels[category] || {};
          const hiddenInCategory = tabs.filter(t => UI.hiddenTabs.includes(t));
          
          if(hiddenInCategory.length === 0) return;
          
          // CrÃ©er ou rÃ©cupÃ©rer le menu
          let menu = document.getElementById('hiddenTabsCatMenu');
          if(!menu) {
              menu = document.createElement('div');
              menu.id = 'hiddenTabsCatMenu';
              menu.className = 'hidden-tabs-menu';
              document.body.appendChild(menu);
          }
          
          // Positionner le menu
          const rect = event.target.getBoundingClientRect();
          menu.style.left = rect.left + 'px';
          menu.style.top = (rect.bottom + 5) + 'px';
          
          // GÃ©nÃ©rer le contenu
          let menuHtml = `
              <div class="hidden-tabs-menu-header">
                  <span>Onglets masquÃ©s</span>
                  <button onclick="app.UI.showAllTabsInCategory('${category}')">Tout afficher</button>
              </div>
              <div class="hidden-tabs-menu-list">
          `;
          hiddenInCategory.forEach(tabName => {
              menuHtml += `<div class="hidden-tabs-menu-item" onclick="app.UI.showTab('${tabName}')">
                  <span>${labels[tabName] || tabName}</span>
                  <span class="text-primary">+ Afficher</span>
              </div>`;
          });
          menuHtml += '</div>';
          menu.innerHTML = menuHtml;
          menu.classList.add('visible');
          
          // Fermer au clic ailleurs
          setTimeout(() => {
              document.addEventListener('click', UI.closeHiddenTabsCatMenu, { once: true });
          }, 10);
      },
      
      closeHiddenTabsCatMenu: () => {
          const menu = document.getElementById('hiddenTabsCatMenu');
          if(menu) menu.classList.remove('visible');
      },
      
      showAllTabsInCategory: (category) => {
          const tabs = UI.categoryTabs[category] || [];
          tabs.forEach(tabName => {
              UI.hiddenTabs = UI.hiddenTabs.filter(t => t !== tabName);
          });
          UI.saveHiddenTabs();
          UI.applyHiddenTabs();
          UI.switchCategory(category);
          UI.closeHiddenTabsCatMenu();
          Utils.toast('Onglets restaurÃ©s', 'success');
      },
      
      // === GESTION DES CATÃ‰GORIES MASQUÃ‰ES ===
      hideCategory: (category) => {
          if(UI.hiddenCategories.includes(category)) return;
          
          // EmpÃªcher de masquer la derniÃ¨re catÃ©gorie
          const allCategories = ['ecriture', 'casting', 'production', 'admin'];
          const visibleCategories = allCategories.filter(c => !UI.hiddenCategories.includes(c) && c !== category);
          if(visibleCategories.length === 0) {
              Utils.toast('Impossible de masquer toutes les catÃ©gories !', 'warning');
              return;
          }
          
          UI.hiddenCategories.push(category);
          
          // Cacher aussi tous les onglets de cette catÃ©gorie (pour synchroniser avec vue classique)
          const tabsInCategory = UI.categoryTabs[category] || [];
          tabsInCategory.forEach(tab => {
              if(!UI.hiddenTabs.includes(tab)) {
                  UI.hiddenTabs.push(tab);
              }
          });
          
          UI.saveHiddenCategories();
          UI.saveHiddenTabs();
          UI.applyHiddenCategories();
          UI.applyHiddenTabs();
          
          // Si la catÃ©gorie masquÃ©e Ã©tait active, basculer vers la premiÃ¨re visible
          if(UI.currentCategory === category) {
              UI.switchCategory(visibleCategories[0]);
          }
          
          Utils.toast('CatÃ©gorie masquÃ©e', 'info');
      },
      
      showCategory: (category) => {
          UI.hiddenCategories = UI.hiddenCategories.filter(c => c !== category);
          
          // Restaurer aussi tous les onglets de cette catÃ©gorie
          const tabsInCategory = UI.categoryTabs[category] || [];
          UI.hiddenTabs = UI.hiddenTabs.filter(t => !tabsInCategory.includes(t));
          
          UI.saveHiddenCategories();
          UI.saveHiddenTabs();
          UI.applyHiddenCategories();
          UI.applyHiddenTabs();
          UI.switchCategory(category);
          UI.closeHiddenCategoriesMenu();
          Utils.toast('CatÃ©gorie restaurÃ©e', 'success');
      },
      
      showAllCategories: () => {
          // Restaurer toutes les catÃ©gories et leurs onglets
          const allCategoryTabs = Object.values(UI.categoryTabs).flat();
          UI.hiddenTabs = UI.hiddenTabs.filter(t => !allCategoryTabs.includes(t));
          UI.hiddenCategories = [];
          UI.saveHiddenCategories();
          UI.saveHiddenTabs();
          UI.applyHiddenCategories();
          UI.applyHiddenTabs();
          Utils.toast('Toutes les catÃ©gories sont visibles', 'success');
      },
      
      showAllHidden: () => {
          UI.hiddenCategories = [];
          UI.hiddenTabs = [];
          UI.saveHiddenCategories();
          UI.saveHiddenTabs();
          UI.applyHiddenCategories();
          UI.applyHiddenTabs();
          if(UI.currentCategory) UI.switchCategory(UI.currentCategory);
          UI.closeHiddenCategoriesMenu();
          Utils.toast('Tous les Ã©lÃ©ments sont visibles', 'success');
      },
      
      applyHiddenCategories: () => {
          // Masquer/afficher les catÃ©gories
          document.querySelectorAll('.tab-category[data-category]').forEach(cat => {
              const catName = cat.getAttribute('data-category');
              cat.style.display = UI.hiddenCategories.includes(catName) ? 'none' : '';
          });
          
          // Mettre Ã  jour le bouton des Ã©lÃ©ments masquÃ©s (catÃ©gories + onglets)
          const toggle = document.getElementById('hiddenCategoriesToggle');
          const countBadge = document.getElementById('hiddenCategoriesCount');
          
          if(toggle && countBadge) {
              const totalHidden = UI.hiddenCategories.length + UI.hiddenTabs.length;
              if(totalHidden > 0) {
                  toggle.style.display = 'flex';
                  countBadge.textContent = totalHidden;
              } else {
                  toggle.style.display = 'none';
              }
          }
      },
      
      toggleHiddenCategoriesMenu: (event) => {
          event.stopPropagation();
          
          const categoryLabels = {
              'ecriture': 'ðŸ“ Ã‰criture',
              'casting': 'ðŸŽ­ Casting & DÃ©cors',
              'production': 'ðŸŽ¬ Production',
              'admin': 'ðŸ“Š Admin'
          };
          
          const tabLabels = {
              'presentation': 'PrÃ©sentation', 'synopsis': 'Synopsis', 'board': 'SÃ©quencier',
              'titlepage': 'Titre', 'script': 'ScÃ©nario', 'storyboard': 'Storyboard', 'chars': 'Personnages',
              'actors': 'ComÃ©dien.nes', 'locs': 'DÃ©cors', 'resources': 'Ressources', 'crew': 'Ã‰quipes',
              'breakdown': 'DÃ©pouillement', 'stats': 'Statistiques', 'planning': 'Planning',
              'scriptreport': 'Rapport', 'expenses': 'DÃ©penses', 'chat': 'Chat'
          };
          
          const hasHiddenCategories = UI.hiddenCategories.length > 0;
          const hasHiddenTabs = UI.hiddenTabs.length > 0;
          
          if(!hasHiddenCategories && !hasHiddenTabs) return;
          
          // CrÃ©er ou rÃ©cupÃ©rer le menu
          let menu = document.getElementById('hiddenCategoriesMenu');
          if(!menu) {
              menu = document.createElement('div');
              menu.id = 'hiddenCategoriesMenu';
              menu.className = 'hidden-tabs-menu';
              document.body.appendChild(menu);
          }
          
          // Positionner le menu
          const rect = event.target.getBoundingClientRect();
          menu.style.left = Math.min(rect.left, window.innerWidth - 250) + 'px';
          menu.style.top = (rect.bottom + 5) + 'px';
          
          // GÃ©nÃ©rer le contenu
          let menuHtml = `
              <div class="hidden-tabs-menu-header">
                  <span>Ã‰lÃ©ments masquÃ©s</span>
                  <button onclick="app.UI.showAllHidden()">Tout afficher</button>
              </div>
              <div class="hidden-tabs-menu-list">
          `;
          
          // CatÃ©gories masquÃ©es
          if(hasHiddenCategories) {
              menuHtml += `<div style="font-size:0.75rem; color:var(--text-sec); padding:8px 12px; border-bottom:1px solid var(--border);">ðŸ“ CatÃ©gories</div>`;
              UI.hiddenCategories.forEach(catName => {
                  menuHtml += `<div class="hidden-tabs-menu-item" onclick="app.UI.showCategory('${catName}')">
                      <span>${categoryLabels[catName] || catName}</span>
                      <span class="text-primary">+ Afficher</span>
                  </div>`;
              });
          }
          
          // Onglets masquÃ©s
          if(hasHiddenTabs) {
              menuHtml += `<div style="font-size:0.75rem; color:var(--text-sec); padding:8px 12px; border-bottom:1px solid var(--border); ${hasHiddenCategories ? 'margin-top:5px;' : ''}">ðŸ“‘ Onglets</div>`;
              UI.hiddenTabs.forEach(tabName => {
                  menuHtml += `<div class="hidden-tabs-menu-item" onclick="app.UI.showTab('${tabName}')">
                      <span>${tabLabels[tabName] || tabName}</span>
                      <span class="text-primary">+ Afficher</span>
                  </div>`;
              });
          }
          
          menuHtml += '</div>';
          menu.innerHTML = menuHtml;
          menu.classList.add('visible');
          
          // Fermer au clic ailleurs
          setTimeout(() => {
              document.addEventListener('click', UI.closeHiddenCategoriesMenu, { once: true });
          }, 10);
      },
      
      closeHiddenCategoriesMenu: () => {
          const menu = document.getElementById('hiddenCategoriesMenu');
          if(menu) menu.classList.remove('visible');
      },
      
      showTab: (tabName) => {
          UI.hiddenTabs = UI.hiddenTabs.filter(t => t !== tabName);
          
          // Restaurer la catÃ©gorie correspondante si elle Ã©tait cachÃ©e
          for(const [cat, tabs] of Object.entries(UI.categoryTabs)) {
              if(tabs.includes(tabName) && UI.hiddenCategories.includes(cat)) {
                  UI.hiddenCategories = UI.hiddenCategories.filter(c => c !== cat);
              }
          }
          
          UI.saveHiddenTabs();
          UI.saveHiddenCategories();
          UI.applyHiddenTabs();
          UI.applyHiddenCategories();
          UI.switchTab(tabName);
          Utils.toast('Onglet restaurÃ©', 'success');
      },
      
      showAllTabs: () => {
          UI.hiddenTabs = [];
          UI.hiddenCategories = [];
          UI.saveHiddenTabs();
          UI.saveHiddenCategories();
          UI.applyHiddenTabs();
          UI.applyHiddenCategories();
          Utils.toast('Tous les onglets sont visibles', 'success');
      },
      
      applyHiddenTabs: () => {
          const tabLabels = {
              'presentation': '1. PRÃ‰SENTATION', 'synopsis': '2. SYNOPSIS', 'board': '3. SÃ‰QUENCIER',
              'titlepage': '4. TITRE', 'script': '5. SCÃ‰NARIO', 'moodboard': '6. MOOD BOARD', 'storyboard': '7. STORYBOARD', 'chars': '8. PERSONNAGES',
              'actors': '9. COMÃ‰DIEN.NES', 'locs': '10. DÃ‰CORS', 'resources': '11. RESSOURCES', 'crew': '12. Ã‰QUIPES',
              'breakdown': '13. DÃ‰POUILLEMENT', 'stats': '14. STATISTIQUES', 'planning': '15. PLANNING',
              'expenses': '16. DÃ‰PENSES', 'chat': '17. CHAT'
          };
          
          // Masquer/afficher les onglets
          document.querySelectorAll('.tab-btn[data-tab]').forEach(tab => {
              const tabName = tab.getAttribute('data-tab');
              tab.style.display = UI.hiddenTabs.includes(tabName) ? 'none' : '';
          });
          
          // Mettre Ã  jour le bouton et le menu des onglets masquÃ©s
          const toggle = document.getElementById('hiddenTabsToggle');
          const countBadge = document.getElementById('hiddenTabsCount');
          const menu = document.getElementById('hiddenTabsMenu');
          
          if(UI.hiddenTabs.length > 0) {
              toggle.style.display = '';
              countBadge.textContent = UI.hiddenTabs.length;
              
              // GÃ©nÃ©rer le menu
              let menuHtml = `
                  <div class="hidden-tabs-menu-header">
                      <span>Onglets masquÃ©s</span>
                      <button onclick="app.UI.showAllTabs()">Tout afficher</button>
                  </div>
                  <div class="hidden-tabs-menu-list">
              `;
              UI.hiddenTabs.forEach(tabName => {
                  menuHtml += `<div class="hidden-tabs-menu-item" onclick="app.UI.showTab('${tabName}')">
                      <span>${tabLabels[tabName] || tabName}</span>
                      <span style="color:var(--success);">â†©</span>
                  </div>`;
              });
              menuHtml += '</div>';
              menu.innerHTML = menuHtml;
          } else {
              toggle.style.display = 'none';
              menu.classList.remove('visible');
          }
          
          // Synchroniser avec la vue catÃ©gories
          const navMode = (() => { try { return localStorage.getItem('fmp_nav_mode') || 'classic'; } catch(e) { return 'classic'; } })();
          if(navMode === 'categories' && UI.currentCategory) {
              UI.switchCategory(UI.currentCategory);
          }
      },
      
      toggleHiddenTabsMenu: (event) => {
          const menu = document.getElementById('hiddenTabsMenu');
          
          // Si dÃ©jÃ  visible, fermer
          if(menu.classList.contains('visible')) {
              menu.classList.remove('visible');
              return;
          }
          
          // Positionner prÃ¨s du bouton cliquÃ©
          const rect = event.target.closest('.tab-btn-hidden-toggle').getBoundingClientRect();
          menu.style.top = (rect.bottom + 5) + 'px';
          menu.style.left = Math.min(rect.left, window.innerWidth - 240) + 'px';
          
          menu.classList.add('visible');
          
          // Fermer au clic extÃ©rieur
          setTimeout(() => {
              document.addEventListener('click', UI.closeHiddenTabsMenu);
          }, 10);
      },
      
      closeHiddenTabsMenu: (e) => {
          const menu = document.getElementById('hiddenTabsMenu');
          const toggle = document.getElementById('hiddenTabsToggle');
          if(!menu.contains(e?.target) && !toggle.contains(e?.target)) {
              menu.classList.remove('visible');
              document.removeEventListener('click', UI.closeHiddenTabsMenu);
          }
      },

      switchTab: (tabName) => { 
    // Mapping des onglets vers les sections de permissions
    const tabToSection = {
        'presentation': 'presentation', 'synopsis': 'synopsis', 'board': 'sequencier', 'titlepage': 'scenario',
        'script': 'scenario', 'storyboard': 'storyboard', 'chars': 'personnages', 'locs': 'lieux',
        'actors': 'comediens', 'resources': 'ressources', 'crew': 'equipe', 'breakdown': 'depouillement',
        'stats': 'stats', 'planning': 'planning'
    };
    
    const section = tabToSection[tabName];
    
    // VÃ©rifier les permissions (sauf pour le propriÃ©taire)
    if(state.currentRole !== 'owner' && section && !Permissions.canAccess(section)) {
        Utils.toast('Vous n\'avez pas accÃ¨s Ã  cette section.', 'error');
        return;
    }
    
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); 
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); 
    document.getElementById('tab-' + tabName).classList.add('active'); 
    const idx = ['presentation', 'synopsis','board', 'titlepage', 'script', 'storyboard', 'chars', 'actors', 'locs', 'resources', 'crew', 'breakdown', 'stats', 'planning', 'expenses', 'chat'].indexOf(tabName); 
    if(idx > -1) document.querySelectorAll('.tab-btn')[idx].classList.add('active');
    
    // Synchroniser avec le mode catÃ©gories si actif
    const tabsCategories = document.getElementById('tabsCategories');
    if(tabsCategories && tabsCategories.classList.contains('active')) {
        const category = UI.getCategoryForTab(tabName);
        if(category !== UI.currentCategory) {
            UI.currentCategory = category;
            document.querySelectorAll('.tab-category').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
            // Reconstruire la sous-nav
            const subnav = document.getElementById('tabsSubnav');
            const tabs = UI.categoryTabs[category] || [];
            const labels = UI.categoryLabels[category] || {};
            subnav.innerHTML = tabs.map(tab => {
                return `<button class="tab-subbtn${tab === tabName ? ' active' : ''}" data-tab="${tab}" onclick="app.UI.switchTab('${tab}')">${labels[tab] || tab}</button>`;
            }).join('');
        }
        // Mettre Ã  jour le bouton actif dans la sous-nav
        document.querySelectorAll('.tab-subbtn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
    }
          
          if(tabName === 'board' || tabName === 'script') {
              els.quickNav.style.display = 'flex';
              UI.updateQuickNav();
          } else {
              els.quickNav.style.display = 'none';
          }
          if(tabName === 'script') UI.renderScript(); 
          if(tabName === 'board') UI.renderBoard(); 
          if(tabName === 'chars') { Actions.syncCharacters(); Store.save(); UI.renderDataTab('characters', els.charContainer); } 
          if(tabName === 'actors') { Actions.syncActorsFromPublicProfiles().then(() => UI.renderDataTab('actors', els.actorContainer)); } 
          if(tabName === 'locs') { Actions.syncLocations(); Store.save(); UI.renderDataTab('locations', els.locContainer); } 
          if(tabName === 'resources') { Resources.init(); }
          if(tabName === 'breakdown') { Crew.syncEssentialCrewToScenes(); Store.save(); Breakdown.init(); } 
          if(tabName === 'planning') { Planning.init(); Planning.applyPermissions(); }
          if(tabName === 'scriptreport') { ScriptReport.init(); }
          if(tabName === 'stats') Stats.render();
          if(tabName === 'titlepage') TitlePage.load(); 
          if(tabName === 'storyboard') Storyboard.init();
          if(tabName === 'moodboard') MoodBoard.init();
          if(tabName === 'crew') { Actions.syncCrewFromPublicProfiles().then(() => UI.renderCrewTab()); }
          if(tabName === 'chat') Chat.init();
          if(tabName === 'expenses') Expenses.init();
          if(tabName === 'presentation') Presentation.init();
      },
      
      // Ouvre le menu dÃ©roulant pour changer le statut d'une scÃ¨ne
      toggleSceneStatus: (sceneId, event) => {
          if(state.currentRole === 'viewer') return;
          event.stopPropagation();
          
          // Fermer tout menu ouvert et le supprimer
          document.querySelectorAll('.scene-status-dropdown').forEach(d => d.remove());
          
          // CrÃ©er le dropdown dans le body pour Ã©viter les problÃ¨mes d'overflow
          const rect = event.target.getBoundingClientRect();
          
          const dropdown = document.createElement('div');
          dropdown.className = 'scene-status-dropdown visible';
          dropdown.style.top = (rect.bottom + 5) + 'px';
          dropdown.style.left = rect.left + 'px';
          dropdown.innerHTML = `
              <div class="scene-status-option" onclick="event.stopPropagation(); app.UI.setSceneStatus('${sceneId}', 'not-verified')">
                  <span class="status-dot not-verified"></span> Non vÃ©rifiÃ©
              </div>
              <div class="scene-status-option" onclick="event.stopPropagation(); app.UI.setSceneStatus('${sceneId}', 'to-work')">
                  <span class="status-dot to-work"></span> Ã€ travailler
              </div>
              <div class="scene-status-option" onclick="event.stopPropagation(); app.UI.setSceneStatus('${sceneId}', 'verified')">
                  <span class="status-dot verified"></span> VÃ©rifiÃ©
              </div>
          `;
          document.body.appendChild(dropdown);
          
          // Fermer au clic ailleurs
          setTimeout(() => {
              const closeHandler = (e) => {
                  if(!dropdown.contains(e.target)) {
                      dropdown.remove();
                      document.removeEventListener('click', closeHandler);
                  }
              };
              document.addEventListener('click', closeHandler);
          }, 10);
      },
      
      // Changer le statut d'une scÃ¨ne via menu
      setSceneStatus: (sceneId, status) => {
          if(state.currentRole === 'viewer') return;
          
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          
          scene.status = status;
          Store.save();
          
          // Supprimer le dropdown
          document.querySelectorAll('.scene-status-dropdown').forEach(d => d.remove());
          
          UI.renderScript();
          UI.renderBoard();
          Breakdown.init();
          Storyboard.renderScenesList();
          Storyboard.renderScenesList();
          
          const statusMessages = { 'not-verified': 'Non vÃ©rifiÃ©', 'to-work': 'Ã€ travailler', 'verified': 'VÃ©rifiÃ©' };
          Utils.toast(`ScÃ¨ne : ${statusMessages[status]}`, 'success');
      },
      
      updateQuickNav: () => {
          els.quickNav.innerHTML = '';
          state.data.scenes.forEach((s, i) => {
              const a = document.createElement('div');
              a.className = 'qn-link';
              a.innerText = (i + 1);
              a.title = s.title;
              a.onclick = () => {
                  const activeTab = document.querySelector('.tab-content.active').id;
                  if(activeTab === 'tab-script') {
                      // VÃ©rifier si on est en Vue ScÃ¨nes ou Vue Script Continue
                      const isContinuousView = document.getElementById('scriptContinuousContainer')?.style.display !== 'none';
                      if(isContinuousView) {
                          // Vue Script Continue
                          const el = document.querySelector(`.script-continuous-scene[data-scene-id="${s.id}"]`);
                          if(el) {
                              el.scrollIntoView({behavior: "smooth", block: "start"});
                              ScriptEditor.setActiveScene(s.id, i);
                          }
                      } else {
                          // Vue ScÃ¨nes
                          const el = document.querySelector(`.script-row[data-id="${s.id}"]`);
                          if(el) el.scrollIntoView({behavior: "smooth", block: "start"});
                      }
                  } else if (activeTab === 'tab-board') {
                       const el = document.querySelector(`.card[data-id="${s.id}"]`);
                       if(el) el.scrollIntoView({behavior: "smooth", block: "center"});
                  }
              };
              els.quickNav.appendChild(a);
          });
      },
      
      renderBoard: () => { 
          els.boardList.innerHTML = ''; 
          const isView = state.currentRole === 'viewer'; 
          state.data.scenes.forEach((s, idx) => { 
              const el = document.createElement('div'); 
              const isFinal = s.isFinal === true;
              el.className = 'card ' + (isFinal ? 'is-final' : 'is-draft'); 
              el.draggable = !isView; el.dataset.id = s.id; 
              const tag = state.data.tags.find(t => t.id === s.tag_id) || {name:'', color: 'transparent'}; 
              if(tag.color !== 'transparent') el.style.borderLeftColor = tag.color; 
              const badge = tag.color !== 'transparent' ? `<span class="tag-badge" style="background:${tag.color}" title="${Utils.escape(tag.name)}"></span>` : ''; 
              const commentBtn = `<span class="comment-badge d-none" data-scene="${s.id}" onclick="event.stopPropagation(); app.Comments.open('${s.id}')" title="Commentaires">0</span>`;
              const sceneStatus = s.status || 'not-verified';
              const statusBadge = `<div class="scene-status-container"><span class="scene-status-badge ${sceneStatus}" onclick="app.UI.toggleSceneStatus('${s.id}', event)">${SCENE_STATUS_LABELS[sceneStatus]}</span></div>`;
              const finalBadge = isFinal ? `<span class="scene-status-badge final">âœ… Finale</span>` : `<span class="scene-status-badge draft">ðŸ“ Brouillon</span>`;
              const finalizeBtn = isView ? '' : (isFinal 
                  ? `<button class="unfinalize-btn" onclick="event.stopPropagation(); app.Actions.unfinalizeScene('${s.id}')">ðŸ“ Repasser en brouillon</button>`
                  : `<button class="finalize-btn" onclick="event.stopPropagation(); app.Actions.finalizeScene('${s.id}')">âœ… Finaliser</button>`);
              const actions = isView ? '' : `<div class="card-actions"><button onclick="event.stopPropagation(); app.Actions.editScene('${s.id}')">âœï¸</button><button onclick="event.stopPropagation(); app.Actions.deleteScene('${s.id}')" style="color:var(--danger);border-color:var(--danger)">ðŸ—‘ï¸</button></div>`; 
              el.innerHTML = `${actions}<h3>${badge}${Utils.escape(s.title)} <small>#${idx + 1}</small> ${finalBadge}${commentBtn}</h3><div style="margin: 5px 0;">${statusBadge}</div><div class="meta">${Utils.escape(s.perso)} â€¢ ${Utils.escape(s.time)} min</div><div class="resume-text">${Utils.escape(s.resume)}</div><div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;"><button onclick="event.stopPropagation(); app.Comments.open('${s.id}')" style="padding:5px 10px; background:var(--bg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:0.8rem;">ðŸ’¬ Commentaires</button>${finalizeBtn}</div>`; 
              if(!isView) { 
                  el.addEventListener('contextmenu', (e) => Actions.openTagMenu(e, s.id)); 
                  el.addEventListener('dragstart', ()=>el.classList.add('dragging')); 
                  el.addEventListener('dragend', ()=>{el.classList.remove('dragging'); Actions.updateOrder('board');}); 
              } 
              els.boardList.appendChild(el); 
          }); 
          UI.updateQuickNav();
          UI.loadBoardMode();
          Comments.updateAllBadges();
      },
      
      renderScript: () => { 
          // Si vue continue active, mettre Ã  jour aussi cette vue
          if(ScriptEditor.viewMode === 'continuous') {
              ScriptEditor.renderContinuous();
          }
          
          const focusedId = document.activeElement && document.activeElement.closest('.script-row') ? document.activeElement.closest('.script-row').dataset.id : null; 
          els.scriptContainer.innerHTML = ''; 
          if(state.data.scenes.length === 0) { els.scriptContainer.innerHTML = '<div style="text-align:center;margin-top:50px;color:var(--text-sec)">Ajoutez des scÃ¨nes pour commencer.</div>'; return; } 
          const isView = state.currentRole === 'viewer' || !Permissions.canEdit('scenario'); 
          state.data.scenes.forEach((scene, idx) => { 
              const row = document.createElement('div'); 
              const sceneIsFinal = scene.isFinal === true;
              row.className = 'script-row ' + (sceneIsFinal ? 'is-final' : 'is-draft'); 
              row.draggable = false; row.dataset.id = scene.id; 
              const contentHtml = scene.scriptContent || "<div class='sc-action'><br></div>"; 
              const tag = state.data.tags.find(t => t.id === scene.tag_id) || {name:'', color: 'transparent'}; 
              const infoStyle = tag.color !== 'transparent' ? `border-left-color:${tag.color}` : ''; 
              const badge = tag.color !== 'transparent' ? `<span class="tag-badge" style="background:${tag.color}" title="${Utils.escape(tag.name)}"></span>` : ''; 
              
              const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
              const versionCount = scene.versions ? scene.versions.length : 0;
              const sceneStatus = scene.status || 'not-verified';
              const statusBadge = `<div class="scene-status-container ml-10"><span class="scene-status-badge ${sceneStatus}" onclick="app.UI.toggleSceneStatus('${scene.id}', event)">${SCENE_STATUS_LABELS[sceneStatus]}</span></div>`;
              const isFinal = scene.isFinal === true;
              const finalBadge = isFinal ? `<span class="scene-status-badge final">âœ… Finale</span>` : `<span class="scene-status-badge draft">ðŸ“ Brouillon</span>`;
              const finalizeBtn = isView ? '' : (isFinal 
                  ? `<button class="unfinalize-btn w-full" onclick="event.stopPropagation(); app.Actions.unfinalizeScene('${scene.id}')">ðŸ“ Repasser en brouillon</button>`
                  : `<button class="finalize-btn w-full" onclick="event.stopPropagation(); app.Actions.finalizeScene('${scene.id}')">âœ… Finaliser cette scÃ¨ne</button>`);
              const sidebarBtns = `
                  <div class="script-sidebar-btns">
                      <button onclick="event.stopPropagation(); app.StoryboardPreview.open('${scene.id}')">ðŸ“· Storyboard (${shotCount})</button>
                      <button onclick="event.stopPropagation(); app.Comments.open('${scene.id}')">ðŸ’¬ Commentaires <span class="comment-badge d-none" data-scene="${scene.id}">0</span></button>
                      <hr class="hr-subtle">
                      <button onclick="event.stopPropagation(); app.SceneVersions.save('${scene.id}')">ðŸ“¸ Sauvegarder version</button>
                      <button onclick="event.stopPropagation(); app.SceneVersions.openModal('${scene.id}')">ðŸ“œ Historique${versionCount > 0 ? ' (' + versionCount + ')' : ''}</button>
                      <hr class="hr-subtle">
                      <div style="text-align:center; margin-bottom:5px;">${finalBadge}</div>
                      ${finalizeBtn}
                      <hr class="hr-subtle">
                      <button onclick="event.stopPropagation(); app.ScriptEditor.openSearchReplace()">ðŸ” Rechercher</button>
                      <button onclick="event.stopPropagation(); app.ScriptImport.openModal()">ðŸ“„ Importer PDF/FDX</button>
                  </div>
              `;
              row.innerHTML = `<div class="lock-overlay">ðŸ”’</div><div class="script-info-col" style="${infoStyle}"><h3 style="cursor:context-menu; display:flex; align-items:center; flex-wrap:wrap;">${badge}${Utils.escape(scene.title)}${statusBadge}</h3><div style="margin-bottom:10px;font-size:0.8em">#${idx+1} â€¢ ${Utils.escape(scene.time)} min</div><div style="margin-bottom:10px; font-size:0.85rem; color:var(--text-main); font-weight:normal;">${Utils.escape(scene.perso)}</div><strong>RÃ©sumÃ©:</strong><p>${Utils.escape(scene.resume)||'-'}</p>${sidebarBtns}</div><div class="script-write-col"><div class="scene-heading-print">${Utils.escape(scene.title)}</div><div class="format-bar scene-format-bar d-none" id="toolbar-${scene.id}"><button class="fmt-btn nav-btn" onclick="app.ScriptEditor.goToScene(${idx - 1})" ${idx === 0 ? 'disabled style="opacity:0.4"' : ''} title="ScÃ¨ne prÃ©cÃ©dente">â¬…ï¸</button><button class="fmt-btn active" data-type="sc-action" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-action', event)" title="Action">Action</button><button class="fmt-btn" data-type="sc-perso" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-perso', event)" title="Personnage">Perso</button><button class="fmt-btn" data-type="sc-dial" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-dial', event)" title="Dialogue">Dial</button><button class="fmt-btn" data-type="sc-paren" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-paren', event)" title="Didascalie">Didas</button><button class="fmt-btn" data-type="sc-trans" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-trans', event)" title="Transition">Trans</button><button class="fmt-btn" data-type="sc-centered" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-centered', event)" title="CentrÃ©">CentrÃ©</button><button class="fmt-btn" data-type="sc-note" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-note', event)" title="Note">Note</button><span class="scene-nav-indicator">${idx + 1}/${state.data.scenes.length}</span><button class="fmt-btn" onclick="app.ScriptEditor.insertSceneAfter(${idx})" title="InsÃ©rer nouvelle scÃ¨ne aprÃ¨s">âž•</button><button class="fmt-btn nav-btn" onclick="app.ScriptEditor.goToScene(${idx + 1})" ${idx === state.data.scenes.length - 1 ? 'disabled style="opacity:0.4"' : ''} title="ScÃ¨ne suivante">âž¡ï¸</button></div><div class="script-editor-box" contenteditable="${!isView}" spellcheck="true" lang="fr" id="editor-${scene.id}">${contentHtml}</div></div>`;
              els.scriptContainer.appendChild(row); 
              if(!isView) { 
                  const handle = row.querySelector('.script-info-col'); 
                  handle.addEventListener('contextmenu', (e) => Actions.openTagMenu(e, scene.id)); 
                  handle.addEventListener('mousedown', (e) => { if(e.button===0) row.setAttribute('draggable', 'true'); }); 
                  handle.addEventListener('mouseup', () => row.setAttribute('draggable', 'false')); 
                  row.addEventListener('dragstart', () => row.classList.add('dragging')); 
                  row.addEventListener('dragend', () => { row.classList.remove('dragging'); row.setAttribute('draggable', 'false'); Actions.updateOrder('script'); }); 
                  const editor = document.getElementById(`editor-${scene.id}`); const toolbar = document.getElementById(`toolbar-${scene.id}`); 
                  editor.addEventListener('input', () => { const s = state.data.scenes.find(x => x.id === scene.id); if(s) s.scriptContent = editor.innerHTML; ScriptEditor.checkAC(editor); Store.updateScene(scene.id, editor.innerHTML); }); 
                  ['keyup', 'mouseup', 'click'].forEach(evt => editor.addEventListener(evt, () => ScriptEditor.updateToolbar(editor, toolbar))); 
                  editor.addEventListener('keydown', (e) => ScriptEditor.handleKey(e, editor, toolbar, scene.id)); 
                  editor.addEventListener('focus', () => Store.acquireLock(scene.id)); 
                  editor.addEventListener('blur', () => Store.releaseLock(scene.id)); 
              } 
          }); 
          UI.applyLocks(); 
          UI.updateQuickNav();
          Comments.updateAllBadges();
      },
      
      renderDataTab: (type, container) => {
          const arr = state.data[type]; container.innerHTML = '';
          if(!arr || arr.length === 0) { 
              const emptyStates = {
                  characters: {
                      icon: 'ðŸŽ­',
                      title: 'Aucun personnage',
                      desc: 'Ajoutez les personnages de votre histoire. Ils pourront ensuite Ãªtre liÃ©s aux comÃ©diens et apparaÃ®tront dans le dÃ©pouillement.',
                      btn: '+ Ajouter un personnage',
                      action: 'app.Actions.addDataItem(\'characters\')'
                  },
                  actors: {
                      icon: 'ðŸŽ¬',
                      title: 'Aucun comÃ©dien',
                      desc: 'Constituez votre casting en ajoutant des comÃ©diens. Vous pourrez les associer aux personnages et gÃ©rer leurs disponibilitÃ©s.',
                      btn: '+ Ajouter un comÃ©dien',
                      action: 'app.Actions.addDataItem(\'actors\')'
                  },
                  locations: {
                      icon: 'ðŸ ',
                      title: 'Aucun dÃ©cor',
                      desc: 'Ajoutez les dÃ©cors de votre scÃ©nario. Vous pourrez ensuite renseigner les lieux rÃ©els de tournage avec adresse et contact.',
                      btn: '+ Ajouter un dÃ©cor',
                      action: 'app.Actions.addDataItem(\'locations\')'
                  }
              };
              const es = emptyStates[type] || { icon: 'ðŸ“', title: 'Aucune donnÃ©e', desc: '', btn: '+ Ajouter', action: '' };
              container.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">${es.icon}</div>
                      <div class="empty-state-title">${es.title}</div>
                      <div class="empty-state-desc">${es.desc}</div>
                      <button class="empty-state-btn" onclick="${es.action}">${es.btn}</button>
                      <div class="empty-state-tips">ðŸ’¡ <strong>Astuce :</strong> Vous pouvez aussi importer depuis un scÃ©nario existant via le menu Fichier.</div>
                  </div>
              `;
              return; 
          } 
          
          // DÃ©terminer les permissions selon le type
          const typeToSection = { 'characters': 'personnages', 'actors': 'comediens', 'locations': 'lieux' };
          const sectionName = typeToSection[type];
          const isView = state.currentRole === 'viewer' || (sectionName && !Permissions.canEdit(sectionName)); 
          let groupType = '';
          if(type === 'characters') groupType = 'perso'; else if(type === 'actors') groupType = 'actor'; else if(type === 'locations') groupType = 'lieu';

          const relevantGroups = state.data.groups.filter(g => g.type === groupType);
          
          // Barre de toggle vue compacte / dÃ©taillÃ©e
          const viewMode = CardModal.getViewMode(type);
          const toggleBar = document.createElement('div');
          toggleBar.className = 'view-toggle-bar';
          toggleBar.innerHTML = `
              <button class="view-toggle-btn ${viewMode === 'compact' ? 'active' : ''}" onclick="app.CardModal.setViewMode('${type}', 'compact')">ðŸ”² Compact</button>
              <button class="view-toggle-btn ${viewMode === 'detailed' ? 'active' : ''}" onclick="app.CardModal.setViewMode('${type}', 'detailed')">ðŸ“‹ DÃ©taillÃ©</button>
          `;
          container.appendChild(toggleBar);
          
          if(viewMode === 'compact') {
              // Vue compacte : grille de petites cartes
              relevantGroups.forEach(grp => {
                  const itemsInGroup = arr.filter(item => item.group_id === grp.id);
                  if(itemsInGroup.length > 0) {
                      const section = document.createElement('div'); section.className = 'group-section';
                      section.innerHTML = `<div class="group-header">${Utils.escape(grp.name)}</div><div class="compact-cards-grid"></div>`;
                      const grid = section.querySelector('.compact-cards-grid');
                      CardModal.renderCompactCards(itemsInGroup, type, grid);
                      container.appendChild(section);
                  }
              });
              const noGroup = arr.filter(item => !item.group_id || !relevantGroups.find(g => g.id === item.group_id));
              if(noGroup.length > 0) {
                  const section = document.createElement('div'); section.className = 'group-section';
                  section.innerHTML = `<div class="group-header text-sec">Non classÃ©</div><div class="compact-cards-grid"></div>`;
                  const grid = section.querySelector('.compact-cards-grid');
                  CardModal.renderCompactCards(noGroup, type, grid);
                  container.appendChild(section);
              }
          } else {
              // Vue dÃ©taillÃ©e : fiches complÃ¨tes (ancien mode)
              relevantGroups.forEach(grp => {
                  const itemsInGroup = arr.filter(item => item.group_id === grp.id);
                  if(itemsInGroup.length > 0) {
                      const section = document.createElement('div'); section.className = 'group-section';
                      section.innerHTML = `<div class="group-header">${Utils.escape(grp.name)}</div><div class="data-grid"></div>`;
                      const grid = section.querySelector('.data-grid');
                      UI.renderDataCards(itemsInGroup, type, grid, relevantGroups);
                      container.appendChild(section);
                  }
              });
              const noGroup = arr.filter(item => !item.group_id || !relevantGroups.find(g => g.id === item.group_id));
              if(noGroup.length > 0) {
                  const section = document.createElement('div'); section.className = 'group-section';
                  section.innerHTML = `<div class="group-header text-sec">Non classÃ©</div><div class="data-grid"></div>`;
                  const grid = section.querySelector('.data-grid');
                  UI.renderDataCards(noGroup, type, grid, relevantGroups);
                  container.appendChild(section);
              }
          }
      },
      
      renderDataCards: (items, type, container, availableGroups) => {
          const isView = state.currentRole === 'viewer';
          items.forEach((item) => { 
              const idx = state.data[type].indexOf(item);
              const div = document.createElement('div'); div.className = 'data-card'; 
              const delBtn = isView ? '' : `<button onclick="app.Actions.deleteDataItem('${type}', ${idx})" style="color:var(--danger);border:none;background:none;cursor:pointer">ðŸ—‘ï¸</button>`; 
              
              let groupSelect = '';
              if(!isView) {
                  groupSelect = `<select class="group-select" onchange="app.Actions.changeGroup('${type}', ${idx}, this.value)">`;
                  groupSelect += `<option value="">-- Groupe --</option>`;
                  availableGroups.forEach(g => { groupSelect += `<option value="${g.id}" ${item.group_id === g.id ? 'selected' : ''}>${g.name}</option>`; });
                  groupSelect += `</select>`;
              }

              let contentHtml = '';
              if (type === 'actors') {
                  // VÃ©rifier si le profil est verrouillÃ© (revendiquÃ© par quelqu'un)
                  const isLocked = !!item.publicProfileId;
                  const isReadOnly = isView || isLocked;
                  
                  // Trouver le personnage que cet acteur joue
                  const linkedCharacter = state.data.characters.find(c => c.actor_id === item.id);
                  
                  contentHtml += `<div class="actor-card-header">`;
                  if(item.photo) contentHtml += `<img src="${item.photo}" class="actor-photo-preview">`;
                  const isInContacts = state.contacts && state.contacts.actors && state.contacts.actors.some(c => c.id === item.id);
                  const lockedBadge = isLocked ? `<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">ðŸ”’ Profil revendiquÃ©</span>` : '';
                  contentHtml += `<div style="flex-grow:1;"><div style="font-weight:bold; font-size:1rem; margin-bottom:5px; display:flex; align-items:center; gap:8px;">${Utils.escape(item.name)} ${lockedBadge} ${!isView ? `<button class="save-contact-btn ${isInContacts ? 'saved' : ''}" onclick="event.stopPropagation(); app.Contacts.saveActorToContacts(${idx})" title="${isInContacts ? 'DÃ©jÃ  dans vos contacts' : 'Sauvegarder dans contacts'}">${isInContacts ? 'â­' : 'â˜†'}</button>` : ''}</div>`;
                  contentHtml += `<select class="actor-input" style="margin-bottom:5px; width:auto;" onchange="app.Actions.updateActorMeta(${idx}, 'gender', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      ${ProfileRenderer.selectOptions.gender.map(o => '<option value="'+o.value+'" '+(item.gender === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                  </select>`;
                  
                  // Afficher le rÃ´le
                  if(linkedCharacter) {
                      contentHtml += `<div style="color:var(--primary); font-size:0.9rem; margin-bottom:5px;">ðŸŽ­ Joue : <strong>${Utils.escape(linkedCharacter.name)}</strong></div>`;
                  } else {
                      contentHtml += `<div style="color:var(--text-sec); font-size:0.85rem; margin-bottom:5px; font-style:italic;">Aucun personnage liÃ©</div>`;
                  }
                  
                  if(!isReadOnly) contentHtml += `<input class="actor-input" placeholder="URL Photo" value="${item.photo||''}" onchange="app.Actions.updateActorMeta(${idx}, 'photo', this.value)">`;
                  contentHtml += `</div>${delBtn}</div>`;
                  contentHtml += `<div class="actor-input-row mt-10">`;
                  contentHtml += `<input class="actor-input" placeholder="Email" value="${item.email||''}" onchange="app.Actions.updateActorMeta(${idx}, 'email', this.value)" ${isReadOnly?'disabled':''}>`;
                  contentHtml += `<input class="actor-input" placeholder="TÃ©l" value="${item.phone||''}" onchange="app.Actions.updateActorMeta(${idx}, 'phone', this.value)" ${isReadOnly?'disabled':''}>`;
                  contentHtml += `</div>`;
                  contentHtml += `<div class="actor-input-row mt-5">`;
                  contentHtml += `<input class="actor-input" placeholder="ðŸ“ Ville / RÃ©gion" value="${item.city||''}" onchange="app.Actions.updateActorMeta(${idx}, 'city', this.value)" ${isReadOnly?'disabled':''}>`;
                  contentHtml += `<input class="actor-input" placeholder="Site Web" value="${item.website||''}" onchange="app.Actions.updateActorMeta(${idx}, 'website', this.value)" ${isReadOnly?'disabled':''}>`;
                  contentHtml += `</div>`;
                  contentHtml += `<textarea class="data-desc mt-5" placeholder="Adresse / Notes..." oninput="app.Actions.updateActorMeta(${idx}, 'address', this.value)" ${isReadOnly?'disabled':''}>${item.address || ''}</textarea>`;
                  contentHtml += `<textarea class="data-desc" style="margin-top:5px; height:50px;" placeholder="Bio..." oninput="app.Actions.updateDataItem('${type}', ${idx}, this.value)" ${isReadOnly?'disabled':''}>${item.bio || ''}</textarea>`;
                  
                  // Section Description physique (vÃ©rifier visibilitÃ©)
                  if(UI.isSectionVisibleForProject(item, 'physical')) {
                  contentHtml += `<div class="actor-physical-section info-box">
                      <strong class="form-label-block">ðŸ“ Description physique</strong>
                      <div class="actor-input-row mb-8">
                          <input class="actor-input" type="number" placeholder="Taille (cm)" value="${item.height || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'height', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="actor-input" type="number" placeholder="Poids (kg)" value="${item.weight || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'weight', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="actor-input" type="number" placeholder="Ã‚ge" value="${item.age || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'age', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>
                      <div class="actor-input-row mb-8">
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'eyeColor', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.eyeColor.map(o => '<option value="'+o.value+'" '+(item.eyeColor === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'hairColor', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.hairColor.map(o => '<option value="'+o.value+'" '+(item.hairColor === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'hairLength', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.hairLength.map(o => '<option value="'+o.value+'" '+(item.hairLength === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                      </div>
                      <div class="actor-input-row mb-8">
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'corpulence', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.corpulence.map(o => '<option value="'+o.value+'" '+(item.corpulence === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'ethnicity', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.ethnicity.map(o => '<option value="'+o.value+'" '+(item.ethnicity === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                      </div>
                      <div class="actor-input-row">
                          <input class="actor-input" placeholder="Sports pratiquÃ©s (Ã©quitation, natation...)" value="${item.sports || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'sports', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="actor-input" placeholder="Langues parlÃ©es (franÃ§ais, anglais...)" value="${item.languages || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'languages', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>
                  </div>`;
                  }
                  
                  // Section Galerie Photos (vÃ©rifier visibilitÃ©)
                  if(UI.isSectionVisibleForProject(item, 'gallery')) {
                  const galleryPhotos = item.galleryPhotos || [];
                  const galleryHTML = galleryPhotos.map((url, i) => `
                      <div style="position:relative; width:80px; height:80px;">
                          <img src="${url}" style="width:100%; height:100%; object-fit:cover; border-radius:6px; border:1px solid var(--border);">
                          ${!isReadOnly ? `<button onclick="app.Actions.removeActorGalleryPhoto(${idx}, ${i})" class="n8-avatar-3">âœ•</button>` : ''}
                      </div>
                  `).join('');
                  
                  contentHtml += `<div class="info-box">
                      <strong class="form-label-block">ðŸ“¸ Galerie Photos</strong>
                      <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
                          ${galleryHTML || '<span style="color:var(--text-sec); font-size:0.85rem;">Aucune photo</span>'}
                      </div>
                      ${!isReadOnly ? `<div class="flex-gap10">
                          <input class="actor-input flex-1" type="url" id="actor-gallery-input-${idx}" placeholder="URL de la photo...">
                          <button onclick="app.Actions.addActorGalleryPhoto(${idx})" class="btn-primary-sm-r6">+ Ajouter</button>
                      </div>` : ''}
                  </div>`;
                  }
                  
                  // Section Bande DÃ©mo (vÃ©rifier visibilitÃ©)
                  if(UI.isSectionVisibleForProject(item, 'demoreel')) {
                  contentHtml += `<div class="info-box">
                      <strong class="form-label-block">ðŸŽ¬ Bande DÃ©mo</strong>
                      <input class="actor-input" type="url" placeholder="URL YouTube ou Vimeo (https://...)" value="${item.demoreel || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'demoreel', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      ${item.demoreel ? `<div class="mt-10"><iframe src="${ProfileRenderer.getEmbedUrl(item.demoreel)}" width="100%" height="200" frameborder="0" allowfullscreen class="br-8"></iframe></div>` : ''}
                  </div>`;
                  }
                  
                  // Section Tarif pour les acteurs (vÃ©rifier visibilitÃ©)
                  if(UI.isSectionVisibleForProject(item, 'tarif')) {
                  const actorCurrencyOptions = (CONFIG.currencies || ['â‚¬', '$', 'Â£', 'CHF']).map(c => `<option value="${c}" ${item.rateCurrency === c ? 'selected' : ''}>${c}</option>`).join('');
                  const actorRateTypeOptions = (CONFIG.rateTypes || ['Jour', 'Semaine', 'Forfait', 'Heure']).map(t => `<option value="${t}" ${item.rateType === t ? 'selected' : ''}>${t}</option>`).join('');
                  
                  contentHtml += `<div class="actor-input-row mt-10">
                      <input type="number" class="actor-input" placeholder="Tarif" value="${item.dailyRate || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'dailyRate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      <select class="actor-input" style="width:auto;" onchange="app.Actions.updateActorMeta(${idx}, 'rateCurrency', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          ${actorCurrencyOptions}
                      </select>
                      <select class="actor-input" style="width:auto;" onchange="app.Actions.updateActorMeta(${idx}, 'rateType', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          ${actorRateTypeOptions}
                      </select>
                      <label style="display:flex; align-items:center; gap:5px; cursor:pointer; white-space:nowrap;">
                          <input type="checkbox" ${item.rateNegotiable ? 'checked' : ''} onchange="app.Actions.updateActorMeta(${idx}, 'rateNegotiable', this.checked)" ${isReadOnly ? 'disabled' : ''}>
                          <span class="fs-085">ðŸ¤ NÃ©gociable</span>
                      </label>
                  </div>`;
                  
                  // Section Statut professionnel
                  contentHtml += `<div style="margin-top:10px; padding:10px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong class="fs-09">ðŸ“‹ Statut professionnel</strong>
                      <div class="actor-input-row mt-8">
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'professionalStatus', this.value); app.UI.renderDataTab('actors', els.actorContainer);" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.professionalStatus.map(o => '<option value="'+o.value+'" '+(item.professionalStatus === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                      </div>
                      ${item.professionalStatus === 'intermittent' ? `
                      <div class="actor-input-row mt-8">
                          <input class="actor-input" placeholder="NÂ° SÃ©curitÃ© Sociale" value="${item.numSecu || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'numSecu', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="actor-input" placeholder="NÂ° CongÃ©s Spectacles" value="${item.numCongesSpectacles || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'numCongesSpectacles', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>` : ''}
                      ${item.professionalStatus === 'micro-entrepreneur' ? `
                      <div class="actor-input-row mt-8">
                          <input class="actor-input" placeholder="NÂ° SIRET" value="${item.siret || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'siret', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>` : ''}
                      
                      <strong style="font-size: 0.9rem; display:block; margin-top:15px;">ðŸ¤ Type de collaboration</strong>
                      <div class="collab-type-selector">
                          <div class="collab-type-btn pro ${item.collabType === 'pro' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Actions.updateActorMeta(${idx}, 'collabType', 'pro'); app.UI.renderDataTab('actors', els.actorContainer);` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                              ðŸŽ¬ Pro
                          </div>
                          <div class="collab-type-btn semi-pro ${item.collabType === 'semi-pro' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Actions.updateActorMeta(${idx}, 'collabType', 'semi-pro'); app.UI.renderDataTab('actors', els.actorContainer);` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                              âš¡ Semi-pro
                          </div>
                          <div class="collab-type-btn benevole ${item.collabType === 'benevole' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Actions.updateActorMeta(${idx}, 'collabType', 'benevole'); app.UI.renderDataTab('actors', els.actorContainer);` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                              â¤ï¸ BÃ©nÃ©vole
                          </div>
                      </div>
                      <p class="text-sec-xs-mt8">
                          ${item.collabType === 'pro' ? 'ðŸ’¼ Contrat classique, horaires et tarifs standards' : 
                            item.collabType === 'semi-pro' ? 'ðŸ¤ Flexible sur les conditions mais rÃ©munÃ©rÃ©Â·e' : 
                            item.collabType === 'benevole' ? 'ðŸŽ Pas de rÃ©munÃ©ration, dÃ©fraiement repas + transport' : 
                            'SÃ©lectionnez votre type de collaboration prÃ©fÃ©rÃ©'}
                      </p>
                  </div>`;
                  }
                  
                  // Section DisponibilitÃ©s pour les acteurs (vÃ©rifier visibilitÃ©)
                  if(UI.isSectionVisibleForProject(item, 'calendar')) {
                  const actorAvailDates = item.availabilityDates || [];
                  const actorAvailDatesHTML = actorAvailDates.map((d, i) => `<span style="display:inline-flex; align-items:center; background:#E8F5E9; border:1px solid #4CAF50; color:#2E7D32; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">âœ“ ${d.from} â†’ ${d.to} ${!isReadOnly ? `<span onclick="app.Actions.removeActorAvailability(${idx}, ${i})" class="delete-link">âœ–</span>` : ''}</span>`).join('');
                  
                  // IndisponibilitÃ©s
                  const actorUnavailDates = item.unavailabilityDates || [];
                  const actorUnavailDatesHTML = actorUnavailDates.map((d, i) => `<span style="display:inline-flex; align-items:center; background:#FFEBEE; border:1px solid #f44336; color:#C62828; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">âœ— ${d.from} â†’ ${d.to} ${d.reason ? '(' + Utils.escape(d.reason) + ')' : ''} ${!isReadOnly ? `<span onclick="app.Actions.removeActorUnavailability(${idx}, ${i})" class="delete-link">âœ–</span>` : ''}</span>`).join('');
                  
                  contentHtml += `<div class="crew-availability-section mt-10">
                      <strong class="fs-09">ðŸ“… DisponibilitÃ©s & IndisponibilitÃ©s</strong>
                      <textarea class="actor-input" style="min-height: 50px; margin-top: 5px; width:100%;" placeholder="Situation / Notes de disponibilitÃ©..." onchange="app.Actions.updateActorMeta(${idx}, 'availabilityText', this.value)" ${isReadOnly ? 'disabled' : ''}>${item.availabilityText || ''}</textarea>
                      <div id="actor-calendar-${idx}"></div>
                      <div class="mt-10">
                          <div class="form-label">ðŸŸ¢ Disponible :</div>
                          ${actorAvailDatesHTML || '<span class="text-sec-xs">Aucune pÃ©riode renseignÃ©e</span>'}
                      </div>
                      <div class="mt-10">
                          <div class="form-label">ðŸ”´ Indisponible :</div>
                          ${actorUnavailDatesHTML || '<span class="text-sec-xs">Aucune pÃ©riode renseignÃ©e</span>'}
                          </div>
                  </div>`;
                  }
                  
                  // Section VÃ©hicule (vÃ©rifier visibilitÃ©)
                  if(UI.isSectionVisibleForProject(item, 'vehicle')) {
                  contentHtml += `<div class="crew-vehicle-section mt-10">
                      <label class="crew-vehicle-toggle">
                          <input type="checkbox" ${item.hasVehicle ? 'checked' : ''} onchange="app.Actions.toggleActorVehicle(${idx}, this.checked)" ${isReadOnly ? 'disabled' : ''}>
                          <strong>ðŸš— PossÃ¨de un vÃ©hicule</strong>
                      </label>
                      <div class="crew-vehicle-details ${item.hasVehicle ? 'visible' : ''}" id="actor-vehicle-${idx}">
                          <div class="actor-input-row mt-8">
                              <input class="actor-input" placeholder="Type de vÃ©hicule" value="${item.vehicleType || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'vehicleType', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              <input class="actor-input" placeholder="Immatriculation" value="${item.vehiclePlate || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'vehiclePlate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          </div>
                          <div class="actor-input-row mt-8">
                              <input class="actor-input" type="number" min="1" max="9" placeholder="Nb places dispo" value="${item.vehicleSeats || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'vehicleSeats', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                  <input type="checkbox" ${item.vehicleTrunk ? 'checked' : ''} onchange="app.Actions.updateActorMeta(${idx}, 'vehicleTrunk', this.checked)" ${isReadOnly ? 'disabled' : ''}>
                                  <span>ðŸ§³ Coffre disponible</span>
                              </label>
                          </div>
                          <textarea class="data-desc" style="margin-top:8px; height:40px;" placeholder="Notes vÃ©hicule..." oninput="app.Actions.updateActorMeta(${idx}, 'vehicleNotes', this.value)" ${isReadOnly ? 'disabled' : ''}>${item.vehicleNotes || ''}</textarea>
                      </div>
                  </div>`;
                  }
                  
                  // Bouton Contrat
                  if(!isView) {
                      contentHtml += `<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border); display:flex; gap:10px; flex-wrap:wrap;">
                          <button onclick="app.Contracts.openModal('actor', ${idx})" style="padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem;">ðŸ“ Contrat</button>
                      </div>`;
                  }
                  
                  // Bouton Contrat
                  if(!isView) {
                      contentHtml += `<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border); display:flex; gap:10px; flex-wrap:wrap;">
                          <button onclick="app.Contracts.openModal('actor', ${idx})" style="padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem;">ðŸ“ Contrat</button>
                      </div>`;
                  }
                  
                  contentHtml += groupSelect;
              } else if(type === 'locations') {
                  // === DÃ‰CORS : Fiche enrichie ===
                  contentHtml += `<div class="data-header"><span class="data-name">ðŸ  ${Utils.escape(item.name)}</span>${delBtn}</div>`;
                  contentHtml += `<textarea class="data-desc" placeholder="Description du dÃ©cor..." oninput="app.Actions.updateDataItem('${type}', ${idx}, this.value)" ${isView?'disabled':''}>${item.desc || ''}</textarea>`;
                  
                  // Section Adresse & Contact
                  contentHtml += `<div style="margin-top:12px; padding:12px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong class="form-label-block">ðŸ“ Lieu de tournage</strong>
                      <input class="actor-input" placeholder="Nom du lieu rÃ©el (ex: MusÃ©e d'Histoire Naturelle)" value="${item.realName || ''}" oninput="app.Actions.updateLocationMeta(${idx}, 'realName', this.value)" ${isView?'disabled':''} style="margin-bottom:8px;">
                      <div class="address-autocomplete-container" style="position:relative; margin-bottom:8px;">
                          <input class="actor-input" id="loc-address-${idx}" placeholder="Adresse complÃ¨te (autocomplÃ©tion)" value="${item.address || ''}" oninput="app.Actions.searchLocationAddress(${idx}, this.value)" ${isView?'disabled':''} autocomplete="off">
                          <div id="loc-suggestions-${idx}" class="address-suggestions"></div>
                      </div>
                      <div style="display:flex; gap:8px; margin-bottom:8px;">
                          <input class="actor-input flex-1" placeholder="ðŸ‘¤ Contact sur place" value="${item.contactName || ''}" oninput="app.Actions.updateLocationMeta(${idx}, 'contactName', this.value)" ${isView?'disabled':''}>
                          <input class="actor-input" placeholder="ðŸ“ž TÃ©lÃ©phone" value="${item.contactPhone || ''}" oninput="app.Actions.updateLocationMeta(${idx}, 'contactPhone', this.value)" ${isView?'disabled':''} style="width:140px;">
                      </div>
                      <textarea class="data-desc" style="min-height:40px;" placeholder="Notes d'accÃ¨s (code porte, parking, interphone...)" oninput="app.Actions.updateLocationMeta(${idx}, 'accessNotes', this.value)" ${isView?'disabled':''}>${item.accessNotes || ''}</textarea>
                  </div>`;
                  
                  // Section Photos de repÃ©rage
                  contentHtml += `<div style="margin-top:12px; padding:12px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong class="form-label-block">ðŸ“¸ Photos de repÃ©rage</strong>
                      <div id="location-gallery-${idx}" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
                          ${(item.galleryPhotos || []).map((photo, pIdx) => `
                              <div style="position:relative; width:80px; height:80px;">
                                  <img src="${photo}" style="width:100%; height:100%; object-fit:cover; border-radius:4px; cursor:pointer;" onclick="window.open('${photo}', '_blank')">
                                  ${!isView ? `<button onclick="app.Actions.removeLocationPhoto(${idx}, ${pIdx})" style="position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; border:none; border-radius:50%; width:18px; height:18px; cursor:pointer; font-size:10px;">âœ•</button>` : ''}
                              </div>
                          `).join('')}
                          ${(item.galleryPhotos || []).length === 0 ? '<span style="color:var(--text-sec); font-size:0.85rem; font-style:italic;">Aucune photo</span>' : ''}
                      </div>
                      ${!isView ? `<input class="actor-input" placeholder="URL de la photo Ã  ajouter" onkeydown="if(event.key==='Enter'){app.Actions.addLocationPhoto(${idx}, this.value); this.value='';}" class="fs-085">` : ''}
                  </div>`;
                  
                  // ScÃ¨nes tournÃ©es dans ce dÃ©cor
                  const locationScenes = state.data.scenes.filter(s => {
                      if(!s.title) return false;
                      const locMatch = s.title.match(/^(?:INT\.|EXT\.|I\/E)\s*([^\-]+)/i);
                      if(locMatch && locMatch[1]) {
                          return locMatch[1].trim().toUpperCase() === item.name.toUpperCase();
                      }
                      return false;
                  });
                  
                  if(locationScenes.length > 0) {
                      const sceneNumbers = locationScenes.map(s => {
                          const scIdx = state.data.scenes.indexOf(s) + 1;
                          return `<span onclick="app.UI.switchTab('script')" style="cursor:pointer; color:var(--primary); text-decoration:underline;">#${scIdx}</span>`;
                      }).join(', ');
                      contentHtml += `<div style="margin-top:8px; padding:8px; background:var(--bg); border-radius:4px; font-size:0.85rem;">
                          <strong>ðŸŽ¬ ScÃ¨nes dans ce dÃ©cor :</strong> ${sceneNumbers} <span class="text-sec">(${locationScenes.length} scÃ¨ne${locationScenes.length > 1 ? 's' : ''})</span>
                      </div>`;
                  } else {
                      contentHtml += `<div style="margin-top:8px; padding:8px; background:var(--bg); border-radius:4px; font-size:0.85rem; color:var(--text-sec);">
                          <em>Aucune scÃ¨ne dans ce dÃ©cor</em>
                      </div>`;
                  }
                  
                  // SÃ©lecteur de groupe pour les dÃ©cors
                  contentHtml += groupSelect;
              } else {
                  // PERSONNAGES (characters)
                  const contentKey = 'bio';
                  contentHtml += `<div class="data-header"><span class="data-name">${Utils.escape(item.name)}</span>${delBtn}</div>`;
                  contentHtml += `<textarea class="data-desc" placeholder="Notes..." oninput="app.Actions.updateDataItem('${type}', ${idx}, this.value)" ${isView?'disabled':''}>${item[contentKey] || ''}</textarea>`;
                  
                  if(type === 'characters') {
                  // Dropdown sexe pour personnages
                  contentHtml += `<select class="group-select" style="margin-top:8px; margin-bottom:8px; width:auto; border-color:var(--border);" onchange="app.Actions.updateCharacterMeta(${idx}, 'gender', this.value)" ${isView ? 'disabled' : ''}>
                      ${ProfileRenderer.selectOptions.gender.map(o => '<option value="'+o.value+'" '+(item.gender === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                  </select>`;
                  
                  // Trouver les scÃ¨nes oÃ¹ ce personnage apparaÃ®t
                  const characterScenes = state.data.scenes.filter(s => {
                      if(!s.perso) return false;
                      const names = s.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
                      return names.includes(item.name.toUpperCase());
                  });
                  
                  if(characterScenes.length > 0) {
                      const sceneNumbers = characterScenes.map(s => {
                          const idx = state.data.scenes.indexOf(s) + 1;
                          return `#${idx}`;
                      }).join(', ');
                      contentHtml += `<div style="margin-top:8px; padding:8px; background:var(--bg); border-radius:4px; font-size:0.85rem;">
                          <strong>ðŸ“ ApparaÃ®t dans :</strong> ${sceneNumbers} <span class="text-sec">(${characterScenes.length} scÃ¨ne${characterScenes.length > 1 ? 's' : ''})</span>
                      </div>`;
                  } else {
                      contentHtml += `<div style="margin-top:8px; padding:8px; background:var(--bg); border-radius:4px; font-size:0.85rem; color:var(--text-sec);">
                          <em>N'apparaÃ®t dans aucune scÃ¨ne</em>
                      </div>`;
                  }
                  
                  if(!isView) {
                      contentHtml += `<select class="group-select" style="margin-top:5px; width:100%; border-color:var(--border);" onchange="app.Actions.linkActor(${idx}, this.value)">`; 
                      contentHtml += `<option value="">-- Lier ComÃ©dien.ne --</option>`;
                      if(state.data.actors) {
                          state.data.actors.forEach(actor => {
                              const isSelected = item.actor_id && item.actor_id === actor.id ? 'selected' : '';
                              contentHtml += `<option value="${actor.id}" ${isSelected}>${actor.name}</option>`;
                          });
                      }
                      contentHtml += `</select>`;
                  } else if (item.actor_id) {
                      const actor = state.data.actors.find(a => a.id === item.actor_id);
                      if(actor) contentHtml += `<div style="margin-top:5px;font-size:0.85rem;color:var(--primary)">ðŸŽ­ ${actor.name}</div>`;
                  }
              }
                  contentHtml += groupSelect;
              }
              div.innerHTML = contentHtml; 
              container.appendChild(div); 
          });
          
          // Initialiser les calendriers pour les acteurs
          if(type === 'actors') {
              setTimeout(() => {
                  items.forEach((item, i) => {
                      const idx = state.data.actors.indexOf(item);
                      const calContainer = document.getElementById('actor-calendar-' + idx);
                      if(calContainer && state.currentRole !== 'viewer') {
                          UI.renderAvailabilityCalendar('actor-calendar-' + idx, 'actor', idx);
                      }
                  });
              }, 100);
          }
      },
      
	  renderCrewTab: () => {
          const container = document.getElementById('crewContainer');
          container.innerHTML = '';
          
          if(!state.data.crew || state.data.crew.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">ðŸŽ¥</div>
                      <div class="empty-state-title">Aucun technicien</div>
                      <div class="empty-state-desc">Constituez votre Ã©quipe technique en ajoutant des membres. Vous pourrez gÃ©rer leurs rÃ´les, tarifs et disponibilitÃ©s.</div>
                      <button class="empty-state-btn" onclick="app.Crew.addMember()">+ Ajouter un technicien</button>
                      <div class="empty-state-tips">ðŸ’¡ <strong>Astuce :</strong> Organisez votre Ã©quipe par dÃ©partements (RÃ©alisation, Image, Son, etc.)</div>
                  </div>
              `;
              return;
          }
          
          const isView = state.currentRole === 'viewer' || !Permissions.canEdit('equipe');
          const crewGroups = state.data.groups.filter(g => g.type === 'crew');
          
          // Barre de toggle vue compacte / dÃ©taillÃ©e
          const viewMode = CardModal.getViewMode('crew');
          const toggleBar = document.createElement('div');
          toggleBar.className = 'view-toggle-bar';
          toggleBar.innerHTML = `
              <button class="view-toggle-btn ${viewMode === 'compact' ? 'active' : ''}" onclick="app.CardModal.setViewMode('crew', 'compact')">ðŸ”² Compact</button>
              <button class="view-toggle-btn ${viewMode === 'detailed' ? 'active' : ''}" onclick="app.CardModal.setViewMode('crew', 'detailed')">ðŸ“‹ DÃ©taillÃ©</button>
          `;
          container.appendChild(toggleBar);
          
          if(viewMode === 'compact') {
              // Vue compacte
              crewGroups.forEach(grp => {
                  const membersInGroup = state.data.crew.filter(m => m.group_id === grp.id);
                  if(membersInGroup.length > 0) {
                      const section = document.createElement('div');
                      section.className = 'group-section';
                      section.innerHTML = `<div class="group-header">${Utils.escape(grp.name)}</div><div class="compact-cards-grid"></div>`;
                      const grid = section.querySelector('.compact-cards-grid');
                      CardModal.renderCompactCrewCards(membersInGroup, grid, isView);
                      container.appendChild(section);
                  }
              });
              
              const noGroup = state.data.crew.filter(m => !m.group_id || !crewGroups.find(g => g.id === m.group_id));
              if(noGroup.length > 0) {
                  const section = document.createElement('div');
                  section.className = 'group-section';
                  section.innerHTML = `<div class="group-header text-sec">Non classÃ©</div><div class="compact-cards-grid"></div>`;
                  const grid = section.querySelector('.compact-cards-grid');
                  CardModal.renderCompactCrewCards(noGroup, grid, isView);
                  container.appendChild(section);
              }
          } else {
              // Vue dÃ©taillÃ©e (ancien mode)
              crewGroups.forEach(grp => {
                  const membersInGroup = state.data.crew.filter(m => m.group_id === grp.id);
                  if(membersInGroup.length > 0) {
                      const section = document.createElement('div');
                      section.className = 'group-section';
                      section.innerHTML = `<div class="group-header">${Utils.escape(grp.name)}</div><div class="data-grid"></div>`;
                      const grid = section.querySelector('.data-grid');
                      
                      membersInGroup.forEach(member => {
                          const idx = state.data.crew.indexOf(member);
                          const card = UI.createCrewCard(member, idx, crewGroups, isView);
                          grid.appendChild(card);
                      });
                      
                      container.appendChild(section);
                  }
              });
              
              const noGroup = state.data.crew.filter(m => !m.group_id || !crewGroups.find(g => g.id === m.group_id));
              if(noGroup.length > 0) {
                  const section = document.createElement('div');
                  section.className = 'group-section';
                  section.innerHTML = `<div class="group-header text-sec">Non classÃ©</div><div class="data-grid"></div>`;
                  const grid = section.querySelector('.data-grid');
                  
                  noGroup.forEach(member => {
                      const idx = state.data.crew.indexOf(member);
                      const card = UI.createCrewCard(member, idx, crewGroups, isView);
                      grid.appendChild(card);
                  });
                  
                  container.appendChild(section);
              }
              
              // Initialiser les calendriers pour les techniciens (mode dÃ©taillÃ© uniquement)
              if(!isView) {
                  setTimeout(() => {
                      state.data.crew.forEach((member, idx) => {
                          const calContainer = document.getElementById('crew-calendar-' + idx);
                          if(calContainer) {
                              UI.renderAvailabilityCalendar('crew-calendar-' + idx, 'crew', idx);
                          }
                      });
                  }, 100);
              }
          }
      },
      
      createCrewCard: (member, idx, availableGroups, isView) => {
          // VÃ©rifier si le profil est verrouillÃ© (revendiquÃ© par quelqu'un)
          const isLocked = !!member.publicProfileId;
          const isReadOnly = isView || isLocked;
          
          const card = document.createElement('div');
          card.className = 'crew-card';
          
          const roles = member.group_id ? Crew.getRolesForGroup(member.group_id) : [];
          
          let rolesOptions = '<option value="">-- Fonction --</option>';
          roles.forEach(r => {
              rolesOptions += `<option value="${r}" ${member.role === r ? 'selected' : ''}>${r}</option>`;
          });
          rolesOptions += '<option value="__custom__">âž• Autre...</option>';
          
          let groupOptions = '<option value="">-- DÃ©partement --</option>';
          availableGroups.forEach(g => {
              groupOptions += `<option value="${g.id}" ${member.group_id === g.id ? 'selected' : ''}>${g.name}</option>`;
          });
          
          let currencyOptions = '';
          CONFIG.currencies.forEach(c => {
              currencyOptions += `<option value="${c}" ${member.rateCurrency === c ? 'selected' : ''}>${c}</option>`;
          });
          
          let rateTypeOptions = '';
          CONFIG.rateTypes.forEach(t => {
              rateTypeOptions += `<option value="${t}" ${member.rateType === t ? 'selected' : ''}>${t}</option>`;
          });
          
          // Availability dates HTML
          let availDatesHTML = '';
          if(member.availabilityDates && member.availabilityDates.length > 0) {
              member.availabilityDates.forEach((d, dIdx) => {
                  const fromDate = new Date(d.from).toLocaleDateString();
                  const toDate = d.to ? new Date(d.to).toLocaleDateString() : fromDate;
                  availDatesHTML += `
                      <span style="display:inline-flex; align-items:center; background:#E8F5E9; border:1px solid #4CAF50; color:#2E7D32; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">âœ“ ${fromDate} â†’ ${toDate} ${!isReadOnly ? `<span onclick="app.Crew.removeAvailabilityDate(${idx}, ${dIdx})" class="delete-link">âœ–</span>` : ''}</span>
                  `;
              });
          }
          
          // Unavailability dates HTML
          let unavailDatesHTML = '';
          if(member.unavailabilityDates && member.unavailabilityDates.length > 0) {
              member.unavailabilityDates.forEach((d, dIdx) => {
                  const fromDate = new Date(d.from).toLocaleDateString();
                  const toDate = d.to ? new Date(d.to).toLocaleDateString() : fromDate;
                  unavailDatesHTML += `
                      <span style="display:inline-flex; align-items:center; background:#FFEBEE; border:1px solid #f44336; color:#C62828; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">âœ— ${fromDate} â†’ ${toDate} ${d.reason ? '(' + Utils.escape(d.reason) + ')' : ''} ${!isReadOnly ? `<span onclick="app.Crew.removeUnavailabilityDate(${idx}, ${dIdx})" class="delete-link">âœ–</span>` : ''}</span>
                  `;
              });
          }
          
          card.innerHTML = `
              <div class="crew-card-header">
                  ${member.photo ? `<img src="${member.photo}" class="crew-photo-preview">` : '<div class="crew-photo-preview" style="display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ðŸ‘¤</div>'}
                  <div class="crew-info-main">
                      <div class="crew-name" style="display:flex; align-items:center; gap:8px;">${Utils.escape(member.name)} ${isLocked ? `<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">ðŸ”’ Profil revendiquÃ©</span>` : ''} ${!isView ? `<button class="save-contact-btn ${state.contacts && state.contacts.crew && state.contacts.crew.some(c => c.id === member.id) ? 'saved' : ''}" onclick="event.stopPropagation(); app.Contacts.saveCrewToContacts(${idx})" title="Sauvegarder dans contacts">${state.contacts && state.contacts.crew && state.contacts.crew.some(c => c.id === member.id) ? 'â­' : 'â˜†'}</button>` : ''}</div>
                      <div class="crew-role">${member.role || 'Fonction non dÃ©finie'}</div>
                  </div>
                  ${!isView ? `<button onclick="app.Crew.deleteMember(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem;">ðŸ—‘ï¸</button>` : ''}
              </div>
              
              ${!isView ? `
              <div class="crew-row">
                  <select class="crew-input" onchange="app.Crew.updateMember(${idx}, 'group_id', this.value)" title="DÃ©partement" ${isLocked ? 'disabled' : ''}>
                      ${groupOptions}
                  </select>
                  <select class="crew-input" id="role-select-${idx}" onchange="app.UI.handleRoleChange(${idx}, this.value)" ${isLocked ? 'disabled' : ''}>
                      ${rolesOptions}
                  </select>
              </div>
              <select class="crew-input mt-8" onchange="app.Crew.updateMember(${idx}, 'gender', this.value)" ${isLocked ? 'disabled' : ''}>
                  ${ProfileRenderer.selectOptions.gender.map(o => '<option value="'+o.value+'" '+(member.gender === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
              </select>
              ` : ''}
              
              ${!isReadOnly ? `<input class="crew-input" placeholder="URL Photo" value="${member.photo || ''}" onchange="app.Crew.updateMember(${idx}, 'photo', this.value)">` : ''}
              
              <div class="crew-row">
                  <input class="crew-input" placeholder="Email" value="${member.email || ''}" onchange="app.Crew.updateMember(${idx}, 'email', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  <input class="crew-input" placeholder="TÃ©lÃ©phone" value="${member.phone || ''}" onchange="app.Crew.updateMember(${idx}, 'phone', this.value)" ${isReadOnly ? 'disabled' : ''}>
              </div>
              
              <div class="crew-row">
                  <input class="crew-input" placeholder="ðŸ“ Ville / RÃ©gion" value="${member.city || ''}" onchange="app.Crew.updateMember(${idx}, 'city', this.value)" ${isReadOnly ? 'disabled' : ''}>
              </div>
              
              <textarea class="crew-input" style="min-height: 60px;" placeholder="Adresse..." onchange="app.Crew.updateMember(${idx}, 'address', this.value)" ${isReadOnly ? 'disabled' : ''}>${member.address || ''}</textarea>
              
              ${UI.isSectionVisibleForProject(member, 'crew-gallery') ? `<div class="info-box">
                  <strong class="form-label-block">ðŸ“¸ Galerie Photos</strong>
                  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
                      ${(member.galleryPhotos || []).map((url, i) => `
                          <div style="position:relative; width:80px; height:80px;">
                              <img src="${url}" style="width:100%; height:100%; object-fit:cover; border-radius:6px; border:1px solid var(--border);">
                              ${!isReadOnly ? `<button onclick="app.Crew.removeGalleryPhoto(${idx}, ${i})" class="n8-avatar-3">âœ•</button>` : ''}
                          </div>
                      `).join('') || '<span style="color:var(--text-sec); font-size:0.85rem;">Aucune photo</span>'}
                  </div>
                  ${!isReadOnly ? `<div class="flex-gap10">
                      <input class="crew-input flex-1" type="url" id="crew-gallery-input-${idx}" placeholder="URL de la photo...">
                      <button onclick="app.Crew.addGalleryPhoto(${idx})" class="btn-primary-sm-r6">+ Ajouter</button>
                  </div>` : ''}
              </div>` : ''}
              
              ${UI.isSectionVisibleForProject(member, 'crew-demoreel') ? `<div class="info-box">
                  <strong class="form-label-block">ðŸŽ¬ Bande DÃ©mo</strong>
                  <input class="crew-input" type="url" placeholder="URL YouTube ou Vimeo (https://...)" value="${member.demoreel || ''}" onchange="app.Crew.updateMember(${idx}, 'demoreel', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  ${member.demoreel ? `<div class="mt-10"><iframe src="${ProfileRenderer.getEmbedUrl(member.demoreel)}" width="100%" height="200" frameborder="0" allowfullscreen class="br-8"></iframe></div>` : ''}
              </div>` : ''}
              
              ${UI.isSectionVisibleForProject(member, 'tarif') ? `<div class="crew-rate-row mt-10">
                  <input type="number" class="crew-input crew-rate-amount" placeholder="Tarif" value="${member.dailyRate || ''}" onchange="app.Crew.updateMember(${idx}, 'dailyRate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  <select class="crew-input crew-rate-currency" onchange="app.Crew.updateMember(${idx}, 'rateCurrency', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      ${currencyOptions}
                  </select>
                  <select class="crew-input crew-rate-type" onchange="app.Crew.updateMember(${idx}, 'rateType', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      ${rateTypeOptions}
                  </select>
                  <label style="display:flex; align-items:center; gap:5px; cursor:pointer; white-space:nowrap;">
                      <input type="checkbox" ${member.rateNegotiable ? 'checked' : ''} onchange="app.Crew.updateMember(${idx}, 'rateNegotiable', this.checked)" ${isReadOnly ? 'disabled' : ''}>
                      <span class="fs-085">ðŸ¤ NÃ©gociable</span>
                  </label>
              </div>
              
              <div style="margin-top:10px; padding:10px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                  <strong class="fs-09">ðŸ“‹ Statut professionnel</strong>
                  <div class="mt-8">
                      <select class="crew-input w-full" onchange="app.Crew.updateMember(${idx}, 'professionalStatus', this.value); app.UI.renderCrewTab();" ${isReadOnly ? 'disabled' : ''}>
                          <option value="" ${!member.professionalStatus ? 'selected' : ''}>-- Statut --</option>
                          <option value="intermittent" ${member.professionalStatus === 'intermittent' ? 'selected' : ''}>IntermittentÂ·e du spectacle</option>
                          <option value="micro-entrepreneur" ${member.professionalStatus === 'micro-entrepreneur' ? 'selected' : ''}>Micro-entrepreneurÂ·e</option>
                          <option value="amateur" ${member.professionalStatus === 'amateur' ? 'selected' : ''}>AmateurÂ·rice (pas de statut)</option>
                      </select>
                  </div>
                  ${member.professionalStatus === 'intermittent' ? `
                  <div class="crew-rate-row mt-8">
                      <input class="crew-input" placeholder="NÂ° SÃ©curitÃ© Sociale" value="${member.numSecu || ''}" onchange="app.Crew.updateMember(${idx}, 'numSecu', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      <input class="crew-input" placeholder="NÂ° CongÃ©s Spectacles" value="${member.numCongesSpectacles || ''}" onchange="app.Crew.updateMember(${idx}, 'numCongesSpectacles', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  </div>` : ''}
                  ${member.professionalStatus === 'micro-entrepreneur' ? `
                  <div class="mt-8">
                      <input class="crew-input w-full" placeholder="NÂ° SIRET" value="${member.siret || ''}" onchange="app.Crew.updateMember(${idx}, 'siret', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  </div>` : ''}
                  
                  <strong style="font-size: 0.9rem; display:block; margin-top:15px;">ðŸ¤ Type de collaboration</strong>
                  <div class="collab-type-selector">
                      <div class="collab-type-btn pro ${member.collabType === 'pro' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Crew.updateMember(${idx}, 'collabType', 'pro'); app.UI.renderCrewTab();` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                          ðŸŽ¬ Pro
                      </div>
                      <div class="collab-type-btn semi-pro ${member.collabType === 'semi-pro' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Crew.updateMember(${idx}, 'collabType', 'semi-pro'); app.UI.renderCrewTab();` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                          âš¡ Semi-pro
                      </div>
                      <div class="collab-type-btn benevole ${member.collabType === 'benevole' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Crew.updateMember(${idx}, 'collabType', 'benevole'); app.UI.renderCrewTab();` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                          â¤ï¸ BÃ©nÃ©vole
                      </div>
                  </div>
                  <p class="text-sec-xs-mt8">
                      ${member.collabType === 'pro' ? 'ðŸ’¼ Contrat classique, horaires et tarifs standards' : 
                        member.collabType === 'semi-pro' ? 'ðŸ¤ Flexible sur les conditions mais rÃ©munÃ©rÃ©Â·e' : 
                        member.collabType === 'benevole' ? 'ðŸŽ Pas de rÃ©munÃ©ration, dÃ©fraiement repas + transport' : 
                        'SÃ©lectionnez votre type de collaboration prÃ©fÃ©rÃ©'}
                  </p>
              </div>` : ''}
              
              ${UI.isSectionVisibleForProject(member, 'calendar') ? `<div class="crew-availability-section">
                  <strong class="fs-09">ðŸ“… DisponibilitÃ©s & IndisponibilitÃ©s</strong>
                  <textarea class="crew-input" style="min-height: 50px; margin-top: 5px;" placeholder="Situation / Notes de disponibilitÃ©..." onchange="app.Crew.updateMember(${idx}, 'availabilityText', this.value)" ${isReadOnly ? 'disabled' : ''}>${member.availabilityText || ''}</textarea>
                  <div id="crew-calendar-${idx}"></div>
                  <div class="mt-10">
                      <div class="form-label">ðŸŸ¢ Disponible :</div>
                      ${availDatesHTML || '<span class="text-sec-xs">Aucune pÃ©riode renseignÃ©e</span>'}
                  </div>
                  <div class="mt-10">
                      <div class="form-label">ðŸ”´ Indisponible :</div>
                      ${unavailDatesHTML || '<span class="text-sec-xs">Aucune pÃ©riode renseignÃ©e</span>'}
                      </div>
              </div>` : ''}
              
              ${UI.isSectionVisibleForProject(member, 'vehicle') ? `<div class="crew-vehicle-section">
                  <label class="crew-vehicle-toggle">
                      <input type="checkbox" ${member.hasVehicle ? 'checked' : ''} onchange="app.Crew.toggleVehicle(${idx}, this.checked)" ${isReadOnly ? 'disabled' : ''}>
                      <strong>ðŸš— PossÃ¨de un vÃ©hicule</strong>
                  </label>
                  <div class="crew-vehicle-details ${member.hasVehicle ? 'visible' : ''}" id="crew-vehicle-${idx}">
                      <div class="crew-row">
                          <input class="crew-input" placeholder="Type de vÃ©hicule" value="${member.vehicleType || ''}" onchange="app.Crew.updateMember(${idx}, 'vehicleType', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="crew-input" placeholder="Immatriculation" value="${member.vehiclePlate || ''}" onchange="app.Crew.updateMember(${idx}, 'vehiclePlate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>
                      <div class="crew-row mt-10">
                          <input class="crew-input" type="number" min="1" max="9" placeholder="Nb places dispo" value="${member.vehicleSeats || ''}" onchange="app.Crew.updateMember(${idx}, 'vehicleSeats', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                              <input type="checkbox" ${member.vehicleTrunk ? 'checked' : ''} onchange="app.Crew.updateMember(${idx}, 'vehicleTrunk', this.checked)" ${isReadOnly ? 'disabled' : ''}>
                              <span>ðŸ§³ Coffre disponible</span>
                          </label>
                      </div>
                      <textarea class="crew-input" style="min-height: 40px; margin-top: 10px;" placeholder="Notes vÃ©hicule..." onchange="app.Crew.updateMember(${idx}, 'vehicleNotes', this.value)" ${isReadOnly ? 'disabled' : ''}>${member.vehicleNotes || ''}</textarea>
                  </div>
              </div>` : ''}
              
              <textarea class="crew-input" style="min-height: 60px; margin-top: 10px;" placeholder="Notes gÃ©nÃ©rales..." onchange="app.Crew.updateMember(${idx}, 'notes', this.value)" ${isReadOnly ? 'disabled' : ''}>${member.notes || ''}</textarea>
              
              ${!isReadOnly ? `<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border); display:flex; gap:10px; flex-wrap:wrap;">
                  <button onclick="app.Contracts.openModal('crew', ${idx})" style="padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem;">ðŸ“ Contrat</button>
              </div>` : ''}
          `;
          
          return card;
      },
      
      handleRoleChange: (idx, value) => {
          if(value === '__custom__') {
              const member = state.data.crew[idx];
              const newRole = Crew.addCustomRole(member.group_id);
              if(newRole) {
                  Crew.updateMember(idx, 'role', newRole);
                  UI.renderCrewTab();
              } else {
                  // Reset select
                  document.getElementById(`role-select-${idx}`).value = member.role || '';
              }
          } else {
              Crew.updateMember(idx, 'role', value);
          }
      },

      handleDragOver: (e, container, selector) => { e.preventDefault(); if(state.currentRole === 'viewer') return; const after = Utils.getDragAfterElement(container, e.clientY, selector); const drag = document.querySelector(selector + '.dragging'); if(drag) after ? container.insertBefore(drag, after) : container.appendChild(drag); },
      goToStoryboard: (sceneId) => {
        UI.switchTab('storyboard');
        setTimeout(() => {
            const scene = state.data.scenes.find(s => s.id === sceneId || String(s.id) === String(sceneId));
            if(scene) {
                Storyboard.selectScene(scene.id);
            }
        }, 150);
    },
	
	renderAvailabilityCalendar: (containerId, personType, personIdx) => {
        const container = document.getElementById(containerId);
        if(!container) return;
        
        const person = personType === 'actor' ? state.data.actors[personIdx] : state.data.crew[personIdx];
        if(!person) return;
        
        // VÃ©rifier si le profil est verrouillÃ© (revendiquÃ©)
        const isLocked = !!person.publicProfileId;
        
        const today = new Date();
        const currentMonth = person._calendarMonth !== undefined ? person._calendarMonth : today.getMonth();
        const currentYear = person._calendarYear !== undefined ? person._calendarYear : today.getFullYear();
        
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        
        const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
        const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        
        const availDates = person.availabilityDates || [];
        const unavailDates = person.unavailabilityDates || [];
        const shootDates = person.shootingDates || [];
        
        const isDateShooting = (dateStr) => {
            return shootDates.find(sd => sd.date === dateStr);
        };
        
        const isDateAvailable = (dateStr) => {
            return availDates.some(range => {
                const from = new Date(range.from);
                const to = new Date(range.to);
                const check = new Date(dateStr);
                return check >= from && check <= to;
            });
        };
        
        const isDateUnavailable = (dateStr) => {
            return unavailDates.some(range => {
                const from = new Date(range.from);
                const to = new Date(range.to);
                const check = new Date(dateStr);
                return check >= from && check <= to;
            });
        };
        
        let html = `<div class="availability-calendar">
            <div class="availability-calendar-header">
                <button onclick="app.UI.changeCalendarMonth('${containerId}', '${personType}', ${personIdx}, -1)">â—€</button>
                <strong>${monthNames[currentMonth]} ${currentYear}</strong>
                <button onclick="app.UI.changeCalendarMonth('${containerId}', '${personType}', ${personIdx}, 1)">â–¶</button>
            </div>
            ${isLocked ? `<div style="font-size:0.7rem; text-align:center; margin-bottom:5px; color:var(--text-sec);">ðŸ”’ Calendrier en lecture seule</div>` : `<div style="font-size:0.7rem; text-align:center; margin-bottom:5px; color:var(--text-sec);">ðŸŸ¢ dispo | ðŸ”´ indispo | ðŸŽ¬ tournage</div>`}
            <div class="availability-calendar-grid">`;
        
        dayNames.forEach(d => {
            html += `<div class="availability-calendar-day-header">${d}</div>`;
        });
        
        for(let i = 0; i < startDay; i++) {
            html += `<div class="availability-calendar-day empty"></div>`;
        }
        
        for(let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === day;
            const isAvail = isDateAvailable(dateStr);
            const isUnavail = isDateUnavailable(dateStr);
            
            const shootingInfo = isDateShooting(dateStr);
            
            let dayClass = 'availability-calendar-day';
            if(isToday) dayClass += ' today';
            if(shootingInfo) dayClass += ' shooting';
            else if(isAvail) dayClass += ' available';
            if(isUnavail) dayClass += ' unavailable';
            if(isLocked) dayClass += ' locked';
            
            const shootTitle = shootingInfo ? `title="ðŸŽ¬ J${shootingInfo.dayNumber} - ${shootingInfo.projectName}${shootingInfo.callTime ? ' | Convoc: ' + shootingInfo.callTime : ''}${shootingInfo.location ? ' | ' + shootingInfo.location : ''}"` : '';
            
            html += `<div class="${dayClass}" 
                data-date="${dateStr}"
                ${shootTitle}
                ${!isLocked ? `onmousedown="app.UI.startCalendarDrag('${containerId}', '${personType}', ${personIdx}, '${dateStr}', event)"
                onmouseenter="app.UI.continueCalendarDrag('${dateStr}')"
                onmouseup="app.UI.endCalendarDrag()"` : ''}
                oncontextmenu="return false;">${day}</div>`;
        }
        
        html += `</div></div>`;
        container.innerHTML = html;
    },
    
    changeCalendarMonth: (containerId, personType, personIdx, delta) => {
        const person = personType === 'actor' ? state.data.actors[personIdx] : state.data.crew[personIdx];
        if(!person) return;
        
        const today = new Date();
        let currentMonth = person._calendarMonth !== undefined ? person._calendarMonth : today.getMonth();
        let currentYear = person._calendarYear !== undefined ? person._calendarYear : today.getFullYear();
        
        currentMonth += delta;
        if(currentMonth > 11) { currentMonth = 0; currentYear++; }
        if(currentMonth < 0) { currentMonth = 11; currentYear--; }
        
        person._calendarMonth = currentMonth;
        person._calendarYear = currentYear;
        
        UI.renderAvailabilityCalendar(containerId, personType, personIdx);
    },
    
    _calendarDrag: { active: false, containerId: null, personType: null, personIdx: null, startDate: null, dates: [], isRightClick: false },
    
    startCalendarDrag: (containerId, personType, personIdx, dateStr, event) => {
        event.preventDefault();
        const isRightClick = event.button === 2;
        UI._calendarDrag = { active: true, containerId, personType, personIdx, startDate: dateStr, dates: [dateStr], isRightClick };
        document.addEventListener('mouseup', UI.endCalendarDrag);
    },
    
    continueCalendarDrag: (dateStr) => {
        if(!UI._calendarDrag.active) return;
        if(!UI._calendarDrag.dates.includes(dateStr)) {
            UI._calendarDrag.dates.push(dateStr);
        }
        const container = document.getElementById(UI._calendarDrag.containerId);
        if(container) {
            const color = UI._calendarDrag.isRightClick ? '#f44336' : '#4CAF50';
            container.querySelectorAll('.availability-calendar-day').forEach(el => {
                if(UI._calendarDrag.dates.includes(el.dataset.date)) {
                    el.style.background = color;
                    el.style.color = 'white';
                }
            });
        }
    },
    
    endCalendarDrag: () => {
        if(!UI._calendarDrag.active) return;
        
        const { personType, personIdx, dates, isRightClick } = UI._calendarDrag;
        if(dates.length > 0) {
            dates.sort();
            const from = dates[0];
            const to = dates[dates.length - 1];
            
            const person = personType === 'actor' ? state.data.actors[personIdx] : state.data.crew[personIdx];
            if(person) {
                // Initialiser les tableaux si nÃ©cessaire
                if(!person.availabilityDates) person.availabilityDates = [];
                if(!person.unavailabilityDates) person.unavailabilityDates = [];
                
                const targetArray = isRightClick ? person.unavailabilityDates : person.availabilityDates;
                const otherArray = isRightClick ? person.availabilityDates : person.unavailabilityDates;
                
                // VÃ©rifier si on clique sur une date dÃ©jÃ  dans le mÃªme Ã©tat (pour la dÃ©sÃ©lectionner)
                if(dates.length === 1) {
                    const existingIdx = targetArray.findIndex(range => {
                        const checkDate = new Date(dates[0]);
                        return checkDate >= new Date(range.from) && checkDate <= new Date(range.to);
                    });
                    if(existingIdx > -1) {
                        // DÃ©sÃ©lectionner
                        targetArray.splice(existingIdx, 1);
                    } else {
                        // Retirer de l'autre Ã©tat si prÃ©sent
                        const otherIdx = otherArray.findIndex(range => {
                            const checkDate = new Date(dates[0]);
                            return checkDate >= new Date(range.from) && checkDate <= new Date(range.to);
                        });
                        if(otherIdx > -1) {
                            otherArray.splice(otherIdx, 1);
                        }
                        // Ajouter au nouvel Ã©tat
                        targetArray.push({ from, to });
                    }
                } else {
                    // SÃ©lection multiple : ajouter la plage
                    targetArray.push({ from, to });
                }
                
                Store.save();
                UI.renderAvailabilityCalendar(UI._calendarDrag.containerId, personType, personIdx);
                
                // RafraÃ®chir aussi la liste des dates
                if(personType === 'actor') {
                    UI.renderDataTab('actors', els.actorContainer);
                } else {
                    UI.renderCrewTab();
                }
            }
        }
        
        UI._calendarDrag = { active: false, containerId: null, personType: null, personIdx: null, startDate: null, dates: [], isRightClick: false };
        document.removeEventListener('mouseup', UI.endCalendarDrag);
    },
	
	applyTabPermissions: () => {
          if(state.currentRole === 'owner') {
              // Le propriÃ©taire voit tout
              document.querySelectorAll('.tab-btn').forEach(btn => {
                  btn.style.opacity = '1';
                  btn.style.pointerEvents = 'auto';
              });
              return;
          }
          
const tabToSection = {
        'synopsis': 'synopsis', 'board': 'sequencier', 'script': 'scenario', 
        'storyboard': 'storyboard', 'chars': 'personnages', 'locs': 'lieux',
        'actors': 'comediens', 'resources': 'ressources', 'crew': 'equipe', 'breakdown': 'depouillement',
        'stats': 'stats', 'planning': 'planning', 'expenses': 'depenses'
    };
          
          document.querySelectorAll('.tab-btn').forEach(btn => {
              const tabName = btn.dataset.tab;
              const section = tabToSection[tabName];
              
              if(section && !Permissions.canAccess(section)) {
                  btn.style.opacity = '0.4';
                  btn.style.pointerEvents = 'none';
                  btn.title = 'ðŸ”’ AccÃ¨s restreint';
              } else {
                  btn.style.opacity = '1';
                  btn.style.pointerEvents = 'auto';
                  btn.title = '';
                  
                  // Indiquer si lecture seule
                  if(section && !Permissions.canEdit(section)) {
                      btn.title = 'ðŸ‘ï¸ Lecture seule';
                  }
              }
          });
      },
	
	initCategoriesDragDrop: () => {
        const nav = document.getElementById('tabsCategories');
        if(!nav) return;
        
        let draggedCat = null;
        
        nav.querySelectorAll('.tab-category').forEach(cat => {
            cat.addEventListener('dragstart', (e) => {
                draggedCat = cat;
                cat.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            cat.addEventListener('dragend', () => {
                cat.classList.remove('dragging');
                nav.querySelectorAll('.tab-category').forEach(c => c.classList.remove('drag-over'));
                draggedCat = null;
                UI.saveCategoriesOrder();
            });
            
            cat.addEventListener('dragover', (e) => {
                e.preventDefault();
                if(draggedCat && draggedCat !== cat) {
                    cat.classList.add('drag-over');
                }
            });
            
            cat.addEventListener('dragleave', () => {
                cat.classList.remove('drag-over');
            });
            
            cat.addEventListener('drop', (e) => {
                e.preventDefault();
                cat.classList.remove('drag-over');
                if(draggedCat && draggedCat !== cat) {
                    const allCats = [...nav.querySelectorAll('.tab-category')];
                    const draggedIdx = allCats.indexOf(draggedCat);
                    const targetIdx = allCats.indexOf(cat);
                    
                    if(draggedIdx < targetIdx) {
                        cat.after(draggedCat);
                    } else {
                        cat.before(draggedCat);
                    }
                }
            });
        });
    },
    
    saveCategoriesOrder: () => {
        const nav = document.getElementById('tabsCategories');
        if(!nav) return;
        const order = [...nav.querySelectorAll('.tab-category')].map(c => c.dataset.category);
        if(!state.data.uiConfig) state.data.uiConfig = { tabColors: {}, categoryColors: {}, subColors: {}, tabsOrder: [], categoriesOrder: [], hiddenTabs: [], hiddenCategories: [] };
        state.data.uiConfig.categoriesOrder = order;
        Store.save();
    },
    
    loadCategoriesOrder: () => {
        const uiConfig = state.data?.uiConfig || {};
        const order = uiConfig.categoriesOrder || [];
        if(order.length > 0) {
            const nav = document.getElementById('tabsCategories');
            if(!nav) return;
            const toggle = document.getElementById('hiddenCategoriesToggle');
            order.forEach(catName => {
                const cat = nav.querySelector(`.tab-category[data-category="${catName}"]`);
                if(cat) nav.insertBefore(cat, toggle);
            });
        }
    },
    
    loadCategoryTabsOrder: () => {
        const uiConfig = state.data?.uiConfig || {};
        const savedOrder = uiConfig.categoryTabsOrder || {};
        const savedLabels = uiConfig.categoryLabelsCustom || {};
        
        // Restaurer l'ordre des sous-onglets pour chaque catÃ©gorie
        Object.keys(savedOrder).forEach(category => {
            if(savedOrder[category] && savedOrder[category].length > 0) {
                UI.categoryTabs[category] = savedOrder[category];
            }
        });
        
        // Restaurer les labels personnalisÃ©s (pour les onglets dÃ©placÃ©s)
        Object.keys(savedLabels).forEach(category => {
            if(savedLabels[category]) {
                UI.categoryLabels[category] = { ...UI.categoryLabels[category], ...savedLabels[category] };
            }
        });
    },
    
	initTabsDragDrop: () => {
        const nav = document.getElementById('tabsNav');
        if(!nav) return;
        
        let draggedTab = null;
        
        nav.querySelectorAll('.tab-btn').forEach(tab => {
            tab.addEventListener('dragstart', (e) => {
                draggedTab = tab;
                tab.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            tab.addEventListener('dragend', () => {
                tab.classList.remove('dragging');
                nav.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('drag-over'));
                draggedTab = null;
                UI.updateTabNumbers();
            });
            
            tab.addEventListener('dragover', (e) => {
                e.preventDefault();
                if(draggedTab && draggedTab !== tab) {
                    tab.classList.add('drag-over');
                }
            });
            
            tab.addEventListener('dragleave', () => {
                tab.classList.remove('drag-over');
            });
            
            tab.addEventListener('drop', (e) => {
                e.preventDefault();
                tab.classList.remove('drag-over');
                if(draggedTab && draggedTab !== tab) {
                    const allTabs = [...nav.querySelectorAll('.tab-btn')];
                    const draggedIdx = allTabs.indexOf(draggedTab);
                    const targetIdx = allTabs.indexOf(tab);
                    
                    if(draggedIdx < targetIdx) {
                        tab.after(draggedTab);
                    } else {
                        tab.before(draggedTab);
                    }
                }
            });
        });
    },
    
    updateTabNumbers: () => {
        const nav = document.getElementById('tabsNav');
        if(!nav) return;
        
        nav.querySelectorAll('.tab-btn').forEach((tab, idx) => {
            const text = tab.textContent.replace(/^\d+\.\s*/, '');
            tab.textContent = `${idx + 1}. ${text}`;
        });
    },
	
	  applyLocks: () => {
          document.querySelectorAll('.script-row').forEach(row => {
              const sid = row.dataset.id;
              const lock = state.activeLocks[sid];
              const editor = row.querySelector('.script-editor-box');
              const overlay = row.querySelector('.lock-overlay');
              if(lock && lock.uid !== state.currentUser.uid) { row.classList.add('is-locked'); editor.contentEditable = "false"; overlay.innerText = `ðŸ”’ ModifiÃ© par ${lock.user.split('@')[0]}`; } 
              else { row.classList.remove('is-locked'); if(state.currentRole !== 'viewer') editor.contentEditable = "true"; }
          });
      },
      
      // VÃ©rifie si une section est visible pour un profil dans le contexte projet
      isSectionVisibleForProject: (item, section) => {
          if(!item || !item.hiddenProject) return true;
          return !item.hiddenProject.includes(section);
      }
  };
  
 const Actions = {
      openShareModal: () => { if(state.currentRole !== 'owner') return Utils.toast("Seul le propriÃ©taire peut partager.", "warning"); els.shareModal.style.display = 'flex'; },
      
      // V62: NOUVELLE GESTION DES VERSIONS
      openVersionModal: () => {
          els.versionModal.style.display = 'flex';
          UI.renderVersionList();
      },
      
      // Sauvegarde manuelle (bouton)
      createManualSnapshot: () => {
          Actions.createAutoSnapshot('Manuel');
          Utils.toast("Sauvegarde crÃ©Ã©e !", "success");
      },
      
      // Sauvegarde automatique (appelÃ©e par Store.save)
      createAutoSnapshot: (trigger = 'Auto') => {
          // Clonage profond des donnÃ©es actuelles
          const snapshotData = JSON.parse(JSON.stringify(state.data));
          
          // Ne pas stocker les snapshots dans un snapshot
          delete snapshotData.snapshots;
          
          const snapshot = {
              trigger: trigger,
              date: new Date().toISOString(),
              dateDisplay: new Date().toLocaleString('fr-FR'),
              user: state.currentUser?.email || 'Inconnu',
              filmId: state.data.filmId,
              data: snapshotData
          };
          
          if(!state.data.snapshots) state.data.snapshots = [];
          
          // Ajouter au dÃ©but (plus rÃ©cent en premier)
          state.data.snapshots.unshift(snapshot);
          
          // Garder seulement les 20 derniÃ¨res sauvegardes
          if(state.data.snapshots.length > 20) {
              state.data.snapshots = state.data.snapshots.slice(0, 20);
          }
      },
      
      // VÃ©rifier si on doit crÃ©er un snapshot auto (toutes les 5 min max)
      shouldAutoSnapshot: () => {
          if(!state.data.snapshots || state.data.snapshots.length === 0) return true;
          
          const lastSnapshot = state.data.snapshots[0];
          if(!lastSnapshot.date) return true;
          
          const lastDate = new Date(lastSnapshot.date);
          const now = new Date();
          const diffMinutes = (now - lastDate) / (1000 * 60);
          
          return diffMinutes >= 5;
      },
      
      restoreSnapshot: async (index) => {
          const snap = state.data.snapshots[index];
          if(!snap) return;
          
          if(!await ConfirmModal.show({ title: 'Restaurer cette sauvegarde ?', message: 'Toutes les donnÃ©es actuelles seront REMPLACÃ‰ES.\n\nCette action est irrÃ©versible.', icon: 'âš ï¸', dangerous: true, confirmText: 'Restaurer' })) return;
          
          // On garde l'historique des snapshots actuel et le filmId
          const currentSnapshots = state.data.snapshots;
          const currentFilmId = state.data.filmId;
          
          // On restaure les donnÃ©es
          state.data = JSON.parse(JSON.stringify(snap.data));
          
          // On rÃ©injecte l'historique Ã  jour et le filmId
          state.data.snapshots = currentSnapshots;
          state.data.filmId = currentFilmId;
          
          History.log('EDIT', `Restauration sauvegarde du ${snap.dateDisplay}`);
          Store.save();
          UI.renderAll();
          els.versionModal.style.display = 'none';
          Utils.toast("Projet restaurÃ© !", "success");
      },
      
      deleteSnapshot: async (index) => {
          if(!await ConfirmModal.confirmDelete("Cette sauvegarde sera dÃ©finitivement supprimÃ©e.")) return;
          state.data.snapshots.splice(index, 1);
          Store.save();
          UI.renderVersionList();
      },

      addScene: () => { 
          if(state.currentRole==='viewer')return; 
          const p = (els.inpPre.value.trim() || 'EXT').toUpperCase(); 
          const l = (els.inpLoc.value.trim() || 'LIEU').toUpperCase(); 
          const s = (els.inpSuff.value.trim() || 'JOUR').toUpperCase(); 
          
          // MÃ©moriser l'ancien lieu si on Ã©dite une scÃ¨ne
          let oldLocation = null;
          if(state.currentEditingId) {
              const oldScene = state.data.scenes.find(x => x.id == state.currentEditingId);
              if(oldScene) {
                  const oldParts = oldScene.title.match(/^[^\.]+\.\s*(.+?)\s*-/);
                  if(oldParts) oldLocation = oldParts[1].trim().toUpperCase();
              }
          }
          
          // CrÃ©er le breakdown initial avec les techniciens essentiels
          const initialBreakdown = { 'TECHNICIENS': [] };
          const essentialGroups = ['gc1', 'gc3', 'gc4']; // Image, RÃ©alisation, Son
          essentialGroups.forEach(groupId => {
              const members = state.data.crew.filter(c => c.group_id === groupId);
              members.forEach(member => {
                  if(!initialBreakdown['TECHNICIENS'].includes(member.name)) {
                      initialBreakdown['TECHNICIENS'].push(member.name);
                  }
              });
          });
          
          // Synchroniser aussi les comÃ©diens des personnages
          const persoInput = els.inpPerso.value.trim();
          if(persoInput) {
              const characterNames = persoInput.split(/[,;]/).map(n => n.trim().toUpperCase());
              characterNames.forEach(charName => {
                  // Chercher le personnage et son comÃ©dien associÃ©
                  const character = state.data.characters?.find(c => c.name.toUpperCase() === charName);
                  if(character && character.actor_id) {
                      const actor = state.data.actors?.find(a => a.id === character.actor_id);
                      if(actor && actor.name) {
                          if(!initialBreakdown['COMEDIENS']) initialBreakdown['COMEDIENS'] = [];
                          if(!initialBreakdown['COMEDIENS'].includes(actor.name)) {
                              initialBreakdown['COMEDIENS'].push(actor.name);
                          }
                      }
                  }
              });
          }
          
          const scene = { id: Utils.generateUniqueId(), title: `${p}. ${l} - ${s}`, perso: els.inpPerso.value.trim(), time: els.inpTime.value.trim(), resume: els.inpResume.value, scriptContent: "<div class='sc-action'><br></div>", breakdown: initialBreakdown, tag_id: 't1', lastModified: Date.now(), lastModifiedBy: state.currentUser.email }; 
          
          const isEdit = !!state.currentEditingId;
          
          if(state.currentEditingId) { 
              const idx = state.data.scenes.findIndex(x => x.id == state.currentEditingId); 
              if(idx > -1) { 
                  scene.id = state.currentEditingId; 
                  scene.scriptContent = state.data.scenes[idx].scriptContent; 
                  scene.breakdown = state.data.scenes[idx].breakdown || {}; 
                  scene.tag_id = state.data.scenes[idx].tag_id; 
                  state.data.scenes[idx] = scene; 
              } 
              state.currentEditingId = null; 
              const formBtn = els.editSceneForm?.querySelector('button');
              if(formBtn) formBtn.innerText = 'âž• Ajouter ScÃ¨ne'; 
          } else { 
              state.data.scenes.push(scene); 
          } 
          
          // Log historique
          History.log(isEdit ? 'EDIT' : 'ADD', `${isEdit ? 'Modification' : 'Ajout'} scÃ¨ne : ${scene.title}`);
          
          // RESET UI & FORM POSITION
          els.inpPre.value=''; els.inpLoc.value=''; els.inpSuff.value=''; els.inpPerso.value=''; els.inpTime.value=''; els.inpResume.value=''; 
          
          document.querySelector('.board-main').prepend(els.editSceneForm);
          
          els.inpPre.focus(); 
          UI.renderBoard(); 
          UI.renderScript(); 
          Store.save();
          Utils.notifyImpact('board', ['script', 'breakdown'], isEdit ? 'modifiÃ©' : 'ajoutÃ©');
          
          // VÃ©rifier si l'ancien lieu est devenu orphelin (aprÃ¨s modification)
          if(isEdit && oldLocation && oldLocation !== l) {
              if(!Actions.isLocationUsed(oldLocation)) {
                  Actions.askDeleteOrphanLocation(oldLocation);
              }
          }
      },
      
      editScene: (id) => { 
          if(state.currentRole==='viewer')return; 
          const s = state.data.scenes.find(x => x.id === id || String(x.id) === String(id)); if(!s)return; 
          const parts = s.title.match(/^([^\.]+)\.\s*(.+?)\s*-\s*(.+)$/); 
          if(parts) { els.inpPre.value = parts[1]; els.inpLoc.value = parts[2]; els.inpSuff.value = parts[3]; } 
          else { els.inpPre.value = "EXT"; els.inpLoc.value = s.title; els.inpSuff.value = "JOUR"; } 
          els.inpPerso.value=s.perso; els.inpTime.value=s.time; els.inpResume.value=s.resume; 
          state.currentEditingId=id; 
          const formBtn = els.editSceneForm?.querySelector('button');
          if(formBtn) formBtn.innerText='ðŸ’¾ Mettre Ã  jour'; 
          
          // DEPLACEMENT DU FORMULAIRE
          const card = document.querySelector(`.card[data-id="${id}"]`);
          if(card) {
              els.boardList.insertBefore(els.editSceneForm, card);
              els.editSceneForm.scrollIntoView({behavior: "smooth", block: "center"});
          } else {
              window.scrollTo(0,0);
          }
      },
      
      finalizeScene: async (id) => {
          if(state.currentRole === 'viewer') return;
          const scene = state.data.scenes.find(s => s.id === id);
          if(!scene) return;
          
          const confirmed = await ConfirmModal.show({
              title: 'âœ… Finaliser cette scÃ¨ne ?',
              message: `Le texte de "${scene.title}" sera considÃ©rÃ© comme dÃ©finitif et vous pourrez commencer le dÃ©pouillement.\n\nVous pourrez toujours repasser en brouillon plus tard (le dÃ©pouillement sera rÃ©initialisÃ©).`,
              icon: 'âœ…',
              confirmText: 'Finaliser'
          });
          
          if(confirmed) {
              scene.isFinal = true;
              scene.finalizedAt = new Date().toISOString();
              scene.finalizedBy = state.currentUser?.email || 'Inconnu';
              Store.save();
              UI.renderBoard();
              UI.renderScript();
              Breakdown.init();
              Utils.toast(`"${scene.title}" est maintenant finale`, 'success');
          }
      },
      
      unfinalizeScene: async (id) => {
          if(state.currentRole === 'viewer') return;
          const scene = state.data.scenes.find(s => s.id === id);
          if(!scene) return;
          
          // VÃ©rifier si la scÃ¨ne a un dÃ©pouillement
          const hasBreakdown = scene.breakdown && Object.values(scene.breakdown).some(arr => arr && arr.length > 0);
          
          let message = `"${scene.title}" repassera en mode brouillon.`;
          if(hasBreakdown) {
              message += `\n\nâš ï¸ ATTENTION : Le dÃ©pouillement de cette scÃ¨ne (${Object.values(scene.breakdown).flat().length} Ã©lÃ©ments) sera SUPPRIMÃ‰ car le texte pourrait changer.`;
          }
          
          const confirmed = await ConfirmModal.show({
              title: 'ðŸ“ Repasser en brouillon ?',
              message: message,
              icon: 'ðŸ“',
              dangerous: hasBreakdown,
              confirmText: hasBreakdown ? 'Supprimer le dÃ©pouillement et continuer' : 'Repasser en brouillon'
          });
          
          if(confirmed) {
              scene.isFinal = false;
              
              // Supprimer le dÃ©pouillement si prÃ©sent
              if(hasBreakdown) {
                  scene.breakdown = {};
                  Utils.toast('DÃ©pouillement rÃ©initialisÃ©', 'info');
              }
              
              Store.save();
              UI.renderBoard();
              UI.renderScript();
              Breakdown.init();
              Utils.toast(`"${scene.title}" est maintenant en brouillon`, 'success');
          }
      },
      
      deleteScene: async (id) => { 
          if(state.currentRole==='viewer') return; 
          const sceneToDelete = state.data.scenes.find(s => s.id === id || String(s.id) === String(id));
          if(!sceneToDelete) return;
          
          // VÃ©rifier si la scÃ¨ne est dans une feuille de service
          const affectedDays = (state.data.shootingDays || []).filter(day => 
              day.scenes && day.scenes.some(ref => ref.sceneId === id || String(ref.sceneId) === String(id))
          );
          
          let confirmMessage = 'Supprimer cette scÃ¨ne ?';
          if(affectedDays.length > 0) {
              const dayNames = affectedDays.map(d => d.name || Utils.formatDate(d.date || d.startDate)).join(', ');
              confirmMessage = `âš ï¸ ATTENTION !\n\nCette scÃ¨ne est programmÃ©e dans ${affectedDays.length} jour(s) de tournage :\n${dayNames}\n\nLa scÃ¨ne sera automatiquement retirÃ©e de ces feuilles de service.\n\nVoulez-vous vraiment supprimer cette scÃ¨ne ?`;
          }
          
          if(await ConfirmModal.show({ title: 'Supprimer cette scÃ¨ne ?', message: confirmMessage, icon: 'ðŸ—‘ï¸', dangerous: true, confirmText: 'Supprimer' })){ 
              // 1. Supprimer les plans storyboard associÃ©s
              if(state.data.shots) {
                  state.data.shots = state.data.shots.filter(shot => shot.sceneId !== id && String(shot.sceneId) !== String(id));
              }
              
              // 2. Retirer la scÃ¨ne du planning (journÃ©es de tournage)
              if(state.data.shootingDays) {
                  state.data.shootingDays.forEach(day => {
                      if(day.scenes) {
                          day.scenes = day.scenes.filter(ref => ref.sceneId !== id && String(ref.sceneId) !== String(id));
                      }
                  });
                  // Supprimer les jours de tournage vides
                  state.data.shootingDays = state.data.shootingDays.filter(day => day.scenes && day.scenes.length > 0);
              }
              
              // 3. Supprimer les commentaires (stockÃ©s dans data.comments)
              if(state.data.comments && state.data.comments[id]) {
                  delete state.data.comments[id];
              }
              
              // 4. Supprimer la scÃ¨ne
              state.data.scenes = state.data.scenes.filter(s => s.id !== id && String(s.id) !== String(id)); 
              if(state.currentEditingId === id) {
                  state.currentEditingId = null;
                  const btn = document.querySelector('.controls-row button');
                  if(btn) btn.innerText = 'âž• Ajouter ScÃ¨ne';
                  if(els.inpPre) els.inpPre.value=''; 
                  if(els.inpLoc) els.inpLoc.value=''; 
                  if(els.inpSuff) els.inpSuff.value=''; 
                  if(els.inpPerso) els.inpPerso.value=''; 
                  if(els.inpTime) els.inpTime.value=''; 
                  if(els.inpResume) els.inpResume.value='';
              }
              // Log historique
              History.log('DELETE', `Suppression scÃ¨ne : ${sceneToDelete?.title || 'Sans titre'}`);
              UI.renderBoard(); 
              UI.renderScript(); 
              Store.save();
              Utils.notifyImpact('board', ['script', 'breakdown', 'storyboard', 'planning'], 'supprimÃ©');
              
              // VÃ©rifier si le lieu est devenu orphelin
              const locParts = sceneToDelete.title.match(/^[^\.]+\.\s*(.+?)\s*-/);
              if(locParts && locParts[1]) {
                  const locName = locParts[1].trim().toUpperCase();
                  if(!Actions.isLocationUsed(locName)) {
                      Actions.askDeleteOrphanLocation(locName);
                  }
              }
              
              // VÃ©rifier si des personnages sont devenus orphelins
              if(sceneToDelete.perso) {
                  const charNames = sceneToDelete.perso.split(/[,;]|\bet\b/i).map(n => n.trim().toUpperCase()).filter(n => n.length);
                  const orphanChars = charNames.filter(name => !Actions.isCharacterUsed(name));
                  if(orphanChars.length > 0) {
                      setTimeout(() => Actions.askDeleteOrphanCharacters(orphanChars), 500); // DÃ©lai pour laisser la premiÃ¨re modale se fermer
                  }
              }
          } 
      },
      
      updateOrder: (fromTab) => { 
          let newIds = []; 
          if (fromTab === 'script') newIds = Array.from(els.scriptContainer.children).map(c => c.dataset.id); 
          else newIds = Array.from(els.boardList.children).map(c => c.dataset.id); 
          
          const newScenes = []; 
          newIds.forEach(id => { const s = state.data.scenes.find(x => String(x.id) === String(id)); if(s) newScenes.push(s); }); 
          
          if(newScenes.length === state.data.scenes.length) {
              // VÃ©rifier si des scÃ¨nes planifiÃ©es ont changÃ© de numÃ©ro
              const plannedScenes = [];
              if(state.data.shootingDays) {
                  state.data.shootingDays.forEach(day => {
                      (day.scenes || []).forEach(ref => {
                          const oldIdx = state.data.scenes.findIndex(s => s.id === ref.sceneId);
                          const newIdx = newScenes.findIndex(s => s.id === ref.sceneId);
                          if(oldIdx !== -1 && newIdx !== -1 && oldIdx !== newIdx) {
                              const scene = newScenes[newIdx];
                              plannedScenes.push({
                                  title: scene.title,
                                  oldNum: oldIdx + 1,
                                  newNum: newIdx + 1,
                                  day: day.name || Utils.formatDate(day.date || day.startDate)
                              });
                          }
                      });
                  });
              }
              
              state.data.scenes = newScenes; 
              if(fromTab === 'script') UI.renderScript(); else UI.renderBoard(); 
              Store.save();
              
              // Notifier si des scÃ¨nes planifiÃ©es ont changÃ© de numÃ©ro
              if(plannedScenes.length > 0) {
                  const details = plannedScenes.slice(0, 3).map(p => `#${p.oldNum}â†’#${p.newNum} (${p.day})`).join(', ');
                  const more = plannedScenes.length > 3 ? ` +${plannedScenes.length - 3} autres` : '';
                  Utils.toast(`âš ï¸ ScÃ¨nes planifiÃ©es renumÃ©rotÃ©es : ${details}${more}`, 'warning', 5000);
              }
          } else {
              console.error("Erreur de tri : dÃ©calage d'IDs dÃ©tectÃ©.", newIds, newScenes.length, state.data.scenes.length);
          }
      },
      
      syncCharacters: () => { const found = new Set(); state.data.scenes.forEach(s => { if(!s.perso) return; s.perso.split(/[,;]|\bet\b/i).map(n=>n.trim()).filter(n=>n.length).forEach(n=>found.add(n)); }); found.forEach(name => { if(!state.data.characters.find(c => c.name.toLowerCase() === name.toLowerCase())) state.data.characters.push({ name: name, bio: "", group_id: "", gender: "" }); }); },
      syncLocations: () => { const found = new Set(); state.data.scenes.forEach(s => { const parts = s.title.match(/^[^\.]+\.\s*(.+?)\s*-/); if(parts && parts[1]) found.add(parts[1].trim().toUpperCase()); }); found.forEach(locName => { if(!state.data.locations.find(l => l.name === locName)) state.data.locations.push({ name: locName, desc: "", group_id: "" }); }); },
      
      // VÃ©rifie si un lieu est utilisÃ© dans d'autres scÃ¨nes (exclut la scÃ¨ne passÃ©e en paramÃ¨tre)
      isLocationUsed: (locationName, excludeSceneId = null) => {
          const locUpper = locationName.toUpperCase();
          return state.data.scenes.some(s => {
              if(excludeSceneId && (s.id === excludeSceneId || String(s.id) === String(excludeSceneId))) return false;
              const parts = s.title.match(/^[^\.]+\.\s*(.+?)\s*-/);
              return parts && parts[1].trim().toUpperCase() === locUpper;
          });
      },
      
      // VÃ©rifie si un personnage est utilisÃ© dans d'autres scÃ¨nes (exclut la scÃ¨ne passÃ©e en paramÃ¨tre)
      isCharacterUsed: (characterName, excludeSceneId = null) => {
          const charUpper = characterName.toUpperCase();
          return state.data.scenes.some(s => {
              if(excludeSceneId && (s.id === excludeSceneId || String(s.id) === String(excludeSceneId))) return false;
              if(!s.perso) return false;
              const chars = s.perso.split(/[,;]|\bet\b/i).map(n => n.trim().toUpperCase());
              return chars.includes(charUpper);
          });
      },
      
      // Propose de supprimer un lieu orphelin
      askDeleteOrphanLocation: async (locationName) => {
          const loc = state.data.locations.find(l => l.name.toUpperCase() === locationName.toUpperCase());
          if(!loc) return;
          
          const confirmed = await ConfirmModal.show({
              title: 'DÃ©cor inutilisÃ©',
              message: `Le dÃ©cor "${locationName}" n'est plus utilisÃ© dans aucune scÃ¨ne.\n\nVoulez-vous le supprimer de la liste des dÃ©cors ?`,
              icon: 'ðŸ“',
              confirmText: 'Supprimer',
              cancelText: 'Garder',
              dangerous: false
          });
          
          if(confirmed) {
              state.data.locations = state.data.locations.filter(l => l.name.toUpperCase() !== locationName.toUpperCase());
              Store.save();
              Utils.toast(`DÃ©cor "${locationName}" supprimÃ©`, 'success');
          }
      },
      
      // Propose de supprimer des personnages orphelins
      askDeleteOrphanCharacters: async (characterNames) => {
          if(!characterNames || characterNames.length === 0) return;
          
          const orphans = characterNames.filter(name => {
              return state.data.characters.find(c => c.name.toUpperCase() === name.toUpperCase());
          });
          
          if(orphans.length === 0) return;
          
          const listText = orphans.map(n => `â€¢ ${n}`).join('\n');
          const confirmed = await ConfirmModal.show({
              title: 'Personnage(s) inutilisÃ©(s)',
              message: `${orphans.length > 1 ? 'Ces personnages ne sont' : 'Ce personnage n\'est'} plus utilisÃ©(s) dans aucune scÃ¨ne :\n\n${listText}\n\nVoulez-vous ${orphans.length > 1 ? 'les' : 'le'} supprimer de la liste des personnages ?`,
              icon: 'ðŸ‘¤',
              confirmText: 'Supprimer',
              cancelText: 'Garder',
              dangerous: false
          });
          
          if(confirmed) {
              orphans.forEach(name => {
                  state.data.characters = state.data.characters.filter(c => c.name.toUpperCase() !== name.toUpperCase());
              });
              Store.save();
              Utils.toast(`${orphans.length} personnage(s) supprimÃ©(s)`, 'success');
          }
      },
      updateDataItem: (type, idx, val) => { if(state.data[type][idx]) { const key = (type === 'characters' || type === 'actors') ? 'bio' : 'desc'; state.data[type][idx][key] = val; Store.save(); } },
      deleteDataItem: async (type, idx) => { 
          if(await ConfirmModal.confirmDelete("Cet Ã©lÃ©ment sera supprimÃ©.")) { 
              // Si on supprime un acteur, dÃ©lier les personnages associÃ©s
              if(type === 'actors') {
                  const actorId = state.data.actors[idx]?.id;
                  const actorName = state.data.actors[idx]?.name;
                  let impactedTabs = [];
                  if(actorId) {
                      // VÃ©rifier si le comÃ©dien Ã©tait planifiÃ©
                      let plannedDays = 0;
                      if(state.data.shootingDays) {
                          state.data.shootingDays.forEach(day => {
                              if(day.callSheet && day.callSheet.some(call => call.personId === actorId && call.type === 'actor')) {
                                  plannedDays++;
                              }
                          });
                      }
                      if(plannedDays > 0) impactedTabs.push('planning');
                      
                      // DÃ©lier les personnages
                      let linkedChars = 0;
                      state.data.characters.forEach(char => {
                          if(char.actor_id === actorId) {
                              delete char.actor_id;
                              linkedChars++;
                          }
                      });
                      if(linkedChars > 0) impactedTabs.push('chars');
                      
                      // Retirer des feuilles de service (callSheet)
                      if(state.data.shootingDays) {
                          state.data.shootingDays.forEach(day => {
                              if(day.callSheet) {
                                  day.callSheet = day.callSheet.filter(
                                      call => !(call.personId === actorId && call.type === 'actor')
                                  );
                              }
                          });
                      }
                      // Supprimer les dÃ©penses de salaire associÃ©es
                      if(state.data.expenses) {
                          const hadExpenses = state.data.expenses.some(e => e.salaryPersonId === actorId && e.salaryPersonType === 'actor');
                          if(hadExpenses) impactedTabs.push('expenses');
                          state.data.expenses = state.data.expenses.filter(
                              e => !(e.salaryPersonId === actorId && e.salaryPersonType === 'actor')
                          );
                      }
                      
                      // Notification si impacts
                      if(impactedTabs.length > 0) {
                          Utils.notifyImpact('actors', impactedTabs, 'supprimÃ©');
                      }
                  }
              }
              
              // Si on supprime un personnage, le retirer du breakdown de toutes les scÃ¨nes
              if(type === 'characters') {
                  const charName = state.data.characters[idx]?.name;
                  if(charName) {
                      let hadBreakdown = false;
                      state.data.scenes.forEach(scene => {
                          if(scene.breakdown && scene.breakdown["PERSONNAGES"]) {
                              const before = scene.breakdown["PERSONNAGES"].length;
                              scene.breakdown["PERSONNAGES"] = scene.breakdown["PERSONNAGES"].filter(
                                  name => name.toLowerCase() !== charName.toLowerCase()
                              );
                              if(scene.breakdown["PERSONNAGES"].length < before) hadBreakdown = true;
                          }
                      });
                      if(hadBreakdown) Utils.notifyImpact('chars', 'breakdown', 'supprimÃ©');
                  }
              }
              
              // Si on supprime un lieu, le retirer du breakdown de toutes les scÃ¨nes
              if(type === 'locations') {
                  const locName = state.data.locations[idx]?.name;
                  if(locName) {
                      let hadBreakdown = false;
                      state.data.scenes.forEach(scene => {
                          if(scene.breakdown && scene.breakdown["DECORS-LIEUX"]) {
                              const before = scene.breakdown["DECORS-LIEUX"].length;
                              scene.breakdown["DECORS-LIEUX"] = scene.breakdown["DECORS-LIEUX"].filter(
                                  name => name.toLowerCase() !== locName.toLowerCase()
                              );
                              if(scene.breakdown["DECORS-LIEUX"].length < before) hadBreakdown = true;
                          }
                      });
                      if(hadBreakdown) Utils.notifyImpact('locs', 'breakdown', 'supprimÃ©');
                  }
              }
              
              state.data[type].splice(idx, 1); 
              Store.save(); 
              type === 'characters' ? UI.renderDataTab('characters', els.charContainer) : (type === 'actors' ? UI.renderDataTab('actors', els.actorContainer) : UI.renderDataTab('locations', els.locContainer)); 
          } 
      },
      addGroup: (type) => { 
        const typeLabel = type === 'perso' ? 'personnages' : (type === 'actor' ? 'comÃ©diens' : 'lieux');
        
        const modal = document.createElement('div');
        modal.id = 'add-group-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10001;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:400px;width:90%;">
                <h3 class="mt-0">âž• Nouveau groupe de ${typeLabel}</h3>
                <div class="mb-15">
                    <label class="label-bold">IcÃ´ne</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div id="new-group-icon" class="n8-flex-1">ðŸ“</div>
                        <button onclick="app.Utils.showIconPicker((icon) => document.getElementById('new-group-icon').textContent = icon)" style="padding:8px 15px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Changer</button>
                    </div>
                </div>
                <div class="mb-20">
                    <label class="label-bold">Nom du groupe</label>
                    <input type="text" id="new-group-name" placeholder="Ex: Protagonistes, DÃ©cors nuit..." class="n8-input-13">
                </div>
                <div class="flex-end-compact">
                    <button onclick="this.closest('div[style*=fixed]').remove()" class="btn-outline-compact">Annuler</button>
                    <button onclick="app.Actions.confirmAddGroup('${type}')" class="btn-success-compact2">CrÃ©er</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('new-group-name').focus();
    },
    
    confirmAddGroup: (type) => {
        const name = document.getElementById('new-group-name').value.trim();
        const icon = document.getElementById('new-group-icon').textContent;
        
        if(!name) {
            Utils.toast('Veuillez entrer un nom pour le groupe.', 'warning');
            return;
        }
        
        state.data.groups.push({ id: 'g'+Date.now(), name: icon + ' ' + name, type: type, icon: icon });
        History.log('ADD', `Ajout groupe : ${icon} ${name}`);
        Store.save();
        
        // Fermer le modal
        const modal = document.getElementById('add-group-modal');
        if(modal) modal.remove();
        
        if(type==='perso') UI.renderDataTab('characters', els.charContainer); 
        else if(type==='actor') UI.renderDataTab('actors', els.actorContainer); 
        else UI.renderDataTab('locations', els.locContainer);
    },
      changeGroup: (type, idx, gid) => { state.data[type][idx].group_id = gid; Store.save(); if(type==='characters') UI.renderDataTab(type, els.charContainer); else if(type==='actors') UI.renderDataTab(type, els.actorContainer); else UI.renderDataTab(type, els.locContainer); },
      // VÃ©rifie si un profil public existe pour cet email et propose de le lier
      checkAndLinkPublicProfile: async (email, type, idx) => {
          if(!email || !email.includes('@')) return false;
          
          const typeLabel = type === 'actor' ? 'comÃ©dien' : 'technicien';
          const dataArray = type === 'actor' ? state.data.actors : state.data.crew;
          
          try {
              // Chercher dans user_profiles
              const { data: profiles, error } = await supabase
                  .from('user_profiles')
                  .select('*')
                  .eq('email', email.toLowerCase());
              
              if(!error && profiles && profiles.length > 0) {
                  const existingProfile = profiles[0];
                  const profileId = existingProfile.id;
                  
                  // CrÃ©er le modal de confirmation
                  const modal = document.createElement('div');
                  modal.id = 'link-profile-modal';
                  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:99999;';
                  modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                  
                  const photoHtml = existingProfile.photo 
                      ? `<img src="${existingProfile.photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:10px;">` 
                      : `<div style="width:80px;height:80px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:2rem;color:white;margin-bottom:10px;">${(existingProfile.name || '?')[0].toUpperCase()}</div>`;
                  
                  modal.innerHTML = `
                      <div style="background:var(--panel-bg);border-radius:12px;padding:25px;width:450px;max-width:90%;text-align:center;">
                          <h3 style="margin:0 0 20px;color:var(--text-main);">ðŸ” Profil existant trouvÃ© !</h3>
                          
                          <p style="color:var(--text-sec);margin-bottom:20px;">Un profil ${typeLabel} existe dÃ©jÃ  Ã  l'adresse <strong>${email}</strong></p>
                          
                          <div style="background:var(--bg);border-radius:10px;padding:20px;margin-bottom:20px;">
                              ${photoHtml}
                              <div style="font-size:1.2rem;font-weight:bold;color:var(--text-main);">${Utils.escape(existingProfile.name || 'Sans nom')}</div>
                              <div style="color:var(--text-sec);margin-top:5px;">${Utils.escape(existingProfile.city || '')} ${existingProfile.age ? 'â€¢ ' + existingProfile.age + ' ans' : ''}</div>
                              ${existingProfile.role ? `<div style="color:var(--primary);margin-top:5px;">${Utils.escape(existingProfile.role)}</div>` : ''}
                              ${existingProfile.department ? `<div style="color:var(--text-sec);font-size:0.9rem;">${Utils.escape(existingProfile.department)}</div>` : ''}
                          </div>
                          
                          <p style="color:var(--text-main);margin-bottom:20px;">Est-ce la bonne personne ?</p>
                          
                          <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                              <button onclick="app.Actions.confirmLinkProfile('${profileId}', '${type}', ${idx})" style="padding:12px 25px;background:var(--success);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">âœ… Oui, lier ce profil</button>
                              <button onclick="document.getElementById('link-profile-modal').remove()" style="padding:12px 25px;background:var(--bg);color:var(--text-main);border:1px solid var(--border);border-radius:8px;cursor:pointer;">âŒ Non, ce n'est pas lui/elle</button>
                          </div>
                          
                          <p style="color:var(--text-sec);font-size:0.85rem;margin-top:15px;">Si ce n'est pas la bonne personne, vÃ©rifiez l'adresse email.</p>
                      </div>
                  `;
                  
                  document.body.appendChild(modal);
                  return true; // Profil trouvÃ©
              }
              return false; // Pas de profil trouvÃ©
          } catch(e) {
              console.warn('Erreur vÃ©rification profil:', e);
              return false;
          }
      },
      
      // Confirme la liaison d'un profil public
      confirmLinkProfile: async (profileId, type, idx) => {
          const dataArray = type === 'actor' ? state.data.actors : state.data.crew;
          
          try {
              const { data: publicData, error } = await supabase
                  .from('user_profiles')
                  .select('*')
                  .eq('id', profileId)
                  .single();
              
              if (error) throw error;
              
              if(publicData && dataArray[idx]) {
                  // Lier le profil
                  dataArray[idx].publicProfileId = profileId;
                  
                  // Mettre Ã  jour les donnÃ©es
                  dataArray[idx].name = publicData.name || dataArray[idx].name;
                  dataArray[idx].photo = publicData.photo || dataArray[idx].photo;
                  dataArray[idx].phone = publicData.phone || dataArray[idx].phone;
                  dataArray[idx].city = publicData.city || dataArray[idx].city;
                  dataArray[idx].bio = publicData.bio || dataArray[idx].bio;
                  
                  Store.save();
                  
                  // Fermer le modal
                  document.getElementById('link-profile-modal')?.remove();
                  
                  // Re-render
                  if(type === 'actor') {
                      UI.renderDataTab('actors', els.actorContainer);
                  } else {
                      UI.renderCrewTab();
                  }
                  
                  Utils.toast('Profil liÃ© avec succÃ¨s !', 'success');
                  
                  // Proposer de notifier
                  const person = dataArray[idx];
                  setTimeout(async () => {
                      if(await ConfirmModal.show({ title: 'PrÃ©venir cette personne ?', message: `Envoyer une notification Ã  ${person.name} pour l'informer qu'il/elle a Ã©tÃ© ajoutÃ©(e) au projet ?`, icon: 'ðŸ“§', confirmText: 'Envoyer' })) {
                          Actions.notifyNewProfile(person, type);
                      }
                  }, 300);
              }
          } catch(e) {
              console.error('Erreur liaison profil:', e);
              Utils.toast('Erreur lors de la liaison', 'error');
          }
      },
      
      // Synchronise les acteurs du projet avec leurs profils publics
      syncActorsFromPublicProfiles: async () => {
          if(!state.data.actors) return;
          
          let hasChanges = false;
          
          // D'abord, vÃ©rifier si des acteurs sans publicProfileId correspondent Ã  un profil public existant
          for(let i = 0; i < state.data.actors.length; i++) {
              const actor = state.data.actors[i];
              if(!actor.publicProfileId && actor.email) {
                  try {
                      // Chercher par email dans user_profiles
                      const { data: profiles } = await supabase
                          .from('user_profiles')
                          .select('id')
                          .eq('email', actor.email.toLowerCase());
                      if(profiles && profiles.length > 0) {
                          actor.publicProfileId = profiles[0].id;
                          hasChanges = true;
                      }
                  } catch(e) {
                      console.warn('Erreur vÃ©rification profil public:', e);
                  }
              }
          }
          
          // Ensuite, synchroniser les donnÃ©es des profils liÃ©s
          for(let i = 0; i < state.data.actors.length; i++) {
              const actor = state.data.actors[i];
              if(actor.publicProfileId) {
                  try {
                      const { data: publicData } = await supabase
                          .from('user_profiles')
                          .select('*')
                          .eq('id', actor.publicProfileId)
                          .single();
                      if(publicData) {
                          // Extraire les donnÃ©es du champ JSONB
                          const extraData = publicData.data || {};
                          // Mettre Ã  jour les donnÃ©es de l'acteur avec le profil public
                          actor.name = publicData.name || actor.name;
                          actor.photo = publicData.photo || actor.photo;
                          actor.phone = publicData.phone || actor.phone;
                          actor.bio = publicData.bio || actor.bio;
                          actor.gender = publicData.gender || actor.gender;
                          actor.city = publicData.city || actor.city;
                          // DonnÃ©es depuis extraData
                          actor.height = extraData.height || actor.height;
                          actor.age = extraData.age || actor.age;
                          actor.eyeColor = extraData.eyeColor || actor.eyeColor;
                          actor.hairColor = extraData.hairColor || actor.hairColor;
                          actor.hairLength = extraData.hairLength || actor.hairLength;
                          actor.ethnicity = extraData.ethnicity || actor.ethnicity;
                          actor.corpulence = extraData.corpulence || actor.corpulence;
                          actor.weight = extraData.weight || actor.weight;
                          actor.languages = extraData.languages || actor.languages;
                          actor.sports = extraData.sports || actor.sports;
                          actor.dailyRate = extraData.dailyRate || actor.dailyRate;
                          actor.rateCurrency = extraData.rateCurrency || actor.rateCurrency;
                          actor.rateType = extraData.rateType || actor.rateType;
                          actor.website = extraData.website || actor.website;
                          actor.demoreel = extraData.demoreel || actor.demoreel;
                          actor.galleryPhotos = extraData.galleryPhotos || actor.galleryPhotos || [];
                          actor.hasVehicle = publicData.vehicle || actor.hasVehicle;
                          actor.vehicleType = extraData.vehicleType || actor.vehicleType;
                          actor.vehiclePlate = extraData.vehiclePlate || actor.vehiclePlate;
                          actor.vehicleSeats = extraData.vehicleSeats || actor.vehicleSeats;
                          actor.vehicleTrunk = extraData.vehicleTrunk || actor.vehicleTrunk;
                          actor.vehicleNotes = extraData.vehicleNotes || actor.vehicleNotes;
                          actor.availabilityText = publicData.availability || actor.availabilityText;
                          actor.availabilityDates = extraData.availabilityDates || actor.availabilityDates;
                          actor.unavailabilityDates = extraData.unavailabilityDates || actor.unavailabilityDates;
                          actor.professionalStatus = extraData.professionalStatus || actor.professionalStatus;
                          actor.collabType = extraData.collabType || actor.collabType;
                          // PrÃ©fÃ©rences de visibilitÃ©
                          actor.hiddenProject = extraData.hiddenProject || [];
                          // Marquer comme synchronisÃ©
                          actor.lastSyncedAt = Date.now();
                      }
                  } catch(e) {
                      console.warn('Erreur sync profil public:', e);
                  }
              }
          }
          // Sauvegarder les donnÃ©es mises Ã  jour
          Store.save();
      },
      
      // Synchronise les techniciens du projet avec leurs profils publics
      syncCrewFromPublicProfiles: async () => {
          if(!state.data.crew) return;
          
          let hasChanges = false;
          
          // D'abord, vÃ©rifier si des techniciens sans publicProfileId correspondent Ã  un profil public existant
          for(let i = 0; i < state.data.crew.length; i++) {
              const member = state.data.crew[i];
              if(!member.publicProfileId && member.email) {
                  try {
                      // Chercher par email dans user_profiles
                      const { data: profiles } = await supabase
                          .from('user_profiles')
                          .select('id')
                          .eq('email', member.email.toLowerCase());
                      if(profiles && profiles.length > 0) {
                          member.publicProfileId = profiles[0].id;
                          hasChanges = true;
                      }
                  } catch(e) {
                      console.warn('Erreur vÃ©rification profil public:', e);
                  }
              }
          }
          
          // Ensuite, synchroniser les donnÃ©es des profils liÃ©s
          for(let i = 0; i < state.data.crew.length; i++) {
              const member = state.data.crew[i];
              if(member.publicProfileId) {
                  try {
                      const { data: publicData } = await supabase
                          .from('user_profiles')
                          .select('*')
                          .eq('id', member.publicProfileId)
                          .single();
                      if(publicData) {
                          // Extraire les donnÃ©es du champ JSONB
                          const extraData = publicData.data || {};
                          // Mettre Ã  jour les donnÃ©es du technicien avec le profil public
                          member.name = publicData.name || member.name;
                          member.photo = publicData.photo || member.photo;
                          member.phone = publicData.phone || member.phone;
                          member.email = publicData.email || member.email;
                          member.gender = publicData.gender || member.gender;
                          member.city = publicData.city || member.city;
                          // DonnÃ©es depuis extraData
                          member.address = extraData.address || member.address;
                          member.role = extraData.role || member.role;
                          member.department = extraData.department || member.department;
                          member.dailyRate = extraData.dailyRate || member.dailyRate;
                          member.rateCurrency = extraData.rateCurrency || member.rateCurrency;
                          member.rateType = extraData.rateType || member.rateType;
                          member.availabilityText = publicData.availability || member.availabilityText;
                          member.availabilityDates = extraData.availabilityDates || member.availabilityDates;
                          member.unavailabilityDates = extraData.unavailabilityDates || member.unavailabilityDates;
                          member.demoreel = extraData.demoreel || member.demoreel;
                          member.galleryPhotos = extraData.crewGalleryPhotos || extraData.galleryPhotos || member.galleryPhotos || [];
                          member.hasVehicle = publicData.vehicle || member.hasVehicle;
                          member.vehicleType = extraData.vehicleType || member.vehicleType;
                          member.vehiclePlate = extraData.vehiclePlate || member.vehiclePlate;
                          member.vehicleSeats = extraData.vehicleSeats || member.vehicleSeats;
                          member.vehicleTrunk = extraData.vehicleTrunk || member.vehicleTrunk;
                          member.vehicleNotes = extraData.vehicleNotes || member.vehicleNotes;
                          member.professionalStatus = extraData.professionalStatus || member.professionalStatus;
                          member.collabType = extraData.collabType || member.collabType;
                          // PrÃ©fÃ©rences de visibilitÃ©
                          member.hiddenProject = extraData.hiddenProject || [];
                          // Marquer comme synchronisÃ©
                          member.lastSyncedAt = Date.now();
                      }
                  } catch(e) {
                      console.warn('Erreur sync profil public crew:', e);
                  }
              }
          }
          // Sauvegarder les donnÃ©es mises Ã  jour
          Store.save();
      },
      
      linkActor: (charIdx, actorId) => { 
          if(!state.data.characters[charIdx]) return; 
          state.data.characters[charIdx].actor_id = actorId; 
          
          const character = state.data.characters[charIdx];
          
          // Mettre Ã  jour le sexe du personnage selon le comÃ©dien liÃ©
          if(actorId) {
              const actor = state.data.actors.find(a => a.id === actorId || String(a.id) === String(actorId));
              if(actor && actor.gender) {
                  state.data.characters[charIdx].gender = actor.gender;
              }
              
              // Synchroniser le comÃ©dien dans le dÃ©pouillement des scÃ¨nes oÃ¹ ce personnage apparaÃ®t
              if(actor && actor.name && character.name) {
                  const charNameUpper = character.name.toUpperCase();
                  state.data.scenes.forEach(scene => {
                      // VÃ©rifier si le personnage est dans cette scÃ¨ne
                      const hasCharacter = scene.perso && scene.perso.toUpperCase().includes(charNameUpper);
                      const inBreakdown = scene.breakdown && scene.breakdown['PERSONNAGES'] && 
                          scene.breakdown['PERSONNAGES'].some(p => p.toUpperCase() === charNameUpper);
                      
                      if(hasCharacter || inBreakdown) {
                          if(!scene.breakdown) scene.breakdown = {};
                          if(!scene.breakdown['COMEDIENS']) scene.breakdown['COMEDIENS'] = [];
                          if(!scene.breakdown['COMEDIENS'].includes(actor.name)) {
                              scene.breakdown['COMEDIENS'].push(actor.name);
                          }
                      }
                  });
              }
          }
          
          Store.save(); 
          UI.renderDataTab('characters', els.charContainer);
          if(actorId) {
              Utils.notifyImpact('chars', 'breakdown', 'liÃ©');
          }
      },
      addActor: async () => { 
          if(state.currentRole !== 'owner' && !Permissions.canEdit('comediens')) {
              Utils.toast('Vous n\'avez pas la permission d\'ajouter des comÃ©diens.', 'error');
              return;
          }
          const name = await ConfirmModal.prompt("Entrez le nom du comÃ©dien ou de la comÃ©dienne.", "Nouveau comÃ©dien", "Nom..."); if(name) { const newActor = { id: 'act_'+Date.now(), name: name, gender: "", bio: "", email: "", phone: "", address: "", city: "", website: "", photo: "", group_id: "", hasVehicle: false, vehicleType: "", vehiclePlate: "", vehicleSeats: "", vehicleTrunk: false, vehicleNotes: "", dailyRate: "", rateCurrency: "â‚¬", rateType: "Jour", availabilityText: "", availabilityDates: [], color: "", height: "", weight: "", age: "", eyeColor: "", hairColor: "", hairLength: "", ethnicity: "", corpulence: "", sports: "", languages: "", demoreel: "", galleryPhotos: [] }; state.data.actors.push(newActor); History.log('ADD', `Ajout comÃ©dien : ${name}`); Store.save(); UI.renderDataTab('actors', els.actorContainer); } },
      updateActorMeta: (idx, field, val) => { 
          if(state.data.actors[idx]) { 
              const oldVal = state.data.actors[idx][field];
              state.data.actors[idx][field] = val; 
              Store.save(); 
              if(field === 'photo') UI.renderDataTab('actors', els.actorContainer);
              
              // Si on ajoute un email valide, vÃ©rifier si un profil public existe
              if(field === 'email' && val && val.includes('@') && val !== oldVal) {
                  Actions.checkAndLinkPublicProfile(val, 'actor', idx).then(found => {
                      if(!found) {
                          // Pas de profil existant, proposer de notifier pour crÃ©er
                          const actor = state.data.actors[idx];
                          setTimeout(async () => {
                              if(await ConfirmModal.show({ title: 'Envoyer une invitation ?', message: `Aucun profil comÃ©dien trouvÃ© pour ${val}.\n\nEnvoyer une invitation Ã  ${actor.name} pour crÃ©er son profil ?`, icon: 'ðŸ“¨', confirmText: 'Inviter' })) {
                                  Actions.notifyNewProfile(actor, 'actor');
                              }
                          }, 300);
                      }
                  });
              }
          } 
      },
      updateCharacterMeta: (idx, field, val) => { if(state.data.characters[idx]) { state.data.characters[idx][field] = val; Store.save(); } },
      toggleActorVehicle: (idx, hasVehicle) => { if(state.data.actors[idx]) { state.data.actors[idx].hasVehicle = hasVehicle; Store.save(); const vehicleDetails = document.getElementById(`actor-vehicle-${idx}`); if(vehicleDetails) { if(hasVehicle) { vehicleDetails.classList.add('visible'); } else { vehicleDetails.classList.remove('visible'); } } } },
      addActorGalleryPhoto: (idx) => {
          const input = document.getElementById(`actor-gallery-input-${idx}`);
          if(!input || !input.value.trim()) { Utils.toast('Veuillez entrer une URL de photo.', 'warning'); return; }
          if(!state.data.actors[idx].galleryPhotos) state.data.actors[idx].galleryPhotos = [];
          state.data.actors[idx].galleryPhotos.push(input.value.trim());
          Store.save();
          UI.renderDataTab('actors', els.actorContainer);
      },
      removeActorGalleryPhoto: (actorIdx, photoIdx) => {
          if(state.data.actors[actorIdx] && state.data.actors[actorIdx].galleryPhotos) {
              state.data.actors[actorIdx].galleryPhotos.splice(photoIdx, 1);
              Store.save();
              UI.renderDataTab('actors', els.actorContainer);
          }
      },
      
      removeActorAvailability: (actorIdx, dateIdx) => {
          if(state.data.actors[actorIdx] && state.data.actors[actorIdx].availabilityDates) {
              state.data.actors[actorIdx].availabilityDates.splice(dateIdx, 1);
              Store.save();
              UI.renderDataTab('actors', els.actorContainer);
          }
      },

      
      removeActorUnavailability: (actorIdx, dateIdx) => {
          if(state.data.actors[actorIdx] && state.data.actors[actorIdx].unavailabilityDates) {
              state.data.actors[actorIdx].unavailabilityDates.splice(dateIdx, 1);
              Store.save();
              UI.renderDataTab('actors', els.actorContainer);
          }
      },
      
      // === DÃ‰CORS (locations) ===
      updateLocationMeta: (idx, field, value) => {
          if(state.data.locations[idx]) {
              state.data.locations[idx][field] = value;
              Store.save();
          }
      },
      addLocationPhoto: (idx, url) => {
          if(!url || !url.trim()) return;
          if(state.data.locations[idx]) {
              if(!state.data.locations[idx].galleryPhotos) state.data.locations[idx].galleryPhotos = [];
              state.data.locations[idx].galleryPhotos.push(url.trim());
              Store.save();
              UI.renderDataTab('locations', els.locContainer);
              Utils.toast('Photo ajoutÃ©e', 'success');
          }
      },
      removeLocationPhoto: (locIdx, photoIdx) => {
          if(state.data.locations[locIdx] && state.data.locations[locIdx].galleryPhotos) {
              state.data.locations[locIdx].galleryPhotos.splice(photoIdx, 1);
              Store.save();
              UI.renderDataTab('locations', els.locContainer);
          }
      },
      locationSearchTimeout: null,
      searchLocationAddress: (idx, query) => {
          clearTimeout(Actions.locationSearchTimeout);
          const suggestions = document.getElementById('loc-suggestions-' + idx);
          if(!suggestions) return;
          
          // Sauvegarder la valeur saisie
          if(state.data.locations[idx]) {
              state.data.locations[idx].address = query;
          }
          
          if(!query || query.length < 3) {
              suggestions.classList.remove('visible');
              return;
          }
          
          Actions.locationSearchTimeout = setTimeout(async () => {
              try {
                  // Utiliser l'API Adresse du gouvernement franÃ§ais (plus prÃ©cise)
                  const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
                  const data = await response.json();
                  
                  if(data.features && data.features.length > 0) {
                      suggestions.innerHTML = data.features.map(f => {
                          const props = f.properties;
                          const label = props.label || '';
                          const context = props.context || '';
                          return `<div class="address-suggestion" onclick="app.Actions.selectLocationAddress(${idx}, '${Utils.escape(label).replace(/'/g, "\\'")}')">
                              <div class="address-suggestion-main">${Utils.escape(props.name || label.split(',')[0])}</div>
                              <div class="address-suggestion-secondary">${Utils.escape(context)}</div>
                          </div>`;
                      }).join('');
                      suggestions.classList.add('visible');
                  } else {
                      suggestions.innerHTML = '<div class="address-suggestion" style="color:var(--text-sec); cursor:default;">Aucun rÃ©sultat</div>';
                      suggestions.classList.add('visible');
                  }
              } catch(e) {
                  console.error('Erreur recherche adresse:', e);
                  suggestions.classList.remove('visible');
              }
          }, 300);
      },
      selectLocationAddress: (idx, address) => {
          if(state.data.locations[idx]) {
              state.data.locations[idx].address = address;
              Store.save();
              document.getElementById('loc-address-' + idx).value = address;
              document.getElementById('loc-suggestions-' + idx).classList.remove('visible');
              Utils.toast('Adresse enregistrÃ©e', 'success');
          }
      },
      
      notifyNewProfile: async (person, type) => {
          try {
              const projectTitle = document.getElementById('projectTitle')?.value || 'Un projet';
              const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'Un rÃ©alisateur';
              const typeLabel = type === 'actor' ? 'comÃ©dien.ne' : 'technicien.ne';
              
              // CrÃ©er un pending claim dans Firebase
              const recipientEmailKey = Utils.sanitizeEmail(person.email);
              const claimId = 'claim_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);
              
              const claimData = {
                  id: claimId,
                  type: type,
                  localId: person.id,
                  name: person.name,
                  email: person.email,
                  phone: person.phone || '',
                  photo: person.photo || '',
                  bio: person.bio || '',
                  gender: person.gender || '',
                  // DonnÃ©es spÃ©cifiques acteur
                  height: person.height || '',
                  age: person.age || '',
                  eyeColor: person.eyeColor || '',
                  hairColor: person.hairColor || '',
                  ethnicity: person.ethnicity || '',
                  languages: person.languages || '',
                  sports: person.sports || '',
                  // DonnÃ©es spÃ©cifiques technicien
                  role: person.role || '',
                  department: person.group_id || '',
                  dailyRate: person.dailyRate || '',
                  rateCurrency: person.rateCurrency || 'â‚¬',
                  // MÃ©tadonnÃ©es
                  createdBy: state.currentUser.email,
                  createdByName: senderName,
                  projectId: state.currentProjectId,
                  projectTitle: projectTitle,
                  createdAt: new Date().toISOString()
              };
              
              // Stocker la demande de revendication dans les notifications
              const {error: notifErr} = await supabase.from('notifications').insert({
                  user_email: person.email.toLowerCase(),
                  type: 'profile_claim',
                  title: `ðŸŽ Un profil ${typeLabel} a Ã©tÃ© crÃ©Ã© Ã  votre nom`,
                  message: JSON.stringify(claimData),
                  link: state.currentProjectId,
                  read: false
              });
              if(notifErr) { console.error('Erreur envoi notification:', notifErr); }
              
              await Messages.send(person.email, {
                  type: 'claim',
                  title: `ðŸŽ Un profil ${typeLabel} a Ã©tÃ© crÃ©Ã© Ã  votre nom`,
                  content: `Bonjour ${person.name},\n\n${senderName} a crÃ©Ã© un profil Ã  votre nom en tant que ${typeLabel} sur le projet "${projectTitle}" dans Moteur.\n\nðŸ‘‰ Connectez-vous pour revendiquer ce profil et le complÃ©ter. Il apparaÃ®tra ensuite dans l'Univers et vous pourrez Ãªtre contactÃ©(e) par d'autres productions !`,
                  projectId: state.currentProjectId,
                  projectTitle: projectTitle,
                  claimId: claimId
              });
              
              await Messages.sendEmailPing(person.email, person.name, 'claim', {
                  senderName: senderName,
                  projectTitle: projectTitle,
                  typeLabel: typeLabel
              });
              
              Utils.toast(`${person.name} a Ã©tÃ© notifiÃ©(e) par email !`, 'success');
          } catch(e) {
              console.error('Erreur notification:', e);
              Utils.toast('Erreur lors de l\'envoi de la notification', 'error');
          }
      },
      openTagMenu: (e, sceneId) => { e.preventDefault(); if(state.currentRole === 'viewer') return; state.contextSceneId = sceneId; els.tagCtxMenu.innerHTML = ''; state.data.tags.forEach(t => { const div = document.createElement('div'); div.innerHTML = `<span class="tag-dot" style="background:${t.color}"></span> ${Utils.escape(t.name)}`; div.onclick = () => { Actions.setTag(t.id); }; els.tagCtxMenu.appendChild(div); }); const hr = document.createElement('hr'); hr.style.margin="5px 0"; hr.style.border="none"; hr.style.borderTop="1px solid var(--border)"; els.tagCtxMenu.appendChild(hr); const newDiv = document.createElement('div'); newDiv.innerHTML = `<span>âž• CrÃ©er un Tag...</span>`; newDiv.onclick = Actions.openTagModal; els.tagCtxMenu.appendChild(newDiv); els.tagCtxMenu.style.display = 'block'; const menuRect = els.tagCtxMenu.getBoundingClientRect(); let top = e.clientY; let left = e.clientX; if(left + 150 > window.innerWidth) left = window.innerWidth - 160; if(top + 200 > window.innerHeight) top = window.innerHeight - 210; if(left < 10) left = 10; if(top < 10) top = 10; els.tagCtxMenu.style.top = top + 'px'; els.tagCtxMenu.style.left = left + 'px'; },
      setTag: (tagId) => { const s = state.data.scenes.find(x => x.id === state.contextSceneId); if(s) { s.tag_id = tagId; Store.save(); UI.renderBoard(); UI.renderScript(); } els.tagCtxMenu.style.display = 'none'; },
      openTagModal: () => { els.tagCtxMenu.style.display='none'; els.tagModal.style.display='flex'; document.getElementById('tag-new-name').value=''; },
      saveNewTag: () => { const name = document.getElementById('tag-new-name').value.trim(); const color = document.getElementById('tag-new-color').value; if(!name) return Utils.toast("Nom requis", "warning"); const newTag = { id: 't'+Date.now(), name: name, color: color }; state.data.tags.push(newTag); Store.save(); Actions.setTag(newTag.id); els.tagModal.style.display='none'; },
      openExportModal: () => { els.exportModal.style.display = 'flex'; },
      confirmExport: () => { 
    els.exportModal.style.display = 'none'; 
    const opts = { 
        author: document.getElementById('exp-author').value, 
        phone: document.getElementById('exp-phone').value, 
        web: document.getElementById('exp-web').value, 
        reg: document.getElementById('exp-reg').value, 
        synop: document.getElementById('exp-synop').checked, 
        board: document.getElementById('exp-board').checked, 
        script: document.getElementById('exp-script').checked, 
        chars: document.getElementById('exp-chars').checked, 
        actors: document.getElementById('exp-actors').checked, 
        locs: document.getElementById('exp-locs').checked, 
        storyboard: document.getElementById('exp-storyboard').checked,
        crew: document.getElementById('exp-crew').checked,
        breakdown: document.getElementById('exp-breakdown').checked, 
        stats: document.getElementById('exp-stats').checked 
    }; 
    Exporter.toPDF(opts); 
}
  };
  
  const Breakdown = {
      init: () => {
          els.bdRightContent.innerHTML = '';
          if(state.data.scenes.length === 0) { els.bdScriptContent.innerHTML = 'Aucune scÃ¨ne.'; return; }
          state.data.scenes.forEach((s, idx) => {
              const isFinal = s.isFinal === true;
              if(isFinal) Breakdown.autoFill(s);
              const card = document.createElement('div'); card.className = 'bd-scene-card';
              const header = document.createElement('div');
              header.className = 'bd-scene-header' + (s.id === state.activeBdSceneId ? ' active' : '');
              const bdStatus = s.status || 'not-verified';
              const bdStatusLabels = { 'not-verified': 'ðŸ”´', 'to-work': 'ðŸŸ¡', 'verified': 'ðŸŸ¢' };
              const finalBadge = isFinal ? `<span class="scene-status-badge final" style="margin-left:8px;">âœ… Finale</span>` : `<span class="scene-status-badge draft" style="margin-left:8px;">ðŸ“ Brouillon</span>`;
              header.innerHTML = `<span class="bd-scene-title">#${idx+1} - ${Utils.escape(s.title)}</span>${finalBadge}<div class="scene-status-container ml-10"><span class="scene-status-badge ${bdStatus}" onclick="app.UI.toggleSceneStatus('${s.id}', event)">${bdStatusLabels[bdStatus]}</span></div> <small>${s.id === state.activeBdSceneId ? 'â–¼' : 'â–¶'}</small>`;
              header.onclick = () => { state.activeBdSceneId = (state.activeBdSceneId === s.id) ? null : s.id; Breakdown.init(); };
              const details = document.createElement('div');
              details.className = 'bd-scene-details' + (s.id === state.activeBdSceneId ? ' open' : '');
              
              if(!isFinal) {
                  // ScÃ¨ne en brouillon - afficher message de blocage
                  details.innerHTML = `
                      <div style="padding: 15px; text-align: center; background: #fff8e1; border-radius: 8px; margin: 10px 0;">
                          <div style="font-size: 1.5rem; margin-bottom: 8px;">ðŸ“</div>
                          <div style="font-weight: 600; color: #ef6c00; margin-bottom: 5px;">ScÃ¨ne en brouillon</div>
                          <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Finalisez cette scÃ¨ne pour pouvoir la dÃ©pouiller.</div>
                          <button onclick="app.Actions.finalizeScene('${s.id}')" class="finalize-btn">âœ… Finaliser cette scÃ¨ne</button>
                      </div>
                  `;
              } else {
                  // ScÃ¨ne finalisÃ©e - afficher le dÃ©pouillement
                  let hasItems = false;
                  CONFIG.bdCategories.forEach(cat => {
                      const items = s.breakdown[cat] || [];
                      if(items.length > 0) {
                          hasItems = true;
                          const group = document.createElement('div'); group.className = 'bd-cat-group';
                          let html = `<div class="bd-cat-name">${cat}</div><div class="bd-tags-container">`;
                          const canEditBd = state.currentRole === 'owner' || Permissions.canEdit('depouillement');
                          items.forEach((item, i) => { html += `<span class="bd-tag" data-term="${item.toLowerCase()}">${Utils.escape(item)} ${canEditBd ? `<button onclick="app.Breakdown.removeItem('${s.id}', '${cat}', ${i}, event)">Ã—</button>` : ''}</span>`; });
                          html += `</div>`;
                          group.innerHTML = html;
                          details.appendChild(group);
                      }
                  });
                  if(!hasItems) details.innerHTML = '<div style="font-size:0.8rem;color:var(--text-sec);font-style:italic">Rien. SÃ©lectionnez du texte Ã  gauche et faites clic-droit pour dÃ©pouiller.</div>';
              }
              card.appendChild(header); card.appendChild(details); els.bdRightContent.appendChild(card);
          });
          if(state.activeBdSceneId) { const scene = state.data.scenes.find(s => s.id === state.activeBdSceneId); if(scene) Breakdown.renderLeft(scene); }
      },
      autoFill: (scene) => {
          if(!scene.breakdown) scene.breakdown = {};
          const locMatch = scene.title.match(/^(?:INT\.|EXT\.|I\/E)\s*([^\-]+)/i);
          if(locMatch && locMatch[1]) { const loc = locMatch[1].trim().toUpperCase(); if(!scene.breakdown["DECORS-LIEUX"]) scene.breakdown["DECORS-LIEUX"] = []; if(!scene.breakdown["DECORS-LIEUX"].includes(loc)) scene.breakdown["DECORS-LIEUX"].push(loc); }
          if(scene.perso) { const names = scene.perso.split(/[,;]|\bet\b/i).map(n => n.trim()).filter(n => n.length > 0); if(!scene.breakdown["PERSONNAGES"]) scene.breakdown["PERSONNAGES"] = []; names.forEach(n => { if(!scene.breakdown["PERSONNAGES"].includes(n)) scene.breakdown["PERSONNAGES"].push(n); }); }
      },
      renderLeft: (scene) => {
          const isFinal = scene.isFinal === true;
          let html = scene.scriptContent || "<p><em>(Vide)</em></p>";
          let titleHtml = scene.title;
          
          if(!isFinal) {
              // ScÃ¨ne en brouillon - afficher le texte avec un overlay d'avertissement
              const finalBadge = `<span class="scene-status-badge draft ml-10">ðŸ“ Brouillon</span>`;
              els.bdScriptContent.innerHTML = `
                  <div class="bd-script-text pos-relative">
                      <h3 style="text-decoration:underline;margin-top:0">${titleHtml}${finalBadge}</h3>
                      ${html}
                      <div style="position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(255,152,0,0.05); pointer-events:none;"></div>
                  </div>
                  <div style="margin-top:15px; padding:15px; background:#fff8e1; border:2px dashed #ff9800; border-radius:8px; text-align:center;">
                      <p style="margin:0 0 10px 0; color:#e65100; font-weight:600;">âš ï¸ Cette scÃ¨ne est en brouillon</p>
                      <p style="margin:0 0 15px 0; color:#666; font-size:0.9rem;">Le dÃ©pouillement sera possible une fois la scÃ¨ne finalisÃ©e.</p>
                      <button onclick="app.Actions.finalizeScene('${scene.id}')" class="finalize-btn">âœ… Finaliser cette scÃ¨ne</button>
                  </div>
              `;
              return;
          }
          
          // ScÃ¨ne finalisÃ©e - afficher normalement avec les marquages
          const finalBadge = `<span class="scene-status-badge final ml-10">âœ… Finale</span>`;
          if(scene.breakdown) {
              const allItems = []; Object.values(scene.breakdown).forEach(arr => allItems.push(...arr));
              allItems.sort((a, b) => b.length - a.length);
              allItems.forEach(term => { 
                  if(!term) return; 
                  const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                  const regex = new RegExp(`(?<![\\w-])${safeTerm}(?![\\w-])`, 'gi'); 
                  html = html.replace(regex, (match) => `<span class="bd-marked" data-term="${term.toLowerCase()}">${match}</span>`);
                  // Aussi marquer dans le titre (pour les dÃ©cors-lieux)
                  titleHtml = titleHtml.replace(regex, (match) => `<span class="bd-marked" data-term="${term.toLowerCase()}">${match}</span>`);
              });
          }
          els.bdScriptContent.innerHTML = `<div class="bd-script-text"><h3 style="text-decoration:underline;margin-top:0">${titleHtml}${finalBadge}</h3>${html}</div>`;
          // Ajouter les listeners de hover pour la liaison visuelle
          Breakdown.setupLinkHovers();
      },
      setupLinkHovers: () => {
          const svg = document.getElementById('bd-link-svg');
          if(!svg) return;
          svg.innerHTML = '';
          const layout = document.querySelector('.breakdown-layout');
          if(!layout) return;
          
          const highlightPair = (term) => {
              document.querySelectorAll(`.bd-marked[data-term="${term}"], .bd-tag[data-term="${term}"]`).forEach(el => el.classList.add('bd-highlight'));
              // Recalculer layoutRect Ã  chaque hover pour Ã©viter les dÃ©calages
              const currentLayoutRect = layout.getBoundingClientRect();
              drawLink(term, currentLayoutRect, svg);
          };
          const unhighlightAll = () => {
              document.querySelectorAll('.bd-highlight').forEach(el => el.classList.remove('bd-highlight'));
              svg.innerHTML = '';
          };
          
          document.querySelectorAll('.bd-marked[data-term]').forEach(el => {
              el.addEventListener('mouseenter', () => highlightPair(el.dataset.term));
              el.addEventListener('mouseleave', unhighlightAll);
          });
          document.querySelectorAll('.bd-tag[data-term]').forEach(el => {
              el.addEventListener('mouseenter', () => highlightPair(el.dataset.term));
              el.addEventListener('mouseleave', unhighlightAll);
          });
          
          function drawLink(term, layoutRect, svg) {
              svg.innerHTML = '';
              const marked = document.querySelector(`.bd-marked[data-term="${term}"]`);
              const tag = document.querySelector(`.bd-tag[data-term="${term}"]`);
              if(!marked || !tag) return;
              // VÃ©rifier que les Ã©lÃ©ments sont visibles
              const r1 = marked.getBoundingClientRect();
              const r2 = tag.getBoundingClientRect();
              if(r1.width === 0 || r2.width === 0) return;
              const scrollLeft = layout.scrollLeft || 0;
              const scrollTop = layout.scrollTop || 0;
              const x1 = r1.right - layoutRect.left + scrollLeft;
              const y1 = r1.top + r1.height/2 - layoutRect.top + scrollTop;
              const x2 = r2.left - layoutRect.left + scrollLeft;
              const y2 = r2.top + r2.height/2 - layoutRect.top + scrollTop;
              const cx1 = x1 + (x2 - x1) * 0.3;
              const cx2 = x1 + (x2 - x1) * 0.7;
              const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
              path.setAttribute('d', `M${x1},${y1} C${cx1},${y1} ${cx2},${y2} ${x2},${y2}`);
              const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
              arrow.setAttribute('points', `${x2},${y2} ${x2-8},${y2-4} ${x2-8},${y2+4}`);
              arrow.setAttribute('fill', '#ffd700');
              svg.appendChild(path);
              svg.appendChild(arrow);
          }
      },
      handleRightClick: (e) => { 
          if(state.currentRole === 'viewer' || !Permissions.canEdit('depouillement')) return; 
          if(!state.activeBdSceneId) return; 
          
          // VÃ©rifier si la scÃ¨ne est finalisÃ©e
          const scene = state.data.scenes.find(s => s.id === state.activeBdSceneId);
          if(!scene || scene.isFinal !== true) {
              e.preventDefault();
              Utils.toast('Finalisez cette scÃ¨ne avant de pouvoir la dÃ©pouiller', 'warning');
              return;
          }
          
          const sel = window.getSelection(); 
          const text = sel.toString().trim(); 
          
          e.preventDefault(); 
          
          // Si pas de texte sÃ©lectionnÃ©, montrer menu pour ajouter technicien
          if(text.length < 1) {
              els.bdCtxMenu.innerHTML = `<div class="ctx-title">Ajouter technicien(s) :</div>`;
              
              // Option pour ajouter tous les techniciens
              const addAllDiv = document.createElement('div');
              addAllDiv.innerText = 'âš¡ Ajouter TOUS les techniciens';
              addAllDiv.style.fontWeight = 'bold';
              addAllDiv.style.borderBottom = '2px solid var(--border)';
              addAllDiv.onclick = () => { 
                  if(state.data.crew && state.data.crew.length > 0) {
                      state.data.crew.forEach(member => {
                          Breakdown.addItemSilent(state.activeBdSceneId, 'TECHNICIENS', member.name);
                      });
                      Store.save();
                      Breakdown.init();
                  }
                  els.bdCtxMenu.style.display = 'none'; 
              };
              els.bdCtxMenu.appendChild(addAllDiv);
              
              // Liste des techniciens
              if(state.data.crew && state.data.crew.length > 0) {
                  state.data.crew.forEach(member => {
                      const div = document.createElement('div');
                      div.innerText = `${member.name} (${member.role || 'Technicien'})`;
                      div.onclick = () => { 
                          Breakdown.addItem(state.activeBdSceneId, 'TECHNICIENS', member.name); 
                          els.bdCtxMenu.style.display = 'none'; 
                      };
                      els.bdCtxMenu.appendChild(div);
                  });
              } else {
                  const emptyDiv = document.createElement('div');
                  emptyDiv.innerText = '(Aucun technicien)';
                  emptyDiv.style.color = 'var(--text-sec)';
                  els.bdCtxMenu.appendChild(emptyDiv);
              }
              
              els.bdCtxMenu.style.display = 'block';
              let top1 = e.clientY; let left1 = e.clientX;
              if(left1 + 200 > window.innerWidth) left1 = window.innerWidth - 210;
              if(top1 + 300 > window.innerHeight) top1 = window.innerHeight - 310;
              if(left1 < 10) left1 = 10; if(top1 < 10) top1 = 10;
              els.bdCtxMenu.style.top = top1 + 'px'; 
              els.bdCtxMenu.style.left = left1 + 'px';
              return;
          }
          
          els.bdCtxMenu.innerHTML = `<div class="ctx-title">Ajouter Ã  :</div>`; 
          
          CONFIG.bdCategories.forEach(cat => { 
              const div = document.createElement('div'); 
              div.innerText = cat; 
              
              if(cat === 'TECHNICIENS' || cat === 'COMEDIENS') {
                  // Clic pour afficher la liste des personnes
                  div.innerHTML = `${cat} â–¶`;
                  div.style.cursor = 'pointer';
                  div.style.fontWeight = 'bold';
                  
                  const isCrew = cat === 'TECHNICIENS';
                  const dataList = isCrew ? state.data.crew : state.data.actors;
                  const itemLabel = isCrew ? 'technicien' : 'comÃ©dien';
                  
                  div.onclick = (ev) => {
                      ev.stopPropagation();
                      Breakdown.showPersonMenu(cat, text, sel, dataList, itemLabel);
                  };
              } else {
                  div.onclick = () => { 
                      Breakdown.addItem(state.activeBdSceneId, cat, text); 
                      els.bdCtxMenu.style.display = 'none'; 
                      sel.removeAllRanges(); 
                  };
              }
              
              els.bdCtxMenu.appendChild(div); 
          }); 
          
          els.bdCtxMenu.style.display = 'block';
          let top2 = e.clientY; let left2 = e.clientX;
          if(left2 + 200 > window.innerWidth) left2 = window.innerWidth - 210;
          if(top2 + 350 > window.innerHeight) top2 = window.innerHeight - 360;
          if(left2 < 10) left2 = 10; if(top2 < 10) top2 = 10;
          els.bdCtxMenu.style.top = top2 + 'px'; 
          els.bdCtxMenu.style.left = left2 + 'px'; 
      },
      addItem: (sceneId, cat, text) => { 
          if(state.currentRole === 'viewer' || !Permissions.canEdit('depouillement')) return; 
          const scene = state.data.scenes.find(s => s.id === sceneId); 
          if(!scene) return; 
          if(!scene.breakdown) scene.breakdown = {}; 
          if(!scene.breakdown[cat]) scene.breakdown[cat] = []; 
          
          if(!scene.breakdown[cat].includes(text)) { 
              scene.breakdown[cat].push(text); 
              if(cat === "PERSONNAGES") ScriptEditor.syncCharMeta(text, sceneId); 
              
              // Auto-ajouter les techniciens responsables de cette catÃ©gorie
              if(cat !== 'TECHNICIENS' && cat !== 'PERSONNAGES' && cat !== 'DECORS-LIEUX') {
                  Breakdown.autoAddResponsibleCrew(sceneId, cat);
              }
              
              // Auto-crÃ©er une fiche Ressource pour ACCESSOIRES, COSTUMES, VEHICULES
              if(cat === 'ACCESSOIRES' || cat === 'COSTUMES' || cat === 'VEHICULES') {
                  Breakdown.autoCreateResource(text, cat);
              }
              
              Store.save(); 
              Breakdown.init(); 
          } 
      },
      
      // Ajouter un Ã©lÃ©ment sans sauvegarder (pour ajout en masse)
      showMainContextMenu: (text, sel) => {
          els.bdCtxMenu.innerHTML = `<div class="ctx-title">Ajouter Ã  :</div>`; 
          
          CONFIG.bdCategories.forEach(cat => { 
              const div = document.createElement('div'); 
              div.innerText = cat; 
              
              if(cat === 'TECHNICIENS' || cat === 'COMEDIENS') {
                  div.innerHTML = `${cat} â–¶`;
                  div.style.cursor = 'pointer';
                  div.style.fontWeight = 'bold';
                  
                  const isCrew = cat === 'TECHNICIENS';
                  const dataList = isCrew ? state.data.crew : state.data.actors;
                  const itemLabel = isCrew ? 'technicien' : 'comÃ©dien';
                  
                  div.onclick = (ev) => {
                      ev.stopPropagation();
                      Breakdown.showPersonMenu(cat, text, sel, dataList, itemLabel);
                  };
              } else {
                  div.onclick = () => { 
                      Breakdown.addItem(state.activeBdSceneId, cat, text); 
                      els.bdCtxMenu.style.display = 'none'; 
                      if(sel) sel.removeAllRanges(); 
                  };
              }
              
              els.bdCtxMenu.appendChild(div); 
          });
      },
      
      showPersonMenu: (cat, text, sel, dataList, itemLabel) => {
          els.bdCtxMenu.innerHTML = '';
          
          // CrÃ©er le titre avec bouton retour (tout cliquable)
          const titleDiv = document.createElement('div');
          titleDiv.className = 'ctx-title';
          titleDiv.style.cssText = 'display:flex; align-items:center; gap:10px; cursor:pointer;';
          titleDiv.innerHTML = `â—€ Ajouter ${itemLabel} :`;
          titleDiv.onclick = (ev) => {
              ev.stopPropagation();
              Breakdown.showMainContextMenu(text, sel);
          };
          els.bdCtxMenu.appendChild(titleDiv);
          
          // Option ajouter tous
          const addAllDiv = document.createElement('div');
          addAllDiv.innerText = `âš¡ TOUS les ${itemLabel}s`;
          addAllDiv.style.fontWeight = 'bold';
          addAllDiv.style.borderBottom = '2px solid var(--border)';
          addAllDiv.onclick = () => { 
              if(dataList && dataList.length > 0) {
                  dataList.forEach(person => {
                      Breakdown.addItemSilent(state.activeBdSceneId, cat, person.name);
                  });
                  Store.save();
                  Breakdown.init();
              }
              els.bdCtxMenu.style.display = 'none';
          };
          els.bdCtxMenu.appendChild(addAllDiv);
          
          // Liste des personnes
          if(dataList && dataList.length > 0) {
              dataList.forEach(person => {
                  const personDiv = document.createElement('div');
                  personDiv.innerText = `${person.name}${person.role ? ' (' + person.role + ')' : ''}`;
                  personDiv.onclick = () => { 
                      Breakdown.addItem(state.activeBdSceneId, cat, person.name); 
                      els.bdCtxMenu.style.display = 'none';
                  };
                  els.bdCtxMenu.appendChild(personDiv);
              });
          } else {
              const emptyDiv = document.createElement('div');
              emptyDiv.innerText = `(Aucun ${itemLabel})`;
              emptyDiv.style.color = 'var(--text-sec)';
              els.bdCtxMenu.appendChild(emptyDiv);
          }
      },
      
      addItemSilent: (sceneId, cat, text) => {
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          if(!scene.breakdown) scene.breakdown = {};
          if(!scene.breakdown[cat]) scene.breakdown[cat] = [];
          if(!scene.breakdown[cat].includes(text)) {
              scene.breakdown[cat].push(text);
          }
      },
      
      // Auto-ajouter les techniciens responsables d'une catÃ©gorie
      autoAddResponsibleCrew: (sceneId, category) => {
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          
          if(!scene.breakdown) scene.breakdown = {};
          if(!scene.breakdown['TECHNICIENS']) scene.breakdown['TECHNICIENS'] = [];
          
          // Trouver les groupes responsables de cette catÃ©gorie
          Object.keys(CONFIG.crewToBreakdownMap).forEach(groupId => {
              if(CONFIG.crewToBreakdownMap[groupId].includes(category)) {
                  // Trouver les techniciens de ce groupe
                  const members = state.data.crew.filter(c => c.group_id === groupId);
                  members.forEach(member => {
                      if(!scene.breakdown['TECHNICIENS'].includes(member.name)) {
                          scene.breakdown['TECHNICIENS'].push(member.name);
                      }
                  });
              }
          });
      },
      
      // Auto-crÃ©er une fiche Ressource depuis le dÃ©pouillement
      autoCreateResource: (text, bdCategory) => {
          if(!state.data.resources) state.data.resources = [];
          
          // Mapper la catÃ©gorie du dÃ©pouillement vers la catÃ©gorie ressource
          const resCategory = BD_TO_RESOURCE_CAT[bdCategory];
          if(!resCategory) return;
          
          // VÃ©rifier si une ressource avec ce nom exact existe dÃ©jÃ 
          const exists = state.data.resources.some(r => 
              r.name.toLowerCase() === text.toLowerCase() ||
              (r.aliases || []).some(a => a.toLowerCase() === text.toLowerCase())
          );
          
          if(!exists) {
              state.data.resources.push({
                  id: 'res_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7),
                  name: text,
                  category: resCategory,
                  photo: '',
                  description: '',
                  note: '',
                  owner: null,
                  aliases: [],
                  autoCreated: true
              });
          }
      },
      
      removeItem: async (sceneId, cat, idx, e) => { 
          if(e) e.stopPropagation(); 
          if(state.currentRole === 'viewer' || !Permissions.canEdit('depouillement')) return; 
          const scene = state.data.scenes.find(s => s.id === sceneId); 
          if(!scene || !scene.breakdown || !scene.breakdown[cat]) return;
          
          const itemName = scene.breakdown[cat][idx];
          
          // VÃ©rifier si c'est une ressource (ACCESSOIRES, COSTUMES, VEHICULES)
          if(cat === 'ACCESSOIRES' || cat === 'COSTUMES' || cat === 'VEHICULES') {
              const resCat = BD_TO_RESOURCE_CAT[cat];
              const resource = (state.data.resources || []).find(r => 
                  r.category === resCat && (r.name.toLowerCase() === itemName.toLowerCase() || (r.aliases || []).some(a => a.toLowerCase() === itemName.toLowerCase()))
              );
              
              if(resource) {
                  // VÃ©rifier si c'est la derniÃ¨re occurrence dans le dÃ©pouillement
                  let count = 0;
                  state.data.scenes.forEach(s => {
                      if(s.breakdown && s.breakdown[cat]) {
                          s.breakdown[cat].forEach(item => {
                              if(item.toLowerCase() === itemName.toLowerCase()) count++;
                          });
                      }
                  });
                  
                  if(count <= 1) {
                      const deleteResource = await UI.confirmModal({
                          title: 'ðŸ—‘ï¸ Supprimer aussi la fiche Ressource ?',
                          message: `"${itemName}" n'apparaÃ®t plus dans aucune scÃ¨ne. Voulez-vous aussi supprimer la fiche Ressource associÃ©e ?`,
                          confirmText: 'Supprimer la fiche',
                          cancelText: 'Garder la fiche',
                          type: 'warning'
                      });
                      
                      if(deleteResource) {
                          state.data.resources = state.data.resources.filter(r => r.id !== resource.id);
                      }
                  }
              }
          }
          
          scene.breakdown[cat].splice(idx, 1); 
          Store.save(); 
          Breakdown.init(); 
      },
      
      // ========== EXPORT PDF DÃ‰POUILLEMENT ==========
      exportPDF: () => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');
          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();
          const margin = 15;
          let y = margin;
          
          const projectTitle = state.data.title || 'Projet sans titre';
          const scenes = state.data.scenes || [];
          
          if(scenes.length === 0) {
              Utils.toast('Aucune scÃ¨ne Ã  exporter', 'warning');
              return;
          }
          
          // Couleurs par catÃ©gorie
          const catColors = {
              'PERSONNAGES': [76, 175, 80],
              'FIGURANTS': [139, 195, 74],
              'COSTUMES': [156, 39, 176],
              'MAQUILLAGE': [233, 30, 99],
              'ACCESSOIRES': [255, 152, 0],
              'VÃ‰HICULES': [96, 125, 139],
              'DECORS-LIEUX': [33, 150, 243],
              'EFFETS SPÃ‰CIAUX': [244, 67, 54],
              'SONS': [0, 188, 212],
              'ANIMAUX': [121, 85, 72],
              'CASCADES': [255, 87, 34],
              'NOTES': [158, 158, 158]
          };
          
          // ===== PAGE DE TITRE =====
          doc.setFillColor(43, 110, 246);
          doc.rect(0, 0, pageWidth, 50, 'F');
          
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(24);
          doc.setFont('helvetica', 'bold');
          doc.text('DÃ‰POUILLEMENT', pageWidth / 2, 25, { align: 'center' });
          
          doc.setFontSize(14);
          doc.setFont('helvetica', 'normal');
          doc.text(projectTitle, pageWidth / 2, 38, { align: 'center' });
          
          y = 60;
          
          // LÃ©gende des catÃ©gories
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(50, 50, 50);
          doc.text('LÃ©gende des catÃ©gories :', margin, y);
          y += 6;
          
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          let legendX = margin;
          let legendCol = 0;
          Object.entries(catColors).forEach(([cat, rgb], idx) => {
              if(legendCol >= 3) {
                  legendCol = 0;
                  legendX = margin;
                  y += 5;
              }
              doc.setFillColor(rgb[0], rgb[1], rgb[2]);
              doc.circle(legendX + 2, y - 1, 2, 'F');
              doc.setTextColor(50, 50, 50);
              doc.text(cat, legendX + 6, y);
              legendX += 60;
              legendCol++;
          });
          
          y += 15;
          
          // ===== DÃ‰POUILLEMENT PAR SCÃˆNE =====
          scenes.forEach((scene, sceneIdx) => {
              const breakdown = scene.breakdown || {};
              const hasContent = Object.values(breakdown).some(arr => arr && arr.length > 0);
              
              if(!hasContent) return;
              
              // Nouvelle page si nÃ©cessaire
              if(y > pageHeight - 60) {
                  doc.addPage();
                  y = margin;
              }
              
              // En-tÃªte de scÃ¨ne
              doc.setFillColor(240, 240, 240);
              doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
              doc.setDrawColor(200, 200, 200);
              doc.rect(margin, y, pageWidth - margin * 2, 10, 'S');
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'bold');
              doc.setTextColor(50, 50, 50);
              const sceneTitle = `#${sceneIdx + 1} - ${scene.title || 'Sans titre'}`;
              doc.text(sceneTitle, margin + 3, y + 7);
              
              // Badge statut
              if(scene.isFinal) {
                  doc.setFillColor(40, 167, 69);
                  doc.setTextColor(255, 255, 255);
                  doc.roundedRect(pageWidth - margin - 20, y + 2, 18, 6, 1, 1, 'F');
                  doc.setFontSize(6);
                  doc.text('FINAL', pageWidth - margin - 11, y + 6, { align: 'center' });
              } else {
                  doc.setFillColor(255, 193, 7);
                  doc.setTextColor(0, 0, 0);
                  doc.roundedRect(pageWidth - margin - 25, y + 2, 23, 6, 1, 1, 'F');
                  doc.setFontSize(6);
                  doc.text('BROUILLON', pageWidth - margin - 13.5, y + 6, { align: 'center' });
              }
              
              y += 14;
              
              // CatÃ©gories du dÃ©pouillement
              Object.entries(breakdown).forEach(([cat, items]) => {
                  if(!items || items.length === 0) return;
                  
                  if(y > pageHeight - 25) {
                      doc.addPage();
                      y = margin;
                  }
                  
                  const rgb = catColors[cat] || [100, 100, 100];
                  
                  // Nom de la catÃ©gorie
                  doc.setFillColor(rgb[0], rgb[1], rgb[2]);
                  doc.circle(margin + 2, y + 1, 2, 'F');
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.setTextColor(rgb[0], rgb[1], rgb[2]);
                  doc.text(cat, margin + 6, y + 2);
                  
                  // Liste des Ã©lÃ©ments
                  doc.setFont('helvetica', 'normal');
                  doc.setTextColor(50, 50, 50);
                  doc.setFontSize(8);
                  
                  const itemsText = items.map(item => typeof item === 'string' ? item : item.name || item).join(', ');
                  const lines = doc.splitTextToSize(itemsText, pageWidth - margin * 2 - 10);
                  
                  y += 5;
                  lines.forEach(line => {
                      if(y > pageHeight - 15) {
                          doc.addPage();
                          y = margin;
                      }
                      doc.text(line, margin + 6, y);
                      y += 4;
                  });
                  
                  y += 3;
              });
              
              y += 8;
          });
          
          // ===== RÃ‰CAPITULATIF GLOBAL =====
          doc.addPage();
          y = margin;
          
          doc.setFillColor(43, 110, 246);
          doc.rect(0, 0, pageWidth, 20, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.text('RÃ‰CAPITULATIF GLOBAL', pageWidth / 2, 13, { align: 'center' });
          
          y = 30;
          
          // AgrÃ©gation par catÃ©gorie
          const globalBreakdown = {};
          scenes.forEach(scene => {
              const breakdown = scene.breakdown || {};
              Object.entries(breakdown).forEach(([cat, items]) => {
                  if(!items || items.length === 0) return;
                  if(!globalBreakdown[cat]) globalBreakdown[cat] = new Set();
                  items.forEach(item => {
                      const name = typeof item === 'string' ? item : item.name || item;
                      globalBreakdown[cat].add(name);
                  });
              });
          });
          
          Object.entries(globalBreakdown).forEach(([cat, itemsSet]) => {
              if(y > pageHeight - 30) {
                  doc.addPage();
                  y = margin;
              }
              
              const rgb = catColors[cat] || [100, 100, 100];
              const items = Array.from(itemsSet);
              
              // En-tÃªte catÃ©gorie
              doc.setFillColor(rgb[0], rgb[1], rgb[2]);
              doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(10);
              doc.setFont('helvetica', 'bold');
              doc.text(`${cat} (${items.length})`, margin + 3, y + 6);
              y += 10;
              
              // Liste
              doc.setTextColor(50, 50, 50);
              doc.setFontSize(9);
              doc.setFont('helvetica', 'normal');
              
              items.forEach((item, idx) => {
                  if(y > pageHeight - 15) {
                      doc.addPage();
                      y = margin;
                  }
                  // Compter dans combien de scÃ¨nes
                  const sceneCount = scenes.filter(s => {
                      const bd = s.breakdown?.[cat] || [];
                      return bd.some(i => (typeof i === 'string' ? i : i.name) === item);
                  }).length;
                  
                  doc.text(`â€¢ ${item}`, margin + 3, y);
                  doc.setTextColor(150, 150, 150);
                  doc.text(`(${sceneCount} scÃ¨ne${sceneCount > 1 ? 's' : ''})`, margin + 100, y);
                  doc.setTextColor(50, 50, 50);
                  y += 5;
              });
              
              y += 8;
          });
          
          // ===== PIED DE PAGE =====
          const totalPages = doc.internal.getNumberOfPages();
          for(let i = 1; i <= totalPages; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.setTextColor(150, 150, 150);
              doc.text(`${projectTitle} - DÃ©pouillement`, margin, pageHeight - 8);
              doc.text(`Page ${i}/${totalPages}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
              doc.text(`GÃ©nÃ©rÃ© par Moteur - ${new Date().toLocaleDateString('fr-FR')}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
          }
          
          // TÃ©lÃ©charger
          const filename = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'depouillement') + '_depouillement.pdf';
          doc.save(filename);
          
          Utils.toast('DÃ©pouillement PDF exportÃ© !', 'success');
          History.log('EXPORT', 'DÃ©pouillement PDF gÃ©nÃ©rÃ©');
      }
  };

// ============ MOOD BOARD MODULE ============
const ColorWheel = {
    canvas: null,
    ctx: null,
    size: 280,
    centerX: 140,
    centerY: 140,
    radius: 130,
    baseHue: 0,
    baseSaturation: 100,
    brightness: 50,
    harmony: 'analogous',
    colors: [],
    isDragging: false,
    onComplete: null,
    
    harmonies: {
        analogous: { name: 'Semblable', angles: [-30, -15, 0, 15, 30], saturations: null },
        shades: { name: 'Nuances', angles: [0, 0, 0, 0, 0], saturations: [100, 75, 50, 25, 10], lightnesses: [25, 35, 50, 65, 80] },
        complementary: { name: 'ComplÃ©mentaire', angles: [0, 15, 180, 165, 195], saturations: [100, 60, 100, 70, 70] },
        splitComplementary: { name: 'Compl. partagÃ©es', angles: [0, 10, 150, 180, 210], saturations: null },
        triadic: { name: 'Triade', angles: [0, 120, 240, 10, 130], saturations: [100, 100, 100, 60, 60] },
        tetradic: { name: 'CarrÃ©', angles: [0, 90, 180, 270, 45], saturations: null },
        compound: { name: 'Composite', angles: [0, 30, 60, 180, 210], saturations: null },
        monochromatic: { name: 'Monochrome', angles: [0, 0, 0, 0, 0], saturations: [100, 80, 60, 40, 20] }
    },
    
    existingName: null,
    
    hexToHsl: (hex) => {
        // Convertir hex en RGB puis HSL
        let r = 0, g = 0, b = 0;
        if(hex.length === 4) {
            r = parseInt(hex[1] + hex[1], 16);
            g = parseInt(hex[2] + hex[2], 16);
            b = parseInt(hex[3] + hex[3], 16);
        } else if(hex.length === 7) {
            r = parseInt(hex.slice(1, 3), 16);
            g = parseInt(hex.slice(3, 5), 16);
            b = parseInt(hex.slice(5, 7), 16);
        }
        r /= 255; g /= 255; b /= 255;
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h = 0, s = 0, l = (max + min) / 2;
        if(max !== min) {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch(max) {
                case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                case g: h = ((b - r) / d + 2) / 6; break;
                case b: h = ((r - g) / d + 4) / 6; break;
            }
        }
        return { h: h * 360, s: s * 100, l: l * 100 };
    },
    
    open: (callback, existingColors = null, existingName = null) => {
        ColorWheel.onComplete = callback;
        ColorWheel.existingName = existingName;
        
        // Si des couleurs existantes sont fournies, extraire la teinte de base
        if(existingColors && existingColors.length > 0) {
            const hsl = ColorWheel.hexToHsl(existingColors[0]);
            ColorWheel.baseHue = hsl.h;
            ColorWheel.baseSaturation = hsl.s;
            ColorWheel.brightness = hsl.l;
        } else {
            ColorWheel.baseHue = Math.random() * 360;
            ColorWheel.baseSaturation = 100;
            ColorWheel.brightness = 50;
        }
        ColorWheel.harmony = 'analogous';
        
        const modal = document.createElement('div');
        modal.className = 'color-wheel-modal';
        modal.id = 'colorWheelModal';
        modal.onclick = (e) => { if(e.target === modal) ColorWheel.close(); };
        
        modal.innerHTML = `
            <div class="color-wheel-container">
                <div class="color-wheel-header">
                    <h3>ðŸŽ¨ GÃ©nÃ©rateur de palette</h3>
                    <button class="color-wheel-close" onclick="ColorWheel.close()">âœ•</button>
                </div>
                <div class="color-wheel-body">
                    <div class="color-wheel-left">
                        <div class="color-wheel-canvas-wrap" id="colorWheelWrap">
                            <canvas id="colorWheelCanvas" width="280" height="280"></canvas>
                        </div>
                        <div class="harmony-selector">
                            <label>Type d'harmonie</label>
                            <select id="harmonySelect" onchange="ColorWheel.setHarmony(this.value)">
                                <option value="analogous">Semblable (Analogues)</option>
                                <option value="shades">Nuances</option>
                                <option value="complementary">ComplÃ©mentaire</option>
                                <option value="splitComplementary">ComplÃ©mentaires partagÃ©es</option>
                                <option value="triadic">Triade</option>
                                <option value="tetradic">CarrÃ© (TÃ©tradique)</option>
                                <option value="compound">Composite</option>
                                <option value="monochromatic">Monochrome</option>
                            </select>
                        </div>
                        <div class="brightness-slider">
                            <label>LuminositÃ©: <span id="brightnessValue">50</span>%</label>
                            <input type="range" id="brightnessRange" min="10" max="90" value="50" oninput="ColorWheel.setBrightness(this.value)">
                        </div>
                    </div>
                    <div class="color-wheel-right">
                        <div class="generated-colors" id="generatedColors"></div>
                    </div>
                </div>
                <div class="color-wheel-actions">
                    <input type="text" id="paletteNameInput" placeholder="Nom de la palette..." style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text-main);">
                    <button class="cancel" onclick="ColorWheel.close()">Annuler</button>
                    <button class="confirm" onclick="ColorWheel.addToBoard()">${existingColors ? 'Modifier' : 'Ajouter au moodboard'}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // PrÃ©-remplir le nom si existant
        if(ColorWheel.existingName) {
            document.getElementById('paletteNameInput').value = ColorWheel.existingName;
        }
        
        ColorWheel.canvas = document.getElementById('colorWheelCanvas');
        ColorWheel.ctx = ColorWheel.canvas.getContext('2d');
        
        ColorWheel.drawWheel();
        ColorWheel.generateColors();
        ColorWheel.updateMarkers();
        ColorWheel.setupEvents();
    },
    
    close: () => {
        const modal = document.getElementById('colorWheelModal');
        if(modal) modal.remove();
    },
    
    drawWheel: () => {
        const ctx = ColorWheel.ctx;
        const cx = ColorWheel.centerX;
        const cy = ColorWheel.centerY;
        const radius = ColorWheel.radius;
        
        ctx.clearRect(0, 0, ColorWheel.size, ColorWheel.size);
        
        for(let angle = 0; angle < 360; angle += 1) {
            for(let r = 0; r < radius; r += 1) {
                const hue = angle;
                const saturation = (r / radius) * 100;
                const lightness = ColorWheel.brightness;
                
                ctx.beginPath();
                ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                
                const rad = (angle - 90) * Math.PI / 180;
                const x = cx + r * Math.cos(rad);
                const y = cy + r * Math.sin(rad);
                
                ctx.arc(x, y, 1.5, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 2;
        ctx.stroke();
    },
    
    setupEvents: () => {
        const wrap = document.getElementById('colorWheelWrap');
        
        wrap.addEventListener('mousedown', (e) => {
            ColorWheel.isDragging = true;
            ColorWheel.handleDrag(e);
        });
        
        document.addEventListener('mousemove', (e) => {
            if(ColorWheel.isDragging) ColorWheel.handleDrag(e);
        });
        
        document.addEventListener('mouseup', () => {
            ColorWheel.isDragging = false;
        });
    },
    
    handleDrag: (e) => {
        const rect = ColorWheel.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left - ColorWheel.centerX;
        const y = e.clientY - rect.top - ColorWheel.centerY;
        
        let angle = Math.atan2(y, x) * 180 / Math.PI + 90;
        if(angle < 0) angle += 360;
        
        const distance = Math.sqrt(x * x + y * y);
        const saturation = Math.min(100, Math.max(10, (distance / ColorWheel.radius) * 100));
        
        ColorWheel.baseHue = angle;
        ColorWheel.baseSaturation = saturation;
        
        ColorWheel.generateColors();
        ColorWheel.updateMarkers();
    },
    
    setHarmony: (harmony) => {
        ColorWheel.harmony = harmony;
        ColorWheel.generateColors();
        ColorWheel.updateMarkers();
    },
    
    setBrightness: (value) => {
        ColorWheel.brightness = parseInt(value);
        document.getElementById('brightnessValue').textContent = value;
        ColorWheel.drawWheel();
        ColorWheel.generateColors();
        ColorWheel.updateMarkers();
    },
    
    generateColors: () => {
        const h = ColorWheel.harmony;
        const harmonyData = ColorWheel.harmonies[h];
        const baseHue = ColorWheel.baseHue;
        const baseSat = ColorWheel.baseSaturation;
        const light = ColorWheel.brightness;
        
        ColorWheel.colors = [];
        
        for(let i = 0; i < 5; i++) {
            let hue = (baseHue + harmonyData.angles[i] + 360) % 360;
            // Appliquer la saturation de base proportionnellement
            let sat;
            if(harmonyData.saturations) {
                sat = (harmonyData.saturations[i] / 100) * baseSat;
            } else {
                sat = baseSat;
            }
            let l = harmonyData.lightnesses ? harmonyData.lightnesses[i] : light;
            
            ColorWheel.colors.push({
                hue: hue,
                saturation: Math.round(sat),
                lightness: l,
                hex: ColorWheel.hslToHex(hue, sat, l)
            });
        }
        
        ColorWheel.renderColors();
    },
    
    hslToHex: (h, s, l) => {
        s /= 100;
        l /= 100;
        const a = s * Math.min(l, 1 - l);
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
    },
    
    hexToRgb: (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    },
    
    renderColors: () => {
        const container = document.getElementById('generatedColors');
        if(!container) return;
        
        container.innerHTML = ColorWheel.colors.map((c, i) => {
            const rgb = ColorWheel.hexToRgb(c.hex);
            return `
                <div class="generated-color-item" onclick="navigator.clipboard.writeText('${c.hex}'); Utils.toast('${c.hex} copiÃ© !', 'success');">
                    <div class="generated-color-swatch" style="background: ${c.hex}"></div>
                    <div class="generated-color-info">
                        <div class="generated-color-hex">${c.hex}</div>
                        <div class="generated-color-rgb">RGB(${rgb.r}, ${rgb.g}, ${rgb.b})</div>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    updateMarkers: () => {
        const wrap = document.getElementById('colorWheelWrap');
        if(!wrap) return;
        
        wrap.querySelectorAll('.color-wheel-marker').forEach(m => m.remove());
        
        ColorWheel.colors.forEach((c, i) => {
            const marker = document.createElement('div');
            marker.className = 'color-wheel-marker' + (i === 0 ? ' main draggable' : '');
            
            const rad = (c.hue - 90) * Math.PI / 180;
            const dist = (c.saturation / 100) * ColorWheel.radius;
            const x = ColorWheel.centerX + dist * Math.cos(rad);
            const y = ColorWheel.centerY + dist * Math.sin(rad);
            
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.style.backgroundColor = c.hex;
            
            wrap.appendChild(marker);
        });
    },
    
    addToBoard: () => {
        const hexColors = ColorWheel.colors.map(c => c.hex);
        const nameInput = document.getElementById('paletteNameInput');
        const paletteName = nameInput && nameInput.value.trim() ? nameInput.value.trim() : ColorWheel.harmonies[ColorWheel.harmony].name;
        
        ColorWheel.close();
        
        if(ColorWheel.onComplete) {
            ColorWheel.onComplete(hexColors, paletteName);
        }
    }
};

const MoodBoard = {
    currentBoardId: null,
    selectedElementId: null,
    zoom: 1,
    panX: 0,
    panY: 0,
    isPanning: false,
    panStartX: 0,
    panStartY: 0,
    isDraggingElement: false,
    isResizingElement: false,
    resizeHandle: null,
    dragOffsetX: 0,
    dragOffsetY: 0,
    
    init: () => {
        MoodBoard.renderBoardsList();
        MoodBoard.setupCanvasEvents();
        MoodBoard.updateEmptyState();
    },
    
    // Initialiser les Ã©vÃ©nements du canvas
    setupCanvasEvents: () => {
        const wrapper = document.getElementById('moodboardCanvasWrapper');
        const canvas = document.getElementById('moodboardCanvas');
        if(!wrapper || !canvas) return;
        
        // Menu radial au clic droit
        wrapper.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const board = MoodBoard.getCurrentBoard();
            if(!board) return;
            
            // Position du clic relative au canvas
            const rect = canvas.getBoundingClientRect();
            MoodBoard.contextX = (e.clientX - rect.left - MoodBoard.panX) / MoodBoard.zoom;
            MoodBoard.contextY = (e.clientY - rect.top - MoodBoard.panY) / MoodBoard.zoom;
            
            // VÃ©rifier si on clique sur un Ã©lÃ©ment
            const clickedElement = e.target.closest('.moodboard-element');
            if(clickedElement) {
                MoodBoard.showElementContextMenu(e.clientX, e.clientY, clickedElement.dataset.id);
            } else {
                MoodBoard.showRadialMenu(e.clientX, e.clientY);
            }
        });
        
        // Pan avec clic milieu ou espace + clic
        wrapper.addEventListener('mousedown', (e) => {
            if(e.target === canvas || e.target === wrapper) {
                if(e.button === 1 || (e.button === 0 && e.target === canvas)) {
                    MoodBoard.isPanning = true;
                    MoodBoard.panStartX = e.clientX - MoodBoard.panX;
                    MoodBoard.panStartY = e.clientY - MoodBoard.panY;
                    canvas.classList.add('dragging');
                    e.preventDefault();
                }
                // DÃ©sÃ©lectionner si clic sur canvas vide
                if(e.target === canvas) {
                    MoodBoard.selectElement(null);
                }
            }
        });
        
        wrapper.addEventListener('mousemove', (e) => {
            if(MoodBoard.isPanning) {
                MoodBoard.panX = e.clientX - MoodBoard.panStartX;
                MoodBoard.panY = e.clientY - MoodBoard.panStartY;
                MoodBoard.updateCanvasTransform();
            }
        });
        
        wrapper.addEventListener('mouseup', () => {
            MoodBoard.isPanning = false;
            canvas.classList.remove('dragging');
        });
        
        wrapper.addEventListener('mouseleave', () => {
            MoodBoard.isPanning = false;
            canvas.classList.remove('dragging');
        });
        
        // Zoom avec molette
        wrapper.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newZoom = Math.max(0.1, Math.min(3, MoodBoard.zoom + delta));
            MoodBoard.zoom = newZoom;
            MoodBoard.updateCanvasTransform();
            MoodBoard.updateZoomDisplay();
        });
        
        // Drag & drop fichiers
        wrapper.addEventListener('dragover', (e) => {
            e.preventDefault();
            wrapper.style.background = 'rgba(59, 130, 246, 0.1)';
        });
        
        wrapper.addEventListener('dragleave', () => {
            wrapper.style.background = '';
        });
        
        wrapper.addEventListener('drop', (e) => {
            e.preventDefault();
            wrapper.style.background = '';
            const files = e.dataTransfer.files;
            if(files.length > 0) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / MoodBoard.zoom;
                const y = (e.clientY - rect.top) / MoodBoard.zoom;
                Array.from(files).forEach((file, i) => {
                    if(file.type.startsWith('image/')) {
                        MoodBoard.addImageFromFile(file, x + i * 20, y + i * 20);
                    }
                });
            }
        });
    },
    
    updateCanvasTransform: () => {
        const canvas = document.getElementById('moodboardCanvas');
        if(canvas) {
            canvas.style.transform = `translate(${MoodBoard.panX}px, ${MoodBoard.panY}px) scale(${MoodBoard.zoom})`;
        }
        MoodBoard.updateMinimap();
    },
    
    updateZoomDisplay: () => {
        const display = document.getElementById('moodboardZoomLevel');
        if(display) {
            display.textContent = Math.round(MoodBoard.zoom * 100) + '%';
        }
    },
    
    zoomIn: () => {
        MoodBoard.zoom = Math.min(3, MoodBoard.zoom + 0.1);
        MoodBoard.updateCanvasTransform();
        MoodBoard.updateZoomDisplay();
    },
    
    zoomOut: () => {
        MoodBoard.zoom = Math.max(0.1, MoodBoard.zoom - 0.1);
        MoodBoard.updateCanvasTransform();
        MoodBoard.updateZoomDisplay();
    },
    
    zoomReset: () => {
        MoodBoard.zoom = 1;
        MoodBoard.panX = 0;
        MoodBoard.panY = 0;
        MoodBoard.updateCanvasTransform();
        MoodBoard.updateZoomDisplay();
    },
    
    updateMinimap: () => {
        // TODO: ImplÃ©menter la minimap
    },
    
    updateEmptyState: () => {
        const empty = document.getElementById('moodboardEmpty');
        const canvas = document.getElementById('moodboardCanvas');
        const boards = state.data.moodboards || [];
        
        if(boards.length === 0) {
            if(empty) empty.style.display = 'flex';
            if(canvas) canvas.style.display = 'none';
        } else {
            if(empty) empty.style.display = 'none';
            if(canvas) canvas.style.display = 'block';
        }
    },
    
    // ===== GESTION DES PLANCHES =====
    
    createBoard: async () => {
        // CrÃ©er une modale personnalisÃ©e avec nom + liaison
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'confirm-modal-overlay';
            modal.onclick = (e) => { if(e.target === modal) { modal.remove(); resolve(); } };
            
            // Construire les options de liaison par catÃ©gories
            let linkOptionsHtml = '<option value="project">ðŸŽ¬ Projet entier</option>';
            
            // ScÃ¨nes
            if((state.data.scenes || []).length > 0) {
                linkOptionsHtml += '<optgroup label="ðŸ“„ ScÃ¨nes">';
                (state.data.scenes || []).forEach((scene, i) => {
                    linkOptionsHtml += `<option value="scene_${scene.id}">ScÃ¨ne ${i+1}: ${Utils.escape(scene.title || 'Sans titre')}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            // Personnages
            if((state.data.characters || []).length > 0) {
                linkOptionsHtml += '<optgroup label="ðŸ‘¤ Personnages">';
                (state.data.characters || []).forEach(char => {
                    linkOptionsHtml += `<option value="character_${char.id}">${Utils.escape(char.name)}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            // ComÃ©diens
            if((state.data.actors || []).length > 0) {
                linkOptionsHtml += '<optgroup label="ðŸŽ­ ComÃ©diens">';
                (state.data.actors || []).forEach(actor => {
                    linkOptionsHtml += `<option value="actor_${actor.id}">${Utils.escape(actor.name)}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            // DÃ©cors
            if((state.data.locations || []).length > 0) {
                linkOptionsHtml += '<optgroup label="ðŸ“ DÃ©cors">';
                (state.data.locations || []).forEach(loc => {
                    linkOptionsHtml += `<option value="location_${loc.id}">${Utils.escape(loc.name)}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            // Ressources
            if((state.data.resources || []).length > 0) {
                linkOptionsHtml += '<optgroup label="ðŸ“¦ Ressources">';
                (state.data.resources || []).forEach(res => {
                    linkOptionsHtml += `<option value="resource_${res.id}">${Utils.escape(res.name)}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            modal.innerHTML = `
                <div class="confirm-modal-box" style="max-width: 450px;">
                    <div class="confirm-modal-icon">ðŸŽ¨</div>
                    <div class="confirm-modal-title">Nouvelle planche</div>
                    <div style="text-align: left; margin: 15px 0;">
                        <label class="label-500">Nom de la planche :</label>
                        <input type="text" id="mbNewBoardName" class="n8-badge-12" value="Planche ${(state.data.moodboards || []).length + 1}" placeholder="Ex: Ambiance gÃ©nÃ©rale...">
                    </div>
                    <div style="text-align: left; margin: 15px 0;">
                        <label class="label-500">Lier Ã  :</label>
                        <select id="mbNewBoardLink" class="n8-badge-12">
                            ${linkOptionsHtml}
                        </select>
                    </div>
                    <div class="confirm-modal-buttons">
                        <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                        <button class="confirm-modal-btn confirm" id="mbCreateBoardBtn">CrÃ©er</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const nameInput = modal.querySelector('#mbNewBoardName');
            const linkSelect = modal.querySelector('#mbNewBoardLink');
            const createBtn = modal.querySelector('#mbCreateBoardBtn');
            
            nameInput.focus();
            nameInput.select();
            
            nameInput.onkeydown = (e) => { if(e.key === 'Enter') createBtn.click(); if(e.key === 'Escape') modal.remove(); };
            
            createBtn.onclick = () => {
                const name = nameInput.value.trim();
                if(!name) {
                    Utils.toast('Entrez un nom pour la planche', 'warning');
                    return;
                }
                
                const linkValue = linkSelect.value;
                let linkedTo = { type: 'project' };
                if(linkValue !== 'project') {
                    const [type, ...idParts] = linkValue.split('_');
                    linkedTo = { type, id: idParts.join('_') };
                }
                
                if(!state.data.moodboards) state.data.moodboards = [];
                
                const board = {
                    id: 'mb_' + Date.now(),
                    name: name,
                    format: 'free',
                    linkedTo: linkedTo,
                    elements: [],
                    createdAt: Date.now(),
                    modifiedAt: Date.now()
                };
                
                state.data.moodboards.push(board);
                Store.save();
                
                modal.remove();
                
                MoodBoard.renderBoardsList();
                MoodBoard.selectBoard(board.id);
                MoodBoard.updateEmptyState();
                
                Utils.toast('Planche "' + name + '" crÃ©Ã©e', 'success');
                resolve(board);
            };
        });
    },
    
    renderBoardsList: () => {
        const container = document.getElementById('moodboardBoardsList');
        if(!container) return;
        
        const boards = state.data.moodboards || [];
        
        if(boards.length === 0) {
            container.innerHTML = '<span style="color: var(--text-sec); font-style: italic; padding: 5px;">Aucune planche</span>';
            return;
        }
        
        container.innerHTML = boards.map(board => {
            const isActive = board.id === MoodBoard.currentBoardId;
            const linkedIcon = board.linkedTo ? 'ðŸ”— ' : '';
            return `
                <div class="moodboard-board-tab ${isActive ? 'active' : ''}" onclick="app.MoodBoard.selectBoard('${board.id}')">
                    ${linkedIcon}${Utils.escape(board.name)}
                    <span class="tab-close" onclick="event.stopPropagation(); app.MoodBoard.deleteBoard('${board.id}')">Ã—</span>
                </div>
            `;
        }).join('');
        
        // Bouton ajouter
        container.innerHTML += `
            <div class="moodboard-board-tab" onclick="app.MoodBoard.createBoard()" style="border-style: dashed;">
                + Nouvelle
            </div>
        `;
    },
    
    selectBoard: (boardId) => {
        MoodBoard.currentBoardId = boardId;
        MoodBoard.selectedElementId = null;
        
        // S'assurer que la planche a un tableau elements
        const board = MoodBoard.getCurrentBoard();
        if(board && !board.elements) {
            board.elements = [];
            Store.save();
        }
        
        MoodBoard.renderBoardsList();
        MoodBoard.renderCanvas();
        
        // Mettre Ã  jour le format
        if(board) {
            const formatSelect = document.getElementById('moodboardFormat');
            if(formatSelect) formatSelect.value = board.format || 'free';
        }
    },
    
    getCurrentBoard: () => {
        if(!MoodBoard.currentBoardId) return null;
        const board = (state.data.moodboards || []).find(b => b.id === MoodBoard.currentBoardId);
        if(board && !board.elements) {
            board.elements = [];
        }
        return board;
    },
    
    deleteBoard: async (boardId) => {
        const board = (state.data.moodboards || []).find(b => b.id === boardId);
        if(!board) return;
        
        const confirmed = await ConfirmModal.show({
            title: 'Supprimer la planche ?',
            message: `Voulez-vous vraiment supprimer "${board.name}" et tous ses Ã©lÃ©ments ?`,
            type: 'danger',
            confirmText: 'Supprimer'
        });
        
        if(!confirmed) return;
        
        state.data.moodboards = state.data.moodboards.filter(b => b.id !== boardId);
        
        if(MoodBoard.currentBoardId === boardId) {
            MoodBoard.currentBoardId = state.data.moodboards.length > 0 ? state.data.moodboards[0].id : null;
        }
        
        Store.save();
        MoodBoard.renderBoardsList();
        MoodBoard.renderCanvas();
        MoodBoard.updateEmptyState();
        
        Utils.toast('Planche supprimÃ©e', 'success');
    },
    
    changeFormat: (format) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        board.format = format;
        board.modifiedAt = Date.now();
        Store.save();
        
        // Mettre Ã  jour la classe du canvas
        const canvas = document.getElementById('moodboardCanvas');
        if(canvas) {
            canvas.className = 'moodboard-canvas format-' + format;
        }
        
        // Synchroniser tous les selects de format
        const formatSelect = document.getElementById('moodboardFormat');
        if(formatSelect) formatSelect.value = format;
        
        // Mettre Ã  jour le panneau info si ouvert
        MoodBoard.updateInfoPanel();
        
        // Recentrer la vue
        MoodBoard.zoomReset();
        
        Utils.toast('Format: ' + format.replace('-', ' ').toUpperCase(), 'success');
    },
    
    // ===== GESTION DES Ã‰LÃ‰MENTS =====
    
    addElement: async (type) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('CrÃ©ez d\'abord une planche', 'warning');
            return;
        }
        
        let element = {
            id: 'el_' + Date.now(),
            type: type,
            x: 100 + Math.random() * 200,
            y: 100 + Math.random() * 200,
            width: 200,
            height: 200,
            linkedTo: null,
            createdAt: Date.now()
        };
        
        if(type === 'image') {
            // Ouvrir le sÃ©lecteur de fichier
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    MoodBoard.addImageFromFile(file, element.x, element.y);
                }
            };
            input.click();
            return;
        }
        
        if(type === 'text') {
            element.content = 'Double-cliquez pour Ã©diter...';
            element.fontSize = 16;
            element.width = 250;
            element.height = 150;
        }
        
        if(type === 'palette') {
            element.colors = ['#264653', '#2a9d8f', '#e9c46a', '#f4a261', '#e76f51', '#ffffff'];
            element.width = 180;
            element.height = 130;
        }
        
        if(type === 'link') {
            const url = await ConfirmModal.prompt({
                title: 'Ajouter un lien',
                message: 'URL du lien (image, vidÃ©o, rÃ©fÃ©rence...) :',
                placeholder: 'https://...'
            });
            if(!url) return;
            
            element.url = url;
            element.title = url.split('/').pop() || 'Lien';
            element.width = 180;
            element.height = 120;
        }
        
        board.elements.push(element);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        MoodBoard.selectElement(element.id);
    },
    
    addImageFromFile: (file, x, y) => {
        const boardId = MoodBoard.currentBoardId;
        if(!boardId) {
            Utils.toast('SÃ©lectionnez d\'abord une planche', 'warning');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            const img = new Image();
            img.onload = () => {
                // RÃ©cupÃ©rer la planche au moment de l'ajout (pas avant)
                const board = MoodBoard.getCurrentBoard();
                if(!board) {
                    Utils.toast('Erreur: planche non trouvÃ©e', 'error');
                    return;
                }
                
                // Calculer les dimensions proportionnelles
                let width = img.width;
                let height = img.height;
                const maxSize = 400;
                
                if(width > maxSize || height > maxSize) {
                    if(width > height) {
                        height = (height / width) * maxSize;
                        width = maxSize;
                    } else {
                        width = (width / height) * maxSize;
                        height = maxSize;
                    }
                }
                
                const element = {
                    id: 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    type: 'image',
                    x: x || 100,
                    y: y || 100,
                    width: Math.round(width),
                    height: Math.round(height),
                    src: dataUrl,
                    fileName: file.name,
                    linkedTo: null,
                    createdAt: Date.now()
                };
                
                board.elements.push(element);
                board.modifiedAt = Date.now();
                Store.save();
                
                MoodBoard.renderCanvas();
                Utils.toast('Image ajoutÃ©e: ' + file.name, 'success');
            };
            img.onerror = () => {
                Utils.toast('Erreur de chargement de l\'image', 'error');
            };
            img.src = dataUrl;
        };
        reader.onerror = () => {
            Utils.toast('Erreur de lecture du fichier', 'error');
        };
        reader.readAsDataURL(file);
    },
    
    renderElementsList: () => {
        const container = document.getElementById('moodboardElementsList');
        const countEl = document.getElementById('moodboardElementsCount');
        if(!container) return;
        
        const board = MoodBoard.getCurrentBoard();
        if(!board || !board.elements || board.elements.length === 0) {
            container.innerHTML = '<p style="color: var(--text-sec); text-align: center; padding: 20px; font-size: 0.85rem;">Aucun Ã©lÃ©ment<br><small>Clic droit sur le canvas pour ajouter</small></p>';
            if(countEl) countEl.textContent = '0';
            return;
        }
        
        if(countEl) countEl.textContent = board.elements.length;
        
        const typeIcons = {
            'image': 'ðŸ–¼ï¸',
            'drawing': 'âœï¸',
            'text': 'ðŸ“',
            'palette': 'ðŸŽ¨',
            'link': 'ðŸ”—',
            'file': 'ðŸ“'
        };
        
        const typeLabels = {
            'image': 'Image',
            'drawing': 'Dessin',
            'text': 'Texte',
            'palette': 'Palette',
            'link': 'Lien',
            'file': 'Fichier'
        };
        
        container.innerHTML = board.elements.map(el => {
            const isSelected = el.id === MoodBoard.selectedElementId;
            const icon = typeIcons[el.type] || 'ðŸ“„';
            const typeLabel = typeLabels[el.type] || el.type;
            
            let name = '';
            if(el.type === 'text') name = (el.content || '').substring(0, 25) + (el.content?.length > 25 ? '...' : '');
            else if(el.type === 'image' || el.type === 'file') name = el.fileName || 'Sans nom';
            else if(el.type === 'palette') name = el.paletteName || 'Palette';
            else if(el.type === 'link') name = el.title || 'Lien';
            else if(el.type === 'drawing') name = 'Dessin';
            else name = typeLabel;
            
            let linkedHtml = '';
            if(el.linkedTo) {
                const linkedLabel = MoodBoard.getLinkLabel(el.linkedTo);
                linkedHtml = `<div class="el-linked">ðŸ”— ${linkedLabel}</div>`;
            }
            
            return `
                <div class="moodboard-element-item ${isSelected ? 'selected' : ''}" 
                     onclick="app.MoodBoard.selectElement('${el.id}')"
                     ondblclick="app.MoodBoard.focusElement('${el.id}')">
                    <span class="el-icon">${icon}</span>
                    <div class="el-info">
                        <div class="el-type">${typeLabel}</div>
                        <div class="el-name">${Utils.escape(name)}</div>
                        ${linkedHtml}
                    </div>
                    <div class="el-actions">
                        <button onclick="event.stopPropagation(); app.MoodBoard.editElement('${el.id}')" title="Modifier">âœï¸</button>
                        <button onclick="event.stopPropagation(); app.MoodBoard.deleteElement('${el.id}')" title="Supprimer">ðŸ—‘ï¸</button>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    getLinkLabel: (linkedTo) => {
        if(!linkedTo) return '';
        if(linkedTo.type === 'project') return 'Projet';
        
        const collections = {
            'scene': state.data.scenes,
            'character': state.data.characters,
            'actor': state.data.actors,
            'location': state.data.locations,
            'resource': state.data.resources
        };
        
        const labels = {
            'scene': 'ScÃ¨ne',
            'character': 'Personnage',
            'actor': 'ComÃ©dien',
            'location': 'DÃ©cor',
            'resource': 'Ressource'
        };
        
        const collection = collections[linkedTo.type] || [];
        const item = collection.find(i => i.id === linkedTo.id);
        
        if(item) {
            return `${labels[linkedTo.type]}: ${item.name || item.title || linkedTo.id}`;
        }
        return labels[linkedTo.type] || linkedTo.type;
    },
    
    moveElementUp: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const index = board.elements.findIndex(el => el.id === elementId);
        if(index < board.elements.length - 1) {
            // Ã‰changer avec l'Ã©lÃ©ment suivant (plus haut dans le z-index)
            const temp = board.elements[index];
            board.elements[index] = board.elements[index + 1];
            board.elements[index + 1] = temp;
            
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Ã‰lÃ©ment montÃ©', 'success');
        } else {
            Utils.toast('DÃ©jÃ  au premier plan', 'info');
        }
    },
    
    moveElementDown: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const index = board.elements.findIndex(el => el.id === elementId);
        if(index > 0) {
            // Ã‰changer avec l'Ã©lÃ©ment prÃ©cÃ©dent (plus bas dans le z-index)
            const temp = board.elements[index];
            board.elements[index] = board.elements[index - 1];
            board.elements[index - 1] = temp;
            
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Ã‰lÃ©ment descendu', 'success');
        } else {
            Utils.toast('DÃ©jÃ  en arriÃ¨re-plan', 'info');
        }
    },
    
    focusElement: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        // Centrer la vue sur l'Ã©lÃ©ment
        const wrapper = document.getElementById('moodboardCanvasWrapper');
        if(!wrapper) return;
        
        const wrapperRect = wrapper.getBoundingClientRect();
        const centerX = wrapperRect.width / 2;
        const centerY = wrapperRect.height / 2;
        
        MoodBoard.panX = centerX - (element.x + element.width / 2) * MoodBoard.zoom;
        MoodBoard.panY = centerY - (element.y + element.height / 2) * MoodBoard.zoom;
        
        MoodBoard.updateCanvasTransform();
        MoodBoard.selectElement(elementId);
    },
    
    renderCanvas: () => {
        const canvas = document.getElementById('moodboardCanvas');
        if(!canvas) return;
        
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            canvas.innerHTML = '';
            MoodBoard.renderElementsList();
            return;
        }
        
        // Appliquer le format
        canvas.className = 'moodboard-canvas format-' + (board.format || 'free');
        
        // Rendre les Ã©lÃ©ments
        canvas.innerHTML = board.elements.map(el => MoodBoard.renderElement(el)).join('');
        
        // Attacher les Ã©vÃ©nements
        board.elements.forEach(el => {
            MoodBoard.attachElementEvents(el.id);
        });
        
        // Mettre Ã  jour la liste des Ã©lÃ©ments dans la sidebar
        MoodBoard.renderElementsList();
    },
    
    renderElement: (el) => {
        const isSelected = el.id === MoodBoard.selectedElementId;
        const linkedBadge = el.linkedTo ? `<div class="element-linked-badge" title="LiÃ© Ã : ${el.linkedTo.type}">ðŸ”—</div>` : '';
        let content = '';
        
        if(el.type === 'image' || el.type === 'drawing') {
            content = `<img class="moodboard-element-image" src="${el.src}" alt="">`;
        }
        
        if(el.type === 'text') {
            const style = `
                font-family: ${el.fontFamily || 'Inter, sans-serif'};
                font-size: ${el.fontSize || 18}px;
                text-align: ${el.textAlign || 'left'};
                color: ${el.textColor || '#333333'};
            `;
            content = `<div class="moodboard-element-text" style="${style}">${Utils.escape(el.content || '').replace(/\n/g, '<br>')}</div>`;
        }
        
        if(el.type === 'palette') {
            const colors = el.colors || ['#000000'];
            content = `<div class="moodboard-element-palette">
                ${el.paletteName ? `<div class="palette-title">${Utils.escape(el.paletteName)}</div>` : ''}
                <div class="palette-colors">
                    ${colors.map(c => `<div class="color-swatch" title="${c}">
                        <div class="color-swatch-box" style="background: ${c};"></div>
                        <span>${c}</span>
                    </div>`).join('')}
                </div>
            </div>`;
        }
        
        if(el.type === 'shape') {
            const shape = MoodBoard.shapes.find(s => s.id === el.shapeId);
            if(shape) {
                content = `<div class="moodboard-element-shape" style="color: ${el.color || '#000000'}; transform: rotate(${el.rotation || 0}deg);">
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none">${shape.svg}</svg>
                </div>`;
            }
        }
        
        if(el.type === 'link') {
            content = `<div class="moodboard-element-link" ondblclick="window.open('${el.url}', '_blank')">
                <div class="link-icon">ðŸ”—</div>
                <div class="link-title">${Utils.escape(el.title || 'Lien')}</div>
                <div class="link-url">${Utils.escape(el.url || '').substring(0, 40)}...</div>
            </div>`;
        }
        
        if(el.type === 'file') {
            const icon = el.fileType.includes('pdf') ? 'ðŸ“„' : 
                        el.fileType.includes('word') || el.fileType.includes('doc') ? 'ðŸ“' : 'ðŸ“';
            const size = el.fileSize > 1024*1024 ? (el.fileSize/1024/1024).toFixed(1) + ' MB' : (el.fileSize/1024).toFixed(0) + ' KB';
            content = `<div class="moodboard-element-file" ondblclick="app.MoodBoard.openFile('${el.id}')">
                <div class="file-icon">${icon}</div>
                <div class="file-name">${Utils.escape(el.fileName || 'Fichier')}</div>
                <div class="file-size">${size}</div>
            </div>`;
        }
        
        const rotateHandle = (el.type === 'shape' || el.type === 'image' || el.type === 'drawing') ? '<div class="rotate-handle" data-action="rotate"></div>' : '';
        
        return `
            <div class="moodboard-element ${isSelected ? 'selected' : ''}" 
                 id="mb-el-${el.id}"
                 data-id="${el.id}"
                 style="left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; height: ${el.height}px; transform: rotate(${el.rotation || 0}deg);">
                ${linkedBadge}
                ${rotateHandle}
                ${content}
                <div class="resize-handle se"></div>
                <div class="resize-handle sw"></div>
                <div class="resize-handle ne"></div>
                <div class="resize-handle nw"></div>
            </div>
        `;
    },
    
    attachElementEvents: (elementId) => {
        const el = document.getElementById('mb-el-' + elementId);
        if(!el) return;
        
        // SÃ©lection au clic
        el.addEventListener('mousedown', (e) => {
            if(e.target.classList.contains('resize-handle')) {
                MoodBoard.startResize(elementId, e);
            } else if(e.target.classList.contains('rotate-handle')) {
                MoodBoard.startRotate(elementId, e);
            } else if(!e.target.classList.contains('moodboard-element-text')) {
                MoodBoard.startDrag(elementId, e);
            }
            MoodBoard.selectElement(elementId);
            e.stopPropagation();
        });
        
        // Ã‰dition du texte
        const textEl = el.querySelector('.moodboard-element-text');
        if(textEl) {
            textEl.addEventListener('blur', () => {
                MoodBoard.updateElementContent(elementId, textEl.innerText);
            });
        }
    },
    
    selectElement: (elementId) => {
        MoodBoard.selectedElementId = elementId;
        
        // Mettre Ã  jour les classes
        document.querySelectorAll('.moodboard-element').forEach(el => {
            el.classList.toggle('selected', el.dataset.id === elementId);
        });
        
        // Mettre Ã  jour le panneau d'info
        MoodBoard.updateInfoPanel();
    },
    
    startRotate: (elementId, e) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        const domEl = document.getElementById('mb-el-' + elementId);
        if(!domEl) return;
        
        const rect = domEl.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
        const startRotation = element.rotation || 0;
        
        const onMouseMove = (e) => {
            const currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
            let newRotation = startRotation + (currentAngle - startAngle);
            
            // Snap Ã  15Â° si Shift est pressÃ©
            if(e.shiftKey) {
                newRotation = Math.round(newRotation / 15) * 15;
            }
            
            element.rotation = newRotation;
            domEl.style.transform = `rotate(${newRotation}deg)`;
        };
        
        const onMouseUp = () => {
            board.modifiedAt = Date.now();
            Store.save();
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        e.preventDefault();
    },
    
    startRotate: (elementId, e) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        const domEl = document.getElementById('mb-el-' + elementId);
        if(!domEl) return;
        
        const rect = domEl.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
        const startRotation = element.rotation || 0;
        
        const onMouseMove = (e) => {
            const currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
            let newRotation = startRotation + (currentAngle - startAngle);
            
            // Snap Ã  15Â° si Shift est pressÃ©
            if(e.shiftKey) {
                newRotation = Math.round(newRotation / 15) * 15;
            }
            
            element.rotation = newRotation;
            domEl.style.transform = `rotate(${newRotation}deg)`;
        };
        
        const onMouseUp = () => {
            board.modifiedAt = Date.now();
            Store.save();
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        e.preventDefault();
    },
    
    startDrag: (elementId, e) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.isDraggingElement = true;
        MoodBoard.dragOffsetX = (e.clientX / MoodBoard.zoom) - element.x;
        MoodBoard.dragOffsetY = (e.clientY / MoodBoard.zoom) - element.y;
        
        const onMouseMove = (e) => {
            if(!MoodBoard.isDraggingElement) return;
            
            const newX = (e.clientX / MoodBoard.zoom) - MoodBoard.dragOffsetX;
            const newY = (e.clientY / MoodBoard.zoom) - MoodBoard.dragOffsetY;
            
            element.x = Math.max(0, newX);
            element.y = Math.max(0, newY);
            
            const domEl = document.getElementById('mb-el-' + elementId);
            if(domEl) {
                domEl.style.left = element.x + 'px';
                domEl.style.top = element.y + 'px';
            }
        };
        
        const onMouseUp = () => {
            MoodBoard.isDraggingElement = false;
            board.modifiedAt = Date.now();
            Store.save();
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    },
    
    startResize: (elementId, e) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.isResizingElement = true;
        MoodBoard.resizeHandle = e.target.classList.contains('se') ? 'se' :
                                 e.target.classList.contains('sw') ? 'sw' :
                                 e.target.classList.contains('ne') ? 'ne' : 'nw';
        
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = element.width;
        const startHeight = element.height;
        const startElX = element.x;
        const startElY = element.y;
        
        const onMouseMove = (e) => {
            if(!MoodBoard.isResizingElement) return;
            
            const dx = (e.clientX - startX) / MoodBoard.zoom;
            const dy = (e.clientY - startY) / MoodBoard.zoom;
            
            if(MoodBoard.resizeHandle === 'se') {
                element.width = Math.max(80, startWidth + dx);
                element.height = Math.max(80, startHeight + dy);
            } else if(MoodBoard.resizeHandle === 'sw') {
                element.width = Math.max(80, startWidth - dx);
                element.height = Math.max(80, startHeight + dy);
                element.x = startElX + (startWidth - element.width);
            } else if(MoodBoard.resizeHandle === 'ne') {
                element.width = Math.max(80, startWidth + dx);
                element.height = Math.max(80, startHeight - dy);
                element.y = startElY + (startHeight - element.height);
            } else if(MoodBoard.resizeHandle === 'nw') {
                element.width = Math.max(80, startWidth - dx);
                element.height = Math.max(80, startHeight - dy);
                element.x = startElX + (startWidth - element.width);
                element.y = startElY + (startHeight - element.height);
            }
            
            const domEl = document.getElementById('mb-el-' + elementId);
            if(domEl) {
                domEl.style.left = element.x + 'px';
                domEl.style.top = element.y + 'px';
                domEl.style.width = element.width + 'px';
                domEl.style.height = element.height + 'px';
            }
        };
        
        const onMouseUp = () => {
            MoodBoard.isResizingElement = false;
            board.modifiedAt = Date.now();
            Store.save();
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    },
    
    updateElementContent: (elementId, content) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        element.content = content;
        board.modifiedAt = Date.now();
        Store.save();
    },
    
    editElement: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        if(element.type === 'text') {
            MoodBoard.showTextPanel(element);
        }
        
        if(element.type === 'palette') {
            // Ouvrir l'Ã©diteur de palette avec les couleurs existantes
            ColorWheel.open((colors, name) => {
                if(colors && colors.length > 0) {
                    element.colors = colors;
                    if(name) element.paletteName = name;
                    board.modifiedAt = Date.now();
                    Store.save();
                    MoodBoard.renderCanvas();
                    Utils.toast('Palette modifiÃ©e', 'success');
                }
            }, element.colors, element.paletteName);
        }
        
        if(element.type === 'link') {
            const url = await ConfirmModal.prompt('URL du lien :', 'Modifier le lien', 'https://...', element.url || '');
            if(url === null) return;
            
            element.url = url;
            try { element.title = new URL(url).hostname; } catch(e) { element.title = 'Lien'; }
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Lien modifiÃ©', 'success');
        }
        
        if(element.type === 'drawing') {
            // RÃ©ouvrir l'Ã©diteur de dessin avec l'image existante
            MoodBoard.editDrawing(element);
        }
        
        if(element.type === 'image') {
            // Permettre de remplacer l'image
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    element.src = ev.target.result;
                    element.fileName = file.name;
                    board.modifiedAt = Date.now();
                    Store.save();
                    MoodBoard.renderCanvas();
                    Utils.toast('Image remplacÃ©e', 'success');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
        
        if(element.type === 'file') {
            Utils.toast('Double-cliquez pour ouvrir le fichier', 'info');
        }
    },
    
    showTextEditPanel: (element) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const modal = document.createElement('div');
        modal.className = 'confirm-modal-overlay';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="confirm-modal-box" style="max-width: 500px;">
                <div class="confirm-modal-icon">ðŸ“</div>
                <div class="confirm-modal-title">Modifier le texte</div>
                <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; align-items: center;">
                    <select id="mbEditTextFont" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); min-width: 120px;">
                        <option value="Inter, sans-serif" ${element.fontFamily?.includes('Inter') ? 'selected' : ''}>Inter</option>
                        <option value="Georgia, serif" ${element.fontFamily?.includes('Georgia') ? 'selected' : ''}>Georgia</option>
                        <option value="'Courier New', monospace" ${element.fontFamily?.includes('Courier') ? 'selected' : ''}>Courier</option>
                        <option value="'Comic Sans MS', cursive" ${element.fontFamily?.includes('Comic') ? 'selected' : ''}>Comic Sans</option>
                        <option value="Impact, sans-serif" ${element.fontFamily?.includes('Impact') ? 'selected' : ''}>Impact</option>
                        <option value="'Times New Roman', serif" ${element.fontFamily?.includes('Times') ? 'selected' : ''}>Times</option>
                        <option value="Arial, sans-serif" ${element.fontFamily?.includes('Arial') ? 'selected' : ''}>Arial</option>
                        <option value="Verdana, sans-serif" ${element.fontFamily?.includes('Verdana') ? 'selected' : ''}>Verdana</option>
                    </select>
                    <select id="mbEditTextSize" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                        <option value="12" ${element.fontSize == 12 ? 'selected' : ''}>12px</option>
                        <option value="14" ${element.fontSize == 14 ? 'selected' : ''}>14px</option>
                        <option value="18" ${element.fontSize == 18 || !element.fontSize ? 'selected' : ''}>18px</option>
                        <option value="24" ${element.fontSize == 24 ? 'selected' : ''}>24px</option>
                        <option value="32" ${element.fontSize == 32 ? 'selected' : ''}>32px</option>
                        <option value="48" ${element.fontSize == 48 ? 'selected' : ''}>48px</option>
                        <option value="64" ${element.fontSize == 64 ? 'selected' : ''}>64px</option>
                    </select>
                    <input type="color" id="mbEditTextColor" value="${element.textColor || '#333333'}" style="width: 45px; height: 36px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; padding: 2px;">
                </div>
                <div style="margin: 15px 0;">
                    <textarea id="mbEditTextContent" style="width: 100%; height: 120px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); resize: vertical; font-family: ${element.fontFamily || 'Inter, sans-serif'}; font-size: ${element.fontSize || 18}px; color: ${element.textColor || '#333333'};">${Utils.escape(element.content || '')}</textarea>
                </div>
                <div class="confirm-modal-buttons">
                    <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                    <button class="confirm-modal-btn confirm" id="mbSaveTextBtn">Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const textarea = document.getElementById('mbEditTextContent');
        const fontSelect = document.getElementById('mbEditTextFont');
        const sizeSelect = document.getElementById('mbEditTextSize');
        const colorInput = document.getElementById('mbEditTextColor');
        
        // PrÃ©visualisation en direct
        const updatePreview = () => {
            textarea.style.fontFamily = fontSelect.value;
            textarea.style.fontSize = sizeSelect.value + 'px';
            textarea.style.color = colorInput.value;
        };
        
        fontSelect.onchange = updatePreview;
        sizeSelect.onchange = updatePreview;
        colorInput.oninput = updatePreview;
        
        modal.querySelector('#mbSaveTextBtn').onclick = () => {
            element.content = textarea.value;
            element.fontFamily = fontSelect.value;
            element.fontSize = parseInt(sizeSelect.value);
            element.textColor = colorInput.value;
            
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            modal.remove();
            Utils.toast('Texte modifiÃ©', 'success');
        };
        
        textarea.focus();
    },
    
    linkElement: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.showLinkModal(element, (linkedTo) => {
            element.linkedTo = linkedTo;
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Liaison mise Ã  jour', 'success');
        });
    },
    
    showLinkModal: (target, callback) => {
        const modal = document.createElement('div');
        modal.className = 'confirm-modal-overlay';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        // Construire les catÃ©gories
        const categories = [
            { id: 'project', icon: 'ðŸŽ¬', label: 'Projet', items: [{ id: 'project', name: 'Projet entier' }] },
            { id: 'scene', icon: 'ðŸ“„', label: 'ScÃ¨nes', items: (state.data.scenes || []).map((s, i) => ({ id: s.id, name: `ScÃ¨ne ${i+1}: ${s.title || 'Sans titre'}` })) },
            { id: 'character', icon: 'ðŸ‘¤', label: 'Personnages', items: (state.data.characters || []).map(c => ({ id: c.id, name: c.name })) },
            { id: 'actor', icon: 'ðŸŽ­', label: 'ComÃ©diens', items: (state.data.actors || []).map(a => ({ id: a.id, name: a.name })) },
            { id: 'location', icon: 'ðŸ“', label: 'DÃ©cors', items: (state.data.locations || []).map(l => ({ id: l.id, name: l.name })) },
            { id: 'resource', icon: 'ðŸ“¦', label: 'Ressources', items: (state.data.resources || []).map(r => ({ id: r.id, name: r.name })) }
        ];
        
        // Valeur actuelle
        const currentType = target.linkedTo?.type || '';
        const currentId = target.linkedTo?.id || '';
        
        let categoriesHtml = categories.map(cat => {
            if(cat.items.length === 0) return '';
            const isActive = cat.id === currentType || (cat.id === 'project' && currentType === 'project');
            return `<button class="mb-link-cat-btn ${isActive ? 'active' : ''}" data-cat="${cat.id}" style="padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px; background: ${isActive ? 'var(--primary)' : 'var(--bg)'}; color: ${isActive ? 'white' : 'var(--text)'}; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span>${cat.icon}</span>
                <span>${cat.label}</span>
                <span style="opacity: 0.6; font-size: 0.8rem;">(${cat.items.length})</span>
            </button>`;
        }).join('');
        
        modal.innerHTML = `
            <div class="confirm-modal-box" style="max-width: 550px; max-height: 80vh; display: flex; flex-direction: column;">
                <div class="confirm-modal-icon">ðŸ”—</div>
                <div class="confirm-modal-title">Lier Ã  un Ã©lÃ©ment</div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; justify-content: center;">
                    ${categoriesHtml}
                    <button class="mb-link-cat-btn ${!currentType ? 'active' : ''}" data-cat="" style="padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px; background: ${!currentType ? 'var(--primary)' : 'var(--bg)'}; color: ${!currentType ? 'white' : 'var(--text)'}; cursor: pointer;">
                        âŒ Aucune liaison
                    </button>
                </div>
                
                <div id="mbLinkItemsList" style="flex: 1; overflow-y: auto; max-height: 300px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                    <p style="text-align: center; color: var(--text-sec);">SÃ©lectionnez une catÃ©gorie</p>
                </div>
                
                <div class="confirm-modal-buttons">
                    <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const itemsList = modal.querySelector('#mbLinkItemsList');
        const catButtons = modal.querySelectorAll('.mb-link-cat-btn');
        
        const showItems = (catId) => {
            catButtons.forEach(btn => {
                btn.style.background = btn.dataset.cat === catId ? 'var(--primary)' : 'var(--bg)';
                btn.style.color = btn.dataset.cat === catId ? 'white' : 'var(--text)';
            });
            
            if(!catId) {
                // Aucune liaison
                callback(null);
                modal.remove();
                return;
            }
            
            const cat = categories.find(c => c.id === catId);
            if(!cat) return;
            
            if(catId === 'project') {
                callback({ type: 'project' });
                modal.remove();
                return;
            }
            
            itemsList.innerHTML = cat.items.map(item => {
                const isSelected = currentType === catId && currentId === item.id;
                return `<div class="mb-link-item" data-type="${catId}" data-id="${item.id}" style="padding: 12px; border-radius: 6px; cursor: pointer; margin-bottom: 5px; background: ${isSelected ? 'var(--primary)' : 'var(--bg)'}; color: ${isSelected ? 'white' : 'var(--text)'}; transition: background 0.2s;">
                    ${cat.icon} ${Utils.escape(item.name)}
                </div>`;
            }).join('');
            
            itemsList.querySelectorAll('.mb-link-item').forEach(item => {
                item.onmouseenter = () => { if(!item.style.background.includes('primary')) item.style.background = 'var(--border)'; };
                item.onmouseleave = () => { if(!item.style.background.includes('primary')) item.style.background = 'var(--bg)'; };
                item.onclick = () => {
                    callback({ type: item.dataset.type, id: item.dataset.id });
                    modal.remove();
                };
            });
        };
        
        catButtons.forEach(btn => {
            btn.onclick = () => showItems(btn.dataset.cat);
        });
        
        // Afficher la catÃ©gorie actuelle si elle existe
        if(currentType && currentType !== 'project') {
            showItems(currentType);
        }
    },
    
    duplicateElement: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        const newElement = JSON.parse(JSON.stringify(element));
        newElement.id = 'el_' + Date.now();
        newElement.x += 30;
        newElement.y += 30;
        newElement.createdAt = Date.now();
        
        board.elements.push(newElement);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        MoodBoard.selectElement(newElement.id);
        Utils.toast('Ã‰lÃ©ment dupliquÃ©', 'success');
    },
    
    deleteElement: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        board.elements = board.elements.filter(el => el.id !== elementId);
        board.modifiedAt = Date.now();
        Store.save();
        
        if(MoodBoard.selectedElementId === elementId) {
            MoodBoard.selectedElementId = null;
        }
        
        MoodBoard.renderCanvas();
        Utils.toast('Ã‰lÃ©ment supprimÃ©', 'success');
    },
    
    // ===== PANNEAU D'INFO =====
    
    toggleInfoPanel: () => {
        const panel = document.getElementById('moodboardInfoPanel');
        if(panel) {
            panel.classList.toggle('active');
            MoodBoard.updateInfoPanel();
        }
    },
    
    updateInfoPanel: () => {
        const panel = document.getElementById('moodboardInfoPanel');
        const content = document.getElementById('moodboardInfoContent');
        const title = document.getElementById('moodboardInfoTitle');
        if(!panel || !content || !panel.classList.contains('active')) return;
        
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === MoodBoard.selectedElementId);
        
        if(element) {
            title.textContent = 'Ã‰lÃ©ment: ' + element.type;
            content.innerHTML = `
                <div class="info-row">
                    <label>Position X</label>
                    <input type="number" value="${Math.round(element.x)}" onchange="app.MoodBoard.updateElementProp('${element.id}', 'x', parseFloat(this.value))">
                </div>
                <div class="info-row">
                    <label>Position Y</label>
                    <input type="number" value="${Math.round(element.y)}" onchange="app.MoodBoard.updateElementProp('${element.id}', 'y', parseFloat(this.value))">
                </div>
                <div class="info-row">
                    <label>Largeur</label>
                    <input type="number" value="${Math.round(element.width)}" onchange="app.MoodBoard.updateElementProp('${element.id}', 'width', parseFloat(this.value))">
                </div>
                <div class="info-row">
                    <label>Hauteur</label>
                    <input type="number" value="${Math.round(element.height)}" onchange="app.MoodBoard.updateElementProp('${element.id}', 'height', parseFloat(this.value))">
                </div>
                <div class="info-row">
                    <label>LiÃ© Ã </label>
                    <input type="text" value="${element.linkedTo ? element.linkedTo.type + (element.linkedTo.id ? ': ' + element.linkedTo.id : '') : 'Aucun'}" readonly style="cursor: pointer;" onclick="app.MoodBoard.linkElement('${element.id}')">
                </div>
            `;
        } else if(board) {
            title.textContent = 'Planche: ' + board.name;
            content.innerHTML = `
                <div class="info-row">
                    <label>Nom</label>
                    <input type="text" value="${Utils.escape(board.name)}" onchange="app.MoodBoard.updateBoardName(this.value)">
                </div>
                <div class="info-row">
                    <label>Format</label>
                    <select onchange="app.MoodBoard.changeFormat(this.value)">
                        <option value="free" ${board.format === 'free' ? 'selected' : ''}>Libre (infini)</option>
                        <option value="a4-landscape" ${board.format === 'a4-landscape' ? 'selected' : ''}>A4 Paysage</option>
                        <option value="a4-portrait" ${board.format === 'a4-portrait' ? 'selected' : ''}>A4 Portrait</option>
                        <option value="a3-landscape" ${board.format === 'a3-landscape' ? 'selected' : ''}>A3 Paysage</option>
                        <option value="a3-portrait" ${board.format === 'a3-portrait' ? 'selected' : ''}>A3 Portrait</option>
                        <option value="a2-landscape" ${board.format === 'a2-landscape' ? 'selected' : ''}>A2 Paysage</option>
                        <option value="a2-portrait" ${board.format === 'a2-portrait' ? 'selected' : ''}>A2 Portrait</option>
                        <option value="a0-landscape" ${board.format === 'a0-landscape' ? 'selected' : ''}>A0 Paysage</option>
                        <option value="a0-portrait" ${board.format === 'a0-portrait' ? 'selected' : ''}>A0 Portrait</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>Ã‰lÃ©ments</label>
                    <input type="text" value="${board.elements.length}" readonly>
                </div>
                <div class="info-row">
                    <label>Lier la planche Ã </label>
                    <button onclick="app.MoodBoard.linkBoard()" style="width: 100%; padding: 8px; cursor: pointer;">ðŸ”— Configurer...</button>
                </div>
            `;
        } else {
            title.textContent = 'PropriÃ©tÃ©s';
            content.innerHTML = '<p class="text-sec">SÃ©lectionnez une planche ou un Ã©lÃ©ment</p>';
        }
    },
    
    updateElementProp: (elementId, prop, value) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        element[prop] = value;
        board.modifiedAt = Date.now();
        Store.save();
        MoodBoard.renderCanvas();
    },
    
    updateBoardName: (name) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        board.name = name;
        board.modifiedAt = Date.now();
        Store.save();
        MoodBoard.renderBoardsList();
    },
    
    linkBoard: async () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        // Similaire Ã  linkElement mais pour la planche
        const options = [
            { value: '', label: 'â€” Aucune liaison â€”' },
            { value: 'project', label: 'ðŸŽ¬ Projet global' }
        ];
        
        (state.data.scenes || []).forEach((scene, i) => {
            options.push({ value: `scene_${scene.id}`, label: `ðŸ“„ ScÃ¨ne ${i+1}: ${scene.title}` });
        });
        
        (state.data.characters || []).forEach(char => {
            options.push({ value: `character_${char.id}`, label: `ðŸ‘¤ ${char.name}` });
        });
        
        (state.data.actors || []).forEach(actor => {
            options.push({ value: `actor_${actor.id}`, label: `ðŸŽ­ ${actor.name}` });
        });
        
        (state.data.locations || []).forEach(loc => {
            options.push({ value: `location_${loc.id}`, label: `ðŸ“ ${loc.name}` });
        });
        
        const currentValue = board.linkedTo ? `${board.linkedTo.type}_${board.linkedTo.id || ''}` : '';
        
        const result = await ConfirmModal.prompt({
            title: 'Lier cette planche',
            message: 'Associer cette planche Ã  :',
            defaultValue: currentValue,
            type: 'select',
            options: options
        });
        
        if(result === null) return;
        
        if(result === '') {
            board.linkedTo = null;
        } else if(result === 'project') {
            board.linkedTo = { type: 'project' };
        } else {
            const [type, id] = result.split('_');
            board.linkedTo = { type, id };
        }
        
        board.modifiedAt = Date.now();
        Store.save();
        MoodBoard.renderBoardsList();
        MoodBoard.updateInfoPanel();
        Utils.toast('Liaison mise Ã  jour', 'success');
    },
    
    // ===== MENU RADIAL =====
    
    contextX: 0,
    contextY: 0,
    
    showRadialMenu: (x, y) => {
        MoodBoard.hideRadialMenu();
        
        const items = [
            { icon: 'âœï¸', label: 'Dessiner', action: 'draw', angle: 0 },
            { icon: 'ðŸ“', label: 'Texte', action: 'text', angle: 60 },
            { icon: 'ðŸŽ¨', label: 'Palette', action: 'palette', angle: 120 },
            { icon: 'â¬¡', label: 'Formes', action: 'shapes', angle: 180 },
            { icon: 'ðŸ“', label: 'Image / Fichier', action: 'file', angle: 240 },
            { icon: 'ðŸ”—', label: 'Lien web', action: 'link', angle: 300 }
        ];
        
        const radius = 80;
        
        const overlay = document.createElement('div');
        overlay.className = 'moodboard-radial-overlay';
        overlay.onclick = () => MoodBoard.hideRadialMenu();
        document.body.appendChild(overlay);
        
        const menu = document.createElement('div');
        menu.className = 'moodboard-radial-menu';
        menu.id = 'moodboardRadialMenu';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        
        // Centre du menu
        const center = document.createElement('div');
        center.className = 'moodboard-radial-center';
        center.innerHTML = 'âœ•';
        center.onclick = () => MoodBoard.hideRadialMenu();
        menu.appendChild(center);
        
        // Items du menu
        items.forEach((item, i) => {
            const el = document.createElement('div');
            el.className = 'moodboard-radial-item';
            el.innerHTML = `${item.icon}<span class="radial-tooltip">${item.label}</span>`;
            
            const angleRad = (item.angle - 90) * Math.PI / 180;
            const itemX = Math.cos(angleRad) * radius;
            const itemY = Math.sin(angleRad) * radius;
            
            el.style.left = itemX + 'px';
            el.style.top = itemY + 'px';
            el.style.transitionDelay = (i * 0.03) + 's';
            
            el.onclick = () => {
                MoodBoard.hideRadialMenu();
                MoodBoard.handleRadialAction(item.action);
            };
            
            menu.appendChild(el);
        });
        
        document.body.appendChild(menu);
        
        // Activer l'animation
        requestAnimationFrame(() => menu.classList.add('active'));
    },
    
    hideRadialMenu: () => {
        const menu = document.getElementById('moodboardRadialMenu');
        const overlay = document.querySelector('.moodboard-radial-overlay');
        const submenu = document.querySelector('.moodboard-palette-submenu, .moodboard-text-panel');
        if(menu) menu.remove();
        if(overlay) overlay.remove();
        if(submenu) submenu.remove();
    },
    
    handleRadialAction: (action) => {
        switch(action) {
            case 'draw':
                MoodBoard.openDrawingTool();
                break;
            case 'text':
                MoodBoard.showTextPanel();
                break;
            case 'palette':
                ColorWheel.open((colors, name) => MoodBoard.addPaletteToBoard(colors, name));
                break;
            case 'shapes':
                MoodBoard.showShapesMenu();
                break;
            case 'file':
                MoodBoard.uploadFile();
                break;
            case 'link':
                MoodBoard.addWebLink();
                break;
        }
    },
    
    showElementContextMenu: (x, y, elementId) => {
        MoodBoard.hideRadialMenu();
        MoodBoard.selectElement(elementId);
        
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        
        const overlay = document.createElement('div');
        overlay.className = 'moodboard-radial-overlay';
        overlay.onclick = () => MoodBoard.hideRadialMenu();
        document.body.appendChild(overlay);
        
        const menu = document.createElement('div');
        menu.className = 'moodboard-radial-menu';
        menu.id = 'moodboardRadialMenu';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        
        let items = [
            { icon: 'â¬†ï¸', label: 'Monter', action: () => MoodBoard.moveElementUp(elementId) },
            { icon: 'â¬‡ï¸', label: 'Descendre', action: () => MoodBoard.moveElementDown(elementId) },
            { icon: 'ðŸ”—', label: 'Lier Ã ...', action: () => MoodBoard.linkElement(elementId) },
            { icon: 'ðŸ“‹', label: 'Dupliquer', action: () => MoodBoard.duplicateElement(elementId) },
            { icon: 'âœï¸', label: 'Modifier', action: () => MoodBoard.editElement(elementId) },
            { icon: 'ðŸ—‘ï¸', label: 'Supprimer', action: () => MoodBoard.deleteElement(elementId) }
        ];
        
        // Ajouter option couleur pour les formes
        if(element && element.type === 'shape') {
            items.splice(4, 0, { icon: 'ðŸŽ¨', label: 'Couleur', action: () => MoodBoard.changeShapeColor(elementId) });
        }
        
        // Ajouter option renommer pour les palettes
        if(element && element.type === 'palette') {
            items.splice(4, 0, { icon: 'âœï¸', label: 'Renommer', action: () => MoodBoard.renamePalette(elementId) });
        }
        
        const radius = 85;
        
        const center = document.createElement('div');
        center.className = 'moodboard-radial-center';
        center.innerHTML = 'âœ•';
        center.onclick = () => MoodBoard.hideRadialMenu();
        menu.appendChild(center);
        
        items.forEach((item, i) => {
            const el = document.createElement('div');
            el.className = 'moodboard-radial-item';
            el.innerHTML = `${item.icon}<span class="radial-tooltip">${item.label}</span>`;
            
            const angle = (i * 60);  // 6 items = 60Â° entre chaque
            const angleRad = (angle - 90) * Math.PI / 180;
            const itemX = Math.cos(angleRad) * radius;
            const itemY = Math.sin(angleRad) * radius;
            
            el.style.left = itemX + 'px';
            el.style.top = itemY + 'px';
            el.style.transitionDelay = (i * 0.03) + 's';
            
            el.onclick = () => {
                MoodBoard.hideRadialMenu();
                item.action();
            };
            
            menu.appendChild(el);
        });
        
        document.body.appendChild(menu);
        requestAnimationFrame(() => menu.classList.add('active'));
    },
    
    // ===== OUTILS DU MENU RADIAL =====
    
    editDrawing: (element) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board || !element) return;
        
        // Charger l'image existante dans le DrawingEditor
        DrawingEditor.open(null, (dataUrl) => {
            if(dataUrl) {
                element.src = dataUrl;
                board.modifiedAt = Date.now();
                Store.save();
                MoodBoard.renderCanvas();
                Utils.toast('Dessin modifiÃ©', 'success');
            }
        });
        
        // Charger l'image existante dans le premier calque aprÃ¨s ouverture
        setTimeout(() => {
            if(element.src && DrawingEditor.layers.length > 0) {
                const img = new Image();
                img.onload = () => {
                    const ctx = DrawingEditor.layers[0].canvas.getContext('2d');
                    ctx.clearRect(0, 0, 800, 600);
                    ctx.drawImage(img, 0, 0, 800, 600);
                    DrawingEditor.redraw();
                };
                img.src = element.src;
            }
        }, 100);
    },
    
    openDrawingTool: () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        // Utiliser le DrawingEditor du Storyboard avec callback
        DrawingEditor.open(null, (dataUrl) => {
            if(dataUrl) {
                const element = {
                    id: 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    type: 'drawing',
                    x: MoodBoard.contextX,
                    y: MoodBoard.contextY,
                    width: 400,
                    height: 300,
                    src: dataUrl,
                    linkedTo: null,
                    createdAt: Date.now()
                };
                
                board.elements.push(element);
                board.modifiedAt = Date.now();
                Store.save();
                MoodBoard.renderCanvas();
                Utils.toast('Dessin ajoutÃ©', 'success');
            }
        });
    },
    
    showTextPanel: (existingElement = null) => {
        const isEdit = !!existingElement;
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const modal = document.createElement('div');
        modal.className = 'confirm-modal-overlay';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        const currentContent = isEdit ? existingElement.content || '' : '';
        const currentFont = isEdit ? existingElement.fontFamily || 'Inter, sans-serif' : 'Inter, sans-serif';
        const currentSize = isEdit ? existingElement.fontSize || 18 : 18;
        const currentColor = isEdit ? existingElement.textColor || '#333333' : '#333333';
        const currentBold = isEdit ? existingElement.fontBold || false : false;
        const currentItalic = isEdit ? existingElement.fontItalic || false : false;
        const currentUnderline = isEdit ? existingElement.fontUnderline || false : false;
        const currentAlign = isEdit ? existingElement.textAlign || 'left' : 'left';
        const currentBgColor = isEdit ? existingElement.bgColor || 'transparent' : 'transparent';
        
        modal.innerHTML = `
            <div class="confirm-modal-box" style="max-width: 550px;">
                <div class="confirm-modal-icon">ðŸ“</div>
                <div class="confirm-modal-title">${isEdit ? 'Modifier le texte' : 'Ajouter du texte'}</div>
                
                <!-- Ligne 1: Police et taille -->
                <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; align-items: center;">
                    <select id="mbTextFont" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); min-width: 130px;">
                        <option value="Inter, sans-serif" ${currentFont.includes('Inter') ? 'selected' : ''}>Inter</option>
                        <option value="Georgia, serif" ${currentFont.includes('Georgia') ? 'selected' : ''}>Georgia</option>
                        <option value="'Courier New', monospace" ${currentFont.includes('Courier') ? 'selected' : ''}>Courier New</option>
                        <option value="'Comic Sans MS', cursive" ${currentFont.includes('Comic') ? 'selected' : ''}>Comic Sans</option>
                        <option value="Impact, sans-serif" ${currentFont.includes('Impact') ? 'selected' : ''}>Impact</option>
                        <option value="'Times New Roman', serif" ${currentFont.includes('Times') ? 'selected' : ''}>Times New Roman</option>
                        <option value="Arial, sans-serif" ${currentFont.includes('Arial') ? 'selected' : ''}>Arial</option>
                        <option value="Verdana, sans-serif" ${currentFont.includes('Verdana') ? 'selected' : ''}>Verdana</option>
                        <option value="'Trebuchet MS', sans-serif" ${currentFont.includes('Trebuchet') ? 'selected' : ''}>Trebuchet</option>
                        <option value="'Lucida Console', monospace" ${currentFont.includes('Lucida') ? 'selected' : ''}>Lucida Console</option>
                    </select>
                    <select id="mbTextSize" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); width: 75px;">
                        <option value="10" ${currentSize == 10 ? 'selected' : ''}>10px</option>
                        <option value="12" ${currentSize == 12 ? 'selected' : ''}>12px</option>
                        <option value="14" ${currentSize == 14 ? 'selected' : ''}>14px</option>
                        <option value="16" ${currentSize == 16 ? 'selected' : ''}>16px</option>
                        <option value="18" ${currentSize == 18 ? 'selected' : ''}>18px</option>
                        <option value="24" ${currentSize == 24 ? 'selected' : ''}>24px</option>
                        <option value="32" ${currentSize == 32 ? 'selected' : ''}>32px</option>
                        <option value="48" ${currentSize == 48 ? 'selected' : ''}>48px</option>
                        <option value="64" ${currentSize == 64 ? 'selected' : ''}>64px</option>
                        <option value="72" ${currentSize == 72 ? 'selected' : ''}>72px</option>
                    </select>
                </div>
                
                <!-- Ligne 2: Style et alignement -->
                <div style="display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; align-items: center;">
                    <div class="n8-flex-7">
                        <button type="button" id="mbTextBold" class="mb-text-style-btn ${currentBold ? 'active' : ''}" title="Gras" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: ${currentBold ? 'var(--primary)' : 'transparent'}; color: ${currentBold ? 'white' : 'var(--text)'};">B</button>
                        <button type="button" id="mbTextItalic" class="mb-text-style-btn ${currentItalic ? 'active' : ''}" title="Italique" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; font-style: italic; background: ${currentItalic ? 'var(--primary)' : 'transparent'}; color: ${currentItalic ? 'white' : 'var(--text)'};">I</button>
                        <button type="button" id="mbTextUnderline" class="mb-text-style-btn ${currentUnderline ? 'active' : ''}" title="SoulignÃ©" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; text-decoration: underline; background: ${currentUnderline ? 'var(--primary)' : 'transparent'}; color: ${currentUnderline ? 'white' : 'var(--text)'};">U</button>
                    </div>
                    <div class="n8-flex-7">
                        <button type="button" id="mbTextAlignLeft" class="mb-text-align-btn ${currentAlign === 'left' ? 'active' : ''}" title="Aligner Ã  gauche" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; background: ${currentAlign === 'left' ? 'var(--primary)' : 'transparent'}; color: ${currentAlign === 'left' ? 'white' : 'var(--text)'};">â¬›</button>
                        <button type="button" id="mbTextAlignCenter" class="mb-text-align-btn ${currentAlign === 'center' ? 'active' : ''}" title="Centrer" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; background: ${currentAlign === 'center' ? 'var(--primary)' : 'transparent'}; color: ${currentAlign === 'center' ? 'white' : 'var(--text)'};">â¬›</button>
                        <button type="button" id="mbTextAlignRight" class="mb-text-align-btn ${currentAlign === 'right' ? 'active' : ''}" title="Aligner Ã  droite" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; background: ${currentAlign === 'right' ? 'var(--primary)' : 'transparent'}; color: ${currentAlign === 'right' ? 'white' : 'var(--text)'};">â¬›</button>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center; margin-left: auto;">
                        <label class="text-sec-sm">Texte:</label>
                        <input type="color" id="mbTextColor" value="${currentColor}" class="n8-misc-2">
                        <label class="text-sec-sm">Fond:</label>
                        <input type="color" id="mbTextBgColor" value="${currentBgColor === 'transparent' ? '#ffffff' : currentBgColor}" class="n8-misc-2">
                        <label style="font-size: 0.75rem; display: flex; align-items: center; gap: 3px;"><input type="checkbox" id="mbTextBgTransparent" ${currentBgColor === 'transparent' ? 'checked' : ''}> Transparent</label>
                    </div>
                </div>
                
                <!-- Zone de texte -->
                <div style="margin: 15px 0;">
                    <textarea id="mbTextContent" placeholder="Votre texte ici..." style="width: 100%; height: 130px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: ${currentBgColor === 'transparent' ? 'var(--bg)' : currentBgColor}; color: ${currentColor}; resize: vertical; font-family: ${currentFont}; font-size: ${currentSize}px; font-weight: ${currentBold ? 'bold' : 'normal'}; font-style: ${currentItalic ? 'italic' : 'normal'}; text-decoration: ${currentUnderline ? 'underline' : 'none'}; text-align: ${currentAlign};">${Utils.escape(currentContent)}</textarea>
                </div>
                
                <div class="confirm-modal-buttons">
                    <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                    <button class="confirm-modal-btn confirm" id="mbSaveTextBtn">${isEdit ? 'Enregistrer' : 'Ajouter'}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const textarea = document.getElementById('mbTextContent');
        const fontSelect = document.getElementById('mbTextFont');
        const sizeSelect = document.getElementById('mbTextSize');
        const colorInput = document.getElementById('mbTextColor');
        const bgColorInput = document.getElementById('mbTextBgColor');
        const bgTransparentCb = document.getElementById('mbTextBgTransparent');
        const boldBtn = document.getElementById('mbTextBold');
        const italicBtn = document.getElementById('mbTextItalic');
        const underlineBtn = document.getElementById('mbTextUnderline');
        const alignLeftBtn = document.getElementById('mbTextAlignLeft');
        const alignCenterBtn = document.getElementById('mbTextAlignCenter');
        const alignRightBtn = document.getElementById('mbTextAlignRight');
        
        let isBold = currentBold;
        let isItalic = currentItalic;
        let isUnderline = currentUnderline;
        let textAlign = currentAlign;
        
        // PrÃ©visualisation en direct
        const updatePreview = () => {
            textarea.style.fontFamily = fontSelect.value;
            textarea.style.fontSize = sizeSelect.value + 'px';
            textarea.style.color = colorInput.value;
            textarea.style.fontWeight = isBold ? 'bold' : 'normal';
            textarea.style.fontStyle = isItalic ? 'italic' : 'normal';
            textarea.style.textDecoration = isUnderline ? 'underline' : 'none';
            textarea.style.textAlign = textAlign;
            textarea.style.background = bgTransparentCb.checked ? 'var(--bg)' : bgColorInput.value;
        };
        
        const updateStyleBtn = (btn, active) => {
            btn.style.background = active ? 'var(--primary)' : 'transparent';
            btn.style.color = active ? 'white' : 'var(--text)';
        };
        
        const updateAlignBtns = () => {
            updateStyleBtn(alignLeftBtn, textAlign === 'left');
            updateStyleBtn(alignCenterBtn, textAlign === 'center');
            updateStyleBtn(alignRightBtn, textAlign === 'right');
        };
        
        fontSelect.onchange = updatePreview;
        sizeSelect.onchange = updatePreview;
        colorInput.oninput = updatePreview;
        bgColorInput.oninput = updatePreview;
        bgTransparentCb.onchange = updatePreview;
        
        boldBtn.onclick = () => { isBold = !isBold; updateStyleBtn(boldBtn, isBold); updatePreview(); };
        italicBtn.onclick = () => { isItalic = !isItalic; updateStyleBtn(italicBtn, isItalic); updatePreview(); };
        underlineBtn.onclick = () => { isUnderline = !isUnderline; updateStyleBtn(underlineBtn, isUnderline); updatePreview(); };
        
        alignLeftBtn.onclick = () => { textAlign = 'left'; updateAlignBtns(); updatePreview(); };
        alignCenterBtn.onclick = () => { textAlign = 'center'; updateAlignBtns(); updatePreview(); };
        alignRightBtn.onclick = () => { textAlign = 'right'; updateAlignBtns(); updatePreview(); };
        
        document.getElementById('mbSaveTextBtn').onclick = () => {
            const content = textarea.value.trim();
            if(!content) {
                Utils.toast('Entrez du texte', 'warning');
                return;
            }
            
            const textData = {
                content: content,
                fontFamily: fontSelect.value,
                fontSize: parseInt(sizeSelect.value),
                textColor: colorInput.value,
                fontBold: isBold,
                fontItalic: isItalic,
                fontUnderline: isUnderline,
                textAlign: textAlign,
                bgColor: bgTransparentCb.checked ? 'transparent' : bgColorInput.value
            };
            
            if(isEdit) {
                Object.assign(existingElement, textData);
            } else {
                const element = {
                    id: 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    type: 'text',
                    x: MoodBoard.contextX,
                    y: MoodBoard.contextY,
                    width: 280,
                    height: 160,
                    ...textData,
                    linkedTo: null,
                    createdAt: Date.now()
                };
                board.elements.push(element);
            }
            
            board.modifiedAt = Date.now();
            Store.save();
            modal.remove();
            MoodBoard.renderCanvas();
            Utils.toast(isEdit ? 'Texte modifiÃ©' : 'Texte ajoutÃ©', 'success');
        };
        
        textarea.focus();
    },
    
    palettePresets: [
        { name: 'ComplÃ©mentaire', desc: '2 couleurs opposÃ©es', colors: ['#E63946', '#1D3557', '#F1FAEE', '#A8DADC', '#457B9D'] },
        { name: 'Analogue', desc: 'Couleurs voisines', colors: ['#264653', '#2A9D8F', '#E9C46A', '#F4A261', '#E76F51'] },
        { name: 'Triadique', desc: '3 couleurs Ã©quidistantes', colors: ['#FF6B6B', '#4ECDC4', '#FFE66D', '#95E1D3', '#F38181'] },
        { name: 'Monochrome', desc: 'Nuances d\'une couleur', colors: ['#0B3954', '#087E8B', '#56A3A6', '#BFD7EA', '#FFFFFF'] },
        { name: 'Pastel', desc: 'Tons doux et clairs', colors: ['#FFB5A7', '#FCD5CE', '#F8EDEB', '#F9DCC4', '#FEC89A'] },
        { name: 'NÃ©on', desc: 'Couleurs vives', colors: ['#FF00FF', '#00FFFF', '#FFFF00', '#FF0080', '#00FF00'] },
        { name: 'Terre', desc: 'Tons naturels', colors: ['#5C4033', '#8B7355', '#C4A77D', '#E6D5AC', '#F5E6CC'] }
    ],
    
    showPaletteSubmenu: () => {
        const submenu = document.createElement('div');
        submenu.className = 'moodboard-palette-submenu';
        submenu.style.left = (MoodBoard.contextX * MoodBoard.zoom + MoodBoard.panX + 50) + 'px';
        submenu.style.top = (MoodBoard.contextY * MoodBoard.zoom + MoodBoard.panY) + 'px';
        submenu.style.maxHeight = '70vh';
        submenu.style.overflowY = 'auto';
        
        let html = '<h4>ðŸŽ¨ Choisir une palette</h4>';
        
        // Option Color Wheel EN PREMIER (comme Adobe Color)
        html += `
            <div class="moodboard-palette-option" onclick="MoodBoard.hideRadialMenu(); ColorWheel.open((colors, name) => MoodBoard.addPaletteToBoard(colors, name));" style="background: linear-gradient(135deg, rgba(255,100,100,0.1), rgba(100,100,255,0.1)); border: 2px solid var(--primary);">
                <div class="moodboard-palette-preview"><span style="background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); border-radius: 50%; width: 100%; height: 100%;"></span></div>
                <div>
                    <div class="palette-name">ðŸŽ¨ Roue chromatique</div>
                    <div class="palette-desc">CrÃ©er avec Adobe Color style</div>
                </div>
            </div>
        `;
        
        MoodBoard.palettePresets.forEach((palette, index) => {
            const colorsHtml = palette.colors.map(c => `<span style="background:${c}"></span>`).join('');
            
            html += `
                <div class="moodboard-palette-option" onclick="app.MoodBoard.addPaletteByIndex(${index})">
                    <div class="moodboard-palette-preview">${colorsHtml}</div>
                    <div>
                        <div class="palette-name">${palette.name}</div>
                        <div class="palette-desc">${palette.desc}</div>
                    </div>
                </div>
            `;
        });
        
        // Option personnalisÃ©e
        html += `
            <div class="moodboard-palette-option" onclick="app.MoodBoard.addCustomPalette()">
                <div class="moodboard-palette-preview"><span style="background:linear-gradient(45deg, red, blue, green)"></span></div>
                <div>
                    <div class="palette-name">PersonnalisÃ©e</div>
                    <div class="palette-desc">Entrer les codes hex</div>
                </div>
            </div>
        `;
        
        submenu.innerHTML = html;
        
        const wrapper = document.getElementById('moodboardCanvasWrapper');
        wrapper.appendChild(submenu);
    },
    
    addPaletteByIndex: (index) => {
        const palette = MoodBoard.palettePresets[index];
        if(palette) {
            MoodBoard.hideRadialMenu();
            MoodBoard.addPaletteToBoard(palette.colors, palette.name);
        }
    },
    
    addCustomPalette: async () => {
        MoodBoard.hideRadialMenu();
        const colorsStr = await ConfirmModal.prompt({
            title: 'Palette personnalisÃ©e',
            message: 'Entrez vos couleurs (codes hex sÃ©parÃ©s par des virgules) :',
            defaultValue: '#264653, #2A9D8F, #E9C46A, #F4A261, #E76F51',
            placeholder: '#FF0000, #00FF00, #0000FF...'
        });
        if(!colorsStr) return;
        const colors = colorsStr.split(',').map(c => c.trim()).filter(c => c);
        MoodBoard.addPaletteToBoard(colors, 'PersonnalisÃ©e');
    },
    
  shapes: [
        // Formes de base
        { id: 'rect', icon: 'â¬œ', name: 'Rectangle', svg: '<rect x="5" y="5" width="90" height="90" fill="currentColor"/>' },
        { id: 'rect-rounded', icon: 'â–¢', name: 'Rectangle arrondi', svg: '<rect x="5" y="5" width="90" height="90" fill="currentColor" rx="15"/>' },
        { id: 'circle', icon: 'â¬¤', name: 'Cercle', svg: '<circle cx="50" cy="50" r="45" fill="currentColor"/>' },
        { id: 'ellipse', icon: 'â¬­', name: 'Ellipse', svg: '<ellipse cx="50" cy="50" rx="45" ry="30" fill="currentColor"/>' },
        { id: 'triangle', icon: 'â–²', name: 'Triangle', svg: '<polygon points="50,5 95,95 5,95" fill="currentColor"/>' },
        { id: 'triangle-down', icon: 'â–¼', name: 'Triangle inversÃ©', svg: '<polygon points="5,5 95,5 50,95" fill="currentColor"/>' },
        { id: 'diamond', icon: 'â—†', name: 'Losange', svg: '<polygon points="50,5 95,50 50,95 5,50" fill="currentColor"/>' },
        { id: 'pentagon', icon: 'â¬ ', name: 'Pentagone', svg: '<polygon points="50,5 97,38 79,95 21,95 3,38" fill="currentColor"/>' },
        { id: 'hexagon', icon: 'â¬¡', name: 'Hexagone', svg: '<polygon points="50,5 93,25 93,75 50,95 7,75 7,25" fill="currentColor"/>' },
        { id: 'octagon', icon: 'â¯ƒ', name: 'Octogone', svg: '<polygon points="30,5 70,5 95,30 95,70 70,95 30,95 5,70 5,30" fill="currentColor"/>' },
        { id: 'star', icon: 'â˜…', name: 'Ã‰toile 5', svg: '<polygon points="50,5 61,35 95,35 68,57 79,91 50,70 21,91 32,57 5,35 39,35" fill="currentColor"/>' },
        { id: 'star4', icon: 'âœ¦', name: 'Ã‰toile 4', svg: '<polygon points="50,5 60,40 95,50 60,60 50,95 40,60 5,50 40,40" fill="currentColor"/>' },
        // FlÃ¨ches
        { id: 'arrow-right', icon: 'âž¡ï¸', name: 'FlÃ¨che droite', svg: '<polygon points="5,30 55,30 55,10 95,50 55,90 55,70 5,70" fill="currentColor"/>' },
        { id: 'arrow-left', icon: 'â¬…ï¸', name: 'FlÃ¨che gauche', svg: '<polygon points="95,30 45,30 45,10 5,50 45,90 45,70 95,70" fill="currentColor"/>' },
        { id: 'arrow-up', icon: 'â¬†ï¸', name: 'FlÃ¨che haut', svg: '<polygon points="30,95 30,45 10,45 50,5 90,45 70,45 70,95" fill="currentColor"/>' },
        { id: 'arrow-down', icon: 'â¬‡ï¸', name: 'FlÃ¨che bas', svg: '<polygon points="30,5 30,55 10,55 50,95 90,55 70,55 70,5" fill="currentColor"/>' },
        { id: 'arrow-double', icon: 'â†”ï¸', name: 'FlÃ¨che double', svg: '<polygon points="5,50 25,30 25,42 75,42 75,30 95,50 75,70 75,58 25,58 25,70" fill="currentColor"/>' },
        { id: 'chevron-right', icon: 'â€º', name: 'Chevron droite', svg: '<polygon points="25,5 75,50 25,95 35,95 85,50 35,5" fill="currentColor"/>' },
        { id: 'chevron-left', icon: 'â€¹', name: 'Chevron gauche', svg: '<polygon points="75,5 25,50 75,95 65,95 15,50 65,5" fill="currentColor"/>' },
        // Bulles et communication
        { id: 'bubble', icon: 'ðŸ’¬', name: 'Bulle parole', svg: '<path d="M5,5 L95,5 Q98,5 98,8 L98,65 Q98,68 95,68 L35,68 L20,90 L20,68 L5,68 Q2,68 2,65 L2,8 Q2,5 5,5 Z" fill="currentColor"/>' },
        { id: 'bubble-round', icon: 'ðŸ—¨ï¸', name: 'Bulle ronde', svg: '<ellipse cx="50" cy="40" rx="45" ry="35" fill="currentColor"/><polygon points="25,65 35,90 45,68" fill="currentColor"/>' },
        { id: 'bubble-thought', icon: 'ðŸ’­', name: 'Bulle pensÃ©e', svg: '<ellipse cx="50" cy="35" rx="40" ry="30" fill="currentColor"/><circle cx="25" cy="75" r="8" fill="currentColor"/><circle cx="15" cy="90" r="5" fill="currentColor"/>' },
        // Symboles
        { id: 'heart', icon: 'â¤ï¸', name: 'CÅ“ur', svg: '<path d="M50,90 C15,60 5,35 20,20 C35,5 50,15 50,30 C50,15 65,5 80,20 C95,35 85,60 50,90 Z" fill="currentColor"/>' },
        { id: 'cross', icon: 'âœš', name: 'Croix', svg: '<polygon points="35,5 65,5 65,35 95,35 95,65 65,65 65,95 35,95 35,65 5,65 5,35 35,35" fill="currentColor"/>' },
        { id: 'x-mark', icon: 'âœ•', name: 'X', svg: '<polygon points="20,5 50,35 80,5 95,20 65,50 95,80 80,95 50,65 20,95 5,80 35,50 5,20" fill="currentColor"/>' },
        { id: 'check', icon: 'âœ“', name: 'Check', svg: '<polygon points="10,50 20,40 40,60 80,20 90,30 40,85" fill="currentColor"/>' },
        { id: 'plus', icon: 'ï¼‹', name: 'Plus', svg: '<rect x="40" y="10" width="20" height="80" fill="currentColor"/><rect x="10" y="40" width="80" height="20" fill="currentColor"/>' },
        { id: 'minus', icon: 'âˆ’', name: 'Moins', svg: '<rect x="10" y="40" width="80" height="20" fill="currentColor" rx="3"/>' },
        // Lignes
        { id: 'line-h', icon: 'â”€', name: 'Ligne horizontale', svg: '<rect x="5" y="45" width="90" height="10" fill="currentColor"/>' },
        { id: 'line-v', icon: 'â”‚', name: 'Ligne verticale', svg: '<rect x="45" y="5" width="10" height="90" fill="currentColor"/>' },
        { id: 'line-diag', icon: 'â•±', name: 'Ligne diagonale', svg: '<polygon points="90,5 95,10 10,95 5,90" fill="currentColor"/>' },
        // Cadres
        { id: 'frame', icon: 'â˜', name: 'Cadre', svg: '<rect x="5" y="5" width="90" height="90" fill="none" stroke="currentColor" stroke-width="8"/>' },
        { id: 'frame-rounded', icon: 'âƒž', name: 'Cadre arrondi', svg: '<rect x="5" y="5" width="90" height="90" fill="none" stroke="currentColor" stroke-width="8" rx="15"/>' },
        { id: 'circle-frame', icon: 'â—‹', name: 'Cercle vide', svg: '<circle cx="50" cy="50" r="42" fill="none" stroke="currentColor" stroke-width="8"/>' }
    ],
    
    showShapesMenu: () => {
        MoodBoard.hideRadialMenu();
        
        const menu = document.createElement('div');
        menu.className = 'moodboard-shape-submenu';
        menu.id = 'moodboardShapeMenu';
        
        MoodBoard.shapes.forEach(shape => {
            const btn = document.createElement('div');
            btn.className = 'moodboard-shape-option';
            btn.innerHTML = shape.icon;
            btn.title = shape.name;
            btn.onclick = () => {
                MoodBoard.addShape(shape.id);
                menu.remove();
            };
            menu.appendChild(btn);
        });
        
        document.body.appendChild(menu);
        
        // Positionner prÃ¨s du clic mais toujours visible
        const wrapper = document.getElementById('moodboardCanvasWrapper');
        const rect = wrapper.getBoundingClientRect();
        let posX = MoodBoard.contextX * MoodBoard.zoom + MoodBoard.panX + rect.left;
        let posY = MoodBoard.contextY * MoodBoard.zoom + MoodBoard.panY + rect.top;
        
        // Ajuster si le menu dÃ©passe Ã  droite
        const menuRect = menu.getBoundingClientRect();
        if(posX + menuRect.width > window.innerWidth - 20) {
            posX = window.innerWidth - menuRect.width - 20;
        }
        // Ajuster si le menu dÃ©passe en bas
        if(posY + menuRect.height > window.innerHeight - 20) {
            posY = window.innerHeight - menuRect.height - 20;
        }
        // Ajuster si le menu dÃ©passe en haut ou Ã  gauche
        if(posX < 20) posX = 20;
        if(posY < 20) posY = 20;
        
        menu.style.left = posX + 'px';
        menu.style.top = posY + 'px';
        
        // Fermer si clic ailleurs
        setTimeout(() => {
            const closeHandler = (e) => {
                if(!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            document.addEventListener('click', closeHandler);
        }, 100);
    },
    
    renamePalette: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.hideRadialMenu();
        
        const newName = await ConfirmModal.prompt('Nom de la palette :', 'Renommer la palette', 'Nom...', element.paletteName || 'Sans nom');
        if(newName !== null && newName.trim()) {
            element.paletteName = newName.trim();
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Palette renommÃ©e', 'success');
        }
    },
    
    changeShapeColor: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.hideRadialMenu();
        
        const modal = document.createElement('div');
        modal.className = 'confirm-modal-overlay';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="confirm-modal-box" style="max-width: 350px;">
                <div class="confirm-modal-icon">ðŸŽ¨</div>
                <div class="confirm-modal-title">Couleur de la forme</div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0;">
                    ${['#000000', '#FFFFFF', '#FF0000', '#FF6B00', '#FFD700', '#00C853', '#2196F3', '#9C27B0', '#E91E63', '#795548', '#607D8B', '#00BCD4'].map(c => 
                        `<div onclick="document.getElementById('shapeColorInput').value='${c}'; document.getElementById('shapeColorPreview').style.background='${c}';" 
                             style="width: 40px; height: 40px; background: ${c}; border-radius: 8px; cursor: pointer; border: 2px solid ${c === '#FFFFFF' ? '#ddd' : 'transparent'}; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>`
                    ).join('')}
                </div>
                <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                    <div id="shapeColorPreview" style="width: 50px; height: 50px; background: ${element.color || '#000000'}; border-radius: 8px; border: 1px solid #ddd;"></div>
                    <input type="color" id="shapeColorInput" value="${element.color || '#000000'}" 
                           onchange="document.getElementById('shapeColorPreview').style.background=this.value"
                           style="flex: 1; height: 50px; cursor: pointer; border: none; border-radius: 8px;">
                </div>
                <div class="confirm-modal-buttons">
                    <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                    <button class="confirm-modal-btn confirm" id="applyShapeColorBtn">Appliquer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('applyShapeColorBtn').onclick = () => {
            element.color = document.getElementById('shapeColorInput').value;
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            modal.remove();
            Utils.toast('Couleur modifiÃ©e', 'success');
        };
    },
    
    addShape: (shapeId) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const shape = MoodBoard.shapes.find(s => s.id === shapeId);
        if(!shape) return;
        
        const element = {
            id: 'el_' + Date.now(),
            type: 'shape',
            shapeId: shapeId,
            x: MoodBoard.contextX,
            y: MoodBoard.contextY,
            width: 150,
            height: 150,
            color: '#000000',
            rotation: 0,
            linkedTo: null,
            createdAt: Date.now()
        };
        
        board.elements.push(element);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        Utils.toast('Forme ajoutÃ©e', 'success');
    },
    
    addPaletteToBoard: (colors, name) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const element = {
            id: 'el_' + Date.now(),
            type: 'palette',
            x: MoodBoard.contextX,
            y: MoodBoard.contextY,
            width: 500,
            height: 200,
            colors: colors,
            paletteName: name,
            linkedTo: null,
            createdAt: Date.now()
        };
        
        board.elements.push(element);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        Utils.toast('Palette "' + name + '" ajoutÃ©e', 'success');
    },
    
    uploadImage: () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('SÃ©lectionnez d\'abord une planche', 'warning');
            return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,.png,.jpg,.jpeg,.gif,.webp,.svg,.bmp';
        input.multiple = true;
        input.onchange = (e) => {
            Array.from(e.target.files).forEach((file, i) => {
                MoodBoard.addImageFromFile(file, MoodBoard.contextX + i * 30, MoodBoard.contextY + i * 30);
            });
        };
        input.click();
    },
    
    uploadFile: () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('SÃ©lectionnez d\'abord une planche', 'warning');
            return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf,.doc,.docx,.txt,.rtf,.xls,.xlsx,.ppt,.pptx,image/*';
        input.multiple = true;
        input.onchange = async (e) => {
            Array.from(e.target.files).forEach((file, i) => {
                const offsetX = MoodBoard.contextX + i * 30;
                const offsetY = MoodBoard.contextY + i * 30;
                
                if(file.type.startsWith('image/')) {
                    MoodBoard.addImageFromFile(file, offsetX, offsetY);
                    return;
                }
                
                // Pour les documents, crÃ©er un Ã©lÃ©ment fichier
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const currentBoard = MoodBoard.getCurrentBoard();
                    if(!currentBoard) return;
                    
                    const element = {
                        id: 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                        type: 'file',
                        x: offsetX,
                        y: offsetY,
                        width: 180,
                        height: 140,
                        fileName: file.name,
                        fileType: file.type || MoodBoard.getFileType(file.name),
                        fileSize: file.size,
                        fileData: ev.target.result,
                        linkedTo: null,
                        createdAt: Date.now()
                    };
                    
                    currentBoard.elements.push(element);
                    currentBoard.modifiedAt = Date.now();
                    Store.save();
                    
                    MoodBoard.renderCanvas();
                    Utils.toast('Fichier ajoutÃ©: ' + file.name, 'success');
                };
                reader.readAsDataURL(file);
            });
        };
        input.click();
    },
    
    getFileType: (fileName) => {
        const ext = fileName.split('.').pop().toLowerCase();
        const types = {
            'pdf': 'application/pdf',
            'doc': 'application/msword',
            'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'xls': 'application/vnd.ms-excel',
            'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'ppt': 'application/vnd.ms-powerpoint',
            'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
            'txt': 'text/plain',
            'rtf': 'application/rtf'
        };
        return types[ext] || 'application/octet-stream';
    },
    
    openFile: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element || !element.fileData) return;
        
        // Ouvrir le fichier dans un nouvel onglet
        const win = window.open();
        if(element.fileType.includes('pdf')) {
            win.document.write(`<iframe src="${element.fileData}" style="width:100%;height:100%;border:none;"></iframe>`);
        } else {
            win.document.write(`<html><head><title>${element.fileName}</title></head><body>
                <p>Fichier: <strong>${element.fileName}</strong></p>
                <p><a href="${element.fileData}" download="${element.fileName}">ðŸ“¥ TÃ©lÃ©charger</a></p>
            </body></html>`);
        }
    },
    
    addWebLink: async () => {
        const url = await ConfirmModal.prompt({
            title: 'Ajouter un lien web',
            message: 'URL du lien (page web, image, vidÃ©o...) :',
            placeholder: 'https://...'
        });
        
        if(!url) return;
        
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const element = {
            id: 'el_' + Date.now(),
            type: 'link',
            x: MoodBoard.contextX,
            y: MoodBoard.contextY,
            width: 200,
            height: 120,
            url: url,
            title: new URL(url).hostname || 'Lien',
            linkedTo: null,
            createdAt: Date.now()
        };
        
        board.elements.push(element);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        Utils.toast('Lien ajoutÃ©', 'success');
    },
    
    // ===== EXPORT =====
    
    // Convertir un SVG en image pour l'export
    svgToImage: (svgContent, color, width, height) => {
        return new Promise((resolve) => {
            const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="${width}" height="${height}">${svgContent.replace(/currentColor/g, color)}</svg>`;
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => resolve(null);
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
        });
    },
    
    exportPNG: async () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('Aucune planche sÃ©lectionnÃ©e', 'warning');
            return;
        }
        
        Utils.toast('GÃ©nÃ©ration du PNG en cours...', 'info');
        
        const canvasW = board.canvasWidth || 1200;
        const canvasH = board.canvasHeight || 800;
        const scale = 2;
        
        const canvas = document.createElement('canvas');
        canvas.width = canvasW * scale;
        canvas.height = canvasH * scale;
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.scale(scale, scale);
        
        const elements = board.elements || [];
        
        // PrÃ©parer les images (images, dessins ET formes SVG)
        const imagesToLoad = [];
        elements.forEach(el => {
            if((el.type === 'image' || el.type === 'drawing') && el.src) {
                imagesToLoad.push({ el, type: 'image' });
            } else if(el.type === 'shape') {
                imagesToLoad.push({ el, type: 'shape' });
            }
        });
        
        // Charger toutes les images et convertir les SVG
        for(const item of imagesToLoad) {
            if(item.type === 'image') {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise(resolve => {
                    img.onload = () => { item.el.imgLoaded = img; resolve(); };
                    img.onerror = () => resolve();
                    img.src = item.el.src;
                });
            } else if(item.type === 'shape') {
                const shape = MoodBoard.shapes.find(s => s.id === item.el.shapeId);
                if(shape) {
                    const w = item.el.width || 100;
                    const h = item.el.height || 100;
                    item.el.shapeImg = await MoodBoard.svgToImage(shape.svg, item.el.color || '#000000', w * scale, h * scale);
                }
            }
        }
        
        // Dessiner tous les Ã©lÃ©ments
        elements.forEach(el => {
            const x = el.x || 0;
            const y = el.y || 0;
            const w = el.width || 100;
            const h = el.height || 100;
            
            ctx.save();
            
            if(el.rotation) {
                ctx.translate(x + w/2, y + h/2);
                ctx.rotate(el.rotation * Math.PI / 180);
                ctx.translate(-(x + w/2), -(y + h/2));
            }
            
            if(el.type === 'image' || el.type === 'drawing') {
                if(el.imgLoaded) ctx.drawImage(el.imgLoaded, x, y, w, h);
            } else if(el.type === 'text') {
                ctx.fillStyle = el.textColor || el.color || '#333333';
                ctx.font = `${el.bold ? 'bold ' : ''}${el.fontSize || 14}px ${el.fontFamily || 'Arial'}`;
                ctx.textAlign = el.textAlign || el.align || 'left';
                const lines = (el.content || '').split('\n');
                lines.forEach((line, i) => {
                    ctx.fillText(line, x + 5, y + 20 + (i * (el.fontSize || 14) * 1.2));
                });
            } else if(el.type === 'palette') {
                const colors = el.colors || [];
                const colorW = w / Math.max(colors.length, 1);
                colors.forEach((color, i) => {
                    ctx.fillStyle = color;
                    ctx.fillRect(x + (i * colorW), y, colorW, h * 0.7);
                    ctx.fillStyle = '#333';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(color, x + (i * colorW) + colorW/2, y + h * 0.9);
                });
                if(el.paletteName) {
                    ctx.fillStyle = '#666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(el.paletteName, x, y - 5);
                }
            } else if(el.type === 'shape') {
                if(el.shapeImg) {
                    ctx.drawImage(el.shapeImg, x, y, w, h);
                } else {
                    ctx.fillStyle = el.color || '#000000';
                    ctx.fillRect(x, y, w, h);
                }
            } else if(el.type === 'link') {
                ctx.fillStyle = '#f0f0f0';
                ctx.strokeStyle = '#ccc';
                ctx.fillRect(x, y, w, h);
                ctx.strokeRect(x, y, w, h);
                ctx.fillStyle = '#2b6ef6';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('ðŸ”— ' + (el.url || 'Lien').substring(0, 30), x + 5, y + h/2 + 4);
            }
            
            ctx.restore();
        });
        
        // Nom de fichier explicite
        const projectTitle = state.data?.title || 'Projet';
        const boardName = board.name || 'MoodBoard';
        const filename = `${projectTitle}_MoodBoard_${boardName}`.replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§_-]/gi, '_') + '.png';
        
        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        Utils.toast('PNG exportÃ© !', 'success');
        History.log('EXPORT', `MoodBoard "${board.name}" exportÃ© en PNG`);
    },
    
    exportPDF: async () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('Aucune planche sÃ©lectionnÃ©e', 'warning');
            return;
        }
        
        Utils.toast('GÃ©nÃ©ration du PDF en cours...', 'info');
        
        const { jsPDF } = window.jspdf;
        const format = board.format || 'a4-landscape';
        
        // DÃ©finir orientation et format
        let orientation = 'landscape';
        let pageFormat = 'a4';
        if(format.includes('portrait')) orientation = 'portrait';
        if(format.includes('a3')) pageFormat = 'a3';
        else if(format.includes('a2')) pageFormat = 'a2';
        else if(format.includes('a0')) pageFormat = 'a0';
        
        const doc = new jsPDF({ orientation, format: pageFormat, unit: 'mm' });
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // En-tÃªte
        doc.setFillColor(43, 110, 246);
        doc.rect(0, 0, pageWidth, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(board.name || 'MoodBoard', 10, 10);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        const projectTitle = state.data?.title || 'Projet';
        doc.text(projectTitle, pageWidth - 10, 10, { align: 'right' });
        
        // Liaison si elle existe
        if(board.linkedTo) {
            doc.setTextColor(200, 200, 200);
            doc.setFontSize(8);
            let linkText = '';
            if(board.linkedTo.type === 'scene') {
                const scene = state.data.scenes.find(s => s.id === board.linkedTo.id);
                linkText = scene ? `LiÃ© Ã  : ${scene.title}` : '';
            } else if(board.linkedTo.type === 'character') {
                const char = state.data.characters.find(c => c.id === board.linkedTo.id);
                linkText = char ? `LiÃ© Ã  : ${char.name}` : '';
            }
            if(linkText) doc.text(linkText, pageWidth / 2, 10, { align: 'center' });
        }
        
        // Zone de travail
        const margin = 10;
        const workY = 20;
        const workWidth = pageWidth - (margin * 2);
        const workHeight = pageHeight - workY - margin;
        
        // Calculer le scale pour adapter les Ã©lÃ©ments au PDF
        const canvasW = board.canvasWidth || 1200;
        const canvasH = board.canvasHeight || 800;
        const scaleX = workWidth / canvasW;
        const scaleY = workHeight / canvasH;
        const scale = Math.min(scaleX, scaleY);
        
        // Fond blanc pour la zone de travail
        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(200, 200, 200);
        doc.rect(margin, workY, workWidth, workHeight, 'FD');
        
        // Dessiner les Ã©lÃ©ments
        const elements = board.elements || [];
        
        // PrÃ©-convertir les formes SVG en images pour le PDF
        const shapeImages = {};
        for(const el of elements) {
            if(el.type === 'shape') {
                const shape = MoodBoard.shapes.find(s => s.id === el.shapeId);
                if(shape) {
                    const imgW = 200;
                    const imgH = 200;
                    const svgImg = await MoodBoard.svgToImage(shape.svg, el.color || '#000000', imgW, imgH);
                    if(svgImg) {
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = imgW;
                        tempCanvas.height = imgH;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(svgImg, 0, 0, imgW, imgH);
                        shapeImages[el.id] = tempCanvas.toDataURL('image/png');
                    }
                }
            }
        }
        
        for(const el of elements) {
            const x = margin + (el.x * scale);
            const y = workY + (el.y * scale);
            const w = (el.width || 100) * scale;
            const h = (el.height || 100) * scale;
            
            try {
                if(el.type === 'image' || el.type === 'drawing') {
                    if(el.src && el.src.startsWith('data:image')) {
                        doc.addImage(el.src, 'PNG', x, y, w, h);
                    }
                } else if(el.type === 'text') {
                    doc.setTextColor(el.textColor || el.color || '#333333');
                    doc.setFontSize(Math.max(8, (el.fontSize || 14) * scale * 0.5));
                    doc.setFont('helvetica', el.bold ? 'bold' : 'normal');
                    const textLines = doc.splitTextToSize(el.content || '', w);
                    doc.text(textLines, x + 2, y + 5);
                } else if(el.type === 'palette') {
                    const colors = el.colors || [];
                    const colorW = w / Math.max(colors.length, 1);
                    colors.forEach((color, i) => {
                        const hex = color.replace('#', '');
                        const r = parseInt(hex.substr(0, 2), 16);
                        const g = parseInt(hex.substr(2, 2), 16);
                        const b = parseInt(hex.substr(4, 2), 16);
                        doc.setFillColor(r, g, b);
                        doc.rect(x + (i * colorW), y, colorW, h * 0.7, 'F');
                        doc.setTextColor(50, 50, 50);
                        doc.setFontSize(6);
                        doc.text(color, x + (i * colorW) + colorW/2, y + h * 0.85, { align: 'center' });
                    });
                    if(el.paletteName) {
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(el.paletteName, x, y - 2);
                    }
                } else if(el.type === 'shape') {
                    if(shapeImages[el.id]) {
                        doc.addImage(shapeImages[el.id], 'PNG', x, y, w, h);
                    } else {
                        const hex = (el.color || '#000000').replace('#', '');
                        const r = parseInt(hex.substr(0, 2), 16);
                        const g = parseInt(hex.substr(2, 2), 16);
                        const b = parseInt(hex.substr(4, 2), 16);
                        doc.setFillColor(r, g, b);
                        doc.rect(x, y, w, h, 'F');
                    }
                } else if(el.type === 'link') {
                    doc.setFillColor(240, 240, 240);
                    doc.setDrawColor(180, 180, 180);
                    doc.roundedRect(x, y, w, h, 3, 3, 'FD');
                    doc.setTextColor(43, 110, 246);
                    doc.setFontSize(8);
                    const urlText = el.url ? (el.url.length > 40 ? el.url.substring(0, 40) + '...' : el.url) : 'Lien';
                    doc.text('ðŸ”— ' + urlText, x + 3, y + h/2 + 2);
                }
            } catch(err) {
                console.warn('Erreur export Ã©lÃ©ment:', el.type, err);
            }
        }
        
        // Pied de page
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(7);
        doc.text(`GÃ©nÃ©rÃ© par Moteur - ${new Date().toLocaleDateString('fr-FR')}`, margin, pageHeight - 3);
        doc.text(`${elements.length} Ã©lÃ©ment(s)`, pageWidth - margin, pageHeight - 3, { align: 'right' });
        
        // Nom de fichier explicite
        const boardName = board.name || 'MoodBoard';
        const filename = `${projectTitle}_MoodBoard_${boardName}`.replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§_-]/gi, '_') + '.pdf';
        doc.save(filename);
        
        Utils.toast('PDF exportÃ© !', 'success');
        History.log('EXPORT', `MoodBoard "${board.name}" exportÃ© en PDF`);
    }
};

const Storyboard = {
    currentSceneId: null,
    
    init: () => {
        Storyboard.renderScenesList();
        document.getElementById('sbNoScene').style.display = 'flex';
        document.getElementById('sbShotsContainer').style.display = 'none';
    },
    
    renderScenesList: () => {
        const container = document.getElementById('sbScenesList');
        container.innerHTML = '';
        
        if(state.data.scenes.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸŽ¬</div>
                    <div class="empty-state-title">Aucune scÃ¨ne</div>
                    <div class="empty-state-desc">CrÃ©ez votre premiÃ¨re scÃ¨ne pour commencer Ã  construire votre sÃ©quencier. Chaque scÃ¨ne peut avoir un titre, un rÃ©sumÃ© et des personnages.</div>
                    <button class="empty-state-btn" onclick="app.Actions.addScene()">+ Ajouter une scÃ¨ne</button>
                    <div class="empty-state-tips">ðŸ’¡ <strong>Astuce :</strong> Importez un scÃ©nario existant pour gÃ©nÃ©rer automatiquement les scÃ¨nes.</div>
                </div>
            `;
            return;
        }
        
        state.data.scenes.forEach((scene, idx) => {
            const shotCount = state.data.shots.filter(s => s.sceneId === scene.id).length;
            const sceneStatus = scene.status || 'not-verified';
            const div = document.createElement('div');
            div.className = 'sb-scene-item' + (Storyboard.currentSceneId === scene.id ? ' active' : '');
            div.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div class="sb-scene-title">#${idx + 1} ${Utils.escape(scene.title)}</div>
                    <div class="scene-status-container"><span class="scene-status-badge ${sceneStatus}" onclick="event.stopPropagation(); app.UI.toggleSceneStatus('${scene.id}', event)">${SCENE_STATUS_LABELS[sceneStatus]}</span></div>
                </div>
                <div class="sb-scene-meta">${shotCount} plan(s)</div>
            `;
            div.onclick = () => Storyboard.selectScene(scene.id);
            container.appendChild(div);
        });
    },
    
    selectScene: (sceneId) => {
        Storyboard.currentSceneId = sceneId;
        Storyboard.renderScenesList();
        document.getElementById('sbNoScene').style.display = 'none';
        document.getElementById('sbShotsContainer').style.display = 'block';
        Storyboard.renderShots();
    },
    
    renderShots: () => {
        const container = document.getElementById('sbShotsList');
        container.innerHTML = '';
        
        if(!state.data.shots) state.data.shots = [];
        
        const shots = state.data.shots
            .filter(s => s.sceneId === Storyboard.currentSceneId)
            .sort((a, b) => a.order - b.order);
        
        if(shots.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucun plan crÃ©Ã©</div>';
            return;
        }
        
        // Create compact grid
        const grid = document.createElement('div');
        grid.className = 'shots-compact-grid';
        
        shots.forEach((shot, idx) => {
            const card = Storyboard.createCompactCard(shot, idx);
            grid.appendChild(card);
        });
        
        container.appendChild(grid);
        
        // Setup drag and drop
        if(state.currentRole !== 'viewer') {
            Storyboard.setupDragDrop(grid);
        }
    },
    
    createCompactCard: (shot, idx) => {
        const sceneIndex = state.data.scenes.findIndex(s => s.id === Storyboard.currentSceneId) + 1;
        const card = document.createElement('div');
        card.className = 'shot-compact-card';
        card.draggable = state.currentRole !== 'viewer';
        card.dataset.shotId = shot.id;
        
        let imageHTML = '';
        if(shot.imageType === 'upload' && shot.imageUrl) {
            imageHTML = `<img src="${shot.imageUrl}" alt="Plan ${sceneIndex}.${idx + 1}">`;
        } else if(shot.imageType === 'drawing' && shot.drawingData) {
            imageHTML = `<canvas id="compact-preview-${shot.id}" width="800" height="600" style="max-width: 100%; max-height: 100%; object-fit: contain;"></canvas>`;
        } else {
            imageHTML = `<div style="color: #999; font-size: 2rem;">ðŸŽ¨</div>`;
        }
        
        const dirtyIndicator = shot.isDirty ? '<div class="shot-dirty-indicator">â—</div>' : '';
        
        // Construire les infos techniques (acronymes)
        const techParts = [];
        if(shot.shotType) techParts.push(Storyboard.extractAcronym(shot.shotType));
        if(shot.cameraMove) techParts.push(Storyboard.extractAcronym(shot.cameraMove));
        if(shot.cameraMode) techParts.push(Storyboard.extractAcronym(shot.cameraMode));
        const techInfo = techParts.length > 0 ? `<div class="shot-compact-tech">${techParts.join(' â€¢ ')}</div>` : '';
        const nameInfo = shot.name ? `<div class="shot-compact-name">${Utils.escape(shot.name)}</div>` : '';
        
        card.innerHTML = `
            ${dirtyIndicator}
            <div class="shot-compact-image" onclick="app.Storyboard.openEditModal('${shot.id}')">
                ${imageHTML}
            </div>
            <div class="shot-compact-footer">
                <span>Plan ${sceneIndex}.${idx + 1}</span>
                ${state.currentRole !== 'viewer' ? `<button class="shot-compact-delete" onclick="app.Storyboard.deleteShot('${shot.id}', event)">ðŸ—‘ï¸</button>` : ''}
            </div>
            ${nameInfo}
            ${techInfo}
        `;
        
        // Render drawing preview
        setTimeout(() => {
            if(shot.imageType === 'drawing' && shot.drawingData) {
                const canvas = document.getElementById(`compact-preview-${shot.id}`);
                if(canvas) {
                    const ctx = canvas.getContext('2d');
                    DrawingEditor.renderDrawingData(ctx, shot.drawingData);
                }
            }
        }, 100);
        
        return card;
    },
    
    setupDragDrop: (container) => {
        const cards = container.querySelectorAll('.shot-compact-card');
        
        cards.forEach(card => {
            card.addEventListener('dragstart', () => {
                card.classList.add('dragging');
            });
            
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                Storyboard.updateShotOrder();
            });
        });
        
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = Storyboard.getDragAfterElement(container, e.clientX, e.clientY);
            const dragging = document.querySelector('.shot-compact-card.dragging');
            
            if(afterElement == null) {
                container.appendChild(dragging);
            } else {
                container.insertBefore(dragging, afterElement);
            }
        });
    },
    
    getDragAfterElement: (container, x, y) => {
        const draggableElements = [...container.querySelectorAll('.shot-compact-card:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offsetX = x - box.left - box.width / 2;
            const offsetY = y - box.top - box.height / 2;
            const offset = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
            
            if(offset < closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.POSITIVE_INFINITY }).element;
    },
    
    updateShotOrder: () => {
        const cards = document.querySelectorAll('.shot-compact-card');
        const newOrder = [];
        
        cards.forEach((card, idx) => {
            const shotId = card.dataset.shotId;
            const shot = state.data.shots.find(s => s.id === shotId);
            if(shot) {
                shot.order = idx;
                newOrder.push(shot);
            }
        });
        
        Store.save();
    },
    
    createShotCard: (shot, idx) => {
        const card = document.createElement('div');
        card.className = 'shot-card';
        card.dataset.shotId = shot.id;
        
        let imagePreview = '';
        if(shot.imageType === 'upload' && shot.imageUrl) {
            imagePreview = `<img src="${shot.imageUrl}" alt="Plan ${idx + 1}">`;
        } else if(shot.imageType === 'drawing' && shot.drawingData) {
            imagePreview = `<canvas id="preview-${shot.id}" width="800" height="600"></canvas>`;
        } else {
            imagePreview = `<div class="shot-upload-zone">
                <div style="font-size: 3rem; margin-bottom: 10px;">ðŸŽ¨</div>
                <div>Cliquez pour ajouter une image</div>
            </div>`;
        }
        
        const isView = state.currentRole === 'viewer';
        
        card.innerHTML = `
            <div class="shot-header">
                <h3 class="m-0">Plan ${idx + 1}</h3>
                ${!isView ? `<button onclick="app.Storyboard.deleteShot('${shot.id}')" style="background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ðŸ—‘ï¸ Supprimer</button>` : ''}
            </div>
            
            <div class="shot-preview" onclick="${!isView ? `app.Storyboard.openImageMenu('${shot.id}')` : ''}">
                ${imagePreview}
            </div>
            
            <div class="shot-meta-grid">
                <input type="text" class="shot-input" placeholder="Nom du plan" value="${shot.name || ''}" 
                    onchange="app.Storyboard.updateShot('${shot.id}', 'name', this.value)" ${isView ? 'disabled' : ''}>
                
                <select class="shot-input" onchange="app.Storyboard.updateShot('${shot.id}', 'shotType', this.value)" ${isView ? 'disabled' : ''}>
                    <option value="">Type de plan...</option>
                    ${CONFIG.shotTypes.map(t => `<option value="${t}" ${shot.shotType === t ? 'selected' : ''}>${t}</option>`).join('')}
                </select>
                
                <select class="shot-input" onchange="app.Storyboard.updateShot('${shot.id}', 'cameraMove', this.value)" ${isView ? 'disabled' : ''}>
                    <option value="">Mouvement...</option>
                    ${CONFIG.cameraMoves.map(m => `<option value="${m}" ${shot.cameraMove === m ? 'selected' : ''}>${m}</option>`).join('')}
                </select>
                
                <select class="shot-input" onchange="app.Storyboard.updateShot('${shot.id}', 'cameraMode', this.value)" ${isView ? 'disabled' : ''}>
                    <option value="">Mode camÃ©ra...</option>
                    ${CONFIG.cameraModes.map(m => `<option value="${m}" ${shot.cameraMode === m ? 'selected' : ''}>${m}</option>`).join('')}
                </select>
            </div>
            
            <textarea class="shot-textarea" placeholder="Description du plan..." 
                onchange="app.Storyboard.updateShot('${shot.id}', 'description', this.value)" ${isView ? 'disabled' : ''}>${shot.description || ''}</textarea>
            
            <textarea class="shot-textarea" placeholder="Direction des acteurs..." 
                onchange="app.Storyboard.updateShot('${shot.id}', 'actorDirection', this.value)" ${isView ? 'disabled' : ''}>${shot.actorDirection || ''}</textarea>
            
            <textarea class="shot-textarea" placeholder="Direction technique..." 
                onchange="app.Storyboard.updateShot('${shot.id}', 'technicalDirection', this.value)" ${isView ? 'disabled' : ''}>${shot.technicalDirection || ''}</textarea>
            
            ${shot.versions && shot.versions.length > 0 ? `
                <div style="margin-top: 15px; padding: 10px; background: var(--bg); border-radius: 6px;">
                    <strong>Versions sauvegardÃ©es (${shot.versions.length})</strong>
                    <select class="shot-input mt-5" onchange="app.Storyboard.restoreVersion('${shot.id}', this.value)">
                        <option value="">Restaurer une version...</option>
                        ${shot.versions.map((v, i) => `<option value="${i}">Version ${i + 1} - ${new Date(v.timestamp).toLocaleString()}</option>`).join('')}
                    </select>
                </div>
            ` : ''}
        `;
        
        // Render drawing preview if exists
        setTimeout(() => {
            if(shot.imageType === 'drawing' && shot.drawingData) {
                const canvas = document.getElementById(`preview-${shot.id}`);
                if(canvas) {
                    const ctx = canvas.getContext('2d');
                    DrawingEditor.renderDrawingData(ctx, shot.drawingData);
                }
            }
        }, 100);
        
        return card;
    },
    
    addShot: () => {
        if(state.currentRole === 'viewer') return;
        if(state.currentRole !== 'owner' && !Permissions.canEdit('storyboard')) {
            Utils.toast('Vous n\'avez pas la permission de modifier le storyboard.', 'error');
            return;
        }
        if(!Storyboard.currentSceneId) return;
        
        const existingShots = state.data.shots.filter(s => s.sceneId === Storyboard.currentSceneId);
        const maxOrder = existingShots.length > 0 ? Math.max(...existingShots.map(s => s.order)) : -1;
        
        const newShot = {
            id: Utils.generateUniqueId(),
            sceneId: Storyboard.currentSceneId,
            order: maxOrder + 1,
            name: '',
            imageType: null,
            imageUrl: null,
            drawingData: null,
            shotType: '',
            cameraMove: '',
            cameraMode: '',
            description: '',
            actorDirection: '',
            technicalDirection: '',
            versions: [],
            isDirty: false,
            lastModified: Date.now()
        };
        
        state.data.shots.push(newShot);
        const scene = state.data.scenes.find(s => s.id === Storyboard.currentSceneId);
        History.log('ADD', `Ajout plan storyboard : ${scene?.title || 'ScÃ¨ne inconnue'}`);
        Store.save();
        Storyboard.renderShots();
        Storyboard.renderScenesList();
    },
    
    deleteShot: async (shotId, event) => {
        if(event) event.stopPropagation();
        if(state.currentRole === 'viewer' || !Permissions.canEdit('storyboard')) return;
        if(!await ConfirmModal.confirmDelete("Ce plan sera dÃ©finitivement supprimÃ©.")) return;
        
        const shot = state.data.shots.find(s => s.id === shotId);
        const scene = state.data.scenes.find(s => s.id === shot?.sceneId);
        state.data.shots = state.data.shots.filter(s => s.id !== shotId);
        History.log('DELETE', `Suppression plan storyboard : ${scene?.title || 'ScÃ¨ne inconnue'}`);
        Store.save();
        Storyboard.renderShots();
        Storyboard.renderScenesList();
    },
    
    updateShot: (shotId, field, value) => {
        if(state.currentRole === 'viewer' || !Permissions.canEdit('storyboard')) return;
        
        const shot = state.data.shots.find(s => s.id === shotId);
        if(shot) {
            shot[field] = value;
            shot.lastModified = Date.now();
            Store.save();
        }
    },
    
    openImageMenu: (shotId) => {
        if(state.currentRole === 'viewer') return;
        
        // CrÃ©er le menu modal
        const menu = document.createElement('div');
        menu.id = 'image-menu-modal';
        menu.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 99999;';
        menu.onclick = (e) => { if(e.target === menu) menu.remove(); };
        
        menu.innerHTML = `
            <div style="background: var(--panel-bg); border-radius: 12px; padding: 25px; text-align: center; min-width: 300px;">
                <h3 style="margin: 0 0 20px; color: var(--text-main);">ðŸ–¼ï¸ Ajouter une image</h3>
                <div class="flex-col-gap10">
                    <button onclick="app.Storyboard.chooseDrawing('${shotId}')" style="padding: 15px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                        ðŸŽ¨ Dessiner
                    </button>
                    <button onclick="app.Storyboard.chooseImport('${shotId}')" style="padding: 15px 20px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                        ðŸ“· Importer une image
                    </button>
                    <button onclick="document.getElementById('image-menu-modal').remove()" style="padding: 12px 20px; background: var(--bg); color: var(--text-main); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 0.95rem;">
                        âœ– Annuler
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(menu);
    },
    
    chooseDrawing: (shotId) => {
        document.getElementById('image-menu-modal').remove();
        DrawingEditor.open(shotId, () => {
            // Callback aprÃ¨s sauvegarde du dessin
            if(Storyboard.currentEditingShotId === shotId) {
                Storyboard.refreshEditModal(shotId);
            }
        });
    },
    
    chooseImport: (shotId) => {
        document.getElementById('image-menu-modal').remove();
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => Storyboard.handleImageUpload(shotId, e);
        input.click();
    },
    
    handleImageUpload: (shotId, event) => {
        const file = event.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const shot = state.data.shots.find(s => s.id === shotId);
            if(shot) {
                shot.imageType = 'upload';
                shot.imageUrl = e.target.result;
                shot.lastModified = Date.now();
                Store.save();
                Storyboard.renderShots();
                // RafraÃ®chir la modale si elle est ouverte
                if(Storyboard.currentEditingShotId === shotId) {
                    Storyboard.refreshEditModal(shotId);
                }
            }
        };
        reader.readAsDataURL(file);
    },
    
	currentEditingShotId: null,
    
    openEditModal: (shotId) => {
        if(state.currentRole === 'viewer') return;
        
        Storyboard.currentEditingShotId = shotId;
        const shot = state.data.shots.find(s => s.id === shotId);
        if(!shot) return;
        
        const sceneIndex = state.data.scenes.findIndex(s => s.id === shot.sceneId) + 1;
        const shotIndex = state.data.shots.filter(s => s.sceneId === shot.sceneId && s.order <= shot.order).length;
        
        document.getElementById('shotEditTitle').innerText = `Ã‰dition Plan ${sceneIndex}.${shotIndex}`;
        
        const content = document.getElementById('shotEditContent');
        content.innerHTML = Storyboard.createShotCard(shot, shotIndex - 1).innerHTML;
        
        // Setup change detection
        content.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('change', () => {
                Storyboard.markAsDirty();
            });
        });
        
        document.getElementById('shot-edit-modal').classList.add('active');
    },
    
    closeEditModal: async () => {
        const saveBtn = document.getElementById('shotEditSaveBtn');
        
        if(saveBtn.classList.contains('visible')) {
            if(!await ConfirmModal.show({ title: 'Modifications non sauvegardÃ©es', message: 'Vous avez des modifications non sauvegardÃ©es.\n\nFermer quand mÃªme ?', icon: 'âš ï¸', dangerous: true, confirmText: 'Fermer sans sauvegarder', cancelText: 'Annuler' })) {
                return;
            }
        }
        
        document.getElementById('shot-edit-modal').classList.remove('active');
        Storyboard.currentEditingShotId = null;
        Storyboard.renderShots();
    },
    
    refreshEditModal: (shotId) => {
        const shot = state.data.shots.find(s => s.id === shotId);
        if(!shot) return;
        
        const sceneIndex = state.data.scenes.findIndex(s => s.id === shot.sceneId) + 1;
        const shotIndex = state.data.shots.filter(s => s.sceneId === shot.sceneId && s.order <= shot.order).length;
        
        const content = document.getElementById('shotEditContent');
        content.innerHTML = Storyboard.createShotCard(shot, shotIndex - 1).innerHTML;
        
        // Re-setup change detection
        content.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('change', () => {
                Storyboard.markAsDirty();
            });
        });
    },
    
    markAsDirty: () => {
        const shot = state.data.shots.find(s => s.id === Storyboard.currentEditingShotId);
        if(shot) {
            shot.isDirty = true;
        }
        
        document.getElementById('shotEditSaveBtn').classList.add('visible');
    },
    
    saveCurrentShot: () => {
        const shot = state.data.shots.find(s => s.id === Storyboard.currentEditingShotId);
        if(!shot) return;
        
        shot.isDirty = false;
        shot.lastModified = Date.now();
        
        Store.save();
        
        document.getElementById('shotEditSaveBtn').classList.remove('visible');
        
        Utils.toast('Plan sauvegardÃ© !', 'success');
        
        Storyboard.closeEditModal();
    },
	
    restoreVersion: (shotId, versionIdx) => {
        if(!versionIdx) return;
        
        const shot = state.data.shots.find(s => s.id === shotId);
        if(shot && shot.versions && shot.versions[versionIdx]) {
            shot.drawingData = JSON.parse(JSON.stringify(shot.versions[versionIdx].data));
            shot.lastModified = Date.now();
            Store.save();
            Storyboard.renderShots();
        }
    },
	currentView: 'edit',
    printConfig: {
        shotNumber: true,
        shotType: true,
        cameraMove: true,
        cameraMode: true,
        description: true,
        actorDirection: true,
        techDirection: true,
        sceneTitle: true
    },
    
    // Extraire l'acronyme entre parenthÃ¨ses, ex: "Gros plan (GP)" â†’ "GP"
    extractAcronym: (value) => {
        if(!value) return '';
        const match = value.match(/\(([^)]+)\)/);
        return match ? match[1] : value;
    },
    
    switchView: (view) => {
        Storyboard.currentView = view;
        
        document.querySelectorAll('.sb-toggle-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if(view === 'edit') {
            document.getElementById('sbEditView').style.display = 'flex';
            document.getElementById('sbPrintPreview').classList.remove('active');
        } else if(view === 'preview') {
            document.getElementById('sbEditView').style.display = 'none';
            document.getElementById('sbPrintPreview').classList.add('active');
            Storyboard.renderPrintPreview('sbPrintPreview');
        }
    },
    
    toggleConfig: () => {
        const panel = document.getElementById('sbConfigPanel');
        panel.classList.toggle('open');
    },
    
    applyConfig: () => {
        Storyboard.printConfig = {
            shotNumber: document.getElementById('cfg-shot-number').checked,
            shotType: document.getElementById('cfg-shot-type').checked,
            cameraMove: document.getElementById('cfg-camera-move').checked,
            cameraMode: document.getElementById('cfg-camera-mode').checked,
            description: document.getElementById('cfg-description').checked,
            actorDirection: document.getElementById('cfg-actor-direction').checked,
            techDirection: document.getElementById('cfg-tech-direction').checked,
            sceneTitle: document.getElementById('cfg-scene-title').checked
        };
        
        document.getElementById('sbConfigPanel').classList.remove('open');
        
        if(Storyboard.currentView === 'preview') {
            Storyboard.renderPrintPreview('sbPrintPreview');
        }
        
        Utils.toast('Configuration appliquÃ©e !', 'success');
    },
    
    openFullscreen: () => {
        document.getElementById('sbFullscreenModal').classList.add('active');
        Storyboard.renderPrintPreview('sbFullscreenContent');
    },
    
    closeFullscreen: () => {
        document.getElementById('sbFullscreenModal').classList.remove('active');
    },
    
    renderPrintPreview: (containerId) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        if(!state.data.shots || state.data.shots.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 50px;">Aucun plan Ã  afficher</div>';
            return;
        }
        
        // Group shots by scene
        const sceneGroups = {};
        state.data.scenes.forEach(scene => {
            const sceneShots = state.data.shots
                .filter(s => s.sceneId === scene.id)
                .sort((a, b) => a.order - b.order);
            
            if(sceneShots.length > 0) {
                sceneGroups[scene.id] = {
                    scene: scene,
                    shots: sceneShots
                };
            }
        });
        
        // Render pages
        Object.values(sceneGroups).forEach(group => {
            const { scene, shots } = group;
            const sceneIndex = state.data.scenes.indexOf(scene) + 1;
            
            // Split shots into pages of 6
            for(let i = 0; i < shots.length; i += 6) {
                const pageShots = shots.slice(i, i + 6);
                const page = Storyboard.createPrintPage(scene, sceneIndex, pageShots, i);
                container.appendChild(page);
            }
        });
    },
    
    createPrintPage: (scene, sceneIndex, shots, startIndex) => {
        const page = document.createElement('div');
        page.className = 'sb-print-page';
        
        if(Storyboard.printConfig.sceneTitle) {
            const title = document.createElement('h2');
            title.innerText = `ScÃ¨ne ${sceneIndex} - ${scene.title}`;
            page.appendChild(title);
        }
        
        const grid = document.createElement('div');
        grid.className = 'sb-print-grid';
        
        shots.forEach((shot, idx) => {
            const shotCard = Storyboard.createPrintShot(shot, sceneIndex, startIndex + idx + 1);
            grid.appendChild(shotCard);
        });
        
        page.appendChild(grid);
        return page;
    },
    
    createPrintShot: (shot, sceneIndex, shotIndex) => {
        const card = document.createElement('div');
        card.className = 'sb-print-shot';
        
        // Image
        const imageDiv = document.createElement('div');
        imageDiv.className = 'sb-print-shot-image';
        
        if(shot.imageType === 'upload' && shot.imageUrl) {
            const img = document.createElement('img');
            img.src = shot.imageUrl;
            imageDiv.appendChild(img);
        } else if(shot.imageType === 'drawing' && shot.drawingData) {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            DrawingEditor.renderDrawingData(ctx, shot.drawingData);
            imageDiv.appendChild(canvas);
        } else {
            imageDiv.innerHTML = '<div style="color: #999;">Pas d\'image</div>';
        }
        
        card.appendChild(imageDiv);
        
        // Info
        const infoDiv = document.createElement('div');
        infoDiv.className = 'sb-print-shot-info';
        
        let infoHTML = '';
        
        // Header line
        const headerParts = [];
        if(Storyboard.printConfig.shotNumber) {
            headerParts.push(`<strong>Plan ${sceneIndex}.${shotIndex}</strong>`);
        }
        if(shot.name) {
            headerParts.push(shot.name);
        }
        if(headerParts.length > 0) {
            infoHTML += `<div class="sb-print-shot-header">${headerParts.join(' - ')}</div>`;
        }
        
        // Meta line (avec acronymes)
        const metaParts = [];
        if(Storyboard.printConfig.shotType && shot.shotType) {
            metaParts.push(Storyboard.extractAcronym(shot.shotType));
        }
        if(Storyboard.printConfig.cameraMove && shot.cameraMove) {
            metaParts.push(Storyboard.extractAcronym(shot.cameraMove));
        }
        if(Storyboard.printConfig.cameraMode && shot.cameraMode) {
            metaParts.push(Storyboard.extractAcronym(shot.cameraMode));
        }
        if(metaParts.length > 0) {
            infoHTML += `<div class="sb-print-shot-meta">${metaParts.join(' â€¢ ')}</div>`;
        }
        
        // Description section
        if(Storyboard.printConfig.description && shot.description) {
            infoHTML += `<div class="sb-print-shot-desc"><strong>Description :</strong> ${Utils.escape(shot.description)}</div>`;
        }
        
        if(Storyboard.printConfig.actorDirection && shot.actorDirection) {
            infoHTML += `<div class="sb-print-shot-desc"><strong>Direction acteurs :</strong> ${Utils.escape(shot.actorDirection)}</div>`;
        }
        
        if(Storyboard.printConfig.techDirection && shot.technicalDirection) {
            infoHTML += `<div class="sb-print-shot-desc"><strong>Direction technique :</strong> ${Utils.escape(shot.technicalDirection)}</div>`;
        }
        
        infoDiv.innerHTML = infoHTML;
        card.appendChild(infoDiv);
        
        return card;
    },
    
    // ========== EXPORT PDF STORYBOARD ==========
    exportPDF: async () => {
        const { jsPDF } = window.jspdf;
        const scenes = state.data.scenes || [];
        const shots = state.data.shots || [];
        
        if(shots.length === 0) {
            Utils.toast('Aucun plan Ã  exporter', 'warning');
            return;
        }
        
        Utils.toast('GÃ©nÃ©ration du PDF en cours...', 'info');
        
        const doc = new jsPDF('l', 'mm', 'a4'); // Paysage
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 10;
        const projectTitle = state.data.title || 'Projet sans titre';
        
        // Configuration d'affichage - utiliser la config complÃ¨te
        const config = Storyboard.printConfig || {};
        const showShotNumber = config.shotNumber !== false;
        const showShotType = config.shotType !== false;
        const showCameraMove = config.cameraMove !== false;
        const showCameraMode = config.cameraMode !== false;
        const showDescription = config.description !== false;
        const showActorDirection = config.actorDirection !== false;
        const showTechDirection = config.techDirection !== false;
        
        // Acronymes
        const shotTypes = { 'Plan gÃ©nÃ©ral': 'PG', 'Plan d\'ensemble': 'PE', 'Plan moyen': 'PM', 'Plan amÃ©ricain': 'PA', 'Plan rapprochÃ©': 'PR', 'Gros plan': 'GP', 'TrÃ¨s gros plan': 'TGP', 'Insert': 'INS' };
        const cameraMoves = { 'Fixe': 'FIX', 'Panoramique': 'PAN', 'Travelling': 'TRAV', 'Zoom': 'ZOOM', 'Steadicam': 'STEAD', 'Drone': 'DRONE', 'Grue': 'GRUE', 'Ã‰paule': 'Ã‰P' };
        const cameraModes = { 'Objectif': 'OBJ', 'Subjectif': 'SUBJ', 'Semi-subjectif': 'SEMI', 'Point de vue': 'PDV' };
        
        // Grouper les plans par scÃ¨ne
        const sceneShots = {};
        shots.forEach(shot => {
            if(!sceneShots[shot.sceneId]) sceneShots[shot.sceneId] = [];
            sceneShots[shot.sceneId].push(shot);
        });
        
        let pageNum = 0;
        
        // Pour chaque scÃ¨ne qui a des plans
        for(const scene of scenes) {
            const sceneIdx = scenes.indexOf(scene);
            const shotsList = sceneShots[scene.id] || [];
            if(shotsList.length === 0) continue;
            
            // 4 plans par page (2x2)
            const shotsPerPage = 4;
            const shotWidth = (pageWidth - margin * 3) / 2;
            const shotHeight = (pageHeight - margin * 3 - 15) / 2;
            const imageHeight = shotHeight * 0.55; // RÃ©duit pour plus d'espace texte
            
            for(let i = 0; i < shotsList.length; i += shotsPerPage) {
                if(pageNum > 0) doc.addPage();
                pageNum++;
                
                // En-tÃªte de page
                doc.setFillColor(43, 110, 246);
                doc.rect(0, 0, pageWidth, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`STORYBOARD - ${projectTitle}`, margin, 8);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`ScÃ¨ne #${sceneIdx + 1} : ${scene.title || 'Sans titre'}`, pageWidth - margin, 8, { align: 'right' });
                
                // Dessiner les plans (grille 2x2)
                const pageShots = shotsList.slice(i, i + shotsPerPage);
                
                pageShots.forEach((shot, idx) => {
                    const col = idx % 2;
                    const row = Math.floor(idx / 2);
                    const x = margin + col * (shotWidth + margin);
                    const y = 15 + row * (shotHeight + margin);
                    
                    // Cadre du plan
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.rect(x, y, shotWidth, shotHeight);
                    
                    // Zone image
                    doc.setFillColor(245, 245, 245);
                    doc.rect(x, y, shotWidth, imageHeight, 'F');
                    
                    // Image du plan
                    if(shot.image) {
                        try {
                            doc.addImage(shot.image, 'PNG', x + 2, y + 2, shotWidth - 4, imageHeight - 4);
                        } catch(e) {
                            doc.setTextColor(180, 180, 180);
                            doc.setFontSize(20);
                            doc.text('ðŸŽ¬', x + shotWidth/2, y + imageHeight/2, { align: 'center' });
                        }
                    } else {
                        doc.setTextColor(180, 180, 180);
                        doc.setFontSize(20);
                        doc.text('ðŸŽ¬', x + shotWidth/2, y + imageHeight/2, { align: 'center' });
                    }
                    
                    // Infos du plan
                    let infoY = y + imageHeight + 4;
                    const maxInfoY = y + shotHeight - 2;
                    doc.setTextColor(50, 50, 50);
                    
                    // Ligne 1: NumÃ©ro, nom et infos techniques
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    let header = [];
                    if(showShotNumber) header.push(`Plan ${i + idx + 1}`);
                    if(shot.name) header.push(`"${shot.name}"`);
                    if(showShotType && shot.shotType) header.push(shotTypes[shot.shotType] || Storyboard.extractAcronym(shot.shotType));
                    if(showCameraMove && shot.cameraMove) header.push(cameraMoves[shot.cameraMove] || Storyboard.extractAcronym(shot.cameraMove));
                    if(showCameraMode && shot.cameraMode) header.push(cameraModes[shot.cameraMode] || Storyboard.extractAcronym(shot.cameraMode));
                    
                    if(header.length > 0) {
                        doc.text(header.join(' â€¢ '), x + 3, infoY);
                        infoY += 4;
                    }
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    
                    // Description
                    if(showDescription && shot.description && infoY < maxInfoY) {
                        const lines = doc.splitTextToSize(`ðŸ“ ${shot.description}`, shotWidth - 6);
                        lines.slice(0, 2).forEach(line => {
                            if(infoY < maxInfoY) { doc.text(line, x + 3, infoY); infoY += 3.5; }
                        });
                    }
                    
                    // Direction acteurs
                    if(showActorDirection && shot.actorDirection && infoY < maxInfoY) {
                        const lines = doc.splitTextToSize(`ðŸŽ­ ${shot.actorDirection}`, shotWidth - 6);
                        lines.slice(0, 2).forEach(line => {
                            if(infoY < maxInfoY) { doc.text(line, x + 3, infoY); infoY += 3.5; }
                        });
                    }
                    
                    // Direction technique
                    if(showTechDirection && shot.technicalDirection && infoY < maxInfoY) {
                        const lines = doc.splitTextToSize(`âš™ï¸ ${shot.technicalDirection}`, shotWidth - 6);
                        lines.slice(0, 2).forEach(line => {
                            if(infoY < maxInfoY) { doc.text(line, x + 3, infoY); infoY += 3.5; }
                        });
                    }
                });
                
                // Pied de page
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${pageNum}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
            }
        }
        
        // Nom de fichier explicite
        const filename = `${projectTitle}_Storyboard`.replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§_-]/gi, '_') + '.pdf';
        doc.save(filename);
        
        Utils.toast('Storyboard PDF exportÃ© !', 'success');
        History.log('EXPORT', 'Storyboard PDF gÃ©nÃ©rÃ©');
    }
};

const DrawingEditor = {
    currentShotId: null,
    moodboardCallback: null,
    canvas: null,
    ctx: null,
    layers: [],
    currentLayerIndex: 0,
    isDrawing: false,
    lastX: 0,
    lastY: 0,
    currentTool: 'pencil',
    currentColor: '#000000',
    brushSize: 10,
    opacity: 100,
    history: [],
    historyStep: -1,
    transparentBg: false,
    
    colors: ['#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080'],
    
    toggleTransparent: (checked) => {
        DrawingEditor.transparentBg = checked;
        DrawingEditor.redraw();
    },
    
    open: (shotId, moodboardCallback = null) => {
        DrawingEditor.currentShotId = shotId;
        DrawingEditor.moodboardCallback = moodboardCallback;
        const modal = document.getElementById('drawing-modal');
        modal.style.display = 'flex';
        
        DrawingEditor.canvas = document.getElementById('drawingCanvas');
        DrawingEditor.ctx = DrawingEditor.canvas.getContext('2d');
        
        // Load existing drawing or create new
        if(shotId) {
            const shot = state.data.shots.find(s => s.id === shotId);
            if(shot && shot.drawingData) {
                DrawingEditor.layers = JSON.parse(JSON.stringify(shot.drawingData.layers));
                DrawingEditor.currentLayerIndex = shot.drawingData.currentLayer || 0;
                // Restaurer les calques depuis les donnÃ©es sauvegardÃ©es
                DrawingEditor.layers.forEach(layer => {
                    if(layer.imageData) {
                        const canvas = document.createElement('canvas');
                        canvas.width = 800;
                        canvas.height = 600;
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.onload = () => {
                            ctx.drawImage(img, 0, 0);
                            DrawingEditor.redraw();
                        };
                        img.src = layer.imageData;
                        layer.canvas = canvas;
                    } else {
                        layer.canvas = document.createElement('canvas');
                        layer.canvas.width = 800;
                        layer.canvas.height = 600;
                    }
                });
            } else {
                DrawingEditor.layers = [DrawingEditor.createNewLayer()];
                DrawingEditor.currentLayerIndex = 0;
            }
        } else {
            // Mode MoodBoard : nouveau dessin vierge
            DrawingEditor.layers = [DrawingEditor.createNewLayer()];
            DrawingEditor.currentLayerIndex = 0;
        }
        
        DrawingEditor.setupCanvas();
        DrawingEditor.renderColorPalette();
        DrawingEditor.renderLayers();
        DrawingEditor.redraw();
        DrawingEditor.saveState();
    },
    
    close: async () => {
        const shotId = DrawingEditor.currentShotId;
        const callback = DrawingEditor.moodboardCallback;
        
        if(await ConfirmModal.show({ title: 'Sauvegarder ?', message: 'Voulez-vous sauvegarder les modifications apportÃ©es Ã  ce dessin ?', icon: 'ðŸ’¾', confirmText: 'Sauvegarder' })) {
            if(callback) {
                // Mode MoodBoard : retourner l'image via callback
                const dataUrl = DrawingEditor.getCompositeImage();
                callback(dataUrl);
            } else {
                // Mode Storyboard classique
                DrawingEditor.save();
                if(Storyboard.currentEditingShotId === shotId) {
                    setTimeout(() => Storyboard.refreshEditModal(shotId), 100);
                }
            }
        }
        document.getElementById('drawing-modal').style.display = 'none';
        DrawingEditor.currentShotId = null;
        DrawingEditor.moodboardCallback = null;
        DrawingEditor.layers = [];
        DrawingEditor.history = [];
        DrawingEditor.historyStep = -1;
    },
    
    getCompositeImage: () => {
        // CrÃ©er un canvas composite avec tous les calques visibles
        const composite = document.createElement('canvas');
        composite.width = 800;
        composite.height = 600;
        const ctx = composite.getContext('2d');
        
        // Fond blanc seulement si pas transparent
        if(!DrawingEditor.transparentBg) {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, composite.width, composite.height);
        }
        
        // Superposer les calques visibles
        DrawingEditor.layers.forEach(layer => {
            if(layer.visible) {
                ctx.drawImage(layer.canvas, 0, 0);
            }
        });
        
        return composite.toDataURL('image/png');
    },
    
    setupCanvas: () => {
        DrawingEditor.canvas.addEventListener('mousedown', DrawingEditor.startDrawing);
        DrawingEditor.canvas.addEventListener('mousemove', DrawingEditor.draw);
        DrawingEditor.canvas.addEventListener('mouseup', DrawingEditor.stopDrawing);
        DrawingEditor.canvas.addEventListener('mouseout', DrawingEditor.stopDrawing);
        
        // Touch support
        DrawingEditor.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            DrawingEditor.canvas.dispatchEvent(mouseEvent);
        });
        
        DrawingEditor.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            DrawingEditor.canvas.dispatchEvent(mouseEvent);
        });
        
        DrawingEditor.canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup', {});
            DrawingEditor.canvas.dispatchEvent(mouseEvent);
        });
    },
    
    createNewLayer: () => {
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 600;
        return {
            id: Utils.generateUniqueId(),
            canvas: canvas,
            visible: true,
            name: 'Calque ' + (DrawingEditor.layers.length + 1)
        };
    },
    
    renderColorPalette: () => {
        const container = document.getElementById('colorPalette');
        container.innerHTML = '';
        
        DrawingEditor.colors.forEach(color => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch' + (DrawingEditor.currentColor === color ? ' active' : '');
            swatch.style.background = color;
            swatch.onclick = () => {
                DrawingEditor.currentColor = color;
                DrawingEditor.renderColorPalette();
            };
            container.appendChild(swatch);
        });
    },
    
    renderLayers: () => {
        const container = document.getElementById('layersList');
        container.innerHTML = '';
        
        DrawingEditor.layers.forEach((layer, idx) => {
            const item = document.createElement('div');
            item.className = 'layer-item' + (idx === DrawingEditor.currentLayerIndex ? ' active' : '');
            item.innerHTML = `
                <span class="layer-visibility" onclick="app.DrawingEditor.toggleLayerVisibility(${idx})">${layer.visible ? 'ðŸ‘ï¸' : 'ðŸ‘ï¸â€ðŸ—¨ï¸'}</span>
                <span class="flex-1">${layer.name}</span>
                ${DrawingEditor.layers.length > 1 ? `<button onclick="app.DrawingEditor.deleteLayer(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer;">ðŸ—‘ï¸</button>` : ''}
            `;
            item.onclick = (e) => {
                if(!e.target.closest('button') && !e.target.closest('.layer-visibility')) {
                    DrawingEditor.currentLayerIndex = idx;
                    DrawingEditor.renderLayers();
                }
            };
            container.appendChild(item);
        });
    },
    
    startDrawing: (e) => {
        const rect = DrawingEditor.canvas.getBoundingClientRect();
        const x = Math.floor(e.clientX - rect.left);
        const y = Math.floor(e.clientY - rect.top);
        
        DrawingEditor.isDrawing = true;
        DrawingEditor.lastX = x;
        DrawingEditor.lastY = y;
    },
    
    draw: (e) => {
        if(!DrawingEditor.isDrawing) return;
        
        const rect = DrawingEditor.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const layer = DrawingEditor.layers[DrawingEditor.currentLayerIndex];
        const ctx = layer.canvas.getContext('2d');
        const tool = DrawingEditor.currentTool;
        
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // Configuration selon l'outil
        if(tool === 'eraser') {
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = DrawingEditor.brushSize;
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'destination-out';
        } else if(tool === 'pencil') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            ctx.lineWidth = Math.max(1, DrawingEditor.brushSize * 0.5);
            ctx.globalAlpha = (DrawingEditor.opacity / 100) * 0.8;
            ctx.globalCompositeOperation = 'source-over';
        } else if(tool === 'pen') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            ctx.lineWidth = Math.max(1, DrawingEditor.brushSize * 0.7);
            ctx.globalAlpha = DrawingEditor.opacity / 100;
            ctx.globalCompositeOperation = 'source-over';
        } else if(tool === 'marker') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            ctx.lineWidth = DrawingEditor.brushSize;
            ctx.globalAlpha = DrawingEditor.opacity / 100;
            ctx.globalCompositeOperation = 'source-over';
        } else if(tool === 'highlighter') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            ctx.lineWidth = DrawingEditor.brushSize * 2;
            ctx.globalAlpha = 0.3;
            ctx.globalCompositeOperation = 'multiply';
            ctx.lineCap = 'square';
        } else if(tool === 'brush') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            const speed = Math.sqrt(Math.pow(x - DrawingEditor.lastX, 2) + Math.pow(y - DrawingEditor.lastY, 2));
            ctx.lineWidth = Math.max(1, DrawingEditor.brushSize * (1 + speed * 0.02));
            ctx.globalAlpha = DrawingEditor.opacity / 100;
            ctx.globalCompositeOperation = 'source-over';
        } else if(tool === 'airbrush') {
            ctx.globalAlpha = 0.1;
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = DrawingEditor.currentColor;
            for(let i = 0; i < 20; i++) {
                const offsetX = (Math.random() - 0.5) * DrawingEditor.brushSize * 2;
                const offsetY = (Math.random() - 0.5) * DrawingEditor.brushSize * 2;
                ctx.beginPath();
                ctx.arc(x + offsetX, y + offsetY, Math.random() * 2, 0, Math.PI * 2);
                ctx.fill();
            }
            DrawingEditor.lastX = x;
            DrawingEditor.lastY = y;
            DrawingEditor.redraw();
            return;
        }
        
        ctx.beginPath();
        ctx.moveTo(DrawingEditor.lastX, DrawingEditor.lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        // Reset composite operation
        ctx.globalCompositeOperation = 'source-over';
        
        DrawingEditor.lastX = x;
        DrawingEditor.lastY = y;
        
        DrawingEditor.redraw();
    },
    
    stopDrawing: () => {
        if(DrawingEditor.isDrawing) {
            DrawingEditor.isDrawing = false;
            DrawingEditor.saveState();
        }
    },
	
	redraw: () => {
        // Clear main canvas
        DrawingEditor.ctx.clearRect(0, 0, DrawingEditor.canvas.width, DrawingEditor.canvas.height);
        
        // Draw all visible layers
        DrawingEditor.layers.forEach(layer => {
            if(layer.visible) {
                DrawingEditor.ctx.drawImage(layer.canvas, 0, 0);
            }
        });
    },
    
    setTool: (tool) => {
        DrawingEditor.currentTool = tool;
        document.querySelectorAll('.drawing-sidebar .brush-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    },
    
    setBrushSize: (size) => {
        DrawingEditor.brushSize = parseInt(size);
    },
    
    setOpacity: (value) => {
        DrawingEditor.opacity = parseInt(value);
        document.getElementById('opacityValue').innerText = value + '%';
    },
    
    addLayer: () => {
        const newLayer = DrawingEditor.createNewLayer();
        DrawingEditor.layers.push(newLayer);
        DrawingEditor.currentLayerIndex = DrawingEditor.layers.length - 1;
        DrawingEditor.renderLayers();
        DrawingEditor.saveState();
    },
    
    deleteLayer: async (idx) => {
        if(DrawingEditor.layers.length === 1) {
            Utils.toast('Impossible de supprimer le dernier calque', 'warning');
            return;
        }
        
        if(await ConfirmModal.confirmDelete("Ce calque sera supprimÃ©.")) {
            DrawingEditor.layers.splice(idx, 1);
            if(DrawingEditor.currentLayerIndex >= DrawingEditor.layers.length) {
                DrawingEditor.currentLayerIndex = DrawingEditor.layers.length - 1;
            }
            DrawingEditor.renderLayers();
            DrawingEditor.redraw();
            DrawingEditor.saveState();
        }
    },
    
    toggleLayerVisibility: (idx) => {
        DrawingEditor.layers[idx].visible = !DrawingEditor.layers[idx].visible;
        DrawingEditor.renderLayers();
        DrawingEditor.redraw();
    },
    
    clear: async () => {
        if(!await ConfirmModal.confirmDelete("Tout le dessin sera effacÃ©.", "Effacer tout ?")) return;
        
        const layer = DrawingEditor.layers[DrawingEditor.currentLayerIndex];
        const ctx = layer.canvas.getContext('2d');
        ctx.clearRect(0, 0, layer.canvas.width, layer.canvas.height);
        DrawingEditor.redraw();
        DrawingEditor.saveState();
    },
    
    saveState: () => {
        // Remove future history if we're not at the end
        if(DrawingEditor.historyStep < DrawingEditor.history.length - 1) {
            DrawingEditor.history = DrawingEditor.history.slice(0, DrawingEditor.historyStep + 1);
        }
        
        // Save current state
        const state = DrawingEditor.layers.map(layer => {
            return {
                id: layer.id,
                visible: layer.visible,
                name: layer.name,
                imageData: layer.canvas.toDataURL()
            };
        });
        
        DrawingEditor.history.push(state);
        DrawingEditor.historyStep++;
        
        // Limit history to 50 steps
        if(DrawingEditor.history.length > 50) {
            DrawingEditor.history.shift();
            DrawingEditor.historyStep--;
        }
    },
    
    undo: () => {
        if(DrawingEditor.historyStep > 0) {
            DrawingEditor.historyStep--;
            DrawingEditor.restoreState(DrawingEditor.history[DrawingEditor.historyStep]);
        }
    },
    
    redo: () => {
        if(DrawingEditor.historyStep < DrawingEditor.history.length - 1) {
            DrawingEditor.historyStep++;
            DrawingEditor.restoreState(DrawingEditor.history[DrawingEditor.historyStep]);
        }
    },
    
    restoreState: (state) => {
        DrawingEditor.layers = state.map(layerState => {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.src = layerState.imageData;
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                DrawingEditor.redraw();
            };
            
            return {
                id: layerState.id,
                canvas: canvas,
                visible: layerState.visible,
                name: layerState.name
            };
        });
        
        DrawingEditor.renderLayers();
    },
    
    save: () => {
        if(!DrawingEditor.currentShotId) return;
        
        const shot = state.data.shots.find(s => s.id === DrawingEditor.currentShotId);
        if(!shot) return;
        
        // Convert layers to serializable format
        const drawingData = {
            layers: DrawingEditor.layers.map(layer => ({
                id: layer.id,
                visible: layer.visible,
                name: layer.name,
                imageData: layer.canvas.toDataURL()
            })),
            currentLayer: DrawingEditor.currentLayerIndex
        };
        
        shot.imageType = 'drawing';
        shot.drawingData = drawingData;
        shot.lastModified = Date.now();
        
        Store.save();
        Storyboard.renderShots();
        Utils.toast('Dessin sauvegardÃ© !', 'success');
    },
    
    saveVersion: () => {
        if(!DrawingEditor.currentShotId) return;
        
        const shot = state.data.shots.find(s => s.id === DrawingEditor.currentShotId);
        if(!shot) return;
        
        // Save current state as a version
        const drawingData = {
            layers: DrawingEditor.layers.map(layer => ({
                id: layer.id,
                visible: layer.visible,
                name: layer.name,
                imageData: layer.canvas.toDataURL()
            })),
            currentLayer: DrawingEditor.currentLayerIndex
        };
        
        if(!shot.versions) shot.versions = [];
        
        shot.versions.push({
            timestamp: Date.now(),
            data: drawingData
        });
        
        shot.imageType = 'drawing';
        shot.drawingData = drawingData;
        shot.lastModified = Date.now();
        
        Store.save();
        Storyboard.renderShots();
        Utils.toast('Version sauvegardÃ©e ! (' + shot.versions.length + ' versions au total)', 'success');
    },
    
    renderDrawingData: (ctx, drawingData) => {
        if(!drawingData || !drawingData.layers) return;
        
        drawingData.layers.forEach(layerData => {
            if(!layerData.visible) return;
            
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
            };
            img.src = layerData.imageData;
        });
    }
};


  // Module Import ScÃ©nario (depuis l'onglet scÃ©nario)
  const ScriptImport = {
      openModal: () => {
          // CrÃ©er le modal d'import
          const existingModal = document.getElementById('script-import-modal');
          if(existingModal) existingModal.remove();
          
          const modal = document.createElement('div');
          modal.id = 'script-import-modal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:10002;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:12px; padding:30px; max-width:500px; width:90%;">
                  <h2 class="mb-20">ðŸ“„ Importer un scÃ©nario</h2>
                  <p class="text-sec-mb20">Importez un fichier PDF ou Final Draft (.fdx) pour ajouter des scÃ¨nes Ã  votre projet.</p>
                  <p style="color:orange; font-size:0.9rem; margin-bottom:20px;">âš ï¸ Attention : l'import remplacera les scÃ¨nes existantes.</p>
                  <div style="display:flex; flex-direction:column; gap:15px;">
                      <label style="display:flex; flex-direction:column; gap:8px; padding:20px; border:2px dashed var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                          <span style="font-size:2rem;">ðŸ“„</span>
                          <span class="fw-600">Choisir un fichier PDF ou FDX</span>
                          <span class="text-sec-sm2">Formats supportÃ©s : .pdf, .fdx, .xml</span>
                          <input type="file" accept=".pdf,.fdx,.xml" onchange="app.ScriptImport.handleFile(event)" class="d-none">
                      </label>
                  </div>
                  <div class="flex-end-mt20">
                      <button onclick="document.getElementById('script-import-modal').remove();" class="btn-border-r8">Annuler</button>
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
      },
      
      handleFile: (e) => {
          const file = e.target.files[0];
          if(!file) return;
          
          // Fermer le modal
          document.getElementById('script-import-modal')?.remove();
          
          // Utiliser le parseur existant
          if(file.name.toLowerCase().endsWith('.pdf')) {
              Importer.parsePDF(file);
          } else if(file.name.toLowerCase().endsWith('.fdx') || file.name.toLowerCase().endsWith('.xml')) {
              const reader = new FileReader();
              reader.onload = (ev) => Importer.parseFDX(ev.target.result);
              reader.readAsText(file);
          } else {
              Utils.toast("Format non supportÃ©. Utilisez PDF ou FDX.", "error");
          }
      }
  };

  const ScriptEditor = {
      format: (sceneId, className, e) => { if(e) e.preventDefault(); const editor = document.getElementById(`editor-${sceneId}`); const sel = window.getSelection(); if (!editor.contains(sel.anchorNode)) return; const block = ScriptEditor.getBlockNode(sel.anchorNode); if(block) { if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, ''); if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, ''); block.className = className; if(className === 'sc-note') ScriptEditor.wrapNote(block); if(className === 'sc-paren') ScriptEditor.wrapParen(block); const s = state.data.scenes.find(x => x.id === sceneId); if(s) s.scriptContent = editor.innerHTML; Store.updateScene(sceneId, editor.innerHTML); ScriptEditor.updateToolbar(editor, document.getElementById(`toolbar-${sceneId}`)); } },
      handleKey: (e, editor, toolbar, sceneId) => { if(state.scriptAC.active) { if(e.key === 'ArrowDown') { e.preventDefault(); state.scriptAC.index++; ScriptEditor.highlightAC(); return; } if(e.key === 'ArrowUp') { e.preventDefault(); state.scriptAC.index--; ScriptEditor.highlightAC(); return; } if(e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); ScriptEditor.selectAC(editor); return; } if(e.key === 'Escape') { ScriptEditor.hideAC(); return; } } const sceneIndex = state.data.scenes.findIndex(s => s.id === sceneId); if(e.ctrlKey || e.metaKey) { const codeToType = { 'Digit1': 'sc-action', 'Digit2': 'sc-perso', 'Digit3': 'sc-dial', 'Digit4': 'sc-paren', 'Digit5': 'sc-trans', 'Digit6': 'sc-centered', 'Digit7': 'sc-note', 'Digit8': 'sc-note', 'Numpad1': 'sc-action', 'Numpad2': 'sc-perso', 'Numpad3': 'sc-dial', 'Numpad4': 'sc-paren', 'Numpad5': 'sc-trans', 'Numpad6': 'sc-centered', 'Numpad7': 'sc-note' }; if(codeToType[e.code]) { e.preventDefault(); e.stopPropagation(); ScriptEditor.setFormatDirect(editor, toolbar, codeToType[e.code]); return; } if(e.key === 'ArrowLeft') { e.preventDefault(); ScriptEditor.goToScene(sceneIndex - 1); return; } if(e.key === 'ArrowRight') { e.preventDefault(); ScriptEditor.goToScene(sceneIndex + 1); return; } if(e.key === 'Enter') { e.preventDefault(); ScriptEditor.insertSceneAfter(sceneIndex); return; } } if(e.key === 'Tab' && e.shiftKey) { e.preventDefault(); ScriptEditor.cycleFormatReverse(editor, toolbar); return; } if(e.key === 'Tab') { e.preventDefault(); ScriptEditor.cycleFormatSmart(editor, toolbar); return; } if(e.key === 'Enter') { e.preventDefault(); const sel = window.getSelection(); const currentBlock = ScriptEditor.getBlockNode(sel.anchorNode); if(currentBlock && (currentBlock.classList.contains('sc-note') || currentBlock.classList.contains('sc-paren'))) { let txt = currentBlock.innerText.trim(); if(currentBlock.classList.contains('sc-note')) { txt = txt.replace(/^\{\s*/, '').replace(/\s*\}$/, '').trim(); currentBlock.innerText = '{ ' + txt + ' }'; } else { txt = txt.replace(/^\(\s*/, '').replace(/\s*\)$/, '').trim(); currentBlock.innerText = '( ' + txt + ' )'; } const newBlock = document.createElement('div'); newBlock.className = currentBlock.classList.contains('sc-paren') ? 'sc-dial' : 'sc-action'; newBlock.innerHTML = '<br>'; currentBlock.after(newBlock); const range = document.createRange(); range.setStart(newBlock, 0); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); ScriptEditor.updateToolbar(editor, toolbar); return; } if(currentBlock && currentBlock.classList.contains('sc-perso')) { const name = currentBlock.innerText.trim().replace(/\(.*\)/, '').trim(); if(name.length > 1) ScriptEditor.syncCharMeta(name, sceneId); } document.execCommand('insertParagraph', false); const newSelection = window.getSelection(); const newBlock = ScriptEditor.getBlockNode(newSelection.anchorNode); const prevBlock = newBlock.previousElementSibling; if(prevBlock && newBlock) { let nextClass = 'sc-action'; if(prevBlock.classList.contains('sc-action')) nextClass = 'sc-perso'; else if(prevBlock.classList.contains('sc-perso')) nextClass = 'sc-dial'; else if(prevBlock.classList.contains('sc-dial')) nextClass = 'sc-perso'; else if(prevBlock.classList.contains('sc-paren')) nextClass = 'sc-dial'; else if(prevBlock.classList.contains('sc-trans')) nextClass = 'sc-action'; newBlock.className = nextClass; } ScriptEditor.updateToolbar(editor, toolbar); } },
      setFormatDirect: (editor, toolbar, className) => { const sel = window.getSelection(); let block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block && editor.children.length > 0) block = editor.firstElementChild; if(!block) return; if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, ''); if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, ''); block.className = className; if(className === 'sc-note') ScriptEditor.wrapNote(block); if(className === 'sc-paren') ScriptEditor.wrapParen(block); ScriptEditor.updateToolbar(editor, toolbar); const sceneId = editor.id.replace('editor-', ''); const s = state.data.scenes.find(x => x.id == sceneId); if(s) { s.scriptContent = editor.innerHTML; Store.save(); } },
      cycleFormatSmart: (editor, toolbar) => { const sel = window.getSelection(); let block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block && editor.children.length > 0) block = editor.firstElementChild; if(!block) return; if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, ''); if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, ''); const smartNext = { 'sc-action': 'sc-perso', 'sc-perso': 'sc-action', 'sc-dial': 'sc-paren', 'sc-paren': 'sc-dial', 'sc-trans': 'sc-action', 'sc-centered': 'sc-action', 'sc-note': 'sc-action', 'sc-general': 'sc-action' }; const currentType = block.className || 'sc-action'; block.className = smartNext[currentType] || 'sc-action'; if(block.className === 'sc-note') ScriptEditor.wrapNote(block); if(block.className === 'sc-paren') ScriptEditor.wrapParen(block); ScriptEditor.updateToolbar(editor, toolbar); },
      cycleFormatReverse: (editor, toolbar) => { const sel = window.getSelection(); let block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block && editor.children.length > 0) block = editor.firstElementChild; if(!block) return; if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, ''); if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, ''); const types = ['sc-action', 'sc-perso', 'sc-dial', 'sc-paren', 'sc-trans', 'sc-centered', 'sc-note']; let currentIdx = types.indexOf(block.className); if(currentIdx === -1) currentIdx = 0; let prevIdx = (currentIdx - 1 + types.length) % types.length; block.className = types[prevIdx]; if(block.className === 'sc-note') ScriptEditor.wrapNote(block); if(block.className === 'sc-paren') ScriptEditor.wrapParen(block); ScriptEditor.updateToolbar(editor, toolbar); },
      cycleFormat: (editor, toolbar) => { ScriptEditor.cycleFormatSmart(editor, toolbar); },
      wrapNote: (block) => { let txt = block.innerText.trim(); if(!txt.startsWith('{')) { block.innerText = '{ ' + txt + ' }'; ScriptEditor.placeCursorInside(block, '{', '}'); } },
      wrapParen: (block) => { let txt = block.innerText.trim(); if(!txt.startsWith('(')) { block.innerText = '( ' + txt + ' )'; ScriptEditor.placeCursorInside(block, '(', ')'); } },
      placeCursorInside: (block, openChar, closeChar) => { const text = block.innerText; const startPos = text.indexOf(openChar) + 2; const endPos = text.lastIndexOf(closeChar) - 1; if(block.firstChild) { const range = document.createRange(); const sel = window.getSelection(); try { const textNode = block.firstChild; const safeStart = Math.min(startPos, textNode.length); range.setStart(textNode, safeStart); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); } catch(e) { console.log('Cursor placement error', e); } } },
      getBlockNode: (node) => { if(!node) return null; if (node.nodeType === 1 && node.classList.contains('script-editor-box')) return node.firstElementChild || null; while (node && node.nodeName !== 'DIV' && !node.classList?.contains('script-editor-box')) node = node.parentNode; return (node && node.classList && !node.classList.contains('script-editor-box')) ? node : null; },
      updateToolbar: (editor, toolbar) => { const sel = window.getSelection(); if(!sel.rangeCount) return; let block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block && editor.children.length > 0) block = editor.firstElementChild; toolbar.querySelectorAll('.fmt-btn').forEach(b => b.classList.remove('active')); if(!block) return; const type = block.className || 'sc-action'; const btn = toolbar.querySelector(`[data-type="${type}"]`); if(btn) btn.classList.add('active'); },
      checkAC: (editor) => { const sel = window.getSelection(); const block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block || !block.classList.contains('sc-perso')) { ScriptEditor.hideAC(); return; } const text = block.innerText.trim().toUpperCase(); if(text.length < 1) { ScriptEditor.hideAC(); return; } const matches = state.data.characters.filter(c => c.name.toUpperCase().startsWith(text) && c.name.toUpperCase() !== text); if(matches.length === 0) { ScriptEditor.hideAC(); return; } state.scriptAC.items = matches; state.scriptAC.active = true; state.scriptAC.index = 0; const range = sel.getRangeAt(0); const rect = range.getBoundingClientRect(); els.scriptACList.style.display = 'block'; els.scriptACList.style.top = (rect.bottom + 5) + 'px'; els.scriptACList.style.left = rect.left + 'px'; ScriptEditor.renderScriptACList(editor); },
      renderScriptACList: (editor) => { els.scriptACList.innerHTML = ''; state.scriptAC.items.forEach((m, i) => { const div = document.createElement('div'); if(i === state.scriptAC.index) div.className = 'active'; div.innerText = m.name; div.onmousedown = (e) => { e.preventDefault(); state.scriptAC.index = i; ScriptEditor.selectAC(editor); }; els.scriptACList.appendChild(div); }); },
      highlightAC: () => { if(state.scriptAC.index >= state.scriptAC.items.length) state.scriptAC.index = 0; if(state.scriptAC.index < 0) state.scriptAC.index = state.scriptAC.items.length - 1; const divs = els.scriptACList.querySelectorAll('div'); divs.forEach(d => d.classList.remove('active')); if(divs[state.scriptAC.index]) divs[state.scriptAC.index].classList.add('active'); },
      selectAC: (editor) => { if(state.scriptAC.index > -1 && state.scriptAC.items[state.scriptAC.index]) { const name = state.scriptAC.items[state.scriptAC.index].name.toUpperCase(); const sel = window.getSelection(); const block = ScriptEditor.getBlockNode(sel.anchorNode); if(block) { block.innerText = name; const range = document.createRange(); range.selectNodeContents(block); range.collapse(false); sel.removeAllRanges(); sel.addRange(range); } } ScriptEditor.hideAC(); },
      hideAC: () => { state.scriptAC.active = false; els.scriptACList.style.display = 'none'; },
      syncCharMeta: (name, sceneId) => { 
          const existsInDb = state.data.characters.find(c => c.name.toLowerCase() === name.toLowerCase()); 
          if (!existsInDb) return; 
          const scene = state.data.scenes.find(s => s.id === sceneId); 
          if(scene) { 
              const currentList = scene.perso ? scene.perso.split(';').map(s=>s.trim()) : []; 
              if(!currentList.find(n => n.toLowerCase() === name.toLowerCase())) { 
                  scene.perso = scene.perso && scene.perso.length > 0 ? scene.perso + "; " + name : name; 
                  // UPDATE VISUEL GAUCHE (Noir / Pas Gras)
                  const row = document.querySelector(`.script-row[data-id="${sceneId}"]`); 
                  if(row) { 
                      const infoCol = row.querySelector('.script-info-col');
                      if(infoCol && infoCol.children[2]) infoCol.children[2].innerText = scene.perso; 
                  } 
              } 
          } 
          Store.save(); 
      },
      
      // ========== NAVIGATION SCÃˆNES ==========
      goToScene: (index) => {
          if(index < 0 || index >= state.data.scenes.length) return;
          const scene = state.data.scenes[index];
          if(!scene) return;
          const row = document.querySelector(`.script-row[data-id="${scene.id}"]`);
          if(row) {
              row.scrollIntoView({ behavior: 'smooth', block: 'start' });
              // Focus sur l'Ã©diteur de cette scÃ¨ne
              setTimeout(() => {
                  const editor = document.getElementById(`editor-${scene.id}`);
                  if(editor) editor.focus();
              }, 300);
          }
      },
      
      insertSceneAfter: (index) => {
          if(state.currentRole === 'viewer') return;
          
          // CrÃ©er une nouvelle scÃ¨ne
          const newScene = {
              id: Date.now(),
              title: 'INT. LIEU - JOUR',
              time: '1',
              resume: '',
              perso: '',
              color: '#808080',
              scriptContent: '<div class="sc-action">Description de l\'action...</div>'
          };
          
          // InsÃ©rer aprÃ¨s l'index spÃ©cifiÃ©
          state.data.scenes.splice(index + 1, 0, newScene);
          
          // Log historique
          History.log('ADD', `Nouvelle scÃ¨ne insÃ©rÃ©e aprÃ¨s Sc.${index + 1}`);
          
          // Sauvegarder et rafraÃ®chir
          Store.save();
          UI.renderScript();
          UI.renderBoard();
          
          // Scroll vers la nouvelle scÃ¨ne
          setTimeout(() => {
              ScriptEditor.goToScene(index + 1);
              Utils.toast(`Nouvelle scÃ¨ne insÃ©rÃ©e (Sc.${index + 2})`, 'success');
          }, 100);
      },
      
      // ========== RECHERCHER / REMPLACER ==========
      searchResults: [],
      currentResultIndex: -1,
      
      openSearchReplace: () => {
          document.getElementById('search-replace-modal').style.display = 'block';
          document.getElementById('search-input').value = '';
          document.getElementById('replace-input').value = '';
          document.getElementById('search-results-info').textContent = 'Tapez pour rechercher...';
          ScriptEditor.searchResults = [];
          ScriptEditor.currentResultIndex = -1;
          ScriptEditor.clearHighlights();
          document.getElementById('search-input').focus();
      },
      
      closeSearchReplace: () => {
          document.getElementById('search-replace-modal').style.display = 'none';
          ScriptEditor.clearHighlights();
      },
      
      searchInScript: () => {
          const query = document.getElementById('search-input').value;
          const caseSensitive = document.getElementById('search-case-sensitive').checked;
          const wholeWord = document.getElementById('search-whole-word').checked;
          
          ScriptEditor.clearHighlights();
          ScriptEditor.searchResults = [];
          ScriptEditor.currentResultIndex = -1;
          
          if(query.length < 1) {
              document.getElementById('search-results-info').textContent = 'Tapez pour rechercher...';
              return;
          }
          
          // Chercher dans tous les Ã©diteurs de scÃ¨ne
          const editors = document.querySelectorAll('.script-editor-box');
          
          editors.forEach(editor => {
              const sceneId = editor.id.replace('editor-', '');
              ScriptEditor.findInElement(editor, query, caseSensitive, wholeWord, sceneId);
          });
          
          const count = ScriptEditor.searchResults.length;
          document.getElementById('search-results-info').textContent = count > 0 
              ? `${count} rÃ©sultat(s) trouvÃ©(s)` 
              : 'Aucun rÃ©sultat';
          
          if(count > 0) {
              ScriptEditor.currentResultIndex = 0;
              ScriptEditor.highlightCurrentResult();
          }
      },
      
      findInElement: (element, query, caseSensitive, wholeWord, sceneId) => {
          const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
          let node;
          
          while(node = walker.nextNode()) {
              let text = node.textContent;
              let searchText = caseSensitive ? text : text.toLowerCase();
              let searchQuery = caseSensitive ? query : query.toLowerCase();
              
              let index = 0;
              while((index = searchText.indexOf(searchQuery, index)) !== -1) {
                  // VÃ©rifier mot entier si nÃ©cessaire
                  if(wholeWord) {
                      const before = index > 0 ? searchText[index - 1] : ' ';
                      const after = index + searchQuery.length < searchText.length ? searchText[index + searchQuery.length] : ' ';
                      if(/\w/.test(before) || /\w/.test(after)) {
                          index++;
                          continue;
                      }
                  }
                  
                  ScriptEditor.searchResults.push({
                      node: node,
                      index: index,
                      length: query.length,
                      sceneId: sceneId
                  });
                  index++;
              }
          }
      },
      
      highlightCurrentResult: () => {
          ScriptEditor.clearHighlights();
          
          if(ScriptEditor.searchResults.length === 0) return;
          
          const result = ScriptEditor.searchResults[ScriptEditor.currentResultIndex];
          if(!result) return;
          
          // CrÃ©er le highlight
          const range = document.createRange();
          range.setStart(result.node, result.index);
          range.setEnd(result.node, result.index + result.length);
          
          const highlight = document.createElement('span');
          highlight.className = 'search-highlight current';
          highlight.style.cssText = 'background: #fbbf24; color: #000; padding: 1px 2px; border-radius: 2px;';
          
          try {
              range.surroundContents(highlight);
              highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } catch(e) {
              console.log('Erreur highlight:', e);
          }
          
          // Mettre Ã  jour l'info
          document.getElementById('search-results-info').textContent = 
              `RÃ©sultat ${ScriptEditor.currentResultIndex + 1} / ${ScriptEditor.searchResults.length}`;
      },
      
      clearHighlights: () => {
          document.querySelectorAll('.search-highlight').forEach(el => {
              const parent = el.parentNode;
              while(el.firstChild) {
                  parent.insertBefore(el.firstChild, el);
              }
              parent.removeChild(el);
              parent.normalize();
          });
      },
      
      searchNext: () => {
          if(ScriptEditor.searchResults.length === 0) {
              ScriptEditor.searchInScript();
              if(ScriptEditor.searchResults.length === 0) return;
          }
          ScriptEditor.clearHighlights();
          const savedIndex = ScriptEditor.currentResultIndex;
          ScriptEditor.searchInScript();
          ScriptEditor.currentResultIndex = (savedIndex + 1) % ScriptEditor.searchResults.length;
          ScriptEditor.highlightCurrentResult();
      },
      
      searchPrev: () => {
          if(ScriptEditor.searchResults.length === 0) {
              ScriptEditor.searchInScript();
              if(ScriptEditor.searchResults.length === 0) return;
          }
          ScriptEditor.clearHighlights();
          const savedIndex = ScriptEditor.currentResultIndex;
          ScriptEditor.searchInScript();
          ScriptEditor.currentResultIndex = savedIndex - 1;
          if(ScriptEditor.currentResultIndex < 0) ScriptEditor.currentResultIndex = ScriptEditor.searchResults.length - 1;
          ScriptEditor.highlightCurrentResult();
      },
      
      replaceOne: () => {
          if(ScriptEditor.searchResults.length === 0) return;
          
          const replaceText = document.getElementById('replace-input').value;
          const highlight = document.querySelector('.search-highlight.current');
          
          if(highlight) {
              const sceneId = highlight.closest('.script-editor-box')?.id.replace('editor-', '');
              highlight.replaceWith(document.createTextNode(replaceText));
              
              // Sauvegarder la scÃ¨ne
              if(sceneId) {
                  const editor = document.getElementById('editor-' + sceneId);
                  const scene = state.data.scenes.find(s => String(s.id) === String(sceneId));
                  if(scene && editor) {
                      scene.scriptContent = editor.innerHTML;
                      Store.save();
                  }
              }
              
              // Passer au suivant
              ScriptEditor.searchInScript();
              if(ScriptEditor.searchResults.length > 0) {
                  ScriptEditor.highlightCurrentResult();
              }
          }
      },
      
      replaceAll: () => {
          const query = document.getElementById('search-input').value;
          const replaceText = document.getElementById('replace-input').value;
          const caseSensitive = document.getElementById('search-case-sensitive').checked;
          const wholeWord = document.getElementById('search-whole-word').checked;
          
          if(query.length < 1) return;
          
          // Sauvegarder avant remplacement
          ScriptEditor.saveBackup();
          
          let totalReplaced = 0;
          
          // Remplacer dans chaque scÃ¨ne
          state.data.scenes.forEach(scene => {
              if(!scene.scriptContent) return;
              
              let content = scene.scriptContent;
              let flags = caseSensitive ? 'g' : 'gi';
              let pattern = wholeWord ? `\\b${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b` : query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              
              const regex = new RegExp(pattern, flags);
              const matches = content.match(regex);
              
              if(matches) {
                  totalReplaced += matches.length;
                  scene.scriptContent = content.replace(regex, replaceText);
              }
          });
          
          Store.save();
          UI.renderScript();
          
          document.getElementById('search-results-info').textContent = `âœ… ${totalReplaced} remplacement(s) effectuÃ©(s)`;
          ScriptEditor.searchResults = [];
          ScriptEditor.currentResultIndex = -1;
          
          // Afficher le bouton annuler
          if(totalReplaced > 0) {
              document.getElementById('undo-replace-btn').style.display = 'block';
          }
          
          Utils.toast(`${totalReplaced} remplacement(s) effectuÃ©(s)`, 'success');
      },
      
      // Sauvegarde pour annulation
      backupScripts: null,
      
      saveBackup: () => {
          ScriptEditor.backupScripts = state.data.scenes.map(s => ({
              id: s.id,
              scriptContent: s.scriptContent
          }));
      },
      
      undoReplace: () => {
          if(!ScriptEditor.backupScripts) {
              Utils.toast('Aucun remplacement Ã  annuler', 'error');
              return;
          }
          
          // Restaurer le contenu
          ScriptEditor.backupScripts.forEach(backup => {
              const scene = state.data.scenes.find(s => String(s.id) === String(backup.id));
              if(scene) {
                  scene.scriptContent = backup.scriptContent;
              }
          });
          
          Store.save();
          UI.renderScript();
          
          ScriptEditor.backupScripts = null;
          document.getElementById('undo-replace-btn').style.display = 'none';
          document.getElementById('search-results-info').textContent = 'â†©ï¸ Remplacement annulÃ©';
          
          Utils.toast('Remplacement annulÃ©', 'success');
      },
      
      // Drag de la fenÃªtre
      initDrag: () => {
          const modal = document.getElementById('search-replace-modal');
          const header = document.getElementById('search-replace-header');
          let isDragging = false;
          let offsetX, offsetY;
          
          header.addEventListener('mousedown', (e) => {
              if(e.target.tagName === 'BUTTON') return;
              isDragging = true;
              offsetX = e.clientX - modal.offsetLeft;
              offsetY = e.clientY - modal.offsetTop;
              modal.style.transition = 'none';
          });
          
          document.addEventListener('mousemove', (e) => {
              if(!isDragging) return;
              let newX = e.clientX - offsetX;
              let newY = e.clientY - offsetY;
              
              // Limites de l'Ã©cran
              newX = Math.max(0, Math.min(newX, window.innerWidth - modal.offsetWidth));
              newY = Math.max(0, Math.min(newY, window.innerHeight - modal.offsetHeight));
              
              modal.style.left = newX + 'px';
              modal.style.top = newY + 'px';
              modal.style.right = 'auto';
          });
          
          document.addEventListener('mouseup', () => {
              isDragging = false;
              modal.style.transition = '';
          });
      },
      
      // ========== VUE SCRIPT CONTINU ==========
      viewMode: 'continuous', // 'scenes' ou 'continuous' - Vue Script par dÃ©faut
      activeSceneId: null,
      
      initViewMode: () => {
          // Charger la prÃ©fÃ©rence sauvegardÃ©e ou utiliser 'continuous' par dÃ©faut
          try {
              const saved = localStorage.getItem('fmp_script_view_mode');
              if(saved) ScriptEditor.viewMode = saved;
          } catch(e) {}
          ScriptEditor.setViewMode(ScriptEditor.viewMode);
      },
      
      setViewMode: (mode) => {
          ScriptEditor.viewMode = mode;
          
          // Sauvegarder la prÃ©fÃ©rence
          PreferencesSync.save('fmp_script_view_mode', mode);
          
          // Update toggle buttons
          document.getElementById('script-view-scenes').classList.toggle('active', mode === 'scenes');
          document.getElementById('script-view-continuous').classList.toggle('active', mode === 'continuous');
          
          // Show/hide containers
          document.getElementById('scriptContainer').style.display = mode === 'scenes' ? 'block' : 'none';
          document.getElementById('scriptContinuousContainer').style.display = mode === 'continuous' ? 'flex' : 'none';
          
          if(mode === 'continuous') {
              ScriptEditor.renderContinuous();
          }
      },
      
      renderContinuous: () => {
          const editor = document.getElementById('scriptContinuousEditor');
          const sidebar = document.getElementById('scriptContinuousSidebar');
          if(!editor || !sidebar) return;
          
          editor.innerHTML = '';
          
          if(state.data.scenes.length === 0) {
              editor.innerHTML = '<div style="text-align:center;padding:50px;color:var(--text-sec)">Ajoutez des scÃ¨nes pour commencer.</div>';
              sidebar.innerHTML = '';
              return;
          }
          
          const isView = state.currentRole === 'viewer' || !Permissions.canEdit('scenario');
          
          // CrÃ©er un conteneur pour chaque scÃ¨ne dans l'Ã©diteur continu
          state.data.scenes.forEach((scene, idx) => {
              const sceneDiv = document.createElement('div');
              sceneDiv.className = 'script-continuous-scene';
              sceneDiv.dataset.sceneId = scene.id;
              sceneDiv.dataset.sceneIndex = idx;
              
              // Heading de la scÃ¨ne (draggable + titre Ã©ditable)
              const heading = document.createElement('div');
              heading.className = 'script-continuous-heading';
              heading.draggable = true;
              heading.innerHTML = `<span class="script-continuous-scene-number">#${idx + 1}</span><span class="scene-title-text" data-scene-id="${scene.id}">${Utils.escape(scene.title)}</span>`;
              
              // Drag depuis le heading
              heading.addEventListener('dragstart', (e) => {
                  ScriptEditor.draggedSceneId = scene.id;
                  e.dataTransfer.effectAllowed = 'move';
                  heading.style.opacity = '0.5';
              });
              heading.addEventListener('dragend', () => {
                  heading.style.opacity = '1';
                  ScriptEditor.draggedSceneId = null;
                  document.querySelectorAll('.script-continuous-scene.drag-over').forEach(el => el.classList.remove('drag-over'));
              });
              
              // Clic sur le titre pour l'Ã©diter
              const titleSpan = heading.querySelector('.scene-title-text');
              titleSpan.addEventListener('click', (e) => {
                  e.stopPropagation();
                  ScriptEditor.editSceneTitle(scene.id, titleSpan);
              });
              
              sceneDiv.appendChild(heading);
              
              // Contenu de la scÃ¨ne
              const content = document.createElement('div');
              content.className = 'script-continuous-content';
              content.contentEditable = !isView;
              content.spellcheck = true;
              content.lang = 'fr';
              content.innerHTML = scene.scriptContent || "<div class='sc-action'><br></div>";
              
              // Events
              if(!isView) {
                  content.addEventListener('input', () => {
                      const s = state.data.scenes.find(x => x.id === scene.id);
                      if(s) s.scriptContent = content.innerHTML;
                      Store.updateScene(scene.id, content.innerHTML);
                  });
                  
                  content.addEventListener('focus', () => {
                      // Ne changer la scÃ¨ne active que si on clique vraiment dedans
                      if(ScriptEditor.activeSceneId !== scene.id) {
                          ScriptEditor.activeSceneId = scene.id;
                          ScriptEditor.updateContinuousSidebar(scene.id, idx);
                          document.querySelectorAll('.script-continuous-scene').forEach(s => {
                              s.classList.toggle('active', s.dataset.sceneId == scene.id);
                          });
                      }
                      Store.acquireLock(scene.id);
                  });
                  
                  content.addEventListener('blur', () => {
                      Store.releaseLock(scene.id);
                  });
                  
                  content.addEventListener('keydown', (e) => {
                      ScriptEditor.handleKeyContinuous(e, content, scene.id);
                  });
                  
                  content.addEventListener('click', () => {
                      ScriptEditor.updateToolbarContinuous();
                      ScriptEditor.saveSelection();
                  });
                  
                  content.addEventListener('mouseup', () => {
                      ScriptEditor.updateToolbarContinuous();
                  });
                  
                  content.addEventListener('keyup', (e) => {
                      if(e.key === 'Shift') {
                          content.focus();
                      }
                  });
              }
              
              // Ã‰vÃ©nements drag & drop pour rÃ©ordonner
              sceneDiv.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  if(ScriptEditor.draggedSceneId && ScriptEditor.draggedSceneId !== scene.id) {
                      sceneDiv.classList.add('drag-over');
                  }
              });
              
              sceneDiv.addEventListener('dragleave', () => {
                  sceneDiv.classList.remove('drag-over');
              });
              
              sceneDiv.addEventListener('drop', (e) => {
                  e.preventDefault();
                  sceneDiv.classList.remove('drag-over');
                  if(ScriptEditor.draggedSceneId && ScriptEditor.draggedSceneId !== scene.id) {
                      ScriptEditor.reorderSceneContinuous(ScriptEditor.draggedSceneId, scene.id);
                  }
              });
              
              sceneDiv.appendChild(content);
              editor.appendChild(sceneDiv);
          });
          
          // Initialiser avec la premiÃ¨re scÃ¨ne
          if(state.data.scenes.length > 0) {
              ScriptEditor.setActiveScene(state.data.scenes[0].id, 0);
          }
      },
      
      setActiveScene: (sceneId, index) => {
          if(ScriptEditor.activeSceneId === sceneId) return;
          ScriptEditor.activeSceneId = sceneId;
          
          // Highlight la scÃ¨ne active
          document.querySelectorAll('.script-continuous-scene').forEach(s => {
              s.classList.toggle('active', s.dataset.sceneId === sceneId);
          });
          
          // Mettre Ã  jour la sidebar
          ScriptEditor.updateContinuousSidebar(sceneId, index);
      },
      
      updateContinuousSidebar: (sceneId, index) => {
          const sidebar = document.getElementById('scriptContinuousSidebar');
          if(!sidebar) return;
          
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          
          const idx = index !== undefined ? index : state.data.scenes.findIndex(s => s.id === sceneId);
          const tag = state.data.tags.find(t => t.id === scene.tag_id) || {name:'', color: 'transparent'};
          const infoStyle = tag.color !== 'transparent' ? `border-left-color:${tag.color}` : '';
          const badge = tag.color !== 'transparent' ? `<span class="tag-badge" style="background:${tag.color}" title="${Utils.escape(tag.name)}"></span>` : '';
          
          const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
          const versionCount = scene.versions ? scene.versions.length : 0;
          const sceneStatus = scene.status || 'not-verified';
          const statusBadge = `<span class="scene-status-badge ${sceneStatus}" onclick="app.UI.toggleSceneStatus('${scene.id}', event)">${SCENE_STATUS_LABELS[sceneStatus]}</span>`;
          const isView = state.currentRole === 'viewer';
          const isFinal = scene.isFinal === true;
          const finalBadge = isFinal ? `<span class="scene-status-badge final">âœ… Finale</span>` : `<span class="scene-status-badge draft">ðŸ“ Brouillon</span>`;
          const finalizeBtn = isView ? '' : (isFinal 
              ? `<button class="unfinalize-btn w-full" onclick="app.Actions.unfinalizeScene('${scene.id}')">ðŸ“ Repasser en brouillon</button>`
              : `<button class="finalize-btn w-full" onclick="app.Actions.finalizeScene('${scene.id}')">âœ… Finaliser cette scÃ¨ne</button>`);
          
          sidebar.innerHTML = `
              <div class="script-info-col" style="${infoStyle}" draggable="true" 
                   ondragstart="app.ScriptEditor.handleSidebarDragStart(event, '${scene.id}')"
                   ondragend="app.ScriptEditor.handleSidebarDragEnd(event)">
                  <h3 style="cursor:move; display:flex; align-items:center; flex-wrap:wrap; gap:8px;">
                      ${badge}${Utils.escape(scene.title)}
                      <div style="margin-left:auto;">${statusBadge}</div>
                  </h3>
                  <div style="margin-bottom:10px;font-size:0.8em">#${idx+1} / ${state.data.scenes.length} â€¢ ${Utils.escape(scene.time)} min</div>
                  <div style="margin-bottom:10px; font-size:0.85rem; color:var(--text-main);">${Utils.escape(scene.perso) || '-'}</div>
                  <strong>RÃ©sumÃ©:</strong>
                  <p class="mt-5">${Utils.escape(scene.resume) || '-'}</p>
                  
                  <div class="script-sidebar-btns">
                      <button onclick="app.StoryboardPreview.open('${scene.id}')">ðŸ“· Storyboard (${shotCount})</button>
                      <button onclick="app.Comments.open('${scene.id}')">ðŸ’¬ Commentaires</button>
                      <hr class="hr-subtle">
                      <button onclick="app.SceneVersions.save('${scene.id}')">ðŸ“¸ Sauvegarder version</button>
                      <button onclick="app.SceneVersions.openModal('${scene.id}')">ðŸ“œ Historique${versionCount > 0 ? ' (' + versionCount + ')' : ''}</button>
                      <hr class="hr-subtle">
                      <div style="text-align:center; margin-bottom:5px;">${finalBadge}</div>
                      ${finalizeBtn}
                      <hr class="hr-subtle">
                      <button onclick="app.ScriptEditor.goToSceneContinuous(${idx - 1})">â¬…ï¸ ScÃ¨ne prÃ©cÃ©dente</button>
                      <button onclick="app.ScriptEditor.goToSceneContinuous(${idx + 1})">âž¡ï¸ ScÃ¨ne suivante</button>
                  </div>
              </div>
          `;
      },
      
      goToSceneContinuous: (index) => {
          if(index < 0 || index >= state.data.scenes.length) {
              Utils.toast(index < 0 ? 'PremiÃ¨re scÃ¨ne atteinte' : 'DerniÃ¨re scÃ¨ne atteinte', 'info');
              return;
          }
          const scene = state.data.scenes[index];
          ScriptEditor.scrollToSceneInContinuous(scene.id);
          // Mettre Ã  jour la sidebar avec la nouvelle scÃ¨ne
          ScriptEditor.setActiveScene(scene.id, index);
      },
      
      scrollToSceneInContinuous: (sceneId) => {
          const sceneDiv = document.querySelector(`.script-continuous-scene[data-scene-id="${sceneId}"]`);
          if(sceneDiv) {
              sceneDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
              const content = sceneDiv.querySelector('.script-continuous-content');
              if(content) {
                  setTimeout(() => content.focus(), 300);
              }
          }
      },
      
      // Timestamps pour dÃ©tecter double-tap
      lastEnterTime: 0,
      lastTabTime: 0,
      doubleTapDelay: 300,
      
      // VÃ©rifie si le bloc est vide (juste des espaces, <br>, ou rien)
      isBlockEmpty: (block) => {
          if(!block) return true;
          const text = block.innerText.replace(/[\s\u00A0]/g, '').replace(/[{}()]/g, '');
          return text.length === 0;
      },
      
      // Change le type du bloc actuel sans crÃ©er de nouvelle ligne
      changeBlockType: (block, newType) => {
          if(!block) return;
          // Nettoyer les caractÃ¨res spÃ©ciaux des notes/parenthÃ¨ses
          if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, '').trim();
          if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, '').trim();
          block.className = newType;
          if(newType === 'sc-note') ScriptEditor.wrapNote(block);
          if(newType === 'sc-paren') ScriptEditor.wrapParen(block);
      },
      
      handleKeyContinuous: (e, content, sceneId) => {
          const toolbar = document.getElementById('continuous-toolbar');
          const sel = window.getSelection();
          const currentBlock = ScriptEditor.getBlockNode(sel.anchorNode);
          const currentType = currentBlock?.className || 'sc-action';
          const isEmpty = ScriptEditor.isBlockEmpty(currentBlock);
          const now = Date.now();
          
          // Ignorer Shift seul (Ã©viter perte de focus)
          if(e.key === 'Shift') {
              e.preventDefault();
              e.stopPropagation();
              return;
          }
          
          // Raccourcis Ctrl+1-6 ou Alt+1-6 pour types directs
          if(e.ctrlKey || e.metaKey || e.altKey) {
              const codeToType = { 'Digit1': 'sc-action', 'Digit2': 'sc-perso', 'Digit3': 'sc-dial', 'Digit4': 'sc-paren', 'Digit5': 'sc-trans', 'Digit6': 'sc-centered', 'Digit7': 'sc-note', 'Numpad1': 'sc-action', 'Numpad2': 'sc-perso', 'Numpad3': 'sc-dial', 'Numpad4': 'sc-paren', 'Numpad5': 'sc-trans', 'Numpad6': 'sc-centered', 'Numpad7': 'sc-note' };
              if(codeToType[e.code]) { e.preventDefault(); e.stopPropagation(); ScriptEditor.setFormatDirectContinuous(content, codeToType[e.code]); return; }
          }
          
          // === SHIFT+TAB (cycle inverse) ===
          if(e.key === 'Tab' && e.shiftKey) {
              e.preventDefault();
              e.stopPropagation();
              let prevType = 'sc-action';
              if(currentType === 'sc-action') prevType = 'sc-note';
              else if(currentType === 'sc-perso') prevType = 'sc-action';
              else if(currentType === 'sc-dial') prevType = 'sc-perso';
              else if(currentType === 'sc-paren') prevType = 'sc-dial';
              else if(currentType === 'sc-trans') prevType = 'sc-paren';
              else if(currentType === 'sc-centered') prevType = 'sc-trans';
              else if(currentType === 'sc-note') prevType = 'sc-centered';
              ScriptEditor.changeBlockType(currentBlock, prevType);
              ScriptEditor.updateToolbarContinuous();
              return;
          }
          
          // === TAB ===
          if(e.key === 'Tab') {
              e.preventDefault();
              e.stopPropagation();
              
              // Double Tab â†’ Note
              if(now - ScriptEditor.lastTabTime < ScriptEditor.doubleTapDelay) {
                  ScriptEditor.changeBlockType(currentBlock, 'sc-note');
                  ScriptEditor.lastTabTime = 0;
                  ScriptEditor.updateToolbarContinuous();
                  return;
              }
              ScriptEditor.lastTabTime = now;
              
              // Tab simple : toggle selon le type (change le bloc actuel, jamais de nouvelle ligne)
              let nextType = 'sc-action';
              if(currentType === 'sc-action') nextType = 'sc-perso';
              else if(currentType === 'sc-perso') nextType = 'sc-paren';
              else if(currentType === 'sc-dial') nextType = 'sc-perso';
              else if(currentType === 'sc-paren') nextType = 'sc-dial';
              else if(currentType === 'sc-trans') nextType = 'sc-action';
              else if(currentType === 'sc-note') nextType = 'sc-action';
              else if(currentType === 'sc-centered') nextType = 'sc-action';
              
              ScriptEditor.changeBlockType(currentBlock, nextType);
              ScriptEditor.updateToolbarContinuous();
              return;
          }
          
          // === ENTER ===
          if(e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              e.stopPropagation();
              
              // Sync perso si besoin
              if(currentBlock && currentBlock.classList.contains('sc-perso')) {
                  const name = currentBlock.innerText.trim().replace(/\(.*\)/, '').trim();
                  if(name.length > 1) ScriptEditor.syncCharMeta(name, sceneId);
              }
              
              // Double Enter ?
              const isDoubleEnter = (now - ScriptEditor.lastEnterTime < ScriptEditor.doubleTapDelay);
              ScriptEditor.lastEnterTime = now;
              
              if(isDoubleEnter) {
                  // Double Enter : change le type du bloc actuel (pas de nouvelle ligne)
                  if(currentType === 'sc-action') {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-trans');
                      ScriptEditor.updateToolbarContinuous();
                      return;
                  } else if(currentType === 'sc-dial' || currentType === 'sc-paren') {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-action');
                      ScriptEditor.updateToolbarContinuous();
                      return;
                  }
              }
              
              // Enter simple - logique selon si la ligne est vide ou non
              
              if(currentType === 'sc-action') {
                  // Action + Enter = si vide: reste Action, si rempli: nouveau paragraphe Action
                  if(isEmpty) {
                      // Ligne vide : on ne fait rien (reste sur Action)
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-action';
                  }
              } else if(currentType === 'sc-perso') {
                  // Perso + Enter = si vide: change en Dialogue, si rempli: nouvelle ligne Dialogue
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-dial');
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-dial';
                  }
              } else if(currentType === 'sc-dial') {
                  // Dialogue + Enter = si vide: change en Perso, si rempli: nouvelle ligne Perso
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-perso');
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-perso';
                  }
              } else if(currentType === 'sc-paren') {
                  // Didas + Enter = si vide: change en Dial, si rempli: nouvelle ligne Dial
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-dial');
                  } else {
                      // Nettoyer le texte et fermer proprement les parenthÃ¨ses
                      let txt = currentBlock.innerText.trim();
                      txt = txt.replace(/^\(\s*/, '').replace(/\s*\)$/, '').trim();
                      currentBlock.innerText = '( ' + txt + ' )';
                      // CrÃ©er nouvelle ligne Dial
                      const newBlock = document.createElement('div');
                      newBlock.className = 'sc-dial';
                      newBlock.innerHTML = '<br>';
                      currentBlock.after(newBlock);
                      const range = document.createRange();
                      range.setStart(newBlock, 0);
                      range.collapse(true);
                      sel.removeAllRanges();
                      sel.addRange(range);
                  }
              } else if(currentType === 'sc-trans') {
                  // Trans + Enter = si vide: change en Action, si rempli: nouvelle ligne Action
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-action');
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-action';
                  }
              } else if(currentType === 'sc-note') {
                  // Note + Enter = si vide: change en Action, si rempli: nouvelle ligne Action
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-action');
                  } else {
                      let txt = currentBlock.innerText.trim();
                      txt = txt.replace(/^\{\s*/, '').replace(/\s*\}$/, '').trim();
                      currentBlock.innerText = '{ ' + txt + ' }';
                      const newBlock = document.createElement('div');
                      newBlock.className = 'sc-action';
                      newBlock.innerHTML = '<br>';
                      currentBlock.after(newBlock);
                      const range = document.createRange();
                      range.setStart(newBlock, 0);
                      range.collapse(true);
                      sel.removeAllRanges();
                      sel.addRange(range);
                  }
              } else if(currentType === 'sc-centered') {
                  // CentrÃ© + Enter = si vide: change en Action, si rempli: nouvelle ligne Action
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-action');
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-action';
                  }
              } else {
                  // DÃ©faut
                  if(!isEmpty) {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-action';
                  }
              }
              
              ScriptEditor.updateToolbarContinuous();
          }
      },
      
      setFormatDirectContinuous: (content, className) => {
          const sel = window.getSelection();
          let block = ScriptEditor.getBlockNode(sel.anchorNode);
          if(!block && content.children.length > 0) block = content.firstElementChild;
          if(!block) return;
          if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, '');
          if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, '');
          block.className = className;
          if(className === 'sc-note') ScriptEditor.wrapNote(block);
          if(className === 'sc-paren') ScriptEditor.wrapParen(block);
          ScriptEditor.updateToolbarContinuous();
      },
      
      // Les fonctions cycleFormat ne sont plus utilisÃ©es - la logique est dans handleKeyContinuous
      cycleFormatSmartContinuous: (content) => { /* deprecated */ },
      
      cycleFormatReverseContinuous: (content) => {
          const sel = window.getSelection();
          let block = ScriptEditor.getBlockNode(sel.anchorNode);
          if(!block && content.children.length > 0) block = content.firstElementChild;
          if(!block) return;
          if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, '');
          if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, '');
          const types = ['sc-action', 'sc-perso', 'sc-dial', 'sc-paren', 'sc-trans', 'sc-centered', 'sc-note'];
          let currentIdx = types.indexOf(block.className);
          if(currentIdx === -1) currentIdx = 0;
          block.className = types[(currentIdx - 1 + types.length) % types.length];
          if(block.className === 'sc-note') ScriptEditor.wrapNote(block);
          if(block.className === 'sc-paren') ScriptEditor.wrapParen(block);
          ScriptEditor.updateToolbarContinuous();
      },
      
      cycleFormatContinuous: (content) => {
          ScriptEditor.cycleFormatSmartContinuous(content);
      },
      
      // Sauvegarder la sÃ©lection pour les boutons
      savedSelection: null,
      
      saveSelection: () => {
          const sel = window.getSelection();
          if(sel.rangeCount > 0) {
              ScriptEditor.savedSelection = sel.getRangeAt(0).cloneRange();
          }
      },
      
      restoreSelection: () => {
          if(ScriptEditor.savedSelection) {
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(ScriptEditor.savedSelection);
          }
      },
      
      formatContinuous: (className, e) => {
          if(e) e.preventDefault();
          
          // Restaurer la sÃ©lection si elle a Ã©tÃ© perdue
          if(ScriptEditor.savedSelection) {
              ScriptEditor.restoreSelection();
          }
          
          const sel = window.getSelection();
          
          // DÃ©tecter si on est en Vue ScÃ¨nes ou Vue Script
          const isContinuousView = document.getElementById('scriptContinuousContainer')?.style.display !== 'none';
          
          if(isContinuousView) {
              // === VUE SCRIPT ===
              const activeScene = document.querySelector('.script-continuous-scene.active');
              if(!activeScene) {
                  Utils.toast('Cliquez d\'abord dans une scÃ¨ne', 'warning');
                  return;
              }
              
              const content = activeScene.querySelector('.script-continuous-content');
              if(!content) return;
              
              if(!sel.anchorNode || !content.contains(sel.anchorNode)) {
                  if(content.firstElementChild) {
                      const range = document.createRange();
                      range.selectNodeContents(content.firstElementChild);
                      range.collapse(true);
                      sel.removeAllRanges();
                      sel.addRange(range);
                  } else {
                      return;
                  }
              }
              
              const block = ScriptEditor.getBlockNode(sel.anchorNode);
              if(block) {
                  ScriptEditor.changeBlockType(block, className);
                  
                  const sceneId = activeScene.dataset.sceneId;
                  const scene = state.data.scenes.find(x => x.id === sceneId);
                  if(scene) {
                      scene.scriptContent = content.innerHTML;
                      Store.updateScene(sceneId, content.innerHTML);
                  }
                  
                  ScriptEditor.updateToolbarContinuous();
                  content.focus();
              }
          } else {
              // === VUE SCÃˆNES ===
              // Trouver l'Ã©diteur actif (celui qui a le focus ou la sÃ©lection)
              const editors = document.querySelectorAll('.script-editor-box');
              let activeEditor = null;
              let activeSceneId = null;
              
              for(const editor of editors) {
                  if(sel.anchorNode && editor.contains(sel.anchorNode)) {
                      activeEditor = editor;
                      activeSceneId = editor.id.replace('editor-', '');
                      break;
                  }
              }
              
              if(!activeEditor) {
                  Utils.toast('Cliquez d\'abord dans une scÃ¨ne', 'warning');
                  return;
              }
              
              const block = ScriptEditor.getBlockNode(sel.anchorNode);
              if(block) {
                  ScriptEditor.changeBlockType(block, className);
                  
                  const scene = state.data.scenes.find(x => x.id == activeSceneId);
                  if(scene) {
                      scene.scriptContent = activeEditor.innerHTML;
                      Store.updateScene(activeSceneId, activeEditor.innerHTML);
                  }
                  
                  ScriptEditor.updateToolbarContinuous();
                  activeEditor.focus();
              }
          }
      },
      
      updateToolbarContinuous: () => {
          const toolbar = document.getElementById('continuous-toolbar');
          if(!toolbar) return;
          
          const sel = window.getSelection();
          if(!sel.rangeCount) return;
          
          const block = ScriptEditor.getBlockNode(sel.anchorNode);
          toolbar.querySelectorAll('.fmt-btn').forEach(b => b.classList.remove('active'));
          
          if(!block) return;
          const type = block.className || 'sc-action';
          const btn = toolbar.querySelector(`[data-type="${type}"]`);
          if(btn) btn.classList.add('active');
      },
      
      // Ã‰diter le titre d'une scÃ¨ne avec 3 champs sÃ©parÃ©s
      editSceneTitle: (sceneId, element) => {
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          
          const currentTitle = scene.title || 'INT. LIEU - JOUR';
          
          // Parser le titre existant : "INT. LIEU - JOUR" ou "EXT. LIEU - NUIT"
          const match = currentTitle.match(/^(INT\.|EXT\.)\s*(.+?)\s*-\s*(JOUR|NUIT|AUBE|CRÃ‰PUSCULE|MATIN|SOIR)$/i);
          let intExt = 'INT.';
          let lieu = 'LIEU';
          let moment = 'JOUR';
          
          if(match) {
              intExt = match[1].toUpperCase();
              lieu = match[2].toUpperCase();
              moment = match[3].toUpperCase();
          } else {
              // Essayer de parser autrement
              const parts = currentTitle.split(/[-â€“]/);
              if(parts.length >= 2) {
                  const firstPart = parts[0].trim();
                  moment = parts[parts.length - 1].trim().toUpperCase();
                  if(firstPart.toUpperCase().startsWith('INT')) {
                      intExt = 'INT.';
                      lieu = firstPart.replace(/^INT\.?\s*/i, '').toUpperCase();
                  } else if(firstPart.toUpperCase().startsWith('EXT')) {
                      intExt = 'EXT.';
                      lieu = firstPart.replace(/^EXT\.?\s*/i, '').toUpperCase();
                  } else {
                      lieu = firstPart.toUpperCase();
                  }
              }
          }
          
          // CrÃ©er le formulaire d'Ã©dition
          const form = document.createElement('div');
          form.style.cssText = 'display: flex; gap: 5px; align-items: center; flex-wrap: nowrap;';
          form.innerHTML = `
              <select id="edit-intext" class="n8-badge-1">
                  <option value="INT." ${intExt === 'INT.' ? 'selected' : ''}>INT.</option>
                  <option value="EXT." ${intExt === 'EXT.' ? 'selected' : ''}>EXT.</option>
              </select>
              <input type="text" id="edit-lieu" value="${lieu}" style="flex: 1; min-width: 80px; padding: 3px 5px; border: 1px solid var(--primary); border-radius: 3px; font-family: inherit; font-size: inherit; font-weight: bold; background: var(--panel-bg); color: var(--text-main); text-transform: uppercase;" />
              <span class="fw-bold">-</span>
              <select id="edit-moment" class="n8-badge-1">
                  <option value="JOUR" ${moment === 'JOUR' ? 'selected' : ''}>JOUR</option>
                  <option value="NUIT" ${moment === 'NUIT' ? 'selected' : ''}>NUIT</option>
                  <option value="AUBE" ${moment === 'AUBE' ? 'selected' : ''}>AUBE</option>
                  <option value="MATIN" ${moment === 'MATIN' ? 'selected' : ''}>MATIN</option>
                  <option value="SOIR" ${moment === 'SOIR' ? 'selected' : ''}>SOIR</option>
                  <option value="CRÃ‰PUSCULE" ${moment === 'CRÃ‰PUSCULE' ? 'selected' : ''}>CRÃ‰PUSCULE</option>
              </select>
              <button id="edit-save-btn" style="padding: 3px 8px; background: var(--primary); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">âœ“</button>
          `;
          
          const saveTitle = () => {
              const newIntExt = form.querySelector('#edit-intext').value;
              const newLieu = form.querySelector('#edit-lieu').value.trim().toUpperCase() || 'LIEU';
              const newMoment = form.querySelector('#edit-moment').value;
              const newTitle = `${newIntExt} ${newLieu} - ${newMoment}`;
              
              scene.title = newTitle;
              element.textContent = newTitle;
              Store.save();
              
              // Mettre Ã  jour partout
              UI.renderBoard();
              if(ScriptEditor.viewMode === 'continuous') {
                  ScriptEditor.updateContinuousSidebar(sceneId);
              }
              
              // Mettre Ã  jour le heading dans la vue continue
              const headingSpan = document.querySelector(`.scene-title-text[data-scene-id="${sceneId}"]`);
              if(headingSpan) headingSpan.textContent = newTitle;
              
              Utils.toast('Titre mis Ã  jour', 'success');
          };
          
          element.textContent = '';
          element.appendChild(form);
          
          // Events
          form.querySelector('#edit-save-btn').addEventListener('click', (e) => {
              e.stopPropagation();
              saveTitle();
          });
          
          form.querySelector('#edit-lieu').addEventListener('keydown', (e) => {
              if(e.key === 'Enter') {
                  e.preventDefault();
                  saveTitle();
              }
              if(e.key === 'Escape') {
                  element.textContent = currentTitle;
              }
          });
          
          // Focus sur le champ lieu
          setTimeout(() => {
              form.querySelector('#edit-lieu').focus();
              form.querySelector('#edit-lieu').select();
          }, 10);
      },
      
      // Drag & Drop pour rÃ©organiser depuis la sidebar
      draggedSceneId: null,
      
      handleSidebarDragStart: (e, sceneId) => {
          ScriptEditor.draggedSceneId = sceneId;
          e.dataTransfer.effectAllowed = 'move';
          e.target.style.opacity = '0.5';
      },
      
      handleSidebarDragEnd: (e) => {
          e.target.style.opacity = '1';
          ScriptEditor.draggedSceneId = null;
          // Retirer tous les indicateurs de drop
          document.querySelectorAll('.script-continuous-scene.drag-over').forEach(el => {
              el.classList.remove('drag-over');
          });
      },
      
      // RÃ©ordonner les scÃ¨nes en vue continue
      reorderSceneContinuous: (draggedId, targetId) => {
          const scenes = state.data.scenes;
          const draggedIndex = scenes.findIndex(s => s.id === draggedId);
          const targetIndex = scenes.findIndex(s => s.id === targetId);
          
          if(draggedIndex === -1 || targetIndex === -1) return;
          
          // Retirer la scÃ¨ne de sa position actuelle
          const [draggedScene] = scenes.splice(draggedIndex, 1);
          
          // Calculer la nouvelle position
          const newIndex = draggedIndex < targetIndex ? targetIndex : targetIndex;
          
          // InsÃ©rer Ã  la nouvelle position
          scenes.splice(newIndex, 0, draggedScene);
          
          // Sauvegarder et rafraÃ®chir
          Store.save();
          History.log('REORDER', `ScÃ¨ne "${draggedScene.title}" dÃ©placÃ©e`);
          
          // Notification de propagation
          Utils.notifyImpact('sequencer', ['scenario', 'breakdown'], 'rÃ©ordonnÃ©');
          
          // RafraÃ®chir les vues
          UI.renderBoard();
          ScriptEditor.renderContinuous();
          
          // Remettre le focus sur la scÃ¨ne dÃ©placÃ©e
          setTimeout(() => {
              ScriptEditor.setActiveScene(draggedId, newIndex);
              ScriptEditor.scrollToSceneInContinuous(draggedId);
          }, 100);
      }
  };
  
  // Initialiser le drag au chargement
  document.addEventListener('DOMContentLoaded', () => {
      ScriptEditor.initDrag();
  });
  
  // ==================== MODULE RESOURCES ====================
  const Resources = {
      currentFilter: 'all',
      
      init: () => {
          Resources.render();
      },
      
      render: () => {
          const container = document.getElementById('resourcesContainer');
          const emptyState = document.getElementById('resourcesEmpty');
          if(!container) return;
          
          const resources = state.data.resources || [];
          const filtered = Resources.currentFilter === 'all' 
              ? resources 
              : resources.filter(r => r.category === Resources.currentFilter);
          
          if(filtered.length === 0) {
              container.innerHTML = '';
              if(emptyState) emptyState.style.display = 'flex';
              return;
          }
          
          if(emptyState) emptyState.style.display = 'none';
          
          container.innerHTML = filtered.map(res => {
              const scenes = Resources.getLinkedScenes(res);
              const ownerText = Resources.getOwnerText(res);
              const categoryLabels = { accessoire: 'ðŸŽ­ Accessoire', costume: 'ðŸ‘” Costume', vehicule: 'ðŸš— VÃ©hicule' };
              
              return `
                  <div class="resource-card" data-id="${res.id}" data-category="${res.category}">
                      <div class="resource-card-photo">
                          ${res.photo ? `<img src="${res.photo}" alt="${Utils.escape(res.name)}">` : 'ðŸ“¦'}
                      </div>
                      <div class="resource-card-header">
                          <span class="resource-card-title">${Utils.escape(res.name)}</span>
                          <span class="resource-card-category ${res.category}">${categoryLabels[res.category] || res.category}</span>
                      </div>
                      <div class="resource-card-body">
                          ${res.description ? `<div class="resource-card-desc">${Utils.escape(res.description)}</div>` : ''}
                          ${ownerText ? `<div class="resource-card-info"><strong>PropriÃ©taire :</strong> ${ownerText}</div>` : ''}
                          ${res.note ? `<div class="resource-card-info"><strong>Note :</strong> ${Utils.escape(res.note)}</div>` : ''}
                          ${scenes.length > 0 ? `
                              <div class="resource-card-info"><strong>ScÃ¨nes liÃ©es :</strong></div>
                              <div class="resource-card-scenes">
                                  ${scenes.map(s => `<span class="resource-card-scene">${Utils.escape(s.title)}</span>`).join('')}
                              </div>
                          ` : ''}
                      </div>
                      <div class="resource-card-actions">
                          <button onclick="app.Resources.merge('${res.id}')" style="background:var(--locked);color:white;">ðŸ”€ Fusionner</button>
                          <button onclick="app.Resources.edit('${res.id}')" style="background:var(--primary);color:white;">âœï¸ Modifier</button>
                          <button onclick="app.Resources.delete('${res.id}')" style="background:var(--danger);color:white;">ðŸ—‘ï¸</button>
                      </div>
                  </div>
              `;
          }).join('');
      },
      
      filter: (category) => {
          Resources.currentFilter = category;
          document.querySelectorAll('.res-filter-btn').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.filter === category);
          });
          Resources.render();
      },
      
      getLinkedScenes: (resource) => {
          const scenes = [];
          const searchTerms = [resource.name.toLowerCase(), ...(resource.aliases || []).map(a => a.toLowerCase())];
          
          state.data.scenes.forEach(scene => {
              if(!scene.breakdown) return;
              const categories = ['ACCESSOIRES', 'COSTUMES', 'VEHICULES'];
              categories.forEach(cat => {
                  const items = scene.breakdown[cat] || [];
                  items.forEach(item => {
                      if(searchTerms.includes(item.toLowerCase())) {
                          if(!scenes.find(s => s.id === scene.id)) {
                              scenes.push(scene);
                          }
                      }
                  });
              });
          });
          return scenes;
      },
      
      getOwnerText: (resource) => {
          if(!resource.owner) return '';
          if(resource.owner.type === 'manual') {
              let text = resource.owner.name || '';
              if(resource.owner.address) text += ` (${resource.owner.address})`;
              return Utils.escape(text);
          } else if(resource.owner.type === 'actor') {
              const actor = state.data.actors.find(a => a.id === resource.owner.id);
              return actor ? `ðŸŽ­ ${Utils.escape(actor.name)}` : '';
          } else if(resource.owner.type === 'crew') {
              const member = state.data.crew.find(c => c.id === resource.owner.id);
              return member ? `ðŸŽ¬ ${Utils.escape(member.name)}` : '';
          }
          return '';
      },
      
      add: async () => {
          if(state.currentRole === 'viewer') return;
          
          const modalHtml = Resources.getFormHtml();
          
          const result = await UI.showModal({
              title: 'âž• Nouvelle Ressource',
              html: modalHtml,
              confirmText: 'CrÃ©er',
              onConfirm: () => Resources.saveFromForm()
          });
      },
      
      edit: async (id) => {
          if(state.currentRole === 'viewer') return;
          const resource = (state.data.resources || []).find(r => r.id === id);
          if(!resource) return;
          
          const modalHtml = Resources.getFormHtml(resource);
          
          const result = await UI.showModal({
              title: 'âœï¸ Modifier la Ressource',
              html: modalHtml,
              confirmText: 'Enregistrer',
              onConfirm: () => Resources.saveFromForm(id)
          });
      },
      
      getFormHtml: (resource = null) => {
          const actors = state.data.actors || [];
          const crew = state.data.crew || [];
          
          const ownerType = resource?.owner?.type || 'none';
          const ownerActorId = ownerType === 'actor' ? resource.owner.id : '';
          const ownerCrewId = ownerType === 'crew' ? resource.owner.id : '';
          const ownerManualName = ownerType === 'manual' ? resource.owner.name || '' : '';
          const ownerManualAddress = ownerType === 'manual' ? resource.owner.address || '' : '';
          
          return `
              <div style="display:grid; gap:15px;">
                  <div>
                      <label class="label-bold">Nom *</label>
                      <input type="text" id="res-name" value="${resource ? Utils.escape(resource.name) : ''}" class="form-input-compact" placeholder="Ex: Robe rouge, TÃ©lÃ©phone vintage...">
                  </div>
                  <div>
                      <label class="label-bold">CatÃ©gorie *</label>
                      <select id="res-category" class="form-input-compact">
                          <option value="accessoire" ${resource?.category === 'accessoire' ? 'selected' : ''}>ðŸŽ­ Accessoire</option>
                          <option value="costume" ${resource?.category === 'costume' ? 'selected' : ''}>ðŸ‘” Costume</option>
                          <option value="vehicule" ${resource?.category === 'vehicule' ? 'selected' : ''}>ðŸš— VÃ©hicule</option>
                      </select>
                  </div>
                  <div>
                      <label class="label-bold">Photo</label>
                      <input type="file" id="res-photo-input" accept="image/*" onchange="app.Resources.previewPhoto(this)" class="mb-10">
                      <div id="res-photo-preview" style="width:100%; height:150px; background:var(--bg); border-radius:6px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                          ${resource?.photo ? `<img src="${resource.photo}" style="max-width:100%; max-height:100%; object-fit:contain;">` : '<span class="text-sec">AperÃ§u photo</span>'}
                      </div>
                      <input type="hidden" id="res-photo" value="${resource?.photo || ''}">
                  </div>
                  <div>
                      <label class="label-bold">Description</label>
                      <textarea id="res-description" rows="3" class="n8-input-10" placeholder="Description dÃ©taillÃ©e...">${resource?.description || ''}</textarea>
                  </div>
                  <div>
                      <label class="label-bold">PropriÃ©taire</label>
                      <select id="res-owner-type" onchange="app.Resources.toggleOwnerFields()" class="n8-input-7">
                          <option value="none" ${ownerType === 'none' ? 'selected' : ''}>-- Aucun --</option>
                          <option value="actor" ${ownerType === 'actor' ? 'selected' : ''}>ðŸŽ­ ComÃ©dien du projet</option>
                          <option value="crew" ${ownerType === 'crew' ? 'selected' : ''}>ðŸŽ¬ Technicien du projet</option>
                          <option value="manual" ${ownerType === 'manual' ? 'selected' : ''}>âœï¸ Saisie manuelle (location, etc.)</option>
                      </select>
                      <div id="res-owner-actor" style="display:${ownerType === 'actor' ? 'block' : 'none'};">
                          <select id="res-owner-actor-id" class="form-input-compact">
                              <option value="">-- SÃ©lectionner --</option>
                              ${actors.map(a => `<option value="${a.id}" ${ownerActorId === a.id ? 'selected' : ''}>${Utils.escape(a.name)}</option>`).join('')}
                          </select>
                      </div>
                      <div id="res-owner-crew" style="display:${ownerType === 'crew' ? 'block' : 'none'};">
                          <select id="res-owner-crew-id" class="form-input-compact">
                              <option value="">-- SÃ©lectionner --</option>
                              ${crew.map(c => `<option value="${c.id}" ${ownerCrewId === c.id ? 'selected' : ''}>${Utils.escape(c.name)} (${Utils.escape(c.role || 'Technicien')})</option>`).join('')}
                          </select>
                      </div>
                      <div id="res-owner-manual" style="display:${ownerType === 'manual' ? 'block' : 'none'};">
                          <input type="text" id="res-owner-name" value="${Utils.escape(ownerManualName)}" placeholder="Nom (ex: Studio Location Paris)" class="n8-input-7">
                          <input type="text" id="res-owner-address" value="${Utils.escape(ownerManualAddress)}" placeholder="Adresse" class="form-input-compact">
                      </div>
                  </div>
                  <div>
                      <label class="label-bold">Note</label>
                      <textarea id="res-note" rows="2" class="n8-input-10" placeholder="Notes supplÃ©mentaires...">${resource?.note || ''}</textarea>
                  </div>
              </div>
          `;
      },
      
      toggleOwnerFields: () => {
          const type = document.getElementById('res-owner-type').value;
          document.getElementById('res-owner-actor').style.display = type === 'actor' ? 'block' : 'none';
          document.getElementById('res-owner-crew').style.display = type === 'crew' ? 'block' : 'none';
          document.getElementById('res-owner-manual').style.display = type === 'manual' ? 'block' : 'none';
      },
      
      previewPhoto: (input) => {
          const preview = document.getElementById('res-photo-preview');
          const hiddenInput = document.getElementById('res-photo');
          
          if(input.files && input.files[0]) {
              const reader = new FileReader();
              reader.onload = (e) => {
                  preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
                  hiddenInput.value = e.target.result;
              };
              reader.readAsDataURL(input.files[0]);
          }
      },
      
      saveFromForm: (editId = null) => {
          const name = document.getElementById('res-name').value.trim();
          const category = document.getElementById('res-category').value;
          const photo = document.getElementById('res-photo').value;
          const description = document.getElementById('res-description').value.trim();
          const note = document.getElementById('res-note').value.trim();
          
          if(!name) {
              Utils.toast('Le nom est obligatoire', 'error');
              return false;
          }
          
          // Owner
          let owner = null;
          const ownerType = document.getElementById('res-owner-type').value;
          if(ownerType === 'actor') {
              const id = document.getElementById('res-owner-actor-id').value;
              if(id) owner = { type: 'actor', id };
          } else if(ownerType === 'crew') {
              const id = document.getElementById('res-owner-crew-id').value;
              if(id) owner = { type: 'crew', id };
          } else if(ownerType === 'manual') {
              const manualName = document.getElementById('res-owner-name').value.trim();
              const manualAddress = document.getElementById('res-owner-address').value.trim();
              if(manualName) owner = { type: 'manual', name: manualName, address: manualAddress };
          }
          
          if(!state.data.resources) state.data.resources = [];
          
          if(editId) {
              const idx = state.data.resources.findIndex(r => r.id === editId);
              if(idx > -1) {
                  state.data.resources[idx] = { ...state.data.resources[idx], name, category, photo, description, note, owner };
              }
              Utils.toast('Ressource modifiÃ©e', 'success');
          } else {
              const newResource = {
                  id: 'res_' + Date.now(),
                  name,
                  category,
                  photo,
                  description,
                  note,
                  owner,
                  aliases: []
              };
              state.data.resources.push(newResource);
              Utils.toast('Ressource crÃ©Ã©e', 'success');
          }
          
          Store.save();
          Resources.render();
          return true;
      },
      
      delete: async (id) => {
          if(state.currentRole === 'viewer') return;
          
          const resource = (state.data.resources || []).find(r => r.id === id);
          if(!resource) return;
          
          // VÃ©rifier si la ressource est utilisÃ©e dans le dÃ©pouillement
          const bdCategory = RESOURCE_CAT_TO_BD[resource.category];
          const searchTerms = [resource.name.toLowerCase(), ...(resource.aliases || []).map(a => a.toLowerCase())];
          
          let usedInScenes = [];
          state.data.scenes.forEach(scene => {
              if(!scene.breakdown || !scene.breakdown[bdCategory]) return;
              scene.breakdown[bdCategory].forEach(item => {
                  if(searchTerms.includes(item.toLowerCase())) {
                      if(!usedInScenes.find(s => s.id === scene.id)) {
                          usedInScenes.push(scene);
                      }
                  }
              });
          });
          
          let message = `ÃŠtes-vous sÃ»r de vouloir supprimer "${resource.name}" ?`;
          let deleteFromBreakdown = false;
          
          if(usedInScenes.length > 0) {
              const alsoDelete = await UI.confirmModal({
                  title: 'ðŸ—‘ï¸ Supprimer la ressource',
                  message: `"${resource.name}" est utilisÃ©e dans ${usedInScenes.length} scÃ¨ne(s). Voulez-vous aussi la supprimer du dÃ©pouillement ?`,
                  confirmText: 'Supprimer partout',
                  cancelText: 'Fiche uniquement',
                  type: 'danger'
              });
              deleteFromBreakdown = alsoDelete;
          } else {
              const confirmed = await UI.confirmModal({
                  title: 'ðŸ—‘ï¸ Supprimer la ressource',
                  message: message,
                  confirmText: 'Supprimer',
                  type: 'danger'
              });
              if(!confirmed) return;
          }
          
          // Supprimer du dÃ©pouillement si demandÃ©
          if(deleteFromBreakdown) {
              state.data.scenes.forEach(scene => {
                  if(!scene.breakdown || !scene.breakdown[bdCategory]) return;
                  scene.breakdown[bdCategory] = scene.breakdown[bdCategory].filter(item => 
                      !searchTerms.includes(item.toLowerCase())
                  );
              });
          }
          
          state.data.resources = state.data.resources.filter(r => r.id !== id);
          Store.save();
          Resources.render();
          Utils.toast('Ressource supprimÃ©e', 'success');
      },
      
      link: async (id) => {
          const resource = (state.data.resources || []).find(r => r.id === id);
          if(!resource) return;
          
          // Trouver les Ã©lÃ©ments du dÃ©pouillement qui pourraient correspondre
          const bdCategory = RESOURCE_CAT_TO_BD[resource.category];
          
          const potentialMatches = [];
          state.data.scenes.forEach(scene => {
              if(!scene.breakdown || !scene.breakdown[bdCategory]) return;
              scene.breakdown[bdCategory].forEach(item => {
                  if(!potentialMatches.includes(item) && item.toLowerCase() !== resource.name.toLowerCase()) {
                      potentialMatches.push(item);
                  }
              });
          });
          
          if(potentialMatches.length === 0) {
              Utils.toast('Aucun Ã©lÃ©ment Ã  lier dans le dÃ©pouillement', 'info');
              return;
          }
          
          const checkboxes = potentialMatches.map(item => `
              <label style="display:flex; align-items:center; gap:10px; padding:8px; background:var(--bg); border-radius:6px; cursor:pointer; margin-bottom:5px;">
                  <input type="checkbox" value="${Utils.escape(item)}" ${(resource.aliases || []).includes(item) ? 'checked' : ''}>
                  <span>${Utils.escape(item)}</span>
              </label>
          `).join('');
          
          const result = await UI.showModal({
              title: `ðŸ”— Lier "${resource.name}" Ã  des Ã©lÃ©ments`,
              html: `
                  <p class="text-sec-mb15-alt">SÃ©lectionnez les Ã©lÃ©ments du dÃ©pouillement qui correspondent Ã  cette ressource :</p>
                  <div style="max-height:300px; overflow-y:auto;">
                      ${checkboxes}
                  </div>
              `,
              confirmText: 'Lier',
              onConfirm: () => {
                  const checked = Array.from(document.querySelectorAll('#modal-content input[type="checkbox"]:checked')).map(cb => cb.value);
                  resource.aliases = checked;
                  Store.save();
                  Resources.render();
                  Utils.toast('Liaisons mises Ã  jour', 'success');
                  return true;
              }
          });
      },
      
      merge: async (id) => {
          const resource = (state.data.resources || []).find(r => r.id === id);
          if(!resource) return;
          
          // Trouver les autres ressources de la mÃªme catÃ©gorie
          const others = state.data.resources.filter(r => r.id !== id && r.category === resource.category);
          
          if(others.length === 0) {
              Utils.toast('Aucune autre ressource de cette catÃ©gorie Ã  fusionner', 'info');
              return;
          }
          
          const radioButtons = others.map(r => {
              const scenes = Resources.getLinkedScenes(r);
              return `
                  <label style="display:flex; align-items:flex-start; gap:10px; padding:12px; background:var(--bg); border-radius:6px; cursor:pointer; margin-bottom:8px;">
                      <input type="radio" name="merge-target" value="${r.id}" style="margin-top:3px;">
                      <div class="flex-1">
                          <div class="fw-600">${Utils.escape(r.name)}</div>
                          ${r.description ? `<div style="font-size:0.85rem; color:var(--text-sec); margin-top:2px;">${Utils.escape(r.description.substring(0, 50))}${r.description.length > 50 ? '...' : ''}</div>` : ''}
                          ${scenes.length > 0 ? `<div style="font-size:0.8rem; color:var(--text-sec); margin-top:4px;">ðŸ“ ${scenes.length} scÃ¨ne(s)</div>` : ''}
                          ${r.photo ? '<div style="font-size:0.8rem; color:var(--success); margin-top:2px;">ðŸ“· Photo</div>' : ''}
                      </div>
                  </label>
              `;
          }).join('');
          
          const myScenes = Resources.getLinkedScenes(resource);
          
          await UI.showModal({
              title: `ðŸ”€ Fusionner "${resource.name}"`,
              html: `
                  <div style="margin-bottom:15px; padding:10px; background:var(--bg); border-radius:6px;">
                      <strong>Fiche actuelle :</strong> ${Utils.escape(resource.name)}
                      ${myScenes.length > 0 ? `<div class="text-sec-sm2">ðŸ“ ${myScenes.length} scÃ¨ne(s) liÃ©e(s)</div>` : ''}
                  </div>
                  <p class="text-sec-mb15-alt">SÃ©lectionnez la fiche avec laquelle fusionner. La fiche la plus complÃ¨te sera conservÃ©e :</p>
                  <div style="max-height:300px; overflow-y:auto;">
                      ${radioButtons}
                  </div>
              `,
              confirmText: 'Fusionner',
              type: 'warning',
              onConfirm: () => {
                  const selected = document.querySelector('input[name="merge-target"]:checked');
                  if(!selected) {
                      Utils.toast('SÃ©lectionnez une fiche Ã  fusionner', 'error');
                      return false;
                  }
                  
                  const targetId = selected.value;
                  const target = state.data.resources.find(r => r.id === targetId);
                  if(!target) return false;
                  
                  // DÃ©cider quelle fiche garder (la plus complÃ¨te)
                  const scoreResource = (r) => {
                      let score = 0;
                      if(r.photo) score += 10;
                      if(r.description) score += 5;
                      if(r.owner) score += 3;
                      if(r.note) score += 2;
                      if(!r.autoCreated) score += 5;
                      return score;
                  };
                  
                  const keepResource = scoreResource(resource) >= scoreResource(target) ? resource : target;
                  const removeResource = keepResource === resource ? target : resource;
                  
                  // Fusionner les aliases (noms alternatifs)
                  const allAliases = new Set([
                      ...(keepResource.aliases || []),
                      ...(removeResource.aliases || []),
                      removeResource.name
                  ]);
                  allAliases.delete(keepResource.name);
                  keepResource.aliases = Array.from(allAliases);
                  
                  // Mettre Ã  jour le dÃ©pouillement pour renommer les occurrences
                  const bdCategory = RESOURCE_CAT_TO_BD[keepResource.category];
                  
                  state.data.scenes.forEach(scene => {
                      if(!scene.breakdown || !scene.breakdown[bdCategory]) return;
                      scene.breakdown[bdCategory] = scene.breakdown[bdCategory].map(item => {
                          if(item.toLowerCase() === removeResource.name.toLowerCase()) {
                              return keepResource.name;
                          }
                          return item;
                      });
                      // Supprimer les doublons
                      scene.breakdown[bdCategory] = [...new Set(scene.breakdown[bdCategory])];
                  });
                  
                  // Supprimer la fiche fusionnÃ©e
                  state.data.resources = state.data.resources.filter(r => r.id !== removeResource.id);
                  
                  Store.save();
                  Resources.render();
                  Utils.toast(`Fiches fusionnÃ©es en "${keepResource.name}"`, 'success');
                  return true;
              }
          });
      }
  };
  
  const Crew = {
    addMember: async () => {
        if(state.currentRole === 'viewer') return;
        if(state.currentRole !== 'owner' && !Permissions.canEdit('equipe')) {
            Utils.toast('Vous n\'avez pas la permission d\'ajouter des techniciens.', 'error');
            return;
        }
        
        const name = await ConfirmModal.prompt("Entrez le nom du technicien.", "Nouveau technicien", "Nom...");
        if(!name) return;
        
        const newMember = {
            id: Utils.generateUniqueId(),
            name: name,
            gender: '',
            role: '',
            email: '',
            phone: '',
            address: '',
            city: '',
            photo: '',
            hasVehicle: false,
            vehicleType: '',
            vehiclePlate: '',
            vehicleSeats: '',
            vehicleTrunk: false,
            vehicleNotes: '',
            availabilityText: '',
            availabilityDates: [],
            dailyRate: '',
            rateCurrency: 'â‚¬',
            rateType: 'Jour',
            notes: '',
            group_id: '',
            demoreel: '',
            galleryPhotos: []
        };
        
        state.data.crew.push(newMember);
        Store.save();
        UI.renderCrewTab();
        
        // Afficher un message pour assigner un dÃ©partement
        Utils.toast('N\'oubliez pas d\'assigner un dÃ©partement au technicien !', 'info');
    },
    
    // AppelÃ©e quand on assigne un groupe Ã  un technicien (depuis updateMember ou ici)
    syncCrewMemberToScenes: (member) => {
        if(!member || !member.name) return;
        
        const essentialGroups = ['gc1', 'gc3', 'gc4']; // Image, RÃ©alisation, Son
        
        // Si le technicien est dans un groupe essentiel, l'ajouter Ã  toutes les scÃ¨nes
        if(essentialGroups.includes(member.group_id)) {
            state.data.scenes.forEach(scene => {
                if(!scene.breakdown) scene.breakdown = {};
                if(!scene.breakdown['TECHNICIENS']) scene.breakdown['TECHNICIENS'] = [];
                if(!scene.breakdown['TECHNICIENS'].includes(member.name)) {
                    scene.breakdown['TECHNICIENS'].push(member.name);
                }
            });
        }
        
        // Si le technicien est dans un groupe avec responsabilitÃ© catÃ©gorie, 
        // l'ajouter aux scÃ¨nes qui ont des Ã©lÃ©ments de cette catÃ©gorie
        const categories = CONFIG.crewToBreakdownMap[member.group_id];
        if(categories) {
            state.data.scenes.forEach(scene => {
                if(!scene.breakdown) return;
                
                // VÃ©rifier si la scÃ¨ne a des Ã©lÃ©ments dans une des catÃ©gories gÃ©rÃ©es
                const hasItems = categories.some(cat => 
                    scene.breakdown[cat] && scene.breakdown[cat].length > 0
                );
                
                if(hasItems) {
                    if(!scene.breakdown['TECHNICIENS']) scene.breakdown['TECHNICIENS'] = [];
                    if(!scene.breakdown['TECHNICIENS'].includes(member.name)) {
                        scene.breakdown['TECHNICIENS'].push(member.name);
                    }
                }
            });
        }
    },
    
    // Synchroniser les techniciens essentiels vers toutes les scÃ¨nes
    syncEssentialCrewToScenes: () => {
        const essentialGroups = ['gc1', 'gc3', 'gc4']; // Image, RÃ©alisation, Son
        const essentialMembers = state.data.crew.filter(c => essentialGroups.includes(c.group_id));
        
        state.data.scenes.forEach(scene => {
            if(!scene.breakdown) scene.breakdown = {};
            if(!scene.breakdown['TECHNICIENS']) scene.breakdown['TECHNICIENS'] = [];
            
            essentialMembers.forEach(member => {
                if(!scene.breakdown['TECHNICIENS'].includes(member.name)) {
                    scene.breakdown['TECHNICIENS'].push(member.name);
                }
            });
        });
    },
    
    confirmDeleteMember: async (idx) => { if(await ConfirmModal.confirmDelete("Ce technicien sera retirÃ© du projet.")) { Crew.deleteMember(idx); } },
        
        deleteMember: async (idx) => {
        if(state.currentRole === 'viewer') return;
        // Confirmation dÃ©jÃ  faite dans confirmDeleteMember si appelÃ© depuis le bouton
        
        // RÃ©cupÃ©rer l'ID du membre avant suppression
        const memberId = state.data.crew[idx]?.id;
        
        // Retirer des feuilles de service (callSheet) de tous les jours de tournage
        if(memberId && state.data.shootingDays) {
            state.data.shootingDays.forEach(day => {
                if(day.callSheet) {
                    day.callSheet = day.callSheet.filter(
                        call => !(call.personId === memberId && call.type === 'crew')
                    );
                }
            });
        }
        
        // Supprimer les dÃ©penses de salaire associÃ©es
        if(memberId && state.data.expenses) {
            state.data.expenses = state.data.expenses.filter(
                e => !(e.salaryPersonId === memberId && e.salaryPersonType === 'crew')
            );
        }
        
        state.data.crew.splice(idx, 1);
        Store.save();
        UI.renderCrewTab();
    },
    
    updateMember: (idx, field, value) => {
        if(state.currentRole === 'viewer') return;
        if(!state.data.crew[idx]) return;
        
        const oldVal = state.data.crew[idx][field];
        state.data.crew[idx][field] = value;
        Store.save();
        
        // Re-render role dropdown if group changed
        if(field === 'group_id') {
            UI.renderCrewTab();
            
            // Synchroniser le technicien vers les scÃ¨nes appropriÃ©es
            const member = state.data.crew[idx];
            if(member) {
                Crew.syncCrewMemberToScenes(member);
                Store.save();
            }
        }
        
        // Si on ajoute un email valide, vÃ©rifier si un profil public existe
        if(field === 'email' && value && value.includes('@') && value !== oldVal) {
            Actions.checkAndLinkPublicProfile(value, 'crew', idx).then(found => {
                if(!found) {
                    // Pas de profil existant, proposer de notifier pour crÃ©er
                    const member = state.data.crew[idx];
                    setTimeout(async () => {
                        if(await ConfirmModal.show({ title: 'Envoyer une invitation ?', message: `Aucun profil technicien trouvÃ© pour ${value}.\n\nEnvoyer une invitation Ã  ${member.name} pour crÃ©er son profil ?`, icon: 'ðŸ“¨', confirmText: 'Inviter' })) {
                            Actions.notifyNewProfile(member, 'crew');
                        }
                    }, 300);
                }
            });
        }
    },
    
    toggleVehicle: (idx, hasVehicle) => {
        if(state.currentRole === 'viewer') return;
        if(!state.data.crew[idx]) return;
        
        state.data.crew[idx].hasVehicle = hasVehicle;
        Store.save();
        
        const vehicleDetails = document.getElementById(`crew-vehicle-${idx}`);
        if(vehicleDetails) {
            if(hasVehicle) {
                vehicleDetails.classList.add('visible');
            } else {
                vehicleDetails.classList.remove('visible');
            }
        }
    },
    
    addGalleryPhoto: (idx) => {
        if(state.currentRole === 'viewer') return;
        const input = document.getElementById(`crew-gallery-input-${idx}`);
        if(!input || !input.value.trim()) { Utils.toast('Veuillez entrer une URL de photo.', 'warning'); return; }
        if(!state.data.crew[idx].galleryPhotos) state.data.crew[idx].galleryPhotos = [];
        state.data.crew[idx].galleryPhotos.push(input.value.trim());
        Store.save();
        UI.renderCrewTab();
    },
    
    removeGalleryPhoto: (crewIdx, photoIdx) => {
        if(state.currentRole === 'viewer') return;
        if(state.data.crew[crewIdx] && state.data.crew[crewIdx].galleryPhotos) {
            state.data.crew[crewIdx].galleryPhotos.splice(photoIdx, 1);
            Store.save();
            UI.renderCrewTab();
        }
    },
    
    addAvailabilityDate: (idx) => {
        const dateFrom = document.getElementById(`crew-date-from-${idx}`).value;
        const dateTo = document.getElementById(`crew-date-to-${idx}`).value;
        
        if(!dateFrom) {
            Utils.toast('Veuillez sÃ©lectionner au moins une date de dÃ©but.', 'warning');
            return;
        }
        
        if(!state.data.crew[idx].availabilityDates) {
            state.data.crew[idx].availabilityDates = [];
        }
        
        state.data.crew[idx].availabilityDates.push({
            from: dateFrom,
            to: dateTo || dateFrom
        });
        
        Store.save();
        UI.renderCrewTab();
    },
    
    removeAvailabilityDate: (memberIdx, dateIdx) => {
        if(state.data.crew[memberIdx] && state.data.crew[memberIdx].availabilityDates) {
            state.data.crew[memberIdx].availabilityDates.splice(dateIdx, 1);
            Store.save();
            UI.renderCrewTab();
        }
    },
    
    addUnavailabilityDate: (memberIdx) => {
        const from = document.getElementById(`crew-unavail-from-${memberIdx}`)?.value;
        const to = document.getElementById(`crew-unavail-to-${memberIdx}`)?.value;
        const reason = document.getElementById(`crew-unavail-reason-${memberIdx}`)?.value || '';
        
        if(!from || !to) {
            Utils.toast('Veuillez sÃ©lectionner les dates de dÃ©but et fin', 'warning');
            return;
        }
        if(from > to) {
            Utils.toast('La date de fin doit Ãªtre aprÃ¨s la date de dÃ©but', 'warning');
            return;
        }
        
        if(!state.data.crew[memberIdx].unavailabilityDates) {
            state.data.crew[memberIdx].unavailabilityDates = [];
        }
        
        state.data.crew[memberIdx].unavailabilityDates.push({ from, to, reason });
        Store.save();
        UI.renderCrewTab();
        Utils.toast('IndisponibilitÃ© ajoutÃ©e', 'success');
    },
    
    removeUnavailabilityDate: (memberIdx, dateIdx) => {
        if(state.data.crew[memberIdx] && state.data.crew[memberIdx].unavailabilityDates) {
            state.data.crew[memberIdx].unavailabilityDates.splice(dateIdx, 1);
            Store.save();
            UI.renderCrewTab();
        }
    },
    
    addCustomRole: async (groupId) => {
        const newRole = await ConfirmModal.prompt("Entrez le nom de la nouvelle fonction.", "Nouvelle fonction", "Ex: Chef Ã©lectricien...");
        if(!newRole) return;
        
        if(!CONFIG.crewRoles[groupId]) {
            CONFIG.crewRoles[groupId] = [];
        }
        
        if(!CONFIG.crewRoles[groupId].includes(newRole)) {
            CONFIG.crewRoles[groupId].push(newRole);
        }
        
        return newRole;
    },
    
    getRolesForGroup: (groupId) => {
        return CONFIG.crewRoles[groupId] || [];
    },
    
    // ========== EXPORT PDF Ã‰QUIPE ==========
    exportPDF: () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = margin;
        
        const projectTitle = state.data.title || 'Projet sans titre';
        const crew = state.data.crew || [];
        const actors = state.data.actors || [];
        
        if(crew.length === 0 && actors.length === 0) {
            Utils.toast('Aucun membre d\'Ã©quipe Ã  exporter', 'warning');
            return;
        }
        
        // ===== PAGE DE TITRE =====
        doc.setFillColor(43, 110, 246);
        doc.rect(0, 0, pageWidth, 50, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text('Ã‰QUIPE DU FILM', pageWidth / 2, 25, { align: 'center' });
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'normal');
        doc.text(projectTitle, pageWidth / 2, 38, { align: 'center' });
        
        y = 60;
        
        // Statistiques
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`${actors.length} comÃ©dien(s) â€¢ ${crew.length} technicien(s)`, pageWidth / 2, y, { align: 'center' });
        y += 15;
        
        // ===== COMÃ‰DIENS =====
        if(actors.length > 0) {
            doc.setFillColor(76, 175, 80);
            doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`ðŸŽ­ COMÃ‰DIENS (${actors.length})`, margin + 5, y + 7);
            y += 15;
            
            // En-tÃªtes du tableau
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(80, 80, 80);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('ComÃ©dien', margin + 3, y + 5.5);
            doc.text('RÃ´le', margin + 55, y + 5.5);
            doc.text('TÃ©lÃ©phone', margin + 100, y + 5.5);
            doc.text('Email', margin + 135, y + 5.5);
            y += 10;
            
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);
            
            actors.forEach((actor, idx) => {
                if(y > pageHeight - 20) {
                    doc.addPage();
                    y = margin;
                }
                
                if(idx % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(margin, y - 4, pageWidth - margin * 2, 8, 'F');
                }
                
                const character = state.data.characters?.find(c => c.id === actor.characterId);
                
                doc.setFontSize(8);
                doc.text((actor.name || '-').substring(0, 28), margin + 3, y);
                doc.text((character?.name || '-').substring(0, 22), margin + 55, y);
                doc.text((actor.phone || '-').substring(0, 18), margin + 100, y);
                doc.setTextColor(43, 110, 246);
                doc.text((actor.email || '-').substring(0, 28), margin + 135, y);
                doc.setTextColor(50, 50, 50);
                
                y += 7;
            });
            
            y += 10;
        }
        
        // ===== Ã‰QUIPE TECHNIQUE =====
        if(crew.length > 0) {
            if(y > pageHeight - 50) {
                doc.addPage();
                y = margin;
            }
            
            // Grouper par dÃ©partement
            const byDepartment = {};
            crew.forEach(member => {
                const dept = member.department || 'Autre';
                if(!byDepartment[dept]) byDepartment[dept] = [];
                byDepartment[dept].push(member);
            });
            
            const deptColors = {
                'RÃ©alisation': [156, 39, 176],
                'Image': [33, 150, 243],
                'Son': [0, 188, 212],
                'LumiÃ¨re': [255, 193, 7],
                'DÃ©cor': [121, 85, 72],
                'HMC': [233, 30, 99],
                'RÃ©gie': [255, 152, 0],
                'Post-production': [96, 125, 139],
                'Production': [76, 175, 80]
            };
            
            Object.entries(byDepartment).forEach(([dept, members]) => {
                if(y > pageHeight - 40) {
                    doc.addPage();
                    y = margin;
                }
                
                const rgb = deptColors[dept] || [100, 100, 100];
                
                // En-tÃªte dÃ©partement
                doc.setFillColor(rgb[0], rgb[1], rgb[2]);
                doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(`${dept.toUpperCase()} (${members.length})`, margin + 5, y + 7);
                y += 12;
                
                // En-tÃªtes du tableau
                doc.setFillColor(245, 245, 245);
                doc.rect(margin, y, pageWidth - margin * 2, 7, 'F');
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('Nom', margin + 3, y + 5);
                doc.text('Fonction', margin + 50, y + 5);
                doc.text('TÃ©lÃ©phone', margin + 100, y + 5);
                doc.text('Email', margin + 135, y + 5);
                y += 9;
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(50, 50, 50);
                
                members.forEach((member, idx) => {
                    if(y > pageHeight - 15) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    if(idx % 2 === 0) {
                        doc.setFillColor(252, 252, 252);
                        doc.rect(margin, y - 3.5, pageWidth - margin * 2, 7, 'F');
                    }
                    
                    doc.setFontSize(8);
                    doc.text((member.name || '-').substring(0, 25), margin + 3, y);
                    doc.text((member.role || '-').substring(0, 25), margin + 50, y);
                    doc.text((member.phone || '-').substring(0, 18), margin + 100, y);
                    doc.setTextColor(43, 110, 246);
                    doc.text((member.email || '-').substring(0, 28), margin + 135, y);
                    doc.setTextColor(50, 50, 50);
                    
                    y += 7;
                });
                
                y += 8;
            });
        }
        
        // ===== PIED DE PAGE =====
        const totalPages = doc.internal.getNumberOfPages();
        for(let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`${projectTitle} - Ã‰quipe`, margin, pageHeight - 8);
            doc.text(`Page ${i}/${totalPages}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
            doc.text(`GÃ©nÃ©rÃ© par Moteur - ${new Date().toLocaleDateString('fr-FR')}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
        }
        
        // TÃ©lÃ©charger
        const filename = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'equipe') + '_equipe.pdf';
        doc.save(filename);
        
        Utils.toast('Ã‰quipe PDF exportÃ©e !', 'success');
        History.log('EXPORT', 'Ã‰quipe PDF gÃ©nÃ©rÃ©e');
    }
};

const PublicProfile = {
    profiles: [], // Liste des profils de l'utilisateur
    currentProfileIndex: -1, // Index du profil actuellement affichÃ©
    equipment: { cameras: [], lenses: [], lights: [], sounds: [], grips: [], makeups: [], other: [] },
    profileProjects: {}, // Mapping profileId -> [{projectId, projectTitle, role}]
    
    // Charge les projets associÃ©s Ã  chaque profil
    loadProfileProjects: async () => {
        PublicProfile.profileProjects = {};
        if(!state.currentUser || PublicProfile.profiles.length === 0) return;
        
        try {
            const projectsList = await Store.getProjectsList();
            
            for(const project of projectsList) {
                // Charger les donnÃ©es complÃ¨tes du projet (actors + crew)
                const { data: projectData } = await supabase
                    .from('projects')
                    .select('data')
                    .eq('id', project.id)
                    .single();
                const data = projectData?.data;
                if(!data) continue;
                
                const projectInfo = { projectId: project.id, projectTitle: project.title || 'Sans titre' };
                
                // VÃ©rifier les acteurs
                if(data.actors && Array.isArray(data.actors)) {
                    data.actors.forEach(actor => {
                        if(actor.publicProfileId) {
                            if(!PublicProfile.profileProjects[actor.publicProfileId]) {
                                PublicProfile.profileProjects[actor.publicProfileId] = [];
                            }
                            // Ã‰viter les doublons
                            if(!PublicProfile.profileProjects[actor.publicProfileId].some(p => p.projectId === project.id)) {
                                PublicProfile.profileProjects[actor.publicProfileId].push({ ...projectInfo, role: 'actor' });
                            }
                        }
                    });
                }
                
                // VÃ©rifier les techniciens
                if(data.crew && Array.isArray(data.crew)) {
                    data.crew.forEach(member => {
                        if(member.publicProfileId) {
                            if(!PublicProfile.profileProjects[member.publicProfileId]) {
                                PublicProfile.profileProjects[member.publicProfileId] = [];
                            }
                            // Ã‰viter les doublons
                            if(!PublicProfile.profileProjects[member.publicProfileId].some(p => p.projectId === project.id)) {
                                PublicProfile.profileProjects[member.publicProfileId].push({ ...projectInfo, role: 'crew' });
                            }
                        }
                    });
                }
            }
        } catch(e) {
            console.error('Erreur chargement projets profils:', e);
        }
    },
    
    // Gestion de la visibilitÃ© des sections
    toggleVisibility: (section, scope) => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) {
            Utils.toast('Veuillez d\'abord sÃ©lectionner un profil', 'warning');
            return;
        }
        
        // Initialiser les tableaux si nÃ©cessaire
        if(!profile.hiddenPublic) profile.hiddenPublic = [];
        if(!profile.hiddenProject) profile.hiddenProject = [];
        
        const hiddenArray = scope === 'public' ? profile.hiddenPublic : profile.hiddenProject;
        const index = hiddenArray.indexOf(section);
        
        if(index > -1) {
            // Section cachÃ©e -> la rendre visible
            hiddenArray.splice(index, 1);
        } else {
            // Section visible -> la cacher
            hiddenArray.push(section);
        }
        
        // Mettre Ã  jour l'affichage des boutons
        PublicProfile.updateVisibilityButtons();
        
        // Sauvegarder automatiquement
        PublicProfile.save();
    },
    
    updateVisibilityButtons: () => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        const hiddenPublic = profile.hiddenPublic || [];
        const hiddenProject = profile.hiddenProject || [];
        
        // Mettre Ã  jour tous les boutons
        document.querySelectorAll('.visibility-btn').forEach(btn => {
            const section = btn.dataset.section;
            const scope = btn.dataset.scope;
            
            const hiddenArray = scope === 'public' ? hiddenPublic : hiddenProject;
            const isHidden = hiddenArray.includes(section);
            
            btn.classList.toggle('hidden-section', isHidden);
            
            // Mettre Ã  jour l'icÃ´ne
            const icon = btn.querySelector('.vis-icon');
            if(icon) {
                icon.textContent = isHidden ? 'ðŸ‘ï¸â€ðŸ—¨ï¸' : 'ðŸ‘ï¸';
            }
            
            // Mettre Ã  jour le title
            const scopeLabel = scope === 'public' ? 'public (Univers)' : 'projet (Ã©quipe)';
            btn.title = isHidden ? `Section cachÃ©e en ${scopeLabel} - Cliquer pour afficher` : `Section visible en ${scopeLabel} - Cliquer pour cacher`;
        });
    },
    
    open: async () => {
        UI.hideAllViews();
        els.publicProfileView.classList.add('active');
        
        // Charger les messages
        Messages.load();
        
        // Afficher l'onglet profil par dÃ©faut
        PublicProfile.showTab('profile');
        
        document.getElementById('profile-title').textContent = 'ðŸŽ­ Mes Profils Publics';
        
        // Charger les profils depuis Firebase
        await PublicProfile.loadProfiles();
        
        // Charger les projets liÃ©s aux profils
        await PublicProfile.loadProfileProjects();
        
        // Charger les profils Ã  revendiquer
        await PublicProfile.loadPendingClaims();
        
        // RÃ©initialiser les filtres de messages maintenant que les profils sont chargÃ©s
        Messages.initFilters();
        
        // Afficher les onglets de profils
        PublicProfile.renderProfileTabs();
        
        // Afficher le premier profil ou le message "nouveau profil"
        if(PublicProfile.profiles.length > 0) {
            PublicProfile.currentProfileIndex = 0;
            PublicProfile.loadProfileToForm(PublicProfile.profiles[0]);
            document.getElementById('no-profile-message').style.display = 'none';
            document.getElementById('profile-all-sections').style.display = 'block';
        } else {
            PublicProfile.currentProfileIndex = -1;
            document.getElementById('no-profile-message').style.display = 'block';
            document.getElementById('profile-all-sections').style.display = 'none';
        }
        // Afficher le conteneur maintenant que tout est chargÃ©
        document.getElementById('current-profile-content').style.display = 'block';
        
        // Charger mes actualitÃ©s
        PublicProfile.loadMyActualites();
    },
    
    close: () => {
        UI.hideAllViews();
        els.dashboardView.style.display = 'flex';
    },
    
	deleteAccount: async () => {
        const confirm1 = await ConfirmModal.show({ title: 'âš ï¸ Supprimer votre compte ?', message: 'Vous allez supprimer dÃ©finitivement votre compte.\n\nTous vos projets dont vous Ãªtes propriÃ©taire seront supprimÃ©s.\n\nCette action est IRRÃ‰VERSIBLE.', icon: 'â˜ ï¸', dangerous: true, confirmText: 'Continuer' });
        if(!confirm1) return;
        
        const confirm2 = await ConfirmModal.prompt('Pour confirmer, tapez "SUPPRIMER" :', "Confirmation finale", "SUPPRIMER");
        if(confirm2 !== 'SUPPRIMER') {
            Utils.toast('Suppression annulÃ©e.', 'info');
            return;
        }
        
        try {
            const email = state.currentUser.email.toLowerCase();
            
            // 1. Supprimer les projets dont l'utilisateur est propriÃ©taire
            await supabase.from('projects').delete().eq('owner_email', email);
            
            // 2. Supprimer les participations aux projets
            await supabase.from('project_members').delete().eq('email', email);
            
            // 3. Supprimer le profil utilisateur
            await supabase.from('user_profiles').delete().eq('email', email);
            
            // 4. Supprimer les messages
            await supabase.from('messages').delete().or(`from_email.eq.${email},to_email.eq.${email}`);
            
            // 5. Supprimer les notifications
            await supabase.from('notifications').delete().eq('user_email', email);
            
            // 6. Supprimer les contacts
            await supabase.from('contacts').delete().eq('owner_email', email);
            
            // 7. Supprimer le compte Supabase Auth
            // Note: La suppression du compte auth doit Ãªtre faite cÃ´tÃ© serveur ou via le dashboard
            await supabase.auth.signOut();
            
            // Compte supprimÃ© avec succÃ¨s
            
            Utils.toast('Votre compte a Ã©tÃ© supprimÃ©. Au revoir !', 'success');
            window.location.reload();
            
        } catch(e) {
            console.error('Erreur suppression compte:', e);
            if(e.code === 'auth/requires-recent-login') {
                Utils.toast('Pour des raisons de sÃ©curitÃ©, veuillez vous dÃ©connecter, vous reconnecter, puis rÃ©essayer.', 'warning');
            } else {
                Utils.toast('Erreur lors de la suppression : ' + e.message, 'error');
            }
        }
    },
	
	updateGallery: (index, url) => {
        const item = document.getElementById('gallery-item-' + index);
        if(!item) return;
        
        if(url && url.trim()) {
            item.innerHTML = `
                <img src="${url}" alt="Photo ${index + 1}" onerror="this.parentElement.innerHTML='<span class=\\'gallery-placeholder\\'>+</span>'">
                <button class="gallery-remove" onclick="event.stopPropagation(); app.PublicProfile.removeGalleryPhoto(${index})">âœ•</button>
            `;
        } else {
            item.innerHTML = '<span class="gallery-placeholder">+</span>';
        }
    },
    
    uploadGalleryPhoto: async (index, event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const item = document.getElementById('gallery-item-' + index);
        const input = document.getElementById('gallery-input-' + index);
        
        if (!file.type.startsWith('image/')) {
            Utils.toast('Fichier non valide', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            Utils.toast('Fichier trop volumineux (max 5 Mo)', 'error');
            return;
        }
        
        item.innerHTML = '<span class="gallery-placeholder">â³</span>';
        
        try {
            const compressedBlob = await PublicProfile.compressImageToBlob(file, 800, 0.8);
            const userId = state.currentUser.id;
            const fileName = `gallery_${index}_${Date.now()}.jpg`;
            const filePath = `${userId}/${fileName}`;
            
            // Supprimer l'ancienne photo si elle existe
            const oldUrl = input.value;
            if (oldUrl && oldUrl.includes('supabase')) {
                const oldPath = oldUrl.split('/gallery/')[1];
                if (oldPath) {
                    await supabase.storage.from('gallery').remove([oldPath]);
                }
            }
            
            const { data, error } = await supabase.storage
                .from('gallery')
                .upload(filePath, compressedBlob, {
                    contentType: 'image/jpeg',
                    upsert: true
                });
            
            if (error) throw error;
            
            const { data: urlData } = supabase.storage
                .from('gallery')
                .getPublicUrl(filePath);
            
            input.value = urlData.publicUrl;
            PublicProfile.updateGallery(index, urlData.publicUrl);
            Utils.toast('Photo uploadÃ©e', 'success');
        } catch (err) {
            console.error('Erreur upload galerie:', err);
            item.innerHTML = '<span class="gallery-placeholder">+</span>';
            Utils.toast('Erreur lors de l\'upload', 'error');
        }
    },
    
    removeGalleryPhoto: async (index) => {
        const input = document.getElementById('gallery-input-' + index);
        if(input) {
            // Supprimer du storage si c'est une URL Supabase
            const url = input.value;
            if (url && url.includes('supabase')) {
                const path = url.split('/gallery/')[1];
                if (path) {
                    await supabase.storage.from('gallery').remove([path]);
                }
            }
            input.value = '';
            PublicProfile.updateGallery(index, '');
        }
    },
    
    loadGallery: (photos) => {
        if(!photos) photos = [];
        for(let i = 0; i < 3; i++) {
            const input = document.getElementById('gallery-input-' + i);
            if(input) {
                input.value = photos[i] || '';
                PublicProfile.updateGallery(i, photos[i] || '');
            }
        }
    },
    
    // Galerie photos techniciens
    updateCrewGallery: (index, url) => {
        const item = document.getElementById('crew-gallery-item-' + index);
        if(!item) return;
        
        if(url && url.trim()) {
            item.innerHTML = `
                <img src="${url}" alt="Photo ${index + 1}" onerror="this.parentElement.innerHTML='<span class=\\'gallery-placeholder\\'>+</span>'">
                <button class="gallery-remove" onclick="event.stopPropagation(); app.PublicProfile.removeCrewGalleryPhoto(${index})">âœ•</button>
            `;
        } else {
            item.innerHTML = '<span class="gallery-placeholder">+</span>';
        }
    },
    
    uploadCrewGalleryPhoto: async (index, event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const item = document.getElementById('crew-gallery-item-' + index);
        const input = document.getElementById('crew-gallery-input-' + index);
        
        if (!file.type.startsWith('image/')) {
            Utils.toast('Fichier non valide', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            Utils.toast('Fichier trop volumineux (max 5 Mo)', 'error');
            return;
        }
        
        item.innerHTML = '<span class="gallery-placeholder">â³</span>';
        
        try {
            const compressedBlob = await PublicProfile.compressImageToBlob(file, 800, 0.8);
            const userId = state.currentUser.id;
            const fileName = `crew_gallery_${index}_${Date.now()}.jpg`;
            const filePath = `${userId}/${fileName}`;
            
            // Supprimer l'ancienne photo si elle existe
            const oldUrl = input.value;
            if (oldUrl && oldUrl.includes('supabase')) {
                const oldPath = oldUrl.split('/gallery/')[1];
                if (oldPath) {
                    await supabase.storage.from('gallery').remove([oldPath]);
                }
            }
            
            const { data, error } = await supabase.storage
                .from('gallery')
                .upload(filePath, compressedBlob, {
                    contentType: 'image/jpeg',
                    upsert: true
                });
            
            if (error) throw error;
            
            const { data: urlData } = supabase.storage
                .from('gallery')
                .getPublicUrl(filePath);
            
            input.value = urlData.publicUrl;
            PublicProfile.updateCrewGallery(index, urlData.publicUrl);
            Utils.toast('Photo uploadÃ©e', 'success');
        } catch (err) {
            console.error('Erreur upload galerie crew:', err);
            item.innerHTML = '<span class="gallery-placeholder">+</span>';
            Utils.toast('Erreur lors de l\'upload', 'error');
        }
    },
    
    removeCrewGalleryPhoto: async (index) => {
        const input = document.getElementById('crew-gallery-input-' + index);
        if(input) {
            // Supprimer du storage si c'est une URL Supabase
            const url = input.value;
            if (url && url.includes('supabase')) {
                const path = url.split('/gallery/')[1];
                if (path) {
                    await supabase.storage.from('gallery').remove([path]);
                }
            }
            input.value = '';
            PublicProfile.updateCrewGallery(index, '');
        }
    },
    
    loadCrewGallery: (photos) => {
        if(!photos) photos = [];
        for(let i = 0; i < 3; i++) {
            const input = document.getElementById('crew-gallery-input-' + i);
            if(input) {
                input.value = photos[i] || '';
                PublicProfile.updateCrewGallery(i, photos[i] || '');
            }
        }
    },
	
	// Affiche/masque une section de matÃ©riel
    toggleEquipmentSection: (section) => {
        const sectionEl = document.getElementById('equip-section-' + section);
        const checkbox = document.getElementById('show-equip-' + section);
        if(sectionEl && checkbox) {
            sectionEl.style.display = checkbox.checked ? 'block' : 'none';
        }
    },
    
	// Affiche les onglets de profils
    renderProfileTabs: () => {
        const container = document.getElementById('profile-tabs-container');
        if(!container) return;
        
        let html = '';
        
        PublicProfile.profiles.forEach((profile, idx) => {
            const isActive = idx === PublicProfile.currentProfileIndex;
            const icon = profile.type === 'actor' ? 'ðŸŽ­' : profile.type === 'crew' ? 'ðŸŽ¥' : profile.type === 'association' ? 'ðŸ›ï¸' : profile.type === 'enterprise' ? 'ðŸ¢' : 'â³';
            const label = profile.type === 'actor' ? (profile.name || 'ComÃ©dien') : 
                          profile.type === 'crew' ? (profile.role || profile.department || 'Technicien') : 
                          profile.type === 'association' ? (profile.assoName || 'Association') :
                          profile.type === 'enterprise' ? (profile.entName || 'Entreprise') : 'Profil en attente';
            
            // RÃ©cupÃ©rer les projets liÃ©s Ã  ce profil
            const linkedProjects = PublicProfile.profileProjects[profile.id] || [];
            let projectBadgesHtml = '';
            if(linkedProjects.length > 0) {
                projectBadgesHtml = '<div class="profile-project-badges">' + 
                    linkedProjects.map(p => `<span class="profile-project-badge" onclick="event.stopPropagation(); app.Store.loadProject('${p.projectId}')" title="Ouvrir ${Utils.escape(p.projectTitle)}">ðŸŽ¬ ${Utils.escape(p.projectTitle)}</span>`).join('') + 
                '</div>';
            }
            
            html += `<div class="profile-tab-card ${isActive ? 'active' : ''}" onclick="app.PublicProfile.switchToProfile(${idx})">
                <div class="profile-tab-header">${icon} ${Utils.escape(label)}</div>
                ${projectBadgesHtml}
            </div>`;
        });
        
        // Bouton ajouter un profil
        html += `<div class="profile-tab-card add-profile" onclick="app.PublicProfile.createNewProfile()">
            <div class="profile-tab-header">âž• Nouveau profil</div>
        </div>`;
        
        container.innerHTML = html;
    },
    
    // CrÃ©e un nouveau profil
    createNewProfile: () => {
        // GÃ©nÃ©rer les disponibilitÃ©s par dÃ©faut (lun-ven pour les 3 prochains mois)
        const defaultAvailability = PublicProfile.generateDefaultAvailability();
        
        const newProfile = {
            id: 'profile_' + Date.now(),
            type: '', // sera dÃ©fini par l'utilisateur
            name: '',
            photo: '',
            gender: '',
            phone: '',
            city: '',
            website: '',
            bio: '',
            // Champs comÃ©dien
            galleryPhotos: [],
            height: '',
            weight: '',
            age: '',
            eyeColor: '',
            hairColor: '',
            hairLength: '',
            ethnicity: '',
            corpulence: '',
            sports: '',
            languages: '',
            // Champs technicien
            department: '',
            role: '',
            cameras: [],
            lenses: [],
            lights: [],
            sounds: [],
            grips: [],
            makeups: [],
            otherEquipment: [],
            // Commun
            dailyRate: '',
            rateCurrency: 'â‚¬',
            availabilityText: '',
            availabilityDates: defaultAvailability,
            unavailabilityDates: [],
            hasVehicle: false,
            vehicleType: '',
            vehicleSeats: '',
            vehicleTrunk: false,
            profileComplete: false,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        PublicProfile.profiles.push(newProfile);
        PublicProfile.currentProfileIndex = PublicProfile.profiles.length - 1;
        PublicProfile.renderProfileTabs();
        PublicProfile.loadProfileToForm(newProfile);
        
        // Afficher le formulaire
        document.getElementById('no-profile-message').style.display = 'none';
        document.getElementById('profile-all-sections').style.display = 'block';
    },
    
    // GÃ©nÃ¨re les disponibilitÃ©s par dÃ©faut (lun-ven pour les 3 prochains mois)
    generateDefaultAvailability: () => {
        const availability = [];
        const today = new Date();
        const endDate = new Date(today);
        endDate.setFullYear(endDate.getFullYear() + 1); // 1 an au lieu de 3 mois
        
        let currentWeekStart = null;
        let currentWeekEnd = null;
        
        const formatDate = (d) => d.toISOString().split('T')[0];
        
        // Parcourir chaque jour de la prochaine annÃ©e
        const current = new Date(today);
        while(current <= endDate) {
            const dayOfWeek = current.getDay(); // 0=dim, 1=lun, ..., 5=ven, 6=sam
            
            if(dayOfWeek >= 1 && dayOfWeek <= 5) { // Lundi Ã  Vendredi
                if(currentWeekStart === null) {
                    currentWeekStart = new Date(current);
                }
                currentWeekEnd = new Date(current);
            } else {
                // Weekend : finaliser la pÃ©riode en cours
                if(currentWeekStart !== null) {
                    availability.push({
                        from: formatDate(currentWeekStart),
                        to: formatDate(currentWeekEnd)
                    });
                    currentWeekStart = null;
                    currentWeekEnd = null;
                }
            }
            
            current.setDate(current.getDate() + 1);
        }
        
        // Finaliser la derniÃ¨re pÃ©riode si nÃ©cessaire
        if(currentWeekStart !== null) {
            availability.push({
                from: formatDate(currentWeekStart),
                to: formatDate(currentWeekEnd)
            });
        }
        
        return availability;
    },
    
    // ========== LANGUES ET SPORTS AVEC NIVEAUX ==========
    languageLevels: {
        'notions': 'ðŸ“˜ Notions',
        'intermediaire': 'ðŸ“— IntermÃ©diaire', 
        'courant': 'ðŸ“™ Courant',
        'bilingue': 'ðŸ“• Bilingue',
        'maternelle': 'ðŸ  Maternelle'
    },
    sportLevels: {
        'debutant': 'ðŸŒ± DÃ©butant',
        'amateur': 'â­ Amateur',
        'confirme': 'â­â­ ConfirmÃ©',
        'competition': 'ðŸ† CompÃ©tition',
        'professionnel': 'ðŸ‘‘ Pro'
    },
    
    addLanguage: async () => {
        const select = document.getElementById('profile-language-select');
        const levelSelect = document.getElementById('profile-language-level');
        let name = select.value;
        const level = levelSelect.value;
        
        if(!name) return;
        
        // Si "Autre", demander le nom
        if(name === '__custom__') {
            name = await ConfirmModal.prompt('Nom de la langue :', 'Ajouter une langue', 'Ex: Mandarin...');
            if(!name || !name.trim()) { select.value = ''; return; }
            name = name.trim();
        }
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        if(!profile.languagesWithLevels) profile.languagesWithLevels = [];
        
        // VÃ©rifier si dÃ©jÃ  ajoutÃ©
        if(profile.languagesWithLevels.some(l => l.name.toLowerCase() === name.toLowerCase())) {
            Utils.toast('Cette langue est dÃ©jÃ  ajoutÃ©e', 'warning');
            select.value = '';
            return;
        }
        
        profile.languagesWithLevels.push({ name, level });
        PublicProfile.renderLanguagesList();
        select.value = '';
    },
    
    removeLanguage: (idx) => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile || !profile.languagesWithLevels) return;
        profile.languagesWithLevels.splice(idx, 1);
        PublicProfile.renderLanguagesList();
    },
    
    renderLanguagesList: () => {
        const container = document.getElementById('profile-languages-list');
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!container || !profile) return;
        
        const langs = profile.languagesWithLevels || [];
        container.innerHTML = langs.map((l, i) => `
            <span class="n8-flex-2">
                <strong>${Utils.escape(l.name)}</strong>
                <span class="text-sec">${PublicProfile.languageLevels[l.level] || l.level}</span>
                <span onclick="app.PublicProfile.removeLanguage(${i})" style="cursor:pointer; color:var(--danger); margin-left:3px;">âœ–</span>
            </span>
        `).join('');
        
        // Mise Ã  jour du champ cachÃ© pour compatibilitÃ©
        document.getElementById('profile-languages').value = langs.map(l => `${l.name} (${l.level})`).join(', ');
    },
    
    addSport: async () => {
        const select = document.getElementById('profile-sport-select');
        const levelSelect = document.getElementById('profile-sport-level');
        let name = select.value;
        const level = levelSelect.value;
        
        if(!name) return;
        
        // Si "Autre", demander le nom
        if(name === '__custom__') {
            name = await ConfirmModal.prompt('Nom du sport ou compÃ©tence :', 'Ajouter une compÃ©tence', 'Ex: Escalade...');
            if(!name || !name.trim()) { select.value = ''; return; }
            name = name.trim();
        }
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        if(!profile.sportsWithLevels) profile.sportsWithLevels = [];
        
        // VÃ©rifier si dÃ©jÃ  ajoutÃ©
        if(profile.sportsWithLevels.some(s => s.name.toLowerCase() === name.toLowerCase())) {
            Utils.toast('Ce sport est dÃ©jÃ  ajoutÃ©', 'warning');
            select.value = '';
            return;
        }
        
        profile.sportsWithLevels.push({ name, level });
        PublicProfile.renderSportsList();
        select.value = '';
    },
    
    removeSport: (idx) => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile || !profile.sportsWithLevels) return;
        profile.sportsWithLevels.splice(idx, 1);
        PublicProfile.renderSportsList();
    },
    
    renderSportsList: () => {
        const container = document.getElementById('profile-sports-list');
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!container || !profile) return;
        
        const sports = profile.sportsWithLevels || [];
        container.innerHTML = sports.map((s, i) => `
            <span class="n8-flex-2">
                <strong>${Utils.escape(s.name)}</strong>
                <span class="text-sec">${PublicProfile.sportLevels[s.level] || s.level}</span>
                <span onclick="app.PublicProfile.removeSport(${i})" style="cursor:pointer; color:var(--danger); margin-left:3px;">âœ–</span>
            </span>
        `).join('');
        
        // Mise Ã  jour du champ cachÃ© pour compatibilitÃ©
        document.getElementById('profile-sports').value = sports.map(s => `${s.name} (${s.level})`).join(', ');
    },
    
    // Migration des anciennes donnÃ©es texte vers le nouveau format
    migrateSkillsData: (profile) => {
        // Migrer les langues
        if(profile.languages && typeof profile.languages === 'string' && !profile.languagesWithLevels) {
            profile.languagesWithLevels = profile.languages.split(',').map(l => l.trim()).filter(l => l).map(l => ({
                name: l.replace(/\s*\([^)]*\)\s*$/, '').trim(),
                level: 'courant'
            }));
        }
        // Migrer les sports
        if(profile.sports && typeof profile.sports === 'string' && !profile.sportsWithLevels) {
            profile.sportsWithLevels = profile.sports.split(',').map(s => s.trim()).filter(s => s).map(s => ({
                name: s.replace(/\s*\([^)]*\)\s*$/, '').trim(),
                level: 'confirme'
            }));
        }
    },
    
    // Change de profil
    switchToProfile: (index) => {
        if(index < 0 || index >= PublicProfile.profiles.length) return;
        
        // Sauvegarder le profil actuel avant de changer
        if(PublicProfile.currentProfileIndex >= 0) {
            PublicProfile.saveFormToCurrentProfile();
        }
        
        PublicProfile.currentProfileIndex = index;
        PublicProfile.renderProfileTabs();
        PublicProfile.loadProfileToForm(PublicProfile.profiles[index]);
        
        document.getElementById('no-profile-message').style.display = 'none';
        document.getElementById('profile-all-sections').style.display = 'block';
    },
    
    // Charge un profil dans le formulaire
    loadProfileToForm: (profile) => {
        // Type de profil
        document.getElementById('profile-type-actor').checked = profile.type === 'actor';
        document.getElementById('profile-type-crew').checked = profile.type === 'crew';
        document.getElementById('profile-type-association').checked = profile.type === 'association';
        document.getElementById('profile-type-enterprise').checked = profile.type === 'enterprise';
        PublicProfile.onProfileTypeChange();
        
        // IdentitÃ©
        document.getElementById('profile-photo').value = profile.photo || '';
        PublicProfile.updatePhotoPreview();
        document.getElementById('profile-name').value = profile.name || '';
        document.getElementById('profile-gender').value = profile.gender || '';
        document.getElementById('profile-email').value = state.currentUser?.email || '';
        document.getElementById('profile-phone').value = profile.phone || '';
        document.getElementById('profile-city').value = profile.city || '';
        document.getElementById('profile-address').value = profile.address || '';
        document.getElementById('profile-hide-address').checked = profile.hideAddress || false;
        document.getElementById('profile-hide-address-projects').checked = profile.hideAddressInProjects || false;
        document.getElementById('profile-website').value = profile.website || '';
        document.getElementById('profile-bio').value = profile.bio || '';
        
        // Mettre Ã  jour les options de confidentialitÃ©
        setTimeout(() => PublicProfile.updateAddressPrivacyOptions(), 100);
        
        // ComÃ©dien
        if(profile.type === 'actor') {
            PublicProfile.loadGallery(profile.galleryPhotos || []);
            document.getElementById('profile-height').value = profile.height || '';
            document.getElementById('profile-weight').value = profile.weight || '';
            document.getElementById('profile-age').value = profile.age || '';
            document.getElementById('profile-eyes').value = profile.eyeColor || '';
            document.getElementById('profile-hair-color').value = profile.hairColor || '';
            document.getElementById('profile-hair-length').value = profile.hairLength || '';
            document.getElementById('profile-ethnicity').value = profile.ethnicity || '';
            document.getElementById('profile-corpulence').value = profile.corpulence || '';
            // Migration et affichage des langues/sports avec niveaux
            PublicProfile.migrateSkillsData(profile);
            PublicProfile.renderLanguagesList();
            PublicProfile.renderSportsList();
            document.getElementById('profile-demoreel').value = profile.demoreel || '';
        }
        
        // Technicien
        if(profile.type === 'crew') {
            document.getElementById('profile-department').value = profile.department || '';
            PublicProfile.updateRoleOptions();
            
            const roleSelect = document.getElementById('profile-role');
            const roleCustom = document.getElementById('profile-role-custom');
            const savedRole = profile.role || '';
            
            let roleFound = false;
            for(let i = 0; i < roleSelect.options.length; i++) {
                if(roleSelect.options[i].value === savedRole) {
                    roleSelect.value = savedRole;
                    roleFound = true;
                    break;
                }
            }
            
            if(!roleFound && savedRole) {
                roleSelect.value = 'Autre';
                roleCustom.style.display = 'block';
                roleCustom.value = savedRole;
            }
            
            PublicProfile.equipment = {
                cameras: profile.cameras || [],
                lenses: profile.lenses || [],
                lights: profile.lights || [],
                sounds: profile.sounds || [],
                grips: profile.grips || [],
                makeups: profile.makeups || [],
                other: profile.otherEquipment || []
            };
            PublicProfile.renderEquipment();
            document.getElementById('profile-crew-demoreel').value = profile.demoreel || '';
            PublicProfile.loadCrewGallery(profile.crewGalleryPhotos || []);
        }
        
        // Association
        if(profile.type === 'association') {
            document.getElementById('profile-asso-name').value = profile.assoName || '';
            document.getElementById('profile-asso-type').value = profile.assoType || '';
            document.getElementById('profile-asso-siret').value = profile.assoSiret || '';
            document.getElementById('profile-asso-members').value = profile.assoMembers || '';
            document.getElementById('profile-asso-year').value = profile.assoYear || '';
            document.getElementById('profile-asso-president').value = profile.assoPresident || '';
            document.getElementById('profile-asso-mission').value = profile.assoMission || '';
            document.getElementById('profile-asso-activities').value = profile.assoActivities || '';
            const services = profile.assoServices || {};
            document.getElementById('asso-service-formation').checked = services.formation || false;
            document.getElementById('asso-service-ateliers').checked = services.ateliers || false;
            document.getElementById('asso-service-networking').checked = services.networking || false;
            document.getElementById('asso-service-casting').checked = services.casting || false;
            document.getElementById('asso-service-materiel').checked = services.materiel || false;
            document.getElementById('asso-service-production').checked = services.production || false;
            document.getElementById('asso-service-diffusion').checked = services.diffusion || false;
            document.getElementById('profile-asso-facebook').value = profile.assoFacebook || '';
            document.getElementById('profile-asso-instagram').value = profile.assoInstagram || '';
            document.getElementById('profile-asso-youtube').value = profile.assoYoutube || '';
            document.getElementById('profile-asso-linkedin').value = profile.assoLinkedin || '';
            document.getElementById('profile-asso-demoreel').value = profile.assoDemoreel || '';
        }
        
        // Entreprise
        if(profile.type === 'enterprise') {
            document.getElementById('profile-ent-name').value = profile.entName || '';
            document.getElementById('profile-ent-type').value = profile.entType || '';
            document.getElementById('profile-ent-siret').value = profile.entSiret || '';
            document.getElementById('profile-ent-legal').value = profile.entLegal || '';
            document.getElementById('profile-ent-year').value = profile.entYear || '';
            document.getElementById('profile-ent-employees').value = profile.entEmployees || '';
            document.getElementById('profile-ent-director').value = profile.entDirector || '';
            document.getElementById('profile-ent-contact').value = profile.entContact || '';
            document.getElementById('profile-ent-description').value = profile.entDescription || '';
            document.getElementById('profile-ent-services').value = profile.entServices || '';
            const specs = profile.entSpecialties || {};
            document.getElementById('ent-spec-fiction').checked = specs.fiction || false;
            document.getElementById('ent-spec-doc').checked = specs.doc || false;
            document.getElementById('ent-spec-pub').checked = specs.pub || false;
            document.getElementById('ent-spec-corporate').checked = specs.corporate || false;
            document.getElementById('ent-spec-clip').checked = specs.clip || false;
            document.getElementById('ent-spec-event').checked = specs.event || false;
            document.getElementById('ent-spec-web').checked = specs.web || false;
            document.getElementById('profile-ent-facebook').value = profile.entFacebook || '';
            document.getElementById('profile-ent-instagram').value = profile.entInstagram || '';
            document.getElementById('profile-ent-youtube').value = profile.entYoutube || '';
            document.getElementById('profile-ent-linkedin').value = profile.entLinkedin || '';
            document.getElementById('profile-ent-vimeo').value = profile.entVimeo || '';
            document.getElementById('profile-ent-imdb').value = profile.entImdb || '';
            document.getElementById('profile-ent-demoreel').value = profile.entDemoreel || '';
        }   
        // Tarif & Dispo
        document.getElementById('profile-rate').value = profile.dailyRate || '';
        document.getElementById('profile-currency').value = profile.rateCurrency || 'â‚¬';
        document.getElementById('profile-rate-negotiable').checked = profile.rateNegotiable || false;
        document.getElementById('profile-availability').value = profile.availabilityText || '';
        
        // Calendrier disponibilitÃ©s
        PublicProfile.renderProfileCalendar();
        PublicProfile.renderProfileDatesList();
        
        // Types de collaboration
        PublicProfile.loadCollabTypes(profile);
        
        // VÃ©hicule
        document.getElementById('profile-has-vehicle').checked = profile.hasVehicle || false;
        document.getElementById('profile-vehicle-details').style.display = profile.hasVehicle ? 'block' : 'none';
        document.getElementById('profile-vehicle-type').value = profile.vehicleType || '';
        document.getElementById('profile-vehicle-plate').value = profile.vehiclePlate || '';
        document.getElementById('profile-vehicle-seats').value = profile.vehicleSeats || '';
        document.getElementById('profile-vehicle-trunk').checked = profile.vehicleTrunk || false;
        document.getElementById('profile-vehicle-notes').value = profile.vehicleNotes || '';
        
        PublicProfile.updatePhotoPreview();
        PublicProfile.updateStatus();
        PublicProfile.updateVisibilityButtons();
    },
    
    // Sauvegarde le formulaire dans le profil actuel
    saveFormToCurrentProfile: () => {
        if(PublicProfile.currentProfileIndex < 0) return;
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        
        // Type
        profile.type = document.getElementById('profile-type-actor').checked ? 'actor' : 
                       document.getElementById('profile-type-crew').checked ? 'crew' : 
                       document.getElementById('profile-type-association').checked ? 'association' :
                       document.getElementById('profile-type-enterprise').checked ? 'enterprise' : '';
        
        // IdentitÃ©
        profile.photo = document.getElementById('profile-photo').value.trim();
        profile.name = document.getElementById('profile-name').value.trim();
        profile.gender = document.getElementById('profile-gender').value;
        profile.phone = document.getElementById('profile-phone').value.trim();
        profile.city = document.getElementById('profile-city').value.trim();
        profile.address = document.getElementById('profile-address')?.value.trim() || '';
        profile.hideAddress = document.getElementById('profile-hide-address')?.checked || false;
        profile.hideAddressInProjects = document.getElementById('profile-hide-address-projects')?.checked || false;
        profile.website = document.getElementById('profile-website').value.trim();
        profile.bio = document.getElementById('profile-bio').value.trim();
        
        // ComÃ©dien
        if(profile.type === 'actor') {
            profile.galleryPhotos = [
                document.getElementById('gallery-input-0')?.value.trim() || '',
                document.getElementById('gallery-input-1')?.value.trim() || '',
                document.getElementById('gallery-input-2')?.value.trim() || ''
            ].filter(url => url);
            profile.height = document.getElementById('profile-height')?.value || '';
            profile.weight = document.getElementById('profile-weight')?.value || '';
            profile.age = document.getElementById('profile-age')?.value || '';
            profile.eyeColor = document.getElementById('profile-eyes')?.value || '';
            profile.hairColor = document.getElementById('profile-hair-color')?.value || '';
            profile.hairLength = document.getElementById('profile-hair-length')?.value || '';
            profile.ethnicity = document.getElementById('profile-ethnicity')?.value || '';
            profile.corpulence = document.getElementById('profile-corpulence')?.value || '';
            // Sports et langues avec niveaux (le champ cachÃ© est mis Ã  jour automatiquement)
            profile.sports = document.getElementById('profile-sports')?.value.trim() || '';
            profile.languages = document.getElementById('profile-languages')?.value.trim() || '';
            // Note: languagesWithLevels et sportsWithLevels sont dÃ©jÃ  dans l'objet profile
            profile.demoreel = document.getElementById('profile-demoreel')?.value.trim() || '';
        }
        
        // Technicien
        if(profile.type === 'crew') {
            profile.department = document.getElementById('profile-department')?.value || '';
            const roleSelect = document.getElementById('profile-role')?.value || '';
            const roleCustom = document.getElementById('profile-role-custom')?.value.trim() || '';
            profile.role = (roleSelect === 'Autre' && roleCustom) ? roleCustom : roleSelect;
            profile.cameras = PublicProfile.equipment.cameras;
            profile.lenses = PublicProfile.equipment.lenses;
            profile.lights = PublicProfile.equipment.lights;
            profile.sounds = PublicProfile.equipment.sounds;
            profile.grips = PublicProfile.equipment.grips;
            profile.makeups = PublicProfile.equipment.makeups;
            profile.otherEquipment = PublicProfile.equipment.other;
            profile.demoreel = document.getElementById('profile-crew-demoreel')?.value.trim() || '';
            profile.crewGalleryPhotos = [
                document.getElementById('crew-gallery-input-0')?.value.trim() || '',
                document.getElementById('crew-gallery-input-1')?.value.trim() || '',
                document.getElementById('crew-gallery-input-2')?.value.trim() || ''
            ].filter(url => url);
        }
        
        // Association
        if(profile.type === 'association') {
            profile.assoName = document.getElementById('profile-asso-name')?.value.trim() || '';
            profile.assoType = document.getElementById('profile-asso-type')?.value || '';
            profile.assoSiret = document.getElementById('profile-asso-siret')?.value.trim() || '';
            profile.assoMembers = document.getElementById('profile-asso-members')?.value || '';
            profile.assoYear = document.getElementById('profile-asso-year')?.value || '';
            profile.assoPresident = document.getElementById('profile-asso-president')?.value.trim() || '';
            profile.assoMission = document.getElementById('profile-asso-mission')?.value.trim() || '';
            profile.assoActivities = document.getElementById('profile-asso-activities')?.value.trim() || '';
            profile.assoServices = {
                formation: document.getElementById('asso-service-formation')?.checked || false,
                ateliers: document.getElementById('asso-service-ateliers')?.checked || false,
                networking: document.getElementById('asso-service-networking')?.checked || false,
                casting: document.getElementById('asso-service-casting')?.checked || false,
                materiel: document.getElementById('asso-service-materiel')?.checked || false,
                production: document.getElementById('asso-service-production')?.checked || false,
                diffusion: document.getElementById('asso-service-diffusion')?.checked || false
            };
            profile.assoFacebook = document.getElementById('profile-asso-facebook')?.value.trim() || '';
            profile.assoInstagram = document.getElementById('profile-asso-instagram')?.value.trim() || '';
            profile.assoYoutube = document.getElementById('profile-asso-youtube')?.value.trim() || '';
            profile.assoLinkedin = document.getElementById('profile-asso-linkedin')?.value.trim() || '';
            profile.assoDemoreel = document.getElementById('profile-asso-demoreel')?.value.trim() || '';
            // Utiliser le nom de l'asso comme nom du profil
            profile.name = profile.assoName || profile.name;
        }
        
        // Entreprise
        if(profile.type === 'enterprise') {
            profile.entName = document.getElementById('profile-ent-name')?.value.trim() || '';
            profile.entType = document.getElementById('profile-ent-type')?.value || '';
            profile.entSiret = document.getElementById('profile-ent-siret')?.value.trim() || '';
            profile.entLegal = document.getElementById('profile-ent-legal')?.value || '';
            profile.entYear = document.getElementById('profile-ent-year')?.value || '';
            profile.entEmployees = document.getElementById('profile-ent-employees')?.value || '';
            profile.entDirector = document.getElementById('profile-ent-director')?.value.trim() || '';
            profile.entContact = document.getElementById('profile-ent-contact')?.value.trim() || '';
            profile.entDescription = document.getElementById('profile-ent-description')?.value.trim() || '';
            profile.entServices = document.getElementById('profile-ent-services')?.value.trim() || '';
            profile.entSpecialties = {
                fiction: document.getElementById('ent-spec-fiction')?.checked || false,
                doc: document.getElementById('ent-spec-doc')?.checked || false,
                pub: document.getElementById('ent-spec-pub')?.checked || false,
                corporate: document.getElementById('ent-spec-corporate')?.checked || false,
                clip: document.getElementById('ent-spec-clip')?.checked || false,
                event: document.getElementById('ent-spec-event')?.checked || false,
                web: document.getElementById('ent-spec-web')?.checked || false
            };
            profile.entFacebook = document.getElementById('profile-ent-facebook')?.value.trim() || '';
            profile.entInstagram = document.getElementById('profile-ent-instagram')?.value.trim() || '';
            profile.entYoutube = document.getElementById('profile-ent-youtube')?.value.trim() || '';
            profile.entLinkedin = document.getElementById('profile-ent-linkedin')?.value.trim() || '';
            profile.entVimeo = document.getElementById('profile-ent-vimeo')?.value.trim() || '';
            profile.entImdb = document.getElementById('profile-ent-imdb')?.value.trim() || '';
            profile.entDemoreel = document.getElementById('profile-ent-demoreel')?.value.trim() || '';
            // Utiliser le nom de l'entreprise comme nom du profil
            profile.name = profile.entName || profile.name;
        }     
        // Tarif & Dispo
        profile.dailyRate = document.getElementById('profile-rate')?.value || '';
        profile.rateCurrency = document.getElementById('profile-currency')?.value || 'â‚¬';
        profile.rateNegotiable = document.getElementById('profile-rate-negotiable')?.checked || false;
        profile.availabilityText = document.getElementById('profile-availability')?.value.trim() || '';
        
        // Types de collaboration
        PublicProfile.saveCollabTypes(profile);
        
        // VÃ©hicule
        profile.hasVehicle = document.getElementById('profile-has-vehicle')?.checked || false;
        profile.vehicleType = document.getElementById('profile-vehicle-type')?.value.trim() || '';
        profile.vehiclePlate = document.getElementById('profile-vehicle-plate')?.value.trim() || '';
        profile.vehicleSeats = document.getElementById('profile-vehicle-seats')?.value || '';
        profile.vehicleTrunk = document.getElementById('profile-vehicle-trunk')?.checked || false;
        profile.vehicleNotes = document.getElementById('profile-vehicle-notes')?.value.trim() || '';
        
        // Statut
        profile.profileComplete = !!(profile.name && profile.phone && profile.city && profile.gender && profile.type);
        profile.updatedAt = new Date().toISOString();
    },
    
    // Change le type de profil (comÃ©dien/technicien)
    onProfileTypeChange: () => {
        const isActor = document.getElementById('profile-type-actor')?.checked || false;
        const isCrew = document.getElementById('profile-type-crew')?.checked || false;
        const isAssociation = document.getElementById('profile-type-association')?.checked || false;
        const isEnterprise = document.getElementById('profile-type-enterprise')?.checked || false;
        
        // Mettre en surbrillance la sÃ©lection
        document.getElementById('profile-type-actor-label').style.borderColor = isActor ? 'var(--primary)' : 'var(--border)';
        document.getElementById('profile-type-crew-label').style.borderColor = isCrew ? 'var(--primary)' : 'var(--border)';
        document.getElementById('profile-type-association-label').style.borderColor = isAssociation ? 'var(--primary)' : 'var(--border)';
        document.getElementById('profile-type-enterprise-label').style.borderColor = isEnterprise ? 'var(--primary)' : 'var(--border)';
        
        // Afficher/masquer les sections
        document.getElementById('profile-actor-section').style.display = isActor ? 'block' : 'none';
        document.getElementById('profile-actor-physical-section').style.display = isActor ? 'block' : 'none';
        document.getElementById('profile-actor-demoreel-section').style.display = isActor ? 'block' : 'none';
        document.getElementById('profile-crew-section').style.display = isCrew ? 'block' : 'none';
        document.getElementById('profile-crew-gallery-section').style.display = isCrew ? 'block' : 'none';
        document.getElementById('profile-crew-demoreel-section').style.display = isCrew ? 'block' : 'none';
        document.getElementById('profile-association-section').style.display = isAssociation ? 'block' : 'none';
        document.getElementById('profile-enterprise-section').style.display = isEnterprise ? 'block' : 'none';
        
        // Mettre Ã  jour le matÃ©riel si technicien
        if(isCrew) {
            const dept = document.getElementById('profile-department')?.value || '';
            PublicProfile.updateEquipmentForDepartment(dept);
        }
        
        // Peupler les selects pour association/entreprise
        if(isAssociation) {
            PublicProfile.populateAssoTypes();
        }
        if(isEnterprise) {
            PublicProfile.populateEntTypes();
        }
        
        // Mettre Ã  jour les options de confidentialitÃ© d'adresse
        PublicProfile.updateAddressPrivacyOptions();
    },
    
    // Recherche d'adresse avec autocomplÃ©tion (API adresse.data.gouv.fr)
    searchAddress: async (query) => {
        const suggestions = document.getElementById('profile-address-suggestions');
        if(!suggestions) return;
        
        if(!query || query.length < 3) {
            suggestions.classList.remove('visible');
            return;
        }
        
        try {
            const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
            const data = await response.json();
            
            if(data.features && data.features.length > 0) {
                suggestions.innerHTML = data.features.map(f => {
                    const props = f.properties;
                    const label = props.label || '';
                    const context = props.context || '';
                    return `<div class="address-suggestion" onclick="app.PublicProfile.selectAddress('${Utils.escape(label).replace(/'/g, "\\'")}', '${props.city || ''}')">
                        <div class="address-suggestion-main">${Utils.escape(props.name || label.split(',')[0])}</div>
                        <div class="address-suggestion-secondary">${Utils.escape(context)}</div>
                    </div>`;
                }).join('');
                suggestions.classList.add('visible');
            } else {
                suggestions.innerHTML = '<div class="address-suggestion" style="color:var(--text-sec); cursor:default;">Aucun rÃ©sultat</div>';
                suggestions.classList.add('visible');
            }
        } catch(e) {
            console.error('Erreur recherche adresse:', e);
            suggestions.classList.remove('visible');
        }
    },
    
    // SÃ©lectionner une adresse
    selectAddress: (address, city) => {
        document.getElementById('profile-address').value = address;
        if(city && !document.getElementById('profile-city').value) {
            document.getElementById('profile-city').value = city;
        }
        document.getElementById('profile-address-suggestions').classList.remove('visible');
    },
    
    // Met Ã  jour les options de confidentialitÃ© selon le type de profil
    updateAddressPrivacyOptions: () => {
        const isActor = document.getElementById('profile-type-actor')?.checked || false;
        const isCrew = document.getElementById('profile-type-crew')?.checked || false;
        const isAssociation = document.getElementById('profile-type-association')?.checked || false;
        const isEnterprise = document.getElementById('profile-type-enterprise')?.checked || false;
        
        const privacyDiv = document.getElementById('profile-address-privacy');
        const hideAddressLabel = document.getElementById('profile-hide-address-label');
        const hideAddressProjectsLabel = document.getElementById('profile-hide-address-projects-label');
        const addressInfo = document.getElementById('profile-address-info');
        
        if(!privacyDiv) return;
        
        // Afficher le bloc de confidentialitÃ©
        privacyDiv.style.display = 'flex';
        
        if(isActor || isCrew) {
            // ComÃ©diens/Techniciens : adresse toujours masquÃ©e dans l'Univers, option pour projets
            hideAddressLabel.style.display = 'none';
            hideAddressProjectsLabel.style.display = 'flex';
            addressInfo.style.display = 'block';
        } else if(isAssociation || isEnterprise) {
            // Associations/Entreprises : choix de masquer ou non
            hideAddressLabel.style.display = 'flex';
            hideAddressProjectsLabel.style.display = 'none';
            addressInfo.style.display = 'none';
        } else {
            privacyDiv.style.display = 'none';
        }
    },
    
    // Peuple les types d'association
    populateAssoTypes: () => {
        const select = document.getElementById('profile-asso-type');
        if(!select || select.options.length > 1) return;
        
        CONFIG.associationTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type.id;
            opt.textContent = type.name;
            select.appendChild(opt);
        });
    },
    
    // Peuple les types d'entreprise
    populateEntTypes: () => {
        const select = document.getElementById('profile-ent-type');
        if(!select || select.options.length > 1) return;
        
        CONFIG.enterpriseTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type.id;
            opt.textContent = type.name;
            select.appendChild(opt);
        });
    },
	
    // Met Ã  jour les checkboxes de matÃ©riel selon le dÃ©partement
    updateEquipmentForDepartment: (dept) => {
        // Ne rien cocher automatiquement - l'utilisateur choisit lui-mÃªme
    },
	
	updateRoleOptions: () => {
        const deptSelect = document.getElementById('profile-department');
        const roleSelect = document.getElementById('profile-role');
        const roleCustom = document.getElementById('profile-role-custom');
        
        const deptId = deptSelect.value;
        roleSelect.innerHTML = '<option value="">-- Fonction * --</option>';
        roleCustom.style.display = 'none';
        roleCustom.value = '';
        
        if(deptId && CONFIG.crewRoles[deptId]) {
            CONFIG.crewRoles[deptId].forEach(role => {
                const opt = document.createElement('option');
                opt.value = role;
                opt.textContent = role;
                roleSelect.appendChild(opt);
            });
        }
        
        // Mettre Ã  jour les sections de matÃ©riel selon le dÃ©partement
        PublicProfile.updateEquipmentForDepartment(deptId);
    },
    
    onRoleChange: () => {
        const roleSelect = document.getElementById('profile-role');
        const roleCustom = document.getElementById('profile-role-custom');
        
        if(roleSelect.value === 'Autre') {
            roleCustom.style.display = 'block';
            roleCustom.focus();
        } else {
            roleCustom.style.display = 'none';
            roleCustom.value = '';
        }
    },
	
    showTab: (tab) => {
        const profileContent = document.getElementById('profile-content');
        const messagesContent = document.getElementById('messages-content');
        const profileTabBtn = document.getElementById('profile-tab-btn');
        const messagesTabBtn = document.getElementById('messages-tab-btn');
        
        if(tab === 'profile') {
            profileContent.style.display = 'block';
            messagesContent.style.display = 'none';
            profileTabBtn.classList.add('active');
            messagesTabBtn.classList.remove('active');
        } else {
            profileContent.style.display = 'none';
            messagesContent.style.display = 'block';
            profileTabBtn.classList.remove('active');
            messagesTabBtn.classList.add('active');
            Messages.render();
        }
    },
    
    // Charge tous les profils de l'utilisateur depuis Firebase
    pendingClaims: [],
    
    // Charge les profils en attente de revendication
    loadPendingClaims: async () => {
        const email = state.currentUser.email.toLowerCase();
        
        try {
            const { data: notifications, error } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_email', email)
                .eq('type', 'profile_claim')
                .eq('read', false);
            
            if(!error && notifications) {
                PublicProfile.pendingClaims = notifications.map(n => {
                    try {
                        return { ...JSON.parse(n.message), notificationId: n.id };
                    } catch(e) {
                        return null;
                    }
                }).filter(c => c !== null);
            } else {
                PublicProfile.pendingClaims = [];
            }
            
            PublicProfile.renderPendingClaims();
        } catch(e) {
            console.error('Erreur chargement claims:', e);
            PublicProfile.pendingClaims = [];
        }
    },
    
    // Affiche les profils Ã  revendiquer
    renderPendingClaims: () => {
        const section = document.getElementById('pending-claims-section');
        const list = document.getElementById('pending-claims-list');
        
        if(!section || !list) return;
        
        if(PublicProfile.pendingClaims.length === 0) {
            section.style.display = 'none';
            return;
        }
        
        section.style.display = 'block';
        
        list.innerHTML = PublicProfile.pendingClaims.map(claim => {
            const typeIcon = claim.type === 'actor' ? 'ðŸŽ­' : 'ðŸŽ¥';
            const typeLabel = claim.type === 'actor' ? 'ComÃ©dienÂ·ne' : 'TechnicienÂ·ne';
            
            return `
                <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden;">
                        ${claim.photo ? `<img src="${claim.photo}" class="img-cover">` : typeIcon}
                    </div>
                    <div class="flex-1">
                        <div class="fw-bold">${Utils.escape(claim.name)}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">${typeLabel} â€¢ CrÃ©Ã© par ${Utils.escape(claim.createdByName)} pour "${Utils.escape(claim.projectTitle)}"</div>
                    </div>
                    <button onclick="app.PublicProfile.claimProfile('${claim.id}')" style="padding: 10px 20px; background: white; color: #764ba2; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                        âœ¨ Revendiquer
                    </button>
                    <button onclick="app.PublicProfile.rejectClaim('${claim.id}')" style="padding: 10px 15px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer;" title="Ignorer">
                        âœ–
                    </button>
                </div>
            `;
        }).join('');
    },
    
    // Revendique un profil et le transforme en profil propre
    claimProfile: async (claimId) => {
        const claim = PublicProfile.pendingClaims.find(c => c.id === claimId);
        if(!claim) return;
        
        if(!await ConfirmModal.show({ title: 'Revendiquer ce profil ?', message: `Le profil "${claim.name}" deviendra votre profil public que vous pourrez complÃ©ter.`, icon: 'âœ‹', confirmText: 'Revendiquer' })) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        try {
            // CrÃ©er un nouveau profil Ã  partir du claim
            const newProfile = {
                id: 'profile_' + Date.now(),
                type: claim.type,
                name: claim.name,
                email: state.currentUser.email,
                phone: claim.phone || '',
                photo: claim.photo || '',
                bio: claim.bio || '',
                gender: claim.gender || '',
                city: '',
                // DonnÃ©es acteur
                height: claim.height || '',
                age: claim.age || '',
                eyeColor: claim.eyeColor || '',
                hairColor: claim.hairColor || '',
                ethnicity: claim.ethnicity || '',
                languages: claim.languages || '',
                sports: claim.sports || '',
                // DonnÃ©es technicien
                role: claim.role || '',
                department: claim.department || '',
                dailyRate: claim.dailyRate || '',
                rateCurrency: claim.rateCurrency || 'â‚¬',
                // MÃ©tadonnÃ©es
                claimedFrom: claimId,
                claimedAt: new Date().toISOString(),
                originalCreator: claim.createdBy,
                profileComplete: false
            };
            
            // Ajouter aux profils
            PublicProfile.profiles.push(newProfile);
            
            // Mettre Ã  jour le profil utilisateur dans Supabase
            const email = state.currentUser.email.toLowerCase();
            const {error: upErr1} = await supabase.from('user_profiles').update({
                name: newProfile.name,
                phone: newProfile.phone,
                photo: newProfile.photo,
                bio: newProfile.bio,
                gender: newProfile.gender,
                profile_type: newProfile.type
            }).eq('email', email);
            if(upErr1) { console.error('Erreur MAJ profil:', upErr1); Toast.show('Erreur mise Ã  jour profil', 'error'); }
            
            // Mettre Ã  jour l'acteur/technicien dans le projet d'origine avec le lien vers le profil public
            if(claim.projectId && claim.localId) {
                const { data: project } = await supabase
                    .from('projects')
                    .select('data')
                    .eq('id', claim.projectId)
                    .single();
                
                if(project && project.data) {
                    const dataArray = claim.type === 'actor' ? project.data.actors : project.data.crew;
                    if(dataArray) {
                        const idx = dataArray.findIndex(p => p.id === claim.localId);
                        if(idx !== -1) {
                            dataArray[idx].publicProfileId = newProfile.id;
                            await supabase.from('projects').update({ data: project.data }).eq('id', claim.projectId);
                        }
                    }
                }
            }
            
            // Supprimer la notification de claim
            if(claim.notificationId) {
                const {error: delNotifErr} = await supabase.from('notifications').delete().eq('id', claim.notificationId);
                if(delNotifErr) throw delNotifErr;
            }
            PublicProfile.pendingClaims = PublicProfile.pendingClaims.filter(c => c.id !== claimId);
            
            // RafraÃ®chir l'affichage
            PublicProfile.renderPendingClaims();
            PublicProfile.renderProfileTabs();
            PublicProfile.currentProfileIndex = PublicProfile.profiles.length - 1;
            PublicProfile.loadProfileToForm(newProfile);
            document.getElementById('no-profile-message').style.display = 'none';
            document.getElementById('profile-all-sections').style.display = 'block';
            
            Utils.toast(`Profil "${claim.name}" revendiquÃ© ! ComplÃ©tez-le pour apparaÃ®tre dans l'Univers.`, 'success');
        } catch(e) {
            console.error('Erreur revendication:', e);
            Utils.toast('Erreur lors de la revendication', 'error');
        }
    },
    
    // Rejette/ignore un claim
    rejectClaim: async (claimId) => {
        if(!await ConfirmModal.show({ title: 'Ignorer ce profil ?', message: 'Ce profil ne vous sera plus proposÃ©.', icon: 'ðŸš«', confirmText: 'Ignorer' })) return;
        
        try {
            // Trouver la notification correspondante
            const claim = PublicProfile.pendingClaims.find(c => c.id === claimId);
            if(claim && claim.notificationId) {
                const {error: delNotifErr2} = await supabase.from('notifications').delete().eq('id', claim.notificationId);
                if(delNotifErr2) throw delNotifErr2;
            }
            PublicProfile.pendingClaims = PublicProfile.pendingClaims.filter(c => c.id !== claimId);
            PublicProfile.renderPendingClaims();
            Utils.toast('Profil ignorÃ©.', 'info');
        } catch(e) {
            console.error('Erreur:', e);
        }
    },
    
    loadProfiles: async () => {
        const email = state.currentUser.email.toLowerCase();
        
        try {
            // Charger le profil depuis Supabase
            const { data: userProfile, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('email', email)
                .single();
            
            if(!error && userProfile && userProfile.name) {
                // Extraire les donnÃ©es supplÃ©mentaires du champ JSONB
                const extraData = userProfile.data || {};
                
                // CrÃ©er un profil complet Ã  partir des donnÃ©es Supabase
                const profile = {
                    id: userProfile.id,
                    type: userProfile.profile_type || 'crew',
                    name: userProfile.name,
                    email: userProfile.email,
                    phone: userProfile.phone || '',
                    photo: userProfile.photo || '',
                    bio: userProfile.bio || '',
                    gender: userProfile.gender || '',
                    city: userProfile.city || '',
                    birthdate: userProfile.birthdate || '',
                    hasVehicle: userProfile.vehicle || false,
                    vehicle: userProfile.vehicle || false,
                    acting_styles: userProfile.acting_styles || [],
                    technical_skills: userProfile.technical_skills || [],
                    experience: userProfile.experience || '',
                    availabilityText: userProfile.availability || '',
                    is_public: userProfile.is_public,
                    profileComplete: userProfile.is_public,
                    // Commun
                    address: extraData.address || '',
                    hideAddress: extraData.hideAddress || false,
                    hideAddressInProjects: extraData.hideAddressInProjects || false,
                    website: extraData.website || '',
                    dailyRate: extraData.dailyRate || '',
                    rateCurrency: extraData.rateCurrency || 'â‚¬',
                    rateNegotiable: extraData.rateNegotiable || false,
                    collabTypes: extraData.collabTypes || [],
                    availabilityDates: extraData.availabilityDates || [],
                    unavailabilityDates: extraData.unavailabilityDates || [],
                    // VÃ©hicule
                    vehicleType: extraData.vehicleType || '',
                    vehiclePlate: extraData.vehiclePlate || '',
                    vehicleSeats: extraData.vehicleSeats || '',
                    vehicleTrunk: extraData.vehicleTrunk || false,
                    vehicleNotes: extraData.vehicleNotes || '',
                    // ComÃ©dien
                    height: extraData.height || '',
                    weight: extraData.weight || '',
                    age: extraData.age || '',
                    eyeColor: extraData.eyeColor || '',
                    hairColor: extraData.hairColor || '',
                    hairLength: extraData.hairLength || '',
                    ethnicity: extraData.ethnicity || '',
                    corpulence: extraData.corpulence || '',
                    sports: extraData.sports || '',
                    languages: extraData.languages || '',
                    languagesWithLevels: extraData.languagesWithLevels || [],
                    sportsWithLevels: extraData.sportsWithLevels || [],
                    galleryPhotos: extraData.galleryPhotos || [],
                    demoreel: extraData.demoreel || '',
                    // Technicien
                    department: extraData.department || '',
                    role: extraData.role || '',
                    cameras: extraData.cameras || [],
                    lenses: extraData.lenses || [],
                    lights: extraData.lights || [],
                    sounds: extraData.sounds || [],
                    grips: extraData.grips || [],
                    makeups: extraData.makeups || [],
                    otherEquipment: extraData.otherEquipment || [],
                    crewGalleryPhotos: extraData.crewGalleryPhotos || [],
                    // Association
                    assoName: extraData.assoName || '',
                    assoType: extraData.assoType || '',
                    assoSiret: extraData.assoSiret || '',
                    assoMembers: extraData.assoMembers || '',
                    assoYear: extraData.assoYear || '',
                    assoPresident: extraData.assoPresident || '',
                    assoMission: extraData.assoMission || '',
                    assoActivities: extraData.assoActivities || '',
                    assoServices: extraData.assoServices || {},
                    assoFacebook: extraData.assoFacebook || '',
                    assoInstagram: extraData.assoInstagram || '',
                    assoYoutube: extraData.assoYoutube || '',
                    assoLinkedin: extraData.assoLinkedin || '',
                    assoDemoreel: extraData.assoDemoreel || '',
                    // Entreprise
                    entName: extraData.entName || '',
                    entType: extraData.entType || '',
                    entSiret: extraData.entSiret || '',
                    entLegal: extraData.entLegal || '',
                    entYear: extraData.entYear || '',
                    entEmployees: extraData.entEmployees || '',
                    entDirector: extraData.entDirector || '',
                    entContact: extraData.entContact || '',
                    entDescription: extraData.entDescription || '',
                    entServices: extraData.entServices || '',
                    entSpecialties: extraData.entSpecialties || {},
                    entFacebook: extraData.entFacebook || '',
                    entInstagram: extraData.entInstagram || '',
                    entYoutube: extraData.entYoutube || '',
                    entLinkedin: extraData.entLinkedin || '',
                    entVimeo: extraData.entVimeo || '',
                    entImdb: extraData.entImdb || '',
                    entDemoreel: extraData.entDemoreel || ''
                };
                PublicProfile.profiles = [profile];
            } else {
                PublicProfile.profiles = [];
            }
        } catch(e) {
            console.error('Erreur chargement profils:', e);
            PublicProfile.profiles = [];
        }
    },
    
    // Ancienne fonction load pour compatibilitÃ©
    load: async () => {
        await PublicProfile.loadProfiles();
    },
    
    // Sauvegarde le profil actuel
    saveCurrentProfile: async () => {
        if(PublicProfile.currentProfileIndex < 0) {
            Utils.toast('Aucun profil Ã  sauvegarder. CrÃ©ez d\'abord un profil.', 'warning');
            return;
        }
        
        // Sauvegarder le formulaire dans l'objet profil
        PublicProfile.saveFormToCurrentProfile();
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        
        if(!profile.type) {
            Utils.toast('Veuillez choisir un type de profil.', 'warning');
            return;
        }
        
        // Validation selon le type
        if(profile.type === 'actor' || profile.type === 'crew') {
            if(!profile.name || !profile.phone || !profile.city || !profile.gender) {
                Utils.toast('Veuillez remplir les champs obligatoires (Nom, Sexe, TÃ©lÃ©phone, Ville).', 'warning');
                return;
            }
        } else if(profile.type === 'association') {
            if(!profile.assoName || !profile.assoType || !profile.assoMission || !profile.city || !profile.phone) {
                Utils.toast('Veuillez remplir les champs obligatoires (Nom, Type, Mission, Ville, TÃ©lÃ©phone).', 'warning');
                return;
            }
        } else if(profile.type === 'enterprise') {
            if(!profile.entName || !profile.entType || !profile.entDescription || !profile.city || !profile.phone) {
                Utils.toast('Veuillez remplir les champs obligatoires (Nom, Type, Description, Ville, TÃ©lÃ©phone).', 'warning');
                return;
            }
        }
        
        const btn = document.querySelector('button[onclick="app.PublicProfile.saveCurrentProfile()"]');
        const originalText = btn ? btn.innerHTML : '';
        if(btn) { btn.innerHTML = '<span class="spinner"></span>Sauvegarde...'; btn.classList.add('btn-loading'); }
        
        const email = state.currentUser.email.toLowerCase();
        
        try {
            // Sauvegarder le profil dans Supabase
            const dataToSave = {
                name: profile.name,
                phone: profile.phone,
                city: profile.city,
                gender: profile.gender,
                photo: profile.photo,
                bio: profile.bio,
                birthdate: profile.birthdate || null,
                vehicle: profile.hasVehicle || profile.vehicle || false,
                profile_type: profile.type,
                acting_styles: profile.acting_styles || [],
                technical_skills: profile.technical_skills || [],
                experience: profile.experience || '',
                availability: profile.availabilityText || profile.availability || '',
                is_public: true,
                updated_at: new Date().toISOString(),
                data: {
                    // Commun
                    address: profile.address || '',
                    hideAddress: profile.hideAddress || false,
                    hideAddressInProjects: profile.hideAddressInProjects || false,
                    website: profile.website || '',
                    dailyRate: profile.dailyRate || '',
                    rateCurrency: profile.rateCurrency || 'â‚¬',
                    rateNegotiable: profile.rateNegotiable || false,
                    collabTypes: profile.collabTypes || [],
                    availabilityDates: profile.availabilityDates || [],
                    unavailabilityDates: profile.unavailabilityDates || [],
                    // VÃ©hicule
                    vehicleType: profile.vehicleType || '',
                    vehiclePlate: profile.vehiclePlate || '',
                    vehicleSeats: profile.vehicleSeats || '',
                    vehicleTrunk: profile.vehicleTrunk || false,
                    vehicleNotes: profile.vehicleNotes || '',
                    // ComÃ©dien
                    height: profile.height || '',
                    weight: profile.weight || '',
                    age: profile.age || '',
                    eyeColor: profile.eyeColor || '',
                    hairColor: profile.hairColor || '',
                    hairLength: profile.hairLength || '',
                    ethnicity: profile.ethnicity || '',
                    corpulence: profile.corpulence || '',
                    sports: profile.sports || '',
                    languages: profile.languages || '',
                    languagesWithLevels: profile.languagesWithLevels || [],
                    sportsWithLevels: profile.sportsWithLevels || [],
                    galleryPhotos: profile.galleryPhotos || [],
                    demoreel: profile.demoreel || '',
                    // Technicien
                    department: profile.department || '',
                    role: profile.role || '',
                    cameras: profile.cameras || [],
                    lenses: profile.lenses || [],
                    lights: profile.lights || [],
                    sounds: profile.sounds || [],
                    grips: profile.grips || [],
                    makeups: profile.makeups || [],
                    otherEquipment: profile.otherEquipment || [],
                    crewGalleryPhotos: profile.crewGalleryPhotos || [],
                    // Association
                    assoName: profile.assoName || '',
                    assoType: profile.assoType || '',
                    assoSiret: profile.assoSiret || '',
                    assoMembers: profile.assoMembers || '',
                    assoYear: profile.assoYear || '',
                    assoPresident: profile.assoPresident || '',
                    assoMission: profile.assoMission || '',
                    assoActivities: profile.assoActivities || '',
                    assoServices: profile.assoServices || {},
                    assoFacebook: profile.assoFacebook || '',
                    assoInstagram: profile.assoInstagram || '',
                    assoYoutube: profile.assoYoutube || '',
                    assoLinkedin: profile.assoLinkedin || '',
                    assoDemoreel: profile.assoDemoreel || '',
                    // Entreprise
                    entName: profile.entName || '',
                    entType: profile.entType || '',
                    entSiret: profile.entSiret || '',
                    entLegal: profile.entLegal || '',
                    entYear: profile.entYear || '',
                    entEmployees: profile.entEmployees || '',
                    entDirector: profile.entDirector || '',
                    entContact: profile.entContact || '',
                    entDescription: profile.entDescription || '',
                    entServices: profile.entServices || '',
                    entSpecialties: profile.entSpecialties || {},
                    entFacebook: profile.entFacebook || '',
                    entInstagram: profile.entInstagram || '',
                    entYoutube: profile.entYoutube || '',
                    entLinkedin: profile.entLinkedin || '',
                    entVimeo: profile.entVimeo || '',
                    entImdb: profile.entImdb || '',
                    entDemoreel: profile.entDemoreel || ''
                }
            };
            
            const {error: upErr} = await supabase.from('user_profiles').upsert({
                email: email,
                ...dataToSave
            }, { onConflict: 'email' });
            if(upErr) { Utils.toast('Erreur sauvegarde profil', 'error'); console.error('Profil upsert:', upErr); }
            
            // Mettre Ã  jour state.userProfile pour le bouton du dashboard
            if(profile.profileComplete) {
                state.userProfile = state.userProfile || {};
                state.userProfile.profileComplete = true;
            }
            
            PublicProfile.renderProfileTabs();
            PublicProfile.updateStatus();
            if(btn) { btn.innerHTML = originalText; btn.classList.remove('btn-loading'); }
            Utils.toast('Profil sauvegardÃ© !', 'success');
        } catch(e) {
            if(btn) { btn.innerHTML = originalText; btn.classList.remove('btn-loading'); }
            Utils.toast('Erreur lors de la sauvegarde', 'error');
        }
    },
    
    // Supprime le profil actuel
    deleteCurrentProfile: async () => {
        if(PublicProfile.currentProfileIndex < 0) return;
        
        if(!await ConfirmModal.confirmDelete("Cette action est irrÃ©versible.", "Supprimer ce profil ?")) return;
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        const email = state.currentUser.email.toLowerCase();
        
        try {
            // RÃ©initialiser le profil dans Supabase (on ne supprime pas, on vide)
            const {error: upErr2} = await supabase.from('user_profiles').update({
                name: '',
                phone: '',
                city: '',
                gender: '',
                photo: '',
                bio: '',
                profile_type: '',
                is_public: false,
                updated_at: new Date().toISOString()
            }).eq('email', email);
            if(upErr2) throw upErr2;
            
            // Supprimer du tableau local
            PublicProfile.profiles.splice(PublicProfile.currentProfileIndex, 1);
            
            // Afficher un autre profil ou le message vide
            if(PublicProfile.profiles.length > 0) {
                PublicProfile.currentProfileIndex = 0;
                PublicProfile.renderProfileTabs();
                PublicProfile.loadProfileToForm(PublicProfile.profiles[0]);
            } else {
                PublicProfile.currentProfileIndex = -1;
                PublicProfile.renderProfileTabs();
                document.getElementById('no-profile-message').style.display = 'block';
                document.getElementById('profile-all-sections').style.display = 'none';
            }
            
            Utils.toast('Profil supprimÃ©.', 'success');
        } catch(e) {
            console.error('Erreur suppression profil:', e);
            Utils.toast('Erreur lors de la suppression', 'error');
        }
    },
    
    // Ancienne fonction save conservÃ©e pour compatibilitÃ©
    save: async () => {
        await PublicProfile.saveCurrentProfile();
    },
    
    updatePhotoPreview: () => {
        const url = document.getElementById('profile-photo').value.trim();
        const preview = document.getElementById('profile-photo-preview');
        if(url) {
            preview.innerHTML = `<img src="${url}" alt="Photo" onerror="this.parentElement.innerHTML='ðŸ‘¤'">`;
        } else {
            preview.innerHTML = 'ðŸ‘¤';
        }
    },
    
    handlePhotoUpload: async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const statusEl = document.getElementById('profile-photo-status');
        const preview = document.getElementById('profile-photo-preview');
        const photoInput = document.getElementById('profile-photo');
        
        // VÃ©rifier le type
        if (!file.type.startsWith('image/')) {
            statusEl.textContent = 'âŒ Fichier non valide';
            statusEl.style.color = '#e74c3c';
            return;
        }
        
        // VÃ©rifier la taille (max 5 Mo)
        if (file.size > 5 * 1024 * 1024) {
            statusEl.textContent = 'âŒ Fichier trop volumineux (max 5 Mo)';
            statusEl.style.color = '#e74c3c';
            return;
        }
        
        statusEl.textContent = 'â³ Upload en cours...';
        statusEl.style.color = 'var(--text-sec)';
        
        try {
            // Compresser l'image
            const compressedBlob = await PublicProfile.compressImageToBlob(file, 800, 0.8);
            
            // Upload vers Supabase Storage
            const userId = state.currentUser.id;
            const fileName = `avatar_${Date.now()}.jpg`;
            const filePath = `${userId}/${fileName}`;
            
            // Supprimer l'ancienne photo si elle existe
            const oldPhoto = photoInput.value;
            if (oldPhoto && oldPhoto.includes('supabase')) {
                const oldPath = oldPhoto.split('/avatars/')[1];
                if (oldPath) {
                    await supabase.storage.from('avatars').remove([oldPath]);
                }
            }
            
            // Uploader la nouvelle photo
            const { data, error } = await supabase.storage
                .from('avatars')
                .upload(filePath, compressedBlob, {
                    contentType: 'image/jpeg',
                    upsert: true
                });
            
            if (error) throw error;
            
            // RÃ©cupÃ©rer l'URL publique
            const { data: urlData } = supabase.storage
                .from('avatars')
                .getPublicUrl(filePath);
            
            const publicUrl = urlData.publicUrl;
            
            photoInput.value = publicUrl;
            preview.innerHTML = `<img src="${publicUrl}" alt="Photo">`;
            statusEl.textContent = `âœ… Photo uploadÃ©e`;
            statusEl.style.color = '#27ae60';
        } catch (err) {
            console.error('Erreur upload:', err);
            statusEl.textContent = 'âŒ Erreur lors de l\'upload';
            statusEl.style.color = '#e74c3c';
        }
    },
    
    compressImage: (file, maxSize, quality) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Redimensionner si nÃ©cessaire
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = Math.round(height * maxSize / width);
                            width = maxSize;
                        } else {
                            width = Math.round(width * maxSize / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convertir en JPEG compressÃ©
                    const base64 = canvas.toDataURL('image/jpeg', quality);
                    resolve(base64);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },
    
    // Compresse et retourne un Blob (pour upload Supabase Storage)
    compressImageToBlob: (file, maxSize, quality) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = Math.round(height * maxSize / width);
                            width = maxSize;
                        } else {
                            width = Math.round(width * maxSize / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },
    
    updateStatus: () => {
        const name = document.getElementById('profile-name').value.trim();
        const phone = document.getElementById('profile-phone').value.trim();
        const city = document.getElementById('profile-city').value.trim();
        const gender = document.getElementById('profile-gender').value;
        
        const isComplete = name && phone && city && gender;
        const statusDiv = document.getElementById('profile-status');
        
        if(isComplete) {
            statusDiv.className = 'profile-status complete';
            statusDiv.innerHTML = 'âœ… Votre profil est complet et visible dans les recherches !';
        } else {
            statusDiv.className = 'profile-status incomplete';
            const missing = [];
            if(!name) missing.push('nom');
            if(!gender) missing.push('sexe');
            if(!phone) missing.push('tÃ©lÃ©phone');
            if(!city) missing.push('ville');
            statusDiv.innerHTML = `âš ï¸ Profil incomplet. Champs manquants : ${missing.join(', ')}`;
        }
    },
    
    addEquipment: (type) => {
        let value = '';
        let list = [];
        let listId = '';
        
        if(type === 'camera') {
            value = document.getElementById('profile-camera-select').value;
            list = PublicProfile.equipment.cameras;
            listId = 'camera-list';
            document.getElementById('profile-camera-select').value = '';
        } else if(type === 'lens') {
            value = document.getElementById('profile-lens-select').value;
            list = PublicProfile.equipment.lenses;
            listId = 'lens-list';
            document.getElementById('profile-lens-select').value = '';
        } else if(type === 'light') {
            value = document.getElementById('profile-light-select').value;
            list = PublicProfile.equipment.lights;
            listId = 'light-list';
            document.getElementById('profile-light-select').value = '';
        } else if(type === 'sound') {
            value = document.getElementById('profile-sound-select').value;
            list = PublicProfile.equipment.sounds;
            listId = 'sound-list';
            document.getElementById('profile-sound-select').value = '';
        } else if(type === 'grip') {
            value = document.getElementById('profile-grip-select').value;
            list = PublicProfile.equipment.grips;
            listId = 'grip-list';
            document.getElementById('profile-grip-select').value = '';
        } else if(type === 'makeup') {
            value = document.getElementById('profile-makeup-select').value;
            list = PublicProfile.equipment.makeups;
            listId = 'makeup-list';
            document.getElementById('profile-makeup-select').value = '';
        } else if(type === 'other') {
            value = document.getElementById('profile-other-equipment').value.trim();
            list = PublicProfile.equipment.other;
            listId = 'other-equipment-list';
            document.getElementById('profile-other-equipment').value = '';
        }
        
        if(value && !list.includes(value)) {
            list.push(value);
            PublicProfile.renderEquipment();
        }
    },
    
    removeEquipment: (type, index) => {
        if(type === 'camera') {
            PublicProfile.equipment.cameras.splice(index, 1);
        } else if(type === 'lens') {
            PublicProfile.equipment.lenses.splice(index, 1);
        } else if(type === 'light') {
            PublicProfile.equipment.lights.splice(index, 1);
        } else if(type === 'sound') {
            PublicProfile.equipment.sounds.splice(index, 1);
        } else if(type === 'grip') {
            PublicProfile.equipment.grips.splice(index, 1);
        } else if(type === 'makeup') {
            PublicProfile.equipment.makeups.splice(index, 1);
        } else if(type === 'other') {
            PublicProfile.equipment.other.splice(index, 1);
        }
        PublicProfile.renderEquipment();
    },
    
    renderEquipment: () => {
        // CamÃ©ras
        const cameraList = document.getElementById('camera-list');
        if(cameraList) {
            cameraList.innerHTML = PublicProfile.equipment.cameras.map((c, i) => 
                `<div class="equipment-tag">ðŸ“· ${c} <span class="remove" onclick="app.PublicProfile.removeEquipment('camera', ${i})">âœ–</span></div>`
            ).join('');
        }
        
        // Objectifs
        const lensList = document.getElementById('lens-list');
        if(lensList) {
            lensList.innerHTML = PublicProfile.equipment.lenses.map((l, i) => 
                `<div class="equipment-tag">ðŸ”­ ${l} <span class="remove" onclick="app.PublicProfile.removeEquipment('lens', ${i})">âœ–</span></div>`
            ).join('');
        }
        
        // LumiÃ¨re
        const lightList = document.getElementById('light-list');
        if(lightList) {
            lightList.innerHTML = PublicProfile.equipment.lights.map((l, i) => 
                `<div class="equipment-tag">ðŸ’¡ ${l} <span class="remove" onclick="app.PublicProfile.removeEquipment('light', ${i})">âœ–</span></div>`
            ).join('');
        }
        
        // Son
        const soundList = document.getElementById('sound-list');
        if(soundList) {
            soundList.innerHTML = PublicProfile.equipment.sounds.map((s, i) => 
                `<div class="equipment-tag">ðŸŽ¤ ${s} <span class="remove" onclick="app.PublicProfile.removeEquipment('sound', ${i})">âœ–</span></div>`
            ).join('');
        }
        
        // Machinerie
        const gripList = document.getElementById('grip-list');
        if(gripList) {
            gripList.innerHTML = PublicProfile.equipment.grips.map((g, i) => 
                `<div class="equipment-tag">ðŸŽ¬ ${g} <span class="remove" onclick="app.PublicProfile.removeEquipment('grip', ${i})">âœ–</span></div>`
            ).join('');
        }
        
        // Maquillage
        const makeupList = document.getElementById('makeup-list');
        if(makeupList) {
            makeupList.innerHTML = PublicProfile.equipment.makeups.map((m, i) => 
                `<div class="equipment-tag">ðŸ’„ ${m} <span class="remove" onclick="app.PublicProfile.removeEquipment('makeup', ${i})">âœ–</span></div>`
            ).join('');
        }
        
        // Autre
        const otherList = document.getElementById('other-equipment-list');
        if(otherList) {
            otherList.innerHTML = PublicProfile.equipment.other.map((o, i) => 
                `<div class="equipment-tag">ðŸ”§ ${o} <span class="remove" onclick="app.PublicProfile.removeEquipment('other', ${i})">âœ–</span></div>`
            ).join('');
        }
    },
    
    // ========== CALENDRIER DISPONIBILITÃ‰S PROFIL ==========
    _profileCalMonth: new Date().getMonth(),
    _profileCalYear: new Date().getFullYear(),
    _profileCalDrag: { active: false, dates: [], isRightClick: false },
    
    renderProfileCalendar: () => {
        const container = document.getElementById('profile-availability-calendar');
        if(!container) return;
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        const year = PublicProfile._profileCalYear;
        const month = PublicProfile._profileCalMonth;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        
        const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
        const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        
        const availDates = profile.availabilityDates || [];
        const unavailDates = profile.unavailabilityDates || [];
        
        const isDateInRange = (dateStr, ranges) => {
            return ranges.some(range => {
                if(!range.from || !range.to) return false;
                return dateStr >= range.from && dateStr <= range.to;
            });
        };
        
        let html = `<div class="availability-calendar">
            <div class="availability-calendar-header">
                <button onclick="app.PublicProfile.changeProfileCalMonth(-1)">â—€</button>
                <strong>${monthNames[month]} ${year}</strong>
                <button onclick="app.PublicProfile.changeProfileCalMonth(1)">â–¶</button>
            </div>
            <div class="availability-calendar-grid">`;
        
        dayNames.forEach(d => {
            html += `<div class="availability-calendar-day-header">${d}</div>`;
        });
        
        for(let i = 0; i < startDay; i++) {
            html += `<div class="availability-calendar-day empty"></div>`;
        }
        
        const today = new Date();
        for(let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
            const isAvail = isDateInRange(dateStr, availDates);
            const isUnavail = isDateInRange(dateStr, unavailDates);
            
            let dayClass = 'availability-calendar-day';
            if(isToday) dayClass += ' today';
            if(isAvail) dayClass += ' available';
            if(isUnavail) dayClass += ' unavailable';
            
            html += `<div class="${dayClass}" 
                data-date="${dateStr}"
                onmousedown="app.PublicProfile.startProfileCalDrag('${dateStr}', event)"
                onmouseenter="app.PublicProfile.continueProfileCalDrag('${dateStr}')"
                onmouseup="app.PublicProfile.endProfileCalDrag()"
                oncontextmenu="return false;">${day}</div>`;
        }
        
        html += `</div></div>`;
        container.innerHTML = html;
    },
    
    changeProfileCalMonth: (delta) => {
        PublicProfile._profileCalMonth += delta;
        if(PublicProfile._profileCalMonth > 11) {
            PublicProfile._profileCalMonth = 0;
            PublicProfile._profileCalYear++;
        }
        if(PublicProfile._profileCalMonth < 0) {
            PublicProfile._profileCalMonth = 11;
            PublicProfile._profileCalYear--;
        }
        PublicProfile.renderProfileCalendar();
    },
    
    startProfileCalDrag: (dateStr, event) => {
        event.preventDefault();
        const isRightClick = event.button === 2;
        PublicProfile._profileCalDrag = { active: true, dates: [dateStr], isRightClick };
        document.addEventListener('mouseup', PublicProfile.endProfileCalDrag);
    },
    
    continueProfileCalDrag: (dateStr) => {
        if(!PublicProfile._profileCalDrag.active) return;
        if(!PublicProfile._profileCalDrag.dates.includes(dateStr)) {
            PublicProfile._profileCalDrag.dates.push(dateStr);
        }
        const container = document.getElementById('profile-availability-calendar');
        if(container) {
            const color = PublicProfile._profileCalDrag.isRightClick ? '#f44336' : '#4CAF50';
            container.querySelectorAll('.availability-calendar-day').forEach(el => {
                if(PublicProfile._profileCalDrag.dates.includes(el.dataset.date)) {
                    el.style.background = color;
                    el.style.color = 'white';
                }
            });
        }
    },
    
    endProfileCalDrag: () => {
        if(!PublicProfile._profileCalDrag.active) return;
        
        const { dates, isRightClick } = PublicProfile._profileCalDrag;
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        
        if(dates.length > 0 && profile) {
            dates.sort();
            const from = dates[0];
            const to = dates[dates.length - 1];
            
            if(!profile.availabilityDates) profile.availabilityDates = [];
            if(!profile.unavailabilityDates) profile.unavailabilityDates = [];
            
            const targetArray = isRightClick ? profile.unavailabilityDates : profile.availabilityDates;
            const otherArray = isRightClick ? profile.availabilityDates : profile.unavailabilityDates;
            
            if(dates.length === 1) {
                const existingIdx = targetArray.findIndex(range => {
                    const checkDate = new Date(dates[0]);
                    return checkDate >= new Date(range.from) && checkDate <= new Date(range.to);
                });
                if(existingIdx > -1) {
                    targetArray.splice(existingIdx, 1);
                } else {
                    const otherIdx = otherArray.findIndex(range => {
                        const checkDate = new Date(dates[0]);
                        return checkDate >= new Date(range.from) && checkDate <= new Date(range.to);
                    });
                    if(otherIdx > -1) {
                        otherArray.splice(otherIdx, 1);
                    }
                    targetArray.push({ from, to });
                }
            } else {
                targetArray.push({ from, to });
            }
            
            PublicProfile.renderProfileCalendar();
            PublicProfile.renderProfileDatesList();
        }
        
        PublicProfile._profileCalDrag = { active: false, dates: [], isRightClick: false };
        document.removeEventListener('mouseup', PublicProfile.endProfileCalDrag);
    },
    
    renderProfileDatesList: () => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        const availList = document.getElementById('profile-avail-dates-list');
        const unavailList = document.getElementById('profile-unavail-dates-list');
        
        if(availList) {
            const availDates = profile.availabilityDates || [];
            if(availDates.length > 0) {
                availList.innerHTML = availDates.map((d, i) => 
                    `<span style="display:inline-flex; align-items:center; background:#E8F5E9; border:1px solid #4CAF50; color:#2E7D32; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">âœ“ ${d.from} â†’ ${d.to} <span onclick="app.PublicProfile.removeProfileDate('avail', ${i})" class="delete-link">âœ–</span></span>`
                ).join('');
            } else {
                availList.innerHTML = '<span class="text-sec-xs">Aucune pÃ©riode renseignÃ©e</span>';
            }
        }
        
        if(unavailList) {
            const unavailDates = profile.unavailabilityDates || [];
            if(unavailDates.length > 0) {
                unavailList.innerHTML = unavailDates.map((d, i) => 
                    `<span style="display:inline-flex; align-items:center; background:#FFEBEE; border:1px solid #f44336; color:#C62828; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">âœ— ${d.from} â†’ ${d.to} <span onclick="app.PublicProfile.removeProfileDate('unavail', ${i})" class="delete-link">âœ–</span></span>`
                ).join('');
            } else {
                unavailList.innerHTML = '<span class="text-sec-xs">Aucune pÃ©riode renseignÃ©e</span>';
            }
        }
    },
    
    removeProfileDate: (type, idx) => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        if(type === 'avail' && profile.availabilityDates) {
            profile.availabilityDates.splice(idx, 1);
        } else if(type === 'unavail' && profile.unavailabilityDates) {
            profile.unavailabilityDates.splice(idx, 1);
        }
        
        PublicProfile.renderProfileCalendar();
        PublicProfile.renderProfileDatesList();
    },
    
    // Met Ã  jour le style des labels de collaboration
    updateCollabLabel: (type) => {
        const labels = {
            'pro': { id: 'label-collab-pro', checkId: 'profile-collab-pro', color: '#4CAF50' },
            'semi': { id: 'label-collab-semi', checkId: 'profile-collab-semi', color: '#FF9800' },
            'benevole': { id: 'label-collab-benevole', checkId: 'profile-collab-benevole', color: '#E91E63' }
        };
        
        const info = labels[type];
        if(!info) return;
        
        const label = document.getElementById(info.id);
        const checkbox = document.getElementById(info.checkId);
        
        if(label && checkbox) {
            if(checkbox.checked) {
                label.style.background = info.color;
                label.style.color = 'white';
            } else {
                label.style.background = 'var(--bg)';
                label.style.color = 'var(--text-main)';
            }
        }
    },
    
    // Charge les checkboxes de collaboration depuis le profil
    loadCollabTypes: (profile) => {
        const collabTypes = profile.collabTypes || [];
        
        const proCheck = document.getElementById('profile-collab-pro');
        const semiCheck = document.getElementById('profile-collab-semi');
        const benevoleCheck = document.getElementById('profile-collab-benevole');
        
        if(proCheck) proCheck.checked = collabTypes.includes('pro');
        if(semiCheck) semiCheck.checked = collabTypes.includes('semi-pro');
        if(benevoleCheck) benevoleCheck.checked = collabTypes.includes('benevole');
        
        PublicProfile.updateCollabLabel('pro');
        PublicProfile.updateCollabLabel('semi');
        PublicProfile.updateCollabLabel('benevole');
    },
    
    // Sauvegarde les checkboxes de collaboration dans le profil
    saveCollabTypes: (profile) => {
        const collabTypes = [];
        
        if(document.getElementById('profile-collab-pro')?.checked) collabTypes.push('pro');
        if(document.getElementById('profile-collab-semi')?.checked) collabTypes.push('semi-pro');
        if(document.getElementById('profile-collab-benevole')?.checked) collabTypes.push('benevole');
        
        profile.collabTypes = collabTypes;
    },
    
    // Publier une actualitÃ© (limite 1 par jour)
    publishActualite: async () => {
        const content = document.getElementById('profile-actualite-content')?.value?.trim();
        if(!content) {
            Utils.toast('Ã‰crivez quelque chose avant de publier', 'warning');
            return;
        }
        
        if(!state.currentUser) return;
        
        // VÃ©rifier si dÃ©jÃ  publiÃ© aujourd'hui
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const { data: existing, error: checkError } = await supabase
            .from('profile_actualites')
            .select('id, created_at')
            .eq('author_email', state.currentUser.email)
            .gte('created_at', today.toISOString());
        
        if(!checkError && existing && existing.length > 0) {
            Utils.toast('ðŸš« Vous avez dÃ©jÃ  publiÃ© une actualitÃ© aujourd\'hui. Revenez demain !', 'warning', 5000);
            return;
        }
        
        // Publier
        const { error } = await supabase
            .from('profile_actualites')
            .insert({
                author_email: state.currentUser.email,
                author_name: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
                content: content
            });
        
        if(error) {
            console.error('Erreur publication actualitÃ©:', error);
            Utils.toast('Erreur lors de la publication', 'error');
            return;
        }
        
        document.getElementById('profile-actualite-content').value = '';
        Utils.toast('ðŸ“° ActualitÃ© publiÃ©e !', 'success');
        PublicProfile.loadMyActualites();
    },
    
    // Charger mes actualitÃ©s
    loadMyActualites: async () => {
        if(!state.currentUser) return;
        
        const container = document.getElementById('profile-my-actualites');
        if(!container) return;
        
        const { data: actualites } = await supabase
            .from('profile_actualites')
            .select('*')
            .eq('author_email', state.currentUser.email)
            .order('created_at', { ascending: false })
            .limit(5);
        
        if(!actualites || actualites.length === 0) {
            container.innerHTML = '<p class="text-sec-italic">Aucune actualitÃ© publiÃ©e</p>';
            return;
        }
        
        container.innerHTML = '<h4 style="margin-bottom: 10px; font-size: 0.9rem; color: var(--text-sec);">Mes derniÃ¨res actualitÃ©s :</h4>' +
            actualites.map(a => `
                <div style="padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                        <div class="flex-1">
                            <div class="text-sec-sm-mb5">${Utils.timeAgo(a.created_at)}</div>
                            <div>${Utils.escape(a.content)}</div>
                        </div>
                        <button onclick="app.PublicProfile.deleteActualite('${a.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 5px;" title="Supprimer">ðŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        
        // Mettre Ã  jour le statut
        const statusEl = document.getElementById('profile-actualite-status');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayPost = actualites.find(a => new Date(a.created_at) >= today);
        
        if(todayPost) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'var(--warning-bg, #fff3cd)';
            statusEl.style.color = 'var(--warning-text, #856404)';
            statusEl.innerHTML = 'â³ Vous avez dÃ©jÃ  publiÃ© aujourd\'hui. Prochaine publication possible demain.';
        } else {
            statusEl.style.display = 'none';
        }
    },
    
    // Supprimer une actualitÃ©
    deleteActualite: async (id) => {
        if(!confirm('Supprimer cette actualitÃ© ?')) return;
        
        const { error } = await supabase
            .from('profile_actualites')
            .delete()
            .eq('id', id);
        
        if(error) {
            Utils.toast('Erreur lors de la suppression', 'error');
            return;
        }
        
        Utils.toast('ActualitÃ© supprimÃ©e', 'success');
        PublicProfile.loadMyActualites();
    }
};

const Chat = {
    currentChannel: null,
    channels: [
        { id: 'general', name: 'ðŸ“¢ GÃ©nÃ©ral', icon: 'ðŸ“¢', type: 'system', description: 'Tout le monde' },
        { id: 'chefs', name: 'ðŸ’¼ Chefs de poste', icon: 'ðŸ’¼', type: 'system', description: 'RÃ©al, Chefs de dÃ©partement' },
        { id: 'technique', name: 'ðŸ”§ Technique', icon: 'ðŸ”§', type: 'system', description: 'Ã‰quipe technique' },
        { id: 'comediens', name: 'ðŸŽ­ ComÃ©diens', icon: 'ðŸŽ­', type: 'system', description: 'ComÃ©diens du projet' }
    ],
    messagesListener: null,
    
    init: () => {
        Chat.loadCustomChannels();
        Chat.renderChannelsList();
        
        // SÃ©lectionner le canal gÃ©nÃ©ral par dÃ©faut
        if(!Chat.currentChannel) {
            Chat.selectChannel('general');
        }
    },
    
    loadCustomChannels: () => {
        // Charger les canaux personnalisÃ©s depuis les donnÃ©es du projet
        if(state.data.chatChannels) {
            state.data.chatChannels.forEach(ch => {
                if(!Chat.channels.find(c => c.id === ch.id)) {
                    Chat.channels.push(ch);
                }
            });
        }
    },
    
    renderChannelsList: () => {
        const container = document.getElementById('chat-channels-list');
        if(!container) return;
        
        const userEmail = state.currentUser?.email;
        const userPerms = Permissions.getCurrentUserPermissions();
        
        let html = '<div class="mb-15"><div style="font-size: 0.75rem; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase;">Canaux principaux</div>';
        
        // Canaux systÃ¨me
        Chat.channels.filter(c => c.type === 'system').forEach(channel => {
            // VÃ©rifier accÃ¨s
            const hasAccess = Chat.canAccessChannel(channel.id);
            if(!hasAccess && state.currentRole !== 'owner') return;
            
            const isActive = Chat.currentChannel === channel.id;
            html += `
                <div class="chat-channel-item ${isActive ? 'active' : ''}" onclick="app.Chat.selectChannel('${channel.id}')" style="padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; background: ${isActive ? 'var(--primary)' : 'var(--bg)'}; color: ${isActive ? 'white' : 'var(--text-main)'};">
                    <div class="fw-600">${channel.icon} ${channel.name.replace(channel.icon + ' ', '')}</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">${channel.description}</div>
                </div>
            `;
        });
        html += '</div>';
        
        // Canaux personnalisÃ©s
        const customChannels = Chat.channels.filter(c => c.type === 'custom');
        if(customChannels.length > 0 || state.currentRole === 'owner') {
            html += '<div><div style="font-size: 0.75rem; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase;">Groupes personnalisÃ©s</div>';
            
            customChannels.forEach(channel => {
                // VÃ©rifier si l'utilisateur est membre
                const isMember = channel.members?.includes(Utils.sanitizeEmail(userEmail)) || state.currentRole === 'owner';
                if(!isMember) return;
                
                const isActive = Chat.currentChannel === channel.id;
                html += `
                    <div class="chat-channel-item ${isActive ? 'active' : ''}" onclick="app.Chat.selectChannel('${channel.id}')" style="padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; background: ${isActive ? 'var(--primary)' : 'var(--bg)'}; color: ${isActive ? 'white' : 'var(--text-main)'}; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="fw-600">${channel.icon || 'ðŸ’¬'} ${Utils.escape(channel.name)}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">${channel.members?.length || 0} membre(s)</div>
                        </div>
                        ${state.currentRole === 'owner' ? `<button onclick="event.stopPropagation(); app.Chat.deleteChannel('${channel.id}')" style="background: none; border: none; cursor: pointer; opacity: 0.6;">ðŸ—‘ï¸</button>` : ''}
                    </div>
                `;
            });
            html += '</div>';
        }
        
        container.innerHTML = html;
    },
    
    canAccessChannel: (channelId) => {
        if(state.currentRole === 'owner') return true;
        
        const userPerms = Permissions.getCurrentUserPermissions();
        
        switch(channelId) {
            case 'general':
                return userPerms.chat_general === 'write';
            case 'chefs':
                return userPerms.chat_chefs === 'write';
            case 'technique':
                return userPerms.chat_technique === 'write';
            case 'comediens':
                return userPerms.chat_comediens === 'write';
            default:
                // Canal personnalisÃ© - vÃ©rifier si membre
                const channel = Chat.channels.find(c => c.id === channelId);
                if(channel && channel.members) {
                    return channel.members.includes(Utils.sanitizeEmail(state.currentUser?.email));
                }
                return false;
        }
    },
    
    selectChannel: (channelId) => {
        Chat.currentChannel = channelId;
        Chat.renderChannelsList();
        
        const channel = Chat.channels.find(c => c.id === channelId);
        if(!channel) return;
        
        // Mettre Ã  jour le header
        document.getElementById('chat-channel-title').textContent = `${channel.icon || 'ðŸ’¬'} ${channel.name.replace(channel.icon + ' ', '')}`;
        document.getElementById('chat-members-btn').style.display = 'inline-block';
        document.getElementById('chat-input-container').style.display = 'block';
        
        // Charger les messages
        Chat.loadMessages(channelId);
        
        // Charger les membres
        Chat.loadMembers(channelId);
    },
    
    loadMessages: (channelId) => {
        const container = document.getElementById('chat-messages-container');
        container.innerHTML = '<div class="chat-empty">ðŸ”„ Chargement...</div>';
        
        // DÃ©tacher l'ancien listener
        if(Chat.messagesListener) {
            Chat.messagesListener();
            Chat.messagesListener = null;
        }
        
        // Ã‰couter les messages en temps rÃ©el via Supabase
        // Les messages du chat sont stockÃ©s dans le data du projet
        const loadChatMessages = async () => {
            try {
                const { data: project } = await supabase
                    .from('projects')
                    .select('data')
                    .eq('id', state.currentProjectId)
                    .single();
                
                const messages = project?.data?.chatMessages?.[channelId] || [];
                Chat.renderMessages(messages);
            } catch(error) {
                console.error('Erreur chargement messages:', error);
                Chat.renderMessages([]);
            }
        };
        
        loadChatMessages();
        
        // Ã‰couter les changements en temps rÃ©el
        Chat.messagesListener = supabase
            .channel('chat_' + state.currentProjectId + '_' + channelId)
            .on('postgres_changes', 
                { event: 'UPDATE', schema: 'public', table: 'projects', filter: 'id=eq.' + state.currentProjectId },
                (payload) => {
                    const messages = payload.new.data?.chatMessages?.[channelId] || [];
                    Chat.renderMessages(messages);
                }
            )
            .subscribe();
    },
    
    renderMessages: (messages) => {
        const container = document.getElementById('chat-messages-container');
        const userEmail = state.currentUser?.email;
        
        if(messages.length === 0) {
            container.innerHTML = `
                <div class="chat-empty">
                    <p class="fs-2-mb10">ðŸ’¬</p>
                    <p>Aucun message dans ce canal</p>
                    <p style="font-size: 0.85rem; opacity: 0.7;">Soyez le premier Ã  Ã©crire !</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        let lastDate = null;
        
        messages.forEach(msg => {
            const msgDate = new Date(msg.timestamp).toLocaleDateString('fr-FR');
            const msgTime = new Date(msg.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const isOwn = msg.senderEmail === userEmail;
            
            // SÃ©parateur de date
            if(msgDate !== lastDate) {
                html += `<div class="chat-date-separator">${msgDate}</div>`;
                lastDate = msgDate;
            }
            
            html += `
                <div class="chat-message ${isOwn ? 'own' : 'other'}">
                    ${!isOwn ? `<div class="chat-message-sender">${Utils.escape(msg.senderName)}</div>` : ''}
                    <div>${Utils.escape(msg.text)}</div>
                    <div class="chat-message-time">${msgTime}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Scroll en bas
        container.scrollTop = container.scrollHeight;
    },
    
    sendMessage: async () => {
        const input = document.getElementById('chat-message-input');
        const text = input.value.trim();
        
        if(!text || !Chat.currentChannel) return;
        
        const message = {
            id: 'msg_' + Date.now(),
            text: text,
            senderEmail: state.currentUser.email,
            senderName: state.userProfile?.name || state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            timestamp: Date.now()
        };
        
        try {
            // Charger les donnÃ©es actuelles du projet
            const { data: project } = await supabase
                .from('projects')
                .select('data')
                .eq('id', state.currentProjectId)
                .single();
            
            if(project) {
                // Initialiser la structure si nÃ©cessaire
                if(!project.data.chatMessages) project.data.chatMessages = {};
                if(!project.data.chatMessages[Chat.currentChannel]) project.data.chatMessages[Chat.currentChannel] = [];
                
                // Ajouter le message
                project.data.chatMessages[Chat.currentChannel].push(message);
                
                // Limiter Ã  100 messages
                if(project.data.chatMessages[Chat.currentChannel].length > 100) {
                    project.data.chatMessages[Chat.currentChannel] = project.data.chatMessages[Chat.currentChannel].slice(-100);
                }
                
                // Sauvegarder
                await supabase.from('projects').update({ data: project.data }).eq('id', state.currentProjectId);
                
                // RafraÃ®chir l'affichage
                Chat.renderMessages(project.data.chatMessages[Chat.currentChannel]);
            }
            input.value = '';
        } catch(e) {
            console.error('Erreur envoi message:', e);
            Utils.toast('Erreur lors de l\'envoi du message', 'error');
        }
    },
    
    loadMembers: (channelId) => {
        const container = document.getElementById('chat-members-list');
        const addSection = document.getElementById('chat-add-member-section');
        if(!container) return;
        
        const channel = Chat.channels.find(c => c.id === channelId);
        let members = [];
        
        if(channel.type === 'system') {
            // Membres basÃ©s sur les permissions + membres ajoutÃ©s manuellement
            members = Chat.getSystemChannelMembers(channelId);
            addSection.style.display = state.currentRole === 'owner' ? 'block' : 'none';
        } else {
            // Membres du canal personnalisÃ©
            members = Chat.getCustomChannelMembers(channel);
            addSection.style.display = state.currentRole === 'owner' ? 'block' : 'none';
        }
        
        if(members.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-sec);">Aucun membre</div>';
            return;
        }
        
        let html = '';
        members.forEach(member => {
            const photoHTML = member.photo ? `<img src="${member.photo}">` : 'ðŸ‘¤';
            html += `
                <div class="chat-member-item">
                    <div class="chat-member-photo">${photoHTML}</div>
                    <div>
                        <div style="font-weight: 500; font-size: 0.9rem;">${Utils.escape(member.name)}</div>
                        <div class="text-sec-xs-alt">${Utils.escape(member.role || 'Membre')}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    getSystemChannelMembers: (channelId) => {
        const members = [];
        const ownerEmail = state.data.meta?.owner || state.currentUser?.email;
        
        // Ajouter le propriÃ©taire
        members.push({
            name: ownerEmail.split('@')[0],
            email: ownerEmail,
            role: 'PropriÃ©taire',
            photo: null
        });
        
        // Ajouter les membres ajoutÃ©s manuellement
        const extraMembers = state.data.chatExtraMembers?.[channelId] || [];
        extraMembers.forEach(emailKey => {
            const actor = state.data.actors?.find(a => Utils.sanitizeEmail(a.email) === emailKey);
            if(actor && !members.find(m => m.email === actor.email)) {
                members.push({ name: actor.name, email: actor.email, role: 'ComÃ©dien.ne (ajoutÃ©)', photo: actor.photo });
                return;
            }
            const crew = state.data.crew?.find(c => Utils.sanitizeEmail(c.email) === emailKey);
            if(crew && !members.find(m => m.email === crew.email)) {
                members.push({ name: crew.name, email: crew.email, role: (crew.role || 'Technicien') + ' (ajoutÃ©)', photo: crew.photo });
            }
        });
        
        // Selon le canal
        if(channelId === 'general') {
            // Tout le monde
            state.data.actors?.forEach(a => {
                if(a.email && !members.find(m => m.email === a.email)) {
                    members.push({ name: a.name, email: a.email, role: 'ComÃ©dien.ne', photo: a.photo });
                }
            });
            state.data.crew?.forEach(c => {
                if(c.email && !members.find(m => m.email === c.email)) {
                    members.push({ name: c.name, email: c.email, role: c.role || 'Technicien', photo: c.photo });
                }
            });
        } else if(channelId === 'chefs') {
            // Chefs de poste
            state.data.crew?.forEach(c => {
                if(c.email && (c.role?.includes('Chef') || c.role?.includes('Directeur') || c.role?.includes('RÃ©alisateur'))) {
                    if(!members.find(m => m.email === c.email)) {
                        members.push({ name: c.name, email: c.email, role: c.role, photo: c.photo });
                    }
                }
            });
        } else if(channelId === 'technique') {
            // Ã‰quipe technique
            state.data.crew?.forEach(c => {
                if(c.email && !members.find(m => m.email === c.email)) {
                    members.push({ name: c.name, email: c.email, role: c.role || 'Technicien', photo: c.photo });
                }
            });
        } else if(channelId === 'comediens') {
            // ComÃ©diens
            state.data.actors?.forEach(a => {
                if(a.email && !members.find(m => m.email === a.email)) {
                    members.push({ name: a.name, email: a.email, role: 'ComÃ©dien.ne', photo: a.photo });
                }
            });
        }
        
        return members;
    },
    
    getCustomChannelMembers: (channel) => {
        const members = [];
        if(!channel.members) return members;
        
        channel.members.forEach(emailKey => {
            // Chercher dans actors
            const actor = state.data.actors?.find(a => Utils.sanitizeEmail(a.email) === emailKey);
            if(actor) {
                members.push({ name: actor.name, email: actor.email, role: 'ComÃ©dien.ne', photo: actor.photo });
                return;
            }
            
            // Chercher dans crew
            const crew = state.data.crew?.find(c => Utils.sanitizeEmail(c.email) === emailKey);
            if(crew) {
                members.push({ name: crew.name, email: crew.email, role: crew.role || 'Technicien', photo: crew.photo });
                return;
            }
            
            // Sinon juste l'email
            members.push({ name: emailKey.replace(/,/g, '.'), email: emailKey, role: 'Membre', photo: null });
        });
        
        return members;
    },
    
    toggleMembersPanel: () => {
        const panel = document.getElementById('chat-members-panel');
        if(panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'flex';
        } else {
            panel.style.display = 'none';
        }
    },
    
    createCustomChannel: () => {
        if(state.currentRole !== 'owner') {
            Utils.toast('Seul le propriÃ©taire peut crÃ©er des groupes.', 'error');
            return;
        }
        
        // Modal de crÃ©ation avec nom + icÃ´ne
        const modal = document.createElement('div');
        modal.id = 'create-channel-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10001;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:400px;width:90%;">
                <h3 class="mt-0">âž• Nouveau groupe de discussion</h3>
                <div class="mb-15">
                    <label class="label-bold">IcÃ´ne</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div id="new-channel-icon" class="n8-flex-1">ðŸ’¬</div>
                        <button onclick="app.Utils.showIconPicker((icon) => document.getElementById('new-channel-icon').textContent = icon)" style="padding:8px 15px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Changer</button>
                    </div>
                </div>
                <div class="mb-20">
                    <label class="label-bold">Nom du groupe</label>
                    <input type="text" id="new-channel-name" placeholder="Ex: Ã‰quipe nuit, Cascadeurs..." class="n8-input-13">
                </div>
                <div class="flex-end-compact">
                    <button onclick="this.closest('div[style*=fixed]').remove()" class="btn-outline-compact">Annuler</button>
                    <button onclick="app.Chat.confirmCreateChannel()" class="btn-success-compact2">CrÃ©er</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('new-channel-name').focus();
    },
    
    confirmCreateChannel: () => {
        const name = document.getElementById('new-channel-name').value.trim();
        const icon = document.getElementById('new-channel-icon').textContent;
        
        if(!name) {
            Utils.toast('Veuillez entrer un nom pour le groupe.', 'warning');
            return;
        }
        
        const newChannel = {
            id: 'custom_' + Date.now(),
            name: name,
            icon: icon,
            type: 'custom',
            description: 'Groupe personnalisÃ©',
            members: [Utils.sanitizeEmail(state.currentUser.email)],
            createdBy: state.currentUser.email,
            createdAt: new Date().toISOString()
        };
        
        // Ajouter Ã  la liste
        Chat.channels.push(newChannel);
        
        // Sauvegarder dans les donnÃ©es du projet
        if(!state.data.chatChannels) state.data.chatChannels = [];
        state.data.chatChannels.push(newChannel);
        Store.save();
        
        // Fermer le modal
        const modal = document.getElementById('create-channel-modal');
        if(modal) modal.remove();
        
        Chat.renderChannelsList();
        Chat.selectChannel(newChannel.id);
        
        // Ouvrir le panel des membres (l'utilisateur pourra cliquer sur Ajouter)
        document.getElementById('chat-members-panel').style.display = 'flex';
    },
    
    deleteChannel: async (channelId) => {
        if(!await ConfirmModal.confirmDelete("Le groupe et tous ses messages seront supprimÃ©s.")) return;
        
        // Retirer de la liste locale
        Chat.channels = Chat.channels.filter(c => c.id !== channelId);
        
        // Retirer des donnÃ©es du projet
        if(state.data.chatChannels) {
            state.data.chatChannels = state.data.chatChannels.filter(c => c.id !== channelId);
        }
        
        // Supprimer les messages du canal
        if(state.data.chatMessages && state.data.chatMessages[channelId]) {
            delete state.data.chatMessages[channelId];
        }
        
        Store.save();
        
        if(Chat.currentChannel === channelId) {
            Chat.currentChannel = 'general';
        }
        
        Chat.renderChannelsList();
        Chat.selectChannel(Chat.currentChannel);
    },
    
    showAddMemberModal: () => {
        // RÃ©cupÃ©rer tous les membres du projet
        const allMembers = [];
        
        state.data.actors?.forEach(a => {
            if(a.email) allMembers.push({ name: a.name, email: a.email, type: 'actor', photo: a.photo });
        });
        
        state.data.crew?.forEach(c => {
            if(c.email) allMembers.push({ name: c.name, email: c.email, type: 'crew', role: c.role, photo: c.photo });
        });
        
        const channel = Chat.channels.find(c => c.id === Chat.currentChannel);
        if(!channel || channel.type !== 'custom') return;
        
        const currentMembers = channel.members || [];
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10001;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        let membersHtml = '';
        allMembers.forEach((m, idx) => {
            const isSelected = currentMembers.includes(Utils.sanitizeEmail(m.email));
            const photoHTML = m.photo ? `<img src="${m.photo}" style="width:100%;height:100%;object-fit:cover;">` : 'ðŸ‘¤';
            membersHtml += `
                <label class="chat-member-item ${isSelected ? 'selected' : ''}" style="cursor:pointer;">
                    <input type="checkbox" value="${Utils.sanitizeEmail(m.email)}" ${isSelected ? 'checked' : ''} style="margin-right: 10px;">
                    <div class="chat-member-photo">${photoHTML}</div>
                    <div>
                        <div style="font-weight: 500;">${Utils.escape(m.name)}</div>
                        <div class="text-sec-xs-alt">${m.type === 'actor' ? 'ComÃ©dien.ne' : (m.role || 'Technicien')}</div>
                    </div>
                </label>
            `;
        });
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto;">
                <h3 class="mt-0">ðŸ‘¥ GÃ©rer les membres</h3>
                <p style="color:var(--text-sec); font-size:0.9rem;">SÃ©lectionnez les personnes Ã  ajouter au groupe "${channel.name}"</p>
                <div style="margin: 20px 0; max-height: 300px; overflow-y: auto;">
                    ${membersHtml || '<p class="text-sec">Aucun membre disponible</p>'}
                </div>
                <div class="flex-end-compact">
                    <button onclick="this.closest('div[style*=fixed]').remove()" class="btn-outline-compact">Annuler</button>
                    <button onclick="app.Chat.saveChannelMembers(this.closest('div[style*=fixed]'))" class="btn-success-compact2">âœ“ Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    saveChannelMembers: (modal) => {
        const channel = Chat.channels.find(c => c.id === Chat.currentChannel);
        if(!channel) return;
        
        const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
        const members = [Utils.sanitizeEmail(state.currentUser.email)]; // Toujours inclure le propriÃ©taire
        
        checkboxes.forEach(cb => {
            if(!members.includes(cb.value)) {
                members.push(cb.value);
            }
        });
        
        if(channel.type === 'custom') {
            channel.members = members;
            
            // Mettre Ã  jour dans state.data
            const dataChannel = state.data.chatChannels?.find(c => c.id === channel.id);
            if(dataChannel) {
                dataChannel.members = members;
            }
        } else {
            // Pour les canaux systÃ¨me, stocker les membres extra
            if(!state.data.chatExtraMembers) state.data.chatExtraMembers = {};
            state.data.chatExtraMembers[channel.id] = members;
        }
        
        Store.save();
        
        modal.remove();
        Chat.loadMembers(Chat.currentChannel);
        Chat.renderChannelsList();
    },
    
    cleanup: () => {
        // DÃ©tacher le listener quand on quitte le projet
        if(Chat.messagesListener) {
            Chat.messagesListener();
            Chat.messagesListener = null;
        }
        Chat.currentChannel = null;
    }
};

const Permissions = {
    // Obtenir les permissions d'un membre du projet
    getForMember: (member, type) => {
        // type = 'actor' ou 'crew'
        if(type === 'actor') {
            return CONFIG.defaultPermissions['comedien'];
        }
        
        // Pour les techniciens, chercher par rÃ´le
        const role = member.role || '';
        
        // Chercher une correspondance exacte
        if(CONFIG.defaultPermissions[role]) {
            return CONFIG.defaultPermissions[role];
        }
        
        // VÃ©rifier si c'est un chef de poste (contient "Chef" ou "Directeur")
        if(role.includes('Chef') || role.includes('Directeur') || role.includes('RÃ©alisateur')) {
            return CONFIG.defaultPermissions['chef_de_poste'];
        }
        
        // Par dÃ©faut, technicien standard
        return CONFIG.defaultPermissions['technicien'];
    },
    
    // Obtenir les permissions actuelles d'un utilisateur sur le projet
    getCurrentUserPermissions: () => {
        if(state.currentRole === 'owner') {
            return CONFIG.defaultPermissions['owner'];
        }
        
        // Chercher l'utilisateur dans les membres du projet
        const userEmail = state.currentUser?.email;
        if(!userEmail) return CONFIG.defaultPermissions['technicien'];
        
        // VÃ©rifier dans les permissions personnalisÃ©es du projet
        if(state.data?.memberPermissions?.[Utils.sanitizeEmail(userEmail)]) {
            return state.data.memberPermissions[Utils.sanitizeEmail(userEmail)];
        }
        
        // Chercher dans les comÃ©diens
        const actor = state.data?.actors?.find(a => a.email === userEmail);
        if(actor) return Permissions.getForMember(actor, 'actor');
        
        // Chercher dans l'Ã©quipe
        const crew = state.data?.crew?.find(c => c.email === userEmail);
        if(crew) return Permissions.getForMember(crew, 'crew');
        
        // Par dÃ©faut selon le rÃ´le ACL
        if(state.currentRole === 'editor') {
            return CONFIG.defaultPermissions['chef_de_poste'];
        }
        
        return CONFIG.defaultPermissions['technicien'];
    },
    
    // VÃ©rifier si l'utilisateur peut accÃ©der Ã  une section
    canAccess: (section) => {
        if(state.currentRole === 'owner') return true;
        const perms = Permissions.getCurrentUserPermissions();
        return perms[section] && perms[section] !== 'none';
    },
    
    // VÃ©rifier si l'utilisateur peut modifier une section
    canEdit: (section) => {
        if(state.currentRole === 'owner') return true;
        const perms = Permissions.getCurrentUserPermissions();
        return perms[section] === 'write';
    },
    
    // Ouvrir le modal de gestion des permissions
    openModal: () => {
        if(state.currentRole !== 'owner') {
            Utils.toast('Seul le propriÃ©taire peut gÃ©rer les accÃ¨s.', 'error');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'permissions-modal';
        modal.id = 'permissions-modal';
        modal.onclick = (e) => { if(e.target === modal) Permissions.closeModal(); };
        
        modal.innerHTML = `
            <div class="permissions-container">
                <div class="permissions-header">
                    <h2>ðŸ” GÃ©rer les accÃ¨s au projet</h2>
                    <button onclick="app.Permissions.closeModal()" class="icon-btn">âœ–</button>
                </div>
                <div class="permissions-body">
                    <p class="text-sec-mb20">
                        DÃ©finissez les permissions pour chaque membre du projet. Les permissions par dÃ©faut sont basÃ©es sur le rÃ´le de chacun.
                    </p>
                    
                    <div class="permissions-section">
                        <h3>ðŸŽ­ ComÃ©dien.nes</h3>
                        <div id="perm-actors-table"></div>
                    </div>
                    
                    <div class="permissions-section">
                        <h3>ðŸŽ¥ Ã‰quipe technique</h3>
                        <div id="perm-crew-table"></div>
                    </div>
                    
                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                        <button onclick="app.Permissions.closeModal()" style="padding:10px 20px; background:var(--bg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Fermer</button>
                        <button onclick="app.Permissions.saveAll()" style="padding:10px 20px; background:var(--success); color:white; border:none; border-radius:6px; cursor:pointer;">ðŸ’¾ Sauvegarder</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        Permissions.renderTables();
    },
    
    closeModal: () => {
        const modal = document.getElementById('permissions-modal');
        if(modal) modal.remove();
    },
    
    renderTables: () => {
        // Table des comÃ©diens
        const actorsDiv = document.getElementById('perm-actors-table');
        if(actorsDiv) {
            if(!state.data.actors || state.data.actors.length === 0) {
                actorsDiv.innerHTML = '<p style="color:var(--text-sec); font-style:italic;">Aucun comÃ©dien dans le projet</p>';
            } else {
                actorsDiv.innerHTML = Permissions.buildTable(state.data.actors, 'actor');
            }
        }
        
        // Table de l'Ã©quipe
        const crewDiv = document.getElementById('perm-crew-table');
        if(crewDiv) {
            if(!state.data.crew || state.data.crew.length === 0) {
                crewDiv.innerHTML = '<p style="color:var(--text-sec); font-style:italic;">Aucun technicien dans le projet</p>';
            } else {
                crewDiv.innerHTML = Permissions.buildTable(state.data.crew, 'crew');
            }
        }
    },
    
    buildTable: (members, type) => {
        const sections = CONFIG.permissionSections;
        
        let html = `<div style="overflow-x:auto;"><table class="permissions-table">
            <thead>
                <tr>
                    <th style="min-width:180px;">Membre</th>
                    <th>Preset</th>
                    ${sections.map(s => `<th style="font-size:0.7rem; min-width:60px;">${s.label.split(' ')[0]}</th>`).join('')}
                </tr>
            </thead>
            <tbody>`;
        
        members.forEach((member, idx) => {
            const emailKey = member.email ? Utils.sanitizeEmail(member.email) : `${type}_${idx}`;
            const currentPerms = state.data.memberPermissions?.[emailKey] || Permissions.getForMember(member, type);
            const photoHTML = member.photo ? `<img src="${member.photo}">` : 'ðŸ‘¤';
            const roleLabel = type === 'actor' ? 'ComÃ©dien.ne' : (member.role || 'Technicien');
            
            html += `<tr>
                <td>
                    <div class="permissions-user-info">
                        <div class="permissions-user-photo">${photoHTML}</div>
                        <div>
                            <div class="permissions-user-name">${Utils.escape(member.name)}</div>
                            <div class="permissions-user-role">${Utils.escape(roleLabel)}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <select class="perm-select" onchange="app.Permissions.applyPreset('${emailKey}', '${type}', ${idx}, this.value)">
                        <option value="">PersonnalisÃ©</option>
                        <option value="comedien" ${type === 'actor' ? 'selected' : ''}>ComÃ©dien</option>
                        <option value="technicien">Technicien</option>
                        <option value="chef_de_poste">Chef de poste</option>
                        <option value="Scripte">Scripte</option>
                        <option value="1erÂ·Ã¨re assistantÂ·e rÃ©alisateurÂ·rice">1er Assistant RÃ©al</option>
                        <option value="DirecteurÂ·rice de casting">Dir. Casting</option>
                        <option value="RÃ©alisateurÂ·rice">RÃ©alisateur</option>
                        <option value="ProducteurÂ·rice">Producteur</option>
                    </select>
                </td>
                ${sections.map(s => `
                    <td>
                        <select class="perm-select" id="perm-${emailKey}-${s.id}" data-email="${emailKey}" data-section="${s.id}">
                            <option value="none" ${currentPerms[s.id] === 'none' ? 'selected' : ''}>âŒ</option>
                            <option value="read" ${currentPerms[s.id] === 'read' ? 'selected' : ''}>ðŸ‘ï¸</option>
                            <option value="write" ${currentPerms[s.id] === 'write' ? 'selected' : ''}>âœï¸</option>
                        </select>
                    </td>
                `).join('')}
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        // LÃ©gende
        html += `<div style="margin-top:10px; font-size:0.8rem; color:var(--text-sec);">
            <span style="margin-right:15px;">âŒ Aucun accÃ¨s</span>
            <span style="margin-right:15px;">ðŸ‘ï¸ Lecture seule</span>
            <span>âœï¸ Modification</span>
        </div>`;
        
        return html;
    },
    
    applyPreset: (emailKey, type, idx, preset) => {
        if(!preset) return;
        
        const perms = CONFIG.defaultPermissions[preset];
        if(!perms) return;
        
        CONFIG.permissionSections.forEach(s => {
            const select = document.getElementById(`perm-${emailKey}-${s.id}`);
            if(select) {
                select.value = perms[s.id] || 'none';
            }
        });
    },
    
    saveAll: async () => {
        if(!state.data.memberPermissions) {
            state.data.memberPermissions = {};
        }
        
        // RÃ©cupÃ©rer toutes les permissions depuis les selects
        const allSelects = document.querySelectorAll('.permissions-table select[data-email]');
        const permsByEmail = {};
        
        allSelects.forEach(select => {
            const email = select.dataset.email;
            const section = select.dataset.section;
            if(!permsByEmail[email]) permsByEmail[email] = {};
            permsByEmail[email][section] = select.value;
        });
        
        // Ajouter les permissions de chat par dÃ©faut
        Object.keys(permsByEmail).forEach(email => {
            permsByEmail[email].chat_general = 'write';
            permsByEmail[email].chat_chefs = permsByEmail[email].scenario === 'write' ? 'write' : 'none';
            permsByEmail[email].chat_technique = permsByEmail[email].depouillement !== 'none' ? 'write' : 'none';
            permsByEmail[email].chat_comediens = permsByEmail[email].comediens !== 'none' ? 'write' : 'none';
        });
        
        state.data.memberPermissions = permsByEmail;
        
        try {
            await Store.save();
            Utils.toast('Permissions sauvegardÃ©es !', 'success');
            Permissions.closeModal();
        } catch(e) {
            console.error('Erreur sauvegarde permissions:', e);
            Utils.toast('Erreur lors de la sauvegarde', 'error');
        }
    },
    
    // Initialiser les permissions pour un nouveau membre
    initForNewMember: (member, type) => {
        if(!member.email) return;
        
        const emailKey = Utils.sanitizeEmail(member.email);
        if(!state.data.memberPermissions) state.data.memberPermissions = {};
        
        if(!state.data.memberPermissions[emailKey]) {
            state.data.memberPermissions[emailKey] = { ...Permissions.getForMember(member, type) };
        }
    }
};

const GlobalSearch = {
    currentType: 'actors',
    results: [],
    
    openActors: () => {
        GlobalSearch.currentType = 'actors';
        GlobalSearch.open();
    },
    
    openCrew: () => {
        GlobalSearch.currentType = 'crew';
        GlobalSearch.open();
    },
    
    open: () => {
        const isActors = GlobalSearch.currentType === 'actors';
        
        const modal = document.createElement('div');
        modal.className = 'global-search-modal';
        modal.id = 'global-search-modal';
        modal.onclick = (e) => { if(e.target === modal) GlobalSearch.close(); };
        
        modal.innerHTML = `
            <div class="global-search-container">
                <div class="global-search-header">
                    <h2>${isActors ? 'ðŸŽ­ Rechercher un.e comÃ©dien.ne' : 'ðŸŽ¥ Rechercher un.e technicien.ne'}</h2>
                    <button onclick="app.GlobalSearch.close()" class="icon-btn">âœ–</button>
                </div>
                <div class="global-search-filters">
                    ${isActors ? GlobalSearch.getActorFiltersHTML() : GlobalSearch.getCrewFiltersHTML()}
                </div>
                <div class="global-search-results" id="global-search-results">
                    <div class="global-search-loading">ðŸ”„ Chargement...</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        GlobalSearch.search();
    },
    
    close: () => {
        const modal = document.getElementById('global-search-modal');
        if(modal) modal.remove();
    },
    
    getActorFiltersHTML: () => {
        return `
            <div class="global-search-filters-row">
                <input type="text" class="global-search-input min-w-200" id="gs-name" placeholder="ðŸ” Nom..." oninput="app.GlobalSearch.search()">
                <select class="global-search-input" id="gs-gender" onchange="app.GlobalSearch.search()">
                    <option value="">Tous sexes</option>
                    <option value="homme">Homme</option>
                    <option value="femme">Femme</option>
                    <option value="non-binaire">Non-binaire</option>
                </select>
                <select class="global-search-input" id="gs-ethnicity" onchange="app.GlobalSearch.search()">
                    <option value="">Toutes origines</option>
                    <option value="caucasien">Caucasien</option>
                    <option value="africain">Africain</option>
                    <option value="asiatique">Asiatique</option>
                    <option value="latino">Latino</option>
                    <option value="maghrebin">MaghrÃ©bin</option>
                    <option value="moyenorient">Moyen-Orient</option>
                    <option value="indien">Indien</option>
                    <option value="metis">MÃ©tis</option>
                </select>
                <select class="global-search-input" id="gs-hair" onchange="app.GlobalSearch.search()">
                    <option value="">Tous cheveux</option>
                    <option value="noir">Noir</option>
                    <option value="brun">Brun</option>
                    <option value="chatain">ChÃ¢tain</option>
                    <option value="blond">Blond</option>
                    <option value="roux">Roux</option>
                    <option value="chauve">Chauve</option>
                </select>
                <select class="global-search-input" id="gs-eyes" onchange="app.GlobalSearch.search()">
                    <option value="">Tous yeux</option>
                    <option value="marron">Marron</option>
                    <option value="bleu">Bleu</option>
                    <option value="vert">Vert</option>
                    <option value="gris">Gris</option>
                    <option value="noir">Noir</option>
                </select>
            </div>
            <div class="global-search-filters-row">
                <input type="text" class="global-search-input" id="gs-city" placeholder="ðŸ“ Ville / RÃ©gion..." oninput="app.GlobalSearch.search()">
                <input type="number" class="global-search-input" id="gs-age-min" placeholder="Ã‚ge min" style="width:80px;" oninput="app.GlobalSearch.search()">
                <input type="number" class="global-search-input" id="gs-age-max" placeholder="Ã‚ge max" style="width:80px;" oninput="app.GlobalSearch.search()">
                <input type="number" class="global-search-input" id="gs-height-min" placeholder="Taille min (cm)" style="width:110px;" oninput="app.GlobalSearch.search()">
                <input type="number" class="global-search-input" id="gs-height-max" placeholder="Taille max (cm)" style="width:110px;" oninput="app.GlobalSearch.search()">
                <input type="text" class="global-search-input" id="gs-sports" placeholder="ðŸ‡ Sport (Ã©quitation...)" oninput="app.GlobalSearch.search()">
                <input type="text" class="global-search-input" id="gs-languages" placeholder="ðŸ—£ï¸ Langue (anglais...)" oninput="app.GlobalSearch.search()">
                <select class="global-search-input" id="gs-collab" onchange="app.GlobalSearch.search()">
                    <option value="">Tous types collab</option>
                    <option value="pro">ðŸŽ¬ Pro</option>
                    <option value="semi-pro">âš¡ Semi-pro</option>
                    <option value="benevole">â¤ï¸ BÃ©nÃ©vole</option>
                </select>
            </div>
        `;
    },
    
    getCrewFiltersHTML: () => {
        return `
            <div class="global-search-filters-row">
                <input type="text" class="global-search-input min-w-200" id="gs-name" placeholder="ðŸ” Nom..." oninput="app.GlobalSearch.search()">
                <select class="global-search-input" id="gs-department" onchange="app.GlobalSearch.search()">
                    <option value="">Tous dÃ©partements</option>
                    <option value="image">ðŸ“¹ Image</option>
                    <option value="lumiere">ðŸ’¡ LumiÃ¨re</option>
                    <option value="realisation">ðŸŽ¬ RÃ©alisation</option>
                    <option value="son">ðŸŽ¤ Son</option>
                    <option value="decoration">ðŸŽ¨ DÃ©coration</option>
                    <option value="costumes">ðŸ‘— Costumes</option>
                    <option value="maquillage">ðŸ’„ Maquillage/Coiffure</option>
                    <option value="regie">ðŸŽ­ RÃ©gie</option>
                    <option value="production">ðŸ’¼ Production</option>
                    <option value="postprod">ðŸŽžï¸ Post-production</option>
                </select>
                <input type="text" class="global-search-input" id="gs-role" placeholder="Fonction (Chef op, Cadreur...)" oninput="app.GlobalSearch.search()">
                <input type="text" class="global-search-input" id="gs-city" placeholder="ðŸ“ Ville / RÃ©gion..." oninput="app.GlobalSearch.search()">
            </div>
            <div class="global-search-filters-row">
                <input type="text" class="global-search-input min-w-200" id="gs-camera" placeholder="ðŸ“· CamÃ©ra (RED, ARRI, Sony...)" oninput="app.GlobalSearch.search()">
                <input type="text" class="global-search-input min-w-200" id="gs-equipment" placeholder="ðŸ”§ MatÃ©riel (stabilisateur, drone...)" oninput="app.GlobalSearch.search()">
                <label style="display:flex; align-items:center; gap:5px; padding:8px; background:var(--input-bg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    <input type="checkbox" id="gs-vehicle" onchange="app.GlobalSearch.search()"> ðŸš— VÃ©hicule
                </label>
                <select class="global-search-input" id="gs-collab" onchange="app.GlobalSearch.search()">
                    <option value="">Tous types collab</option>
                    <option value="pro">ðŸŽ¬ Pro</option>
                    <option value="semi-pro">âš¡ Semi-pro</option>
                    <option value="benevole">â¤ï¸ BÃ©nÃ©vole</option>
                </select>
            </div>
        `;
    },
    
    search: async () => {
        const resultsDiv = document.getElementById('global-search-results');
        if(!resultsDiv) return;
        
        resultsDiv.innerHTML = '<div class="global-search-loading">ðŸ”„ Recherche en cours...</div>';
        
        const isActors = GlobalSearch.currentType === 'actors';
        
        try {
            // Rechercher dans user_profiles avec le bon type
            const profileType = isActors ? 'actor' : 'crew';
            const { data, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('profile_type', profileType)
                .eq('is_public', true);
            
            let results = [];
            if(!error && data) {
                // Extraire les donnÃ©es du champ JSONB pour chaque profil
                results = data.map(p => {
                    const extraData = p.data || {};
                    return {
                        ...p,
                        ...extraData,
                        type: p.profile_type || 'crew',
                        hasVehicle: p.vehicle || false,
                        availabilityText: p.availability || ''
                    };
                });
            }
            
            // Filtrer uniquement les profils complets
            results = results.filter(r => r.is_public);
            
            // Appliquer les filtres
            const name = (document.getElementById('gs-name')?.value || '').toLowerCase();
            const city = (document.getElementById('gs-city')?.value || '').toLowerCase();
            
            if(name) results = results.filter(r => (r.name || '').toLowerCase().includes(name));
            if(city) results = results.filter(r => (r.city || '').toLowerCase().includes(city));
            
            const collab = document.getElementById('gs-collab')?.value;
            if(collab) results = results.filter(r => r.collabType === collab);
            
            if(isActors) {
                const gender = document.getElementById('gs-gender')?.value;
                const ethnicity = document.getElementById('gs-ethnicity')?.value;
                const hair = document.getElementById('gs-hair')?.value;
                const eyes = document.getElementById('gs-eyes')?.value;
                const ageMin = parseInt(document.getElementById('gs-age-min')?.value) || 0;
                const ageMax = parseInt(document.getElementById('gs-age-max')?.value) || 999;
                const heightMin = parseInt(document.getElementById('gs-height-min')?.value) || 0;
                const heightMax = parseInt(document.getElementById('gs-height-max')?.value) || 999;
                const sports = (document.getElementById('gs-sports')?.value || '').toLowerCase();
                const languages = (document.getElementById('gs-languages')?.value || '').toLowerCase();
                
                if(gender) results = results.filter(r => r.gender === gender);
                if(ethnicity) results = results.filter(r => r.ethnicity === ethnicity);
                if(hair) results = results.filter(r => r.hairColor === hair);
                if(eyes) results = results.filter(r => r.eyeColor === eyes);
                if(ageMin > 0) results = results.filter(r => parseInt(r.age) >= ageMin);
                if(ageMax < 999) results = results.filter(r => parseInt(r.age) <= ageMax);
                if(heightMin > 0) results = results.filter(r => parseInt(r.height) >= heightMin);
                if(heightMax < 999) results = results.filter(r => parseInt(r.height) <= heightMax);
                if(sports) results = results.filter(r => (r.sports || '').toLowerCase().includes(sports));
                if(languages) results = results.filter(r => (r.languages || '').toLowerCase().includes(languages));
            } else {
                const department = document.getElementById('gs-department')?.value;
                const role = (document.getElementById('gs-role')?.value || '').toLowerCase();
                const camera = (document.getElementById('gs-camera')?.value || '').toLowerCase();
                const equipment = (document.getElementById('gs-equipment')?.value || '').toLowerCase();
                const hasVehicle = document.getElementById('gs-vehicle')?.checked;
                
                if(department) results = results.filter(r => r.department === department);
                if(role) results = results.filter(r => (r.role || '').toLowerCase().includes(role));
                if(camera) results = results.filter(r => (r.cameras || []).some(c => c.toLowerCase().includes(camera)));
                if(equipment) {
                    results = results.filter(r => {
                        const allEquip = [...(r.cameras || []), ...(r.lenses || []), ...(r.otherEquipment || [])].join(' ').toLowerCase();
                        return allEquip.includes(equipment);
                    });
                }
                if(hasVehicle) results = results.filter(r => r.hasVehicle);
            }
            
            GlobalSearch.results = results;
            GlobalSearch.renderResults();
            
        } catch(e) {
            console.error('Erreur recherche:', e);
            resultsDiv.innerHTML = '<div class="global-search-empty">âŒ Erreur lors de la recherche</div>';
        }
    },
    
    renderResults: () => {
        const resultsDiv = document.getElementById('global-search-results');
        if(!resultsDiv) return;
        
        const isActors = GlobalSearch.currentType === 'actors';
        const results = GlobalSearch.results;
        
        if(results.length === 0) {
            resultsDiv.innerHTML = `<div class="global-search-empty">
                <p style="font-size:1.2rem; margin-bottom:10px;">Aucun rÃ©sultat trouvÃ©</p>
                <p class="fs-09">Essayez d'Ã©largir vos critÃ¨res de recherche</p>
            </div>`;
            return;
        }
        
        let html = `<p class="text-sec-mb15-alt">${results.length} rÃ©sultat${results.length > 1 ? 's' : ''}</p>`;
        html += '<div class="global-search-results-grid">';
        
        results.forEach((person, idx) => {
            const photoHTML = person.photo 
                ? `<img src="${person.photo}" alt="${person.name || person.title}">`
                : defaultIcon;
            
            let metaHTML = '';
            let tagsHTML = '';
            
            if(isActors) {
                const details = [];
                if(person.age) details.push(person.age + ' ans');
                if(person.height) details.push(person.height + ' cm');
                if(person.city) details.push('ðŸ“ ' + person.city);
                metaHTML = details.join(' â€¢ ');
                
                if(person.collabType === 'pro') tagsHTML += `<span class="global-search-card-tag" style="background:#4CAF50;color:white;">ðŸŽ¬ Pro</span>`;
                if(person.collabType === 'semi-pro') tagsHTML += `<span class="global-search-card-tag" style="background:#FF9800;color:white;">âš¡ Semi-pro</span>`;
                if(person.collabType === 'benevole') tagsHTML += `<span class="global-search-card-tag" style="background:#E91E63;color:white;">â¤ï¸ BÃ©nÃ©vole</span>`;
                if(person.dailyRate) tagsHTML += `<span class="global-search-card-tag">ðŸ’° ${person.dailyRate}${person.rateCurrency || 'â‚¬'}</span>`;
                if(person.sports) tagsHTML += `<span class="global-search-card-tag">ðŸƒ ${person.sports}</span>`;
                if(person.languages) tagsHTML += `<span class="global-search-card-tag">ðŸ—£ï¸ ${person.languages}</span>`;
                if(person.hasVehicle) tagsHTML += `<span class="global-search-card-tag">ðŸš— VÃ©hicule</span>`;
                if(person.demoreel) tagsHTML += `<span class="global-search-card-tag">ðŸŽ¬ DÃ©mo</span>`;
                if(person.galleryPhotos && person.galleryPhotos.length > 0) tagsHTML += `<span class="global-search-card-tag">ðŸ“¸ ${person.galleryPhotos.length} photos</span>`;
            } else {
                const deptLabels = { image: 'ðŸ“¹ Image', lumiere: 'ðŸ’¡ LumiÃ¨re', realisation: 'ðŸŽ¬ RÃ©alisation', son: 'ðŸŽ¤ Son', decoration: 'ðŸŽ¨ DÃ©coration', costumes: 'ðŸ‘— Costumes', maquillage: 'ðŸ’„ Maquillage', regie: 'ðŸŽ­ RÃ©gie', production: 'ðŸ’¼ Production', postprod: 'ðŸŽžï¸ Post-prod' };
                metaHTML = (person.role || '') + (person.department ? ' â€¢ ' + (deptLabels[person.department] || person.department) : '');
                if(person.city) metaHTML += ' â€¢ ðŸ“ ' + person.city;
                
                if(person.collabType === 'pro') tagsHTML += `<span class="global-search-card-tag" style="background:#4CAF50;color:white;">ðŸŽ¬ Pro</span>`;
                if(person.collabType === 'semi-pro') tagsHTML += `<span class="global-search-card-tag" style="background:#FF9800;color:white;">âš¡ Semi-pro</span>`;
                if(person.collabType === 'benevole') tagsHTML += `<span class="global-search-card-tag" style="background:#E91E63;color:white;">â¤ï¸ BÃ©nÃ©vole</span>`;
                if(person.dailyRate) tagsHTML += `<span class="global-search-card-tag">ðŸ’° ${person.dailyRate}${person.rateCurrency || 'â‚¬'}</span>`;
                if(person.cameras && person.cameras.length > 0) {
                    person.cameras.slice(0, 3).forEach(c => tagsHTML += `<span class="global-search-card-tag">ðŸ“· ${c}</span>`);
                    if(person.cameras.length > 3) tagsHTML += `<span class="global-search-card-tag">+${person.cameras.length - 3}</span>`;
                }
                if(person.hasVehicle) tagsHTML += `<span class="global-search-card-tag">ðŸš— VÃ©hicule</span>`;
                if(person.demoreel) tagsHTML += `<span class="global-search-card-tag">ðŸŽ¬ DÃ©mo</span>`;
                if((person.crewGalleryPhotos && person.crewGalleryPhotos.length > 0) || (person.galleryPhotos && person.galleryPhotos.length > 0)) tagsHTML += `<span class="global-search-card-tag">ðŸ“¸ Photos</span>`;
            }
            
            html += `
                <div class="global-search-card">
                    <div class="global-search-card-header">
                        <div class="global-search-card-photo">${photoHTML}</div>
                        <div>
                            <div class="global-search-card-name">${Utils.escape(person.name)}</div>
                            <div class="global-search-card-meta">${metaHTML}</div>
                        </div>
                    </div>
                    ${tagsHTML ? `<div class="global-search-card-tags">${tagsHTML}</div>` : ''}
                    <div class="global-search-card-actions">
                        <button onclick="app.GlobalSearch.viewProfile(${idx})" style="background:var(--bg); border:1px solid var(--border); color:var(--text-main);">ðŸ‘ï¸ Voir profil</button>
                        <button onclick="app.GlobalSearch.addToProject(${idx})" style="background:var(--primary); border:none; color:white;">âž• Ajouter au projet</button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        resultsDiv.innerHTML = html;
    },
    
    viewProfile: (idx) => {
        const person = GlobalSearch.results[idx];
        if(!person) return;
        
        const isActors = GlobalSearch.currentType === 'actors';
        
        let detailsHTML = '';
        if(isActors) {
            detailsHTML = `
                <p><strong>Ã‚ge:</strong> ${person.age || 'N/A'} ans</p>
                <p><strong>Taille:</strong> ${person.height || 'N/A'} cm</p>
                <p><strong>Yeux:</strong> ${person.eyeColor || 'N/A'}</p>
                <p><strong>Cheveux:</strong> ${person.hairColor || 'N/A'} (${person.hairLength || 'N/A'})</p>
                <p><strong>Origine:</strong> ${person.ethnicity || 'N/A'}</p>
                ${person.sports ? `<p><strong>Sports:</strong> ${person.sports}</p>` : ''}
                ${person.languages ? `<p><strong>Langues:</strong> ${person.languages}</p>` : ''}
            `;
        } else {
            detailsHTML = `
                <p><strong>DÃ©partement:</strong> ${person.department || 'N/A'}</p>
                <p><strong>Fonction:</strong> ${person.role || 'N/A'}</p>
                ${person.cameras && person.cameras.length > 0 ? `<p><strong>CamÃ©ras:</strong> ${person.cameras.join(', ')}</p>` : ''}
                ${person.lenses && person.lenses.length > 0 ? `<p><strong>Objectifs:</strong> ${person.lenses.join(', ')}</p>` : ''}
                ${person.otherEquipment && person.otherEquipment.length > 0 ? `<p><strong>Autre matÃ©riel:</strong> ${person.otherEquipment.join(', ')}</p>` : ''}
            `;
        }
        
        const profileModal = document.createElement('div');
        profileModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:10001;';
        profileModal.onclick = (e) => { if(e.target === profileModal) profileModal.remove(); };
        
        profileModal.innerHTML = `
            <div class="modal-panel">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                    <div class="n8-avatar-4">
                        ${person.photo ? `<img src="${person.photo}" style="width:100%;height:100%;object-fit:cover;">` : 'ðŸ‘¤'}
                    </div>
                    <div>
                        <h2 class="m-0">${Utils.escape(person.name)}</h2>
                        <p style="margin:5px 0 0;color:var(--text-sec);">ðŸ“ ${person.city || 'Non prÃ©cisÃ©'}</p>
                    </div>
                </div>
                ${person.bio ? `<p class="mb-15">${Utils.escape(person.bio)}</p>` : ''}
                <div class="box-bg">
                    ${detailsHTML}
                </div>
                <div class="box-bg">
                    <p><strong>ðŸ’° Tarif:</strong> ${person.dailyRate || 'N/A'} ${person.rateCurrency || 'â‚¬'}/${person.rateType || 'jour'}</p>
                    ${person.hasVehicle ? `<p><strong>ðŸš— VÃ©hicule:</strong> ${person.vehicleType || 'Oui'} (${person.vehicleSeats || '?'} places)</p>` : ''}
                    ${person.availabilityText ? `<p><strong>ðŸ“… DisponibilitÃ©s:</strong> ${person.availabilityText}</p>` : ''}
                </div>
                ${(person.galleryPhotos && person.galleryPhotos.length > 0) || (person.crewGalleryPhotos && person.crewGalleryPhotos.length > 0) ? `
                <div class="box-bg">
                    <p class="mb-10"><strong>ðŸ“¸ Galerie Photos</strong></p>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        ${(person.galleryPhotos || person.crewGalleryPhotos || []).map(url => url ? `<img src="${url}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="window.open('${url}','_blank')">` : '').join('')}
                    </div>
                </div>` : ''}
                ${person.demoreel ? `
                <div class="box-bg">
                    <p class="mb-10"><strong>ðŸŽ¬ Bande DÃ©mo</strong></p>
                    <iframe src="${ProfileRenderer.getEmbedUrl(person.demoreel)}" width="100%" height="200" frameborder="0" allowfullscreen class="br-8"></iframe>
                </div>` : ''}
                <div style="display:flex;gap:10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Fermer</button>
                    <button onclick="app.GlobalSearch.addToProject(${idx}); this.closest('div[style*=fixed]').remove();" style="flex:1;padding:12px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">âž• Ajouter au projet</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(profileModal);
    },
    
    addToProject: (idx) => {
        const person = GlobalSearch.results[idx];
        if(!person) return;
        
        const isActors = GlobalSearch.currentType === 'actors';
        
        // CrÃ©er une copie pour le projet
        const newEntry = { ...person };
        newEntry.id = (isActors ? 'act_' : 'crew_') + Date.now();
        newEntry.availabilityDates = [];
        delete newEntry.profileComplete;
        delete newEntry.updatedAt;
        
        // VÃ©rifier si dÃ©jÃ  dans le projet
        const existingList = isActors ? state.data.actors : state.data.crew;
        const alreadyExists = existingList.some(e => e.email === person.email);
        
        if(alreadyExists) {
            Utils.toast('Cette personne est dÃ©jÃ  dans le projet !', 'warning');
            return;
        }
        
if(isActors) {
            state.data.actors.push(newEntry);
            Store.save();
            UI.renderDataTab('actors', els.actorContainer);
        } else {
            state.data.crew.push(newEntry);
            Store.save();
            UI.renderCrewTab();
        }
        
        Utils.toast(`${person.name} ajoutÃ©(e) au projet !`, 'success');
        
        // Proposer d'avertir la personne si elle a un email
        if(person.email) {
            setTimeout(async () => {
                if(await ConfirmModal.show({ title: 'PrÃ©venir cette personne ?', message: `Envoyer une notification Ã  ${person.name} pour l'informer qu'il/elle a Ã©tÃ© ajoutÃ©(e) au projet ?`, icon: 'ðŸ“§', confirmText: 'Envoyer' })) {
                    GlobalSearch.notifyPerson(person);
                }
            }, 300);
        }
    },
    
    notifyPerson: async (person) => {
        try {
            const projectTitle = document.getElementById('projectTitle')?.value || 'Un projet';
            const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'Quelqu\'un';
            
            await Messages.send(person.email, {
                type: 'info',
                title: `Vous avez Ã©tÃ© ajoutÃ©(e) au projet "${projectTitle}"`,
                content: `${senderName} vous a ajoutÃ©(e) au projet "${projectTitle}" sur Moteur.\n\nVous pouvez maintenant collaborer sur ce projet.`,
                projectId: state.currentProjectId,
                projectTitle: projectTitle
            });
            
            // Envoyer aussi un ping email
            await Messages.sendEmailPing(person.email, person.name, 'claim', {
                senderName: senderName,
                projectTitle: projectTitle,
                typeLabel: typeLabel
            });
            
            Utils.toast(`${person.name} a Ã©tÃ© notifiÃ©(e) !`, 'success');
        } catch(e) {
            console.error('Erreur notification:', e);
            Utils.toast('Erreur lors de l\'envoi de la notification', 'error');
        }
    }
};
  
  const ActorSearch = {
    filtersVisible: false,
    
    toggleFilters: () => {
        ActorSearch.filtersVisible = !ActorSearch.filtersVisible;
        const filtersDiv = document.getElementById('actor-filters');
        if(filtersDiv) {
            filtersDiv.style.display = ActorSearch.filtersVisible ? 'block' : 'none';
        }
    },
    
    applyFilters: () => {
        const name = (document.getElementById('filter-name')?.value || '').toLowerCase();
        const gender = document.getElementById('filter-gender')?.value || '';
        const ethnicity = document.getElementById('filter-ethnicity')?.value || '';
        const hair = document.getElementById('filter-hair')?.value || '';
        const eyes = document.getElementById('filter-eyes')?.value || '';
        const ageMin = parseInt(document.getElementById('filter-age-min')?.value) || 0;
        const ageMax = parseInt(document.getElementById('filter-age-max')?.value) || 999;
        const heightMin = parseInt(document.getElementById('filter-height-min')?.value) || 0;
        const heightMax = parseInt(document.getElementById('filter-height-max')?.value) || 999;
        const sports = (document.getElementById('filter-sports')?.value || '').toLowerCase();
        const languages = (document.getElementById('filter-languages')?.value || '').toLowerCase();
        const hasVehicle = document.getElementById('filter-vehicle')?.checked || false;
        
        const cards = document.querySelectorAll('#actorContainer .data-card');
        let visibleCount = 0;
        
        cards.forEach((card, idx) => {
            const actor = state.data.actors[idx];
            if(!actor) return;
            
            let visible = true;
            
            // Filtre par nom
            if(name && !actor.name.toLowerCase().includes(name)) visible = false;
            
            // Filtre par sexe
            if(gender && actor.gender !== gender) visible = false;
            
            // Filtre par origine
            if(ethnicity && actor.ethnicity !== ethnicity) visible = false;
            
            // Filtre par cheveux
            if(hair && actor.hairColor !== hair) visible = false;
            
            // Filtre par yeux
            if(eyes && actor.eyeColor !== eyes) visible = false;
            
            // Filtre par Ã¢ge
            const actorAge = parseInt(actor.age) || 0;
            if(ageMin > 0 && actorAge < ageMin) visible = false;
            if(ageMax < 999 && actorAge > ageMax) visible = false;
            
            // Filtre par taille
            const actorHeight = parseInt(actor.height) || 0;
            if(heightMin > 0 && actorHeight < heightMin) visible = false;
            if(heightMax < 999 && actorHeight > heightMax) visible = false;
            
            // Filtre par sport
            if(sports && !(actor.sports || '').toLowerCase().includes(sports)) visible = false;
            
            // Filtre par langue
            if(languages && !(actor.languages || '').toLowerCase().includes(languages)) visible = false;
            
            // Filtre par vÃ©hicule
            if(hasVehicle && !actor.hasVehicle) visible = false;
            
            card.style.display = visible ? '' : 'none';
            if(visible) visibleCount++;
        });
        
        const countDiv = document.getElementById('filter-results-count');
        if(countDiv) {
            const total = state.data.actors?.length || 0;
            countDiv.textContent = `${visibleCount} / ${total} comÃ©dien${visibleCount > 1 ? 's' : ''} affichÃ©${visibleCount > 1 ? 's' : ''}`;
        }
    },
    
    resetFilters: () => {
        document.getElementById('filter-name').value = '';
        document.getElementById('filter-gender').value = '';
        document.getElementById('filter-ethnicity').value = '';
        document.getElementById('filter-hair').value = '';
        document.getElementById('filter-eyes').value = '';
        document.getElementById('filter-age-min').value = '';
        document.getElementById('filter-age-max').value = '';
        document.getElementById('filter-height-min').value = '';
        document.getElementById('filter-height-max').value = '';
        document.getElementById('filter-sports').value = '';
        document.getElementById('filter-languages').value = '';
        document.getElementById('filter-vehicle').checked = false;
        
        const cards = document.querySelectorAll('#actorContainer .data-card');
        cards.forEach(card => card.style.display = '');
        
        const countDiv = document.getElementById('filter-results-count');
        if(countDiv) countDiv.textContent = '';
    }
};
  
  const Contacts = {
    currentTab: 'actors',
    currentMode: 'favorites',
    directoryResults: [],
    
    open: () => {
        UI.hideAllViews();
        els.contactsView.classList.add('active');
        Contacts.currentMode = 'favorites';
        Contacts.currentTab = 'actors';
        Contacts.updateUI();
        Contacts.loadAndRender();
    },
    
    close: () => {
        UI.hideAllViews();
        els.dashboardView.style.display = 'flex';
    },
    
    switchMode: (mode) => {
        Contacts.currentMode = mode;
        Contacts.updateUI();
        if(mode === 'favorites') {
            Contacts.render();
        } else {
            Contacts.searchDirectory();
        }
    },
    
    switchTab: (tab) => {
        Contacts.currentTab = tab;
        // Mettre Ã  jour les sous-onglets
        document.querySelectorAll('#contacts-sub-tabs .contacts-tab').forEach(t => t.classList.remove('active'));
        const activeTab = document.querySelector(`#contacts-sub-tabs .contacts-tab[onclick*="${tab}"]`);
        if(activeTab) activeTab.classList.add('active');
        
        if(Contacts.currentMode === 'favorites') {
            Contacts.render();
        } else {
            Contacts.updateFilters();
            Contacts.searchDirectory();
        }
    },
    
    updateUI: () => {
        const isFavorites = Contacts.currentMode === 'favorites';
        
        // Titre
        document.getElementById('contacts-title').textContent = isFavorites ? 'â­ Mes Favoris' : 'ðŸŒ Annuaire';
        
        // Onglets principaux
        document.querySelectorAll('.contacts-body > .contacts-tabs:first-child .contacts-tab').forEach(t => t.classList.remove('active'));
        const modeTab = document.querySelector(`.contacts-body > .contacts-tabs:first-child .contacts-tab[onclick*="${Contacts.currentMode}"]`);
        if(modeTab) modeTab.classList.add('active');
        
        // Filtres
        const filtersDiv = document.getElementById('contacts-filters');
        if(isFavorites) {
            filtersDiv.style.display = 'none';
        } else {
            filtersDiv.style.display = 'block';
            Contacts.updateFilters();
        }
    },
    
    updateFilters: () => {
        const filtersDiv = document.getElementById('contacts-filters');
        const tab = Contacts.currentTab;
        
        if(tab === 'actors') {
            filtersDiv.innerHTML = `
                <div class="flex-wrap-gap10">
                    <input type="text" class="global-search-input min-w-150" id="contact-filter-name" placeholder="ðŸ” Nom..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city" placeholder="ðŸ“ Ville..." oninput="app.Contacts.searchDirectory()">
                    <select class="global-search-input" id="contact-filter-gender" onchange="app.Contacts.searchDirectory()">
                        <option value="">Tous sexes</option>
                        <option value="homme">Homme</option>
                        <option value="femme">Femme</option>
                        <option value="non-binaire">Non-binaire</option>
                    </select>
                    <select class="global-search-input" id="contact-filter-ethnicity" onchange="app.Contacts.searchDirectory()">
                        <option value="">Toutes origines</option>
                        <option value="caucasien">Caucasien</option>
                        <option value="africain">Africain</option>
                        <option value="asiatique">Asiatique</option>
                        <option value="latino">Latino</option>
                        <option value="maghrebin">MaghrÃ©bin</option>
                        <option value="metis">MÃ©tis</option>
                    </select>
                    <input type="text" class="global-search-input" id="contact-filter-sports" placeholder="ðŸ‡ Sport..." style="width:120px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-languages" placeholder="ðŸ—£ï¸ Langue..." style="width:120px;" oninput="app.Contacts.searchDirectory()">
                </div>
            `;
        } else if(tab === 'crew') {
            filtersDiv.innerHTML = `
                <div class="flex-wrap-gap10">
                    <input type="text" class="global-search-input min-w-150" id="contact-filter-name-crew" placeholder="ðŸ” Nom..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city-crew" placeholder="ðŸ“ Ville..." oninput="app.Contacts.searchDirectory()">
                    <select class="global-search-input" id="contact-filter-department" onchange="app.Contacts.searchDirectory()">
                        <option value="">Tous dÃ©partements</option>
                        <option value="image">ðŸ“¹ Image</option>
                        <option value="lumiere">ðŸ’¡ LumiÃ¨re</option>
                        <option value="realisation">ðŸŽ¬ RÃ©alisation</option>
                        <option value="son">ðŸŽ¤ Son</option>
                        <option value="decoration">ðŸŽ¨ DÃ©coration</option>
                        <option value="costumes">ðŸ‘— Costumes</option>
                        <option value="maquillage">ðŸ’„ Maquillage</option>
                        <option value="regie">ðŸŽ­ RÃ©gie</option>
                        <option value="production">ðŸ’¼ Production</option>
                        <option value="postprod">ðŸŽžï¸ Post-prod</option>
                    </select>
                    <input type="text" class="global-search-input" id="contact-filter-role" placeholder="Fonction..." style="width:130px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-camera" placeholder="ðŸ“· CamÃ©ra..." style="width:130px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-equipment" placeholder="ðŸ”§ MatÃ©riel..." style="width:130px;" oninput="app.Contacts.searchDirectory()">
                </div>
            `;
        } else if(tab === 'projects') {
            filtersDiv.innerHTML = `
                <div class="flex-wrap-gap10">
                    <input type="text" class="global-search-input min-w-150" id="contact-filter-name-projects" placeholder="ðŸ” Titre..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city-projects" placeholder="ðŸ“ Lieu..." oninput="app.Contacts.searchDirectory()">
                    <select class="global-search-input" id="contact-filter-projectType" onchange="app.Contacts.searchDirectory()">
                        <option value="">Tous types</option>
                        <option value="court-metrage">Court-mÃ©trage</option>
                        <option value="long-metrage">Long-mÃ©trage</option>
                        <option value="serie">SÃ©rie</option>
                        <option value="documentaire">Documentaire</option>
                        <option value="clip">Clip</option>
                        <option value="pub">PublicitÃ©</option>
                    </select>
                    <select class="global-search-input" id="contact-filter-genre" onchange="app.Contacts.searchDirectory()">
                        <option value="">Tous genres</option>
                        <option value="drame">Drame</option>
                        <option value="comedie">ComÃ©die</option>
                        <option value="thriller">Thriller</option>
                        <option value="horreur">Horreur</option>
                        <option value="sf">Science-Fiction</option>
                        <option value="fantastique">Fantastique</option>
                    </select>
                </div>
            `;
        } else if(tab === 'associations') {
            filtersDiv.innerHTML = `
                <div class="flex-wrap-gap10">
                    <input type="text" class="global-search-input min-w-150" id="contact-filter-name-associations" placeholder="ðŸ” Nom..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city-associations" placeholder="ðŸ“ Ville..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-activity-associations" placeholder="ðŸŽ¯ ActivitÃ©..." style="width:150px;" oninput="app.Contacts.searchDirectory()">
                </div>
            `;
        } else if(tab === 'enterprises') {
            filtersDiv.innerHTML = `
                <div class="flex-wrap-gap10">
                    <input type="text" class="global-search-input min-w-150" id="contact-filter-name-enterprises" placeholder="ðŸ” Nom..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city-enterprises" placeholder="ðŸ“ Ville..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-activity-enterprises" placeholder="ðŸŽ¯ ActivitÃ©..." style="width:150px;" oninput="app.Contacts.searchDirectory()">
                </div>
            `;
        }
    },
    
    searchDirectory: async () => {
        const tab = Contacts.currentTab;
        const profileTypes = {
            actors: 'actor',
            crew: 'crew',
            projects: 'project',
            associations: 'association',
            enterprises: 'enterprise'
        };
        const profileType = profileTypes[tab] || 'actor';
        
        els.contactsList.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);">ðŸ”„ Recherche...</div>';
        
        try {
            const { data, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('profile_type', profileType)
                .eq('is_public', true);
            
            let results = [];
            if(!error && data) {
                // Extraire les donnÃ©es du champ JSONB pour chaque profil
                results = data.map(p => {
                    const extraData = p.data || {};
                    return {
                        ...p,
                        ...extraData,
                        type: p.profile_type || 'crew',
                        hasVehicle: p.vehicle || false,
                        availabilityText: p.availability || ''
                    };
                });
            }
            
            // Filtrer profils complets uniquement
            results = results.filter(r => r.is_public);
            
            // Appliquer filtres
            const suffix = (tab === 'actors') ? '' : '-' + tab;
            const name = (document.getElementById('contact-filter-name' + suffix)?.value || '').toLowerCase();
            const city = (document.getElementById('contact-filter-city' + suffix)?.value || '').toLowerCase();
            
            if(name) results = results.filter(r => (r.name || '').toLowerCase().includes(name));
            if(city) results = results.filter(r => (r.city || '').toLowerCase().includes(city));
            
            if(tab === 'actors') {
                const gender = document.getElementById('contact-filter-gender')?.value;
                const ethnicity = document.getElementById('contact-filter-ethnicity')?.value;
                const sports = (document.getElementById('contact-filter-sports')?.value || '').toLowerCase();
                const languages = (document.getElementById('contact-filter-languages')?.value || '').toLowerCase();
                
                if(gender) results = results.filter(r => r.gender === gender);
                if(ethnicity) results = results.filter(r => r.ethnicity === ethnicity);
                if(sports) results = results.filter(r => (r.sports || '').toLowerCase().includes(sports));
                if(languages) results = results.filter(r => (r.languages || '').toLowerCase().includes(languages));
            } else if(tab === 'crew') {
                const department = document.getElementById('contact-filter-department')?.value;
                const role = (document.getElementById('contact-filter-role')?.value || '').toLowerCase();
                const camera = (document.getElementById('contact-filter-camera')?.value || '').toLowerCase();
                const equipment = (document.getElementById('contact-filter-equipment')?.value || '').toLowerCase();
                
                if(department) results = results.filter(r => r.department === department);
                if(role) results = results.filter(r => (r.role || '').toLowerCase().includes(role));
                if(camera) results = results.filter(r => (r.cameras || []).some(c => c.toLowerCase().includes(camera)));
                if(equipment) {
                    results = results.filter(r => {
                        const allEquip = [...(r.cameras || []), ...(r.lenses || []), ...(r.otherEquipment || [])].join(' ').toLowerCase();
                        return allEquip.includes(equipment);
                    });
                }
            } else if(tab === 'projects') {
                const projectType = document.getElementById('contact-filter-projectType')?.value;
                const genre = document.getElementById('contact-filter-genre')?.value;
                
                if(projectType) results = results.filter(r => r.projectType === projectType);
                if(genre) results = results.filter(r => r.genre === genre);
            } else if(tab === 'associations' || tab === 'enterprises') {
                const activity = (document.getElementById('contact-filter-activity-' + tab)?.value || '').toLowerCase();
                
                if(activity) results = results.filter(r => (r.activity || r.description || '').toLowerCase().includes(activity));
            }
            
            Contacts.directoryResults = results;
            Contacts.renderDirectory();
            
        } catch(e) {
            console.error('Erreur recherche annuaire:', e);
            els.contactsList.innerHTML = '<div style="text-align:center; padding:40px; color:var(--danger);">âŒ Erreur de recherche</div>';
        }
    },
    
    renderDirectory: () => {
        const results = Contacts.directoryResults;
        const tab = Contacts.currentTab;
        
        if(results.length === 0) {
            els.contactsList.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-sec);">
                <p style="font-size: 1.2rem; margin-bottom: 10px;">Aucun profil trouvÃ©</p>
                <p class="fs-09">Essayez d'Ã©largir vos critÃ¨res de recherche</p>
            </div>`;
            return;
        }
        
        let html = `<div style="grid-column: 1/-1; margin-bottom:10px; color:var(--text-sec);">${results.length} profil${results.length > 1 ? 's' : ''} trouvÃ©${results.length > 1 ? 's' : ''}</div>`;
        
        results.forEach((person, idx) => {
            const photoHTML = person.photo 
                ? `<img src="${person.photo}" alt="${person.name}">`
                : 'ðŸ‘¤';
            
            let metaHTML = '';
            let defaultIcon = 'ðŸ‘¤';
            if(tab === 'actors') {
                const details = [];
                if(person.age) details.push(person.age + ' ans');
                if(person.city) details.push('ðŸ“ ' + person.city);
                metaHTML = details.join(' â€¢ ');
                defaultIcon = 'ðŸŽ­';
            } else if(tab === 'crew') {
                metaHTML = person.role || '';
                if(person.city) metaHTML += ' â€¢ ðŸ“ ' + person.city;
                defaultIcon = 'ðŸŽ¥';
            } else if(tab === 'projects') {
                metaHTML = person.projectType || '';
                if(person.genre) metaHTML += ' â€¢ ' + person.genre;
                if(person.city) metaHTML += ' â€¢ ðŸ“ ' + person.city;
                defaultIcon = 'ðŸŽ¬';
            } else if(tab === 'associations') {
                metaHTML = person.activity || '';
                if(person.city) metaHTML += ' â€¢ ðŸ“ ' + person.city;
                defaultIcon = 'ðŸ›ï¸';
            } else if(tab === 'enterprises') {
                metaHTML = person.activity || '';
                if(person.city) metaHTML += ' â€¢ ðŸ“ ' + person.city;
                defaultIcon = 'ðŸ¢';
            }
            
            // VÃ©rifier si dÃ©jÃ  dans favoris
            const isInFavorites = state.contacts && state.contacts[Contacts.currentTab] && 
                state.contacts[Contacts.currentTab].some(c => c.email === person.email);
            
            html += `<div class="contact-card">
                <div class="contact-card-header">
                    <div class="contact-card-photo">${photoHTML}</div>
                    <div>
                        <div class="contact-card-name">${Utils.escape(person.name || person.title || person.assoName || person.entName || 'Sans nom')}</div>
                        <div class="contact-card-role">${metaHTML}</div>
                    </div>
                </div>
                <div class="contact-card-info">
                    ${person.email ? `ðŸ“§ ${person.email}<br>` : ''}
                    ${person.phone ? `ðŸ“± ${person.phone}<br>` : ''}
                    ${person.hasVehicle ? 'ðŸš— VÃ©hicule disponible' : ''}
                </div>
                <div class="contact-card-actions">
                    <button onclick="app.Contacts.viewDirectoryProfile(${idx})">ðŸ‘ï¸ Voir</button>
                    <button onclick="app.Contacts.addToFavorites(${idx})" style="${isInFavorites ? 'opacity:0.5; cursor:not-allowed;' : ''}" ${isInFavorites ? 'disabled' : ''}>${isInFavorites ? 'â­ DÃ©jÃ  favori' : 'â­ Ajouter aux favoris'}</button>
                </div>
            </div>`;
        });
        
        els.contactsList.innerHTML = html;
    },
    
    viewDirectoryProfile: (idx) => {
        const person = Contacts.directoryResults[idx];
        if(!person) return;
        
        const tab = Contacts.currentTab;
        const displayName = person.name || person.title || person.assoName || person.entName || 'Sans nom';
        let defaultIcon = 'ðŸ‘¤';
        
        let detailsHTML = '';
        if(tab === 'actors') {
            defaultIcon = 'ðŸŽ­';
            detailsHTML = `
                <p><strong>Ã‚ge:</strong> ${person.age || 'N/A'} ans</p>
                <p><strong>Taille:</strong> ${person.height || 'N/A'} cm</p>
                <p><strong>Yeux:</strong> ${person.eyeColor || 'N/A'}</p>
                <p><strong>Cheveux:</strong> ${person.hairColor || 'N/A'}</p>
                <p><strong>Origine:</strong> ${person.ethnicity || 'N/A'}</p>
                ${person.sports ? `<p><strong>Sports:</strong> ${person.sports}</p>` : ''}
                ${person.languages ? `<p><strong>Langues:</strong> ${person.languages}</p>` : ''}
            `;
        } else if(tab === 'crew') {
            defaultIcon = 'ðŸŽ¥';
            detailsHTML = `
                <p><strong>DÃ©partement:</strong> ${person.department || 'N/A'}</p>
                <p><strong>Fonction:</strong> ${person.role || 'N/A'}</p>
                ${person.cameras && person.cameras.length > 0 ? `<p><strong>CamÃ©ras:</strong> ${person.cameras.join(', ')}</p>` : ''}
                ${person.lenses && person.lenses.length > 0 ? `<p><strong>Objectifs:</strong> ${person.lenses.join(', ')}</p>` : ''}
                ${person.otherEquipment && person.otherEquipment.length > 0 ? `<p><strong>MatÃ©riel:</strong> ${person.otherEquipment.join(', ')}</p>` : ''}
            `;
        } else if(tab === 'projects') {
            defaultIcon = 'ðŸŽ¬';
            detailsHTML = `
                <p><strong>Type:</strong> ${person.projectType || 'N/A'}</p>
                <p><strong>Genre:</strong> ${person.genre || 'N/A'}</p>
                ${person.director ? `<p><strong>RÃ©alisateur:</strong> ${person.director}</p>` : ''}
                ${person.producer ? `<p><strong>Producteur:</strong> ${person.producer}</p>` : ''}
                ${person.status ? `<p><strong>Statut:</strong> ${person.status}</p>` : ''}
            `;
        } else if(tab === 'associations') {
            defaultIcon = 'ðŸ›ï¸';
            detailsHTML = `
                <p><strong>ActivitÃ©:</strong> ${person.activity || 'N/A'}</p>
                ${person.members ? `<p><strong>Membres:</strong> ${person.members}</p>` : ''}
                ${person.website ? `<p><strong>Site web:</strong> <a href="${person.website}" target="_blank">${person.website}</a></p>` : ''}
            `;
        } else if(tab === 'enterprises') {
            defaultIcon = 'ðŸ¢';
            detailsHTML = `
                <p><strong>ActivitÃ©:</strong> ${person.activity || 'N/A'}</p>
                ${person.siret ? `<p><strong>SIRET:</strong> ${person.siret}</p>` : ''}
                ${person.website ? `<p><strong>Site web:</strong> <a href="${person.website}" target="_blank">${person.website}</a></p>` : ''}
            `;
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10001;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        const isInFavorites = state.contacts && state.contacts[Contacts.currentTab] && 
            state.contacts[Contacts.currentTab].some(c => c.email === person.email);
        
        modal.innerHTML = `
            <div class="modal-panel">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                    <div class="n8-avatar-4">
                        ${person.photo ? `<img src="${person.photo}" style="width:100%;height:100%;object-fit:cover;">` : defaultIcon}
                    </div>
                    <div>
                        <h2 class="m-0">${Utils.escape(displayName)}</h2>
                        <p style="margin:5px 0 0;color:var(--text-sec);">ðŸ“ ${person.city || 'Non prÃ©cisÃ©'}</p>
                    </div>
                </div>
                ${person.bio || person.description ? `<p class="mb-15">${Utils.escape(person.bio || person.description)}</p>` : ''}
                <div class="box-bg">
                    ${detailsHTML}
                </div>
                <div class="box-bg">
                    <p><strong>ðŸ“§ Email:</strong> ${person.email || 'N/A'}</p>
                    <p><strong>ðŸ“± TÃ©lÃ©phone:</strong> ${person.phone || 'N/A'}</p>
                    <p><strong>ðŸ’° Tarif:</strong> ${person.dailyRate || 'N/A'} ${person.rateCurrency || 'â‚¬'} / jour</p>
                    ${person.hasVehicle ? `<p><strong>ðŸš— VÃ©hicule:</strong> ${person.vehicleType || 'Oui'}</p>` : ''}
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Fermer</button>
                    <button onclick="app.Contacts.addToFavorites(${idx}); this.closest('div[style*=fixed]').remove();" style="flex:1;padding:12px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;" ${isInFavorites ? 'disabled style="flex:1;padding:12px;background:var(--text-sec);color:white;border:none;border-radius:6px;cursor:not-allowed;"' : ''}>${isInFavorites ? 'â­ DÃ©jÃ  dans favoris' : 'â­ Ajouter aux favoris'}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    addToFavorites: async (idx) => {
        const person = Contacts.directoryResults[idx];
        if(!person) return;
        
        const type = Contacts.currentTab;
        const email = state.currentUser.email.toLowerCase();
        
        // CrÃ©er l'entrÃ©e contact
        const contactData = {
            owner_email: email,
            contact_email: person.email || '',
            contact_type: type,
            name: person.name || person.title || person.assoName || person.entName,
            notes: JSON.stringify(person),
            created_at: new Date().toISOString()
        };
        
        try {
            const { data, error } = await supabase.from('contacts').insert(contactData).select().single();
            
            if(error) throw error;
            
            // Mettre Ã  jour en local
            if(!state.contacts) state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
            if(!state.contacts[type]) state.contacts[type] = [];
            state.contacts[type].push({ ...person, id: data.id });
            
            Utils.toast(`${person.name || 'Contact'} ajoutÃ©(e) Ã  vos favoris !`, 'success');
            Contacts.renderDirectory();
        } catch(e) {
            console.error('Erreur ajout favoris:', e);
            Utils.toast('Erreur lors de l\'ajout', 'error');
        }
    },
    
    loadAndRender: async () => {
        const email = state.currentUser.email.toLowerCase();
        try {
            const { data: contacts, error } = await supabase
                .from('contacts')
                .select('*')
                .eq('owner_email', email);
            
            if(!error && contacts) {
                // Enrichir chaque contact avec publicProfileId depuis notes
                const enrichedContacts = contacts.map(c => {
                    let enriched = { ...c };
                    try {
                        const notesData = JSON.parse(c.notes || '{}');
                        if(notesData.publicProfileId) {
                            enriched.publicProfileId = notesData.publicProfileId;
                        }
                    } catch(e) {}
                    return enriched;
                });
                
                state.contacts = {
                    actors: enrichedContacts.filter(c => c.contact_type === 'actor'),
                    crew: enrichedContacts.filter(c => c.contact_type === 'crew'),
                    projects: enrichedContacts.filter(c => c.contact_type === 'project'),
                    associations: enrichedContacts.filter(c => c.contact_type === 'association'),
                    enterprises: enrichedContacts.filter(c => c.contact_type === 'enterprise')
                };
            } else {
                state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
            }
        } catch(e) {
            console.error('Erreur chargement contacts:', e);
            state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
        }
        Contacts.render();
    },
    
    render: () => {
        const tab = Contacts.currentTab;
        const list = state.contacts[tab] || [];
        
        const tabLabels = {
            actors: 'comÃ©dien.ne',
            crew: 'technicien.ne',
            projects: 'projet',
            associations: 'association',
            enterprises: 'entreprise'
        };
        const tabIcons = {
            actors: 'ðŸŽ­',
            crew: 'ðŸŽ¥',
            projects: 'ðŸŽ¬',
            associations: 'ðŸ›ï¸',
            enterprises: 'ðŸ¢'
        };
        
        if(!list || list.length === 0) {
            els.contactsList.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-sec);">
                <p style="font-size: 1.2rem; margin-bottom: 10px;">Aucun ${tabLabels[tab] || 'contact'} en favoris</p>
                <p class="fs-09">Ajoutez des favoris depuis l'Annuaire ou l'Univers en cliquant sur â­</p>
            </div>`;
            return;
        }
        
        let html = '';
        list.forEach((contact, idx) => {
            const displayName = contact.name || contact.title || contact.assoName || contact.entName || 'Sans nom';
            const photoHTML = contact.photo 
                ? `<img src="${contact.photo}" alt="${displayName}">`
                : tabIcons[tab] || 'ðŸ‘¤';
            
            let roleOrDept = '';
            if(tab === 'actors') {
                roleOrDept = contact.linkedCharacter || contact.city || '';
            } else if(tab === 'crew') {
                roleOrDept = contact.role || contact.department || '';
            } else if(tab === 'projects') {
                roleOrDept = contact.projectType || contact.genre || '';
            } else if(tab === 'associations' || tab === 'enterprises') {
                roleOrDept = contact.activity || contact.city || '';
            }
            
            html += `<div class="contact-card">
                <div class="contact-card-header">
                    <div class="contact-card-photo">${photoHTML}</div>
                    <div>
                        <div class="contact-card-name">${Utils.escape(displayName)}</div>
                        <div class="contact-card-role">${Utils.escape(roleOrDept)}</div>
                    </div>
                </div>
                <div class="contact-card-info">
                    ${contact.email ? `ðŸ“§ ${contact.email}<br>` : ''}
                    ${contact.phone ? `ðŸ“± ${contact.phone}<br>` : ''}
                    ${contact.website ? `ðŸŒ ${contact.website}<br>` : ''}
                    ${contact.hasVehicle ? 'ðŸš— VÃ©hicule disponible' : ''}
                </div>
                <div class="contact-card-actions">
                    <button onclick="app.Contacts.edit('${tab}', ${idx})">âœï¸ Modifier</button>
                    <button onclick="app.Contacts.delete('${tab}', ${idx})" class="text-danger">ðŸ—‘ï¸ Supprimer</button>
                </div>
            </div>`;
        });
        
        els.contactsList.innerHTML = html;
    },
    
    saveActorToContacts: async (idx) => {
        const data = state.data.actors[idx];
        if(!data) return;
        await Contacts.saveToContacts('actors', data);
        UI.renderDataTab('actors', els.actorContainer);
    },
    
    saveCrewToContacts: async (idx) => {
        const data = state.data.crew[idx];
        if(!data) return;
        await Contacts.saveToContacts('crew', data);
        UI.renderCrewTab();
    },
    
    saveToContacts: async (type, data) => {
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        const contactData = {
            id: data.id || ('contact_' + Date.now()),
            name: data.name,
            gender: data.gender || '',
            photo: data.photo || '',
            email: data.email || '',
            phone: data.phone || '',
            address: data.address || '',
            website: data.website || '',
            bio: data.bio || '',
            hasVehicle: data.hasVehicle || false,
            vehicleType: data.vehicleType || '',
            vehiclePlate: data.vehiclePlate || '',
            vehicleSeats: data.vehicleSeats || '',
            vehicleTrunk: data.vehicleTrunk || false,
            vehicleNotes: data.vehicleNotes || '',
            dailyRate: data.dailyRate || '',
            rateCurrency: data.rateCurrency || 'â‚¬',
            rateType: data.rateType || 'Jour',
            availabilityText: data.availabilityText || '',
            availabilityDates: data.availabilityDates || [],
            height: data.height || '',
            weight: data.weight || '',
            age: data.age || '',
            eyeColor: data.eyeColor || '',
            hairColor: data.hairColor || '',
            hairLength: data.hairLength || '',
            ethnicity: data.ethnicity || '',
            bustSize: data.bustSize || '',
            bustType: data.bustType || '',
            corpulence: data.corpulence || '',
            sports: data.sports || '',
            languages: data.languages || '',
            savedAt: new Date().toISOString()
        };
        
        if(type === 'crew') {
            contactData.role = data.role || '';
            contactData.department = data.group_id || '';
        }
        
        try {
            // Sauvegarder dans Supabase
            const { error } = await supabase.from('contacts').upsert({
                id: contactData.id,
                owner_email: state.currentUser.email.toLowerCase(),
                contact_email: contactData.email || '',
                contact_type: type,
                name: contactData.name,
                notes: JSON.stringify(contactData)
            }, { onConflict: 'id' });
            
            if (error) throw error;
            
            // Recharger les contacts en mÃ©moire
            if(!state.contacts) state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
            if(!state.contacts[type]) state.contacts[type] = [];
            const list = state.contacts[type];
            const existingIdx = list.findIndex(c => c.id === contactData.id);
            if(existingIdx > -1) {
                list[existingIdx] = contactData;
            } else {
                list.push(contactData);
            }
            Utils.toast('Contact sauvegardÃ© !', 'success');
            return true;
        } catch(e) {
            console.error('Erreur sauvegarde contact:', e);
            Utils.toast('Erreur lors de la sauvegarde', 'error');
            return false;
        }
    },
    
    delete: async (type, idx) => {
        if(!await ConfirmModal.confirmDelete("Ce contact sera supprimÃ©.")) return;
        
        const list = state.contacts[type] || [];
        const contact = list[idx];
        if(!contact) return;
        
        try {
            const {error: delFavErr} = await supabase.from('contacts').delete().eq('id', contactToRemove.id);
            if(delFavErr) { console.error('Erreur suppression favori:', delFavErr); Toast.show('Erreur suppression favori', 'error'); return; }
            btn.textContent = 'â˜†';
            Contacts.render();
        } catch(e) {
            console.error('Erreur suppression contact:', e);
            Utils.toast('Erreur lors de la suppression', 'error');
        }
    },
    
    edit: (type, idx) => {
        Utils.toast('FonctionnalitÃ© d\'Ã©dition Ã  venir !', 'info');
    },
    
    isInContacts: (type, id) => {
        if(!state.contacts) return false;
        const list = type === 'actors' ? state.contacts.actors : state.contacts.crew;
        return list && list.some(c => c.id === id);
    },
    
    importToProject: async (type) => {
        if(!state.contacts) await Contacts.loadAndRender();
        
        const list = type === 'actors' ? state.contacts.actors : state.contacts.crew;
        if(!list || list.length === 0) {
            Utils.toast('Aucun contact Ã  importer. Ajoutez d\'abord des contacts depuis vos projets.', 'warning');
            return;
        }
        
        let html = `<div style="max-height: 400px; overflow-y: auto;">`;
        list.forEach((contact, idx) => {
            const alreadyInProject = type === 'actors' 
                ? state.data.actors.some(a => a.id === contact.id)
                : state.data.crew.some(c => c.id === contact.id);
            
            html += `<label style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); cursor: ${alreadyInProject ? 'not-allowed' : 'pointer'}; opacity: ${alreadyInProject ? '0.5' : '1'};">
                <input type="checkbox" ${alreadyInProject ? 'disabled checked' : ''} data-idx="${idx}">
                <span>${Utils.escape(contact.name)}</span>
                ${alreadyInProject ? '<span class="text-sec-sm">(dÃ©jÃ  ajoutÃ©)</span>' : ''}
            </label>`;
        });
        html += `</div>`;
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10000;';
        modal.innerHTML = `<div style="background:var(--panel-bg);border-radius:12px;padding:20px;max-width:500px;width:90%;">
            <h3 style="margin:0 0 15px 0;">ðŸ“‡ Importer des contacts</h3>
            ${html}
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:15px;">
                <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:10px 20px;border:1px solid var(--border);background:var(--bg);border-radius:6px;cursor:pointer;">Annuler</button>
                <button onclick="app.Contacts.doImport('${type}', this.closest('div[style*=fixed]'))" style="padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">Importer</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    },
    
    doImport: (type, modal) => {
        const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked:not([disabled])');
        const list = type === 'actors' ? state.contacts.actors : state.contacts.crew;
        
        checkboxes.forEach(cb => {
            const idx = parseInt(cb.dataset.idx);
            const contact = list[idx];
            if(!contact) return;
            
            const newEntry = { ...contact };
            newEntry.availabilityDates = [];
            newEntry.availabilityText = '';
            delete newEntry.savedAt;
            
            if(type === 'actors') {
                state.data.actors.push(newEntry);
            } else {
                state.data.crew.push(newEntry);
            }
        });
        
        Store.save();
        modal.remove();
        
        if(type === 'actors') {
            UI.renderDataTab('actors', els.actorContainer);
        } else {
            UI.renderCrewTab();
        }
        
        Utils.toast(`${checkboxes.length} contact(s) importÃ©(s) !`, 'success');
    }
};
  
  const Planning = {
    currentView: 'month',
    currentMode: 'calendar',
    currentDate: new Date(),
    editingDayId: null,
    weatherCache: {},
    
    // Types de journÃ©es avec leurs couleurs et icÃ´nes
    dayTypes: {
        'tournage': { icon: 'ðŸŽ¬', color: '#FF9800', label: 'Tournage' },
        'repetition': { icon: 'ðŸŽ­', color: '#9C27B0', label: 'RÃ©pÃ©tition' },
        'reperage': { icon: 'ðŸ”', color: '#00BCD4', label: 'RepÃ©rage' },
        'essai-costume': { icon: 'ðŸ‘—', color: '#E91E63', label: 'Essai costume' },
        'essai-maquillage': { icon: 'ðŸ’„', color: '#F06292', label: 'Essai maquillage' },
        'formation': { icon: 'ðŸ“š', color: '#3F51B5', label: 'Formation' },
        'reunion': { icon: 'ðŸ“‹', color: '#607D8B', label: 'RÃ©union' },
        'autre': { icon: 'ðŸ“Œ', color: '#795548', label: 'Autre' }
    },
    
    getDayTypeInfo: (dayType) => {
        return Planning.dayTypes[dayType] || Planning.dayTypes['tournage'];
    },
    
    init: () => {
        Planning.render();
    },
    
    // Basculer entre Calendrier et Kanban
    setMode: (mode) => {
        Planning.currentMode = mode;
        
        // Mettre Ã  jour les boutons
        document.getElementById('planning-mode-calendar').classList.toggle('active', mode === 'calendar');
        document.getElementById('planning-mode-kanban').classList.toggle('active', mode === 'kanban');
        document.getElementById('planning-mode-workplan').classList.toggle('active', mode === 'workplan');
        
        // Afficher/masquer les vues
        document.getElementById('planningContainer').style.display = mode === 'calendar' ? 'block' : 'none';
        document.getElementById('kanbanContainer').style.display = mode === 'kanban' ? 'block' : 'none';
        document.getElementById('workplanContainer').style.display = mode === 'workplan' ? 'block' : 'none';
        document.getElementById('calendar-view-toggle').style.display = mode === 'calendar' ? 'flex' : 'none';
        
        // Masquer navigation et actions en mode plan de travail (visibility pour garder l'espace)
        document.querySelector('.planning-nav').style.visibility = mode === 'workplan' ? 'hidden' : 'visible';
        document.querySelector('.planning-actions').style.display = mode === 'workplan' ? 'none' : 'flex';
        
        if(mode === 'kanban') {
            Planning.renderKanban();
        } else if(mode === 'workplan') {
            Planning.renderWorkPlan();
        }
    },
    
    // Afficher le Plan de Travail
    // Afficher le Plan de Travail (DOOD)
    renderWorkPlan: () => {
        const shootDays = (state.data.shootingDays || []).slice().sort((a, b) => {
            const dateA = new Date(a.startDate || a.date);
            const dateB = new Date(b.startDate || b.date);
            return dateA - dateB;
        });
        
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const characters = state.data.characters || [];
        
        // Ã‰tat vide
        if(shootDays.length === 0) {
            document.getElementById('workplanContent').innerHTML = `
                <div class="workplan-empty">
                    <div class="workplan-empty-icon">ðŸ“‹</div>
                    <h3 class="mb-10">Aucun jour de tournage planifiÃ©</h3>
                    <p style="color: #666; margin-bottom: 20px;">Ajoutez des jours de tournage dans le calendrier pour gÃ©nÃ©rer le plan de travail.</p>
                    <button onclick="app.Planning.setMode('calendar')" class="n8-badge-15">ðŸ“… Aller au calendrier</button>
                </div>`;
            return;
        }
        
        // CrÃ©er mapping prÃ©sences : qui travaille quel jour
        const buildPresenceMap = () => {
            const map = {};
            
            // Init pour chaque acteur
            actors.forEach(actor => {
                map[`actor_${actor.id}`] = { type: 'actor', person: actor, days: {} };
            });
            
            // Init pour chaque technicien
            crew.forEach(member => {
                map[`crew_${member.id}`] = { type: 'crew', person: member, days: {} };
            });
            
            // Parcourir les jours et leurs callSheets
            shootDays.forEach((day, dayIdx) => {
                (day.callSheet || []).forEach(call => {
                    const key = `${call.type}_${call.personId}`;
                    if(map[key]) {
                        map[key].days[dayIdx] = { callTime: call.callTime, notes: call.notes };
                    }
                });
            });
            
            return map;
        };
        
        const presenceMap = buildPresenceMap();
        
        // DÃ©terminer le code pour chaque cellule (SW, W, WF, H, etc.)
        const getCellCode = (personKey, dayIdx) => {
            const data = presenceMap[personKey];
            
            // VÃ©rifier s'il y a un override manuel (V, R, H ajoutÃ©s manuellement)
            const overrideKey = `${personKey}_${dayIdx}`;
            const override = (state.data.workplanOverrides || {})[overrideKey];
            if(override) return override;
            
            if(!data) return '';
            
            const days = Object.keys(data.days).map(Number).sort((a,b) => a - b);
            if(days.length === 0) return '';
            
            const firstDay = days[0];
            const lastDay = days[days.length - 1];
            const isWorkingThisDay = data.days[dayIdx] !== undefined;
            
            // Hors pÃ©riode de contrat
            if(dayIdx < firstDay || dayIdx > lastDay) return '';
            
            // Un seul jour de travail total
            if(days.length === 1 && isWorkingThisDay) return 'T';
            
            // Premier jour
            if(dayIdx === firstDay) return 'SW';
            
            // Dernier jour
            if(dayIdx === lastDay) return 'WF';
            
            // Entre premier et dernier jour
            if(isWorkingThisDay) return 'W'; // Travaille
            return 'H'; // Hold (pas convoquÃ© mais sous contrat)
        };
        
        // Trouver le personnage associÃ© Ã  un acteur
        const getCharacterForActor = (actorId) => {
            const char = characters.find(c => c.actorId === actorId);
            return char ? char.name : '';
        };
        
        // Compter les jours de travail
        const countWorkDays = (personKey) => {
            const data = presenceMap[personKey];
            if(!data) return 0;
            return Object.keys(data.days).length;
        };
        
        // Dates du tournage
        const firstDate = new Date(shootDays[0].startDate || shootDays[0].date);
        const lastDate = new Date(shootDays[shootDays.length - 1].startDate || shootDays[shootDays.length - 1].date);
        const formatDate = (d) => d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        // Construction HTML
        let html = '<div class="workplan-wrapper">';
        
        // En-tÃªte avec infos film
        html += `
            <div class="workplan-header-box">
                <div>
                    <div class="workplan-header-title">${Utils.escape(state.data.title || 'Sans titre')}</div>
                    <div class="workplan-header-subtitle">Plan de travail</div>
                </div>
                <div class="workplan-header-info">
                    <strong>Tournage :</strong> Du ${formatDate(firstDate)} au ${formatDate(lastDate)}<br>
                    <strong>Jours :</strong> ${shootDays.length} jour${shootDays.length > 1 ? 's' : ''} de tournage<br>
                    <strong>ComÃ©diens :</strong> ${actors.length}
                </div>
                <div class="workplan-header-version">
                    <strong>Version nÂ°1</strong><br>
                    GÃ©nÃ©rÃ© le ${formatDate(new Date())}
                </div>
            </div>`;
        
        // Tableau principal
        html += '<table class="workplan-table"><thead><tr>';
        html += '<th class="workplan-col-num">NÂ°</th>';
        html += '<th class="workplan-col-role">RÃ”LE</th>';
        html += '<th class="workplan-col-actor">COMÃ‰DIEN.NE</th>';
        
        // En-tÃªtes des jours
        shootDays.forEach((day, idx) => {
            const date = new Date(day.startDate || day.date);
            const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' }).substring(0, 2);
            const dayNum = date.getDate();
            const month = date.toLocaleDateString('fr-FR', { month: 'short' }).substring(0, 3);
            html += `<th class="workplan-col-day" title="J${idx + 1} - ${date.toLocaleDateString('fr-FR')}">${dayName}<br>${dayNum}<br>${month}</th>`;
        });
        
        html += '<th class="workplan-col-total">TOTAL</th>';
        html += '</tr></thead><tbody>';
        
        // Section ComÃ©diens
        if(actors.length > 0) {
            html += `<tr class="workplan-section-row"><td colspan="${shootDays.length + 4}">ðŸŽ­ COMÃ‰DIEN.NES</td></tr>`;
            
            actors.forEach((actor, idx) => {
                const personKey = `actor_${actor.id}`;
                const character = getCharacterForActor(actor.id);
                const totalDays = countWorkDays(personKey);
                
                html += '<tr>';
                html += `<td class="workplan-cell-num">${idx + 1}</td>`;
                html += `<td class="workplan-cell-role">${Utils.escape(character || 'â€”')}</td>`;
                html += `<td class="workplan-cell-actor">${Utils.escape(actor.name || 'Sans nom')}</td>`;
                
                // Cellules des jours
                shootDays.forEach((day, dayIdx) => {
                    const code = getCellCode(personKey, dayIdx);
                    const cellClass = code ? `workplan-bar-${code}` : 'workplan-bar-empty';
                    const isEditable = !['T', 'SW', 'W', 'WF'].includes(code);
                    const clickAttr = isEditable ? `onclick="app.Planning.openWorkplanMenu(event, '${personKey}', ${dayIdx})"` : '';
                    const cursorStyle = isEditable ? 'cursor: pointer;' : '';
                    html += `<td class="${cellClass}" style="${cursorStyle}" ${clickAttr}>${code}</td>`;
                });
                
                html += `<td class="workplan-cell-total">${totalDays}</td>`;
                html += '</tr>';
            });
        }
        
        // Section Techniciens
        if(crew.length > 0) {
            html += `<tr class="workplan-section-row"><td colspan="${shootDays.length + 4}">ðŸŽ¥ TECHNICIEN.NES</td></tr>`;
            
            crew.forEach((member, idx) => {
                const personKey = `crew_${member.id}`;
                const totalDays = countWorkDays(personKey);
                
                html += '<tr>';
                html += `<td class="workplan-cell-num">${idx + 1}</td>`;
                html += `<td class="workplan-cell-role">${Utils.escape(member.role || 'â€”')}</td>`;
                html += `<td class="workplan-cell-actor">${Utils.escape(member.name || 'Sans nom')}</td>`;
                
                // Cellules des jours
                shootDays.forEach((day, dayIdx) => {
                    const code = getCellCode(personKey, dayIdx);
                    const cellClass = code ? `workplan-bar-${code}` : 'workplan-bar-empty';
                    const isEditable = !['T', 'SW', 'W', 'WF'].includes(code);
                    const clickAttr = isEditable ? `onclick="app.Planning.openWorkplanMenu(event, '${personKey}', ${dayIdx})"` : '';
                    const cursorStyle = isEditable ? 'cursor: pointer;' : '';
                    html += `<td class="${cellClass}" style="${cursorStyle}" ${clickAttr}>${code}</td>`;
                });
                
                html += `<td class="workplan-cell-total">${totalDays}</td>`;
                html += '</tr>';
            });
        }
        
        html += '</tbody></table>';
        
        // Footer avec lÃ©gende et actions
        html += `
            <div class="workplan-footer">
                <div class="workplan-legend">
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-SW">SW</div> DÃ©but</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-W">W</div> Travaille</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-WF">WF</div> Fin</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-T">T</div> Travaille (1 jour)</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-H">H</div> Hold/Retenue</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-R">R</div> Repos</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-V">V</div> Voyage</div>
                </div>
                <div class="workplan-actions">
                    <button onclick="app.Planning.printWorkPlan()">ðŸ–¨ï¸ Imprimer</button>
                    <button onclick="app.Planning.renderWorkPlan()">ðŸ”„ Actualiser</button>
                </div>
            </div>`;
        
        html += '</div>';
        
        document.getElementById('workplanContent').innerHTML = html;
    },
    
    // Ouvrir le menu pour modifier une cellule du plan de travail
    openWorkplanMenu: (event, personKey, dayIdx) => {
        event.stopPropagation();
        
        // Fermer un menu existant
        const existingMenu = document.getElementById('workplan-cell-menu');
        if(existingMenu) existingMenu.remove();
        
        // CrÃ©er le menu
        const menu = document.createElement('div');
        menu.id = 'workplan-cell-menu';
        menu.className = 'workplan-cell-menu';
        menu.innerHTML = `
            <div class="workplan-menu-item" onclick="app.Planning.setWorkplanOverride('${personKey}', ${dayIdx}, 'H')"><span class="workplan-bar-H" style="padding: 2px 6px; border-radius: 3px;">H</span> Hold</div>
            <div class="workplan-menu-item" onclick="app.Planning.setWorkplanOverride('${personKey}', ${dayIdx}, 'V')"><span class="workplan-bar-V" style="padding: 2px 6px; border-radius: 3px;">V</span> Voyage</div>
            <div class="workplan-menu-item" onclick="app.Planning.setWorkplanOverride('${personKey}', ${dayIdx}, 'R')"><span class="workplan-bar-R" style="padding: 2px 6px; border-radius: 3px;">R</span> Repos</div>
            <div class="workplan-menu-divider"></div>
            <div class="workplan-menu-item" onclick="app.Planning.setWorkplanOverride('${personKey}', ${dayIdx}, null)">âœ• Effacer</div>
        `;
        
        // Positionner le menu
        menu.style.position = 'absolute';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        document.body.appendChild(menu);
        
        // Fermer au clic ailleurs
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            });
        }, 10);
    },
    
    // DÃ©finir une valeur manuelle dans le plan de travail
    setWorkplanOverride: (personKey, dayIdx, value) => {
        if(!state.data.workplanOverrides) state.data.workplanOverrides = {};
        
        const overrideKey = `${personKey}_${dayIdx}`;
        
        if(value === null) {
            delete state.data.workplanOverrides[overrideKey];
        } else {
            state.data.workplanOverrides[overrideKey] = value;
        }
        
        // Fermer le menu
        const menu = document.getElementById('workplan-cell-menu');
        if(menu) menu.remove();
        
        // Sauvegarder et rafraÃ®chir
        Store.save();
        Planning.renderWorkPlan();
        
        Utils.toast(`Statut mis Ã  jour : ${value || 'effacÃ©'}`, 'success');
    },
    
    // RÃ©cupÃ©rer les Ã©lÃ©ments du dÃ©pouillement pour une personne selon son dÃ©partement
    getBreakdownItemsForPerson: (member, scenesIds) => {
        if(!member.group_id) return [];
        
        const categories = CONFIG.crewToBreakdownMap[member.group_id];
        if(!categories || categories.length === 0) return [];
        
        const items = [];
        
        scenesIds.forEach(sceneId => {
            const scene = state.data.scenes.find(s => s.id === sceneId);
            if(!scene || !scene.breakdown) return;
            
            const sceneIdx = state.data.scenes.indexOf(scene) + 1;
            
            categories.forEach(cat => {
                const catItems = scene.breakdown[cat] || [];
                catItems.forEach(item => {
                    items.push({
                        item: item,
                        category: cat,
                        sceneNum: sceneIdx,
                        sceneTitle: scene.title
                    });
                });
            });
        });
        
        return items;
    },
    
    // Imprimer le Plan de Travail
    printWorkPlan: () => {
        const content = document.getElementById('workplanContent').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Plan de Travail - ${state.data.title || 'Film'}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .workplan-wrapper { background: white; }
                    .workplan-header-box { border: 2px solid #333; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }
                    .workplan-header-title { font-size: 1.4rem; font-weight: bold; }
                    .workplan-header-subtitle { font-size: 0.9rem; color: #666; }
                    .workplan-header-info { font-size: 0.85rem; }
                    .workplan-header-version { text-align: right; font-size: 0.85rem; }
                    .workplan-table { width: 100%; border-collapse: collapse; font-size: 9px; }
                    .workplan-table th, .workplan-table td { border: 1px solid #999; padding: 3px 4px; text-align: center; }
                    .workplan-table thead th { background: #f0f0f0; font-weight: 600; }
                    .workplan-cell-num, .workplan-col-num { background: #f5f5f5; }
                    .workplan-cell-role, .workplan-col-role { text-align: left; width: 100px; }
                    .workplan-cell-actor, .workplan-col-actor { text-align: left; width: 110px; font-size: 8px; }
                    .workplan-cell-total, .workplan-col-total { background: #f5f5f5; font-weight: 600; }
                    .workplan-bar-T, .workplan-bar-SW, .workplan-bar-W, .workplan-bar-WF { background: #c0392b !important; color: white; font-weight: bold; }
                    .workplan-bar-H { background: #f39c12 !important; color: white; }
                    .workplan-bar-R { background: #3498db !important; color: white; }
                    .workplan-bar-V { background: #9b59b6 !important; color: white; }
                    .workplan-section-row td { background: #d5d5d5 !important; font-weight: 600; text-align: left; }
                    .workplan-footer { margin-top: 15px; }
                    .workplan-legend { display: flex; gap: 15px; flex-wrap: wrap; font-size: 10px; }
                    .workplan-legend-item { display: flex; align-items: center; gap: 4px; }
                    .workplan-legend-box { width: 20px; height: 14px; border: 1px solid #999; font-size: 8px; display: flex; align-items: center; justify-content: center; color: white; }
                    .workplan-actions { display: none; }
                    @page { size: landscape; margin: 10mm; }
                </style>
            </head>
            <body>${content}</body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    },
    
    // Afficher le Kanban
    renderKanban: () => {
        const scenes = state.data.scenes || [];
        const shootDays = state.data.shootingDays || [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // RÃ©cupÃ©rer le filtre de type
        const typeFilter = document.getElementById('kanban-type-filter')?.value || 'all';
        
        // Filtrer les jours par type si nÃ©cessaire
        const filteredDays = typeFilter === 'all' 
            ? shootDays 
            : shootDays.filter(day => (day.dayType || 'tournage') === typeFilter);
        
        // CrÃ©er un mapping scÃ¨ne -> date de tournage (uniquement pour les jours filtrÃ©s)
        const sceneToDate = {};
        const sceneToDay = {}; // Pour rÃ©cupÃ©rer les infos du jour
        filteredDays.forEach(day => {
            const dateStr = day.startDate || day.date;
            if(dateStr && day.scenes) {
                day.scenes.forEach(sceneRef => {
                    const sceneId = sceneRef.sceneId || sceneRef;
                    sceneToDate[sceneId] = new Date(dateStr);
                    sceneToDay[sceneId] = day;
                });
            }
        });
        
        // CatÃ©goriser les scÃ¨nes
        const todo = [];
        const planned = [];
        const shooting = [];
        const done = [];
        
        scenes.forEach(scene => {
            const sceneDate = sceneToDate[scene.id];
            
            if(!sceneDate) {
                // Pas dans le calendrier
                todo.push({ scene, date: null });
            } else {
                sceneDate.setHours(0, 0, 0, 0);
                if(sceneDate.getTime() === today.getTime()) {
                    // Aujourd'hui
                    shooting.push({ scene, date: sceneDate });
                } else if(sceneDate > today) {
                    // Futur
                    planned.push({ scene, date: sceneDate });
                } else {
                    // PassÃ©
                    done.push({ scene, date: sceneDate });
                }
            }
        });
        
        // Fonction pour crÃ©er une carte
        const createCard = (item) => {
            const scene = item.scene;
            const sceneIndex = scenes.findIndex(s => s.id === scene.id) + 1;
            const dateStr = item.date ? item.date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '';
            const intExt = scene.intExt || '';
            const dayNight = scene.dayNight || '';
            
            // RÃ©cupÃ©rer le type de journÃ©e
            const day = sceneToDay[scene.id];
            const dayTypeInfo = day ? Planning.getDayTypeInfo(day.dayType) : null;
            const typeTag = dayTypeInfo ? `<span style="background:${dayTypeInfo.color}; color:white; padding:2px 6px; border-radius:4px; font-size:0.7rem;">${dayTypeInfo.icon} ${dayTypeInfo.label}</span>` : '';
            
            return `
                <div class="kanban-card" onclick="app.UI.switchTab('board')">
                    <div class="kanban-card-title">Sc. ${sceneIndex} - ${Utils.escape(scene.title || 'Sans titre')}</div>
                    <div class="kanban-card-info">
                        ${intExt ? `<span class="kanban-card-tag ${intExt.toLowerCase()}">${intExt}</span>` : ''}
                        ${dayNight ? `<span class="kanban-card-tag ${dayNight.toLowerCase()}">${dayNight}</span>` : ''}
                        ${typeTag}
                    </div>
                    ${scene.location ? `<div style="font-size: 0.75rem; color: var(--text-sec); margin-top: 4px;">ðŸ“ ${Utils.escape(scene.location)}</div>` : ''}
                    ${dateStr ? `<div class="kanban-card-date">ðŸ“… ${dateStr}</div>` : ''}
                </div>
            `;
        };
        
        // Remplir les colonnes
        document.getElementById('kanban-body-todo').innerHTML = todo.length ? todo.map(createCard).join('') : '<div class="empty-state-sm">Aucune scÃ¨ne</div>';
        document.getElementById('kanban-body-planned').innerHTML = planned.length ? planned.map(createCard).join('') : '<div class="empty-state-sm">Aucune scÃ¨ne</div>';
        document.getElementById('kanban-body-shooting').innerHTML = shooting.length ? shooting.map(createCard).join('') : '<div class="empty-state-sm">Aucune scÃ¨ne</div>';
        document.getElementById('kanban-body-done').innerHTML = done.length ? done.map(createCard).join('') : '<div class="empty-state-sm">Aucune scÃ¨ne</div>';
        
        // Mettre Ã  jour les compteurs
        document.getElementById('kanban-count-todo').textContent = todo.length;
        document.getElementById('kanban-count-planned').textContent = planned.length;
        document.getElementById('kanban-count-shooting').textContent = shooting.length;
        document.getElementById('kanban-count-done').textContent = done.length;
    },
    
    applyPermissions: () => {
        const canEdit = state.currentRole === 'owner' || Permissions.canEdit('planning');
        
        // DÃ©sactiver les boutons d'ajout si pas de permission
        const addButtons = document.querySelectorAll('#tab-planning button[onclick*="addShootingDay"], #tab-planning button[onclick*="editDay"]');
        addButtons.forEach(btn => {
            if(!canEdit) {
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
                btn.title = 'ðŸ”’ Lecture seule';
            }
        });
        
        // DÃ©sactiver les clics sur les jours
        if(!canEdit) {
            const dayCells = document.querySelectorAll('.planning-day');
            dayCells.forEach(cell => {
                cell.style.cursor = 'default';
                const originalOnclick = cell.onclick;
                cell.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                };
            });
        }
    },
    
    setView: (view) => {
        Planning.currentView = view;
        document.querySelectorAll('.planning-view-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        Planning.render();
    },
    
    prev: () => {
        if(Planning.currentView === 'month') {
            Planning.currentDate.setMonth(Planning.currentDate.getMonth() - 1);
        } else if(Planning.currentView === 'week') {
            Planning.currentDate.setDate(Planning.currentDate.getDate() - 7);
        } else {
            Planning.currentDate.setDate(Planning.currentDate.getDate() - 1);
        }
        Planning.render();
    },
    
    next: () => {
        if(Planning.currentView === 'month') {
            Planning.currentDate.setMonth(Planning.currentDate.getMonth() + 1);
        } else if(Planning.currentView === 'week') {
            Planning.currentDate.setDate(Planning.currentDate.getDate() + 7);
        } else {
            Planning.currentDate.setDate(Planning.currentDate.getDate() + 1);
        }
        Planning.render();
    },
    
    goToday: () => {
        Planning.currentDate = new Date();
        Planning.render();
    },
    
    render: () => {
        Planning.renderAvailabilitySelectors();
        const container = document.getElementById('planningContainer');
        const titleEl = document.getElementById('planningTitle');
        
        const months = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
        const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        
        if(Planning.currentView === 'month') {
            titleEl.innerText = months[Planning.currentDate.getMonth()] + ' ' + Planning.currentDate.getFullYear();
            container.innerHTML = Planning.renderMonthView();
        } else if(Planning.currentView === 'week') {
            const weekStart = Planning.getWeekStart(Planning.currentDate);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            titleEl.innerText = `${weekStart.getDate()} - ${weekEnd.getDate()} ${months[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;
            container.innerHTML = Planning.renderWeekView();
        } else {
            titleEl.innerText = `${days[Planning.currentDate.getDay()]} ${Planning.currentDate.getDate()} ${months[Planning.currentDate.getMonth()]} ${Planning.currentDate.getFullYear()}`;
            container.innerHTML = Planning.renderDayView();
        }
    },
    
    getWeekStart: (date) => {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    },
    
    formatDate: (date) => {
        const d = new Date(date);
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    },
    
    getShootDay: (dateStr) => {
        if(!state.data.shootingDays) return null;
        return state.data.shootingDays.find(sd => {
            const start = sd.startDate || sd.date;
            const end = sd.endDate || sd.startDate || sd.date;
            return dateStr >= start && dateStr <= end;
        });
    },
    
    getShootDayByStartDate: (dateStr) => {
        if(!state.data.shootingDays) return null;
        return state.data.shootingDays.find(sd => (sd.startDate || sd.date) === dateStr);
    },
    
    renderMonthView: () => {
        const year = Planning.currentDate.getFullYear();
        const month = Planning.currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        const today = Planning.formatDate(new Date());
        
        let html = '<div class="planning-calendar">';
        html += '<div class="planning-weekdays">';
        ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(d => {
            html += `<div class="planning-weekday">${d}</div>`;
        });
        html += '</div>';
        html += '<div class="planning-days">';
        
        // Previous month days
        const prevMonth = new Date(year, month, 0);
        for(let i = startDay - 1; i >= 0; i--) {
            const day = prevMonth.getDate() - i;
            const dateStr = Planning.formatDate(new Date(year, month - 1, day));
            const shootDay = Planning.getShootDay(dateStr);
            html += `<div class="planning-day other-month" data-date="${dateStr}" onclick="app.Planning.openDay('${dateStr}')" ondragover="app.Planning.onDragOver(event)" ondrop="app.Planning.onDrop(event, '${dateStr}')">
                <div class="planning-day-number">${day}</div>
                ${shootDay ? (() => { const typeInfo = Planning.getDayTypeInfo(shootDay.dayType); return `<div class="planning-day-shoot" style="background: ${typeInfo.color};" draggable="true" ondragstart="app.Planning.onDragStart(event, '${shootDay.id}')" onclick="event.stopPropagation(); app.Planning.editShootDay('${shootDay.id}')" oncontextmenu="event.preventDefault(); event.stopPropagation(); app.Planning.showDayContextMenu(event, '${shootDay.id}')" title="${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label)}"><span class="month-resize-handle left" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'left')"></span>${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label).substring(0, 10)}<span class="month-resize-handle right" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'right')"></span></div>`; })() : ''}
            </div>`;
        }
        
        // Current month days
        for(let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = Planning.formatDate(new Date(year, month, day));
            const isToday = dateStr === today;
            const shootDay = Planning.getShootDay(dateStr);
            const hasShoot = shootDay !== null;
            
            // RÃ©cupÃ©rer les disponibilitÃ©s
            const availBars = Planning.getAvailabilityBarsForDate(dateStr);
            let availHTML = '';
            if(availBars.length > 0) {
                availHTML = '<div class="planning-day-availability">';
                availBars.forEach(bar => {
                    let vehicleIcon = '';
                    if(bar.hasVehicle) {
                        let vehicleInfo = bar.vehicleSeats ? bar.vehicleSeats + ' place(s)' : '';
                        if(bar.vehicleTrunk) vehicleInfo += vehicleInfo ? ' + coffre dispo' : 'Coffre dispo';
                        vehicleIcon = `<span style="margin-left: auto; cursor: help;" title="${vehicleInfo || 'VÃ©hicule disponible'}">ðŸš—</span>`;
                    }
                    availHTML += `<div class="availability-bar" style="background: ${bar.color};">${bar.name}${vehicleIcon}</div>`;
                });
                availHTML += '</div>';
            }
            
            let classes = 'planning-day';
            if(isToday) classes += ' today';
            if(hasShoot) classes += ' has-shoot';
            
            html += `<div class="${classes}" data-date="${dateStr}" onclick="app.Planning.openDay('${dateStr}')" ondragover="app.Planning.onDragOver(event)" ondrop="app.Planning.onDrop(event, '${dateStr}')">
                <div class="planning-day-number">${day}</div>
                ${availHTML}
                ${shootDay ? (() => { const typeInfo = Planning.getDayTypeInfo(shootDay.dayType); return `<div class="planning-day-shoot" style="background: ${typeInfo.color};" draggable="true" ondragstart="app.Planning.onDragStart(event, '${shootDay.id}')" onclick="event.stopPropagation(); app.Planning.editShootDay('${shootDay.id}')" oncontextmenu="event.preventDefault(); event.stopPropagation(); app.Planning.showDayContextMenu(event, '${shootDay.id}')" title="${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label)}"><span class="month-resize-handle left" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'left')"></span>${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label).substring(0, 10)}<span class="month-resize-handle right" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'right')"></span></div>`; })() : ''}
            </div>`;
        }
        
        // Next month days
        const totalCells = startDay + lastDay.getDate();
        const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for(let day = 1; day <= remaining; day++) {
            const dateStr = Planning.formatDate(new Date(year, month + 1, day));
            const shootDay = Planning.getShootDay(dateStr);
            html += `<div class="planning-day other-month" data-date="${dateStr}" onclick="app.Planning.openDay('${dateStr}')" ondragover="app.Planning.onDragOver(event)" ondrop="app.Planning.onDrop(event, '${dateStr}')">
                <div class="planning-day-number">${day}</div>
                ${shootDay ? (() => { const typeInfo = Planning.getDayTypeInfo(shootDay.dayType); return `<div class="planning-day-shoot" style="background: ${typeInfo.color};" draggable="true" ondragstart="app.Planning.onDragStart(event, '${shootDay.id}')" onclick="event.stopPropagation(); app.Planning.editShootDay('${shootDay.id}')" oncontextmenu="event.preventDefault(); event.stopPropagation(); app.Planning.showDayContextMenu(event, '${shootDay.id}')" title="${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label)}"><span class="month-resize-handle left" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'left')"></span>${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label).substring(0, 10)}<span class="month-resize-handle right" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'right')"></span></div>`; })() : ''}
            </div>`;
        }
        
        html += '</div></div>';
        return html;
    },
    
    renderWeekView: () => {
        const weekStart = Planning.getWeekStart(Planning.currentDate);
        const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        const today = Planning.formatDate(new Date());
        
        // Collecter les jours de tournage de la semaine
        const weekShootDays = [];
        
        // CrÃ©er un tableau des 7 dates de la semaine (format YYYY-MM-DD)
        const weekDates = [];
        for(let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + i);
            weekDates.push(Planning.formatDate(d));
        }
        
        // Parcourir tous les jours de tournage et voir lesquels sont dans cette semaine
        (state.data.shootingDays || []).forEach(shootDay => {
            const startDate = shootDay.startDate || shootDay.date;
            const endDate = shootDay.endDate || shootDay.startDate || shootDay.date;
            if(!startDate) return;
            
            const weekStartStr = weekDates[0];
            const weekEndStr = weekDates[6];
            
            // VÃ©rifier si le tournage chevauche cette semaine
            // Le tournage chevauche si : startDate <= weekEnd ET endDate >= weekStart
            if(startDate > weekEndStr || endDate < weekStartStr) {
                // Pas de chevauchement, ignorer
                return;
            }
            
            // Calculer les indices de dÃ©but et fin dans la semaine
            let startDayIndex = weekDates.indexOf(startDate);
            let endDayIndex = weekDates.indexOf(endDate);
            
            // Si le dÃ©but est avant cette semaine, commencer au jour 0
            if(startDayIndex < 0 && startDate < weekStartStr) {
                startDayIndex = 0;
            }
            // Si la fin est aprÃ¨s cette semaine, finir au jour 6
            if(endDayIndex < 0 && endDate > weekEndStr) {
                endDayIndex = 6;
            }
            
            // Si toujours -1, c'est que la date n'est pas dans la semaine (ne devrait pas arriver aprÃ¨s le check ci-dessus)
            if(startDayIndex < 0 || endDayIndex < 0) return;
            
            const spanDays = endDayIndex - startDayIndex + 1;
            const startHour = shootDay.crewCall ? parseInt(shootDay.crewCall.split(':')[0]) : 7;
            const endHour = shootDay.estimatedWrap ? parseInt(shootDay.estimatedWrap.split(':')[0]) : 19;
            
            weekShootDays.push({ 
                ...shootDay, 
                dayIndex: startDayIndex, 
                spanDays: spanDays,
                startHour, 
                endHour, 
                dateStr: startDate 
            });
        });
        
        let html = '<div class="planning-week-view">';
        
        // Header
        html += '<div class="planning-week-header">';
        html += '<div class="planning-week-header-cell"></div>';
        for(let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + i);
            const dateStr = Planning.formatDate(d);
            const isToday = dateStr === today;
            html += `<div class="planning-week-header-cell" style="${isToday ? 'background: var(--primary); color: white;' : ''}">${days[i]} ${d.getDate()}</div>`;
        }
        html += '</div>';
        
        // Body - Time slots avec position relative pour les Ã©vÃ©nements
        html += '<div class="planning-week-body pos-relative">';
        
        // Grille des heures
        for(let hour = 6; hour <= 22; hour++) {
            html += '<div class="planning-week-row">';
            html += `<div class="planning-week-time">${String(hour).padStart(2, '0')}:00</div>`;
            
            for(let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                const dateStr = Planning.formatDate(d);
                
                html += `<div class="planning-week-cell" data-hour="${hour}" data-day="${i}" data-date="${dateStr}" onclick="app.Planning.openDay('${dateStr}')" ondragover="app.Planning.onDragOverWeek(event, ${hour})" ondragleave="app.Planning.onDragLeave(event)" ondrop="app.Planning.onDropWeek(event, '${dateStr}', ${hour})"></div>`;
            }
            html += '</div>';
        }
        
        // Overlay des Ã©vÃ©nements (positionnÃ©s absolument dans le body)
        html += '<div class="planning-week-events-overlay">';
        weekShootDays.forEach(shootDay => {
            const totalHours = 17; // de 6h Ã  22h + 1
            const topPercent = ((shootDay.startHour - 6) / totalHours) * 100;
            const heightPercent = Math.max(((shootDay.endHour - shootDay.startHour) / totalHours) * 100, 5);
            
            const spanDays = shootDay.spanDays || 1;
            const widthCalc = `calc((100% / 7) * ${spanDays} - 6px)`;
            
            // Pour les jours multi-jours, le bloc prend toute la hauteur
            let blockTop, blockHeight;
            if(spanDays > 1) {
                // Multi-jours : de l'heure de dÃ©but du premier jour jusqu'Ã  la fin de journÃ©e, puis journÃ©es complÃ¨tes
                blockTop = ((shootDay.startHour - 6) / 17) * 100;
                blockHeight = 100 - blockTop; // Jusqu'en bas
            } else {
                blockTop = topPercent;
                blockHeight = heightPercent;
            }
            
            // Nom du tournage (basÃ© sur les scÃ¨nes ou le nom personnalisÃ©)
            const displayName = shootDay.name || `Tournage`;
            
            html += `<div class="planning-week-event-block ${spanDays > 1 ? 'multi-day' : ''}" 
                style="top: ${blockTop}%; height: ${blockHeight}%; left: calc((100% / 7) * ${shootDay.dayIndex} + 3px); width: ${widthCalc};"
                draggable="true" 
                ondragstart="app.Planning.onDragStart(event, '${shootDay.id}')"
                onclick="event.stopPropagation(); app.Planning.editShootDay('${shootDay.id}')" 
                oncontextmenu="event.preventDefault(); event.stopPropagation(); app.Planning.showDayContextMenu(event, '${shootDay.id}')"
                title="${Utils.escape(displayName)} | ${shootDay.crewCall || '07:00'} - ${shootDay.estimatedWrap || '19:00'} | ${(shootDay.scenes || []).length} scÃ¨ne(s)">
                <div class="event-block-content">
                    <strong>${Utils.escape(displayName)}</strong>
                    <span>${shootDay.crewCall || '07:00'} - ${shootDay.estimatedWrap || '19:00'}</span>
                    <span>${(shootDay.scenes || []).length} scÃ¨ne(s)${spanDays > 1 ? ' â€¢ ' + spanDays + 'j' : ''}</span>
                </div>
                <div class="event-resize-handle-top" onmousedown="app.Planning.startResize(event, '${shootDay.id}', 'top')"></div>
                <div class="event-resize-handle-bottom" onmousedown="app.Planning.startResize(event, '${shootDay.id}', 'bottom')"></div>
                <div class="event-resize-handle-right" onmousedown="app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'right')"></div>
                <div class="event-resize-handle-left" onmousedown="app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'left')"></div>
            </div>`;
        });
        html += '</div>'; // Ferme overlay
        
        html += '</div>'; // Ferme week-body
        
        html += '</div>'; // Ferme week-view
        return html;
    },
    
    renderDayView: () => {
        const dateStr = Planning.formatDate(Planning.currentDate);
        const shootDay = Planning.getShootDay(dateStr);
        const availBars = Planning.getAvailabilityBarsForDate(dateStr);
        
        let html = '<div class="planning-day-view">';
        
        // En-tÃªte du jour
        html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid var(--border);">
            <div>
                <div style="font-size:1.5rem; font-weight:bold;">ðŸ“… ${new Date(dateStr).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
            </div>
            <div class="flex-gap10">
                ${shootDay ? `<button onclick="app.Planning.editShootDay('${shootDay.id}')" class="btn-primary">âœï¸ Modifier : ${Utils.escape(shootDay.name || 'Tournage')}</button>` : `<button onclick="app.Planning.addShootDay('${dateStr}')" class="btn-primary">âž• Planifier un tournage</button>`}
            </div>
        </div>`;
        
        // Section Jour de Tournage
        if(shootDay) {
            html += `<div style="background:rgba(40,167,69,0.1); border:2px solid var(--success); border-radius:8px; padding:15px; margin-bottom:20px;">
                <div class="flex-center-mb10">
                    <span class="fs-15">ðŸŽ¬</span>
                    <span style="font-weight:bold; font-size:1.1rem;">${Utils.escape(shootDay.name || 'Tournage')}</span>
                </div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px; font-size:0.9rem;">
                    <div>ðŸ“ <strong>Lieu:</strong> ${shootDay.location || 'Non dÃ©fini'}</div>
                    <div>â° <strong>Convocation:</strong> ${shootDay.crewCall || '--:--'}</div>
                    <div>ðŸŽ¬ <strong>PrÃªt Ã  tourner:</strong> ${shootDay.readyToShoot || '--:--'}</div>
                    <div>ðŸ <strong>Fin estimÃ©e:</strong> ${shootDay.estimatedWrap || '--:--'}</div>
                </div>
                <div style="margin-top:10px; font-size:0.9rem;">
                    <strong>ScÃ¨nes:</strong> ${shootDay.scenes?.length || 0} â€¢ 
                    <strong>ConvoquÃ©s:</strong> ${shootDay.callSheet?.length || 0}
                </div>
            </div>`;
        } else {
            html += `<div style="background:var(--bg); border:1px dashed var(--border); border-radius:8px; padding:20px; margin-bottom:20px; text-align:center; color:var(--text-sec);">
                <span class="fs-15">ðŸ“­</span>
                <p style="margin:10px 0 0;">Aucun tournage planifiÃ© ce jour</p>
            </div>`;
        }
        
        // Section DisponibilitÃ©s ComÃ©diens
        html += `<div class="mb-20">
            <h3 class="title-primary">ðŸŽ­ DisponibilitÃ©s ComÃ©dien.nes</h3>`;
        
        const actorBars = availBars.filter(b => b.type === 'actor');
        if(actorBars.length > 0) {
            html += '<div class="flex-wrap-gap8">';
            actorBars.forEach(bar => {
                const bgColor = bar.color || '#4CAF50';
                html += `<div style="background:${bgColor}; color:#fff; padding:6px 12px; border-radius:20px; font-size:0.85rem; display:flex; align-items:center; gap:5px;">
                    ${bar.name}
                    ${bar.hasVehicle ? '<span title="VÃ©hicule disponible">ðŸš—</span>' : ''}
                </div>`;
            });
            html += '</div>';
        } else {
            html += '<div style="color:var(--text-sec); font-size:0.9rem; padding:10px; background:var(--bg); border-radius:6px;">Aucune disponibilitÃ© affichÃ©e. SÃ©lectionnez des comÃ©dien.nes dans le panneau ci-dessus.</div>';
        }
        html += '</div>';
        
        // Section DisponibilitÃ©s Techniciens
        html += `<div class="mb-20">
            <h3 class="title-primary">ðŸŽ¬ DisponibilitÃ©s Ã‰quipe Technique</h3>`;
        
        const crewBars = availBars.filter(b => b.type === 'crew');
        if(crewBars.length > 0) {
            html += '<div class="flex-wrap-gap8">';
            crewBars.forEach(bar => {
                const bgColor = bar.color || '#2196F3';
                html += `<div style="background:${bgColor}; color:#fff; padding:6px 12px; border-radius:20px; font-size:0.85rem; display:flex; align-items:center; gap:5px;">
                    ${bar.name}
                    ${bar.hasVehicle ? '<span title="VÃ©hicule disponible">ðŸš—</span>' : ''}
                </div>`;
            });
            html += '</div>';
        } else {
            html += '<div style="color:var(--text-sec); font-size:0.9rem; padding:10px; background:var(--bg); border-radius:6px;">Aucune disponibilitÃ© affichÃ©e. SÃ©lectionnez des technicien.nes dans le panneau ci-dessus.</div>';
        }
        html += '</div>';
        
        // RÃ©sumÃ© des vÃ©hicules disponibles
        const vehicleBars = availBars.filter(b => b.hasVehicle);
        if(vehicleBars.length > 0) {
            html += `<div style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:15px;">
                <h3 class="title-primary">ðŸš— VÃ©hicules Disponibles</h3>
                <div style="display:flex; flex-wrap:wrap; gap:10px;">`;
            vehicleBars.forEach(bar => {
                let vehicleInfo = bar.vehicleSeats ? `${bar.vehicleSeats} places` : '';
                if(bar.vehicleTrunk) vehicleInfo += vehicleInfo ? ' + coffre' : 'Coffre dispo';
                html += `<div style="background:var(--panel-bg); border:1px solid var(--border); padding:8px 12px; border-radius:6px; font-size:0.85rem;">
                    <strong>${bar.name}</strong> ${vehicleInfo ? `<span class="text-sec">â€¢ ${vehicleInfo}</span>` : ''}
                </div>`;
            });
            html += '</div></div>';
        }
        
        html += '</div>';
        return html;
    },
    
    renderShootDayCard: (shootDay) => {
        let html = `<div class="shoot-day-card">`;
        const startDateObj = new Date(shootDay.startDate || shootDay.date);
        const endDateObj = new Date(shootDay.endDate || shootDay.startDate || shootDay.date);
        const dateDisplay = shootDay.startDate === shootDay.endDate || !shootDay.endDate
            ? startDateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })
            : startDateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) + ' â†’ ' + endDateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
        
        html += `<h3>${Utils.escape(shootDay.name || 'Tournage')} - ${dateDisplay}
            <button onclick="app.Planning.editShootDay('${shootDay.id}')" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">âœï¸ Modifier</button>
        </h3>`;
        
        // Weather
        html += `<div class="weather-widget" id="weather-${shootDay.id}">
            <div class="weather-icon">ðŸŒ¤ï¸</div>
            <div class="weather-info">
                <div class="weather-temp">--Â°C</div>
                <div class="weather-desc">Chargement mÃ©tÃ©o...</div>
            </div>
        </div>`;
        
        // Location
        if(shootDay.location) {
            html += `<div class="shoot-section mt-15">
                <div class="shoot-section-title">ðŸ“ Lieu de tournage</div>
                <div style="padding: 10px; background: var(--panel-bg); border-radius: 6px;">
                    <strong>${Utils.escape(shootDay.location)}</strong><br>
                    ${shootDay.locationAddress ? Utils.escape(shootDay.locationAddress) : ''}
                </div>
            </div>`;
        }
        
        // Horaires
        html += `<div class="shoot-section">
            <div class="shoot-section-title">â° Horaires</div>
            <div class="shoot-time-grid">
                <div><strong>Convocation Ã©quipe:</strong> ${shootDay.crewCall || '--:--'}</div>
                <div><strong>PrÃªt Ã  tourner:</strong> ${shootDay.readyToShoot || '--:--'}</div>
                <div><strong>Pause dÃ©jeuner:</strong> ${shootDay.lunchStart || '--:--'} - ${shootDay.lunchEnd || '--:--'}</div>
                <div><strong>Fin estimÃ©e:</strong> ${shootDay.estimatedWrap || '--:--'}</div>
            </div>
        </div>`;
        
        // ScÃ¨nes
        if(shootDay.scenes && shootDay.scenes.length > 0) {
            html += `<div class="shoot-section">
                <div class="shoot-section-title">ðŸŽ¬ ScÃ¨nes du jour (${shootDay.scenes.length})</div>
                <div class="shoot-scene-list">`;
            
            shootDay.scenes.forEach(sceneRef => {
                const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId);
                if(scene) {
                    html += `<div class="shoot-scene-item">
                        <input type="time" class="shoot-scene-time" value="${sceneRef.startTime || ''}" disabled>
                        <div class="shoot-scene-info">
                            <div class="shoot-scene-title">${Utils.escape(scene.title)}</div>
                            <div class="shoot-scene-meta">${Utils.escape(scene.perso || 'Pas de personnages dÃ©finis')}</div>
                        </div>
                    </div>`;
                }
            });
            
            html += `</div></div>`;
        }
        
        // Convocations
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            html += `<div class="shoot-section">
                <div class="shoot-section-title">ðŸ“‹ Convocations (${shootDay.callSheet.length})</div>
                <table class="callsheet-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Fonction</th>
                            <th>Convocation</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            // SÃ©parer comÃ©diens et techniciens
            const actorCalls = shootDay.callSheet.filter(c => c.type === 'actor');
            const crewCalls = shootDay.callSheet.filter(c => c.type === 'crew');
            
            // Afficher les comÃ©diens groupÃ©s par catÃ©gorie
            if(actorCalls.length > 0) {
                const actorGroups = state.data.groups.filter(g => g.type === 'actor');
                
                actorGroups.forEach(grp => {
                    const groupCalls = actorCalls.filter(call => {
                        const actor = state.data.actors.find(a => a.id === call.personId);
                        return actor && actor.group_id === grp.id;
                    });
                    
                    if(groupCalls.length > 0) {
                        html += `<tr class="bg-base"><td colspan="4" class="th-primary">ðŸŽ­ ${grp.name}</td></tr>`;
                        groupCalls.forEach(call => {
                            const person = state.data.actors.find(a => a.id === call.personId);
                            if(person) {
                                const character = state.data.characters.find(c => c.actor_id === person.id);
                                const role = character ? character.name : 'ComÃ©dien(ne)';
                                html += `<tr>
                                    <td>${Utils.escape(person.name)}</td>
                                    <td>${Utils.escape(role)}</td>
                                    <td><strong>${call.callTime || '--:--'}</strong></td>
                                    <td>${Utils.escape(call.notes || '')}</td>
                                </tr>`;
                            }
                        });
                    }
                });
                
                // ComÃ©diens sans groupe
                const noGroupCalls = actorCalls.filter(call => {
                    const actor = state.data.actors.find(a => a.id === call.personId);
                    return actor && (!actor.group_id || !actorGroups.find(g => g.id === actor.group_id));
                });
                
                if(noGroupCalls.length > 0) {
                    html += `<tr class="bg-base"><td colspan="4" class="th-primary">ðŸŽ­ ComÃ©diens</td></tr>`;
                    noGroupCalls.forEach(call => {
                        const person = state.data.actors.find(a => a.id === call.personId);
                        if(person) {
                            const character = state.data.characters.find(c => c.actor_id === person.id);
                            const role = character ? character.name : 'ComÃ©dien(ne)';
                            html += `<tr>
                                <td>${Utils.escape(person.name)}</td>
                                <td>${Utils.escape(role)}</td>
                                <td><strong>${call.callTime || '--:--'}</strong></td>
                                <td>${Utils.escape(call.notes || '')}</td>
                            </tr>`;
                        }
                    });
                }
            }
            
            // Afficher les techniciens groupÃ©s par dÃ©partement
            if(crewCalls.length > 0) {
                const crewGroups = state.data.groups.filter(g => g.type === 'crew');
                
                crewGroups.forEach(grp => {
                    const groupCalls = crewCalls.filter(call => {
                        const member = state.data.crew.find(c => c.id === call.personId);
                        return member && member.group_id === grp.id;
                    });
                    
                    if(groupCalls.length > 0) {
                        html += `<tr class="bg-base"><td colspan="4" class="th-primary">${grp.name}</td></tr>`;
                        groupCalls.forEach(call => {
                            const person = state.data.crew.find(c => c.id === call.personId);
                            if(person) {
                                html += `<tr>
                                    <td>${Utils.escape(person.name)}</td>
                                    <td>${Utils.escape(person.role || 'Technicien')}</td>
                                    <td><strong>${call.callTime || '--:--'}</strong></td>
                                    <td>${Utils.escape(call.notes || '')}</td>
                                </tr>`;
                            }
                        });
                    }
                });
                
                // Techniciens sans groupe
                const noGroupCalls = crewCalls.filter(call => {
                    const member = state.data.crew.find(c => c.id === call.personId);
                    return member && (!member.group_id || !crewGroups.find(g => g.id === member.group_id));
                });
                
                if(noGroupCalls.length > 0) {
                    html += `<tr class="bg-base"><td colspan="4" style="font-weight: bold; padding: 8px; color: var(--text-sec);">Autres techniciens</td></tr>`;
                    noGroupCalls.forEach(call => {
                        const person = state.data.crew.find(c => c.id === call.personId);
                        if(person) {
                            html += `<tr>
                                <td>${Utils.escape(person.name)}</td>
                                <td>${Utils.escape(person.role || 'Technicien')}</td>
                                <td><strong>${call.callTime || '--:--'}</strong></td>
                                <td>${Utils.escape(call.notes || '')}</td>
                            </tr>`;
                        }
                    });
                }
            }
            
            html += `</tbody></table></div>`;
        }
        
        // Notes
        if(shootDay.notes) {
            html += `<div class="shoot-section">
                <div class="shoot-section-title">ðŸ“ Notes</div>
                <div style="padding: 10px; background: var(--panel-bg); border-radius: 6px; white-space: pre-wrap;">${Utils.escape(shootDay.notes)}</div>
            </div>`;
        }
        
        // Bouton Email
        html += `<div class="shoot-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
            <button onclick="app.Planning.sendCallSheetEmail('${shootDay.id}')" style="padding: 12px 24px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                ðŸ“§ Envoyer la feuille de service par email
            </button>
        </div>`;
        
        html += `</div>`;
        
        // Load weather
        setTimeout(() => Planning.loadWeather(shootDay), 100);
        
        return html;
    },
    
    openDay: (dateStr) => {
        const shootDay = Planning.getShootDay(dateStr);
        if(shootDay) {
            Planning.editShootDay(shootDay.id);
        } else {
            Planning.addShootDay(dateStr);
        }
    },
    
    addShootDay: (dateStr) => {
        if(state.currentRole === 'viewer') return;
        
        const date = dateStr || Planning.formatDate(Planning.currentDate);
        
        // Calculate day number
        const existingDays = state.data.shootingDays || [];
        const dayNumber = existingDays.length + 1;
        
        const newDay = {
            id: Utils.generateUniqueId(),
            date: date,
            dayNumber: dayNumber,
            dayType: 'tournage', // tournage, repetition, reperage, essai_costume, formation, reunion
            location: '',
            locationAddress: '',
            crewCall: '07:00',
            readyToShoot: '08:30',
            lunchStart: '13:00',
            lunchEnd: '14:00',
            estimatedWrap: '19:00',
            scenes: [],
            callSheet: [],
            notes: '',
            weather: null,
            customWeather: ''
        };
        
        Planning.editingDayId = 'new';
        Planning.showEditModal(newDay);
    },
    
    editShootDay: (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        // S'assurer que scenes et callSheet sont des tableaux
        if(!shootDay.scenes) shootDay.scenes = [];
        if(!shootDay.callSheet) shootDay.callSheet = [];
        
        Planning.editingDayId = dayId;
        Planning.showEditModal(shootDay);
    },
    
    showEditModal: (shootDay) => {
        // Store temp copy for editing
        Planning.tempShootDay = JSON.parse(JSON.stringify(shootDay));
        
        const modal = document.getElementById('planning-modal');
        const title = document.getElementById('planningModalTitle');
        const body = document.getElementById('planningModalBody');
        
        title.innerText = Planning.editingDayId === 'new' ? 'Nouveau Tournage' : `Modifier : ${shootDay.name || 'Tournage'}`;
        
        // Get all scenes
        const allScenes = state.data.scenes;
        
        // Build dropdown options
        let sceneOptions = '<option value="">-- SÃ©lectionner une scÃ¨ne --</option>';
        allScenes.forEach((scene, idx) => {
            const alreadyInThisDay = (shootDay.scenes || []).some(ref => ref.sceneId === scene.id);
            if(!alreadyInThisDay) {
                const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
const shotLabel = shotCount > 0 ? ` ðŸ“·${shotCount}` : '';
sceneOptions += `<option value="${scene.id}">#${idx + 1} - ${Utils.escape(scene.title)}${shotLabel}</option>`;
            }
        });
        
        // Build selected scenes list
        let selectedScenesHTML = '';
        (shootDay.scenes || []).forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId);
            if(scene) {
                const sceneIdx = state.data.scenes.indexOf(scene) + 1;
                const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
const shotBadge = shotCount > 0 ? `<span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">ðŸ“· ${shotCount} plan${shotCount > 1 ? 's' : ''}</span>` : '<span style="background: var(--border); color: var(--text-sec); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">ðŸ“· 0</span>';
// RÃ©cupÃ©rer les plans de cette scÃ¨ne
                const sceneShots = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id) : [];
                const selectedShots = sceneRef.selectedShots || [];
                
                let shotsHTML = '';
                if(sceneShots.length > 0) {
                    shotsHTML = `<div class="scene-shots-list" style="margin-top: 8px; padding: 8px; background: var(--panel-bg); border-radius: 4px;">
                        <div class="text-sec-sm-mb5">ðŸ“· Plans Ã  tourner :</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${sceneShots.map(shot => {
                                const isSelected = selectedShots.includes(shot.id);
                                return `<label style="display: flex; align-items: center; gap: 3px; padding: 3px 8px; background: ${isSelected ? 'var(--primary)' : 'var(--bg)'}; color: ${isSelected ? 'white' : 'var(--text-main)'}; border-radius: 4px; cursor: pointer; font-size: 0.8rem; border: 1px solid var(--border);">
                                    <input type="checkbox" data-scene-id="${scene.id}" data-shot-id="${shot.id}" ${isSelected ? 'checked' : ''} onchange="app.Planning.toggleShotSelection('${scene.id}', '${shot.id}')" class="d-none">
                                    ${Utils.escape(shot.shotNumber || shot.name || 'Plan ' + shot.id)}
                                </label>`;
                            }).join('')}
                        </div>
                        <div class="mt-5">
                            <button onclick="app.Planning.selectAllShots('${scene.id}')" class="n8-badge-5">Tout</button>
                            <button onclick="app.Planning.deselectAllShots('${scene.id}')" class="n8-badge-11">Aucun</button>
                        </div>
                    </div>`;
                }
                
                selectedScenesHTML += `<div class="selected-scene-item" style="margin-bottom: 10px; padding: 10px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border);">
                    <div class="flex-row-gap10">
                        <input type="time" id="scene-time-${scene.id}" value="${sceneRef.startTime || ''}" style="width: 90px;">
                        <span style="flex: 1; font-weight: bold;">#${sceneIdx} - ${Utils.escape(scene.title)}${shotBadge}</span>
                        <span class="text-sec-sm2">${Utils.escape(scene.perso || '')}</span>
                        <button onclick="app.Planning.removeSceneFromDay('${scene.id}')" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">âœ–</button>
                    </div>
                    ${shotsHTML}
                </div>`;
            }
        });
        
        if(!shootDay.scenes || shootDay.scenes.length === 0) {
            selectedScenesHTML = '<div style="color: var(--text-sec); font-style: italic; padding: 15px; text-align: center;">Aucune scÃ¨ne sÃ©lectionnÃ©e</div>';
        }
        
        const scenesSelectionHTML = `
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="scene-dropdown" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); font-size: 1rem;">
                    ${sceneOptions}
                </select>
                <button onclick="app.Planning.addSceneToDay()" class="btn-primary">âž• Ajouter</button>
            </div>
            <div id="selected-scenes-list">${selectedScenesHTML}</div>
        `;
        
        // Get all people for callsheet
        let callsheetRows = '';
        
        // Actors
        if(state.data.actors && state.data.actors.length > 0) {
            state.data.actors.forEach(actor => {
                const call = shootDay.callSheet.find(c => c.personId === actor.id && c.type === 'actor');
                callsheetRows += `<tr>
                    <td><input type="checkbox" id="call-actor-${actor.id}" data-type="actor" data-id="${actor.id}" ${call ? 'checked' : ''}></td>
                    <td>${Utils.escape(actor.name)}</td>
                    <td>ComÃ©dien(ne)</td>
                    <td><input type="time" id="call-time-actor-${actor.id}" value="${call ? call.callTime : ''}" style="width: 85px;"></td>
                    <td>
                        <select id="call-transport-actor-${actor.id}" onchange="app.Planning.onTransportChange('actor', '${actor.id}')" style="width: 100%; padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.85rem;">
                            <option value="" ${!call?.transport ? 'selected' : ''}>-- Transport --</option>
                            <option value="own" ${call?.transport === 'own' ? 'selected' : ''}>ðŸš— Propres moyens</option>
                            <option value="own-brings" ${call?.transport === 'own-brings' ? 'selected' : ''}>ðŸš—ðŸ‘¥ AmÃ¨ne...</option>
                            <option value="taxi" ${call?.transport === 'taxi' ? 'selected' : ''}>ðŸš• Taxi</option>
                            <option value="public" ${call?.transport === 'public' ? 'selected' : ''}>ðŸš‡ Transports</option>
                            <option value="with" ${call?.transport === 'with' ? 'selected' : ''}>ðŸš—âž¡ï¸ Part avec...</option>
                        </select>
                    </td>
                    <td>
                        <div id="call-withwho-actor-${actor.id}" class="withwho-dropdown" style="display: ${call?.transport === 'own-brings' || call?.transport === 'with' ? 'block' : 'none'};">
                            <button type="button" class="withwho-btn" onclick="app.Planning.toggleWithWhoDropdown('actor', '${actor.id}')">
                                <span class="withwho-label">-- Choisir --</span>
                            </button>
                            <div class="withwho-list" id="call-withwho-list-actor-${actor.id}"></div>
                        </div>
                    </td>
                    <td><input type="text" id="call-notes-actor-${actor.id}" value="${call?.notes || ''}" placeholder="Notes..." class="w-full"></td>
                </tr>`;
            });
        }
        
        // Crew - GroupÃ© par dÃ©partement
        if(state.data.crew && state.data.crew.length > 0) {
            const crewGroups = state.data.groups.filter(g => g.type === 'crew');
            
            // D'abord les techniciens groupÃ©s par dÃ©partement
            crewGroups.forEach(grp => {
                const membersInGroup = state.data.crew.filter(m => m.group_id === grp.id);
                if(membersInGroup.length > 0) {
                    callsheetRows += `<tr class="bg-base"><td colspan="5" style="font-weight: bold; padding: 10px; color: var(--primary);">${grp.name}</td></tr>`;
                    membersInGroup.forEach(member => {
                        const call = shootDay.callSheet.find(c => c.personId === member.id && c.type === 'crew');
                        callsheetRows += `<tr>
                            <td><input type="checkbox" id="call-crew-${member.id}" data-type="crew" data-id="${member.id}" ${call ? 'checked' : ''}></td>
                            <td>${Utils.escape(member.name)}</td>
                            <td>${Utils.escape(member.role || 'Technicien')}</td>
                            <td><input type="time" id="call-time-crew-${member.id}" value="${call ? call.callTime : ''}" style="width: 85px;"></td>
                            <td>
                                <select id="call-transport-crew-${member.id}" onchange="app.Planning.onTransportChange('crew', '${member.id}')" style="width: 100%; padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.85rem;">
                                    <option value="" ${!call?.transport ? 'selected' : ''}>-- Transport --</option>
                                    <option value="own" ${call?.transport === 'own' ? 'selected' : ''}>ðŸš— Propres moyens</option>
                                    <option value="own-brings" ${call?.transport === 'own-brings' ? 'selected' : ''}>ðŸš—ðŸ‘¥ AmÃ¨ne...</option>
                                    <option value="taxi" ${call?.transport === 'taxi' ? 'selected' : ''}>ðŸš• Taxi</option>
                                    <option value="public" ${call?.transport === 'public' ? 'selected' : ''}>ðŸš‡ Transports</option>
                                    <option value="with" ${call?.transport === 'with' ? 'selected' : ''}>ðŸš—âž¡ï¸ Part avec...</option>
                                </select>
                            </td>
                            <td>
                                <div id="call-withwho-crew-${member.id}" class="withwho-dropdown" style="display: ${call?.transport === 'own-brings' || call?.transport === 'with' ? 'block' : 'none'};">
                                    <button type="button" class="withwho-btn" onclick="app.Planning.toggleWithWhoDropdown('crew', '${member.id}')">
                                        <span class="withwho-label">-- Choisir --</span>
                                    </button>
                                    <div class="withwho-list" id="call-withwho-list-crew-${member.id}"></div>
                                </div>
                            </td>
                            <td><input type="text" id="call-notes-crew-${member.id}" value="${call?.notes || ''}" placeholder="Notes..." class="w-full"></td>
                        </tr>`;
                    });
                }
            });
            
            // Techniciens sans dÃ©partement
            const noGroupCrew = state.data.crew.filter(m => !m.group_id || !crewGroups.find(g => g.id === m.group_id));
            if(noGroupCrew.length > 0) {
                callsheetRows += `<tr class="bg-base"><td colspan="5" style="font-weight: bold; padding: 10px; color: var(--text-sec);">Non classÃ©</td></tr>`;
                noGroupCrew.forEach(member => {
                    const call = shootDay.callSheet.find(c => c.personId === member.id && c.type === 'crew');
                    callsheetRows += `<tr>
                        <td><input type="checkbox" id="call-crew-${member.id}" data-type="crew" data-id="${member.id}" ${call ? 'checked' : ''}></td>
                        <td>${Utils.escape(member.name)}</td>
                        <td>${Utils.escape(member.role || 'Technicien')}</td>
                        <td><input type="time" id="call-time-crew-${member.id}" value="${call ? call.callTime : ''}" style="width: 85px;"></td>
                        <td>
                            <select id="call-transport-crew-${member.id}" onchange="app.Planning.onTransportChange('crew', '${member.id}')" style="width: 100%; padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.85rem;">
                                <option value="" ${!call?.transport ? 'selected' : ''}>-- Transport --</option>
                                <option value="own" ${call?.transport === 'own' ? 'selected' : ''}>ðŸš— Propres moyens</option>
                                <option value="own-brings" ${call?.transport === 'own-brings' ? 'selected' : ''}>ðŸš—ðŸ‘¥ AmÃ¨ne...</option>
                                <option value="taxi" ${call?.transport === 'taxi' ? 'selected' : ''}>ðŸš• Taxi</option>
                                <option value="public" ${call?.transport === 'public' ? 'selected' : ''}>ðŸš‡ Transports</option>
                                <option value="with" ${call?.transport === 'with' ? 'selected' : ''}>ðŸš—âž¡ï¸ Part avec...</option>
                            </select>
                        </td>
                        <td>
                            <div id="call-withwho-crew-${member.id}" class="withwho-dropdown" style="display: ${call?.transport === 'own-brings' || call?.transport === 'with' ? 'block' : 'none'};">
                                <button type="button" class="withwho-btn" onclick="app.Planning.toggleWithWhoDropdown('crew', '${member.id}')">
                                    <span class="withwho-label">-- Choisir --</span>
                                </button>
                                <div class="withwho-list" id="call-withwho-list-crew-${member.id}"></div>
                            </div>
                        </td>
                        <td><input type="text" id="call-notes-crew-${member.id}" value="${call?.notes || ''}" placeholder="Notes..." class="w-full"></td>
                    </tr>`;
                });
            }
        }
        
        body.innerHTML = `
            <div class="shoot-section">
                <div class="shoot-section-title">ðŸ“… Type, Dates et Nom</div>
                <div class="shoot-time-grid">
                    <div class="shoot-time-item">
                        <label>Type de journÃ©e</label>
                        <select id="edit-dayType" class="n8-input-14">
                            <option value="tournage" ${(shootDay.dayType || 'tournage') === 'tournage' ? 'selected' : ''}>ðŸŽ¬ Tournage</option>
                            <option value="repetition" ${shootDay.dayType === 'repetition' ? 'selected' : ''}>ðŸŽ­ RÃ©pÃ©tition</option>
                            <option value="reperage" ${shootDay.dayType === 'reperage' ? 'selected' : ''}>ðŸ” RepÃ©rage</option>
                            <option value="essai-costume" ${shootDay.dayType === 'essai-costume' ? 'selected' : ''}>ðŸ‘— Essai costume</option>
                            <option value="essai-maquillage" ${shootDay.dayType === 'essai-maquillage' ? 'selected' : ''}>ðŸ’„ Essai maquillage</option>
                            <option value="formation" ${shootDay.dayType === 'formation' ? 'selected' : ''}>ðŸ“š Formation</option>
                            <option value="reunion" ${shootDay.dayType === 'reunion' ? 'selected' : ''}>ðŸ“‹ RÃ©union</option>
                            <option value="autre" ${shootDay.dayType === 'autre' ? 'selected' : ''}>ðŸ“Œ Autre</option>
                        </select>
                    </div>
                    <div class="shoot-time-item">
                        <label>Nom</label>
                        <input type="text" id="edit-name" value="${shootDay.name || ''}" placeholder="Ex: Sc.5 - Bureau (sera auto-gÃ©nÃ©rÃ© si vide)">
                    </div>
                </div>
                <div class="shoot-time-grid mt-10">
                    <div class="shoot-time-item">
                        <label>Date de dÃ©but</label>
                        <input type="date" id="edit-startDate" value="${shootDay.startDate || shootDay.date || ''}">
                    </div>
                    <div class="shoot-time-item">
                        <label>Date de fin</label>
                        <input type="date" id="edit-endDate" value="${shootDay.endDate || shootDay.startDate || shootDay.date || ''}">
                    </div>
                </div>
            </div>
            
            <div class="shoot-section" style="background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), rgba(var(--primary-rgb), 0.1)); border: 2px solid var(--primary); border-radius: 8px; padding: 15px;">
                <div class="shoot-section-title">ðŸŽ¬ ScÃ¨nes Ã  tourner (sÃ©lectionnez d'abord pour auto-remplir)</div>
                <div id="scenes-selection">${scenesSelectionHTML}</div>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">ðŸ“ LIEU</div>
                <div class="shoot-time-grid">
                    <div class="shoot-time-item">
                        <label>DÃ©cor (scÃ©nario)</label>
                        <select id="edit-location-select" onchange="app.Planning.onLocationSelect(this.value)" class="n8-input-14">
                            <option value="">-- SÃ©lectionner un dÃ©cor --</option>
                            ${state.data.locations.map(loc => `<option value="${Utils.escape(loc.name)}" ${shootDay.location === loc.name ? 'selected' : ''}>${Utils.escape(loc.name)}</option>`).join('')}
                            <option value="__custom__">âž• Autre...</option>
                        </select>
                    </div>
                    <div class="shoot-time-item">
                        <label>Lieu rÃ©el de tournage</label>
                        <input type="text" id="edit-location" value="${shootDay.locationRealName || ''}" placeholder="Ex: MusÃ©e d'Histoire Naturelle">
                    </div>
                    <div class="shoot-time-item" style="flex: 2;">
                        <label>Adresse</label>
                        <div class="address-autocomplete-container">
                            <input type="text" id="edit-locationAddress" value="${shootDay.locationAddress || ''}" placeholder="Tapez une adresse..." oninput="app.Planning.searchAddress(this.value)" autocomplete="off">
                            <div id="address-suggestions" class="address-suggestions"></div>
                        </div>
                        <input type="hidden" id="edit-locationLat" value="${shootDay.locationLat || ''}">
                        <input type="hidden" id="edit-locationLng" value="${shootDay.locationLng || ''}">
                        <div id="location-minimap" class="address-minimap" style="display: ${shootDay.locationLat ? 'block' : 'none'};"></div>
                    </div>
                </div>
                <div class="shoot-time-grid mt-15">
                    <div class="shoot-time-item">
                        <label>ðŸ‘¤ Contact sur place (nom)</label>
                        <input type="text" id="edit-contactName" value="${shootDay.contactName || ''}" placeholder="Ex: Jean Dupont">
                    </div>
                    <div class="shoot-time-item">
                        <label>ðŸ“ž TÃ©lÃ©phone contact</label>
                        <input type="tel" id="edit-contactPhone" value="${shootDay.contactPhone || ''}" placeholder="Ex: 06 12 34 56 78">
                    </div>
                </div>
                <div class="mt-10">
                    <label class="label-500">ðŸ“ Notes d'accÃ¨s / Infos pratiques</label>
                    <textarea id="edit-locationNotes" placeholder="Ex: Code porte 1234, parking gratuit derriÃ¨re le bÃ¢timent, sonner Ã  l'interphone..." class="n8-input-5">${shootDay.locationNotes || ''}</textarea>
                </div>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">â° Horaires</div>
                <div class="shoot-time-grid">
                    <div class="shoot-time-item">
                        <label>Convocation Ã©quipe</label>
                        <input type="time" id="edit-crewCall" value="${shootDay.crewCall || '07:00'}">
                    </div>
                    <div class="shoot-time-item">
                        <label>PrÃªt Ã  tourner</label>
                        <input type="time" id="edit-readyToShoot" value="${shootDay.readyToShoot || '08:30'}">
                    </div>
                    <div class="shoot-time-item">
                        <label>DÃ©but pause dÃ©jeuner</label>
                        <input type="time" id="edit-lunchStart" value="${shootDay.lunchStart || '13:00'}">
                    </div>
                    <div class="shoot-time-item">
                        <label>Fin pause dÃ©jeuner</label>
                        <input type="time" id="edit-lunchEnd" value="${shootDay.lunchEnd || '14:00'}">
                    </div>
                    <div class="shoot-time-item">
                        <label>Fin estimÃ©e</label>
                        <input type="time" id="edit-estimatedWrap" value="${shootDay.estimatedWrap || '19:00'}">
                    </div>
                </div>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">ðŸ“‹ Convocations</div>
                <table class="callsheet-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">âœ“</th>
                            <th>Nom</th>
                            <th>Fonction</th>
                            <th style="width: 90px;">Heure</th>
                            <th style="width: 160px;">Transport</th>
                            <th style="width: 150px;">Avec qui</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>${callsheetRows || '<tr><td colspan="5" style="text-align: center; color: var(--text-sec);">Aucun comÃ©dien ou technicien enregistrÃ©</td></tr>'}</tbody>
                </table>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">ðŸŒ¤ï¸ MÃ©tÃ©o personnalisÃ©e (optionnel)</div>
                <textarea id="edit-customWeather" placeholder="Ex: PrÃ©voir parapluies, tournage extÃ©rieur annulÃ© si pluie..." class="n8-input-5">${shootDay.customWeather || ''}</textarea>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">ðŸ“ Notes gÃ©nÃ©rales</div>
                <textarea id="edit-notes" placeholder="Notes pour l'Ã©quipe..." style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);">${shootDay.notes || ''}</textarea>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">ðŸ“¦ Besoins (DÃ©pouillement automatique)</div>
                <div id="auto-breakdown-needs" style="background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                    <em class="text-sec">SÃ©lectionnez des scÃ¨nes pour voir les besoins...</em>
                </div>
            </div>
            
            ${Planning.editingDayId !== 'new' ? `
            <div class="shoot-section" style="border-top: 2px solid var(--danger); padding-top: 15px; margin-top: 20px;">
                <button onclick="app.Planning.deleteShootDay('${shootDay.id}')" style="padding: 10px 20px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer;">ðŸ—‘ï¸ Supprimer ce jour de tournage</button>
            </div>
            ` : ''}
        `;
        
        modal.classList.add('active');
        
        // Auto-sÃ©lectionner les acteurs des scÃ¨nes dÃ©jÃ  prÃ©sentes
        setTimeout(() => {
            Planning.autoSelectActorsForScenes();
            
            // Initialiser les dropdowns "Avec qui" pour le transport
            Planning.initWithWhoDropdowns();
            
            // Afficher la mini-carte si des coordonnÃ©es existent
            if(shootDay.locationLat && shootDay.locationLng) {
                Planning.showMiniMap(shootDay.locationLat, shootDay.locationLng);
            }
            
            // Mettre Ã  jour les besoins du dÃ©pouillement
            Planning.updateBreakdownNeeds();
            
            // Auto-cocher les techniciens selon le dÃ©pouillement
            Planning.autoSelectCrewForBreakdown();
        }, 100);
    },
    
closeModal: () => {
        document.getElementById('planning-modal').classList.remove('active');
        Planning.editingDayId = null;
        Planning.tempShootDay = null;
    },
    
    // GÃ¨re le changement de transport pour afficher/masquer "Avec qui"
    onTransportChange: (type, personId) => {
        const transportSelect = document.getElementById(`call-transport-${type}-${personId}`);
        const withWhoDropdown = document.getElementById(`call-withwho-${type}-${personId}`);
        
        if(!transportSelect || !withWhoDropdown) return;
        
        const transport = transportSelect.value;
        
        if(transport === 'own-brings' || transport === 'with') {
            withWhoDropdown.style.display = 'block';
            Planning.populateWithWhoDropdown(type, personId, transport);
        } else {
            withWhoDropdown.style.display = 'none';
        }
    },
    
    // Ouvre/ferme le dropdown "Avec qui"
    toggleWithWhoDropdown: (type, personId) => {
        const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
        const btn = list?.previousElementSibling;
        
        // Fermer tous les autres dropdowns ouverts
        document.querySelectorAll('.withwho-list.open').forEach(el => {
            if(el.id !== `call-withwho-list-${type}-${personId}`) {
                el.classList.remove('open');
                el.previousElementSibling?.classList.remove('open');
            }
        });
        
        if(list) {
            list.classList.toggle('open');
            btn?.classList.toggle('open');
        }
    },
    
    // GÃ¨re le clic sur une option du dropdown
    onWithWhoItemClick: (type, personId, value, checkbox) => {
        const transportSelect = document.getElementById(`call-transport-${type}-${personId}`);
        const transport = transportSelect?.value;
        
        // Si "Part avec" â†’ sÃ©lection unique (dÃ©cocher les autres)
        if(transport === 'with') {
            const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
            list?.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                if(cb !== checkbox) cb.checked = false;
            });
        }
        
        Planning.updateWithWhoLabel(type, personId);
        
        // Synchronisation bidirectionnelle du transport
        if(checkbox.checked) {
            Planning.syncTransport(type, personId, value, transport);
        } else {
            Planning.unsyncTransport(type, personId, value);
        }
    },
    
    // Met Ã  jour le label du bouton dropdown
    // Synchronise le transport : si A amÃ¨ne B, B passe en "Part avec A"
    syncTransport: (driverType, driverId, passengerId, transport) => {
        // Extraire le type et l'ID du passager (format: "actor_act_xxx" ou "crew_crew_xxx")
        const firstUnderscore = passengerId.indexOf('_');
        if(firstUnderscore === -1) return;
        const passengerType = passengerId.substring(0, firstUnderscore);
        const passId = passengerId.substring(firstUnderscore + 1);
        if(!passengerType || !passId) return;
        
        // Si le conducteur "amÃ¨ne" quelqu'un
        if(transport === 'own-brings') {
            // Cocher la checkbox du passager s'il ne l'est pas dÃ©jÃ 
            const passengerCheckbox = document.querySelector(`input[data-type="${passengerType}"][data-id="${passId}"]`);
            if(passengerCheckbox && !passengerCheckbox.checked) {
                passengerCheckbox.checked = true;
            }
            
            // Mettre le passager en "Part avec..."
            const passengerTransport = document.getElementById(`call-transport-${passengerType}-${passId}`);
            if(passengerTransport && passengerTransport.value !== 'with') {
                passengerTransport.value = 'with';
                Planning.onTransportChange(passengerType, passId);
            }
            
            // Cocher le conducteur dans la liste "avec qui" du passager
            setTimeout(() => {
                const passengerWithWhoList = document.getElementById(`call-withwho-list-${passengerType}-${passId}`);
                if(passengerWithWhoList) {
                    const driverCheckbox = passengerWithWhoList.querySelector(`input[value="${driverType}_${driverId}"]`);
                    if(driverCheckbox && !driverCheckbox.checked) {
                        driverCheckbox.checked = true;
                        Planning.updateWithWhoLabel(passengerType, passId);
                    }
                }
            }, 50);
        }
        
        // Si le passager "part avec" quelqu'un (synchronisation inverse)
        if(transport === 'with') {
            const driverTransport = document.getElementById(`call-transport-${passengerType}-${passId}`);
            // VÃ©rifier si le conducteur n'est pas dÃ©jÃ  en mode "amÃ¨ne"
            if(driverTransport && driverTransport.value !== 'own-brings') {
                // Le mettre en "AmÃ¨ne..."
                driverTransport.value = 'own-brings';
                Planning.onTransportChange(passengerType, passId);
            }
            
            // Cocher le passager actuel dans la liste du conducteur
            setTimeout(() => {
                const driverWithWhoList = document.getElementById(`call-withwho-list-${passengerType}-${passId}`);
                if(driverWithWhoList) {
                    const currentPersonCheckbox = driverWithWhoList.querySelector(`input[value="${driverType}_${driverId}"]`);
                    if(currentPersonCheckbox && !currentPersonCheckbox.checked) {
                        currentPersonCheckbox.checked = true;
                        Planning.updateWithWhoLabel(passengerType, passId);
                    }
                }
            }, 50);
        }
    },
    
    // DÃ©synchronise quand on dÃ©coche quelqu'un
    unsyncTransport: (type, personId, otherId) => {
        const firstUnderscore = otherId.indexOf('_');
        if(firstUnderscore === -1) return;
        const otherType = otherId.substring(0, firstUnderscore);
        const otherPersonId = otherId.substring(firstUnderscore + 1);
        if(!otherType || !otherPersonId) return;
        
        // DÃ©cocher la personne actuelle dans la liste de l'autre
        const otherWithWhoList = document.getElementById(`call-withwho-list-${otherType}-${otherPersonId}`);
        if(otherWithWhoList) {
            const checkbox = otherWithWhoList.querySelector(`input[value="${type}_${personId}"]`);
            if(checkbox && checkbox.checked) {
                checkbox.checked = false;
                Planning.updateWithWhoLabel(otherType, otherPersonId);
            }
        }
        
        // Si l'autre n'a plus personne dans sa liste, remettre son transport Ã  vide
        setTimeout(() => {
            const otherList = document.getElementById(`call-withwho-list-${otherType}-${otherPersonId}`);
            if(otherList) {
                const stillChecked = otherList.querySelectorAll('input[type="checkbox"]:checked').length;
                if(stillChecked === 0) {
                    const otherTransport = document.getElementById(`call-transport-${otherType}-${otherPersonId}`);
                    if(otherTransport && (otherTransport.value === 'with' || otherTransport.value === 'own-brings')) {
                        otherTransport.value = '';
                        Planning.onTransportChange(otherType, otherPersonId);
                    }
                }
            }
        }, 100);
    },
    
    updateWithWhoLabel: (type, personId) => {
        const dropdown = document.getElementById(`call-withwho-${type}-${personId}`);
        const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
        const label = dropdown?.querySelector('.withwho-label');
        
        if(!list || !label) return;
        
        const checked = list.querySelectorAll('input[type="checkbox"]:checked');
        
        if(checked.length === 0) {
            label.textContent = '-- Choisir --';
        } else if(checked.length === 1) {
            label.textContent = checked[0].nextElementSibling.textContent;
        } else {
            label.textContent = `${checked.length} personnes`;
        }
    },
    
    // Remplit le dropdown "Avec qui" avec les personnes du projet
    populateWithWhoDropdown: (type, personId, transport) => {getElementById(`call-withwho-${type}-${personId}`);
        const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
        const label = dropdown?.querySelector('.withwho-label');
        
        if(!list || !label) return;
        
        const checked = list.querySelectorAll('input[type="checkbox"]:checked');
        
        if(checked.length === 0) {
            label.textContent = '-- Choisir --';
        } else if(checked.length === 1) {
            label.textContent = checked[0].nextElementSibling.textContent;
        } else {
            label.textContent = `${checked.length} personnes`;
        }
    },
    
    // Remplit le dropdown "Avec qui" avec les personnes du projet
    populateWithWhoDropdown: (type, personId, transport) => {
        const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
        if(!list) return;
        
        // RÃ©cupÃ©rer les donnÃ©es sauvegardÃ©es
        const shootDay = Planning.tempShootDay || {};
        const call = shootDay.callSheet?.find(c => c.personId === personId && c.type === type);
        const savedWithWho = call?.withWho || [];
        
        let html = '';
        
        // Ajouter les comÃ©diens
        (state.data.actors || []).forEach(actor => {
            if(type === 'actor' && actor.id === personId) return; // Exclure soi-mÃªme
            const checked = savedWithWho.includes(`actor_${actor.id}`) ? 'checked' : '';
            html += `<div class="withwho-item ${checked ? 'selected' : ''}">
                <input type="checkbox" id="withwho-actor-${actor.id}-for-${type}-${personId}" value="actor_${actor.id}" ${checked} onchange="app.Planning.onWithWhoItemClick('${type}', '${personId}', 'actor_${actor.id}', this)">
                <label for="withwho-actor-${actor.id}-for-${type}-${personId}">ðŸŽ­ ${Utils.escape(actor.name)}</label>
            </div>`;
        });
        
        // Ajouter les techniciens
        (state.data.crew || []).forEach(member => {
            if(type === 'crew' && member.id === personId) return; // Exclure soi-mÃªme
            const checked = savedWithWho.includes(`crew_${member.id}`) ? 'checked' : '';
            html += `<div class="withwho-item ${checked ? 'selected' : ''}">
                <input type="checkbox" id="withwho-crew-${member.id}-for-${type}-${personId}" value="crew_${member.id}" ${checked} onchange="app.Planning.onWithWhoItemClick('${type}', '${personId}', 'crew_${member.id}', this)">
                <label for="withwho-crew-${member.id}-for-${type}-${personId}">ðŸŽ¬ ${Utils.escape(member.name)}</label>
            </div>`;
        });
        
        list.innerHTML = html || '<div class="withwho-item text-sec">Aucune personne disponible</div>';
        
        // Mettre Ã  jour le label
        Planning.updateWithWhoLabel(type, personId);
    },
    
    // Initialise tous les dropdowns "Avec qui" aprÃ¨s le rendu du formulaire
    initWithWhoDropdowns: () => {
        const shootDay = Planning.tempShootDay || {};
        
        // Pour chaque personne dans la callSheet
        (shootDay.callSheet || []).forEach(call => {
            if(call.transport === 'own-brings' || call.transport === 'with') {
                Planning.populateWithWhoDropdown(call.type, call.personId, call.transport);
            }
        });
        
        // Fermer les dropdowns quand on clique ailleurs
        document.addEventListener('click', Planning.closeAllWithWhoDropdowns);
    },
    
    // Ferme tous les dropdowns si on clique en dehors
    closeAllWithWhoDropdowns: (e) => {
        if(!e.target.closest('.withwho-dropdown')) {
            document.querySelectorAll('.withwho-list.open').forEach(el => {
                el.classList.remove('open');
                el.previousElementSibling?.classList.remove('open');
            });
        }
    },
    
    notifyCallSheet: async (shootDay) => {
        if(!shootDay.callSheet || shootDay.callSheet.length === 0) return;
        
        const projectName = state.data.title || 'Projet';
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'La production';
        
        for(const call of shootDay.callSheet) {
            let person = null;
            let personType = '';
            
            if(call.type === 'actor') {
                person = state.data.actors.find(a => a.id === call.personId);
                personType = 'comÃ©dienÂ·ne';
            } else if(call.type === 'crew') {
                person = state.data.crew.find(c => c.id === call.personId);
                personType = 'technicienÂ·ne';
            }
            
            if(person && person.email) {
                const subject = `ðŸŽ¬ Convocation J${shootDay.dayNumber} - ${projectName}`;
                const content = `Bonjour ${person.name || ''},

Vous Ãªtes convoquÃ©Â·e pour le tournage de "${projectName}" :

ðŸ“… Date : ${dateFormatted}
ðŸ“ Lieu : ${shootDay.location || 'Ã€ confirmer'}${shootDay.locationAddress ? '\nðŸ“Œ Adresse : ' + shootDay.locationAddress : ''}
â° Convocation : ${call.callTime || shootDay.crewCall || 'Ã€ confirmer'}
ðŸŽ¬ PrÃªt Ã  tourner : ${shootDay.readyToShoot || 'Ã€ confirmer'}
${call.notes ? '\nðŸ“ Notes : ' + call.notes : ''}
${shootDay.notes ? '\nðŸ“‹ Notes gÃ©nÃ©rales : ' + shootDay.notes : ''}

Merci de confirmer votre prÃ©sence.

${senderName}
${projectName}`;

                try {
                    // Envoyer message interne
                    await Messages.send(person.email, {
                        subject: subject,
                        content: content,
                        type: 'callsheet',
                        projectId: state.currentProjectId,
                        projectName: projectName,
                        shootDayId: shootDay.id,
                        date: shootDay.date
                    });
                    
                    // Envoyer email
                    await Messages.sendEmailPing(person.email, person.name, 'callsheet', {
                        projectName: projectName,
                        shootDate: dateFormatted,
                        location: shootDay.location || 'Ã€ confirmer',
                        callTime: call.callTime || shootDay.crewCall || 'Ã€ confirmer'
                    });
                } catch(e) {
                    console.warn(`Erreur notification ${person.name}:`, e);
                }
            }
        }
    },
    
    syncShootingDatesToProfiles: () => {
        // Collecter tous les jours de tournage avec leurs callsheets
        const shootingDays = state.data.shootingDays || [];
        const projectName = state.data.title || 'Projet';
        const projectId = state.currentProjectId;
        
        // RÃ©initialiser les shootingDates de tous les acteurs et techniciens pour ce projet
        (state.data.actors || []).forEach(actor => {
            if(!actor.shootingDates) actor.shootingDates = [];
            actor.shootingDates = actor.shootingDates.filter(sd => sd.projectId !== projectId);
        });
        (state.data.crew || []).forEach(member => {
            if(!member.shootingDates) member.shootingDates = [];
            member.shootingDates = member.shootingDates.filter(sd => sd.projectId !== projectId);
        });
        
        // Ajouter les nouvelles dates de tournage
        shootingDays.forEach(day => {
            if(!day.callSheet || !day.date) return;
            
            day.callSheet.forEach(call => {
                if(call.type === 'actor') {
                    const actor = state.data.actors.find(a => a.id === call.personId);
                    if(actor) {
                        if(!actor.shootingDates) actor.shootingDates = [];
                        actor.shootingDates.push({
                            date: day.date,
                            projectId: projectId,
                            projectName: projectName,
                            dayNumber: day.dayNumber,
                            callTime: call.callTime,
                            location: day.location
                        });
                    }
                } else if(call.type === 'crew') {
                    const member = state.data.crew.find(c => c.id === call.personId);
                    if(member) {
                        if(!member.shootingDates) member.shootingDates = [];
                        member.shootingDates.push({
                            date: day.date,
                            projectId: projectId,
                            projectName: projectName,
                            dayNumber: day.dayNumber,
                            callTime: call.callTime,
                            location: day.location
                        });
                    }
                }
            });
        });
        
        // Synchroniser vers les profils publics sur Firebase
        Planning.syncShootingDatesToPublicProfiles();
    },
    
    // Pousse les dates de tournage vers les profils publics (Supabase)
    syncShootingDatesToPublicProfiles: async () => {
        // Les dates de tournage sont maintenant stockÃ©es dans le projet lui-mÃªme
        // La synchronisation vers les profils publics se fera via le champ availability du user_profiles
        console.log('âœ… Dates de tournage sauvegardÃ©es dans le projet');
    },
    
    saveShootDay: () => {
        if(state.currentRole === 'viewer') return;
        
        const startDate = document.getElementById('edit-startDate').value;
        const endDate = document.getElementById('edit-endDate').value || startDate;
        
        // GÃ©nÃ©rer le nom automatiquement si vide
        let name = document.getElementById('edit-name').value.trim();
        if(!name && Planning.tempShootDay && Planning.tempShootDay.scenes && Planning.tempShootDay.scenes.length > 0 && state.data.scenes) {
            const sceneInfos = Planning.tempShootDay.scenes.map(ref => {
                const sceneIndex = state.data.scenes.findIndex(s => s.id === ref.sceneId);
                const selectedShots = ref.selectedShots || [];
                const shotCount = selectedShots.length;
                return sceneIndex >= 0 ? { num: sceneIndex + 1, shots: shotCount } : null;
            }).filter(Boolean);
            
            if(sceneInfos.length === 1) {
                // Une seule scÃ¨ne : Sc.3 (5 pl.)
                const info = sceneInfos[0];
                name = `Sc.${info.num}` + (info.shots > 0 ? ` (${info.shots} pl.)` : '');
            } else if(sceneInfos.length > 1) {
                // Plusieurs scÃ¨nes : Sc.3(3pl);5(5pl)
                name = 'Sc.' + sceneInfos.map(info => 
                    info.shots > 0 ? `${info.num}(${info.shots}pl)` : `${info.num}`
                ).join(';');
            }
        }
        if(!name) {
            name = `Tournage ${startDate}`;
        }
        
        const shootDay = {
            id: Planning.editingDayId === 'new' ? Utils.generateUniqueId() : Planning.editingDayId,
            dayType: document.getElementById('edit-dayType').value || 'tournage',
            startDate: startDate,
            endDate: endDate,
            name: name,
            location: document.getElementById('edit-location').value,
            locationRealName: document.getElementById('edit-location').value,
            locationAddress: document.getElementById('edit-locationAddress').value,
            locationLat: document.getElementById('edit-locationLat').value || null,
            locationLng: document.getElementById('edit-locationLng').value || null,
            contactName: document.getElementById('edit-contactName').value,
            contactPhone: document.getElementById('edit-contactPhone').value,
            locationNotes: document.getElementById('edit-locationNotes').value,
            crewCall: document.getElementById('edit-crewCall').value,
            readyToShoot: document.getElementById('edit-readyToShoot').value,
            lunchStart: document.getElementById('edit-lunchStart').value,
            lunchEnd: document.getElementById('edit-lunchEnd').value,
            estimatedWrap: document.getElementById('edit-estimatedWrap').value,
            scenes: [],
            callSheet: [],
            notes: document.getElementById('edit-notes').value,
            customWeather: document.getElementById('edit-customWeather').value
        };
        
        // Collect scenes from tempShootDay
        if(Planning.tempShootDay && Planning.tempShootDay.scenes) {
            Planning.tempShootDay.scenes.forEach(ref => {
                const timeInput = document.getElementById(`scene-time-${ref.sceneId}`);
                shootDay.scenes.push({ 
                    sceneId: ref.sceneId, 
                    startTime: timeInput ? timeInput.value : ref.startTime,
                    selectedShots: ref.selectedShots || []
                });
            });
        }
        
        // Collect callsheet
        document.querySelectorAll('.callsheet-table input[type="checkbox"]:checked').forEach(cb => {
            const type = cb.dataset.type;
            const personId = cb.dataset.id;
            
            // VÃ©rifier que les Ã©lÃ©ments existent avant d'accÃ©der Ã  leur valeur
            const callTimeEl = document.getElementById(`call-time-${type}-${personId}`);
            const notesEl = document.getElementById(`call-notes-${type}-${personId}`);
            const transportEl = document.getElementById(`call-transport-${type}-${personId}`);
            
            // Si les Ã©lÃ©ments n'existent pas, ignorer cette entrÃ©e
            if(!callTimeEl || !notesEl || !transportEl) return;
            
            const callTime = callTimeEl.value;
            const notes = notesEl.value;
            const transport = transportEl.value;
            
            // RÃ©cupÃ©rer les personnes sÃ©lectionnÃ©es dans "Avec qui" (nouveau dropdown avec checkboxes)
            let withWho = [];
            if(transport === 'own-brings' || transport === 'with') {
                const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
                if(list) {
                    list.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                        withWho.push(checkbox.value);
                    });
                }
            }
            
            shootDay.callSheet.push({ type, personId, callTime, notes, transport, withWho });
        });
        
        // Save
        if(Planning.editingDayId === 'new') {
            if(!state.data.shootingDays) state.data.shootingDays = [];
            state.data.shootingDays.push(shootDay);
        } else {
            const idx = state.data.shootingDays.findIndex(sd => sd.id === shootDay.id);
            if(idx > -1) {
                state.data.shootingDays[idx] = shootDay;
            }
        }
        
        // Log historique
        const isNew = Planning.editingDayId === 'new';
        History.log(isNew ? 'ADD' : 'EDIT', `${isNew ? 'Ajout' : 'Modification'} tournage "${shootDay.name}" (${shootDay.startDate}${shootDay.endDate !== shootDay.startDate ? ' â†’ ' + shootDay.endDate : ''})`);
        
        // Synchroniser les calendriers des profils
        Planning.syncShootingDatesToProfiles();
        
        Store.save();
        Planning.closeModal();
        Planning.render();
        
        Utils.toast('Jour de tournage sauvegardÃ© !', 'success');
    },
    
    deleteShootDay: async (dayId) => {
        if(!await ConfirmModal.confirmDelete("Ce jour de tournage sera supprimÃ©.")) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        History.log('DELETE', `Suppression jour de tournage #${shootDay?.dayNumber || '?'} (${shootDay?.date || '?'})`);
        state.data.shootingDays = state.data.shootingDays.filter(sd => sd.id !== dayId);
        
        // Synchroniser les calendriers des profils
        Planning.syncShootingDatesToProfiles();
        
        Store.save();
        Planning.closeModal();
        Planning.render();
    },
    
    deleteShootDayFromList: async (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!await ConfirmModal.confirmDelete(`Le tournage "${shootDay?.name || 'Tournage'}" (${shootDay?.startDate || shootDay?.date || '?'}) sera supprimÃ©.`)) return;
        
        History.log('DELETE', `Suppression tournage "${shootDay?.name || '?'}" (${shootDay?.startDate || shootDay?.date || '?'})`);
        state.data.shootingDays = state.data.shootingDays.filter(sd => sd.id !== dayId);
        
        // Synchroniser les calendriers des profils
        Planning.syncShootingDatesToProfiles();
        
        Store.save();
        Planning.openCallSheets(); // RafraÃ®chir la liste
        Planning.render();
        Utils.toast('Jour de tournage supprimÃ©', 'success');
    },
    
    showDayContextMenu: (event, dayId) => {
        // Supprimer un ancien menu s'il existe
        const oldMenu = document.getElementById('planning-context-menu');
        if(oldMenu) oldMenu.remove();
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        const menu = document.createElement('div');
        menu.id = 'planning-context-menu';
        let menuTop = event.clientY;
        let menuLeft = event.clientX;
        if(menuLeft + 200 > window.innerWidth) menuLeft = window.innerWidth - 210;
        if(menuTop + 180 > window.innerHeight) menuTop = window.innerHeight - 190;
        if(menuLeft < 10) menuLeft = 10;
        if(menuTop < 10) menuTop = 10;
        menu.style.cssText = `
            position: fixed;
            top: ${menuTop}px;
            left: ${menuLeft}px;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 99999;
            min-width: 180px;
            overflow: hidden;
        `;
        
        menu.innerHTML = `
            <div style="padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-sec); font-size: 0.85rem;">
                ðŸ“… ${Utils.escape(shootDay.name || 'Tournage').substring(0, 20)} - ${new Date(shootDay.startDate || shootDay.date).toLocaleDateString('fr-FR')}
            </div>
            <div class="context-menu-item" onclick="event.stopPropagation(); app.Planning.hideContextMenu(); app.Planning.editShootDay('${dayId}');" style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                <span>âœï¸</span> Modifier
            </div>
            <div class="context-menu-item" onclick="event.stopPropagation(); app.Planning.hideContextMenu(); app.Planning.duplicateShootDay('${dayId}');" style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                <span>ðŸ“‹</span> Dupliquer
            </div>
            <div class="context-menu-item" onclick="event.stopPropagation(); app.Planning.hideContextMenu(); app.Planning.deleteShootDayFromCalendar('${dayId}');" style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--danger);">
                <span>ðŸ—‘ï¸</span> Supprimer
            </div>
        `;
        
        document.body.appendChild(menu);
        
        // Fermer le menu en cliquant ailleurs
        setTimeout(() => {
            document.addEventListener('click', Planning.hideContextMenu, { once: true });
        }, 10);
    },
    
    hideContextMenu: () => {
        const menu = document.getElementById('planning-context-menu');
        if(menu) menu.remove();
    },
    
    deleteShootDayFromCalendar: async (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!await ConfirmModal.confirmDelete(`Le tournage "${shootDay?.name || 'Tournage'}" (${shootDay?.startDate || shootDay?.date || '?'}) sera supprimÃ©.`)) return;
        
        History.log('DELETE', `Suppression tournage "${shootDay?.name || '?'}" (${shootDay?.startDate || shootDay?.date || '?'})`);
        state.data.shootingDays = state.data.shootingDays.filter(sd => sd.id !== dayId);
        
        Planning.syncShootingDatesToProfiles();
        Store.save();
        Planning.render();
        Utils.toast('Jour de tournage supprimÃ©', 'success');
    },
    
    duplicateShootDay: (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        const newDay = JSON.parse(JSON.stringify(shootDay));
        newDay.id = Utils.generateUniqueId();
        newDay.dayNumber = (state.data.shootingDays.length || 0) + 1;
        newDay.date = ''; // Ã€ dÃ©finir
        newDay.validated = false;
        
        state.data.shootingDays.push(newDay);
        Store.save();
        
        // Ouvrir la modale pour dÃ©finir la nouvelle date
        Planning.editShootDay(newDay.id);
        Utils.toast('Jour dupliquÃ© - DÃ©finissez la nouvelle date', 'info');
    },
    
    draggedDayId: null,
    
    onDragStart: (event, dayId) => {
        Planning.draggedDayId = dayId;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', dayId);
        event.target.style.opacity = '0.5';
    },
    
    onDragOver: (event) => {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        event.currentTarget.style.background = 'rgba(43, 110, 246, 0.2)';
    },
    
    onDrop: async (event, targetDate) => {
        event.preventDefault();
        event.currentTarget.style.background = '';
        
        if(!Planning.draggedDayId) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.draggedDayId);
        if(!shootDay) return;
        
        // Calculer la durÃ©e du tournage
        const oldStartDate = shootDay.startDate || shootDay.date;
        const oldEndDate = shootDay.endDate || oldStartDate;
        const startDateObj = new Date(oldStartDate);
        const endDateObj = new Date(oldEndDate);
        const duration = Math.round((endDateObj - startDateObj) / (1000 * 60 * 60 * 24));
        
        // Calculer les nouvelles dates
        const newStartDate = targetDate;
        const newStartDateObj = new Date(newStartDate);
        const newEndDateObj = new Date(newStartDateObj);
        newEndDateObj.setDate(newEndDateObj.getDate() + duration);
        const newEndDate = Planning.formatDate(newEndDateObj);
        
        // VÃ©rifier si un jour existe dÃ©jÃ  Ã  cette date
        const existingDay = state.data.shootingDays.find(sd => {
            if(sd.id === Planning.draggedDayId) return false;
            const start = sd.startDate || sd.date;
            const end = sd.endDate || start;
            return (newStartDate >= start && newStartDate <= end) || (newEndDate >= start && newEndDate <= end);
        });
        
        if(existingDay) {
            if(!await ConfirmModal.show({ title: 'Jour existant', message: 'Un jour de tournage existe dÃ©jÃ  sur cette pÃ©riode.\n\nVoulez-vous continuer ?', icon: 'ðŸ“…', confirmText: 'Continuer' })) {
                Planning.draggedDayId = null;
                Planning.render();
                return;
            }
        }
        
        shootDay.startDate = newStartDate;
        shootDay.endDate = newEndDate;
        // Supprimer l'ancien format si prÃ©sent
        delete shootDay.date;
        
        History.log('EDIT', `DÃ©placement tournage "${shootDay.name}" : ${oldStartDate} â†’ ${newStartDate}`);
        Planning.syncShootingDatesToProfiles();
        Store.save();
        Planning.render();
        Utils.toast('Tournage dÃ©placÃ©', 'success');
        
        Planning.draggedDayId = null;
    },
    
    onDragOverWeek: (event, hour) => {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        event.currentTarget.style.background = 'rgba(43, 110, 246, 0.3)';
    },
    
    onDragLeave: (event) => {
        event.currentTarget.style.background = '';
    },
    
    onDropWeek: async (event, targetDate, hour) => {
        event.preventDefault();
        event.currentTarget.style.background = '';
        
        if(!Planning.draggedDayId) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.draggedDayId);
        if(!shootDay) return;
        
        // Calculer la durÃ©e en jours
        const oldStartDate = shootDay.startDate || shootDay.date;
        const oldEndDate = shootDay.endDate || oldStartDate;
        const startDateObj = new Date(oldStartDate);
        const endDateObj = new Date(oldEndDate);
        const durationDays = Math.round((endDateObj - startDateObj) / (1000 * 60 * 60 * 24));
        
        // Calculer la durÃ©e en heures
        const oldStartHour = shootDay.crewCall ? parseInt(shootDay.crewCall.split(':')[0]) : 7;
        const oldEndHour = shootDay.estimatedWrap ? parseInt(shootDay.estimatedWrap.split(':')[0]) : 19;
        const durationHours = oldEndHour - oldStartHour;
        
        // Nouvelles dates
        const newStartDate = targetDate;
        const newStartDateObj = new Date(newStartDate);
        const newEndDateObj = new Date(newStartDateObj);
        newEndDateObj.setDate(newEndDateObj.getDate() + durationDays);
        const newEndDate = Planning.formatDate(newEndDateObj);
        
        // Nouvelle heure de dÃ©but et fin
        const newStartHour = hour;
        const newEndHour = Math.min(hour + durationHours, 22);
        
        // VÃ©rifier si un jour existe dÃ©jÃ  Ã  cette date
        const existingDay = state.data.shootingDays.find(sd => {
            if(sd.id === Planning.draggedDayId) return false;
            const start = sd.startDate || sd.date;
            const end = sd.endDate || start;
            return (newStartDate >= start && newStartDate <= end) || (newEndDate >= start && newEndDate <= end);
        });
        
        if(existingDay) {
            if(!await ConfirmModal.show({ title: 'Tournage existant', message: 'Un tournage existe dÃ©jÃ  sur cette pÃ©riode.\n\nVoulez-vous continuer ?', icon: 'ðŸ“…', confirmText: 'Continuer' })) {
                Planning.draggedDayId = null;
                Planning.render();
                return;
            }
        }
        
        shootDay.startDate = newStartDate;
        shootDay.endDate = newEndDate;
        delete shootDay.date;
        shootDay.crewCall = String(newStartHour).padStart(2, '0') + ':00';
        shootDay.estimatedWrap = String(newEndHour).padStart(2, '0') + ':00';
        
        // Mettre Ã  jour readyToShoot (30 min aprÃ¨s crewCall)
        shootDay.readyToShoot = String(newStartHour).padStart(2, '0') + ':30';
        
        History.log('EDIT', `DÃ©placement tournage "${shootDay.name}" : ${oldStartDate} â†’ ${newStartDate} (${shootDay.crewCall} - ${shootDay.estimatedWrap})`);
        Planning.syncShootingDatesToProfiles();
        Store.save();
        Planning.render();
        Utils.toast(`Tournage dÃ©placÃ© au ${newStartDate} (${shootDay.crewCall} - ${shootDay.estimatedWrap})`, 'success');
        
        Planning.draggedDayId = null;
    },
    
    // Resize des Ã©vÃ©nements
    resizingDayId: null,
    resizeDirection: null,
    resizeStartY: 0,
    resizeStartHour: 0,
    
    startResize: (event, dayId, direction) => {
        event.preventDefault();
        event.stopPropagation();
        
        Planning.resizingDayId = dayId;
        Planning.resizeDirection = direction;
        Planning.resizeStartY = event.clientY;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(shootDay) {
            if(direction === 'top') {
                Planning.resizeStartHour = shootDay.crewCall ? parseInt(shootDay.crewCall.split(':')[0]) : 7;
            } else {
                Planning.resizeStartHour = shootDay.estimatedWrap ? parseInt(shootDay.estimatedWrap.split(':')[0]) : 19;
            }
        }
        
        document.addEventListener('mousemove', Planning.onResizeMove);
        document.addEventListener('mouseup', Planning.onResizeEnd);
    },
    
    onResizeMove: (event) => {
        if(!Planning.resizingDayId) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.resizingDayId);
        if(!shootDay) return;
        
        // Calculer le delta en heures (30px = 1 heure approximativement)
        const deltaY = event.clientY - Planning.resizeStartY;
        const deltaHours = Math.round(deltaY / 30);
        
        let newHour = Planning.resizeStartHour + deltaHours;
        newHour = Math.max(6, Math.min(22, newHour));
        
        if(Planning.resizeDirection === 'top') {
            const endHour = shootDay.estimatedWrap ? parseInt(shootDay.estimatedWrap.split(':')[0]) : 19;
            if(newHour < endHour) {
                shootDay.crewCall = String(newHour).padStart(2, '0') + ':00';
                shootDay.readyToShoot = String(newHour).padStart(2, '0') + ':30';
            }
        } else {
            const startHour = shootDay.crewCall ? parseInt(shootDay.crewCall.split(':')[0]) : 7;
            if(newHour > startHour) {
                shootDay.estimatedWrap = String(newHour).padStart(2, '0') + ':00';
            }
        }
        
        Planning.render();
    },
    
    onResizeEnd: () => {
        if(Planning.resizingDayId) {
            const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.resizingDayId);
            if(shootDay) {
                History.log('EDIT', `Modification horaires jour #${shootDay.dayNumber} : ${shootDay.crewCall} - ${shootDay.estimatedWrap}`);
                Planning.syncShootingDatesToProfiles();
                Store.save();
                Utils.toast(`Horaires modifiÃ©s : ${shootDay.crewCall} - ${shootDay.estimatedWrap}`, 'success');
            }
        }
        
        Planning.resizingDayId = null;
        Planning.resizeDirection = null;
        document.removeEventListener('mousemove', Planning.onResizeMove);
        document.removeEventListener('mouseup', Planning.onResizeEnd);
    },
    
    // Resize horizontal (Ã©tendre sur plusieurs jours)
    resizeHorizontalDayId: null,
    resizeHorizontalStartX: 0,
    resizeHorizontalDirection: null,
    resizeHorizontalOriginalStartDate: null,
    resizeHorizontalOriginalEndDate: null,
    
    startResizeHorizontal: (event, dayId, direction) => {
        event.preventDefault();
        event.stopPropagation();
        
        Planning.resizeHorizontalDayId = dayId;
        Planning.resizeHorizontalStartX = event.clientX;
        Planning.resizeHorizontalDirection = direction;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(shootDay) {
            Planning.resizeHorizontalOriginalStartDate = shootDay.startDate || shootDay.date;
            Planning.resizeHorizontalOriginalEndDate = shootDay.endDate || shootDay.startDate || shootDay.date;
        }
        
        document.addEventListener('mousemove', Planning.onResizeHorizontalMove);
        document.addEventListener('mouseup', Planning.onResizeHorizontalEnd);
    },
    
    onResizeHorizontalMove: (event) => {
        if(!Planning.resizeHorizontalDayId) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.resizeHorizontalDayId);
        if(!shootDay) return;
        
        // Trouver la cellule sous le curseur
        const elementUnderCursor = document.elementFromPoint(event.clientX, event.clientY);
        const dayCell = elementUnderCursor?.closest('.planning-day, .planning-week-cell');
        
        if(dayCell) {
            const targetDate = dayCell.dataset?.date || dayCell.getAttribute('onclick')?.match(/'(\d{4}-\d{2}-\d{2})'/)?.[1];
            
            if(targetDate) {
                const startDate = new Date(shootDay.startDate || shootDay.date);
                const targetDateObj = new Date(targetDate);
                
                if(Planning.resizeHorizontalDirection === 'right') {
                    // Ne pas permettre endDate < startDate
                    if(targetDateObj >= startDate) {
                        if(shootDay.endDate !== targetDate) {
                            shootDay.endDate = targetDate;
                            Planning.render();
                        }
                    }
                } else if(Planning.resizeHorizontalDirection === 'left') {
                    const endDate = new Date(shootDay.endDate || shootDay.startDate || shootDay.date);
                    // Ne pas permettre startDate > endDate
                    if(targetDateObj <= endDate) {
                        if(shootDay.startDate !== targetDate) {
                            shootDay.startDate = targetDate;
                            Planning.render();
                        }
                    }
                }
            }
        }
    },
    
    onResizeHorizontalEnd: () => {
        if(Planning.resizeHorizontalDayId) {
            const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.resizeHorizontalDayId);
            if(shootDay) {
                const startDate = shootDay.startDate || shootDay.date;
                const endDate = shootDay.endDate || startDate;
                
                History.log('EDIT', `Modification durÃ©e tournage "${shootDay.name || 'Sans nom'}" : ${startDate} â†’ ${endDate}`);
                Planning.syncShootingDatesToProfiles();
                Store.save();
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                Utils.toast(`Tournage Ã©tendu sur ${days} jour(s)`, 'success');
            }
        }
        
        Planning.resizeHorizontalDayId = null;
        Planning.resizeHorizontalDirection = null;
        document.removeEventListener('mousemove', Planning.onResizeHorizontalMove);
        document.removeEventListener('mouseup', Planning.onResizeHorizontalEnd);
    },
    
    // AutocomplÃ©tion d'adresse via Nominatim (OpenStreetMap)
    addressSearchTimeout: null,
    searchAddress: (query) => {
        clearTimeout(Planning.addressSearchTimeout);
        const suggestions = document.getElementById('address-suggestions');
        
        if(!query || query.length < 3) {
            suggestions.classList.remove('visible');
            return;
        }
        
        Planning.addressSearchTimeout = setTimeout(async () => {
            try {
                // Utiliser l'API Adresse du gouvernement franÃ§ais (plus prÃ©cise)
                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
                const data = await response.json();
                
                if(data.features && data.features.length > 0) {
                    suggestions.innerHTML = data.features.map(f => {
                        const props = f.properties;
                        const coords = f.geometry.coordinates;
                        const label = props.label || '';
                        const context = props.context || '';
                        return `<div class="address-suggestion" onclick="app.Planning.selectAddress('${Utils.escape(label).replace(/'/g, "\\'")}', ${coords[1]}, ${coords[0]})">
                            <div class="address-suggestion-main">${Utils.escape(props.name || label.split(',')[0])}</div>
                            <div class="address-suggestion-secondary">${Utils.escape(context)}</div>
                        </div>`;
                    }).join('');
                    suggestions.classList.add('visible');
                } else {
                    suggestions.innerHTML = '<div class="address-suggestion" style="color:var(--text-sec); cursor:default;">Aucun rÃ©sultat</div>';
                    suggestions.classList.add('visible');
                }
            } catch(e) {
                console.error('Erreur recherche adresse:', e);
                suggestions.classList.remove('visible');
            }
        }, 300);
    },
    
    selectAddress: (address, lat, lng) => {
        document.getElementById('edit-locationAddress').value = address;
        document.getElementById('edit-locationLat').value = lat;
        document.getElementById('edit-locationLng').value = lng;
        document.getElementById('address-suggestions').classList.remove('visible');
        
        // Afficher la mini-carte
        Planning.showMiniMap(lat, lng);
    },
    
    showMiniMap: (lat, lng) => {
        const mapContainer = document.getElementById('location-minimap');
        if(!mapContainer) return;
        
        mapContainer.style.display = 'block';
        mapContainer.innerHTML = '';
        
        // Utiliser Leaflet si disponible (dÃ©jÃ  chargÃ© pour l'Univers)
        if(typeof L !== 'undefined') {
            const miniMap = L.map(mapContainer, { 
                zoomControl: false, 
                attributionControl: false,
                dragging: false,
                scrollWheelZoom: false
            }).setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
            L.marker([lat, lng]).addTo(miniMap);
            
            // Stocker la rÃ©fÃ©rence pour nettoyage
            Planning.currentMiniMap = miniMap;
        } else {
            // Fallback: image statique
            mapContainer.innerHTML = `<img src="https://staticmap.openstreetmap.de/staticmap.php?center=${lat},${lng}&zoom=15&size=400x150&markers=${lat},${lng},red-pushpin" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
        }
    },
    
    updateSceneSelection: () => {
        // Auto-add actors from selected scenes to callsheet
        document.querySelectorAll('#scenes-selection input[type="checkbox"]').forEach(cb => {
            const sceneId = cb.value;
            const scene = state.data.scenes.find(s => s.id === sceneId);
            
            if(cb.checked && scene && scene.perso) {
                const characterNames = scene.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
                
                characterNames.forEach(charName => {
                    const character = state.data.characters.find(c => c.name.toUpperCase() === charName);
                    if(character && character.actor_id) {
                        const actorCheckbox = document.getElementById(`call-actor-${character.actor_id}`);
                        if(actorCheckbox && !actorCheckbox.checked) {
                            actorCheckbox.checked = true;
                        }
                    }
                });
            }
        });
    },
    
	tempShootDay: null,
    
addSceneToDay: () => {
        const dropdown = document.getElementById('scene-dropdown');
        const sceneIdRaw = dropdown ? dropdown.value : null;
        
        if(!sceneIdRaw) {
            Utils.toast('Veuillez sÃ©lectionner une scÃ¨ne', 'warning');
            return;
        }
        
        // Essayer de trouver la scÃ¨ne avec string OU number
        let scene = state.data.scenes.find(s => s.id === sceneIdRaw);
        if(!scene) {
            scene = state.data.scenes.find(s => s.id === parseInt(sceneIdRaw));
        }
        if(!scene) {
            scene = state.data.scenes.find(s => String(s.id) === sceneIdRaw);
        }
        
        if(!scene) {
            Utils.toast('ScÃ¨ne introuvable !', 'error');
            return;
        }
        
        const sceneId = scene.id; // Utiliser l'ID exact de la scÃ¨ne trouvÃ©e
        
        // Initialize tempShootDay if needed
        if(!Planning.tempShootDay) {
            Planning.tempShootDay = { 
                scenes: [], 
                callSheet: [] 
            };
        }
        
        if(!Planning.tempShootDay.scenes) {
            Planning.tempShootDay.scenes = [];
        }
        
        if(!Planning.tempShootDay.callSheet) {
            Planning.tempShootDay.callSheet = [];
        }
        
        // Check if already added
        if(Planning.tempShootDay.scenes.some(ref => ref.sceneId === sceneId)) {
            Utils.toast('Cette scÃ¨ne est dÃ©jÃ  ajoutÃ©e', 'warning');
            return;
        }
        
        // Add scene
        Planning.tempShootDay.scenes.push({ sceneId: sceneId, startTime: '' });
        
        // Auto-add actors from this scene
        if(scene.perso) {
            const characterNames = scene.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
            
            characterNames.forEach(charName => {
                const character = state.data.characters.find(c => c.name.toUpperCase() === charName);
                if(character && character.actor_id) {
                    // Check if already in callsheet
                    const alreadyAdded = Planning.tempShootDay.callSheet.some(c => c.personId === character.actor_id && c.type === 'actor');
                    if(!alreadyAdded) {
                        Planning.tempShootDay.callSheet.push({
                            type: 'actor',
                            personId: character.actor_id,
                            callTime: '',
                            notes: ''
                        });
                        
                        // Check the checkbox
                        const actorCheckbox = document.getElementById(`call-actor-${character.actor_id}`);
                        if(actorCheckbox) {
                            actorCheckbox.checked = true;
                        }
                    }
                }
            });
        }
        
        // Refresh the list
        Planning.refreshScenesList();
        
        // Auto-sÃ©lectionner les acteurs des scÃ¨nes
        Planning.autoSelectActorsForScenes();
        
        // Auto-sÃ©lectionner les techniciens selon le dÃ©pouillement
        Planning.autoSelectCrewForBreakdown();
        
        // Auto-remplir le lieu depuis la scÃ¨ne (premiÃ¨re scÃ¨ne ajoutÃ©e uniquement)
        if(Planning.tempShootDay.scenes.length === 1) {
            // Extraire le lieu du titre de la scÃ¨ne (format: "INT. LIEU - JOUR")
            const locMatch = scene.title.match(/^(?:INT\.|EXT\.|I\/E)\s*([^\-]+)/i);
            if(locMatch && locMatch[1]) {
                const locName = locMatch[1].trim().toUpperCase();
                const loc = state.data.locations.find(l => l.name.toUpperCase() === locName);
                
                if(loc) {
                    // Remplir le sÃ©lecteur de lieu
                    const locSelect = document.getElementById('edit-location-select');
                    const locInput = document.getElementById('edit-location');
                    if(locSelect) {
                        locSelect.value = loc.name;
                    }
                    if(locInput) {
                        locInput.value = loc.realName || '';
                    }
                    
                    // Remplir les infos du dÃ©cor
                    if(loc.address) {
                        const addrInput = document.getElementById('edit-locationAddress');
                        if(addrInput && !addrInput.value) addrInput.value = loc.address;
                    }
                    if(loc.contactName) {
                        const contactInput = document.getElementById('edit-contactName');
                        if(contactInput && !contactInput.value) contactInput.value = loc.contactName;
                    }
                    if(loc.contactPhone) {
                        const phoneInput = document.getElementById('edit-contactPhone');
                        if(phoneInput && !phoneInput.value) phoneInput.value = loc.contactPhone;
                    }
                    if(loc.accessNotes) {
                        const notesInput = document.getElementById('edit-locationNotes');
                        if(notesInput && !notesInput.value) notesInput.value = loc.accessNotes;
                    }
                    
                    Utils.toast(`ðŸ“ Lieu "${loc.name}" auto-rempli depuis la scÃ¨ne`, 'success');
                }
            }
        }
    },
    
    removeSceneFromDay: (sceneId) => {
        if(!Planning.tempShootDay) return;
        
        Planning.tempShootDay.scenes = Planning.tempShootDay.scenes.filter(ref => String(ref.sceneId) !== String(sceneId));
        
        // RÃ©initialiser l'Ã©quipe selon les scÃ¨nes restantes
        Planning.recalculateCallSheetForScenes();
        
        Planning.refreshScenesList();
    },
    
    // Recalculer la callsheet en fonction des scÃ¨nes actuelles
    recalculateCallSheetForScenes: () => {
        if(!Planning.tempShootDay) return;
        
        // Collecter les acteurs et techniciens nÃ©cessaires pour les scÃ¨nes restantes
        const neededActorIds = new Set();
        const neededCrewIds = new Set();
        
        (Planning.tempShootDay.scenes || []).forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
            if(!scene) return;
            
            // Acteurs via perso
            if(scene.perso) {
                const characterNames = scene.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
                characterNames.forEach(charName => {
                    const character = state.data.characters?.find(c => c.name.toUpperCase() === charName);
                    if(character && character.actor_id) neededActorIds.add(character.actor_id);
                    const actor = state.data.actors?.find(a => a.name.toUpperCase() === charName);
                    if(actor) neededActorIds.add(actor.id);
                });
            }
            
            // Acteurs via dÃ©pouillement COMEDIENS
            if(scene.breakdown && scene.breakdown['COMEDIENS']) {
                scene.breakdown['COMEDIENS'].forEach(actorName => {
                    const actor = state.data.actors?.find(a => a.name.toUpperCase() === actorName.toUpperCase());
                    if(actor) neededActorIds.add(actor.id);
                });
            }
            
            // Acteurs via dÃ©pouillement PERSONNAGES
            if(scene.breakdown && scene.breakdown['PERSONNAGES']) {
                scene.breakdown['PERSONNAGES'].forEach(charName => {
                    const character = state.data.characters?.find(c => c.name.toUpperCase() === charName.toUpperCase());
                    if(character && character.actor_id) neededActorIds.add(character.actor_id);
                });
            }
            
            // Techniciens via dÃ©pouillement TECHNICIENS
            if(scene.breakdown && scene.breakdown['TECHNICIENS']) {
                scene.breakdown['TECHNICIENS'].forEach(name => {
                    const crew = state.data.crew?.find(c => c.name.toUpperCase() === name.toUpperCase());
                    if(crew) neededCrewIds.add(crew.id);
                });
            }
        });
        
        // Collecter les personnes Ã  retirer
        const actorsToRemove = [];
        const crewToRemove = [];
        
        // DÃ©cocher et retirer les acteurs qui ne sont plus nÃ©cessaires
        (Planning.tempShootDay.callSheet || []).forEach(call => {
            if(call.type === 'actor' && !neededActorIds.has(call.personId)) {
                actorsToRemove.push(call.personId);
                const checkbox = document.getElementById(`call-actor-${call.personId}`);
                if(checkbox) checkbox.checked = false;
                // RÃ©initialiser le transport
                const transportSelect = document.getElementById(`call-transport-actor-${call.personId}`);
                if(transportSelect) transportSelect.value = '';
                // Cacher le dropdown "avec qui"
                const withWhoDropdown = document.getElementById(`call-withwho-actor-${call.personId}`);
                if(withWhoDropdown) withWhoDropdown.style.display = 'none';
            }
        });
        
        // DÃ©cocher et retirer les techniciens qui ne sont plus nÃ©cessaires
        (Planning.tempShootDay.callSheet || []).forEach(call => {
            if(call.type === 'crew' && !neededCrewIds.has(call.personId)) {
                crewToRemove.push(call.personId);
                const checkbox = document.getElementById(`call-crew-${call.personId}`);
                if(checkbox) checkbox.checked = false;
                // RÃ©initialiser le transport
                const transportSelect = document.getElementById(`call-transport-crew-${call.personId}`);
                if(transportSelect) transportSelect.value = '';
                // Cacher le dropdown "avec qui"
                const withWhoDropdown = document.getElementById(`call-withwho-crew-${call.personId}`);
                if(withWhoDropdown) withWhoDropdown.style.display = 'none';
            }
        });
        
        // Retirer du callSheet
        Planning.tempShootDay.callSheet = Planning.tempShootDay.callSheet.filter(call => {
            if(call.type === 'actor' && actorsToRemove.includes(call.personId)) return false;
            if(call.type === 'crew' && crewToRemove.includes(call.personId)) return false;
            return true;
        });
        
        // Nettoyer les transports "avec qui" pour les personnes retirÃ©es
        const allRemovedIds = [
            ...actorsToRemove.map(id => `actor_${id}`),
            ...crewToRemove.map(id => `crew_${id}`)
        ];
        
        Planning.tempShootDay.callSheet.forEach(call => {
            if(call.withWho && call.withWho.length > 0) {
                const originalLength = call.withWho.length;
                call.withWho = call.withWho.filter(id => !allRemovedIds.includes(id));
                
                // Si plus personne dans "avec qui", rÃ©initialiser le transport
                if(call.withWho.length === 0 && (call.transport === 'own-brings' || call.transport === 'with')) {
                    call.transport = '';
                    const transportSelect = document.getElementById(`call-transport-${call.type}-${call.personId}`);
                    if(transportSelect) transportSelect.value = '';
                    const withWhoDropdown = document.getElementById(`call-withwho-${call.type}-${call.personId}`);
                    if(withWhoDropdown) withWhoDropdown.style.display = 'none';
                }
                
                // Mettre Ã  jour le label si changement
                if(call.withWho.length !== originalLength) {
                    Planning.updateWithWhoLabel(call.type, call.personId);
                    
                    // DÃ©cocher les checkboxes des personnes retirÃ©es dans la liste "avec qui"
                    allRemovedIds.forEach(removedId => {
                        const checkbox = document.querySelector(`#call-withwho-list-${call.type}-${call.personId} input[value="${removedId}"]`);
                        if(checkbox) checkbox.checked = false;
                    });
                }
            }
        });
        
        // Mettre Ã  jour toutes les listes "avec qui" pour retirer les personnes supprimÃ©es
        Planning.tempShootDay.callSheet.forEach(call => {
            const listContainer = document.getElementById(`call-withwho-list-${call.type}-${call.personId}`);
            if(listContainer) {
                // DÃ©cocher toutes les checkboxes des personnes retirÃ©es
                allRemovedIds.forEach(removedId => {
                    const checkbox = listContainer.querySelector(`input[value="${removedId}"]`);
                    if(checkbox) checkbox.checked = false;
                });
            }
        });
        
        // RafraÃ®chir l'affichage de la section besoins/dÃ©pouillement
        Planning.refreshBreakdownPreview();
    },
    
    // RafraÃ®chir l'aperÃ§u du dÃ©pouillement dans la modal
    refreshBreakdownPreview: () => {
        const container = document.getElementById('breakdown-preview');
        if(!container) return;
        
        // Collecter tous les Ã©lÃ©ments de dÃ©pouillement des scÃ¨nes sÃ©lectionnÃ©es
        const allCategories = {};
        (Planning.tempShootDay?.scenes || []).forEach(ref => {
            const scene = state.data.scenes.find(s => s.id === ref.sceneId || String(s.id) === String(ref.sceneId));
            if(scene && scene.breakdown) {
                Object.entries(scene.breakdown).forEach(([category, items]) => {
                    if(Array.isArray(items) && items.length > 0) {
                        if(!allCategories[category]) allCategories[category] = [];
                        items.forEach(item => {
                            if(!allCategories[category].includes(item)) {
                                allCategories[category].push(item);
                            }
                        });
                    }
                });
            }
        });
        
        if(Object.keys(allCategories).length === 0) {
            container.innerHTML = '<p class="text-sec-italic">SÃ©lectionnez des scÃ¨nes pour voir les besoins</p>';
            return;
        }
        
        container.innerHTML = Object.entries(allCategories).map(([cat, items]) => `
            <div style="display: inline-block; margin: 5px; padding: 8px 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                <strong>${Utils.escape(cat)}</strong>: ${items.map(i => Utils.escape(i)).join(', ')}
            </div>
        `).join('');
    },
    
    toggleShotSelection: (sceneId, shotId) => {
        if(!Planning.tempShootDay) return;
        
        const sceneRef = Planning.tempShootDay.scenes.find(ref => ref.sceneId === sceneId || String(ref.sceneId) === String(sceneId));
        if(!sceneRef) return;
        
        if(!sceneRef.selectedShots) {
            sceneRef.selectedShots = [];
        }
        
        const idx = sceneRef.selectedShots.indexOf(shotId);
        if(idx >= 0) {
            sceneRef.selectedShots.splice(idx, 1);
        } else {
            sceneRef.selectedShots.push(shotId);
        }
        
        Planning.refreshScenesList();
    },
    
    selectAllShots: (sceneId) => {
        if(!Planning.tempShootDay) return;
        
        const sceneRef = Planning.tempShootDay.scenes.find(ref => ref.sceneId === sceneId || String(ref.sceneId) === String(sceneId));
        if(!sceneRef) return;
        
        const sceneShots = state.data.shots ? state.data.shots.filter(s => s.sceneId === sceneId || String(s.sceneId) === String(sceneId)) : [];
        sceneRef.selectedShots = sceneShots.map(s => s.id);
        
        Planning.refreshScenesList();
    },
    
    deselectAllShots: (sceneId) => {
        if(!Planning.tempShootDay) return;
        
        const sceneRef = Planning.tempShootDay.scenes.find(ref => ref.sceneId === sceneId || String(ref.sceneId) === String(sceneId));
        if(!sceneRef) return;
        
        sceneRef.selectedShots = [];
        
        Planning.refreshScenesList();
    },
    
   autoSelectActorsForScenes: () => {
        if(!Planning.tempShootDay || !Planning.tempShootDay.scenes) return;
        if(!Planning.tempShootDay.callSheet) Planning.tempShootDay.callSheet = [];
        
        // Fonction helper pour ajouter un acteur
        const addActorToCallSheet = (actorId) => {
            if(!actorId) return;
            
            // Cocher la checkbox
            const actorCheckbox = document.getElementById(`call-actor-${actorId}`);
            if(actorCheckbox && !actorCheckbox.checked) {
                actorCheckbox.checked = true;
            }
            
            // Ajouter au callSheet si pas dÃ©jÃ  prÃ©sent
            const alreadyInCallSheet = Planning.tempShootDay.callSheet.some(
                c => c.personId === actorId && c.type === 'actor'
            );
            if(!alreadyInCallSheet) {
                Planning.tempShootDay.callSheet.push({
                    type: 'actor',
                    personId: actorId,
                    callTime: '',
                    notes: ''
                });
            }
        };
        
        Planning.tempShootDay.scenes.forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
            if(!scene) return;
            
            // 1. Chercher via le champ "perso" de la scÃ¨ne
            if(scene.perso) {
                const characterNames = scene.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
                
                characterNames.forEach(charName => {
                    // Chercher par personnage liÃ©
                    const character = state.data.characters?.find(c => c.name.toUpperCase() === charName);
                    if(character && character.actor_id) {
                        addActorToCallSheet(character.actor_id);
                    }
                    
                    // Chercher aussi par nom d'acteur directement
                    const actor = state.data.actors?.find(a => a.name.toUpperCase() === charName);
                    if(actor) {
                        addActorToCallSheet(actor.id);
                    }
                });
            }
            
            // 2. Chercher via le dÃ©pouillement catÃ©gorie COMEDIENS
            if(scene.breakdown && scene.breakdown['COMEDIENS']) {
                scene.breakdown['COMEDIENS'].forEach(actorName => {
                    const actor = state.data.actors?.find(a => a.name.toUpperCase() === actorName.toUpperCase());
                    if(actor) {
                        addActorToCallSheet(actor.id);
                    }
                });
            }
            
            // 3. Chercher via le dÃ©pouillement catÃ©gorie PERSONNAGES (si liÃ©s Ã  des acteurs)
            if(scene.breakdown && scene.breakdown['PERSONNAGES']) {
                scene.breakdown['PERSONNAGES'].forEach(charName => {
                    const character = state.data.characters?.find(c => c.name.toUpperCase() === charName.toUpperCase());
                    if(character && character.actor_id) {
                        addActorToCallSheet(character.actor_id);
                    }
                });
            }
        });
    },
    
    // Auto-cocher les techniciens selon le dÃ©pouillement des scÃ¨nes
    autoSelectCrewForBreakdown: () => {
        if(!Planning.tempShootDay || !Planning.tempShootDay.scenes) return;
        if(!Planning.tempShootDay.callSheet) Planning.tempShootDay.callSheet = [];
        
        // Collecter tous les noms de techniciens dans la catÃ©gorie TECHNICIENS du dÃ©pouillement
        const neededCrewNames = new Set();
        
        Planning.tempShootDay.scenes.forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
            if(scene && scene.breakdown && scene.breakdown['TECHNICIENS']) {
                scene.breakdown['TECHNICIENS'].forEach(name => {
                    neededCrewNames.add(name.toUpperCase());
                });
            }
        });
        
        // Cocher les techniciens dont le nom est dans la liste ET les ajouter au callSheet
        state.data.crew.forEach(member => {
            if(neededCrewNames.has(member.name.toUpperCase())) {
                // Cocher la checkbox
                const crewCheckbox = document.getElementById(`call-crew-${member.id}`);
                if(crewCheckbox && !crewCheckbox.checked) {
                    crewCheckbox.checked = true;
                }
                
                // Ajouter au callSheet si pas dÃ©jÃ  prÃ©sent
                const alreadyInCallSheet = Planning.tempShootDay.callSheet.some(
                    c => c.personId === member.id && c.type === 'crew'
                );
                if(!alreadyInCallSheet) {
                    Planning.tempShootDay.callSheet.push({
                        type: 'crew',
                        personId: member.id,
                        callTime: '',
                        notes: ''
                    });
                }
            }
        });
    },
    
    refreshScenesList: () => {
        const container = document.getElementById('selected-scenes-list');
        const dropdown = document.getElementById('scene-dropdown');
        
        if(!Planning.tempShootDay || Planning.tempShootDay.scenes.length === 0) {
            container.innerHTML = '<div style="color: var(--text-sec); font-style: italic; padding: 15px; text-align: center;">Aucune scÃ¨ne sÃ©lectionnÃ©e</div>';
        } else {
            let html = '';
            Planning.tempShootDay.scenes.forEach(sceneRef => {
                const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
                if(scene) {
                    const sceneIdx = state.data.scenes.indexOf(scene) + 1;
                    const sceneShots = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id) : [];
                    const shotCount = sceneShots.length;
                    const selectedShots = sceneRef.selectedShots || [];
                    const selectedCount = selectedShots.length;
                    const shotBadge = shotCount > 0 
                        ? `<span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">ðŸ“· ${selectedCount}/${shotCount} plan${shotCount > 1 ? 's' : ''}</span>` 
                        : '<span style="background: var(--border); color: var(--text-sec); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">ðŸ“· 0</span>';
                    
                    let shotsHTML = '';
                    if(sceneShots.length > 0) {
                        shotsHTML = `<div class="scene-shots-list" style="margin-top: 8px; padding: 8px; background: var(--panel-bg); border-radius: 4px;">
                            <div class="text-sec-sm-mb5">ðŸ“· Plans Ã  tourner :</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${sceneShots.map(shot => {
                                    const isSelected = selectedShots.includes(shot.id);
                                    return `<label style="display: flex; align-items: center; gap: 3px; padding: 3px 8px; background: ${isSelected ? 'var(--primary)' : 'var(--bg)'}; color: ${isSelected ? 'white' : 'var(--text-main)'}; border-radius: 4px; cursor: pointer; font-size: 0.8rem; border: 1px solid var(--border);">
                                        <input type="checkbox" data-scene-id="${scene.id}" data-shot-id="${shot.id}" ${isSelected ? 'checked' : ''} onchange="app.Planning.toggleShotSelection('${scene.id}', '${shot.id}')" class="d-none">
                                        ${Utils.escape(shot.shotNumber || shot.name || 'Plan ' + shot.id)}
                                    </label>`;
                                }).join('')}
                            </div>
                            <div class="mt-5">
                                <button onclick="app.Planning.selectAllShots('${scene.id}')" class="n8-badge-5">Tout</button>
                                <button onclick="app.Planning.deselectAllShots('${scene.id}')" class="n8-badge-11">Aucun</button>
                            </div>
                        </div>`;
                    }
                    
                    html += `<div class="selected-scene-item" style="margin-bottom: 10px; padding: 10px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border);">
                        <div class="flex-row-gap10">
                            <input type="time" id="scene-time-${scene.id}" value="${sceneRef.startTime || ''}" style="width: 90px;">
                            <span style="flex: 1; font-weight: bold;">#${sceneIdx} - ${Utils.escape(scene.title)}${shotBadge}</span>
                            <span class="text-sec-sm2">${Utils.escape(scene.perso || '')}</span>
                            <button onclick="app.Planning.removeSceneFromDay('${scene.id}')" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">âœ–</button>
                        </div>
                        ${shotsHTML}
                    </div>`;
                }
            });
            container.innerHTML = html;
        }
        
        // Refresh dropdown
        let options = '<option value="">-- SÃ©lectionner une scÃ¨ne --</option>';
        state.data.scenes.forEach((scene, idx) => {
            const alreadySelected = Planning.tempShootDay && Planning.tempShootDay.scenes.some(ref => ref.sceneId === scene.id || String(ref.sceneId) === String(scene.id));
            if(!alreadySelected) {
                const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
const shotLabel = shotCount > 0 ? ` ðŸ“·${shotCount}` : '';
options += `<option value="${scene.id}">#${idx + 1} - ${Utils.escape(scene.title)}${shotLabel}</option>`;
            }
        });
        dropdown.innerHTML = options;
        
        // Auto-fill breakdown needs
        Planning.updateBreakdownNeeds();
    },
    
    updateBreakdownNeeds: () => {
        const container = document.getElementById('auto-breakdown-needs');
        if(!container) return;
        
        if(!Planning.tempShootDay || Planning.tempShootDay.scenes.length === 0) {
            container.innerHTML = '<em class="text-sec">SÃ©lectionnez des scÃ¨nes pour voir les besoins...</em>';
            return;
        }
        
        // Collecter tous les besoins des scÃ¨nes sÃ©lectionnÃ©es
        const allNeeds = {};
        
        Planning.tempShootDay.scenes.forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
            if(scene && scene.breakdown) {
                Object.keys(scene.breakdown).forEach(category => {
                    if(!allNeeds[category]) {
                        allNeeds[category] = new Set();
                    }
                    scene.breakdown[category].forEach(item => {
                        allNeeds[category].add(item);
                    });
                });
            }
        });
        
        // Afficher les besoins
        if(Object.keys(allNeeds).length === 0) {
            container.innerHTML = '<em class="text-sec">Aucun dÃ©pouillement pour ces scÃ¨nes. Allez dans l\'onglet DÃ©pouillement pour ajouter des Ã©lÃ©ments.</em>';
            return;
        }
        
        // Trouver les techniciens responsables par catÃ©gorie
        const getResponsiblesForCategory = (category) => {
            const responsibles = [];
            const crewGroups = state.data.groups.filter(g => g.type === 'crew');
            
            // Chercher quel groupe gÃ¨re cette catÃ©gorie
            Object.keys(CONFIG.crewToBreakdownMap).forEach(groupId => {
                if(CONFIG.crewToBreakdownMap[groupId].includes(category)) {
                    // Trouver les techniciens de ce groupe
                    const members = state.data.crew.filter(c => c.group_id === groupId);
                    members.forEach(m => responsibles.push(m.name));
                }
            });
            
            return responsibles;
        };
        
        let html = '';
        
        // Fonction pour obtenir le comÃ©dien liÃ© Ã  un personnage
        const getActorForCharacter = (charName) => {
            const character = state.data.characters?.find(c => c.name.toUpperCase() === charName.toUpperCase());
            if(character && character.actor_id) {
                const actor = state.data.actors?.find(a => a.id === character.actor_id);
                return actor ? actor.name : null;
            }
            return null;
        };
        
        // Ordre personnalisÃ© des catÃ©gories (PERSONNAGES en premier)
        const categoryOrder = ['PERSONNAGES', 'COMEDIENS', 'TECHNICIENS', 'COSTUMES', 'MAQUILLAGE-COIFFURE', 'ACCESSOIRES', 'DECORS-LIEUX', 'VEHICULES', 'FIGURATION', 'ANIMAUX', 'SON-MUSIQUE', 'EFFETS SPECIAUX (SFX)', 'EFFETS VISUELS (VFX)', 'LUMIERE', 'MACHINERIE', 'LOGISTIQUE'];
        
        const sortedCategories = Object.keys(allNeeds).sort((a, b) => {
            const idxA = categoryOrder.indexOf(a);
            const idxB = categoryOrder.indexOf(b);
            return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
        });
        
        sortedCategories.forEach(category => {
            if(allNeeds[category].size > 0) {
                const items = Array.from(allNeeds[category]);
                const responsibles = getResponsiblesForCategory(category);
                const responsiblesStr = responsibles.length > 0 
                    ? `<span style="color: var(--text-sec); font-size: 0.8rem; margin-left: 10px;">(${responsibles.join(', ')})</span>` 
                    : '';
                
                // Affichage spÃ©cial pour PERSONNAGES : montrer personnage / comÃ©dien
                let itemsHtml = '';
                if(category === 'PERSONNAGES') {
                    itemsHtml = items.map(charName => {
                        const actorName = getActorForCharacter(charName);
                        if(actorName) {
                            return `<span class="badge-panel">
                                <strong>${Utils.escape(charName)}</strong> <span class="text-sec">/</span> <span style="color: var(--primary);">${Utils.escape(actorName)}</span>
                            </span>`;
                        } else {
                            return `<span class="badge-panel">
                                ${Utils.escape(charName)} <span style="color: var(--warning); font-size: 0.75rem;">âš ï¸ Non castÃ©</span>
                            </span>`;
                        }
                    }).join('');
                } else if(category === 'COMEDIENS') {
                    // Ne pas afficher COMEDIENS sÃ©parÃ©ment si dÃ©jÃ  affichÃ© avec PERSONNAGES
                    // Sauf si le comÃ©dien n'est pas liÃ© Ã  un personnage
                    const actorsAlreadyShown = new Set();
                    if(allNeeds['PERSONNAGES']) {
                        allNeeds['PERSONNAGES'].forEach(charName => {
                            const actorName = getActorForCharacter(charName);
                            if(actorName) actorsAlreadyShown.add(actorName.toUpperCase());
                        });
                    }
                    const actorsNotLinked = items.filter(name => !actorsAlreadyShown.has(name.toUpperCase()));
                    if(actorsNotLinked.length === 0) return; // Skip si tous les comÃ©diens sont dÃ©jÃ  affichÃ©s
                    itemsHtml = actorsNotLinked.map(item => `<span class="badge-panel">${Utils.escape(item)}</span>`).join('');
                } else {
                    itemsHtml = items.map(item => `<span class="badge-panel">${Utils.escape(item)}</span>`).join('');
                }
                
                if(itemsHtml) {
                    html += `<div class="mb-10">
                        <strong style="color: var(--primary); font-size: 0.85rem;">${category}</strong>${responsiblesStr}
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                            ${itemsHtml}
                        </div>
                    </div>`;
                }
            }
        });
        
        container.innerHTML = html;
    },
	
	onLocationSelect: (value) => {
        const locationInput = document.getElementById('edit-location');
        const addressInput = document.getElementById('edit-locationAddress');
        
        if(value === '__custom__') {
            locationInput.value = '';
            locationInput.focus();
            return;
        }
        
        if(value) {
            // Le champ edit-location contient maintenant le nom rÃ©el, pas le dÃ©cor
            const loc = state.data.locations.find(l => l.name === value);
            locationInput.value = loc?.realName || '';
            
            // Auto-remplir depuis la fiche dÃ©cor si disponible
            if(loc) {
                if(loc.address && !document.getElementById('edit-locationAddress').value) {
                    document.getElementById('edit-locationAddress').value = loc.address;
                }
                if(loc.contactName && !document.getElementById('edit-contactName').value) {
                    document.getElementById('edit-contactName').value = loc.contactName;
                }
                if(loc.contactPhone && !document.getElementById('edit-contactPhone').value) {
                    document.getElementById('edit-contactPhone').value = loc.contactPhone;
                }
                if(loc.accessNotes && !document.getElementById('edit-locationNotes').value) {
                    document.getElementById('edit-locationNotes').value = loc.accessNotes;
                }
                if(loc.lat && loc.lng) {
                    document.getElementById('edit-locationLat').value = loc.lat;
                    document.getElementById('edit-locationLng').value = loc.lng;
                    Planning.showMiniMap(loc.lat, loc.lng);
                }
            }
            if(loc && loc.desc) {
                addressInput.value = loc.desc;
            }
        }
    },
	
    loadWeather: async (shootDay) => {
        const weatherEl = document.getElementById(`weather-${shootDay.id}`);
        if(!weatherEl) return;
        
        // Use cached weather if available
        if(Planning.weatherCache[shootDay.date]) {
            Planning.displayWeather(weatherEl, Planning.weatherCache[shootDay.date], shootDay);
            return;
        }
        
        try {
            // Using Open-Meteo API (free, no key required)
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=48.8566&longitude=2.3522&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode&timezone=Europe/Paris&start_date=${shootDay.date}&end_date=${shootDay.date}`);
            const data = await response.json();
            
            if(data.daily) {
                const weather = {
                    tempMax: Math.round(data.daily.temperature_2m_max[0]),
                    tempMin: Math.round(data.daily.temperature_2m_min[0]),
                    precipitation: data.daily.precipitation_probability_max[0],
                    code: data.daily.weathercode[0]
                };
                
                Planning.weatherCache[shootDay.date] = weather;
                Planning.displayWeather(weatherEl, weather, shootDay);
            }
        } catch(err) {
            console.error('Weather error:', err);
            weatherEl.innerHTML = `
                <div class="weather-icon">â“</div>
                <div class="weather-info">
                    <div class="weather-temp">--Â°C</div>
                    <div class="weather-desc">MÃ©tÃ©o indisponible</div>
                </div>
            `;
        }
    },
    
	selectedAvailability: { actors: [], crew: [] },
    
    renderAvailabilitySelectors: () => {
        Planning.renderAvailabilityTags('actors');
        Planning.renderAvailabilityTags('crew');
        
        // Ajouter les event listeners pour focus/blur
        const actorsSearch = document.getElementById('planning-actors-search');
        const crewSearch = document.getElementById('planning-crew-search');
        
        if(actorsSearch && !actorsSearch.dataset.init) {
            actorsSearch.dataset.init = 'true';
            actorsSearch.addEventListener('focus', () => Planning.showDropdown('actors'));
            actorsSearch.addEventListener('blur', () => setTimeout(() => Planning.hideDropdown('actors'), 200));
        }
        if(crewSearch && !crewSearch.dataset.init) {
            crewSearch.dataset.init = 'true';
            crewSearch.addEventListener('focus', () => Planning.showDropdown('crew'));
            crewSearch.addEventListener('blur', () => setTimeout(() => Planning.hideDropdown('crew'), 200));
        }
    },
    
    renderAvailabilityTags: (type) => {
        const tagsContainer = document.getElementById(`planning-${type}-tags`);
        if(!tagsContainer) return;
        
        const selectedIds = type === 'actors' ? Planning.selectedAvailability.actors : Planning.selectedAvailability.crew;
        const dataArray = type === 'actors' ? state.data.actors : state.data.crew;
        
        if(selectedIds.length === 0) {
            tagsContainer.innerHTML = '<span class="text-sec-sm2">Aucune sÃ©lection</span>';
            return;
        }
        
        let html = '';
        selectedIds.forEach(id => {
            const person = dataArray?.find(p => p.id === id);
            if(person) {
                if(!person.color) person.color = CONFIG.availabilityColors[dataArray.indexOf(person) % CONFIG.availabilityColors.length];
                html += `<span style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: linear-gradient(135deg, ${person.color}22, ${person.color}11); border: 1px solid ${person.color}; border-radius: 20px; font-size: 0.85rem;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${person.color};"></span>
                    ${Utils.escape(person.name)}
                    <button onclick="app.Planning.toggleAvailabilityPerson('${type === 'actors' ? 'actor' : 'crew'}', '${id}')" style="background: none; border: none; cursor: pointer; padding: 0; margin-left: 2px; color: var(--text-sec); font-size: 1rem; line-height: 1;">&times;</button>
                </span>`;
            }
        });
        tagsContainer.innerHTML = html;
    },
    
    showDropdown: (type) => {
        const dropdown = document.getElementById(`planning-${type}-dropdown`);
        if(dropdown) {
            dropdown.style.display = 'block';
            Planning.filterAvailabilityList(type);
        }
    },
    
    hideDropdown: (type) => {
        const dropdown = document.getElementById(`planning-${type}-dropdown`);
        if(dropdown) dropdown.style.display = 'none';
    },
    
    filterAvailabilityList: (type) => {
        const searchInput = document.getElementById(`planning-${type}-search`);
        const dropdown = document.getElementById(`planning-${type}-dropdown`);
        if(!searchInput || !dropdown) return;
        
        const query = searchInput.value.toLowerCase().trim();
        const dataArray = type === 'actors' ? state.data.actors : state.data.crew;
        const selectedIds = type === 'actors' ? Planning.selectedAvailability.actors : Planning.selectedAvailability.crew;
        
        if(!dataArray || dataArray.length === 0) {
            dropdown.innerHTML = '<div style="padding: 10px; color: var(--text-sec); text-align: center;">Aucun ' + (type === 'actors' ? 'comÃ©dien' : 'technicien') + '</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        const filtered = dataArray.filter(person => {
            const matchesQuery = !query || person.name.toLowerCase().includes(query);
            const notSelected = !selectedIds.includes(person.id);
            return matchesQuery && notSelected;
        });
        
        if(filtered.length === 0) {
            dropdown.innerHTML = '<div style="padding: 10px; color: var(--text-sec); text-align: center;">' + (query ? 'Aucun rÃ©sultat' : 'Tous sÃ©lectionnÃ©s') + '</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        let html = '';
        filtered.forEach((person, idx) => {
            if(!person.color) person.color = CONFIG.availabilityColors[dataArray.indexOf(person) % CONFIG.availabilityColors.length];
            const role = type === 'actors' ? '' : (person.role ? ` - ${person.role}` : '');
            html += `<div onclick="app.Planning.selectFromDropdown('${type}', '${person.id}')" 
                         style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s;"
                         onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
                <span style="width: 10px; height: 10px; border-radius: 50%; background: ${person.color};"></span>
                <span class="flex-1">${Utils.escape(person.name)}${role}</span>
                <span style="color: var(--text-sec); font-size: 0.8rem;">+ Ajouter</span>
            </div>`;
        });
        dropdown.innerHTML = html;
        dropdown.style.display = 'block';
    },
    
    selectFromDropdown: (type, id) => {
        const personType = type === 'actors' ? 'actor' : 'crew';
        Planning.toggleAvailabilityPerson(personType, id);
        
        // Vider la recherche et mettre Ã  jour
        const searchInput = document.getElementById(`planning-${type}-search`);
        if(searchInput) searchInput.value = '';
        Planning.filterAvailabilityList(type);
    },
    
    toggleAvailabilityPerson: (type, id) => {
        const list = type === 'actor' ? Planning.selectedAvailability.actors : Planning.selectedAvailability.crew;
        const idx = list.indexOf(id);
        if(idx > -1) {
            list.splice(idx, 1);
        } else {
            list.push(id);
        }
        Planning.renderAvailabilitySelectors();
        Planning.render();
    },
    
    getAvailabilityBarsForDate: (dateStr) => {
        let bars = [];
        
        // VÃ©rifier les acteurs sÃ©lectionnÃ©s
        Planning.selectedAvailability.actors.forEach(actorId => {
            const actor = state.data.actors.find(a => a.id === actorId);
            if(actor && actor.availabilityDates) {
                const isAvailable = actor.availabilityDates.some(range => {
                    const from = new Date(range.from);
                    const to = new Date(range.to);
                    const check = new Date(dateStr);
                    return check >= from && check <= to;
                });
                if(isAvailable) {
                    bars.push({ name: actor.name, color: actor.color, type: 'actor', hasVehicle: actor.hasVehicle, vehicleSeats: actor.vehicleSeats, vehicleTrunk: actor.vehicleTrunk });
                }
            }
        });
        
        // VÃ©rifier les techniciens sÃ©lectionnÃ©s
        Planning.selectedAvailability.crew.forEach(crewId => {
            const member = state.data.crew.find(c => c.id === crewId);
            if(member && member.availabilityDates) {
                const isAvailable = member.availabilityDates.some(range => {
                    const from = new Date(range.from);
                    const to = new Date(range.to);
                    const check = new Date(dateStr);
                    return check >= from && check <= to;
                });
                if(isAvailable) {
                    bars.push({ name: member.name, color: member.color, type: 'crew', hasVehicle: member.hasVehicle, vehicleSeats: member.vehicleSeats, vehicleTrunk: member.vehicleTrunk });
                }
            }
        });
        
        return bars;
    },
	
	openCallSheets: () => {
        const modal = document.getElementById('callsheets-modal');
        const list = document.getElementById('callsheets-list');
        
        if(!state.data.shootingDays || state.data.shootingDays.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);"><p>Aucun jour de tournage planifiÃ©.</p><p>CrÃ©ez un jour de tournage depuis le calendrier.</p></div>';
        } else {
            // Trier par date
            const sortedDays = [...state.data.shootingDays].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '<div style="display:flex; flex-direction:column; gap:15px;">';
            
            sortedDays.forEach(day => {
                const startDate = day.startDate || day.date;
                const endDate = day.endDate || startDate;
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                const dateFormatted = startDate === endDate 
                    ? startDateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })
                    : startDateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) + ' â†’ ' + endDateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                const isPast = endDateObj < new Date();
                const isToday = Planning.formatDate(startDateObj) === Planning.formatDate(new Date()) || Planning.formatDate(endDateObj) === Planning.formatDate(new Date());
                const status = day.validated ? 'âœ… ValidÃ©e' : (isPast ? 'âš ï¸ PassÃ©e' : (isToday ? 'ðŸŽ¬ Aujourd\'hui' : 'ðŸ“ En prÃ©paration'));
                const statusColor = day.validated ? 'var(--success)' : (isPast ? 'var(--danger)' : (isToday ? 'var(--primary)' : 'var(--text-sec)'));
                
                html += `<div style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem;">${Utils.escape(day.name || 'Tournage')} - ${dateFormatted}</div>
                        <div style="color:var(--text-sec); font-size:0.9rem; margin-top:5px;">
                            ðŸ“ ${day.location || 'Lieu non dÃ©fini'} â€¢ 
                            ðŸŽ¬ ${day.scenes?.length || 0} scÃ¨ne(s) â€¢ 
                            ðŸ‘¥ ${day.callSheet?.length || 0} convoquÃ©(s)
                        </div>
                        <div style="margin-top:8px; font-size:0.85rem; color:${statusColor}; font-weight:500;">${status}</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button onclick="app.Planning.editShootDay('${day.id}')" style="padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">âœï¸ Modifier</button>
                        <button onclick="app.Planning.printCallSheet('${day.id}')" style="padding:8px 15px; background:var(--panel-bg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">ðŸ–¨ï¸ Imprimer</button>
                        <button onclick="app.Planning.sendCallSheet('${day.id}')" style="padding:8px 15px; background:var(--warning, #FF9800); color:white; border:none; border-radius:6px; cursor:pointer;">ðŸ“§ Envoyer</button>
                        <button onclick="app.Planning.validateCallSheet('${day.id}')" style="padding:8px 15px; background:${day.validated ? 'var(--text-sec)' : 'var(--success)'}; color:white; border:none; border-radius:6px; cursor:pointer;">${day.validated ? 'ðŸ”“ DÃ©-valider' : 'âœ… Valider'}</button>
                        <button onclick="app.Planning.deleteShootDayFromList('${day.id}')" style="padding:8px 15px; background:var(--danger); color:white; border:none; border-radius:6px; cursor:pointer;">ðŸ—‘ï¸ Supprimer</button>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            list.innerHTML = html;
        }
        
        modal.style.display = 'flex';
    },
    
    closeCallSheets: () => {
        document.getElementById('callsheets-modal').style.display = 'none';
    },
    
    validateCallSheet: (dayId) => {
        const day = state.data.shootingDays.find(d => d.id === dayId);
        if(!day) return;
        
        day.validated = !day.validated;
        Store.save();
        Planning.openCallSheets(); // RafraÃ®chir la liste
    },
    
    publishCallSheet: async (shootDay) => {
        // GÃ©nÃ©rer un token unique pour cette feuille
        const token = 'fds_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);
        
        const projectName = state.data.title || 'Projet';
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        
        // Construire les donnÃ©es des scÃ¨nes
        const scenesData = (shootDay.scenes || []).map(ref => {
            const scene = state.data.scenes.find(s => s.id === ref.sceneId);
            return scene ? {
                startTime: ref.startTime || '--:--',
                title: scene.title || 'ScÃ¨ne sans titre',
                perso: scene.perso || '',
                decor: scene.decor || '',
                time: scene.time || ''
            } : null;
        }).filter(s => s);
        
        // Construire les donnÃ©es des convoquÃ©s
        const callSheetData = (shootDay.callSheet || []).map(call => {
            let person = null;
            if(call.type === 'actor') {
                person = state.data.actors.find(a => a.id === call.personId);
            } else if(call.type === 'crew') {
                person = state.data.crew.find(c => c.id === call.personId);
            }
            return person ? {
                name: person.name || 'Inconnu',
                role: person.role || person.department || (call.type === 'actor' ? 'ComÃ©dienÂ·ne' : 'TechnicienÂ·ne'),
                callTime: call.callTime || shootDay.crewCall || '',
                notes: call.notes || ''
            } : null;
        }).filter(c => c);
        
        // DonnÃ©es publiques de la feuille de service
        const publicData = {
            token: token,
            projectName: projectName,
            dayNumber: shootDay.dayNumber,
            date: shootDay.date,
            dateFormatted: dateFormatted,
            location: shootDay.location || '',
            locationAddress: shootDay.locationAddress || '',
            contactName: shootDay.contactName || '',
            contactPhone: shootDay.contactPhone || '',
            locationNotes: shootDay.locationNotes || '',
            crewCall: shootDay.crewCall || '',
            readyToShoot: shootDay.readyToShoot || '',
            lunchStart: shootDay.lunchStart || '',
            lunchEnd: shootDay.lunchEnd || '',
            estimatedWrap: shootDay.estimatedWrap || '',
            notes: shootDay.notes || '',
            customWeather: shootDay.customWeather || '',
            scenes: scenesData,
            callSheet: callSheetData,
            createdAt: Date.now(),
            createdBy: state.currentUser?.email || ''
        };
        
        // Sauvegarder dans le projet (les callsheets publiques sont stockÃ©es dans data)
        try {
            if(!state.data.publicCallsheets) state.data.publicCallsheets = {};
            state.data.publicCallsheets[token] = publicData;
            await Store.save();
            return token;
        } catch(e) {
            console.error('âŒ Erreur publication feuille:', e);
            return null;
        }
    },
    
    loadPublicCallSheet: async (token) => {
        try {
            // Chercher dans les donnÃ©es du projet actuel
            const data = state.data?.publicCallsheets?.[token];
            if(!data) {
                document.getElementById('public-callsheet-content').innerHTML = '<p style="text-align:center; color:#c00;">âŒ Feuille de service introuvable ou expirÃ©e.</p>';
                return;
            }
            
            // GÃ©nÃ©rer le HTML de la feuille
            let html = `
                <div style="text-align:center; border-bottom:3px solid #333; padding-bottom:20px; margin-bottom:20px;">
                    <h2 style="margin:0; font-size:1.8rem;">${Utils.escape(data.projectName)}</h2>
                    <p style="font-size:1.3rem; margin:10px 0;">FEUILLE DE SERVICE - JOUR ${data.dayNumber}</p>
                    <p style="font-size:1.1rem; color:#666;">${Utils.escape(data.dateFormatted)}</p>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div style="background:#f5f5f5; padding:15px; border-radius:8px;">
                        <h3 style="margin:0 0 10px; color:#333;">ðŸ“ Lieu</h3>
                        <p style="margin:0; font-size:1.1rem; font-weight:bold;">${Utils.escape(data.location) || 'Ã€ confirmer'}</p>
                        ${data.locationAddress ? `<p style="margin:5px 0 0; color:#666;">${Utils.escape(data.locationAddress)}</p>` : ''}
                        ${data.contactName || data.contactPhone ? `<p style="margin:10px 0 0; padding-top:10px; border-top:1px solid #ddd;"><strong>ðŸ‘¤ Contact sur place:</strong> ${Utils.escape(data.contactName) || ''} ${data.contactPhone ? 'ðŸ“ž ' + Utils.escape(data.contactPhone) : ''}</p>` : ''}
                        ${data.locationNotes ? `<p style="margin:5px 0 0; color:#666; font-style:italic;">ðŸ“ ${Utils.escape(data.locationNotes)}</p>` : ''}
                    </div>
                    <div style="background:#f5f5f5; padding:15px; border-radius:8px;">
                        <h3 style="margin:0 0 10px; color:#333;">â° Horaires</h3>
                        <p class="m-0"><strong>Convocation Ã©quipe:</strong> ${Utils.escape(data.crewCall) || 'Ã€ confirmer'}</p>
                        <p style="margin:5px 0;"><strong>PrÃªt Ã  tourner:</strong> ${Utils.escape(data.readyToShoot) || 'Ã€ confirmer'}</p>
                        <p style="margin:5px 0;"><strong>Repas:</strong> ${Utils.escape(data.lunchStart) || '?'} - ${Utils.escape(data.lunchEnd) || '?'}</p>
                        <p style="margin:5px 0 0;"><strong>Fin estimÃ©e:</strong> ${Utils.escape(data.estimatedWrap) || 'Ã€ confirmer'}</p>
                    </div>
                </div>`;
            
            // ScÃ¨nes
            if(data.scenes && data.scenes.length > 0) {
                html += `
                    <div class="mb-20">
                        <h3 style="background:#333; color:white; padding:10px; margin:0;">ðŸŽ¬ ScÃ¨nes PrÃ©vues</h3>
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th class="td-bordered">Heure</th>
                                    <th class="td-bordered">ScÃ¨ne</th>
                                    <th class="td-bordered">Personnages</th>
                                    <th class="td-bordered">DÃ©cor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.scenes.map(s => `
                                    <tr>
                                        <td class="td-bordered-simple">${Utils.escape(s.startTime)}</td>
                                        <td class="td-bordered-simple">${Utils.escape(s.title)}</td>
                                        <td class="td-bordered-simple">${Utils.escape(s.perso)}</td>
                                        <td class="td-bordered-simple">${Utils.escape(s.decor)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }
            
            // Ã‰quipe convoquÃ©e
            if(data.callSheet && data.callSheet.length > 0) {
                html += `
                    <div class="mb-20">
                        <h3 style="background:#333; color:white; padding:10px; margin:0;">ðŸ‘¥ Ã‰quipe ConvoquÃ©e</h3>
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th class="td-bordered">Nom</th>
                                    <th class="td-bordered">Fonction</th>
                                    <th class="td-bordered">Convocation</th>
                                    <th class="td-bordered">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.callSheet.map(c => `
                                    <tr>
                                        <td style="padding:10px; border:1px solid #ddd; font-weight:bold;">${Utils.escape(c.name)}</td>
                                        <td class="td-bordered-simple">${Utils.escape(c.role)}</td>
                                        <td class="td-bordered-simple">${Utils.escape(c.callTime)}</td>
                                        <td class="td-bordered-simple">${Utils.escape(c.notes)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }
            
            // Notes
            if(data.notes) {
                html += `
                    <div style="background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h3 style="margin:0 0 10px; color:#856404;">ðŸ“‹ Notes</h3>
                        <p style="margin:0; white-space:pre-wrap;">${Utils.escape(data.notes)}</p>
                    </div>`;
            }
            
            if(data.customWeather) {
                html += `
                    <div style="background:#d1ecf1; padding:15px; border-radius:8px;">
                        <h3 style="margin:0 0 10px; color:#0c5460;">ðŸŒ¤ï¸ MÃ©tÃ©o / Conditions</h3>
                        <p style="margin:0; white-space:pre-wrap;">${Utils.escape(data.customWeather)}</p>
                    </div>`;
            }
            
            document.getElementById('public-callsheet-content').innerHTML = html;
            document.getElementById('public-callsheet-modal').style.display = 'block';
            
        } catch(e) {
            console.error('Erreur chargement feuille publique:', e);
            document.getElementById('public-callsheet-content').innerHTML = '<p style="text-align:center; color:#c00;">âŒ Erreur lors du chargement.</p>';
        }
    },
    
    sendCallSheet: async (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) {
            Utils.toast('Jour de tournage introuvable', 'error');
            return;
        }
        
        const projectName = state.data.title || 'Projet';
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'La production';
        const appUrl = 'https://moteur.studio'; // URL de l'application
        
        // Construire la liste des scÃ¨nes
        let scenesText = '';
        if(shootDay.scenes && shootDay.scenes.length > 0) {
            scenesText = '\n\nðŸŽ¬ SCÃˆNES PRÃ‰VUES :\n';
            shootDay.scenes.forEach(ref => {
                const scene = state.data.scenes.find(s => s.id === ref.sceneId);
                if(scene) {
                    scenesText += `â€¢ ${ref.startTime || '--:--'} - ${scene.title || 'ScÃ¨ne sans titre'}`;
                    if(scene.perso) scenesText += ` (${scene.perso})`;
                    if(scene.decor) scenesText += ` - ${scene.decor}`;
                    scenesText += '\n';
                }
            });
        }
        
        // Collecter toutes les personnes Ã  notifier
        const recipients = [];
        
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            for(const call of shootDay.callSheet) {
                let person = null;
                
                if(call.type === 'actor') {
                    person = state.data.actors.find(a => a.id === call.personId);
                } else if(call.type === 'crew') {
                    person = state.data.crew.find(c => c.id === call.personId);
                }
                
                if(person && person.email) {
                    recipients.push({
                        name: person.name || 'Inconnu',
                        email: person.email,
                        callTime: call.callTime || shootDay.crewCall || 'Ã€ confirmer',
                        notes: call.notes || ''
                    });
                }
            }
        }
        
        if(recipients.length === 0) {
            Utils.toast('Aucune personne avec email dans cette feuille de service', 'warning');
            return;
        }
        
        if(!await ConfirmModal.show({ title: `Envoyer la feuille de service J${shootDay.dayNumber} ?`, message: `${recipients.length} destinataire(s) :\n\n${recipients.map(r => 'â€¢ ' + r.name).join('\n')}`, icon: 'ðŸ“§', confirmText: 'Envoyer' })) {
            return;
        }
        
        // Publier la feuille de service pour gÃ©nÃ©rer le lien
        Utils.toast('Publication de la feuille de service...', 'info');
        const token = await Planning.publishCallSheet(shootDay);
        if(!token) {
            Utils.toast('Erreur lors de la publication', 'error');
            return;
        }
        
        const publicLink = window.location.origin + window.location.pathname + '?callsheet=' + token;
        
        let sent = 0;
        let errors = 0;
        
        for(const recipient of recipients) {
            const subject = `ðŸŽ¬ Feuille de Service J${shootDay.dayNumber} - ${projectName}`;
            const content = `Bonjour ${recipient.name},

Vous avez reÃ§u une feuille de service pour le projet "${projectName}".

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“… JOUR ${shootDay.dayNumber} - ${dateFormatted.toUpperCase()}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“ Lieu : ${shootDay.location || 'Ã€ confirmer'}${shootDay.locationAddress ? '\nðŸ“Œ Adresse : ' + shootDay.locationAddress : ''}${shootDay.contactName || shootDay.contactPhone ? '\nðŸ‘¤ Contact sur place : ' + (shootDay.contactName || '') + (shootDay.contactPhone ? ' ðŸ“ž ' + shootDay.contactPhone : '') : ''}${shootDay.locationNotes ? '\nðŸ“ AccÃ¨s : ' + shootDay.locationNotes : ''}

â° HORAIRES :
- Votre convocation : ${recipient.callTime}
- PrÃªt Ã  tourner : ${shootDay.readyToShoot || 'Ã€ confirmer'}
- Repas : ${shootDay.lunchStart || '?'} - ${shootDay.lunchEnd || '?'}
- Fin estimÃ©e : ${shootDay.estimatedWrap || 'Ã€ confirmer'}
${scenesText}${recipient.notes ? '\nðŸ“ NOTES VOUS CONCERNANT :\n' + recipient.notes : ''}${shootDay.notes ? '\n\nðŸ“‹ NOTES GÃ‰NÃ‰RALES :\n' + shootDay.notes : ''}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ”— VOIR LA FEUILLE DE SERVICE COMPLÃˆTE :
Cliquez sur le lien ci-dessous pour voir et imprimer votre feuille de service :

ðŸ‘‰ ${publicLink}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Merci de confirmer votre prÃ©sence en rÃ©pondant Ã  ce message.

Cordialement,
${senderName}
${projectName}`;

            try {
                // Envoyer message interne
                await Messages.send(recipient.email, {
                    subject: subject,
                    content: content,
                    type: 'callsheet',
                    projectId: state.currentProjectId,
                    projectName: projectName,
                    shootDayId: shootDay.id,
                    date: shootDay.date
                });
                
                // Envoyer email avec lien public
                await Messages.sendEmailPing(recipient.email, recipient.name, 'callsheet', {
                    projectName: projectName,
                    shootDate: dateFormatted,
                    location: shootDay.location || 'Ã€ confirmer',
                    callTime: recipient.callTime,
                    senderName: senderName,
                    publicLink: publicLink
                });
                
                sent++;
            } catch(e) {
                console.error(`âŒ Erreur envoi Ã  ${recipient.name}:`, e);
                errors++;
            }
        }
        
        if(sent > 0) {
            Utils.toast(`âœ… ${sent} convocation(s) envoyÃ©e(s) !`, 'success');
        }
        if(errors > 0) {
            Utils.toast(`âš ï¸ ${errors} erreur(s) d'envoi`, 'warning');
        }
    },
    
    printCallSheet: (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const projectTitle = document.getElementById('projectTitle')?.value || 'Projet';
        
        let printContent = `
            <html>
            <head>
                <title>Feuille de Service - Jour ${shootDay.dayNumber}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                    h2 { color: #333; margin-top: 25px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
                    .info-item { padding: 8px; background: #f5f5f5; border-radius: 4px; }
                    .info-label { font-weight: bold; color: #666; }
                    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                    th { background: #f0f0f0; }
                    .scene-item { padding: 10px; margin: 5px 0; background: #f9f9f9; border-left: 3px solid #2b6ef6; }
                </style>
            </head>
            <body>
                <h1>ðŸ“‹ FEUILLE DE SERVICE</h1>
                <div style="text-align:center; margin-bottom:20px;">
                    <strong style="font-size:1.2rem;">${projectTitle}</strong><br>
                    <span>Jour ${shootDay.dayNumber} - ${dateFormatted}</span>
                </div>
                
                <h2>ðŸ“ Lieu de Tournage</h2>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Lieu:</span> ${shootDay.location || 'Non dÃ©fini'}</div>
                    <div class="info-item"><span class="info-label">Adresse:</span> ${shootDay.locationAddress || 'Non dÃ©finie'}</div>
                </div>
                
                <h2>â° Horaires</h2>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Convocation Ã©quipe:</span> ${shootDay.crewCall || '--:--'}</div>
                    <div class="info-item"><span class="info-label">PrÃªt Ã  tourner:</span> ${shootDay.readyToShoot || '--:--'}</div>
                    <div class="info-item"><span class="info-label">Pause dÃ©jeuner:</span> ${shootDay.lunchStart || '--:--'} - ${shootDay.lunchEnd || '--:--'}</div>
                    <div class="info-item"><span class="info-label">Fin estimÃ©e:</span> ${shootDay.estimatedWrap || '--:--'}</div>
                </div>
                
                <h2>ðŸŽ¬ ScÃ¨nes Ã  Tourner</h2>`;
        
        if(shootDay.scenes && shootDay.scenes.length > 0) {
            shootDay.scenes.forEach(sceneRef => {
                const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId);
                if(scene) {
                    printContent += `<div class="scene-item">
                        <strong>${scene.title}</strong><br>
                        <span class="text-muted">Personnages: ${scene.perso || 'N/A'}</span><br>
                        <span class="text-muted">Heure prÃ©vue: ${sceneRef.startTime || 'Non dÃ©finie'}</span>
                    </div>`;
                }
            });
        } else {
            printContent += '<p style="color:#999;">Aucune scÃ¨ne planifiÃ©e</p>';
        }
        
        printContent += '<h2>ðŸ‘¥ Convocations</h2>';
        
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            printContent += `<table>
                <thead><tr><th>Nom</th><th>Fonction</th><th>Convocation</th><th>Notes</th></tr></thead>
                <tbody>`;
            
            shootDay.callSheet.forEach(call => {
                let person = null;
                let role = '';
                if(call.type === 'actor') {
                    person = state.data.actors.find(a => a.id === call.personId);
                    role = 'ComÃ©dien(ne)';
                } else {
                    person = state.data.crew.find(c => c.id === call.personId);
                    role = person?.role || 'Technicien';
                }
                if(person) {
                    printContent += `<tr>
                        <td>${person.name}</td>
                        <td>${role}</td>
                        <td>${call.callTime || '--:--'}</td>
                        <td>${call.notes || ''}</td>
                    </tr>`;
                }
            });
            
            printContent += '</tbody></table>';
        } else {
            printContent += '<p style="color:#999;">Aucune convocation</p>';
        }
        
        // Section "Ã€ prÃ©voir" basÃ©e sur le dÃ©pouillement
        const scenesIds = (shootDay.scenes || []).map(ref => ref.sceneId);
        if(scenesIds.length > 0 && shootDay.callSheet && shootDay.callSheet.length > 0) {
            let breakdownByPerson = [];
            
            shootDay.callSheet.forEach(call => {
                if(call.type !== 'crew') return;
                
                const member = state.data.crew.find(c => c.id === call.personId);
                if(!member || !member.group_id) return;
                
                const items = Planning.getBreakdownItemsForPerson(member, scenesIds);
                if(items.length > 0) {
                    const groupInfo = state.data.groups.find(g => g.id === member.group_id);
                    breakdownByPerson.push({
                        name: member.name,
                        department: groupInfo ? groupInfo.name : 'Non classÃ©',
                        items: items
                    });
                }
            });
            
            if(breakdownByPerson.length > 0) {
                printContent += '<h2>ðŸ“¦ Ã€ PrÃ©voir par DÃ©partement</h2>';
                
                // Regrouper par dÃ©partement
                const byDepartment = {};
                breakdownByPerson.forEach(person => {
                    if(!byDepartment[person.department]) {
                        byDepartment[person.department] = { names: [], items: [] };
                    }
                    byDepartment[person.department].names.push(person.name);
                    person.items.forEach(item => {
                        // Ã‰viter les doublons
                        const exists = byDepartment[person.department].items.some(
                            i => i.item === item.item && i.sceneNum === item.sceneNum
                        );
                        if(!exists) {
                            byDepartment[person.department].items.push(item);
                        }
                    });
                });
                
                // Afficher par dÃ©partement
                Object.keys(byDepartment).forEach(dept => {
                    const data = byDepartment[dept];
                    const namesStr = data.names.join(', ');
                    
                    printContent += `<div style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 6px; border-left: 3px solid #ff9800;">
                        <strong>${dept}</strong> <span class="text-muted">(${namesStr})</span>
                        <ul style="margin: 10px 0 0 20px; padding: 0;">`;
                    
                    data.items.forEach(item => {
                        printContent += `<li>${item.item} <span class="text-muted">(Sc.${item.sceneNum})</span></li>`;
                    });
                    
                    printContent += '</ul></div>';
                });
            }
        }
        
        if(shootDay.notes) {
            printContent += `<h2>ðŸ“ Notes</h2><p>${shootDay.notes}</p>`;
        }
        
        printContent += '</body></html>';
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    },
	
	sendCallSheetEmail: (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        // Collecter les emails des convoquÃ©s
        const emails = [];
        
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            shootDay.callSheet.forEach(call => {
                let person = null;
                if(call.type === 'actor') {
                    person = state.data.actors.find(a => a.id === call.personId);
                } else if(call.type === 'crew') {
                    person = state.data.crew.find(c => c.id === call.personId);
                }
                if(person && person.email) {
                    emails.push(person.email);
                }
            });
        }
        
        // Construire le contenu de l'email
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        
        let body = `FEUILLE DE SERVICE - JOUR ${shootDay.dayNumber}%0D%0A`;
        body += `Date: ${dateFormatted}%0D%0A`;
        body += `Lieu: ${shootDay.location || 'Non dÃ©fini'}%0D%0A`;
        if(shootDay.locationAddress) body += `Adresse: ${shootDay.locationAddress}%0D%0A`;
        body += `%0D%0A`;
        body += `HORAIRES:%0D%0A`;
        body += `- Convocation Ã©quipe: ${shootDay.crewCall || '--:--'}%0D%0A`;
        body += `- PrÃªt Ã  tourner: ${shootDay.readyToShoot || '--:--'}%0D%0A`;
        body += `- Pause dÃ©jeuner: ${shootDay.lunchStart || '--:--'} - ${shootDay.lunchEnd || '--:--'}%0D%0A`;
        body += `- Fin estimÃ©e: ${shootDay.estimatedWrap || '--:--'}%0D%0A`;
        body += `%0D%0A`;
        
        if(shootDay.scenes && shootDay.scenes.length > 0) {
            body += `SCENES A TOURNER:%0D%0A`;
            shootDay.scenes.forEach(sceneRef => {
                const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId);
                if(scene) {
                    body += `- ${scene.title}%0D%0A`;
                }
            });
            body += `%0D%0A`;
        }
        
        if(shootDay.notes) {
            body += `NOTES:%0D%0A${shootDay.notes}%0D%0A`;
        }
        
        const subject = `Feuille de service - Jour ${shootDay.dayNumber} - ${dateFormatted}`;
        const mailtoLink = `mailto:${emails.join(',')}?subject=${encodeURIComponent(subject)}&body=${body}`;
        
        if(emails.length === 0) {
            Utils.toast('Aucun email trouvÃ© parmi les personnes convoquÃ©es. Ajoutez les emails dans les fiches ComÃ©diens et Ã‰quipe.', 'warning');
        }
        
        window.open(mailtoLink, '_blank');
    },
	
    displayWeather: (el, weather, shootDay) => {
        const weatherIcons = {
            0: 'â˜€ï¸', 1: 'ðŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸',
            45: 'ðŸŒ«ï¸', 48: 'ðŸŒ«ï¸',
            51: 'ðŸŒ§ï¸', 53: 'ðŸŒ§ï¸', 55: 'ðŸŒ§ï¸',
            61: 'ðŸŒ§ï¸', 63: 'ðŸŒ§ï¸', 65: 'ðŸŒ§ï¸',
            71: 'ðŸŒ¨ï¸', 73: 'ðŸŒ¨ï¸', 75: 'ðŸŒ¨ï¸',
            80: 'ðŸŒ¦ï¸', 81: 'ðŸŒ¦ï¸', 82: 'ðŸŒ¦ï¸',
            95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
        };
        
        const weatherDesc = {
            0: 'Ciel dÃ©gagÃ©', 1: 'Principalement dÃ©gagÃ©', 2: 'Partiellement nuageux', 3: 'Couvert',
            45: 'Brouillard', 48: 'Brouillard givrant',
            51: 'Bruine lÃ©gÃ¨re', 53: 'Bruine modÃ©rÃ©e', 55: 'Bruine dense',
            61: 'Pluie lÃ©gÃ¨re', 63: 'Pluie modÃ©rÃ©e', 65: 'Pluie forte',
            71: 'Neige lÃ©gÃ¨re', 73: 'Neige modÃ©rÃ©e', 75: 'Neige forte',
            80: 'Averses lÃ©gÃ¨res', 81: 'Averses modÃ©rÃ©es', 82: 'Averses violentes',
            95: 'Orage', 96: 'Orage avec grÃªle lÃ©gÃ¨re', 99: 'Orage avec grÃªle forte'
        };
        
        const icon = weatherIcons[weather.code] || 'ðŸŒ¤ï¸';
        const desc = weatherDesc[weather.code] || 'Temps variable';
        
        let customNote = '';
        if(shootDay.customWeather) {
            customNote = `<div style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 0.85rem;">ðŸ“ ${Utils.escape(shootDay.customWeather)}</div>`;
        }
        
        el.innerHTML = `
            <div class="weather-icon">${icon}</div>
            <div class="weather-info">
                <div class="weather-temp">${weather.tempMin}Â°C - ${weather.tempMax}Â°C</div>
                <div class="weather-desc">${desc}</div>
                <div class="weather-details">ProbabilitÃ© de pluie: ${weather.precipitation}%</div>
            </div>
            ${customNote}
        `;
    },
    
    generateFDS: () => {
        // If editing, save first
        Planning.saveShootDay();
        
        // Trouver le jour sauvegardÃ© par son ID
        const savedDay = state.data.shootingDays.find(sd => sd.id === Planning.editingDayId) 
            || state.data.shootingDays.find(sd => sd.startDate === document.getElementById('edit-startDate').value);
        if(!savedDay) {
            Utils.toast('Jour de tournage non trouvÃ©', 'error');
            return;
        }
        
        Planning.showFDS(savedDay);
    },
    
    showFDS: async (shootDay) => {
        Planning.currentFDSDay = shootDay;
        
        const modal = document.getElementById('fds-modal');
        const content = document.getElementById('fdsContent');
        
        // Utiliser startDate au lieu de date
        const shootDate = shootDay.startDate || shootDay.date;
        const dateObj = new Date(shootDate);
        const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        
        // Afficher chargement
        content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner dark"></div><p>Chargement mÃ©tÃ©o...</p></div>';
        modal.classList.add('active');
        
        // RÃ©cupÃ©rer mÃ©tÃ©o si coordonnÃ©es disponibles
        let weatherHTML = '';
        if(shootDay.locationLat && shootDay.locationLng && shootDate) {
            const weather = await Weather.fetch(parseFloat(shootDay.locationLat), parseFloat(shootDay.locationLng), shootDate);
            weatherHTML = Weather.renderCard(weather);
        } else if(!shootDay.locationLat || !shootDay.locationLng) {
            weatherHTML = '<p class="text-sec-italic">ðŸ“ Renseignez une adresse avec GPS pour voir la mÃ©tÃ©o</p>';
        }
        
        // Programme du jour avec scÃ¨nes ET plans sÃ©lectionnÃ©s
        let scenesHTML = '';
        (shootDay.scenes || []).forEach(ref => {
            const scene = state.data.scenes.find(s => s.id === ref.sceneId);
            if(scene) {
                const sceneIndex = state.data.scenes.findIndex(s => s.id === ref.sceneId) + 1;
                const selectedShots = ref.selectedShots || [];
                // Utiliser state.data.shots au lieu de storyboard
                const allShots = state.data.shots?.filter(s => s.sceneId === ref.sceneId || String(s.sceneId) === String(ref.sceneId)) || [];
                const totalShots = allShots.length;
                
                // Afficher les numÃ©ros des plans sÃ©lectionnÃ©s
                let shotsInfo = '-';
                if(totalShots > 0) {
                    if(selectedShots.length > 0) {
                        // Trier les plans par ordre
                        const sortedShots = [...allShots].sort((a,b) => (a.order || 0) - (b.order || 0));
                        // RÃ©cupÃ©rer les numÃ©ros des plans sÃ©lectionnÃ©s
                        const shotNumbers = selectedShots.map(shotId => {
                            const shotIndex = sortedShots.findIndex(s => s.id === shotId);
                            return shotIndex >= 0 ? shotIndex + 1 : null;
                        }).filter(Boolean).sort((a,b) => a-b);
                        shotsInfo = `Plans: ${shotNumbers.join(', ')} (${selectedShots.length}/${totalShots})`;
                    } else {
                        shotsInfo = `0/${totalShots} plans`;
                    }
                }
                
                scenesHTML += `<tr>
                    <td>${ref.startTime || '--:--'}</td>
                    <td><strong>Sc.${sceneIndex}</strong> - ${Utils.escape(scene.title)}</td>
                    <td>${Utils.escape(scene.perso || '-')}</td>
                    <td>${scene.time || '-'} min</td>
                    <td>${shotsInfo}</td>
                </tr>`;
            }
        });
        
        // Convocations avec transport - groupÃ©es par catÃ©gorie
        let callsheetHTML = '';
        const actorCalls = (shootDay.callSheet || []).filter(c => c.type === 'actor');
        const crewCalls = (shootDay.callSheet || []).filter(c => c.type === 'crew');
        
        // Fonction helper pour le transport
        const getTransportInfo = (call) => {
            let transportInfo = '';
            if(call.transport === 'own') transportInfo = 'ðŸš—';
            else if(call.transport === 'own-brings') {
                const withNames = (call.withWho || []).map(id => {
                    const [type, personId] = [id.substring(0, id.indexOf('_')), id.substring(id.indexOf('_') + 1)];
                    const p = type === 'actor' ? state.data.actors.find(a => a.id === personId) : state.data.crew.find(c => c.id === personId);
                    return p ? p.name : '';
                }).filter(Boolean).join(', ');
                transportInfo = withNames ? `ðŸš—ðŸ‘¥ ${withNames}` : 'ðŸš—ðŸ‘¥';
            }
            else if(call.transport === 'with') {
                const withNames = (call.withWho || []).map(id => {
                    const [type, personId] = [id.substring(0, id.indexOf('_')), id.substring(id.indexOf('_') + 1)];
                    const p = type === 'actor' ? state.data.actors.find(a => a.id === personId) : state.data.crew.find(c => c.id === personId);
                    return p ? p.name : '';
                }).filter(Boolean).join(', ');
                transportInfo = withNames ? `â†’ ${withNames}` : 'ðŸš—â†’';
            }
            else if(call.transport === 'taxi') transportInfo = 'ðŸš•';
            else if(call.transport === 'public') transportInfo = 'ðŸš‡';
            return transportInfo;
        };
        
        // ComÃ©diens groupÃ©s
        if(actorCalls.length > 0) {
            const actorGroups = state.data.groups.filter(g => g.type === 'actor');
            
            actorGroups.forEach(grp => {
                const groupCalls = actorCalls.filter(call => {
                    const actor = state.data.actors.find(a => a.id === call.personId);
                    return actor && actor.group_id === grp.id;
                });
                
                if(groupCalls.length > 0) {
                    callsheetHTML += `<tr class="bg-base"><td colspan="5" class="th-primary">ðŸŽ­ ${grp.name}</td></tr>`;
                    groupCalls.forEach(call => {
                        const person = state.data.actors.find(a => a.id === call.personId);
                        if(person) {
                            const character = state.data.characters.find(c => c.actor_id === person.id);
                            const role = character ? character.name : 'ComÃ©dien(ne)';
                            callsheetHTML += `<tr>
                                <td>${Utils.escape(person.name)}</td>
                                <td>${Utils.escape(role)}</td>
                                <td><strong>${call.callTime || '--:--'}</strong></td>
                                <td>${getTransportInfo(call)}</td>
                                <td>${Utils.escape(call.notes || '-')}</td>
                            </tr>`;
                        }
                    });
                }
            });
            
            // ComÃ©diens sans groupe
            const noGroupActors = actorCalls.filter(call => {
                const actor = state.data.actors.find(a => a.id === call.personId);
                return actor && (!actor.group_id || !actorGroups.find(g => g.id === actor.group_id));
            });
            
            if(noGroupActors.length > 0) {
                callsheetHTML += `<tr class="bg-base"><td colspan="5" class="th-primary">ðŸŽ­ ComÃ©diens</td></tr>`;
                noGroupActors.forEach(call => {
                    const person = state.data.actors.find(a => a.id === call.personId);
                    if(person) {
                        const character = state.data.characters.find(c => c.actor_id === person.id);
                        const role = character ? character.name : 'ComÃ©dien(ne)';
                        callsheetHTML += `<tr>
                            <td>${Utils.escape(person.name)}</td>
                            <td>${Utils.escape(role)}</td>
                            <td><strong>${call.callTime || '--:--'}</strong></td>
                            <td>${getTransportInfo(call)}</td>
                            <td>${Utils.escape(call.notes || '-')}</td>
                        </tr>`;
                    }
                });
            }
        }
        
        // Techniciens groupÃ©s par dÃ©partement
        if(crewCalls.length > 0) {
            const crewGroups = state.data.groups.filter(g => g.type === 'crew');
            
            crewGroups.forEach(grp => {
                const groupCalls = crewCalls.filter(call => {
                    const member = state.data.crew.find(c => c.id === call.personId);
                    return member && member.group_id === grp.id;
                });
                
                if(groupCalls.length > 0) {
                    callsheetHTML += `<tr class="bg-base"><td colspan="5" class="th-primary">ðŸŽ¥ ${grp.name}</td></tr>`;
                    groupCalls.forEach(call => {
                        const person = state.data.crew.find(c => c.id === call.personId);
                        if(person) {
                            callsheetHTML += `<tr>
                                <td>${Utils.escape(person.name)}</td>
                                <td>${Utils.escape(person.role || 'Technicien')}</td>
                                <td><strong>${call.callTime || '--:--'}</strong></td>
                                <td>${getTransportInfo(call)}</td>
                                <td>${Utils.escape(call.notes || '-')}</td>
                            </tr>`;
                        }
                    });
                }
            });
            
            // Techniciens sans groupe
            const noGroupCrew = crewCalls.filter(call => {
                const member = state.data.crew.find(c => c.id === call.personId);
                return member && (!member.group_id || !crewGroups.find(g => g.id === member.group_id));
            });
            
            if(noGroupCrew.length > 0) {
                callsheetHTML += `<tr class="bg-base"><td colspan="5" style="font-weight: bold; padding: 8px; color: var(--text-sec);">ðŸŽ¥ Autres techniciens</td></tr>`;
                noGroupCrew.forEach(call => {
                    const person = state.data.crew.find(c => c.id === call.personId);
                    if(person) {
                        callsheetHTML += `<tr>
                            <td>${Utils.escape(person.name)}</td>
                            <td>${Utils.escape(person.role || 'Technicien')}</td>
                            <td><strong>${call.callTime || '--:--'}</strong></td>
                            <td>${getTransportInfo(call)}</td>
                            <td>${Utils.escape(call.notes || '-')}</td>
                        </tr>`;
                    }
                });
            }
        }
        
        // Section lieu avec contact et notes d'accÃ¨s
        let locationHTML = `
            <div class="fds-section">
                <div class="fds-section-title">ðŸ“ LIEU DE TOURNAGE</div>
                <p><strong>${Utils.escape(shootDay.location || shootDay.locationRealName || 'Non dÃ©fini')}</strong></p>
                <p>${Utils.escape(shootDay.locationAddress || '')}</p>`;
        
        // Contact et tÃ©lÃ©phone
        if(shootDay.contactName || shootDay.contactPhone) {
            locationHTML += `<p class="mt-10">ðŸ‘¤ <strong>Contact :</strong> ${Utils.escape(shootDay.contactName || '')} ${shootDay.contactPhone ? 'ðŸ“ž ' + Utils.escape(shootDay.contactPhone) : ''}</p>`;
        }
        
        // Notes d'accÃ¨s
        if(shootDay.locationNotes) {
            locationHTML += `<p style="margin-top: 5px; padding: 10px; background: rgba(var(--warning-rgb), 0.1); border-radius: 6px;">ðŸ“ ${Utils.escape(shootDay.locationNotes)}</p>`;
        }
        
        if(shootDay.locationLat && shootDay.locationLng) {
            const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=${shootDay.locationLat},${shootDay.locationLng}`;
            locationHTML += `
                <div id="fds-map-container" class="fds-map-container"></div>
                <div class="fds-location-actions">
                    <a href="${gmapsUrl}" target="_blank" class="fds-gmaps-btn">ðŸ“ Ouvrir dans Google Maps</a>
                </div>
                <p class="fds-gmaps-link-print" style="display: none; font-size: 10px; color: #666; word-break: break-all; margin-top: 5px;">ðŸ—ºï¸ ${gmapsUrl}</p>`;
        }
        locationHTML += '</div>';
        
        // DÃ©pouillement (Ã©lÃ©ments nÃ©cessaires pour les scÃ¨nes) - stockÃ© dans scene.breakdown
        // Avec les responsables par dÃ©partement
        let breakdownHTML = '';
        const allCategories = {};
        (shootDay.scenes || []).forEach(ref => {
            const scene = state.data.scenes.find(s => s.id === ref.sceneId);
            if(scene && scene.breakdown) {
                Object.entries(scene.breakdown).forEach(([category, items]) => {
                    if(Array.isArray(items) && items.length > 0) {
                        if(!allCategories[category]) allCategories[category] = [];
                        items.forEach(item => {
                            if(!allCategories[category].includes(item)) {
                                allCategories[category].push(item);
                            }
                        });
                    }
                });
            }
        });
        
        // Mapping catÃ©gorie dÃ©pouillement -> groupe crew
        const categoryToCrewGroup = {
            'ACCESSOIRES': 'gc5', 'DECORS-LIEUX': 'gc5',
            'COSTUMES': 'gc6',
            'MAQUILLAGE-COIFFURE': 'gc7',
            'VEHICULES': 'gc12', 'LOGISTIQUE': 'gc12',
            'SON-MUSIQUE': 'gc4',
            'LUMIERE': 'gc2',
            'FIGURATION': 'gc9', 'ANIMAUX': 'gc9',
            'EFFETS SPECIAUX (SFX)': 'gc16',
            'EFFETS VISUELS (VFX)': 'gc13'
        };
        
        // Trouver le responsable pour chaque catÃ©gorie
        const getResponsibleForCategory = (category) => {
            const groupId = categoryToCrewGroup[category];
            if(!groupId) return null;
            
            // Chercher dans la callSheet du jour les techniciens de ce groupe
            const responsible = (shootDay.callSheet || []).find(call => {
                if(call.type !== 'crew') return false;
                const crew = state.data.crew.find(c => c.id === call.personId);
                return crew && crew.group_id === groupId;
            });
            
            if(responsible) {
                const crew = state.data.crew.find(c => c.id === responsible.personId);
                return crew ? crew.name : null;
            }
            return null;
        };
        
        if(Object.keys(allCategories).length > 0) {
            breakdownHTML = `
                <div class="fds-section">
                    <div class="fds-section-title">ðŸ“¦ DÃ‰POUILLEMENT / BESOINS</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        ${Object.entries(allCategories).map(([cat, items]) => {
                            const responsible = getResponsibleForCategory(cat);
                            const responsibleText = responsible ? ` (${Utils.escape(responsible)})` : '';
                            return `
                            <div style="padding: 10px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                                <strong>${Utils.escape(cat)}${responsibleText}</strong>
                                <ul style="margin: 5px 0 0 15px; padding: 0;">
                                    ${items.map(item => `<li>${Utils.escape(item)}</li>`).join('')}
                                </ul>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        } else {
            breakdownHTML = `
                <div class="fds-section">
                    <div class="fds-section-title">ðŸ“¦ DÃ‰POUILLEMENT / BESOINS</div>
                    <p class="text-sec-italic">Aucun Ã©lÃ©ment de dÃ©pouillement pour les scÃ¨nes sÃ©lectionnÃ©es</p>
                </div>`;
        }
        
        // Nom du tournage
        const dayName = shootDay.name || `Jour ${shootDay.dayNumber || '?'}`;
        
        content.innerHTML = `
            <div class="fds-preview" id="fds-print-content">
                <div class="fds-header">
                    <div class="fds-title">${Utils.escape(state.data.title)}</div>
                    <div class="fds-subtitle">FEUILLE DE SERVICE</div>
                    <div class="mt-10">
                        <strong>${Utils.escape(dayName)}</strong> - ${dateStr}
                    </div>
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">ðŸŽ¬ PROGRAMME DU JOUR</div>
                    <table class="fds-table">
                        <thead>
                            <tr><th>Heure</th><th>ScÃ¨ne</th><th>Personnages</th><th>DurÃ©e</th><th>Plans</th></tr>
                        </thead>
                        <tbody>
                            ${scenesHTML || '<tr><td colspan="5" class="text-center">Aucune scÃ¨ne planifiÃ©e</td></tr>'}
                        </tbody>
                    </table>
                </div>
                
                ${locationHTML}
                
                <div class="fds-section">
                    <div class="fds-section-title">â° HORAIRES GÃ‰NÃ‰RAUX</div>
                    <table class="fds-table">
                        <tr>
                            <td><strong>Convocation Ã©quipe</strong></td>
                            <td>${shootDay.crewCall || '--:--'}</td>
                            <td><strong>PrÃªt Ã  tourner</strong></td>
                            <td>${shootDay.readyToShoot || '--:--'}</td>
                        </tr>
                        <tr>
                            <td><strong>Pause dÃ©jeuner</strong></td>
                            <td>${shootDay.lunchStart || '--:--'} - ${shootDay.lunchEnd || '--:--'}</td>
                            <td><strong>Fin estimÃ©e</strong></td>
                            <td>${shootDay.estimatedWrap || '--:--'}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">ðŸ“‹ CONVOCATIONS</div>
                    <table class="fds-table">
                        <thead>
                            <tr><th>Nom</th><th>Fonction</th><th>Convocation</th><th>Transport</th><th>Notes</th></tr>
                        </thead>
                        <tbody>
                            ${callsheetHTML || '<tr><td colspan="5" class="text-center">Aucune convocation</td></tr>'}
                        </tbody>
                    </table>
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">ðŸŒ¤ï¸ MÃ‰TÃ‰O PRÃ‰VUE</div>
                    ${weatherHTML}
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">ðŸŒ¡ï¸ MÃ‰TÃ‰O PERSONNALISÃ‰E / CONSIGNES</div>
                    <p style="white-space: pre-wrap;">${shootDay.customWeather ? Utils.escape(shootDay.customWeather) : '<span class="text-sec-italic">Vide</span>'}</p>
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">ðŸ“ NOTES GÃ‰NÃ‰RALES</div>
                    <p style="white-space: pre-wrap;">${shootDay.notes ? Utils.escape(shootDay.notes) : '<span class="text-sec-italic">Vide</span>'}</p>
                </div>
                
                ${breakdownHTML}
            </div>
        `;
        
        // Initialiser la carte Leaflet
        if(shootDay.locationLat && shootDay.locationLng) {
            setTimeout(() => {
                const mapContainer = document.getElementById('fds-map-container');
                if(mapContainer && typeof L !== 'undefined') {
                    const fdsMap = L.map(mapContainer, { zoomControl: true, attributionControl: false })
                        .setView([parseFloat(shootDay.locationLat), parseFloat(shootDay.locationLng)], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(fdsMap);
                    L.marker([parseFloat(shootDay.locationLat), parseFloat(shootDay.locationLng)]).addTo(fdsMap)
                        .bindPopup(`<strong>${Utils.escape(shootDay.location || 'Lieu')}</strong>`).openPopup();
                    Planning.currentFDSMap = fdsMap;
                }
            }, 100);
        }
    },
    
    printFDS: () => {
        const shootDay = Planning.currentFDSDay;
        if(!shootDay) return;
        
        // GÃ©nÃ©rer le nom du fichier
        const projectTitle = state.data.title || 'Projet';
        const dayName = shootDay.name || `J${shootDay.dayNumber || ''}`;
        const dateStr = shootDay.startDate || shootDay.date || '';
        const pdfTitle = `${projectTitle} - FDS ${dayName} - ${dateStr}`.replace(/[\/\\:*?"<>|]/g, '-');
        
        // PrÃ©parer le contenu avec le lien Google Maps en texte
        let content = document.getElementById('fds-print-content').innerHTML;
        
        // Ajouter le lien Google Maps en texte visible pour l'impression
        let gmapsTextHTML = '';
        if(shootDay.locationLat && shootDay.locationLng) {
            const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=${shootDay.locationLat},${shootDay.locationLng}`;
            gmapsTextHTML = `<p class="print-only-link" style="font-size: 10px; color: #666; word-break: break-all;">ðŸ—ºï¸ Google Maps: ${gmapsUrl}</p>`;
        }
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${Utils.escape(pdfTitle)}</title>
                <style>
                    body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; margin: 20px; }
                    .fds-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 15px; }
                    .fds-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
                    .fds-subtitle { font-size: 14px; }
                    .fds-section { margin-bottom: 15px; page-break-inside: avoid; }
                    .fds-section-title { font-weight: bold; background: #eee; padding: 5px; margin-bottom: 10px; }
.fds-gmaps-link-print { display: none; }
@media print { .fds-gmaps-link-print { display: block !important; } .fds-map-container, .fds-location-actions { display: none !important; } }
                    .fds-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
                    .fds-table th, .fds-table td { border: 1px solid #333; padding: 5px; text-align: left; }
                    .fds-table th { background: #ddd; }
                    .fds-weather-card { display: flex; gap: 15px; align-items: center; padding: 10px; background: #f0f7ff; border-radius: 8px; margin-bottom: 10px; flex-wrap: wrap; }
                    .fds-weather-icon { font-size: 2rem; }
                    .fds-weather-temp { font-size: 1.5rem; font-weight: bold; }
                    .fds-weather-row { display: flex; gap: 10px; flex-wrap: wrap; }
                    .fds-weather-item { padding: 3px 8px; background: #e0e0e0; border-radius: 10px; font-size: 11px; }
                    .fds-sun-times { display: flex; gap: 15px; font-size: 11px; margin-top: 5px; }
                    .fds-map-container { display: none; }
                    .fds-location-actions { display: none; }
                    .fds-gmaps-btn { display: none; }
                    .print-only-link { display: block; margin-top: 10px; }
                    @media screen {
                        .print-only-link { display: none; }
                    }
                    @page { margin: 15mm; }
                </style>
            </head>
            <body>${content}${gmapsTextHTML}</body>
            </html>
        `);
        printWindow.document.close();
        
        // Petit dÃ©lai pour que le titre soit bien pris en compte
        setTimeout(() => {
            printWindow.print();
        }, 100);
    },
    
    sendFDS: async () => {
        const shootDay = Planning.currentFDSDay;
        if(!shootDay) {
            Utils.toast('Aucune feuille de service chargÃ©e', 'error');
            return;
        }
        
        const projectName = state.data.title || 'Projet';
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'La production';
        
        // RÃ©cupÃ©rer mÃ©tÃ©o et lien GPS
        let weatherInfo = '';
        let gmapsLink = '';
        if(shootDay.locationLat && shootDay.locationLng) {
            gmapsLink = `\nðŸ—ºï¸ GPS : https://www.google.com/maps/search/?api=1&query=${shootDay.locationLat},${shootDay.locationLng}`;
            const weather = await Weather.fetch(shootDay.locationLat, shootDay.locationLng, shootDay.date);
            if(weather) {
                weatherInfo = `\n\nðŸŒ¤ï¸ MÃ©tÃ©o : ${weather.icon} ${weather.description}, ${weather.tempMin}Â°C - ${weather.tempMax}Â°C`;
                if(weather.precipitationProb > 30) weatherInfo += ` (${weather.precipitationProb}% pluie)`;
                weatherInfo += `\nðŸŒ… Soleil : ${weather.sunrise} - ${weather.sunset}`;
            }
        }
        
        // Collecter toutes les personnes Ã  notifier
        const recipients = [];
        
        // Parcourir la callSheet
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            for(const call of shootDay.callSheet) {
                let person = null;
                
                if(call.type === 'actor') {
                    person = state.data.actors.find(a => a.id === call.personId);
                } else if(call.type === 'crew') {
                    person = state.data.crew.find(c => c.id === call.personId);
                }
                
                if(person && person.email) {
                    recipients.push({
                        name: person.name || 'Inconnu',
                        email: person.email,
                        callTime: call.callTime || shootDay.crewCall || 'Ã€ confirmer',
                        notes: call.notes || ''
                    });
                }
            }
        }
        
        if(recipients.length === 0) {
            Utils.toast('Aucune personne avec email dans cette feuille de service', 'warning');
            return;
        }
        
        if(!await ConfirmModal.show({ title: 'Envoyer la feuille de service ?', message: `${recipients.length} destinataire(s) :\n\n${recipients.map(r => 'â€¢ ' + r.name).join('\n')}`, icon: 'ðŸ“§', confirmText: 'Envoyer' })) {
            return;
        }
        
        let sent = 0;
        let errors = 0;
        
        for(const recipient of recipients) {
            const subject = `ðŸŽ¬ Feuille de Service J${shootDay.dayNumber} - ${projectName}`;
            const content = `Bonjour ${recipient.name},

Vous avez reÃ§u une feuille de service pour le projet "${projectName}" :

ðŸ“… Date : ${dateFormatted}
ðŸŽ¬ Jour de tournage : J${shootDay.dayNumber}
ðŸ“ Lieu : ${shootDay.location || 'Ã€ confirmer'}${shootDay.locationAddress ? '\nðŸ“Œ Adresse : ' + shootDay.locationAddress : ''}${gmapsLink}${weatherInfo}

â° Votre convocation : ${recipient.callTime}
ðŸŽ¬ PrÃªt Ã  tourner : ${shootDay.readyToShoot || 'Ã€ confirmer'}
ðŸ½ï¸ Repas : ${shootDay.lunchStart || '?'} - ${shootDay.lunchEnd || '?'}
ðŸ Fin estimÃ©e : ${shootDay.estimatedWrap || 'Ã€ confirmer'}
${recipient.notes ? '\nðŸ“ Notes vous concernant : ' + recipient.notes : ''}
${shootDay.notes ? '\nðŸ“‹ Notes gÃ©nÃ©rales : ' + shootDay.notes : ''}

Merci de confirmer votre prÃ©sence.

Cordialement,
${senderName}
${projectName}`;

            try {
                // Envoyer message interne
                await Messages.send(recipient.email, {
                    subject: subject,
                    content: content,
                    type: 'callsheet',
                    projectId: state.currentProjectId,
                    projectName: projectName,
                    shootDayId: shootDay.id,
                    date: shootDay.date
                });
                
                // Envoyer email
                await Messages.sendEmailPing(recipient.email, recipient.name, 'callsheet', {
                    projectName: projectName,
                    shootDate: dateFormatted,
                    location: shootDay.location || 'Ã€ confirmer',
                    callTime: recipient.callTime,
                    senderName: senderName
                });
                
                sent++;
                console.log(`âœ… Convocation envoyÃ©e Ã  ${recipient.name}`);
            } catch(e) {
                console.error(`âŒ Erreur envoi Ã  ${recipient.name}:`, e);
                errors++;
            }
        }
        
        if(sent > 0) {
            Utils.toast(`${sent} convocation(s) envoyÃ©e(s) !`, 'success');
        }
        if(errors > 0) {
            Utils.toast(`${errors} erreur(s) d'envoi`, 'warning');
        }
    },
    
    // ========== CALENDRIER VISUEL V1.4.6 ==========
    availMonth: new Date().getMonth(),
    availYear: new Date().getFullYear(),
    
    // Export ICS pour Google Calendar / Outlook
    exportICS: () => {
        const shootingDays = state.data.shootingDays || [];
        
        if(shootingDays.length === 0) {
            Utils.toast('Aucun jour de tournage Ã  exporter', 'warning');
            return;
        }
        
        let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Moteur//Calendrier Tournage//FR
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${state.data.title || 'Tournage'}
`;
        
        shootingDays.forEach(day => {
            const startDate = day.startDate || day.date;
            const endDate = day.endDate || startDate;
            if(!startDate) return;
            
            const startDateStr = startDate.replace(/-/g, '');
            // ICS DTEND est exclusif, donc on ajoute 1 jour
            const endDateObj = new Date(endDate);
            endDateObj.setDate(endDateObj.getDate() + 1);
            const endDateStr = Planning.formatDate(endDateObj).replace(/-/g, '');
            
            const sceneTitles = (day.scenes || []).map(s => {
                const scene = state.data.scenes.find(sc => sc.id === s.sceneId);
                return scene ? scene.title : '';
            }).filter(t => t).join(', ');
            
            const uid = `${day.id}@filmmanagerpro`;
            const summary = `${day.name || 'Tournage'} - ${state.data.title || 'Projet'}`;
            const description = sceneTitles ? `ScÃ¨nes: ${sceneTitles}` : '';
            const location = day.location || '';
            
            icsContent += `BEGIN:VEVENT
UID:${uid}
DTSTART;VALUE=DATE:${startDateStr}
DTEND;VALUE=DATE:${endDateStr}
SUMMARY:${summary}
DESCRIPTION:${description.replace(/\n/g, '\\n')}
LOCATION:${location}
STATUS:CONFIRMED
END:VEVENT
`;
        });
        
        icsContent += 'END:VCALENDAR';
        
        // TÃ©lÃ©charger le fichier
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${(state.data.title || 'Tournage').replace(/\s+/g, '_')}_planning.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        Utils.toast(`${shootingDays.length} jour(s) exportÃ©(s) en .ICS`, 'success');
        History.log('ADD', 'Export calendrier ICS');
    },
    
    // Afficher la vue des disponibilitÃ©s
    showAvailabilityView: () => {
        const modal = document.getElementById('availability-modal');
        modal.style.display = 'flex';
        Planning.renderAvailabilityCalendar();
    },
    
    prevAvailMonth: () => {
        Planning.availMonth--;
        if(Planning.availMonth < 0) {
            Planning.availMonth = 11;
            Planning.availYear--;
        }
        Planning.renderAvailabilityCalendar();
    },
    
    nextAvailMonth: () => {
        Planning.availMonth++;
        if(Planning.availMonth > 11) {
            Planning.availMonth = 0;
            Planning.availYear++;
        }
        Planning.renderAvailabilityCalendar();
    },
    
    renderAvailabilityCalendar: () => {
        const container = document.getElementById('availability-calendar-container');
        const monthYearEl = document.getElementById('avail-month-year');
        
        const monthNames = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
        monthYearEl.textContent = `${monthNames[Planning.availMonth]} ${Planning.availYear}`;
        
        const year = Planning.availYear;
        const month = Planning.availMonth;
        
        // Premier jour du mois et nombre de jours
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        let startWeekDay = firstDay.getDay();
        if(startWeekDay === 0) startWeekDay = 7; // Lundi = 1
        
        // RÃ©cupÃ©rer les personnes (acteurs + techniciens)
        const actors = (state.data.actors || []).filter(a => a.name);
        const crew = (state.data.crew || []).filter(c => c.name);
        const people = [
            ...actors.map(a => ({ ...a, _type: 'ðŸŽ­', _personType: 'actor' })),
            ...crew.map(c => ({ ...c, _type: 'ðŸŽ¬', _personType: 'crew' }))
        ];
        
        // Jours de tournage
        const shootingDays = state.data.shootingDays || [];
        const shootingDates = new Set(shootingDays.map(d => d.date));
        
        // Construire le tableau
        let html = `<div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                <thead>
                    <tr class="bg-base">
                        <th style="padding: 10px; border: 1px solid var(--border); position: sticky; left: 0; background: var(--bg); z-index: 1;">Personne</th>`;
        
        for(let d = 1; d <= daysInMonth; d++) {
            const date = new Date(year, month, d);
            const dayName = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][date.getDay()];
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const isShooting = shootingDates.has(dateStr);
            
            html += `<th style="padding: 8px 5px; border: 1px solid var(--border); text-align: center; min-width: 45px; font-size: 0.8rem; ${isWeekend ? 'background: rgba(0,0,0,0.05);' : ''} ${isShooting ? 'background: rgba(76,175,80,0.3);' : ''}">
                ${dayName}<br><strong>${d}</strong>
                ${isShooting ? '<br>ðŸŽ¬' : ''}
            </th>`;
        }
        
        html += `</tr></thead><tbody>`;
        
        // Lignes pour chaque personne
        people.forEach(person => {
            html += `<tr>
                <td style="padding: 8px; border: 1px solid var(--border); position: sticky; left: 0; background: var(--panel-bg); z-index: 1; white-space: nowrap;">
                    ${person._type} ${Utils.escape(person.name)}
                </td>`;
            
            const availDates = person.availabilityDates || [];
            const unavailDates = person.unavailabilityDates || [];
            
            for(let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const date = new Date(year, month, d);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isShooting = shootingDates.has(dateStr);
                
                // VÃ©rifier disponibilitÃ©
                let isAvailable = false;
                availDates.forEach(range => {
                    if(range.from && range.to) {
                        if(dateStr >= range.from && dateStr <= range.to) {
                            isAvailable = true;
                        }
                    }
                });
                
                // VÃ©rifier indisponibilitÃ©
                let isUnavailable = false;
                unavailDates.forEach(range => {
                    if(range.from && range.to) {
                        if(dateStr >= range.from && dateStr <= range.to) {
                            isUnavailable = true;
                        }
                    }
                });
                
                let cellStyle = 'padding: 5px; border: 1px solid var(--border); text-align: center;';
                let cellContent = '';
                
                if(isWeekend) cellStyle += ' background: rgba(0,0,0,0.03);';
                
                // PrioritÃ© : Indisponible > Disponible > Non renseignÃ©
                if(isUnavailable) {
                    cellStyle += ' background: rgba(244, 67, 54, 0.3);';
                    cellContent = 'âœ—';
                } else if(isAvailable) {
                    cellStyle += ' background: rgba(33, 150, 243, 0.3);';
                    cellContent = 'âœ“';
                }
                
                // Jour de tournage
                if(isShooting) {
                    if(isUnavailable) {
                        cellStyle = 'padding: 5px; border: 1px solid var(--border); text-align: center; background: rgba(244, 67, 54, 0.5);';
                        cellContent = 'âš ï¸';
                    } else if(isAvailable) {
                        cellStyle = 'padding: 5px; border: 1px solid var(--border); text-align: center; background: rgba(76, 175, 80, 0.4);';
                        cellContent = 'ðŸŽ¬';
                    } else {
                        cellContent = 'ðŸŽ¬';
                    }
                }
                
                html += `<td style="${cellStyle}">${cellContent}</td>`;
            }
            
            html += `</tr>`;
        });
        
        html += `</tbody></table></div>`;
        
        if(people.length === 0) {
            html = `<div style="text-align: center; padding: 40px; color: var(--text-sec);">
                Ajoutez des comÃ©dienÂ·neÂ·s ou technicienÂ·neÂ·s avec leurs disponibilitÃ©s pour voir le calendrier.
            </div>`;
        }
        
        container.innerHTML = html;
    }
};
  
const Stats = {
      render: () => {
          const scenes = state.data.scenes;
          document.getElementById('stat-total-scenes').innerText = scenes.length;
          let totalTime = 0; 
          scenes.forEach(s => totalTime += parseFloat(s.time||0));
          document.getElementById('stat-total-time').innerText = Math.round(totalTime) + " min";
          
          let totalDial = 0; 
          const charCounts = {}; 
          const tagCounts = {};
          
          scenes.forEach(s => {
              const tid = s.tag_id || 't1'; 
              tagCounts[tid] = (tagCounts[tid] || 0) + 1;
              const div = document.createElement('div'); 
              div.innerHTML = s.scriptContent;
              const dials = div.querySelectorAll('.sc-dial'); 
              totalDial += dials.length;
              dials.forEach(d => {
                 const text = d.innerText.trim(); 
                 const words = text.split(/\s+/).filter(w => w.length > 0).length;
                 let prev = d.previousElementSibling; 
                 while(prev && !prev.classList.contains('sc-perso')) prev = prev.previousElementSibling;
                 if(prev) { 
                     const name = prev.innerText.trim().replace(/\(.*\)/,'').trim().toUpperCase(); 
                     charCounts[name] = (charCounts[name] || 0) + words; 
                 }
              });
          });
          
          document.getElementById('stat-total-dials').innerText = totalDial;
          Stats.drawBarChart('chart-chars', charCounts, 100);
          
          const tagData = {}; 
          state.data.tags.forEach(t => { 
              if(tagCounts[t.id]) tagData[t.name] = tagCounts[t.id]; 
          });
          Stats.drawBarChart('chart-tags', tagData, 10);
          
          // Lieux stats
          Stats.renderLieuxStats();
          
          // Crew stats
          Stats.renderCrewStats();
          
          // Shots stats
          Stats.renderShotsStats();
          
          // Actor days stats
          Stats.renderActorDaysStats();
          
          // Stats avancÃ©es V1.4.3
          Stats.renderAdvanced();
      },
      
      renderCrewStats: () => {
          const container = document.getElementById('chart-crew');
          if(!container) return;
          
          if(!state.data.crew || state.data.crew.length === 0) {
              container.innerHTML = '<div class="text-muted-center">Aucun technicien</div>';
              document.getElementById('stat-total-crew').innerText = '0';
              document.getElementById('stat-total-budget').innerText = '0 â‚¬';
              return;
          }
          
          document.getElementById('stat-total-crew').innerText = state.data.crew.length;
          
          let totalBudget = 0;
          state.data.crew.forEach(m => {
              if(m.dailyRate) {
                  totalBudget += parseFloat(m.dailyRate) || 0;
              }
          });
          document.getElementById('stat-total-budget').innerText = totalBudget.toLocaleString() + ' â‚¬/jour';
          
          const crewGroups = state.data.groups.filter(g => g.type === 'crew');
          const deptCounts = {};
          
          crewGroups.forEach(grp => {
              const count = state.data.crew.filter(m => m.group_id === grp.id).length;
              if(count > 0) {
                  deptCounts[grp.name] = count;
              }
          });
          
          const unassigned = state.data.crew.filter(m => !m.group_id).length;
          if(unassigned > 0) {
              deptCounts['Non classÃ©'] = unassigned;
          }
          
          Stats.drawBarChart('chart-crew', deptCounts, 15);
      },
      
	  renderActorDaysStats: () => {
          const container = document.getElementById('chart-actor-days');
          if(!container) return;
          
          const shootingDays = state.data.shootingDays || [];
          const actors = state.data.actors || [];
          
          if(actors.length === 0) {
              container.innerHTML = '<div class="text-muted-center">Aucun comÃ©dien</div>';
              return;
          }
          
          if(shootingDays.length === 0) {
              container.innerHTML = '<div class="text-muted-center">Aucun jour de tournage planifiÃ©</div>';
              return;
          }
          
          // Compter les jours par comÃ©dien
          const daysByActor = {};
          
          shootingDays.forEach(day => {
              if(!day.callSheet || day.callSheet.length === 0) return;
              
              day.callSheet.forEach(call => {
                  if(call.type === 'actor') {
                      const actor = actors.find(a => a.id === call.personId);
                      if(actor) {
                          const name = actor.name || 'Sans nom';
                          daysByActor[name] = (daysByActor[name] || 0) + 1;
                      }
                  }
              });
          });
          
          if(Object.keys(daysByActor).length === 0) {
              container.innerHTML = '<div class="text-muted-center">Aucun comÃ©dien convoquÃ©</div>';
              return;
          }
          
          Stats.drawBarChart('chart-actor-days', daysByActor, 20);
      },
      
	  renderLieuxStats: () => {
          const container = document.getElementById('chart-lieux');
          if(!container) return;
          
          const lieuxCounts = {};
          state.data.scenes.forEach(s => {
              if(!s.title) return;
              const locMatch = s.title.match(/^(?:INT\.|EXT\.|I\/E)\s*([^\-]+)/i);
              if(locMatch && locMatch[1]) {
                  const lieu = locMatch[1].trim().toUpperCase();
                  lieuxCounts[lieu] = (lieuxCounts[lieu] || 0) + 1;
              }
          });
          
          Stats.drawBarChart('chart-lieux', lieuxCounts, 100);
      },
	  
      renderShotsStats: () => {
          const container = document.getElementById('chart-shots');
          if(!container) return;
          
          if(!state.data.shots || state.data.shots.length === 0) {
              container.innerHTML = '<div class="text-muted-center">Aucun plan</div>';
              document.getElementById('stat-total-shots').innerText = '0';
              return;
          }
          
          document.getElementById('stat-total-shots').innerText = state.data.shots.length;
          
          const shotTypeCounts = {};
          state.data.shots.forEach(s => {
              if(s.shotType) {
                  shotTypeCounts[s.shotType] = (shotTypeCounts[s.shotType] || 0) + 1;
              }
          });
          
          Stats.drawBarChart('chart-shots', shotTypeCounts, 10);
      },
      
      drawBarChart: (id, dataObj, limit) => {
          const container = document.getElementById(id); 
          container.innerHTML = '';
          const sorted = Object.entries(dataObj).sort((a,b) => b[1] - a[1]).slice(0, limit);
          if(sorted.length === 0) { 
              container.innerHTML = '<div class="text-muted-center">Pas de donnÃ©es</div>'; 
              return; 
          }
          const max = sorted[0][1];
          sorted.forEach(([label, val]) => {
              const pct = (val / max) * 100; 
              const row = document.createElement('div'); 
              row.className = 'bar-row';
              row.innerHTML = `<div class="bar-label">${label}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div><div class="bar-val">${val}</div>`;
              
              // Rendre cliquable selon le type de chart
              if(id === 'chart-chars') {
                  row.style.cursor = 'pointer';
                  row.title = 'Cliquer pour voir les personnages';
                  row.onclick = () => {
                      app.UI.switchTab('personnages');
                  };
              } else if(id === 'chart-lieux') {
                  row.style.cursor = 'pointer';
                  row.title = 'Cliquer pour voir les lieux';
                  row.onclick = () => {
                      app.UI.switchTab('lieux');
                  };
              } else if(id === 'chart-crew') {
                  row.style.cursor = 'pointer';
                  row.title = 'Cliquer pour voir l\'Ã©quipe';
                  row.onclick = () => {
                      app.UI.switchTab('equipe');
                  };
              }
              
              container.appendChild(row);
          });
      },
      
      // ===== STATISTIQUES AVANCÃ‰ES V1.4.3 =====
      chartInstances: {},
      
      renderAdvanced: () => {
          Stats.renderProgressScenes();
          Stats.renderIntExtChart();
          Stats.renderJourNuitChart();
          Stats.renderBudgetChart();
          Stats.renderTimeTagsChart();
      },
      
      destroyChart: (chartId) => {
          if(Stats.chartInstances[chartId]) {
              Stats.chartInstances[chartId].destroy();
              delete Stats.chartInstances[chartId];
          }
      },
      
      // Barre de progression scÃ¨nes planifiÃ©es
      renderProgressScenes: () => {
          const totalScenes = state.data.scenes?.length || 0;
          const shootingDays = state.data.shootingDays || [];
          const plannedSceneIds = new Set();
          shootingDays.forEach(day => {
              (day.scenes || []).forEach(s => plannedSceneIds.add(s.sceneId));
          });
          const plannedCount = plannedSceneIds.size;
          const pct = totalScenes > 0 ? Math.round((plannedCount / totalScenes) * 100) : 0;
          
          const bar = document.getElementById('progress-scenes-planned');
          if(bar) {
              bar.style.width = pct + '%';
              bar.textContent = pct + '%';
          }
          
          const legend = document.getElementById('legend-scenes-planned');
          if(legend) {
              legend.innerHTML = `
                  <div class="stats-legend-item"><span class="stats-legend-color" style="background:#4CAF50"></span> PlanifiÃ©es: ${plannedCount}</div>
                  <div class="stats-legend-item"><span class="stats-legend-color" style="background:#ddd"></span> Total: ${totalScenes}</div>
              `;
          }
      },
      
      // Camembert INT/EXT
      renderIntExtChart: () => {
          const canvas = document.getElementById('chart-int-ext');
          if(!canvas) return;
          
          Stats.destroyChart('intExt');
          
          let intCount = 0, extCount = 0;
          (state.data.scenes || []).forEach(s => {
              const title = (s.title || '').toUpperCase();
              if(title.startsWith('INT')) intCount++;
              else if(title.startsWith('EXT')) extCount++;
          });
          
          if(intCount === 0 && extCount === 0) {
              canvas.parentElement.innerHTML = '<div class="empty-state-lg">Pas de donnÃ©es</div>';
              return;
          }
          
          Stats.chartInstances['intExt'] = new Chart(canvas, {
              type: 'doughnut',
              data: {
                  labels: ['IntÃ©rieur', 'ExtÃ©rieur'],
                  datasets: [{
                      data: [intCount, extCount],
                      backgroundColor: ['#2196F3', '#FF9800'],
                      borderWidth: 0
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { position: 'bottom' }
                  }
              }
          });
      },
      
      // Camembert JOUR/NUIT
      renderJourNuitChart: () => {
          const canvas = document.getElementById('chart-jour-nuit');
          if(!canvas) return;
          
          Stats.destroyChart('jourNuit');
          
          let jourCount = 0, nuitCount = 0, aubeCount = 0;
          (state.data.scenes || []).forEach(s => {
              const title = (s.title || '').toUpperCase();
              if(title.includes('JOUR')) jourCount++;
              else if(title.includes('NUIT')) nuitCount++;
              else if(title.includes('AUBE') || title.includes('CRÃ‰PUSCULE')) aubeCount++;
          });
          
          if(jourCount === 0 && nuitCount === 0 && aubeCount === 0) {
              canvas.parentElement.innerHTML = '<div class="empty-state-lg">Pas de donnÃ©es</div>';
              return;
          }
          
          const labels = ['Jour', 'Nuit'];
          const data = [jourCount, nuitCount];
          const colors = ['#FFC107', '#3F51B5'];
          
          if(aubeCount > 0) {
              labels.push('Aube/CrÃ©puscule');
              data.push(aubeCount);
              colors.push('#FF5722');
          }
          
          Stats.chartInstances['jourNuit'] = new Chart(canvas, {
              type: 'doughnut',
              data: {
                  labels: labels,
                  datasets: [{
                      data: data,
                      backgroundColor: colors,
                      borderWidth: 0
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { position: 'bottom' }
                  }
              }
          });
      },
      
      // Budget par catÃ©gorie + comparaison
      renderBudgetChart: () => {
          const canvas = document.getElementById('chart-budget-cat');
          if(!canvas) return;
          
          Stats.destroyChart('budgetCat');
          
          const expenses = state.data.expenses || [];
          const categories = {};
          let totalDepense = 0;
          
          expenses.forEach(exp => {
              if(exp.status === 'validated' || exp.status === 'pending') {
                  const cat = exp.category || 'Autre';
                  const amount = parseFloat(exp.amount) || 0;
                  categories[cat] = (categories[cat] || 0) + amount;
                  totalDepense += amount;
              }
          });
          
          // Budget prÃ©vu (depuis prÃ©sentation ou estimÃ©)
          const budgetPrevu = parseFloat(state.data.presentation?.budget) || 0;
          const reste = budgetPrevu - totalDepense;
          
          // Mise Ã  jour des valeurs
          document.getElementById('budget-prevu').textContent = budgetPrevu.toLocaleString('fr-FR') + ' â‚¬';
          document.getElementById('budget-depense').textContent = totalDepense.toLocaleString('fr-FR') + ' â‚¬';
          
          const resteEl = document.getElementById('budget-reste');
          resteEl.textContent = reste.toLocaleString('fr-FR') + ' â‚¬';
          resteEl.className = 'budget-item-value ' + (reste >= 0 ? 'positive' : 'negative');
          
          // Barre de progression budget
          const pctBudget = budgetPrevu > 0 ? Math.min(100, Math.round((totalDepense / budgetPrevu) * 100)) : 0;
          const barBudget = document.getElementById('progress-budget');
          if(barBudget) {
              barBudget.style.width = pctBudget + '%';
              barBudget.textContent = pctBudget + '% utilisÃ©';
              barBudget.style.background = pctBudget > 90 ? 'linear-gradient(90deg, #f44336, #E91E63)' : 'linear-gradient(90deg, #2196F3, #03A9F4)';
          }
          
          // Camembert catÃ©gories
          const catLabels = Object.keys(categories);
          const catData = Object.values(categories);
          
          if(catLabels.length === 0) {
              canvas.parentElement.innerHTML = '<div class="empty-state-lg">Aucune dÃ©pense</div>';
              return;
          }
          
          const catColors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#f44336', '#00BCD4', '#795548', '#607D8B'];
          
          Stats.chartInstances['budgetCat'] = new Chart(canvas, {
              type: 'pie',
              data: {
                  labels: catLabels,
                  datasets: [{
                      data: catData,
                      backgroundColor: catColors.slice(0, catLabels.length),
                      borderWidth: 0
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { position: 'bottom' }
                  }
              }
          });
      },
      
      // Temps par tag (barres horizontales)
      renderTimeTagsChart: () => {
          const canvas = document.getElementById('chart-time-tags');
          if(!canvas) return;
          
          Stats.destroyChart('timeTags');
          
          const tagTimes = {};
          const tagColors = {};
          
          (state.data.tags || []).forEach(t => {
              tagTimes[t.name] = 0;
              tagColors[t.name] = t.color || '#999';
          });
          
          (state.data.scenes || []).forEach(s => {
              const tag = (state.data.tags || []).find(t => t.id === s.tag_id);
              if(tag) {
                  tagTimes[tag.name] += parseFloat(s.time) || 0;
              }
          });
          
          const labels = Object.keys(tagTimes).filter(k => tagTimes[k] > 0);
          const data = labels.map(l => Math.round(tagTimes[l]));
          const colors = labels.map(l => tagColors[l]);
          
          if(labels.length === 0) {
              canvas.parentElement.innerHTML = '<div class="empty-state-lg">Pas de donnÃ©es</div>';
              return;
          }
          
          Stats.chartInstances['timeTags'] = new Chart(canvas, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Minutes',
                      data: data,
                      backgroundColor: colors,
                      borderWidth: 0,
                      borderRadius: 5
                  }]
              },
              options: {
                  indexAxis: 'y',
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { display: false }
                  },
                  scales: {
                      x: {
                          beginAtZero: true,
                          title: { display: true, text: 'Minutes' }
                      }
                  }
              }
          });
      }
  };
  
 const Exporter = {
    toPDF: (opts) => { 
        document.body.className = state.currentRole === 'viewer' ? 'read-only' : ''; 
        if(document.body.classList.contains('dark-mode')) document.body.classList.remove('dark-mode'); 
        document.getElementById('pc-title').innerText = state.data.title;
        document.getElementById('pc-author').innerText = opts.author ? `Auteur : ${opts.author}` : "";
        let contactHtml = ""; 
        if(opts.phone) contactHtml += `<p>TÃ©l : ${opts.phone}</p>`; 
        if(opts.web) contactHtml += `<p>Web : ${opts.web}</p>`; 
        if(opts.reg) contactHtml += `<p>DÃ©pÃ´t : ${opts.reg}</p>`;
        document.getElementById('pc-contact').innerHTML = contactHtml;
        
        if(opts.synop) document.body.classList.add('print-synopsis'); 
        if(opts.board) document.body.classList.add('print-board'); 
        if(opts.script) document.body.classList.add('print-script'); 
        if(opts.chars) document.body.classList.add('print-chars'); 
        if(opts.actors) document.body.classList.add('print-actors');
        if(opts.locs) document.body.classList.add('print-locs'); 
        if(opts.storyboard) {
            document.body.classList.add('print-storyboard');
            // Render print preview before printing
            Storyboard.renderPrintPreview('sbPrintPreview');
        }
        if(opts.crew) document.body.classList.add('print-crew');
        if(opts.breakdown) document.body.classList.add('print-breakdown'); 
        if(opts.stats) document.body.classList.add('print-stats');
        
        window.print(); 
        
        try { if(localStorage.getItem(CONFIG.themeKey) === 'dark') document.body.classList.add('dark-mode'); } catch(e) {} 
        if(state.currentRole === 'viewer') document.body.classList.add('read-only'); 
        document.body.className = document.body.className.replace(/print-\w+/g, "").trim();
    },
    
    // ========== RAPPORT DE PRODUCTION PDF ==========
    productionReport: () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = margin;
        
        const projectTitle = state.data.title || 'Projet sans titre';
        const today = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
        
        // ===== PAGE DE COUVERTURE =====
        doc.setFillColor(43, 110, 246);
        doc.rect(0, 0, pageWidth, 60, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(28);
        doc.setFont('helvetica', 'bold');
        doc.text('RAPPORT DE PRODUCTION', pageWidth / 2, 30, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Document gÃ©nÃ©rÃ© par Moteur', pageWidth / 2, 45, { align: 'center' });
        
        doc.setTextColor(50, 50, 50);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text(projectTitle, pageWidth / 2, 90, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text(`GÃ©nÃ©rÃ© le ${today}`, pageWidth / 2, 105, { align: 'center' });
        
        // Logo/Affiche si disponible
        if(state.data.poster) {
            try {
                doc.addImage(state.data.poster, 'JPEG', pageWidth/2 - 30, 115, 60, 80);
            } catch(e) {}
        }
        
        // ===== FONCTION UTILITAIRES =====
        const addSection = (title, yPos) => {
            if(yPos > pageHeight - 40) {
                doc.addPage();
                yPos = margin;
            }
            doc.setFillColor(43, 110, 246);
            doc.rect(margin, yPos, pageWidth - margin * 2, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(title, margin + 5, yPos + 7);
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            return yPos + 15;
        };
        
        const addKeyValue = (key, value, yPos) => {
            if(yPos > pageHeight - 20) {
                doc.addPage();
                yPos = margin;
            }
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(key + ' :', margin, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(String(value || '-'), margin + 45, yPos);
            return yPos + 6;
        };
        
        const addTable = (headers, rows, yPos, colWidths) => {
            const totalWidth = pageWidth - margin * 2;
            const rowHeight = 7;
            
            if(yPos > pageHeight - 40) {
                doc.addPage();
                yPos = margin;
            }
            
            // Header
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, yPos, totalWidth, rowHeight, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            let xPos = margin + 2;
            headers.forEach((h, i) => {
                doc.text(h, xPos, yPos + 5);
                xPos += colWidths[i];
            });
            yPos += rowHeight;
            
            // Rows
            doc.setFont('helvetica', 'normal');
            rows.forEach((row, idx) => {
                if(yPos > pageHeight - 20) {
                    doc.addPage();
                    yPos = margin;
                }
                if(idx % 2 === 1) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(margin, yPos, totalWidth, rowHeight, 'F');
                }
                xPos = margin + 2;
                row.forEach((cell, i) => {
                    const text = String(cell || '-').substring(0, 40);
                    doc.text(text, xPos, yPos + 5);
                    xPos += colWidths[i];
                });
                yPos += rowHeight;
            });
            
            return yPos + 5;
        };
        
        // ===== PAGE 2 : RÃ‰SUMÃ‰ GÃ‰NÃ‰RAL =====
        doc.addPage();
        y = margin;
        
        y = addSection('ðŸ“Š RÃ‰SUMÃ‰ GÃ‰NÃ‰RAL', y);
        
        const scenes = state.data.scenes || [];
        const characters = state.data.characters || [];
        const actors = state.data.actors || [];
        const locations = state.data.locations || [];
        const crew = state.data.crew || [];
        const shots = state.data.shots || [];
        const expenses = state.data.expenses || [];
        const shootingDays = state.data.shootingDays || [];
        
        y = addKeyValue('Titre du projet', projectTitle, y);
        y = addKeyValue('Nombre de scÃ¨nes', scenes.length, y);
        y = addKeyValue('Nombre de plans (storyboard)', shots.length, y);
        y = addKeyValue('Personnages', characters.length, y);
        y = addKeyValue('ComÃ©diens', actors.length, y);
        y = addKeyValue('DÃ©cors', locations.length, y);
        y = addKeyValue('Techniciens', crew.length, y);
        y = addKeyValue('Jours de tournage prÃ©vus', shootingDays.length, y);
        
        // DurÃ©e estimÃ©e
        const totalMinutes = scenes.reduce((sum, s) => sum + (parseFloat(s.time) || 0), 0);
        y = addKeyValue('DurÃ©e estimÃ©e', `${Math.floor(totalMinutes)} min`, y);
        
        // Budget
        const budget = state.data.budget || 0;
        const totalExpenses = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
        y = addKeyValue('Budget prÃ©vu', `${budget.toLocaleString('fr-FR')} â‚¬`, y);
        y = addKeyValue('DÃ©penses engagÃ©es', `${totalExpenses.toLocaleString('fr-FR')} â‚¬`, y);
        y = addKeyValue('Reste disponible', `${(budget - totalExpenses).toLocaleString('fr-FR')} â‚¬`, y);
        
        // Statistiques scÃ¨nes
        y += 5;
        y = addSection('ðŸŽ¬ STATISTIQUES SCÃˆNES', y);
        
        const intScenes = scenes.filter(s => s.title && s.title.toUpperCase().startsWith('INT')).length;
        const extScenes = scenes.filter(s => s.title && s.title.toUpperCase().startsWith('EXT')).length;
        const dayScenes = scenes.filter(s => s.title && s.title.toUpperCase().includes('JOUR')).length;
        const nightScenes = scenes.filter(s => s.title && s.title.toUpperCase().includes('NUIT')).length;
        const finalizedScenes = scenes.filter(s => s.isFinal).length;
        
        y = addKeyValue('IntÃ©rieur / ExtÃ©rieur', `${intScenes} INT / ${extScenes} EXT`, y);
        y = addKeyValue('Jour / Nuit', `${dayScenes} JOUR / ${nightScenes} NUIT`, y);
        y = addKeyValue('ScÃ¨nes finalisÃ©es', `${finalizedScenes} / ${scenes.length}`, y);
        
        // ===== PERSONNAGES =====
        if(characters.length > 0) {
            y += 5;
            y = addSection('ðŸŽ­ PERSONNAGES', y);
            const charRows = characters.map(c => {
                const actor = actors.find(a => a.characterId === c.id);
                return [c.name, c.age || '-', c.gender || '-', actor ? actor.name : '(non castÃ©)'];
            });
            y = addTable(['Personnage', 'Ã‚ge', 'Genre', 'ComÃ©dien'], charRows, y, [50, 25, 25, 60]);
        }
        
        // ===== COMÃ‰DIENS =====
        if(actors.length > 0) {
            y += 5;
            y = addSection('ðŸŽ¬ COMÃ‰DIENS', y);
            const actorRows = actors.map(a => {
                const char = characters.find(c => c.id === a.characterId);
                return [a.name, char ? char.name : '-', a.phone || '-', a.email || '-'];
            });
            y = addTable(['Nom', 'RÃ´le', 'TÃ©lÃ©phone', 'Email'], actorRows, y, [45, 40, 40, 55]);
        }
        
        // ===== Ã‰QUIPE TECHNIQUE =====
        if(crew.length > 0) {
            y += 5;
            y = addSection('ðŸ‘¥ Ã‰QUIPE TECHNIQUE', y);
            const crewRows = crew.map(c => [c.name, c.role || '-', c.department || '-', c.phone || '-']);
            y = addTable(['Nom', 'Poste', 'DÃ©partement', 'TÃ©lÃ©phone'], crewRows, y, [45, 45, 40, 50]);
        }
        
        // ===== DÃ‰CORS =====
        if(locations.length > 0) {
            y += 5;
            y = addSection('ðŸ“ DÃ‰CORS', y);
            const locRows = locations.map(l => {
                const sceneCount = scenes.filter(s => s.locationId === l.id || (s.title && s.title.includes(l.name))).length;
                return [l.name, l.realLocation || '-', l.address || '-', sceneCount + ' scÃ¨ne(s)'];
            });
            y = addTable(['DÃ©cor', 'Lieu rÃ©el', 'Adresse', 'ScÃ¨nes'], locRows, y, [40, 45, 55, 30]);
        }
        
        // ===== PLANNING =====
        if(shootingDays.length > 0) {
            y += 5;
            y = addSection('ðŸ“… PLANNING DE TOURNAGE', y);
            const planRows = shootingDays.map(d => {
                const date = d.startDate ? new Date(d.startDate).toLocaleDateString('fr-FR') : '-';
                const scenesList = (d.scenes || []).map(sId => {
                    const scene = scenes.find(s => s.id === sId);
                    return scene ? `#${scenes.indexOf(scene) + 1}` : '';
                }).filter(Boolean).join(', ');
                return [d.name || 'Jour', date, d.location || '-', scenesList || '-'];
            });
            y = addTable(['Nom', 'Date', 'Lieu', 'ScÃ¨nes'], planRows, y, [40, 30, 50, 50]);
        }
        
        // ===== BUDGET DÃ‰TAILLÃ‰ =====
        if(expenses.length > 0) {
            y += 5;
            y = addSection('ðŸ’° BUDGET & DÃ‰PENSES', y);
            
            // Par catÃ©gorie
            const byCategory = {};
            expenses.forEach(e => {
                const cat = e.category || 'Autre';
                if(!byCategory[cat]) byCategory[cat] = 0;
                byCategory[cat] += parseFloat(e.amount) || 0;
            });
            
            const budgetRows = Object.entries(byCategory).map(([cat, amount]) => [cat, amount.toLocaleString('fr-FR') + ' â‚¬']);
            budgetRows.push(['TOTAL', totalExpenses.toLocaleString('fr-FR') + ' â‚¬']);
            y = addTable(['CatÃ©gorie', 'Montant'], budgetRows, y, [100, 70]);
        }
        
        // ===== PIED DE PAGE SUR CHAQUE PAGE =====
        const totalPages = doc.internal.getNumberOfPages();
        for(let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`${projectTitle} - Rapport de production`, margin, pageHeight - 8);
            doc.text(`Page ${i}/${totalPages}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
        }
        
        // TÃ©lÃ©charger
        const filename = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'rapport') + '_production.pdf';
        doc.save(filename);
        
        Utils.toast('Rapport de production exportÃ© !', 'success');
        History.log('EXPORT', 'Rapport de production PDF gÃ©nÃ©rÃ©');
    },
    
    // ========== EXPORT ZIP COMPLET ==========
    exportZIP: async () => {
        Utils.toast('PrÃ©paration de l\'export ZIP...', 'info');
        
        // VÃ©rifier si JSZip est disponible, sinon le charger
        if(typeof JSZip === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.onload = () => Exporter.doExportZIP();
            script.onerror = () => Utils.toast('Erreur de chargement de JSZip', 'error');
            document.head.appendChild(script);
        } else {
            Exporter.doExportZIP();
        }
    },
    
    doExportZIP: async () => {
        try {
            const zip = new JSZip();
            const projectTitle = state.data.title || 'projet';
            const folderName = projectTitle.replace(/[^a-z0-9]/gi, '_');
            const folder = zip.folder(folderName);
            const pdfFolder = folder.folder('PDF');
            const csvFolder = folder.folder('CSV');
            
            Utils.toast('GÃ©nÃ©ration des fichiers...', 'info');
            
            // 1. DonnÃ©es JSON du projet (pour rÃ©import dans Moteur)
            folder.file('projet_data.json', JSON.stringify(state.data, null, 2));
            
            // ===== GÃ‰NÃ‰RATION DES PDFs =====
            const { jsPDF } = window.jspdf;
            const margin = 15;
            const today = new Date().toLocaleDateString('fr-FR');
            
            // Helper : Header unifiÃ© pour tous les PDFs du ZIP
            const zipHeader = (doc, title, subtitle) => {
                const pw = doc.internal.pageSize.getWidth();
                doc.setFillColor(43, 110, 246);
                doc.rect(0, 0, pw, 35, 'F');
                doc.setFillColor(30, 85, 210);
                doc.rect(0, 32, pw, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(title, pw / 2, 16, { align: 'center' });
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(190, 215, 255);
                doc.text(subtitle || projectTitle, pw / 2, 27, { align: 'center' });
                doc.setTextColor(50, 50, 50);
            };
            
            // Helper : Footer unifiÃ© pour tous les PDFs du ZIP
            const zipFooter = (doc, label) => {
                const tp = doc.internal.getNumberOfPages();
                const pw = doc.internal.pageSize.getWidth();
                const ph = doc.internal.pageSize.getHeight();
                for(let i = 1; i <= tp; i++) {
                    doc.setPage(i);
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, ph - 12, pw - margin, ph - 12);
                    doc.setFontSize(7);
                    doc.setTextColor(150, 150, 150);
                    doc.text(projectTitle + (label ? ' â€” ' + label : ''), margin, ph - 7);
                    doc.text('GÃ©nÃ©rÃ© par Moteur â€” moteur.studio', pw / 2, ph - 7, { align: 'center' });
                    doc.text('Page ' + i + '/' + tp, pw - margin, ph - 7, { align: 'right' });
                }
            };
            
            // Helper : Titre de section colorÃ©
            const zipSection = (doc, title, rgb, yPos) => {
                const pw = doc.internal.pageSize.getWidth();
                doc.setFillColor(rgb[0], rgb[1], rgb[2]);
                doc.roundedRect(margin, yPos, pw - margin * 2, 8, 1.5, 1.5, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text(title, margin + 4, yPos + 5.5);
                doc.setTextColor(50, 50, 50);
                doc.setFont('helvetica', 'normal');
                return yPos + 12;
            };
            
            // PDF 1 : ScÃ©nario
            if(state.data.scenes && state.data.scenes.length > 0) {
                const docScenario = new jsPDF('p', 'mm', 'a4');
                const pw = docScenario.internal.pageSize.getWidth();
                const ph = docScenario.internal.pageSize.getHeight();
                
                // Page de couverture
                docScenario.setFillColor(43, 110, 246);
                docScenario.rect(0, 0, pw, 70, 'F');
                docScenario.setFillColor(30, 85, 210);
                docScenario.rect(0, 66, pw, 4, 'F');
                docScenario.setTextColor(255, 255, 255);
                docScenario.setFontSize(28);
                docScenario.setFont('helvetica', 'bold');
                docScenario.text('SCÃ‰NARIO', pw / 2, 30, { align: 'center' });
                docScenario.setFontSize(16);
                docScenario.setFont('helvetica', 'normal');
                docScenario.text(projectTitle, pw / 2, 48, { align: 'center' });
                docScenario.setFontSize(10);
                docScenario.setTextColor(180, 210, 255);
                docScenario.text(state.data.scenes.length + ' scÃ¨ne(s) â€¢ ' + today, pw / 2, 60, { align: 'center' });
                
                const meta = state.data.scriptMeta || {};
                let metaY = 90;
                docScenario.setTextColor(100, 100, 100);
                docScenario.setFontSize(11);
                if(meta.author) { docScenario.text('Ã‰crit par ' + meta.author, pw / 2, metaY, { align: 'center' }); metaY += 8; }
                if(meta.draft) { docScenario.text(meta.draft, pw / 2, metaY, { align: 'center' }); metaY += 8; }
                
                docScenario.addPage();
                let yPos = 45;
                
                state.data.scenes.forEach((scene, idx) => {
                    if(yPos > ph - 30) { docScenario.addPage(); yPos = 45; }
                    
                    // En-tÃªte scÃ¨ne
                    docScenario.setFillColor(240, 242, 245);
                    docScenario.rect(margin, yPos - 5, pw - margin * 2, 9, 'F');
                    docScenario.setFontSize(10);
                    docScenario.setFont('helvetica', 'bold');
                    docScenario.setTextColor(43, 110, 246);
                    docScenario.text(`#${idx + 1} â€” ${scene.title || 'Sans titre'}`, margin + 3, yPos + 1);
                    docScenario.setTextColor(50, 50, 50);
                    yPos += 10;
                    
                    if(scene.scriptContent) {
                        docScenario.setFontSize(9.5);
                        docScenario.setFont('helvetica', 'normal');
                        const text = scene.scriptContent.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ');
                        const lines = docScenario.splitTextToSize(text, pw - margin * 2);
                        lines.forEach(line => {
                            if(yPos > ph - 18) { docScenario.addPage(); yPos = 45; }
                            docScenario.text(line, margin, yPos);
                            yPos += 4.5;
                        });
                    }
                    yPos += 8;
                });
                
                // Header sur chaque page sauf la premiÃ¨re (couverture)
                const tp = docScenario.internal.getNumberOfPages();
                for(let i = 2; i <= tp; i++) {
                    docScenario.setPage(i);
                    docScenario.setFillColor(43, 110, 246);
                    docScenario.rect(0, 0, pw, 12, 'F');
                    docScenario.setTextColor(255, 255, 255);
                    docScenario.setFontSize(8);
                    docScenario.setFont('helvetica', 'bold');
                    docScenario.text('SCÃ‰NARIO â€” ' + projectTitle, margin, 8);
                    docScenario.setFont('helvetica', 'normal');
                    docScenario.text('Page ' + (i - 1), pw - margin, 8, { align: 'right' });
                }
                zipFooter(docScenario, 'ScÃ©nario');
                pdfFolder.file('Scenario.pdf', docScenario.output('blob'));
            }
            
            // PDF 2 : SÃ©quencier
            if(state.data.scenes && state.data.scenes.length > 0) {
                const docSeq = new jsPDF('l', 'mm', 'a4');
                const pw = docSeq.internal.pageSize.getWidth();
                const ph = docSeq.internal.pageSize.getHeight();
                
                zipHeader(docSeq, 'SÃ‰QUENCIER', projectTitle + ' â€¢ ' + state.data.scenes.length + ' scÃ¨ne(s)');
                let yPos = 43;
                
                // En-tÃªtes tableau
                const drawSeqHeaders = (doc, y) => {
                    doc.setFillColor(240, 242, 245);
                    doc.rect(margin, y, pw - margin * 2, 7, 'F');
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(7.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text('NÂ°', margin + 2, y + 5);
                    doc.text('IntitulÃ©', margin + 15, y + 5);
                    doc.text('INT/EXT', margin + 90, y + 5);
                    doc.text('DurÃ©e', margin + 115, y + 5);
                    doc.text('Personnages', margin + 135, y + 5);
                    doc.text('RÃ©sumÃ©', margin + 195, y + 5);
                    doc.setFont('helvetica', 'normal');
                    return y + 9;
                };
                yPos = drawSeqHeaders(docSeq, yPos);
                
                docSeq.setFontSize(8);
                state.data.scenes.forEach((scene, idx) => {
                    if(yPos > ph - 18) { docSeq.addPage(); zipHeader(docSeq, 'SÃ‰QUENCIER', projectTitle); yPos = drawSeqHeaders(docSeq, 43); }
                    
                    if(idx % 2 === 0) {
                        docSeq.setFillColor(250, 250, 252);
                        docSeq.rect(margin, yPos - 3.5, pw - margin * 2, 7, 'F');
                    }
                    
                    docSeq.setTextColor(43, 110, 246);
                    docSeq.setFont('helvetica', 'bold');
                    docSeq.text(`${idx + 1}`, margin + 2, yPos);
                    docSeq.setTextColor(50, 50, 50);
                    docSeq.setFont('helvetica', 'normal');
                    docSeq.text((scene.title || '').substring(0, 35), margin + 15, yPos);
                    docSeq.text((scene.lieu || '-').substring(0, 12), margin + 90, yPos);
                    docSeq.text(scene.time || '-', margin + 115, yPos);
                    docSeq.text((scene.perso || '').substring(0, 28), margin + 135, yPos);
                    docSeq.text((scene.resume || '').substring(0, 45), margin + 195, yPos);
                    yPos += 7;
                });
                zipFooter(docSeq, 'SÃ©quencier');
                pdfFolder.file('Sequencier.pdf', docSeq.output('blob'));
            }
            
            // PDF 3 : Ã‰quipe
            if(state.data.crew && state.data.crew.length > 0) {
                const docCrew = new jsPDF('p', 'mm', 'a4');
                const pw = docCrew.internal.pageSize.getWidth();
                const ph = docCrew.internal.pageSize.getHeight();
                const actors = state.data.actors || [];
                
                zipHeader(docCrew, 'Ã‰QUIPE', projectTitle + ' â€¢ ' + (state.data.crew.length + actors.length) + ' membre(s)');
                let yPos = 43;
                
                // ComÃ©diens
                if(actors.length > 0) {
                    yPos = zipSection(docCrew, 'COMÃ‰DIENS (' + actors.length + ')', [76, 175, 80], yPos);
                    
                    docCrew.setFillColor(240, 242, 245);
                    docCrew.rect(margin, yPos, pw - margin * 2, 7, 'F');
                    docCrew.setTextColor(100, 100, 100);
                    docCrew.setFontSize(7.5);
                    docCrew.setFont('helvetica', 'bold');
                    docCrew.text('ComÃ©dien', margin + 3, yPos + 5);
                    docCrew.text('RÃ´le', margin + 50, yPos + 5);
                    docCrew.text('TÃ©lÃ©phone', margin + 95, yPos + 5);
                    docCrew.text('Email', margin + 130, yPos + 5);
                    yPos += 9;
                    
                    actors.forEach((actor, idx) => {
                        if(yPos > ph - 18) { docCrew.addPage(); yPos = margin + 5; }
                        if(idx % 2 === 0) { docCrew.setFillColor(250, 250, 252); docCrew.rect(margin, yPos - 3.5, pw - margin * 2, 7, 'F'); }
                        const character = state.data.characters?.find(c => c.id === actor.characterId);
                        docCrew.setFontSize(8);
                        docCrew.setFont('helvetica', 'normal');
                        docCrew.setTextColor(50, 50, 50);
                        docCrew.text((actor.name || '-').substring(0, 25), margin + 3, yPos);
                        docCrew.text((character?.name || '-').substring(0, 22), margin + 50, yPos);
                        docCrew.text((actor.phone || '-').substring(0, 18), margin + 95, yPos);
                        docCrew.setTextColor(43, 110, 246);
                        docCrew.text((actor.email || '-').substring(0, 28), margin + 130, yPos);
                        docCrew.setTextColor(50, 50, 50);
                        yPos += 7;
                    });
                    yPos += 6;
                }
                
                // Techniciens par dÃ©partement
                const depts = {};
                state.data.crew.forEach(c => { const d = c.department || 'Autre'; if(!depts[d]) depts[d] = []; depts[d].push(c); });
                
                const deptColors = {
                    'RÃ©alisation': [156, 39, 176], 'Image': [33, 150, 243], 'Son': [0, 188, 212],
                    'LumiÃ¨re': [255, 193, 7], 'DÃ©cor': [121, 85, 72], 'HMC': [233, 30, 99],
                    'RÃ©gie': [255, 152, 0], 'Post-production': [96, 125, 139], 'Production': [76, 175, 80]
                };
                
                Object.entries(depts).forEach(([dept, members]) => {
                    if(yPos > ph - 35) { docCrew.addPage(); yPos = margin + 5; }
                    const rgb = deptColors[dept] || [100, 100, 100];
                    yPos = zipSection(docCrew, dept.toUpperCase() + ' (' + members.length + ')', rgb, yPos);
                    
                    members.forEach((c, idx) => {
                        if(yPos > ph - 15) { docCrew.addPage(); yPos = margin + 5; }
                        if(idx % 2 === 0) { docCrew.setFillColor(250, 250, 252); docCrew.rect(margin, yPos - 3.5, pw - margin * 2, 7, 'F'); }
                        docCrew.setFontSize(8);
                        docCrew.setFont('helvetica', 'normal');
                        docCrew.setTextColor(50, 50, 50);
                        docCrew.text((c.name || '-').substring(0, 22), margin + 3, yPos);
                        docCrew.setTextColor(100, 100, 100);
                        docCrew.text((c.role || '-').substring(0, 22), margin + 50, yPos);
                        docCrew.setTextColor(50, 50, 50);
                        docCrew.text((c.phone || '').substring(0, 18), margin + 95, yPos);
                        docCrew.setTextColor(43, 110, 246);
                        docCrew.text((c.email || '').substring(0, 28), margin + 130, yPos);
                        docCrew.setTextColor(50, 50, 50);
                        yPos += 7;
                    });
                    yPos += 4;
                });
                zipFooter(docCrew, 'Ã‰quipe');
                pdfFolder.file('Equipe.pdf', docCrew.output('blob'));
            }
            
            // PDF 4 : Budget
            if(state.data.expenses && state.data.expenses.length > 0) {
                const docBudget = new jsPDF('p', 'mm', 'a4');
                const pw = docBudget.internal.pageSize.getWidth();
                const ph = docBudget.internal.pageSize.getHeight();
                const currency = state.data.budget?.currency || 'â‚¬';
                const vatMode = state.data.budget?.vatMode || 'HT';
                const budget = state.data.budget?.total || 0;
                const totalSpent = state.data.expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
                
                zipHeader(docBudget, 'BUDGET', projectTitle + ' â€¢ Mode ' + vatMode);
                let yPos = 43;
                
                // RÃ©sumÃ©
                docBudget.setFillColor(245, 247, 250);
                docBudget.roundedRect(margin, yPos, pw - margin * 2, 16, 2, 2, 'F');
                docBudget.setDrawColor(43, 110, 246);
                docBudget.setLineWidth(0.3);
                docBudget.roundedRect(margin, yPos, pw - margin * 2, 16, 2, 2, 'S');
                docBudget.setLineWidth(0.2);
                docBudget.setFontSize(9);
                docBudget.setFont('helvetica', 'bold');
                docBudget.setTextColor(50, 50, 50);
                docBudget.text('PrÃ©visionnel : ' + budget.toLocaleString('fr-FR') + ' ' + currency, margin + 5, yPos + 7);
                docBudget.setTextColor(76, 175, 80);
                docBudget.text('DÃ©pensÃ© : ' + totalSpent.toLocaleString('fr-FR') + ' ' + currency, margin + 70, yPos + 7);
                const resteZip = budget - totalSpent;
                docBudget.setTextColor(resteZip < 0 ? 220 : 43, resteZip < 0 ? 53 : 110, resteZip < 0 ? 69 : 246);
                docBudget.text('Reste : ' + resteZip.toLocaleString('fr-FR') + ' ' + currency, margin + 135, yPos + 7);
                docBudget.setTextColor(50, 50, 50);
                yPos += 24;
                
                // Tableau dÃ©penses
                yPos = zipSection(docBudget, 'DÃ‰PENSES (' + state.data.expenses.length + ')', [96, 125, 139], yPos);
                
                const drawBudgetHeaders = (doc, y) => {
                    doc.setFillColor(240, 242, 245);
                    doc.rect(margin, y, pw - margin * 2, 7, 'F');
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(7.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Description', margin + 3, y + 5);
                    doc.text('CatÃ©gorie', margin + 70, y + 5);
                    doc.text('Montant', margin + 120, y + 5);
                    doc.text('Statut', margin + 155, y + 5);
                    doc.setFont('helvetica', 'normal');
                    return y + 9;
                };
                yPos = drawBudgetHeaders(docBudget, yPos);
                
                const statusColorsZip = { pending: [255, 152, 0], approved: [76, 175, 80], rejected: [220, 53, 69], done: [43, 110, 246], escalated: [156, 39, 176], returned: [96, 125, 139] };
                
                state.data.expenses.forEach((e, idx) => {
                    if(yPos > ph - 18) { docBudget.addPage(); yPos = margin + 5; yPos = drawBudgetHeaders(docBudget, yPos); }
                    if(idx % 2 === 0) { docBudget.setFillColor(250, 250, 252); docBudget.rect(margin, yPos - 3.5, pw - margin * 2, 6.5, 'F'); }
                    docBudget.setFontSize(7.5);
                    docBudget.setTextColor(50, 50, 50);
                    docBudget.text((e.title || e.description || '').substring(0, 32), margin + 3, yPos);
                    docBudget.text((e.category || '').substring(0, 22), margin + 70, yPos);
                    docBudget.text((parseFloat(e.amount) || 0).toLocaleString('fr-FR') + ' ' + currency, margin + 120, yPos);
                    const sc = statusColorsZip[e.status] || [100, 100, 100];
                    docBudget.setTextColor(sc[0], sc[1], sc[2]);
                    docBudget.setFont('helvetica', 'bold');
                    docBudget.text(EXPENSE_STATUS_LABELS[e.status] || e.status || '-', margin + 155, yPos);
                    docBudget.setFont('helvetica', 'normal');
                    docBudget.setTextColor(50, 50, 50);
                    yPos += 6;
                });
                zipFooter(docBudget, 'Budget');
                pdfFolder.file('Budget.pdf', docBudget.output('blob'));
            }
            
            // PDF 5 : Planning
            if(state.data.shootingDays && state.data.shootingDays.length > 0) {
                const docPlanning = new jsPDF('l', 'mm', 'a4');
                const pw = docPlanning.internal.pageSize.getWidth();
                const ph = docPlanning.internal.pageSize.getHeight();
                
                zipHeader(docPlanning, 'PLANNING DE TOURNAGE', projectTitle + ' â€¢ ' + state.data.shootingDays.length + ' jour(s)');
                let yPos = 43;
                
                const drawPlanHeaders = (doc, y) => {
                    doc.setFillColor(240, 242, 245);
                    doc.rect(margin, y, pw - margin * 2, 7, 'F');
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(7.5);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Jour', margin + 3, y + 5);
                    doc.text('Date', margin + 45, y + 5);
                    doc.text('Lieu', margin + 85, y + 5);
                    doc.text('ScÃ¨nes', margin + 175, y + 5);
                    doc.setFont('helvetica', 'normal');
                    return y + 9;
                };
                yPos = drawPlanHeaders(docPlanning, yPos);
                
                state.data.shootingDays.forEach((d, idx) => {
                    if(yPos > ph - 18) { docPlanning.addPage(); zipHeader(docPlanning, 'PLANNING DE TOURNAGE', projectTitle); yPos = drawPlanHeaders(docPlanning, 43); }
                    
                    if(idx % 2 === 0) {
                        docPlanning.setFillColor(250, 250, 252);
                        docPlanning.rect(margin, yPos - 3.5, pw - margin * 2, 7, 'F');
                    }
                    
                    docPlanning.setFontSize(8);
                    docPlanning.setTextColor(43, 110, 246);
                    docPlanning.setFont('helvetica', 'bold');
                    docPlanning.text('J' + (idx + 1), margin + 3, yPos);
                    docPlanning.setTextColor(50, 50, 50);
                    docPlanning.setFont('helvetica', 'normal');
                    docPlanning.text((d.name || '').substring(0, 18), margin + 14, yPos);
                    docPlanning.text(d.startDate ? new Date(d.startDate).toLocaleDateString('fr-FR') : '-', margin + 45, yPos);
                    docPlanning.text((d.location || '-').substring(0, 40), margin + 85, yPos);
                    const scenesList = (d.scenes || []).map(sId => { const i = state.data.scenes?.findIndex(s => s.id === sId); return i >= 0 ? '#' + (i + 1) : ''; }).filter(Boolean).join(', ');
                    docPlanning.text(scenesList.substring(0, 50), margin + 175, yPos);
                    yPos += 7;
                });
                zipFooter(docPlanning, 'Planning');
                pdfFolder.file('Planning.pdf', docPlanning.output('blob'));
            }
            
            // PDF 6 : Personnages & ComÃ©diens
            if((state.data.characters && state.data.characters.length > 0) || (state.data.actors && state.data.actors.length > 0)) {
                const docCasting = new jsPDF('p', 'mm', 'a4');
                const pw = docCasting.internal.pageSize.getWidth();
                const ph = docCasting.internal.pageSize.getHeight();
                
                zipHeader(docCasting, 'CASTING', projectTitle);
                let yPos = 43;
                
                if(state.data.characters && state.data.characters.length > 0) {
                    yPos = zipSection(docCasting, 'PERSONNAGES (' + state.data.characters.length + ')', [156, 39, 176], yPos);
                    
                    state.data.characters.forEach((c, idx) => {
                        if(yPos > ph - 25) { docCasting.addPage(); yPos = margin + 5; }
                        
                        if(idx % 2 === 0) { docCasting.setFillColor(250, 250, 252); docCasting.rect(margin, yPos - 4, pw - margin * 2, 10, 'F'); }
                        
                        const actor = state.data.actors?.find(a => a.characterId === c.id);
                        docCasting.setFontSize(9);
                        docCasting.setFont('helvetica', 'bold');
                        docCasting.setTextColor(50, 50, 50);
                        docCasting.text((c.name || 'Sans nom') + (c.age ? ' (' + c.age + ')' : ''), margin + 3, yPos);
                        
                        if(actor) {
                            docCasting.setFont('helvetica', 'normal');
                            docCasting.setTextColor(43, 110, 246);
                            docCasting.text('â†’ ' + actor.name, margin + 75, yPos);
                            docCasting.setTextColor(50, 50, 50);
                        }
                        yPos += 5;
                        
                        if(c.description) {
                            docCasting.setFontSize(7.5);
                            docCasting.setFont('helvetica', 'normal');
                            docCasting.setTextColor(100, 100, 100);
                            const lines = docCasting.splitTextToSize(c.description, pw - margin * 2 - 6);
                            lines.slice(0, 2).forEach(line => {
                                docCasting.text(line, margin + 5, yPos);
                                yPos += 3.8;
                            });
                            docCasting.setTextColor(50, 50, 50);
                        }
                        yPos += 3;
                    });
                    yPos += 6;
                }
                
                // Section ComÃ©diens
                const actors = state.data.actors || [];
                if(actors.length > 0 && yPos < ph - 30) {
                    yPos = zipSection(docCasting, 'COMÃ‰DIENS (' + actors.length + ')', [76, 175, 80], yPos);
                    actors.forEach((a, idx) => {
                        if(yPos > ph - 15) { docCasting.addPage(); yPos = margin + 5; }
                        if(idx % 2 === 0) { docCasting.setFillColor(250, 250, 252); docCasting.rect(margin, yPos - 3.5, pw - margin * 2, 7, 'F'); }
                        docCasting.setFontSize(8);
                        docCasting.setFont('helvetica', 'normal');
                        docCasting.setTextColor(50, 50, 50);
                        docCasting.text((a.name || '-').substring(0, 25), margin + 3, yPos);
                        docCasting.text((a.phone || '').substring(0, 18), margin + 60, yPos);
                        docCasting.setTextColor(43, 110, 246);
                        docCasting.text((a.email || '').substring(0, 30), margin + 100, yPos);
                        docCasting.setTextColor(50, 50, 50);
                        yPos += 7;
                    });
                }
                zipFooter(docCasting, 'Casting');
                pdfFolder.file('Casting.pdf', docCasting.output('blob'));
            }
            
            // PDF 7 : DÃ©cors
            if(state.data.locations && state.data.locations.length > 0) {
                const docDecors = new jsPDF('p', 'mm', 'a4');
                const pw = docDecors.internal.pageSize.getWidth();
                const ph = docDecors.internal.pageSize.getHeight();
                
                zipHeader(docDecors, 'DÃ‰CORS & LIEUX', projectTitle + ' â€¢ ' + state.data.locations.length + ' dÃ©cor(s)');
                let yPos = 43;
                
                state.data.locations.forEach((loc, idx) => {
                    if(yPos > ph - 30) { docDecors.addPage(); yPos = margin + 5; }
                    
                    // Carte dÃ©cor
                    docDecors.setFillColor(245, 247, 250);
                    const cardH = 8 + (loc.realLocation ? 5 : 0) + (loc.address ? 5 : 0) + (loc.contact ? 5 : 0) + (loc.notes ? 5 : 0);
                    docDecors.roundedRect(margin, yPos, pw - margin * 2, cardH + 4, 2, 2, 'F');
                    docDecors.setDrawColor(220, 220, 220);
                    docDecors.roundedRect(margin, yPos, pw - margin * 2, cardH + 4, 2, 2, 'S');
                    
                    yPos += 6;
                    docDecors.setFontSize(10);
                    docDecors.setFont('helvetica', 'bold');
                    docDecors.setTextColor(43, 110, 246);
                    docDecors.text((idx + 1) + '. ' + (loc.name || 'Sans nom'), margin + 5, yPos);
                    yPos += 6;
                    
                    docDecors.setFontSize(8);
                    docDecors.setFont('helvetica', 'normal');
                    docDecors.setTextColor(80, 80, 80);
                    if(loc.realLocation) { docDecors.text('Lieu rÃ©el : ' + loc.realLocation, margin + 8, yPos); yPos += 5; }
                    if(loc.address) { docDecors.text('Adresse : ' + loc.address, margin + 8, yPos); yPos += 5; }
                    if(loc.contact) { docDecors.text('Contact : ' + loc.contact, margin + 8, yPos); yPos += 5; }
                    if(loc.notes) { docDecors.text('Notes : ' + (loc.notes || '').substring(0, 60), margin + 8, yPos); yPos += 5; }
                    docDecors.setTextColor(50, 50, 50);
                    yPos += 6;
                });
                zipFooter(docDecors, 'DÃ©cors');
                pdfFolder.file('Decors.pdf', docDecors.output('blob'));
            }
            
            // ===== FICHIERS SOURCES (Fountain, CSV) =====
            
            // Fountain du scÃ©nario
            if(state.data.scenes && state.data.scenes.length > 0) {
                let fountain = `Title: ${state.data.title || 'Sans titre'}\n`;
                const meta = state.data.scriptMeta || {};
                if(meta.author) fountain += `Author: ${meta.author}\n`;
                if(meta.draft) fountain += `Draft date: ${meta.draft}\n`;
                fountain += '\n';
                
                state.data.scenes.forEach(scene => {
                    fountain += `\n${scene.title}\n\n`;
                    if(scene.scriptContent) {
                        fountain += scene.scriptContent.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ') + '\n';
                    }
                });
                folder.file('scenario.fountain', fountain);
            }
            
            // CSVs dans sous-dossier
            if(state.data.characters && state.data.characters.length > 0) {
                let csv = 'Nom;Age;Genre;Description\n';
                state.data.characters.forEach(c => {
                    csv += `"${c.name || ''}";"${c.age || ''}";"${c.gender || ''}";"${(c.description || '').replace(/"/g, '""')}"\n`;
                });
                csvFolder.file('personnages.csv', csv);
            }
            
            if(state.data.actors && state.data.actors.length > 0) {
                let csv = 'Nom;Role;Email;Telephone;Adresse\n';
                state.data.actors.forEach(a => {
                    const char = state.data.characters?.find(c => c.id === a.characterId);
                    csv += `"${a.name || ''}";"${char?.name || ''}";"${a.email || ''}";"${a.phone || ''}";"${a.address || ''}"\n`;
                });
                csvFolder.file('comediens.csv', csv);
            }
            
            if(state.data.crew && state.data.crew.length > 0) {
                let csv = 'Nom;Poste;Departement;Email;Telephone\n';
                state.data.crew.forEach(c => {
                    csv += `"${c.name || ''}";"${c.role || ''}";"${c.department || ''}";"${c.email || ''}";"${c.phone || ''}"\n`;
                });
                csvFolder.file('equipe.csv', csv);
            }
            
            if(state.data.locations && state.data.locations.length > 0) {
                let csv = 'Decor;Lieu_Reel;Adresse;Contact;Notes\n';
                state.data.locations.forEach(l => {
                    csv += `"${l.name || ''}";"${l.realLocation || ''}";"${l.address || ''}";"${l.contact || ''}";"${(l.notes || '').replace(/"/g, '""')}"\n`;
                });
                csvFolder.file('decors.csv', csv);
            }
            
            if(state.data.expenses && state.data.expenses.length > 0) {
                let csv = 'Description;Montant;Categorie;Statut;Date\n';
                state.data.expenses.forEach(e => {
                    csv += `"${e.description || ''}";"${e.amount || 0}";"${e.category || ''}";"${e.status || ''}";"${e.date || ''}"\n`;
                });
                csvFolder.file('budget_depenses.csv', csv);
            }
            
            if(state.data.shootingDays && state.data.shootingDays.length > 0) {
                let csv = 'Nom;Date;Lieu;Adresse;Scenes\n';
                state.data.shootingDays.forEach(d => {
                    const scenesList = (d.scenes || []).map(sId => {
                        const idx = state.data.scenes?.findIndex(s => s.id === sId);
                        return idx >= 0 ? `#${idx + 1}` : '';
                    }).filter(Boolean).join(', ');
                    csv += `"${d.name || ''}";"${d.startDate || ''}";"${d.location || ''}";"${d.address || ''}";"${scenesList}"\n`;
                });
                csvFolder.file('planning.csv', csv);
            }
            
            if(state.data.scenes && state.data.scenes.length > 0) {
                let csv = 'Numero;Titre;Duree;Personnages;Resume;Statut\n';
                state.data.scenes.forEach((s, idx) => {
                    csv += `"${idx + 1}";"${s.title || ''}";"${s.time || ''}";"${s.perso || ''}";"${(s.resume || '').replace(/"/g, '""')}";"${s.isFinal ? 'Final' : 'Brouillon'}"\n`;
                });
                csvFolder.file('sequencier.csv', csv);
            }
            
            if(state.data.resources && state.data.resources.length > 0) {
                let csv = 'Nom;Type;Description;Proprietaire\n';
                state.data.resources.forEach(r => {
                    csv += `"${r.name || ''}";"${r.type || ''}";"${(r.description || '').replace(/"/g, '""')}";"${r.owner || ''}"\n`;
                });
                csvFolder.file('ressources.csv', csv);
            }
            
            // README
            const readme = `# ${state.data.title || 'Projet'}

Export gÃ©nÃ©rÃ© par Moteur le ${new Date().toLocaleDateString('fr-FR')}

## ðŸ“‚ Structure de l'archive

### Racine
- **projet_data.json** : DonnÃ©es complÃ¨tes â†’ Pour rÃ©importer dans Moteur
- **scenario.fountain** : ScÃ©nario au format Fountain (Final Draft, Highland...)
- **README.md** : Ce fichier

### ðŸ“„ Dossier PDF/
Documents prÃªts Ã  imprimer :
- Scenario.pdf : ScÃ©nario complet
- Sequencier.pdf : Tableau des scÃ¨nes
- Casting.pdf : Personnages et comÃ©diens
- Equipe.pdf : Ã‰quipe technique par dÃ©partement
- Decors.pdf : Liste des dÃ©cors avec adresses
- Budget.pdf : DÃ©penses et budget
- Planning.pdf : Jours de tournage

### ðŸ“Š Dossier CSV/
Fichiers tableur (Excel, Calc, Numbers) :
- personnages.csv, comediens.csv, equipe.csv
- decors.csv, budget_depenses.csv
- planning.csv, sequencier.csv, ressources.csv

## ðŸ”„ RÃ©importer dans Moteur

Menu **Fichier > Importer > Importer un projet (JSON)**
puis sÃ©lectionner **projet_data.json**

## ðŸ“ˆ Statistiques

- ScÃ¨nes : ${state.data.scenes?.length || 0}
- Personnages : ${state.data.characters?.length || 0}
- ComÃ©diens : ${state.data.actors?.length || 0}
- Techniciens : ${state.data.crew?.length || 0}
- DÃ©cors : ${state.data.locations?.length || 0}
- Jours de tournage : ${state.data.shootingDays?.length || 0}

---
GÃ©nÃ©rÃ© par Moteur - moteur.studio
`;
            folder.file('README.md', readme);
            
            // GÃ©nÃ©rer le ZIP
            const content = await zip.generateAsync({ type: 'blob' });
            
            // TÃ©lÃ©charger
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `${folderName}_export.zip`;
            link.click();
            URL.revokeObjectURL(link.href);
            
            Utils.toast('Export ZIP gÃ©nÃ©rÃ© !', 'success');
            History.log('EXPORT', 'Export ZIP complet gÃ©nÃ©rÃ©');
            
        } catch(err) {
            console.error('Erreur export ZIP:', err);
            Utils.toast('Erreur lors de l\'export ZIP', 'error');
        }
    }
};

  const Importer = {
      rawLines: [],
      marginMap: {}, 
      steps: [
          { key: 'sc-heading', label: "1. Surlignez une EN-TÃŠTE DE SCÃˆNE (ex: INT. SALON - JOUR)" },
          { key: 'sc-action', label: "2. Surlignez une ligne d'ACTION" },
          { key: 'sc-perso', label: "3. Surlignez un NOM DE PERSONNAGE" },
          { key: 'sc-dial', label: "4. Surlignez un DIALOGUE ou une DIDASCALIE (distinction automatique par les parenthÃ¨ses)" },
          { key: 'sc-trans', label: "5. Surlignez une TRANSITION (ex: CUT TO:)" },
          { key: 'cleanup', label: "6. NETTOYAGE : SÃ©lectionnez du texte indÃ©sirable (numÃ©ro de page, '(SUITE)') pour le supprimer partout." }
      ],
      currentStepIndex: 0,
      selectedCleanupText: "", 

      trigger: () => els.importInput.click(),

      handleFileSelect: (e) => {
          const file = e.target.files[0];
          if(!file) return;
          if (file.name.toLowerCase().endsWith('.pdf')) { Importer.parsePDF(file); } 
          else if (file.name.toLowerCase().endsWith('.fdx') || file.name.toLowerCase().endsWith('.xml')) { 
             const reader = new FileReader(); reader.onload = (ev) => Importer.parseFDX(ev.target.result); reader.readAsText(file); 
          } else { Utils.toast("Format non supportÃ©.", "error"); }
          e.target.value = ''; 
      },

      parsePDF: async (file) => {
          try {
              els.projectList.innerHTML = '<div class="p-20">Lecture PDF (Patience, chargement complet)...</div>';
              const arrayBuffer = await file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
              let allLines = [];
              
              for (let i = 1; i <= pdf.numPages; i++) {
                  const page = await pdf.getPage(i);
                  const content = await page.getTextContent();
                  let items = content.items.map(item => ({ str: item.str, x: Math.round(item.transform[4]), y: Math.round(item.transform[5]) }));
                  items.sort((a, b) => (b.y - a.y) || (a.x - b.x));
                  
                  let currentY = null, lineText = [], lineX = 0;
                  items.forEach(item => {
                      if (currentY === null || Math.abs(item.y - currentY) < 4) {
                          lineText.push(item.str);
                          if(lineX === 0) lineX = item.x; 
                      } else {
                          if (lineText.length > 0) allLines.push({ text: lineText.join('').trim(), x: lineX });
                          lineText = [item.str]; lineX = item.x; currentY = item.y;
                      }
                      currentY = item.y;
                  });
                  if (lineText.length > 0) allLines.push({ text: lineText.join('').trim(), x: lineX });
              }
              
              Importer.rawLines = allLines;
              Importer.startVisualWizard();

          } catch (err) { console.error(err); Utils.toast("Erreur PDF : " + err.message, "error"); location.reload(); }
      },

      startVisualWizard: () => {
          els.visualWizard.style.display = 'flex';
          Importer.marginMap = {};
          Importer.currentStepIndex = 0;
          
          if(!window.cleanerListenerAttached) {
             document.addEventListener('mouseup', Importer.handleSelection);
             els.cleanupToast.addEventListener('click', Importer.performCleanup);
             window.cleanerListenerAttached = true;
          }
          
          Importer.renderWizardLines();
          Importer.updateWizardUI();
      },

      renderWizardLines: () => {
          els.wizPageView.innerHTML = '';
          Importer.rawLines.slice(0, 2000).forEach((l, idx) => {
              if(!l.text) return;
              const div = document.createElement('div');
              div.className = 'wiz-line';
              div.innerText = l.text;
              div.style.paddingLeft = (l.x / 2) + 'px';
              div.dataset.x = l.x;
              div.dataset.idx = idx;
              div.onclick = (e) => {
                  const sel = window.getSelection();
                  if(sel.toString().length > 0) return;
                  Importer.handleLineClick(l.x);
              };
              els.wizPageView.appendChild(div);
          });
      },

      handleSelection: () => {
          const step = Importer.steps[Importer.currentStepIndex];
          if (!step || step.key !== 'cleanup') {
              els.cleanupToast.style.display = 'none';
              return;
          }

          const sel = window.getSelection();
          const text = sel.toString().trim();
          const wizard = document.getElementById('visual-wizard');
          
          if (wizard.style.display === 'flex' && text.length > 0 && wizard.contains(sel.anchorNode)) {
              Importer.selectedCleanupText = text;
              
              // DÃ©tection des patterns de numÃ©ros de page
              const pagePatterns = [
                  /^\d+\.?$/,           // "1" ou "1."
                  /^\d+\s*\/\s*\d+$/,   // "1/20" ou "1 / 20"
                  /^-\s*\d+\s*-$/,      // "- 1 -"
                  /^Page\s*\d+$/i,      // "Page 1"
                  /^\[\d+\]$/,          // "[1]"
                  /^\(\d+\)$/           // "(1)"
              ];
              
              const isPageNumber = pagePatterns.some(p => p.test(text));
              
              if(isPageNumber) {
                  Importer.cleanupMode = 'pageNumbers';
                  els.cleanupToast.innerHTML = `ðŸ—‘ï¸ Supprimer <b>TOUS les numÃ©ros de page</b> du document`;
              } else {
                  Importer.cleanupMode = 'exact';
                  els.cleanupToast.innerHTML = `ðŸ—‘ï¸ Supprimer partout : "<b>${text.substring(0, 20)}${text.length>20?'...':''}</b>"`;
              }
              els.cleanupToast.style.display = 'block';
          } else {
              els.cleanupToast.style.display = 'none';
          }
      },
      
      cleanupMode: 'exact', // 'exact' ou 'pageNumbers'

      performCleanup: () => {
          if(!Importer.selectedCleanupText) return;
          
          let count = 0;
          
          if(Importer.cleanupMode === 'pageNumbers') {
              // Supprimer toutes les lignes qui ressemblent Ã  des numÃ©ros de page
              const pageRegex = /^(\d+\.?|\d+\s*\/\s*\d+|-\s*\d+\s*-|Page\s*\d+|\[\d+\]|\(\d+\))$/i;
              Importer.rawLines = Importer.rawLines.filter(line => {
                  if(pageRegex.test(line.text.trim())) {
                      count++;
                      return false; // Supprimer cette ligne
                  }
                  return true;
              });
              Utils.toast(`${count} numÃ©ros de page supprimÃ©s !`, 'success');
          } else {
              // Suppression exacte (comportement original)
              const target = Importer.selectedCleanupText;
              const escaped = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              const regex = new RegExp(escaped, 'g');
              
              Importer.rawLines = Importer.rawLines.map(line => {
                  if(line.text.includes(target)) {
                      const newText = line.text.replace(regex, '').trim();
                      if(newText !== line.text) count++;
                      return { ...line, text: newText };
                  }
                  return line;
              }).filter(line => line.text.length > 0);
              
              Utils.toast(`${count} occurrences supprimÃ©es !`, 'success');
          }
          
          els.cleanupToast.style.display = 'none';
          window.getSelection().removeAllRanges();
          Importer.renderWizardLines();
      },

      updateWizardUI: () => {
          const step = Importer.steps[Importer.currentStepIndex];
          
          if(!step) { Importer.finishImport(); return; }
          
          els.wizTitle.innerText = `Ã‰tape ${Importer.currentStepIndex + 1}/${Importer.steps.length}`;
          els.wizTitle.style.color = "var(--primary)";
          els.wizDesc.innerText = step.label;
          els.wizDesc.style.fontWeight = "bold";
          els.wizDesc.style.fontSize = "1.1rem";
          
          document.querySelectorAll('.wiz-line').forEach(l => l.classList.remove('selected-ref'));

          if (step.key === 'cleanup') {
              els.wizSkip.innerText = "âœ… Terminer l'importation";
              els.wizSkip.style.background = "var(--success)";
              els.wizSkip.style.color = "white";
              els.wizSkip.style.fontWeight = "bold";
          } else {
              els.wizSkip.innerText = "Sauter cette Ã©tape";
              els.wizSkip.style.background = "var(--border)";
              els.wizSkip.style.color = "var(--text-main)";
              els.wizSkip.style.fontWeight = "normal";
          }
      },

      handleLineClick: (xVal) => {
          const step = Importer.steps[Importer.currentStepIndex];
          if(!step) return;

          if(step.key === 'cleanup') return;

          Importer.marginMap[xVal] = step.key;
          const matches = document.querySelectorAll(`.wiz-line[data-x="${xVal}"]`);
          matches.forEach(el => el.classList.add('selected-ref'));
          setTimeout(() => { Importer.nextStep(); }, 400);
      },

      nextStep: (skip = false) => {
          Importer.currentStepIndex++;
          Importer.updateWizardUI();
      },
      
      cancel: () => { els.visualWizard.style.display = 'none'; UI.renderDashboard(); },

      finishImport: () => {
          els.visualWizard.style.display = 'none';
          const newData = Store.getEmpty();
          newData.title = "Import Complet";
          
          let currentScene = null;
          
          // Pour la fusion des lignes consÃ©cutives
          let pendingType = null;
          let pendingText = [];
          
          const getType = (x) => {
             const definedMargins = Object.keys(Importer.marginMap).map(Number);
             if(definedMargins.length === 0) return 'sc-action'; 
             const closest = definedMargins.reduce((prev, curr) => Math.abs(curr - x) < Math.abs(prev - x) ? curr : prev);
             if(Math.abs(closest - x) > 20) return 'sc-action'; 
             return Importer.marginMap[closest];
          };
          
          // Fonction pour Ã©crire le paragraphe accumulÃ©
          const flushPending = () => {
              if(!currentScene || !pendingType || pendingText.length === 0) return;
              const mergedText = pendingText.join(' ');
              currentScene.scriptContent += `<div class="${pendingType}">${Utils.escape(mergedText)}</div>`;
              pendingType = null;
              pendingText = [];
          };

          Importer.rawLines.forEach((l, globalIdx) => {
              const text = l.text;
              if(!text) return; 

              let type = getType(l.x);
              
              // Distinction dialogue/didascalie : les parenthÃ¨ses font foi
              // Si la marge correspond Ã  dialogue OU didascalie, on utilise les parenthÃ¨ses pour trancher
              if (type === 'sc-dial' || type === 'sc-paren') {
                  if (/^\(.*\)$/.test(text.trim())) {
                      type = 'sc-paren'; // Entre parenthÃ¨ses = didascalie
                  } else {
                      type = 'sc-dial'; // Pas de parenthÃ¨ses = dialogue
                  }
              }
              
              if(/^(INT\.|EXT\.|I\/E)/i.test(text)) type = 'sc-heading';

              if (type === 'sc-heading') {
                  // Ã‰crire le paragraphe en attente avant de changer de scÃ¨ne
                  flushPending();
                  
                  if (currentScene) {
                      currentScene.time = Utils.estimateTime(currentScene.scriptContent);
                      newData.scenes.push(currentScene);
                  }
                  
                  let cleanTitle = text.replace(/^\d+[\.\-\s]*/, '').toUpperCase();

                  currentScene = { 
                      id: Utils.generateUniqueId(),
                      title: cleanTitle, 
                      time: "0", 
                      perso: "", 
                      resume: "", 
                      scriptContent: "", 
                      breakdown: {}, 
                      tag_id: 't1' 
                  };
                  
                  let rawLoc = cleanTitle.replace(/^(\d+)?\s*(INT\.|EXT\.|I\/E)\s*/i, '').split(/[-â€“]/)[0].trim();
                  if(rawLoc && !newData.locations.find(x=>x.name===rawLoc)) newData.locations.push({name: rawLoc, desc:"", group_id:""});
                  
              } else if (currentScene) {
                  let htmlClass = type || 'sc-action';
                  
                  // Gestion des personnages (pas de fusion pour eux)
                  if(htmlClass === 'sc-perso') {
                      flushPending(); // Ã‰crire ce qui est en attente
                      const rawName = text.replace(/\(.*\)/, '').trim().toUpperCase();
                      if(rawName.length > 1) {
                          if(!newData.characters.find(c=>c.name===rawName)) newData.characters.push({name: rawName, bio:"", group_id:""});
                          
                          const currentPersos = currentScene.perso.split(',').map(s => s.trim()).filter(s => s);
                          if(!currentPersos.includes(rawName)) {
                              currentPersos.push(rawName);
                              currentScene.perso = currentPersos.join(', ');
                          }
                      }
                      currentScene.scriptContent += `<div class="${htmlClass}">${Utils.escape(text)}</div>`;
                  }
                  // Fusion des lignes consÃ©cutives pour action, dialogue, didascalie, transition
                  else if (htmlClass === pendingType) {
                      // MÃªme type que le prÃ©cÃ©dent : on accumule
                      pendingText.push(text);
                  } else {
                      // Type diffÃ©rent : Ã©crire ce qui est en attente et dÃ©marrer un nouveau groupe
                      flushPending();
                      pendingType = htmlClass;
                      pendingText = [text];
                  }
              }
          });
          
          // Ã‰crire le dernier paragraphe en attente
          flushPending();
          
          if(currentScene) {
              currentScene.time = Utils.estimateTime(currentScene.scriptContent);
              newData.scenes.push(currentScene);
          }
          
          Store.createNewProjectFromImport(newData);
      },

      parseFDX: (xmlText) => {
          const parser = new DOMParser(); const xmlDoc = parser.parseFromString(xmlText, "text/xml"); const newData = Store.getEmpty();
          const titleTag = xmlDoc.querySelector('Title Page Title'); newData.title = (titleTag && titleTag.textContent) ? "Import: " + titleTag.textContent.trim() : "Projet FDX";
          const paragraphs = xmlDoc.getElementsByTagName("Paragraph"); let currentScene = null;
          for (let i = 0; i < paragraphs.length; i++) {
              const p = paragraphs[i]; const type = p.getAttribute("Type");
              let text = ""; const texts = p.getElementsByTagName("Text"); for(let t=0; t<texts.length; t++) text += texts[t].textContent; text = text.trim(); if(!text) continue;
              if (type === "Scene Heading") {
                  if (currentScene) newData.scenes.push(currentScene);
                  let cleanTitle = text.replace(/^\d+[\.\-\s]*/, '').toUpperCase();
                  currentScene = { id: Utils.generateUniqueId(), title: cleanTitle, time: "0", perso: "", resume: "", scriptContent: "", breakdown: {}, tag_id: 't1' };
              } else if (currentScene) {
                  let htmlClass = "sc-action";
                  if (type === "Character") htmlClass = "sc-perso"; else if (type === "Dialogue") htmlClass = "sc-dial"; else if (type === "Parenthetical") htmlClass = "sc-paren"; else if (type === "Transition") htmlClass = "sc-trans";
                  if(htmlClass === "sc-perso") {
                       const charName = text.replace(/\(.*\)/, '').trim().toUpperCase();
                       if (!currentScene.perso.includes(charName)) currentScene.perso = currentScene.perso ? currentScene.perso + ", " + charName : charName;
                  }
                  currentScene.scriptContent += `<div class="${htmlClass}">${Utils.escape(text)}</div>`;
              }
          }
          if (currentScene) newData.scenes.push(currentScene);
          Store.createNewProjectFromImport(newData);
      }
  };

// --- MODULE EXPENSES V88 ---

// ========== HISTORIQUE DES MODIFICATIONS ==========
// ========== GESTION DES CONTRATS ==========
const Contracts = {
    currentType: 'image',
    selectedPerson: null,
    selectedPersonType: null,
    
    // Ouvrir la modale de gÃ©nÃ©ration de contrat
    openModal: (personType = null, personIdx = null) => {
        if(!state.currentProjectId) {
            Utils.toast('Ouvrez un projet d\'abord', 'warning');
            return;
        }
        
        // PrÃ©-sÃ©lectionner si on vient d'une fiche
        if(personType && personIdx !== null) {
            Contracts.selectedPersonType = personType;
            const list = personType === 'actor' ? state.data.actors : state.data.crew;
            Contracts.selectedPerson = list[personIdx];
        } else {
            Contracts.selectedPerson = null;
            Contracts.selectedPersonType = null;
        }
        
        const modal = document.createElement('div');
        modal.className = 'contracts-modal';
        modal.id = 'contracts-modal';
        modal.onclick = (e) => { if(e.target === modal) Contracts.closeModal(); };
        
        modal.innerHTML = `
            <div class="contracts-box">
                <div class="contracts-header">
                    <h3>ðŸ“ GÃ©nÃ©ration de contrat</h3>
                    <button class="history-close-btn" onclick="app.Contracts.closeModal()">âœ•</button>
                </div>
                <div class="contracts-content">
                    <div class="contracts-tabs">
                        <div class="contracts-tab active" data-type="image" onclick="app.Contracts.switchTab('image')">ðŸ“¸ Droit Ã  l'image</div>
                        <div class="contracts-tab" data-type="cddu" onclick="app.Contracts.switchTab('cddu')">ðŸ“‹ CDDU (IntermittentÂ·e)</div>
                        <div class="contracts-tab" data-type="prestation" onclick="app.Contracts.switchTab('prestation')">ðŸ“„ Prestation (Auto-entrepreneur)</div>
                        <div class="contracts-tab" data-type="benevole" onclick="app.Contracts.switchTab('benevole')">â¤ï¸ Accord BÃ©nÃ©vole</div>
                    </div>
                    <div id="contract-form-container">
                        ${Contracts.renderForm('image')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    closeModal: () => {
        const modal = document.getElementById('contracts-modal');
        if(modal) modal.remove();
        Contracts.selectedPerson = null;
        Contracts.selectedPersonType = null;
    },
    
    switchTab: (type) => {
        Contracts.currentType = type;
        document.querySelectorAll('.contracts-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.type === type);
        });
        document.getElementById('contract-form-container').innerHTML = Contracts.renderForm(type);
    },
    
    renderForm: (type) => {
        const actors = (state.data.actors || []).filter(a => a.name);
        const crew = (state.data.crew || []).filter(c => c.name);
        const project = state.data.presentation || {};
        
        let personListHTML = '';
        
        if(type === 'cddu') {
            // Filtrer intermittents
            const intermittents = [
                ...actors.filter(a => a.professionalStatus === 'intermittent').map(a => ({...a, _type: 'actor'})),
                ...crew.filter(c => c.professionalStatus === 'intermittent').map(c => ({...c, _type: 'crew'}))
            ];
            personListHTML = Contracts.renderPersonList(intermittents, 'intermittent');
        } else if(type === 'prestation') {
            // Filtrer micro-entrepreneurs
            const micros = [
                ...actors.filter(a => a.professionalStatus === 'micro-entrepreneur').map(a => ({...a, _type: 'actor'})),
                ...crew.filter(c => c.professionalStatus === 'micro-entrepreneur').map(c => ({...c, _type: 'crew'}))
            ];
            personListHTML = Contracts.renderPersonList(micros, 'micro-entrepreneur');
        } else if(type === 'benevole') {
            // Filtrer bÃ©nÃ©voles
            const benevoles = [
                ...actors.filter(a => a.collabType === 'benevole').map(a => ({...a, _type: 'actor'})),
                ...crew.filter(c => c.collabType === 'benevole').map(c => ({...c, _type: 'crew'}))
            ];
            personListHTML = Contracts.renderPersonList(benevoles, 'benevole');
        } else {
            // Droit Ã  l'image - tous
            const all = [
                ...actors.map(a => ({...a, _type: 'actor'})),
                ...crew.map(c => ({...c, _type: 'crew'}))
            ];
            personListHTML = Contracts.renderPersonList(all, 'all');
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        return `
            <div class="contract-form">
                <h4 class="mb-15-m0">1. SÃ©lectionner la personne</h4>
                <div class="person-select-list">
                    ${personListHTML || '<p style="color:var(--text-sec);text-align:center;padding:20px;">Aucune personne avec ce statut. Configurez le statut dans les fiches ComÃ©dienÂ·neÂ·s ou Ã‰quipe.</p>'}
                </div>
                
                <h4 style="margin:20px 0 15px;">2. Informations du contrat</h4>
                <div class="contract-form-row">
                    <div class="contract-form-group">
                        <label>Date de dÃ©but</label>
                        <input type="date" id="contract-date-start" value="${project.dateShootingStart || today}">
                    </div>
                    <div class="contract-form-group">
                        <label>Date de fin</label>
                        <input type="date" id="contract-date-end" value="${project.dateShootingEnd || today}">
                    </div>
                    <div class="contract-form-group">
                        <label>Lieu de travail</label>
                        <input type="text" id="contract-lieu" value="${project.city || ''}" placeholder="Ville de tournage">
                    </div>
                </div>
                ${type === 'cddu' ? `
                <div class="contract-form-row">
                    <div class="contract-form-group">
                        <label>Convention collective</label>
                        <select id="contract-convention">
                            <option value="Production cinÃ©matographique">Production cinÃ©matographique</option>
                            <option value="Production audiovisuelle">Production audiovisuelle</option>
                            <option value="Spectacle vivant">Spectacle vivant</option>
                            <option value="Prestation technique">Prestation technique</option>
                        </select>
                    </div>
                    <div class="contract-form-group">
                        <label>DurÃ©e totale estimÃ©e (heures)</label>
                        <input type="number" id="contract-heures" value="35" placeholder="35">
                    </div>
                </div>
                ` : ''}
                ${type === 'image' ? `
                <div class="contract-form-row">
                    <div class="contract-form-group">
                        <label>Type d'utilisation</label>
                        <select id="contract-usage">
                            <option value="Tous supports">Tous supports (cinÃ©ma, TV, web, etc.)</option>
                            <option value="CinÃ©ma uniquement">CinÃ©ma uniquement</option>
                            <option value="Web uniquement">Web uniquement</option>
                            <option value="Usage interne">Usage interne uniquement</option>
                        </select>
                    </div>
                    <div class="contract-form-group">
                        <label>DurÃ©e de cession</label>
                        <select id="contract-duree-cession">
                            <option value="illimitÃ©e">DurÃ©e illimitÃ©e</option>
                            <option value="5 ans">5 ans</option>
                            <option value="10 ans">10 ans</option>
                            <option value="durÃ©e du projet">DurÃ©e du projet</option>
                        </select>
                    </div>
                </div>
                ` : ''}
                
                <div class="contract-actions">
                    <button class="contract-btn contract-btn-secondary" onclick="app.Contracts.closeModal()">Annuler</button>
                    <button class="contract-btn contract-btn-primary" onclick="app.Contracts.preview()">ðŸ‘ï¸ AperÃ§u</button>
                    <button class="contract-btn contract-btn-primary" onclick="app.Contracts.generatePDF()">ðŸ“„ GÃ©nÃ©rer PDF</button>
                </div>
            </div>
        `;
    },
    
    renderPersonList: (persons, statusFilter) => {
        if(!persons || persons.length === 0) return '';
        
        return persons.map((p, i) => {
            const statusLabel = p.professionalStatus === 'intermittent' ? 'IntermittentÂ·e' : 
                               p.professionalStatus === 'micro-entrepreneur' ? 'Micro-entrepreneurÂ·e' : '';
            const statusClass = p.professionalStatus || '';
            const typeLabel = p._type === 'actor' ? 'ðŸŽ­ ComÃ©dienÂ·ne' : 'ðŸŽ¬ TechnicienÂ·ne';
            const isSelected = Contracts.selectedPerson && Contracts.selectedPerson.id === p.id;
            
            return `
                <div class="person-select-item ${isSelected ? 'selected' : ''}" onclick="app.Contracts.selectPerson('${p._type}', '${p.id}')">
                    <div class="flex-1">
                        <strong>${Utils.escape(p.name)}</strong>
                        <div style="font-size:0.85rem;color:var(--text-sec);">${typeLabel} ${p.role ? '- ' + p.role : ''}</div>
                    </div>
                    ${statusLabel ? `<span class="status-badge ${statusClass}">${statusLabel}</span>` : ''}
                </div>
            `;
        }).join('');
    },
    
    selectPerson: (type, id) => {
        const list = type === 'actor' ? state.data.actors : state.data.crew;
        Contracts.selectedPerson = list.find(p => p.id === id);
        Contracts.selectedPersonType = type;
        
        document.querySelectorAll('.person-select-item').forEach(item => {
            item.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
    },
    
    preview: () => {
        if(!Contracts.selectedPerson) {
            Utils.toast('Veuillez sÃ©lectionner une personne', 'warning');
            return;
        }
        
        const html = Contracts.generateContractHTML();
        
        const previewModal = document.createElement('div');
        previewModal.className = 'contracts-modal';
        previewModal.onclick = (e) => { if(e.target === previewModal) previewModal.remove(); };
        
        previewModal.innerHTML = `
            <div class="contracts-box" style="max-width:800px;">
                <div class="contracts-header">
                    <h3>ðŸ‘ï¸ AperÃ§u du contrat</h3>
                    <button class="history-close-btn" onclick="this.closest('.contracts-modal').remove()">âœ•</button>
                </div>
                <div class="contracts-content">
                    <div class="contract-preview">${html}</div>
                    <div class="contract-actions">
                        <button class="contract-btn contract-btn-secondary" onclick="this.closest('.contracts-modal').remove()">Fermer</button>
                        <button class="contract-btn contract-btn-primary" onclick="app.Contracts.generatePDF()">ðŸ“„ GÃ©nÃ©rer PDF</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(previewModal);
    },
    
    generateContractHTML: () => {
        const p = Contracts.selectedPerson;
        const project = state.data.presentation || {};
        const type = Contracts.currentType;
        
        const dateStart = document.getElementById('contract-date-start')?.value || '';
        const dateEnd = document.getElementById('contract-date-end')?.value || '';
        const lieu = document.getElementById('contract-lieu')?.value || '';
        
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '___________';
        
        if(type === 'cddu') {
            const convention = document.getElementById('contract-convention')?.value || 'Production cinÃ©matographique';
            const heures = document.getElementById('contract-heures')?.value || '35';
            const role = Contracts.selectedPersonType === 'actor' ? 
                (state.data.characters?.find(c => c.actor_id === p.id)?.name || 'ComÃ©dienÂ·ne') : 
                (p.role || 'TechnicienÂ·ne');
            
            return `
                <h1>CONTRAT Ã€ DURÃ‰E DÃ‰TERMINÃ‰E D'USAGE (CDDU)</h1>
                <p class="text-italic-center">ConformÃ©ment aux articles L.1242-2, L.1242-7 et D.1242-1 du Code du travail</p>
                
                <h2>PRÃ‰AMBULE â€“ MOTIF DE RECOURS</h2>
                <p>Le prÃ©sent contrat est conclu dans le cadre d'un <strong>emploi Ã  caractÃ¨re temporaire</strong> 
                pour lequel il est d'usage constant, dans le secteur de la production cinÃ©matographique et audiovisuelle, 
                de ne pas recourir au contrat Ã  durÃ©e indÃ©terminÃ©e en raison de la nature de l'activitÃ© exercÃ©e 
                et du caractÃ¨re par nature temporaire de cet emploi (article D.1242-1 du Code du travail).<br>
                <strong>Ce contrat n'a pas pour objet de pourvoir durablement un emploi liÃ© Ã  l'activitÃ© normale et permanente de l'entreprise.</strong></p>
                
                <h2>ENTRE LES SOUSSIGNÃ‰Â·EÂ·S</h2>
                <p><strong>L'Employeur :</strong><br>
                Nom / DÃ©nomination sociale : ${Utils.escape(project.producer) || '___________________'}<br>
                Adresse : ${Utils.escape(project.addressLegal || project.city) || '___________________'}<br>
                SIRET : ${Utils.escape(project.siret) || '___________________'}<br>
                Code APE/NAF : ${Utils.escape(project.ape) || '___________________'}<br>
                NÂ° Licence entrepreneur spectacle : ${Utils.escape(project.licence) || '___________________'}<br>
                ReprÃ©sentÃ©Â·e par : ${Utils.escape(project.director) || '___________________'}, en qualitÃ© de ${Utils.escape(project.directorTitle) || '___________________'}</p>
                
                <p style="font-size:0.9em;color:#666;"><em>La DÃ©claration PrÃ©alable Ã  l'Embauche (DPAE) a Ã©tÃ© effectuÃ©e auprÃ¨s de l'URSSAF 
                de ${Utils.escape(project.urssaf) || '___________________'} le ___________________.</em></p>
                
                <p><strong>Et le/la SalariÃ©Â·e â€“ IntermittentÂ·e du spectacle :</strong><br>
                Nom et prÃ©nom : ${Utils.escape(p.name)}<br>
                NÃ©Â·e le : ___________________ Ã  ___________________<br>
                NationalitÃ© : ___________________<br>
                Adresse : ${Utils.escape(p.address) || '___________________'}<br>
                NÂ° de SÃ©curitÃ© sociale : ${Utils.escape(p.numSecu) || '___________________'}<br>
                NÂ° CongÃ©s Spectacles : ${Utils.escape(p.numCongesSpectacles) || '___________________'}<br>
                NÂ° d'objet (PÃ´le emploi spectacle) : ___________________<br>
                Emploi/mÃ©tier : ${Utils.escape(role)}</p>
                
                <h2>ARTICLE 1 â€“ OBJET DU CONTRAT</h2>
                <p>Le prÃ©sent contrat a pour objet d'engager le/la salariÃ©Â·e en qualitÃ© de <strong>${Utils.escape(role)}</strong> 
                pour le projet intitulÃ© Â« <strong>${Utils.escape(state.data.title) || 'Sans titre'}</strong> Â».</p>
                
                <h2>ARTICLE 2 â€“ NATURE DU CONTRAT</h2>
                <p>Le/la salariÃ©Â·e est engagÃ©Â·e dans le cadre d'un contrat Ã  durÃ©e dÃ©terminÃ©e d'usage (CDDU), 
                conformÃ©ment aux articles L.1242-2 et suivants du Code du travail, spÃ©cifiques aux professions du spectacle.</p>
                
                <h2>ARTICLE 3 â€“ DURÃ‰E DU CONTRAT</h2>
                <p>Le prÃ©sent contrat prend effet le <strong>${formatDate(dateStart)}</strong> et se termine le <strong>${formatDate(dateEnd)}</strong>.<br>
                DurÃ©e totale estimÃ©e : <strong>${heures} heures</strong>.</p>
                
                <h2>ARTICLE 4 â€“ LIEU DE TRAVAIL</h2>
                <p>Le lieu de travail principal est fixÃ© Ã  : <strong>${Utils.escape(lieu) || '___________________'}</strong>.<br>
                Des dÃ©placements pourront Ãªtre nÃ©cessaires selon les besoins de la production.</p>
                
                <h2>ARTICLE 5 â€“ RÃ‰MUNÃ‰RATION</h2>
                <p>Le/la salariÃ©Â·e percevra une rÃ©munÃ©ration brute de <strong>${p.dailyRate || '___'} ${p.rateCurrency || 'â‚¬'}</strong> par ${p.rateType || 'jour'}.<br>
                Cette rÃ©munÃ©ration est soumise aux cotisations sociales en vigueur.</p>
                
                <h2>ARTICLE 6 â€“ CONVENTION COLLECTIVE</h2>
                <p>Le prÃ©sent contrat est rÃ©gi par la convention collective de la <strong>${convention}</strong>.</p>
                
                <h2>ARTICLE 7 â€“ CAISSE DE RETRAITE ET PRÃ‰VOYANCE</h2>
                <p>Caisse de retraite complÃ©mentaire : AUDIENS<br>
                Adresse : 74 rue Jean Bleuzen, 92170 Vanves</p>
                
                <h2>ARTICLE 8 â€“ CONGÃ‰S SPECTACLES</h2>
                <p>Les congÃ©s payÃ©s seront versÃ©s par la Caisse des CongÃ©s Spectacles.<br>
                NÂ° d'affiliation employeur : ${Utils.escape(project.congesSpectacles) || '___________________'}</p>
                
                <h2>ARTICLE 9 â€“ ABATTEMENT POUR FRAIS PROFESSIONNELS</h2>
                <p>L'emploi occupÃ© ouvre droit Ã  la dÃ©duction forfaitaire spÃ©cifique pour frais professionnels 
                prÃ©vue par l'arrÃªtÃ© du 20 dÃ©cembre 2002. Le/la salariÃ©Â·e dÃ©clare :<br>
                â˜ Accepter l'application de cet abattement<br>
                â˜ Refuser l'application de cet abattement<br>
                <em style="font-size:0.85em;color:#666;">Note : L'application de cet abattement a pour consÃ©quence de minorer l'assiette 
                des cotisations sociales et donc les droits sociaux (retraite, indemnitÃ©s journaliÃ¨res, allocations chÃ´mage).</em></p>
                
                <h2>ARTICLE 10 â€“ FIN DE CONTRAT</h2>
                <p>Ã€ l'issue du contrat, l'employeur remettra au/Ã  la salariÃ©Â·e :<br>
                â€¢ Un certificat de travail<br>
                â€¢ Une attestation PÃ´le emploi (AEM â€“ Attestation Employeur Mensuelle)<br>
                â€¢ Un reÃ§u pour solde de tout compte<br>
                â€¢ Le dernier bulletin de salaire<br>
                â€¢ Un certificat congÃ©s spectacles</p>
                
                <h2>ARTICLE 11 â€“ JURIDICTION COMPÃ‰TENTE</h2>
                <p>En cas de litige relatif Ã  l'exÃ©cution du prÃ©sent contrat, les parties conviennent de rechercher 
                une solution amiable. Ã€ dÃ©faut, le Conseil de Prud'hommes compÃ©tent sera celui du lieu de travail 
                ou du domicile du/de la salariÃ©Â·e.</p>
                
                <div class="signature-zone">
                    <div class="signature-box">
                        <p>Fait Ã  ${Utils.escape(lieu) || '___________'}, le ${formatDate(new Date().toISOString())}</p>
                        <p><strong>L'Employeur</strong></p>
                        <p class="signature-line">Signature et cachet</p>
                    </div>
                    <div class="signature-box">
                        <p>Lu et approuvÃ©,</p>
                        <p><strong>Le/La SalariÃ©Â·e</strong></p>
                        <p class="signature-line">${Utils.escape(p.name)}</p>
                    </div>
                </div>
            `;
        } else if(type === 'prestation') {
            return `
                <h1>CONTRAT DE PRESTATION DE SERVICES</h1>
                
                <h2>ENTRE LES SOUSSIGNÃ‰Â·EÂ·S</h2>
                <p><strong>Le/La ClientÂ·e :</strong><br>
                Nom / DÃ©nomination sociale : ${Utils.escape(project.producer) || '___________________'}<br>
                Adresse : ${Utils.escape(project.addressLegal || project.city) || '___________________'}<br>
                SIRET : ${Utils.escape(project.siret) || '___________________'}<br>
                ReprÃ©sentÃ©Â·e par : ${Utils.escape(project.director) || '___________________'}, en qualitÃ© de ${Utils.escape(project.directorTitle) || '___________________'}</p>
                
                <p><strong>Et le/la Prestataire (Micro-entrepreneurÂ·e) :</strong><br>
                Nom et prÃ©nom : ${Utils.escape(p.name)}<br>
                Adresse : ${Utils.escape(p.address) || '___________________'}<br>
                SIRET : ${Utils.escape(p.siret) || '___________________'}<br>
                ActivitÃ© : ${Utils.escape(p.role) || 'Prestation technique'}</p>
                
                <h2>ARTICLE 1 â€“ OBJET DU CONTRAT</h2>
                <p>Le/la prestataire s'engage Ã  rÃ©aliser pour le/la clientÂ·e la mission suivante :<br>
                <strong>${Utils.escape(p.role) || 'Prestation technique'}</strong> pour le projet Â« <strong>${Utils.escape(state.data.title) || 'Sans titre'}</strong> Â».</p>
                
                <h2>ARTICLE 2 â€“ DURÃ‰E DE LA MISSION</h2>
                <p>La mission dÃ©bute le <strong>${formatDate(dateStart)}</strong> et se termine le <strong>${formatDate(dateEnd)}</strong>.</p>
                
                <h2>ARTICLE 3 â€“ LIEU D'EXÃ‰CUTION</h2>
                <p>La prestation sera rÃ©alisÃ©e Ã  : <strong>${Utils.escape(lieu) || '___________________'}</strong>.</p>
                
                <h2>ARTICLE 4 â€“ RÃ‰MUNÃ‰RATION</h2>
                <p>En contrepartie de la rÃ©alisation de la mission, le/la clientÂ·e versera au/Ã  la prestataire la somme de :<br>
                <strong>${p.dailyRate || '___'} ${p.rateCurrency || 'â‚¬'} HT</strong> par ${p.rateType || 'jour'}.<br>
                TVA non applicable, article 293 B du CGI (si applicable).</p>
                
                <h2>ARTICLE 5 â€“ MODALITÃ‰S DE PAIEMENT</h2>
                <p>Le paiement sera effectuÃ© par virement bancaire sous 30 jours Ã  rÃ©ception de la facture.</p>
                
                <h2>ARTICLE 6 â€“ INDÃ‰PENDANCE</h2>
                <p>Le/la prestataire exerce son activitÃ© de maniÃ¨re indÃ©pendante et n'est soumisÂ·e Ã  aucun lien de subordination. 
                Il/elle organise librement son travail dans le respect des dÃ©lais convenus.</p>
                
                <h2>ARTICLE 7 â€“ ASSURANCE</h2>
                <p>Le/la prestataire dÃ©clare :<br>
                â€¢ ÃŠtre assurÃ©Â·e au titre de sa responsabilitÃ© civile professionnelle<br>
                â€¢ NÂ° de police : ___________________<br>
                â€¢ Compagnie d'assurance : ___________________<br>
                Et s'engage Ã  maintenir cette assurance pendant toute la durÃ©e de la mission.</p>
                
                <h2>ARTICLE 8 â€“ PROPRIÃ‰TÃ‰ INTELLECTUELLE</h2>
                <p>Sauf accord contraire Ã©crit, les crÃ©ations rÃ©alisÃ©es dans le cadre de la prÃ©sente mission 
                (images, sons, textes, graphismes, etc.) sont la propriÃ©tÃ© exclusive du/de la clientÂ·e 
                dÃ¨s leur crÃ©ation et leur paiement intÃ©gral.<br><br>
                Le/la prestataire cÃ¨de au/Ã  la clientÂ·e, Ã  titre exclusif, l'ensemble des droits patrimoniaux 
                attachÃ©s aux crÃ©ations, pour tous supports et tous modes d'exploitation, pour le monde entier 
                et pour toute la durÃ©e lÃ©gale de protection des droits d'auteur.<br><br>
                Cette cession inclut notamment les droits de reproduction, reprÃ©sentation, adaptation, 
                traduction et exploitation commerciale.</p>
                
                <h2>ARTICLE 9 â€“ CONFIDENTIALITÃ‰</h2>
                <p>Le/la prestataire s'engage Ã  garder strictement confidentielles toutes les informations 
                relatives au projet et au/Ã  la clientÂ·e dont il/elle pourrait avoir connaissance dans le cadre 
                de l'exÃ©cution de la prÃ©sente mission.<br>
                Cette obligation de confidentialitÃ© restera en vigueur pendant une durÃ©e de 2 ans aprÃ¨s la fin du contrat.</p>
                
                <h2>ARTICLE 10 â€“ RÃ‰SILIATION</h2>
                <p><strong>RÃ©siliation pour convenance :</strong> Chaque partie peut rÃ©silier le prÃ©sent contrat 
                moyennant un prÃ©avis de ___ jours ouvrÃ©s notifiÃ© par Ã©crit (email avec accusÃ© de rÃ©ception ou LRAR).<br><br>
                <strong>RÃ©siliation pour faute :</strong> En cas de manquement grave d'une partie Ã  ses obligations, 
                l'autre partie pourra rÃ©silier le contrat de plein droit, 8 jours aprÃ¨s mise en demeure restÃ©e infructueuse.<br><br>
                <strong>ConsÃ©quences :</strong> En cas de rÃ©siliation, le/la prestataire sera rÃ©munÃ©rÃ©Â·e pour les prestations 
                dÃ©jÃ  rÃ©alisÃ©es et acceptÃ©es par le/la clientÂ·e.</p>
                
                <h2>ARTICLE 11 â€“ SOUS-TRAITANCE</h2>
                <p>Le/la prestataire ne pourra sous-traiter tout ou partie de la mission sans l'accord prÃ©alable 
                et Ã©crit du/de la clientÂ·e.</p>
                
                <h2>ARTICLE 12 â€“ LITIGE ET DROIT APPLICABLE</h2>
                <p>Le prÃ©sent contrat est soumis au droit franÃ§ais.<br>
                En cas de litige, les parties s'engagent Ã  rechercher une solution amiable. 
                Ã€ dÃ©faut d'accord dans un dÃ©lai de 30 jours, le litige sera soumis aux tribunaux compÃ©tents 
                du ressort du siÃ¨ge social du/de la clientÂ·e.</p>
                
                <h2>ARTICLE 13 â€“ DÃ‰CLARATIONS DU/DE LA PRESTATAIRE</h2>
                <p>Le/la prestataire dÃ©clare :<br>
                â˜ ÃŠtre rÃ©guliÃ¨rement inscritÂ·e au Registre du Commerce ou au RÃ©pertoire des MÃ©tiers<br>
                â˜ ÃŠtre Ã  jour de ses obligations fiscales et sociales<br>
                â˜ Ne pas Ãªtre en situation de dÃ©pendance Ã©conomique vis-Ã -vis du/de la clientÂ·e</p>
                
                <p style="margin-top:20px;padding:10px;background:#fff3cd;border:1px solid #ffc107;font-size:0.85em;">
                <strong>âš ï¸ Attention :</strong> Le recours Ã  unÂ·e prestataire auto-entrepreneurÂ·e est licite 
                uniquement si celui/celle-ci exerce son activitÃ© de maniÃ¨re rÃ©ellement indÃ©pendante, 
                sans lien de subordination. Ã€ dÃ©faut, le contrat pourrait Ãªtre requalifiÃ© en contrat de travail.</p>
                
                <div class="signature-zone">
                    <div class="signature-box">
                        <p>Fait Ã  ${Utils.escape(lieu) || '___________'}, le ${formatDate(new Date().toISOString())}</p>
                        <p>En deux exemplaires originaux</p>
                        <p><strong>Le/La ClientÂ·e</strong></p>
                        <p class="signature-line">Signature et cachet</p>
                    </div>
                    <div class="signature-box">
                        <p>Lu et approuvÃ©,</p>
                        <p><strong>Le/La Prestataire</strong></p>
                        <p>${Utils.escape(p.name)}</p>
                        <p class="signature-line">Signature prÃ©cÃ©dÃ©e de Â« Lu et approuvÃ© Â»</p>
                    </div>
                </div>
            `;
        } else if(type === 'benevole') {
            // Accord BÃ©nÃ©vole
            return Contracts.generateBenevoleHTML(p, project, dateStart, dateEnd, lieu, formatDate);
        } else {
            // Droit Ã  l'image
            const usage = document.getElementById('contract-usage')?.value || 'Tous supports';
            const dureeCession = document.getElementById('contract-duree-cession')?.value || 'illimitÃ©e';
            
            return `
                <h1>AUTORISATION D'EXPLOITATION DU DROIT Ã€ L'IMAGE</h1>
                <p class="text-italic-center">Articles 9 du Code civil et 226-1 du Code pÃ©nal</p>
                
                <h2>ARTICLE 1 â€“ IDENTITÃ‰ DU/DE LA SIGNATAIRE</h2>
                <p>Je soussignÃ©Â·e :<br>
                Nom et prÃ©nom : ${Utils.escape(p.name)}<br>
                NÃ©Â·e le : ___________________ Ã  ___________________<br>
                NationalitÃ© : ___________________<br>
                Adresse : ${Utils.escape(p.address) || '___________________'}<br>
                Email : ${Utils.escape(p.email) || '___________________'}<br>
                TÃ©lÃ©phone : ${Utils.escape(p.phone) || '___________________'}</p>
                
                <p style="margin-top:15px;padding:10px;border:1px solid #333;"><strong>â˜ Personne majeure</strong> agissant en mon nom propre<br><br>
                <strong>â˜ ReprÃ©sentant lÃ©gal d'unÂ·e mineurÂ·e</strong><br>
                Nom du/de la mineurÂ·e : ___________________<br>
                NÃ©Â·e le : ___________________ Ã  ___________________<br>
                Lien avec le/la mineurÂ·e : â˜ PÃ¨re â˜ MÃ¨re â˜ Tuteur/Tutrice lÃ©galÂ·e<br>
                <em style="font-size:0.85em;">L'autorisation des deux parents ou du tuteur lÃ©gal est requise pour toutÂ·e mineurÂ·e.</em></p>
                
                <h2>ARTICLE 2 â€“ BÃ‰NÃ‰FICIAIRE DE L'AUTORISATION</h2>
                <p>J'autorise expressÃ©ment :<br>
                La sociÃ©tÃ© / personne : ${Utils.escape(project.producer) || '___________________'}<br>
                Adresse : ${Utils.escape(project.addressLegal || project.city) || '___________________'}<br>
                SIRET : ${Utils.escape(project.siret) || '___________________'}<br>
                ReprÃ©sentÃ©e par : ${Utils.escape(project.director) || '___________________'}, en qualitÃ© de ${Utils.escape(project.directorTitle) || '___________________'}<br>
                Pour le projet intitulÃ© : Â« <strong>${Utils.escape(state.data.title) || 'Sans titre'}</strong> Â»</p>
                
                <h2>ARTICLE 3 â€“ OBJET DE L'AUTORISATION</h2>
                <p>Ã€ fixer, reproduire, reprÃ©senter et exploiter mon image (et/ou celle du/de la mineurÂ·e que je reprÃ©sente) 
                captÃ©e lors des prises de vues rÃ©alisÃ©es :<br>
                Du : <strong>${formatDate(dateStart)}</strong> au <strong>${formatDate(dateEnd)}</strong><br>
                Lieu : <strong>${Utils.escape(lieu) || '___________________'}</strong></p>
                
                <h2>ARTICLE 4 â€“ SUPPORTS ET MODES D'EXPLOITATION</h2>
                <p>Cette autorisation est consentie pour les utilisations suivantes :<br>
                <strong>${usage}</strong></p>
                <p>Supports autorisÃ©s :<br>
                â˜ Exploitation cinÃ©matographique (salles)<br>
                â˜ Diffusion tÃ©lÃ©visuelle (hertzienne, cÃ¢ble, satellite, TNT)<br>
                â˜ Supports vidÃ©o (DVD, Blu-ray, VOD, SVOD)<br>
                â˜ Internet et rÃ©seaux sociaux<br>
                â˜ Supports promotionnels (affiches, bandes-annonces, making-of)<br>
                â˜ Festivals et projections publiques<br>
                â˜ Usage pÃ©dagogique et culturel<br>
                â˜ Tous supports connus ou inconnus Ã  ce jour</p>
                
                <h2>ARTICLE 5 â€“ Ã‰TENDUE TERRITORIALE ET DURÃ‰E</h2>
                <p><strong>Territoire :</strong> Monde entier / ou limitÃ© Ã  : ___________________<br>
                <strong>DurÃ©e :</strong> ${dureeCession}<br>
                <em style="font-size:0.85em;">En cas de durÃ©e illimitÃ©e, l'autorisation est consentie pour toute la durÃ©e lÃ©gale de protection 
                des droits de propriÃ©tÃ© intellectuelle et de leurs Ã©ventuelles prolongations.</em></p>
                
                <h2>ARTICLE 6 â€“ CONTREPARTIE FINANCIÃˆRE</h2>
                <p>${p.dailyRate ? `Cette autorisation est consentie moyennant la somme forfaitaire de <strong>${p.dailyRate} ${p.rateCurrency || 'â‚¬'}</strong> (${p.rateType === 'jour' ? 'par jour' : p.rateType === 'heure' ? 'par heure' : 'forfait global'}).` : 'Cette autorisation est consentie <strong>Ã  titre gratuit</strong>, le/la signataire reconnaissant avoir Ã©tÃ© informÃ©Â·e de la possibilitÃ© de demander une rÃ©munÃ©ration.'}</p>
                
                <h2>ARTICLE 7 â€“ ENGAGEMENTS DU BÃ‰NÃ‰FICIAIRE</h2>
                <p>Le bÃ©nÃ©ficiaire s'engage Ã  ce que l'exploitation de l'image :<br>
                â€¢ Ne porte pas atteinte Ã  la dignitÃ©, Ã  l'honneur ou Ã  la rÃ©putation du/de la signataire<br>
                â€¢ Ne dÃ©nature pas le contexte dans lequel les images ont Ã©tÃ© captÃ©es<br>
                â€¢ Ne soit pas utilisÃ©e dans un contexte pornographique, diffamatoire ou contraire aux bonnes mÅ“urs<br>
                â€¢ Respecte le droit moral du/de la signataire</p>
                
                <h2>ARTICLE 8 â€“ DROIT DE RETRAIT</h2>
                <p>ConformÃ©ment aux articles 9 du Code civil, le/la signataire conserve le droit de retirer 
                son autorisation Ã  tout moment, par lettre recommandÃ©e avec accusÃ© de rÃ©ception adressÃ©e au bÃ©nÃ©ficiaire.<br>
                Ce retrait ne pourra toutefois pas affecter les exploitations dÃ©jÃ  rÃ©alisÃ©es ou en cours au moment de la notification, 
                ni ouvrir droit Ã  indemnisation.</p>
                
                <h2>ARTICLE 9 â€“ PROTECTION DES DONNÃ‰ES PERSONNELLES (RGPD)</h2>
                <p style="font-size:0.9em;">ConformÃ©ment au RÃ¨glement GÃ©nÃ©ral sur la Protection des DonnÃ©es (UE 2016/679) et Ã  la loi Informatique et LibertÃ©s, 
                le/la signataire dispose d'un droit d'accÃ¨s, de rectification, d'effacement, de limitation, d'opposition 
                et de portabilitÃ© des donnÃ©es le/la concernant.<br>
                Ces droits peuvent Ãªtre exercÃ©s auprÃ¨s de : ${Utils.escape(project.producer) || '___________________'}<br>
                Email : ___________________<br>
                Les donnÃ©es collectÃ©es seront conservÃ©es pour la durÃ©e nÃ©cessaire Ã  l'exploitation autorisÃ©e.</p>
                
                <h2>ARTICLE 10 â€“ DÃ‰CLARATIONS</h2>
                <p>Le/la signataire dÃ©clare :<br>
                â˜ Avoir pris connaissance de l'intÃ©gralitÃ© du prÃ©sent document<br>
                â˜ Avoir eu la possibilitÃ© de poser des questions et d'obtenir des rÃ©ponses<br>
                â˜ Ne pas Ãªtre liÃ©Â·e par un contrat exclusif relatif Ã  l'utilisation de son image<br>
                â˜ Donner son consentement libre, spÃ©cifique, Ã©clairÃ© et univoque</p>
                
                <div class="signature-zone">
                    <div class="signature-box">
                        <p>Fait Ã  ${Utils.escape(lieu) || '___________'}, le ${formatDate(new Date().toISOString())}</p>
                        <p>En deux exemplaires originaux</p>
                        <p><strong>Le/La BÃ©nÃ©ficiaire</strong></p>
                        <p class="signature-line">Signature et cachet</p>
                    </div>
                    <div class="signature-box">
                        <p>Lu et approuvÃ©,<br>Mention manuscrite Â« Bon pour accord Â»</p>
                        <p><strong>Le/La Signataire</strong></p>
                        <p>${Utils.escape(p.name)}</p>
                        <p class="signature-line">Signature prÃ©cÃ©dÃ©e de la mention<br>Â« Lu et approuvÃ©, bon pour accord Â»</p>
                    </div>
                </div>
            `;
        }
    },
    
    // GÃ©nÃ©rer le HTML pour l'Accord BÃ©nÃ©vole
    generateBenevoleHTML: (p, project, dateStart, dateEnd, lieu, formatDate) => {
        const role = p._type === 'actor' ? 
            (state.data.characters?.find(c => c.actor_id === p.id)?.name || 'ComÃ©dienÂ·ne') : 
            (p.role || 'TechnicienÂ·ne bÃ©nÃ©vole');
        
        return `
            <h1>ACCORD DE COLLABORATION BÃ‰NÃ‰VOLE</h1>
            <p class="text-italic-center">Engagement moral et Ã©thique de collaboration</p>
            
            <h2>PRÃ‰AMBULE</h2>
            <p>Le prÃ©sent accord dÃ©finit les conditions d'une collaboration <strong>bÃ©nÃ©vole</strong> dans le cadre 
            d'un projet audiovisuel Ã  but non lucratif ou Ã  budget limitÃ©. Il n'Ã©tablit aucun lien de subordination 
            et ne constitue pas un contrat de travail. Chaque partie s'engage librement et de bonne foi.</p>
            
            <h2>ENTRE</h2>
            <p><strong>Le/La PorteurÂ·se de projet :</strong><br>
            Nom / Structure : ${Utils.escape(project.producer) || '___________________'}<br>
            Adresse : ${Utils.escape(project.addressLegal || project.city) || '___________________'}<br>
            ReprÃ©sentÃ©Â·e par : ${Utils.escape(project.director) || '___________________'}<br>
            Email : ${Utils.escape(project.emailLegal) || '___________________'}</p>
            
            <p><strong>Et le/la CollaborateurÂ·rice bÃ©nÃ©vole :</strong><br>
            Nom et prÃ©nom : ${Utils.escape(p.name)}<br>
            Adresse : ${Utils.escape(p.address) || '___________________'}<br>
            Email : ${Utils.escape(p.email) || '___________________'}<br>
            TÃ©lÃ©phone : ${Utils.escape(p.phone) || '___________________'}</p>
            
            <h2>ARTICLE 1 â€“ OBJET DE LA COLLABORATION</h2>
            <p>Le/la collaborateurÂ·rice bÃ©nÃ©vole accepte de participer au projet intitulÃ© 
            Â« <strong>${Utils.escape(state.data.title) || 'Sans titre'}</strong> Â» 
            en qualitÃ© de <strong>${Utils.escape(role)}</strong>.</p>
            
            <h2>ARTICLE 2 â€“ PÃ‰RIODE DE COLLABORATION</h2>
            <p>La collaboration est prÃ©vue du <strong>${formatDate(dateStart)}</strong> au <strong>${formatDate(dateEnd)}</strong>.<br>
            Lieu principal : <strong>${Utils.escape(lieu) || '___________________'}</strong><br>
            Les horaires et jours de prÃ©sence seront dÃ©finis d'un commun accord.</p>
            
            <h2>ARTICLE 3 â€“ NATURE BÃ‰NÃ‰VOLE</h2>
            <p>Les parties reconnaissent expressÃ©ment que cette collaboration est <strong>bÃ©nÃ©vole</strong> :<br>
            â€¢ Aucune rÃ©munÃ©ration ne sera versÃ©e<br>
            â€¢ Aucun lien de subordination n'existe entre les parties<br>
            â€¢ Le/la collaborateurÂ·rice est libre d'organiser sa participation<br>
            â€¢ Le/la collaborateurÂ·rice peut mettre fin Ã  sa participation Ã  tout moment</p>
            
            <h2>ARTICLE 4 â€“ DÃ‰FRAIEMENTS</h2>
            <p>Le/la porteurÂ·se de projet s'engage, dans la mesure du possible, Ã  prendre en charge :<br>
            â˜ Les repas sur le lieu de tournage/travail<br>
            â˜ Les frais de transport (sur justificatifs)<br>
            â˜ L'hÃ©bergement si nÃ©cessaire<br>
            <em style="font-size:0.9em;">Les modalitÃ©s prÃ©cises seront dÃ©finies avant chaque journÃ©e de collaboration.</em></p>
            
            <h2>ARTICLE 5 â€“ ENGAGEMENTS MUTUELS</h2>
            <p><strong>Le/la porteurÂ·se de projet s'engage Ã  :</strong><br>
            â€¢ Traiter le/la collaborateurÂ·rice avec respect et bienveillance<br>
            â€¢ Fournir les informations nÃ©cessaires Ã  la bonne rÃ©alisation du projet<br>
            â€¢ Assurer des conditions de travail sÃ©curisÃ©es<br>
            â€¢ Mentionner le/la collaborateurÂ·rice au gÃ©nÃ©rique du projet (sauf demande contraire)</p>
            
            <p><strong>Le/la collaborateurÂ·rice s'engage Ã  :</strong><br>
            â€¢ Participer de bonne foi et avec professionnalisme<br>
            â€¢ Respecter les consignes de sÃ©curitÃ© et d'organisation<br>
            â€¢ PrÃ©venir en cas d'absence ou d'empÃªchement<br>
            â€¢ Respecter la confidentialitÃ© du projet</p>
            
            <h2>ARTICLE 6 â€“ CRÃ‰DITS ET RECONNAISSANCE</h2>
            <p>Le/la collaborateurÂ·rice figurera au gÃ©nÃ©rique du projet sous le nom :<br>
            <strong>${Utils.escape(p.name)}</strong><br>
            Fonction/RÃ´le : <strong>${Utils.escape(role)}</strong><br><br>
            â˜ Je souhaite apparaÃ®tre au gÃ©nÃ©rique<br>
            â˜ Je ne souhaite pas apparaÃ®tre au gÃ©nÃ©rique</p>
            
            <h2>ARTICLE 7 â€“ PROPRIÃ‰TÃ‰ INTELLECTUELLE</h2>
            <p>Le/la collaborateurÂ·rice accepte que sa contribution soit intÃ©grÃ©e au projet final. 
            En contrepartie de cette collaboration bÃ©nÃ©vole et de la mention au gÃ©nÃ©rique, 
            il/elle cÃ¨de gracieusement les droits d'exploitation de sa contribution pour ce projet uniquement.</p>
            
            <h2>ARTICLE 8 â€“ ASSURANCE</h2>
            <p>Le/la porteurÂ·se de projet dÃ©clare :<br>
            â˜ Disposer d'une assurance responsabilitÃ© civile couvrant les collaborateurs<br>
            â˜ Ne pas disposer d'assurance spÃ©cifique (le/la collaborateurÂ·rice participe Ã  ses risques)</p>
            
            <h2>ARTICLE 9 â€“ ESPRIT DE L'ACCORD</h2>
            <p style="font-style:italic;">Cet accord repose sur la confiance mutuelle, le respect et l'envie commune de rÃ©aliser 
            un projet crÃ©atif. Les parties s'engagent Ã  communiquer ouvertement et Ã  rÃ©soudre tout diffÃ©rend 
            de maniÃ¨re amiable et constructive. L'aventure humaine compte autant que le rÃ©sultat final.</p>
            
            <div class="signature-zone">
                <div class="signature-box">
                    <p>Fait Ã  ${Utils.escape(lieu) || '___________'}, le ${formatDate(new Date().toISOString())}</p>
                    <p>En deux exemplaires</p>
                    <p><strong>Le/La PorteurÂ·se de projet</strong></p>
                    <p class="signature-line">Signature</p>
                </div>
                <div class="signature-box">
                    <p>Lu et approuvÃ©,<br>Â« Je m'engage librement Â»</p>
                    <p><strong>Le/La CollaborateurÂ·rice</strong></p>
                    <p>${Utils.escape(p.name)}</p>
                    <p class="signature-line">Signature</p>
                </div>
            </div>
        `;
    },
    
    generatePDF: () => {
        if(!Contracts.selectedPerson) {
            Utils.toast('Veuillez sÃ©lectionner une personne', 'warning');
            return;
        }
        
        // VÃ©rifier les infos manquantes selon le type de contrat
        const p = Contracts.selectedPerson;
        const type = Contracts.currentType;
        const missing = [];
        
        if(!p.address) missing.push('Adresse');
        
        if(type === 'cddu') {
            if(!p.numSecu) missing.push('NÂ° SÃ©curitÃ© Sociale');
            if(!p.numCongesSpectacles) missing.push('NÂ° CongÃ©s Spectacles');
        }
        
        if(type === 'prestation') {
            if(!p.siret) missing.push('NÂ° SIRET');
        }
        
        if(missing.length > 0) {
            Contracts.showMissingInfoWarning(missing);
            return;
        }
        
        Contracts.doGeneratePDF();
    },
    
    // Afficher l'avertissement des infos manquantes
    showMissingInfoWarning: (missing) => {
        const p = Contracts.selectedPerson;
        
        const modal = document.createElement('div');
        modal.id = 'contract-missing-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:100000;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="modal-panel-450">
                <h3 style="margin:0 0 20px; color:#FF9800;">âš ï¸ Informations manquantes</h3>
                <p class="mb-15">Pour gÃ©nÃ©rer le contrat de <strong>${Utils.escape(p.name)}</strong>, il manque :</p>
                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px;">
                    ${missing.map(m => `<span style="background:var(--danger); color:white; padding:5px 12px; border-radius:6px; font-size:0.9rem;">âŒ ${m}</span>`).join('')}
                </div>
                ${p.email ? `<p style="color:var(--text-sec); margin-bottom:15px; font-size:0.9rem;">Vous pouvez envoyer un rappel Ã  ${p.name} pour qu'il complÃ¨te son profil.</p>` : `<p style="color:var(--text-sec); margin-bottom:15px; font-size:0.9rem;">Cette personne n'a pas d'email. ComplÃ©tez sa fiche manuellement.</p>`}
                <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
                    <button onclick="document.getElementById('contract-missing-modal').remove()" class="btn-outline">Annuler</button>
                    ${p.email ? `<button onclick="app.Contracts.sendMissingInfoEmail()" class="btn-primary">ðŸ“§ Envoyer rappel</button>` : ''}
                    <button onclick="app.Contracts.forceGeneratePDF()" style="padding:10px 20px; background:#FF9800; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">ðŸ“„ GÃ©nÃ©rer quand mÃªme</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Envoyer email de rappel pour contrat
    sendMissingInfoEmail: async () => {
        const p = Contracts.selectedPerson;
        if(!p || !p.email) return;
        
        const type = Contracts.currentType;
        const issues = [];
        
        if(!p.address) issues.push('ton adresse');
        if(type === 'cddu') {
            if(!p.numSecu) issues.push('ton numÃ©ro de SÃ©curitÃ© Sociale');
            if(!p.numCongesSpectacles) issues.push('ton numÃ©ro CongÃ©s Spectacles');
        }
        if(type === 'prestation' && !p.siret) {
            issues.push('ton numÃ©ro SIRET');
        }
        
        const projectTitle = state.data.title || 'Sans titre';
        const contractType = type === 'cddu' ? 'CDDU' : (type === 'prestation' ? 'contrat de prestation' : 'autorisation droit Ã  l\'image');
        
        try {
            await emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, {
                to_email: p.email,
                to_name: p.name,
                from_name: state.currentUser?.displayName || state.currentUser?.email || 'L\'Ã©quipe',
                project_title: projectTitle,
                subject: `ðŸŽ¬ ${projectTitle} - Infos requises pour ton contrat`,
                message: `Salut ${p.name} ! ðŸ‘‹\n\nLe projet "${projectTitle}" a besoin de quelques informations pour gÃ©nÃ©rer ton ${contractType}.\n\nIl manque : ${issues.join(', ')}\n\nPeux-tu mettre Ã  jour ton profil sur Moteur quand tu as 2 minutes ?\n\nMerci ! ðŸŽ¬`,
                reply_to: state.currentUser?.email || ''
            });
            
            Utils.toast(`ðŸ“§ Email envoyÃ© Ã  ${p.name}`, 'success');
            document.getElementById('contract-missing-modal')?.remove();
        } catch(e) {
            console.error('Erreur envoi email:', e);
            Utils.toast('Erreur lors de l\'envoi', 'error');
        }
    },
    
    // Forcer la gÃ©nÃ©ration malgrÃ© les infos manquantes
    forceGeneratePDF: () => {
        document.getElementById('contract-missing-modal')?.remove();
        Contracts.doGeneratePDF();
    },
    
    // GÃ©nÃ©ration effective du PDF
    doGeneratePDF: () => {
        const html = Contracts.generateContractHTML();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Titre selon le type
        const titles = {
            'cddu': 'CDDU',
            'prestation': 'Contrat_Prestation',
            'image': 'Autorisation_Image',
            'benevole': 'Accord_Benevole'
        };
        
        const fileName = `${titles[Contracts.currentType]}_${Contracts.selectedPerson.name.replace(/\s+/g, '_')}_${state.data.title?.replace(/\s+/g, '_') || 'Projet'}.pdf`;
        
        // Utiliser html2canvas si disponible, sinon mÃ©thode simple
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = `<div style="font-family: Times New Roman, serif; font-size: 11pt; padding: 20px; max-width: 170mm;">${html}</div>`;
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        document.body.appendChild(tempDiv);
        
        doc.html(tempDiv, {
            callback: function(doc) {
                doc.save(fileName);
                document.body.removeChild(tempDiv);
                Utils.toast('Contrat PDF gÃ©nÃ©rÃ© !', 'success');
                History.log('ADD', `GÃ©nÃ©ration contrat ${Contracts.currentType.toUpperCase()} pour ${Contracts.selectedPerson.name}`);
            },
            x: 15,
            y: 15,
            width: 180,
            windowWidth: 700
        });
    }
};

// ========== NOTIFICATIONS ==========
const Notifications = {
    unreadCount: 0,
    items: [],
    listenerAttached: false,
    
    // Initialiser l'Ã©coute des notifications
    init: async () => {
        if(!state.currentUser || Notifications.listenerAttached) return;
        
        const email = state.currentUser.email.toLowerCase();
        
        // Charger les notifications initiales
        const loadNotifications = async () => {
            const { data, error } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_email', email)
                .order('created_at', { ascending: false })
                .limit(50);
            
            if(!error && data) {
                Notifications.items = data.map(n => ({
                    id: n.id,
                    type: n.type,
                    title: n.title,
                    message: n.message,
                    link: n.link,
                    read: n.read,
                    timestamp: new Date(n.created_at).getTime()
                }));
                
                Notifications.unreadCount = Notifications.items.filter(n => !n.read).length;
                Notifications.updateBadge();
                Notifications.renderList();
            }
        };
        
        await loadNotifications();
        
        // Ã‰couter les nouvelles notifications en temps rÃ©el
        if(Notifications._channel) { try { await supabase.removeChannel(Notifications._channel); } catch(e) {} }
        const notifChannel = supabase.channel('notifications_' + email);
        notifChannel.on('postgres_changes', 
                { event: '*', schema: 'public', table: 'notifications', filter: 'user_email=eq.' + email },
                () => loadNotifications()
            )
            .subscribe();
        Notifications._channel = notifChannel;
        
        Notifications.listenerAttached = true;
    },
    
    // Mettre Ã  jour le badge
    updateBadge: () => {
        const badge = document.getElementById('notif-badge');
        if(!badge) return;
        
        if(Notifications.unreadCount > 0) {
            badge.textContent = Notifications.unreadCount > 99 ? '99+' : Notifications.unreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    },
    
    // Afficher/masquer le panneau
    togglePanel: () => {
        const panel = document.getElementById('notif-panel');
        if(panel) {
            panel.classList.toggle('visible');
        }
    },
    
    // Fermer le panneau
    closePanel: () => {
        const panel = document.getElementById('notif-panel');
        if(panel) {
            panel.classList.remove('visible');
        }
    },
    
    // Rendre la liste
    renderList: () => {
        const list = document.getElementById('notif-list');
        if(!list) return;
        
        if(Notifications.items.length === 0) {
            list.innerHTML = '<div class="notif-empty">ðŸ”• Aucune notification</div>';
            return;
        }
        
        list.innerHTML = Notifications.items.map(n => {
            const date = new Date(n.timestamp);
            const timeAgo = Notifications.getTimeAgo(date);
            const icon = Notifications.getIcon(n.type);
            const unreadClass = n.read ? '' : 'unread';
            
            return `
                <div class="notif-item ${unreadClass}" onclick="app.Notifications.handleClick('${n.id}', '${n.type}', '${n.projectId || ''}')">
                    <span class="notif-icon">${icon}</span>
                    <div class="notif-content">
                        <div class="notif-text">${Utils.escape(n.message)}</div>
                        <div class="notif-time">${timeAgo}</div>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    // Obtenir l'icÃ´ne selon le type
    getIcon: (type) => {
        const icons = {
            'invite': 'ðŸ“¨',
            'message': 'ðŸ’¬',
            'modification': 'âœï¸',
            'share': 'ðŸ‘¥'
        };
        return icons[type] || 'ðŸ””';
    },
    
    // Calculer "il y a X temps"
    getTimeAgo: (date) => {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if(seconds < 60) return "Ã€ l'instant";
        if(seconds < 3600) return `Il y a ${Math.floor(seconds / 60)} min`;
        if(seconds < 86400) return `Il y a ${Math.floor(seconds / 3600)}h`;
        if(seconds < 604800) return `Il y a ${Math.floor(seconds / 86400)}j`;
        return date.toLocaleDateString('fr-FR');
    },
    
    // GÃ©rer le clic sur une notification
    handleClick: async (notifId, type, projectId) => {
        // Marquer comme lu
        await Notifications.markAsRead(notifId);
        
        // Action selon le type
        if(type === 'invite' && projectId) {
            Notifications.closePanel();
            Store.loadProject(projectId);
        } else if(type === 'message') {
            Notifications.closePanel();
            // Ouvrir les messages si nÃ©cessaire
        }
    },
    
    // Marquer une notification comme lue
    markAsRead: async (notifId) => {
        if(!state.currentUser) return;
        
        try {
            const {error: mrErr} = await supabase.from('notifications').update({ read: true }).eq('id', notifId);
            if(mrErr) throw mrErr;
        } catch(e) {
            console.error('Erreur markAsRead:', e);
        }
    },
    
    // Marquer toutes comme lues
    markAllRead: async () => {
        if(!state.currentUser) return;
        
        const email = state.currentUser.email.toLowerCase();
        const unreadIds = Notifications.items.filter(n => !n.read).map(n => n.id);
        
        if(unreadIds.length > 0) {
            try {
                const {error: maErr} = await supabase.from('notifications').update({ read: true }).eq('user_email', email).eq('read', false);
                if(maErr) throw maErr;
                Utils.toast('Toutes les notifications marquÃ©es comme lues', 'success');
            } catch(e) {
                console.error('Erreur markAllRead:', e);
            }
        }
    },
    
    // Envoyer une notification Ã  un utilisateur
    send: async (toEmail, type, message, projectId = null) => {
        const notif = {
            user_email: toEmail.toLowerCase(),
            type: type,
            title: type === 'invite' ? 'ðŸ“¨ Invitation' : 'ðŸ”” Notification',
            message: message,
            link: projectId,
            read: false
        };
        
        try {
            const {error: notifErr2} = await supabase.from('notifications').insert(notif);
            if(notifErr2) throw notifErr2;
        } catch(e) {
            console.error('Erreur envoi notification:', e);
        }
    },
    
    // Toggle panneau (pour le header)
    toggle: () => {
        const panel = document.getElementById('notif-panel');
        if(!panel) return;
        
        const isVisible = panel.style.display === 'block';
        panel.style.display = isVisible ? 'none' : 'block';
        
        if(!isVisible) {
            Notifications.renderList();
        }
    },
    
    // Met Ã  jour le badge de rÃ´le de l'utilisateur dans le header
    updateRoleBadge: () => {
        const badge = document.getElementById('user-role-badge');
        if(!badge) return;
        
        const currentEmail = state.currentUser?.email;
        if(!currentEmail) {
            badge.style.display = 'none';
            return;
        }
        
        let roleText = '';
        let roleClass = '';
        let roleIcon = '';
        
        // VÃ©rifier si propriÃ©taire
        if(state.currentRole === 'owner') {
            roleText = 'PropriÃ©taire';
            roleClass = 'owner';
            roleIcon = 'ðŸ‘‘';
        }
        // VÃ©rifier si responsable budget global
        else if(state.data?.budget?.manager === currentEmail) {
            roleText = 'Resp. Budget';
            roleClass = 'budget-manager';
            roleIcon = 'ðŸ’°';
        }
        // VÃ©rifier si responsable d'un dÃ©partement
        else {
            const deptManagers = state.data?.budget?.deptManagers || {};
            const deptsList = [
                { id: 'image', name: 'Image', icon: 'ðŸ“¹' },
                { id: 'lumiere', name: 'LumiÃ¨re', icon: 'ðŸ’¡' },
                { id: 'son', name: 'Son', icon: 'ðŸŽ¤' },
                { id: 'realisation', name: 'RÃ©alisation', icon: 'ðŸŽ¬' },
                { id: 'decoration', name: 'DÃ©coration', icon: 'ðŸŽ¨' },
                { id: 'costumes', name: 'Costumes', icon: 'ðŸ‘—' },
                { id: 'maquillage', name: 'Maquillage', icon: 'ðŸ’„' },
                { id: 'regie', name: 'RÃ©gie', icon: 'ðŸŽ­' },
                { id: 'production', name: 'Production', icon: 'ðŸ’¼' },
                { id: 'transport', name: 'Transport', icon: 'ðŸš—' },
                { id: 'catering', name: 'Catering', icon: 'ðŸ´' },
                { id: 'postprod', name: 'Post-prod', icon: 'ðŸŽžï¸' },
                { id: 'location', name: 'Locations', icon: 'ðŸ ' },
                { id: 'assurance', name: 'Assurance', icon: 'ðŸ“‹' }
            ];
            for(const [deptId, manager] of Object.entries(deptManagers)) {
                if(manager.email === currentEmail) {
                    const dept = deptsList.find(d => d.id === deptId);
                    roleText = `Resp. ${dept?.name || deptId}`;
                    roleClass = 'dept-manager';
                    roleIcon = dept?.icon || 'ðŸ“‹';
                    break;
                }
            }
        }
        
        // VÃ©rifier le rÃ´le dans l'Ã©quipe si pas de rÃ´le budget
        if(!roleText && state.data?.crew) {
            const crewMember = state.data.crew.find(c => c.email === currentEmail);
            if(crewMember && crewMember.role) {
                roleText = crewMember.role;
                roleIcon = 'ðŸŽ¬';
            }
        }
        
        if(roleText) {
            badge.innerHTML = `${roleIcon} ${roleText}`;
            badge.className = `user-role-badge ${roleClass}`;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
};

const History = {
    // Types d'actions
    TYPES: {
        ADD: { icon: 'âž•', label: 'Ajout', class: 'add' },
        EDIT: { icon: 'âœï¸', label: 'Modification', class: 'edit' },
        DELETE: { icon: 'ðŸ—‘ï¸', label: 'Suppression', class: 'delete' },
        SHARE: { icon: 'ðŸ‘¥', label: 'Partage', class: 'share' }
    },
    
    // Enregistrer une action dans l'historique
    log: async (type, description, details = {}) => {
        if(!state.currentProjectId || !state.currentUser) return;
        
        const entry = {
            type: type,
            description: description,
            details: details,
            user: {
                email: state.currentUser.email,
                name: state.currentUser.displayName || state.currentUser.email.split('@')[0]
            },
            timestamp: Date.now()
        };
        
        try {
            // Stocker l'historique dans les donnÃ©es du projet
            if(!state.data.history) state.data.history = [];
            state.data.history.unshift(entry);
            // Garder les 100 derniÃ¨res entrÃ©es
            if(state.data.history.length > 100) {
                state.data.history = state.data.history.slice(0, 100);
            }
            // Ne pas appeler Store.save() ici pour Ã©viter les boucles
        } catch(e) {
            console.error('Erreur historique:', e);
        }
    },
    
    // Charger l'historique
    load: async () => {
        if(!state.currentProjectId) return [];
        
        try {
            return state.data.history || [];
        } catch(e) {
            console.error('Erreur chargement historique:', e);
            return [];
        }
    },
    
    // Ouvrir la modale
    openModal: async () => {
        if(!state.currentProjectId) {
            Utils.toast('Ouvrez un projet d\'abord', 'warning');
            return;
        }
        
        const entries = await History.load();
        const users = [...new Set(entries.map(e => e.user?.email).filter(Boolean))];
        
        const modal = document.createElement('div');
        modal.className = 'history-modal';
        modal.id = 'history-modal';
        modal.onclick = (e) => { if(e.target === modal) History.closeModal(); };
        
        modal.innerHTML = `
            <div class="history-box">
                <div class="history-header">
                    <h3>ðŸ“œ Historique des modifications</h3>
                    <button class="history-close-btn" onclick="app.History.closeModal()">âœ•</button>
                </div>
                <div class="history-filters">
                    <select id="history-filter-type" onchange="app.History.applyFilters()">
                        <option value="">Tous les types</option>
                        <option value="ADD">âž• Ajouts</option>
                        <option value="EDIT">âœï¸ Modifications</option>
                        <option value="DELETE">ðŸ—‘ï¸ Suppressions</option>
                        <option value="SHARE">ðŸ‘¥ Partages</option>
                    </select>
                    <select id="history-filter-user" onchange="app.History.applyFilters()">
                        <option value="">Tous les utilisateurs</option>
                        ${users.map(u => `<option value="${u}">${u}</option>`).join('')}
                    </select>
                </div>
                <div class="history-list" id="history-list">
                    ${History.renderEntries(entries)}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        state.historyEntries = entries;
    },
    
    // Fermer la modale
    closeModal: () => {
        const modal = document.getElementById('history-modal');
        if(modal) modal.remove();
    },
    
    // Appliquer les filtres
    applyFilters: () => {
        const typeFilter = document.getElementById('history-filter-type')?.value || '';
        const userFilter = document.getElementById('history-filter-user')?.value || '';
        
        let filtered = state.historyEntries || [];
        
        if(typeFilter) {
            filtered = filtered.filter(e => e.type === typeFilter);
        }
        if(userFilter) {
            filtered = filtered.filter(e => e.user?.email === userFilter);
        }
        
        const listEl = document.getElementById('history-list');
        if(listEl) {
            listEl.innerHTML = History.renderEntries(filtered);
        }
    },
    
    // Rendre les entrÃ©es HTML
    renderEntries: (entries) => {
        if(!entries || entries.length === 0) {
            return '<div class="history-empty">ðŸ“­ Aucune modification enregistrÃ©e</div>';
        }
        
        return entries.map(entry => {
            const typeInfo = History.TYPES[entry.type] || History.TYPES.EDIT;
            const date = new Date(entry.timestamp);
            const dateStr = date.toLocaleDateString('fr-FR');
            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div class="history-item">
                    <div class="history-icon ${typeInfo.class}">${typeInfo.icon}</div>
                    <div class="history-content">
                        <div class="history-action">${Utils.escape(entry.description)}</div>
                        <div class="history-meta">
                            <span>ðŸ‘¤ ${Utils.escape(entry.user?.name || 'Inconnu')}</span>
                            <span>ðŸ“… ${dateStr} Ã  ${timeStr}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
};

// ========== MODE PRÃ‰SENTATION PLEIN Ã‰CRAN ==========
const PresentMode = {
    isActive: false,
    currentTabIndex: 0,
    tabs: [],
    
    start: () => {
        if(!state.currentProjectId) {
            Utils.toast('Ouvrez un projet d\'abord', 'warning');
            return;
        }
        
        // Collecter les onglets visibles
        PresentMode.tabs = [];
        document.querySelectorAll('#tabsNav .tab-btn').forEach((btn, idx) => {
            if(btn.style.display !== 'none') {
                PresentMode.tabs.push({
                    id: btn.dataset.tab,
                    name: btn.textContent.trim()
                });
            }
        });
        
        if(PresentMode.tabs.length === 0) {
            Utils.toast('Aucun onglet disponible', 'warning');
            return;
        }
        
        // Trouver l'onglet actuellement actif
        const activeTab = document.querySelector('#tabsNav .tab-btn.active');
        if(activeTab) {
            const activeId = activeTab.dataset.tab;
            const idx = PresentMode.tabs.findIndex(t => t.id === activeId);
            if(idx >= 0) PresentMode.currentTabIndex = idx;
        } else {
            PresentMode.currentTabIndex = 0;
        }
        
        // Activer le mode
        document.body.classList.add('presentation-mode');
        PresentMode.isActive = true;
        PresentMode.updateTabName();
        
        // Plein Ã©cran si supportÃ©
        if(document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(() => {});
        }
        
        Utils.toast('Mode PrÃ©sentation activÃ© - Ã‰chap pour quitter', 'info');
    },
    
    exit: () => {
        document.body.classList.remove('presentation-mode');
        PresentMode.isActive = false;
        
        // Quitter le plein Ã©cran
        if(document.fullscreenElement && document.exitFullscreen) {
            document.exitFullscreen().catch(() => {});
        }
        
        Utils.toast('Mode PrÃ©sentation dÃ©sactivÃ©', 'info');
    },
    
    nextTab: () => {
        if(PresentMode.tabs.length === 0) return;
        PresentMode.currentTabIndex = (PresentMode.currentTabIndex + 1) % PresentMode.tabs.length;
        PresentMode.goToCurrentTab();
    },
    
    prevTab: () => {
        if(PresentMode.tabs.length === 0) return;
        PresentMode.currentTabIndex = (PresentMode.currentTabIndex - 1 + PresentMode.tabs.length) % PresentMode.tabs.length;
        PresentMode.goToCurrentTab();
    },
    
    goToCurrentTab: () => {
        const tab = PresentMode.tabs[PresentMode.currentTabIndex];
        if(tab) {
            // Activer l'onglet
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            const content = document.getElementById('tab-' + tab.id);
            const btn = document.querySelector(`.tab-btn[data-tab="${tab.id}"]`);
            if(content) content.classList.add('active');
            if(btn) btn.classList.add('active');
            
            PresentMode.updateTabName();
        }
    },
    
    updateTabName: () => {
        const nameEl = document.getElementById('presTabName');
        const tab = PresentMode.tabs[PresentMode.currentTabIndex];
        if(nameEl && tab) {
            nameEl.textContent = `${PresentMode.currentTabIndex + 1}/${PresentMode.tabs.length} - ${tab.name}`;
        }
    }
};

// --- MODULE PRESENTATION V93 ---
const Presentation = {
    init: () => {
        Presentation.load();
        Presentation.renderCrewNeeds();
        Presentation.renderActorNeeds();
        Presentation.renderPartners();
    },
    
    load: () => {
        const p = state.data.presentation || {};
        
        const imgInput = document.getElementById('project-image-input');
        const imgPreview = document.getElementById('project-image-preview');
        const imgPlaceholder = document.getElementById('project-image-placeholder');
        if(imgInput) imgInput.value = p.image || '';
        if(p.image) {
            if(imgPreview) { imgPreview.src = p.image; imgPreview.style.display = 'block'; }
            if(imgPlaceholder) imgPlaceholder.style.display = 'none';
        }
        
        const titleDisplay = document.getElementById('project-title-display');
        if(titleDisplay) titleDisplay.textContent = state.data.title || 'Sans titre';
        
        if(document.getElementById('project-type')) document.getElementById('project-type').value = p.type || '';
        if(document.getElementById('project-genre')) document.getElementById('project-genre').value = p.genre || '';
        
        if(document.getElementById('project-date-preprod-start')) document.getElementById('project-date-preprod-start').value = p.datePreprodStart || '';
        if(document.getElementById('project-date-preprod-end')) document.getElementById('project-date-preprod-end').value = p.datePreprodEnd || '';
        if(document.getElementById('project-date-shooting-start')) document.getElementById('project-date-shooting-start').value = p.dateShootingStart || '';
        if(document.getElementById('project-date-shooting-end')) document.getElementById('project-date-shooting-end').value = p.dateShootingEnd || '';
        if(document.getElementById('project-date-postprod-start')) document.getElementById('project-date-postprod-start').value = p.datePostprodStart || '';
        if(document.getElementById('project-date-postprod-end')) document.getElementById('project-date-postprod-end').value = p.datePostprodEnd || '';
        if(document.getElementById('project-date-release')) document.getElementById('project-date-release').value = p.dateRelease || '';
        if(document.getElementById('project-date-distribution-end')) document.getElementById('project-date-distribution-end').value = p.dateDistributionEnd || '';
        
        if(document.getElementById('project-city')) document.getElementById('project-city').value = p.city || '';
        if(document.getElementById('project-region')) document.getElementById('project-region').value = p.region || '';
        if(document.getElementById('project-country')) document.getElementById('project-country').value = p.country || 'France';
        
        if(document.getElementById('project-producer')) document.getElementById('project-producer').value = p.producer || '';
        if(document.getElementById('project-director')) document.getElementById('project-director').value = p.director || '';
        if(document.getElementById('project-writer')) document.getElementById('project-writer').value = p.writer || '';
        if(document.getElementById('project-prod-manager')) document.getElementById('project-prod-manager').value = p.prodManager || '';
        if(document.getElementById('project-budget')) document.getElementById('project-budget').value = p.budget || '';
        
        // Informations lÃ©gales employeur (contrats)
        if(document.getElementById('project-siret')) document.getElementById('project-siret').value = p.siret || '';
        if(document.getElementById('project-ape')) document.getElementById('project-ape').value = p.ape || '';
        if(document.getElementById('project-licence')) document.getElementById('project-licence').value = p.licence || '';
        if(document.getElementById('project-urssaf')) document.getElementById('project-urssaf').value = p.urssaf || '';
        if(document.getElementById('project-conges-spectacles')) document.getElementById('project-conges-spectacles').value = p.congesSpectacles || '';
        if(document.getElementById('project-email-legal')) document.getElementById('project-email-legal').value = p.emailLegal || '';
        if(document.getElementById('project-address-legal')) document.getElementById('project-address-legal').value = p.addressLegal || '';
        if(document.getElementById('project-director-title')) document.getElementById('project-director-title').value = p.directorTitle || '';
        
        if(document.getElementById('project-description')) document.getElementById('project-description').value = p.description || '';
        if(document.getElementById('project-public')) document.getElementById('project-public').checked = p.isPublic || false;
        
        // Mettre Ã  jour les boutons de visibilitÃ©
        Presentation.updateVisibilityButtons();
        
        // Type de production
        Presentation.updateProductionTypeUI(p.productionType || '');
        
        // Ã‰quipe actuelle
        Presentation.renderTeamList();
    },
    
    setProductionType: (type) => {
        if(!state.data.presentation) state.data.presentation = {};
        state.data.presentation.productionType = type;
        Presentation.updateProductionTypeUI(type);
        Store.save();
    },
    
    updateProductionTypeUI: (type) => {
        document.querySelectorAll('.project-type-card').forEach(card => {
            card.classList.toggle('selected', card.dataset.type === type);
        });
    },
    
    // === Ã‰QUIPE ACTUELLE ===
    selectedTeamMember: null,
    
    renderTeamList: () => {
        const container = document.getElementById('project-team-list');
        if(!container) return;
        
        const team = state.data.presentation?.team || [];
        
        if(team.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-sec); font-style: italic;">Aucun membre ajoutÃ©</div>';
            return;
        }
        
        container.innerHTML = team.map((member, idx) => `
            <div style="display: flex; align-items: center; gap: 15px; padding: 12px 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                <div style="width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem;">
                    ${member.name ? member.name.charAt(0).toUpperCase() : '?'}
                </div>
                <div class="flex-1">
                    <div style="font-weight: 600; color: var(--text-main);">${Utils.escape(member.name || 'Sans nom')}</div>
                    <div style="font-size: 0.85rem; color: var(--primary);">${Utils.escape(member.role || 'RÃ´le non dÃ©fini')}</div>
                    ${member.email ? `<div class="text-sec-sm">${Utils.escape(member.email)}</div>` : ''}
                </div>
                <button onclick="app.Presentation.removeTeamMember(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; padding: 5px;" title="Retirer">âœ•</button>
            </div>
        `).join('');
    },
    
    openTeamMemberModal: () => {
        Presentation.selectedTeamMember = null;
        document.getElementById('team-member-role').value = '';
        document.getElementById('team-member-custom-role-div').style.display = 'none';
        document.getElementById('team-member-custom-role').value = '';
        document.getElementById('team-member-search').value = '';
        document.getElementById('team-member-search-results').innerHTML = '';
        document.getElementById('team-member-new-name').value = '';
        document.getElementById('team-member-new-email').value = '';
        document.getElementById('team-member-modal').style.display = 'flex';
        
        // GÃ©rer le champ rÃ´le personnalisÃ©
        document.getElementById('team-member-role').onchange = function() {
            document.getElementById('team-member-custom-role-div').style.display = this.value === 'Autre' ? 'block' : 'none';
        };
    },
    
    closeTeamMemberModal: () => {
        document.getElementById('team-member-modal').style.display = 'none';
    },
    
    searchTeamMember: async (query) => {
        const resultsDiv = document.getElementById('team-member-search-results');
        if(!query || query.length < 2) {
            resultsDiv.innerHTML = '';
            return;
        }
        
        const q = query.toLowerCase();
        const results = [];
        
        // Chercher dans les techniciens du projet
        (state.data.crew || []).forEach(member => {
            if(member.name?.toLowerCase().includes(q) || member.email?.toLowerCase().includes(q)) {
                results.push({ type: 'crew', id: member.id, name: member.name, email: member.email, photo: member.photo });
            }
        });
        
        // Chercher dans les comÃ©diens du projet
        (state.data.actors || []).forEach(actor => {
            if(actor.name?.toLowerCase().includes(q) || actor.email?.toLowerCase().includes(q)) {
                results.push({ type: 'actor', id: actor.id, name: actor.name, email: actor.email, photo: actor.photo });
            }
        });
        
        // Chercher dans l'Univers (profils publics Supabase)
        try {
            const { data: profiles } = await supabase
                .from('user_profiles')
                .select('id, name, email, photo, profile_type')
                .eq('is_public', true)
                .or(`name.ilike.%${q}%,email.ilike.%${q}%`)
                .limit(50);
            
            (profiles || []).forEach(profile => {
                if(!results.find(r => r.email === profile.email)) {
                    results.push({ type: 'universe', id: profile.id, name: profile.name, email: profile.email, photo: profile.photo });
                }
            });
        } catch(e) { console.warn('Erreur recherche Univers:', e); }
        
        if(results.length === 0) {
            resultsDiv.innerHTML = '<div style="padding: 10px; color: var(--text-sec); font-style: italic;">Aucun rÃ©sultat</div>';
            return;
        }
        
        resultsDiv.innerHTML = results.slice(0, 10).map(r => `
            <div onclick="app.Presentation.selectTeamMember('${r.type}', '${r.id}', '${Utils.escape(r.name || '')}', '${Utils.escape(r.email || '')}')" 
                 style="display: flex; align-items: center; gap: 10px; padding: 8px 10px; cursor: pointer; border-radius: 6px; transition: background 0.2s;"
                 onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='transparent'">
                <div style="width: 35px; height: 35px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    ${r.photo ? `<img src="${r.photo}" class="img-cover">` : r.name?.charAt(0).toUpperCase() || '?'}
                </div>
                <div>
                    <div style="font-weight: 500;">${Utils.escape(r.name || 'Sans nom')}</div>
                    <div class="text-sec-sm">${Utils.escape(r.email || '')}</div>
                </div>
            </div>
        `).join('');
    },
    
    selectTeamMember: (type, id, name, email) => {
        Presentation.selectedTeamMember = { type, id, name, email };
        document.getElementById('team-member-search').value = name;
        document.getElementById('team-member-search-results').innerHTML = `
            <div style="padding: 10px; background: var(--success); color: white; border-radius: 6px; text-align: center;">
                âœ“ ${Utils.escape(name)} sÃ©lectionnÃ©
            </div>
        `;
        document.getElementById('team-member-new-name').value = '';
        document.getElementById('team-member-new-email').value = '';
    },
    
    addTeamMember: () => {
        const role = document.getElementById('team-member-role').value;
        const customRole = document.getElementById('team-member-custom-role').value;
        const finalRole = role === 'Autre' ? customRole : role;
        
        if(!finalRole) {
            Utils.toast('Veuillez sÃ©lectionner un rÃ´le', 'warning');
            return;
        }
        
        let memberData = null;
        
        if(Presentation.selectedTeamMember) {
            memberData = {
                id: Presentation.selectedTeamMember.id,
                type: Presentation.selectedTeamMember.type,
                name: Presentation.selectedTeamMember.name,
                email: Presentation.selectedTeamMember.email,
                role: finalRole
            };
        } else {
            const newName = document.getElementById('team-member-new-name').value.trim();
            if(!newName) {
                Utils.toast('Veuillez sÃ©lectionner ou crÃ©er une personne', 'warning');
                return;
            }
            memberData = {
                id: 'new_' + Date.now(),
                type: 'new',
                name: newName,
                email: document.getElementById('team-member-new-email').value.trim(),
                role: finalRole
            };
        }
        
        if(!state.data.presentation) state.data.presentation = {};
        if(!state.data.presentation.team) state.data.presentation.team = [];
        
        // VÃ©rifier si dÃ©jÃ  prÃ©sent
        const exists = state.data.presentation.team.find(m => m.name === memberData.name && m.role === memberData.role);
        if(exists) {
            Utils.toast('Cette personne a dÃ©jÃ  ce rÃ´le dans l\'Ã©quipe', 'warning');
            return;
        }
        
        state.data.presentation.team.push(memberData);
        Store.save();
        Presentation.renderTeamList();
        Presentation.closeTeamMemberModal();
        Utils.toast(`${memberData.name} ajoutÃ© comme ${memberData.role}`, 'success');
    },
    
    removeTeamMember: async (idx) => {
        if(!await ConfirmModal.confirmDelete("Ce membre sera retirÃ© de l'Ã©quipe.")) return;
        
        if(state.data.presentation?.team) {
            const member = state.data.presentation.team[idx];
            state.data.presentation.team.splice(idx, 1);
            Store.save();
            Presentation.renderTeamList();
            Utils.toast(`${member?.name || 'Membre'} retirÃ© de l'Ã©quipe`, 'success');
        }
    },
    
    togglePublicVisibility: () => {
        Presentation.save();
    },
    
    toggleSectionVisibility: (section) => {
        const btn = document.getElementById(`project-vis-btn-${section}`);
        if(!btn) return;
        
        const isHidden = btn.classList.toggle('hidden-section');
        Presentation.save();
        
        Utils.toast(isHidden ? `Section masquÃ©e dans l'Univers` : `Section visible dans l'Univers`, 'info');
    },
    
    updateVisibilityButtons: () => {
        const p = state.data.presentation || {};
        const vis = p.visibility || {};
        
        const sections = ['dates', 'location', 'team', 'legal', 'productionType', 'partners', 'crew', 'casting', 'description'];
        sections.forEach(section => {
            const btn = document.getElementById(`project-vis-btn-${section}`);
            if(btn) {
                // Par dÃ©faut visible sauf legal
                const defaultVisible = section !== 'legal';
                const isVisible = vis[section] !== undefined ? vis[section] : defaultVisible;
                btn.classList.toggle('hidden-section', !isVisible);
            }
        });
    },
    
    save: () => {
        if(!state.data.presentation) state.data.presentation = {};
        const p = state.data.presentation;
        
        p.image = document.getElementById('project-image-input')?.value || '';
        p.type = document.getElementById('project-type')?.value || '';
        p.genre = document.getElementById('project-genre')?.value || '';
        
        p.datePreprodStart = document.getElementById('project-date-preprod-start')?.value || '';
        p.datePreprodEnd = document.getElementById('project-date-preprod-end')?.value || '';
        p.dateShootingStart = document.getElementById('project-date-shooting-start')?.value || '';
        p.dateShootingEnd = document.getElementById('project-date-shooting-end')?.value || '';
        p.datePostprodStart = document.getElementById('project-date-postprod-start')?.value || '';
        p.datePostprodEnd = document.getElementById('project-date-postprod-end')?.value || '';
        p.dateRelease = document.getElementById('project-date-release')?.value || '';
        p.dateDistributionEnd = document.getElementById('project-date-distribution-end')?.value || '';
        
        p.city = document.getElementById('project-city')?.value || '';
        p.region = document.getElementById('project-region')?.value || '';
        p.country = document.getElementById('project-country')?.value || 'France';
        
        p.producer = document.getElementById('project-producer')?.value || '';
        p.director = document.getElementById('project-director')?.value || '';
        p.writer = document.getElementById('project-writer')?.value || '';
        p.prodManager = document.getElementById('project-prod-manager')?.value || '';
        p.budget = document.getElementById('project-budget')?.value || '';
        
        // Informations lÃ©gales employeur (contrats)
        p.siret = document.getElementById('project-siret')?.value || '';
        p.ape = document.getElementById('project-ape')?.value || '';
        p.licence = document.getElementById('project-licence')?.value || '';
        p.urssaf = document.getElementById('project-urssaf')?.value || '';
        p.congesSpectacles = document.getElementById('project-conges-spectacles')?.value || '';
        p.emailLegal = document.getElementById('project-email-legal')?.value || '';
        p.addressLegal = document.getElementById('project-address-legal')?.value || '';
        p.directorTitle = document.getElementById('project-director-title')?.value || '';
        
        // Synchroniser avec le module DÃ©penses
        if(!state.data.budget) state.data.budget = { total: 0, currency: 'â‚¬', manager: '', envelopes: {} };
        state.data.budget.total = parseFloat(p.budget) || 0;
        
        // Mettre Ã  jour le champ dans les dÃ©penses si visible
        const expensesBudgetInput = document.getElementById('expenses-budget-total');
        if(expensesBudgetInput) expensesBudgetInput.value = state.data.budget.total || '';
        
        p.description = document.getElementById('project-description')?.value || '';
        
        const wasPublic = p.isPublic || false;
        p.isPublic = document.getElementById('project-public')?.checked || false;
        
        // Options de visibilitÃ© par section (lire depuis les boutons)
        const getVis = (section, defaultVal = true) => {
            const btn = document.getElementById(`project-vis-btn-${section}`);
            return btn ? !btn.classList.contains('hidden-section') : defaultVal;
        };
        p.visibility = {
            dates: getVis('dates'),
            location: getVis('location'),
            team: getVis('team'),
            legal: getVis('legal', false),
            productionType: getVis('productionType'),
            partners: getVis('partners'),
            crew: getVis('crew'),
            casting: getVis('casting'),
            description: getVis('description')
        };
        
        p.updatedAt = new Date().toISOString();
        
        Store.save();
        
        if(p.isPublic) {
            Presentation.publishToUniverse();
        } else if(wasPublic && !p.isPublic) {
            Presentation.unpublishFromUniverse();
        }
    },
    
    publishToUniverse: async () => {
        if(!state.currentProjectId || !state.currentUser) return;
        
        const p = state.data.presentation || {};
        const projectTitle = document.getElementById('projectTitle')?.value || p.title || 'Sans titre';
        
        const vis = p.visibility || {};
        const publicData = {
            title: projectTitle,
            projectType: p.type || '',
            genre: p.genre || '',
            image: p.image || '',
            // Localisation
            city: vis.location !== false ? (p.city || '') : '',
            region: vis.location !== false ? (p.region || '') : '',
            country: vis.location !== false ? (p.country || 'France') : '',
            // Ã‰quipe
            director: vis.team !== false ? (p.director || '') : '',
            producer: vis.team !== false ? (p.producer || '') : '',
            writer: vis.team !== false ? (p.writer || '') : '',
            budget: vis.team !== false ? (p.budget || '') : '',
            team: vis.team !== false ? (p.team || []) : [],
            // Dates
            datePreprodStart: vis.dates !== false ? (p.datePreprodStart || '') : '',
            datePreprodEnd: vis.dates !== false ? (p.datePreprodEnd || '') : '',
            dateShootingStart: vis.dates !== false ? (p.dateShootingStart || '') : '',
            dateShootingEnd: vis.dates !== false ? (p.dateShootingEnd || '') : '',
            datePostprodStart: vis.dates !== false ? (p.datePostprodStart || '') : '',
            datePostprodEnd: vis.dates !== false ? (p.datePostprodEnd || '') : '',
            dateRelease: vis.dates !== false ? (p.dateRelease || '') : '',
            // Infos lÃ©gales
            siret: vis.legal !== false ? (p.siret || '') : '',
            ape: vis.legal !== false ? (p.ape || '') : '',
            licence: vis.legal !== false ? (p.licence || '') : '',
            urssaf: vis.legal !== false ? (p.urssaf || '') : '',
            // Type de production
            productionType: vis.productionType !== false ? (p.productionType || '') : '',
            // Partenaires
            associations: vis.partners !== false ? (p.associations || []) : [],
            enterprises: vis.partners !== false ? (p.enterprises || []) : [],
            // Description
            description: vis.description !== false ? (p.description || '') : '',
            // Besoins
            actorNeeds: vis.casting !== false ? (p.actorNeeds || []) : [],
            crewNeeds: vis.crew !== false ? (p.crewNeeds || {}) : {},
            customCrewNeeds: vis.crew !== false ? (p.customCrewNeeds || []) : [],
            // Meta
            visibility: vis,
            isPublic: true,
            ownerEmail: state.currentUser.email,
            ownerId: state.currentUser.uid,
            projectId: state.currentProjectId,
            updatedAt: new Date().toISOString()
        };
        
        try {
            // Stocker les donnÃ©es publiques dans le projet
            state.data.publicProjectData = publicData;
            state.data.isPublicProject = true;
            await Store.save();
            
            // Mettre Ã  jour la carte de l'Univers si elle est chargÃ©e
            if(Universe.allProjects) {
                const existingIdx = Universe.allProjects.findIndex(p => p.projectId === state.currentProjectId || p.id === state.currentProjectId);
                const projectEntry = {
                    ...publicData,
                    id: state.currentProjectId,
                    type: 'project',
                    location: publicData.city,
                    projectId: state.currentProjectId
                };
                if(existingIdx >= 0) {
                    Universe.allProjects[existingIdx] = projectEntry;
                } else {
                    Universe.allProjects.push(projectEntry);
                }
            }
        } catch(e) {
            console.error('Erreur publication projet:', e);
        }
    },
    
    unpublishFromUniverse: async () => {
        if(!state.currentProjectId) return;
        
        try {
            state.data.isPublicProject = false;
            delete state.data.publicProjectData;
            await Store.save();
            
            // Retirer de la carte de l'Univers si elle est chargÃ©e
            if(Universe.allProjects) {
                Universe.allProjects = Universe.allProjects.filter(p => p.projectId !== state.currentProjectId && p.id !== state.currentProjectId);
            }
        } catch(e) {
            console.error('Erreur suppression projet public:', e);
        }
    },
    
    crewPositions: [
        { id: 'realisateur', name: 'RÃ©alisateurÂ·rice', dept: 'RÃ©alisation' },
        { id: 'assistant_real', name: '1er Assistant RÃ©alisateur', dept: 'RÃ©alisation' },
        { id: 'scripte', name: 'Scripte', dept: 'RÃ©alisation' },
        { id: 'dop', name: 'Chef OpÃ©rateur / DOP', dept: 'Image' },
        { id: 'cadreur', name: 'Cadreur', dept: 'Image' },
        { id: 'assistant_cam', name: 'Assistant CamÃ©ra', dept: 'Image' },
        { id: 'chef_elec', name: 'Chef Ã‰lectricien', dept: 'LumiÃ¨re' },
        { id: 'electricien', name: 'Ã‰lectricien', dept: 'LumiÃ¨re' },
        { id: 'chef_machino', name: 'Chef Machiniste', dept: 'Machinerie' },
        { id: 'machiniste', name: 'Machiniste', dept: 'Machinerie' },
        { id: 'ingeson', name: 'IngÃ©nieur du Son', dept: 'Son' },
        { id: 'perchman', name: 'Perchman', dept: 'Son' },
        { id: 'chef_deco', name: 'Chef DÃ©corateur', dept: 'DÃ©coration' },
        { id: 'accessoiriste', name: 'Accessoiriste', dept: 'DÃ©coration' },
        { id: 'chef_costumes', name: 'Chef Costumier', dept: 'Costumes' },
        { id: 'habilleur', name: 'HabilleurÂ·se', dept: 'Costumes' },
        { id: 'chef_maquillage', name: 'Chef Maquilleur', dept: 'Maquillage' },
        { id: 'maquilleur', name: 'MaquilleurÂ·se', dept: 'Maquillage' },
        { id: 'coiffeur', name: 'CoiffeurÂ·se', dept: 'Maquillage' },
        { id: 'dir_prod', name: 'Directeur de Production', dept: 'Production' },
        { id: 'regisseur', name: 'RÃ©gisseur GÃ©nÃ©ral', dept: 'RÃ©gie' },
        { id: 'assistant_regie', name: 'Assistant RÃ©gie', dept: 'RÃ©gie' },
        { id: 'dir_casting', name: 'Directeur de Casting', dept: 'Casting' },
        { id: 'photographe', name: 'Photographe Plateau', dept: 'Autre' },
        { id: 'monteur', name: 'Monteur', dept: 'Post-production' },
        { id: 'etalonneur', name: 'Ã‰talonneur', dept: 'Post-production' },
        { id: 'mixeur', name: 'Mixeur Son', dept: 'Post-production' }
    ],
    
    renderCrewNeeds: () => {
        const container = document.getElementById('needs-crew-list');
        if(!container) return;
        
        if(!state.data.presentation) state.data.presentation = {};
        if(!state.data.presentation.crewNeeds) state.data.presentation.crewNeeds = {};
        
        const needs = state.data.presentation.crewNeeds;
        
        let html = '';
        Presentation.crewPositions.forEach(pos => {
            const need = needs[pos.id] || { needed: false, count: 1 };
            html += `<div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg); border-radius: 6px;">
                <input type="checkbox" id="need-crew-${pos.id}" ${need.needed ? 'checked' : ''} onchange="app.Presentation.toggleCrewNeed('${pos.id}')" style="width: 18px; height: 18px;">
                <label for="need-crew-${pos.id}" style="flex: 1; cursor: pointer;">${pos.name}</label>
                <input type="number" id="need-crew-count-${pos.id}" value="${need.count}" min="1" max="20" class="n8-input-4" onchange="app.Presentation.updateCrewNeedCount('${pos.id}', this.value)" ${need.needed ? '' : 'disabled'}>
            </div>`;
        });
        
        const customNeeds = state.data.presentation.customCrewNeeds || [];
        customNeeds.forEach((custom, idx) => {
            html += `<div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--highlight); border-radius: 6px;">
                <input type="checkbox" checked disabled style="width: 18px; height: 18px;">
                <input type="text" value="${Utils.escape(custom.name)}" style="flex: 1; padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateCustomCrewNeed(${idx}, 'name', this.value)">
                <input type="number" value="${custom.count}" min="1" max="20" class="n8-input-4" onchange="app.Presentation.updateCustomCrewNeed(${idx}, 'count', this.value)">
                <button onclick="app.Presentation.removeCustomCrewNeed(${idx})" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">âœ•</button>
            </div>`;
        });
        
        container.innerHTML = html;
    },
    
    toggleCrewNeed: (posId) => {
        if(!state.data.presentation.crewNeeds) state.data.presentation.crewNeeds = {};
        const checkbox = document.getElementById(`need-crew-${posId}`);
        const countInput = document.getElementById(`need-crew-count-${posId}`);
        
        if(!state.data.presentation.crewNeeds[posId]) {
            state.data.presentation.crewNeeds[posId] = { needed: false, count: 1 };
        }
        
        state.data.presentation.crewNeeds[posId].needed = checkbox.checked;
        countInput.disabled = !checkbox.checked;
        
        Store.save();
    },
    
    updateCrewNeedCount: (posId, count) => {
        if(!state.data.presentation.crewNeeds) state.data.presentation.crewNeeds = {};
        if(!state.data.presentation.crewNeeds[posId]) {
            state.data.presentation.crewNeeds[posId] = { needed: true, count: 1 };
        }
        state.data.presentation.crewNeeds[posId].count = parseInt(count) || 1;
        Store.save();
    },
    
    addCustomCrewNeed: async () => {
        const name = await ConfirmModal.prompt("Entrez le nom du poste.", "Nouveau poste", "Ex: Assistant rÃ©alisateur...");
        if(!name || !name.trim()) return;
        
        if(!state.data.presentation.customCrewNeeds) state.data.presentation.customCrewNeeds = [];
        state.data.presentation.customCrewNeeds.push({ name: name.trim(), count: 1 });
        Store.save();
        Presentation.renderCrewNeeds();
    },
    
    updateCustomCrewNeed: (idx, field, value) => {
        if(!state.data.presentation.customCrewNeeds) return;
        if(field === 'name') {
            state.data.presentation.customCrewNeeds[idx].name = value;
        } else if(field === 'count') {
            state.data.presentation.customCrewNeeds[idx].count = parseInt(value) || 1;
        }
        Store.save();
    },
    
    removeCustomCrewNeed: (idx) => {
        if(!state.data.presentation.customCrewNeeds) return;
        state.data.presentation.customCrewNeeds.splice(idx, 1);
        Store.save();
        Presentation.renderCrewNeeds();
    },
    
    renderActorNeeds: () => {
        const container = document.getElementById('needs-actors-list');
        if(!container) return;
        
        if(!state.data.presentation) state.data.presentation = {};
        if(!state.data.presentation.actorNeeds) state.data.presentation.actorNeeds = [];
        
        const needs = state.data.presentation.actorNeeds;
        
        if(needs.length === 0) {
            container.innerHTML = '<div style="color: var(--text-sec); text-align: center; padding: 20px; background: var(--bg); border-radius: 8px;">Aucun rÃ´le dÃ©fini. Cliquez sur "Ajouter un rÃ´le" pour commencer.</div>';
            return;
        }
        
        let html = '';
        needs.forEach((need, idx) => {
            html += `<div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                <div class="section-header-10">
                    <input type="text" value="${Utils.escape(need.roleName || '')}" placeholder="Nom du rÃ´le (ex: Marie, Inspecteur...)" style="flex: 1; padding: 8px; font-weight: bold; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'roleName', this.value)">
                    <button onclick="app.Presentation.removeActorNeed(${idx})" style="margin-left: 10px; background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">ðŸ—‘ï¸</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label class="text-sec-sm">Type</label>
                        <select class="form-input-r4" onchange="app.Presentation.updateActorNeed(${idx}, 'type', this.value)">
                            <option value="principal" ${need.type === 'principal' ? 'selected' : ''}>RÃ´le principal</option>
                            <option value="secondaire" ${need.type === 'secondaire' ? 'selected' : ''}>RÃ´le secondaire</option>
                            <option value="figurant" ${need.type === 'figurant' ? 'selected' : ''}>Figurant</option>
                            <option value="silhouette" ${need.type === 'silhouette' ? 'selected' : ''}>Silhouette</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sec-sm">Sexe</label>
                        <select class="form-input-r4" onchange="app.Presentation.updateActorNeed(${idx}, 'gender', this.value)">
                            <option value="" ${!need.gender ? 'selected' : ''}>Peu importe</option>
                            <option value="homme" ${need.gender === 'homme' ? 'selected' : ''}>Homme</option>
                            <option value="femme" ${need.gender === 'femme' ? 'selected' : ''}>Femme</option>
                            <option value="non-binaire" ${need.gender === 'non-binaire' ? 'selected' : ''}>Non-binaire</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sec-sm">Ã‚ge min</label>
                        <input type="number" value="${need.ageMin || ''}" placeholder="18" min="1" max="100" class="form-input-r4" onchange="app.Presentation.updateActorNeed(${idx}, 'ageMin', this.value)">
                    </div>
                    <div>
                        <label class="text-sec-sm">Ã‚ge max</label>
                        <input type="number" value="${need.ageMax || ''}" placeholder="30" min="1" max="100" class="form-input-r4" onchange="app.Presentation.updateActorNeed(${idx}, 'ageMax', this.value)">
                    </div>
                    <div>
                        <label class="text-sec-sm">Origine</label>
                        <select class="form-input-r4" onchange="app.Presentation.updateActorNeed(${idx}, 'ethnicity', this.value)">
                            <option value="" ${!need.ethnicity ? 'selected' : ''}>Peu importe</option>
                            <option value="caucasien" ${need.ethnicity === 'caucasien' ? 'selected' : ''}>Caucasien</option>
                            <option value="africain" ${need.ethnicity === 'africain' ? 'selected' : ''}>Africain</option>
                            <option value="asiatique" ${need.ethnicity === 'asiatique' ? 'selected' : ''}>Asiatique</option>
                            <option value="latino" ${need.ethnicity === 'latino' ? 'selected' : ''}>Latino</option>
                            <option value="maghrebin" ${need.ethnicity === 'maghrebin' ? 'selected' : ''}>MaghrÃ©bin</option>
                            <option value="metis" ${need.ethnicity === 'metis' ? 'selected' : ''}>MÃ©tis</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sec-sm">Cheveux</label>
                        <select class="form-input-r4" onchange="app.Presentation.updateActorNeed(${idx}, 'hairColor', this.value)">
                            <option value="" ${!need.hairColor ? 'selected' : ''}>Peu importe</option>
                            <option value="noir" ${need.hairColor === 'noir' ? 'selected' : ''}>Noir</option>
                            <option value="brun" ${need.hairColor === 'brun' ? 'selected' : ''}>Brun</option>
                            <option value="chatain" ${need.hairColor === 'chatain' ? 'selected' : ''}>ChÃ¢tain</option>
                            <option value="blond" ${need.hairColor === 'blond' ? 'selected' : ''}>Blond</option>
                            <option value="roux" ${need.hairColor === 'roux' ? 'selected' : ''}>Roux</option>
                            <option value="gris" ${need.hairColor === 'gris' ? 'selected' : ''}>Gris/Blanc</option>
                            <option value="chauve" ${need.hairColor === 'chauve' ? 'selected' : ''}>Chauve</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sec-sm">Nombre recherchÃ©</label>
                        <input type="number" value="${need.count || 1}" min="1" max="100" class="form-input-r4" onchange="app.Presentation.updateActorNeed(${idx}, 'count', this.value)">
                    </div>
                </div>
                <div class="mt-10">
                    <label class="text-sec-sm">Description du rÃ´le</label>
                    <textarea placeholder="DÃ©crivez le personnage, ses caractÃ©ristiques, le contexte..." style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); min-height: 60px; resize: vertical;" onchange="app.Presentation.updateActorNeed(${idx}, 'description', this.value)">${Utils.escape(need.description || '')}</textarea>
                </div>
            </div>`;
        });
        
        container.innerHTML = html;
    },
    
    addActorNeed: () => {
        if(!state.data.presentation.actorNeeds) state.data.presentation.actorNeeds = [];
        state.data.presentation.actorNeeds.push({
            roleName: '',
            type: 'principal',
            gender: '',
            ageMin: '',
            ageMax: '',
            ethnicity: '',
            hairColor: '',
            count: 1,
            description: ''
        });
        Store.save();
        Presentation.renderActorNeeds();
    },
    
    updateActorNeed: (idx, field, value) => {
        if(!state.data.presentation.actorNeeds || !state.data.presentation.actorNeeds[idx]) return;
        state.data.presentation.actorNeeds[idx][field] = value;
        Store.save();
    },
    
    removeActorNeed: async (idx) => {
        if(!await ConfirmModal.confirmDelete("Ce rÃ´le sera supprimÃ©.")) return;
        if(!state.data.presentation.actorNeeds) return;
        state.data.presentation.actorNeeds.splice(idx, 1);
        Store.save();
        Presentation.renderActorNeeds();
    },

    updateImage: (url) => {
        const preview = document.getElementById('project-image-preview');
        const placeholder = document.getElementById('project-image-placeholder');
        
        if(url && url.trim()) {
            if(preview) {
                preview.src = url;
                preview.style.display = 'block';
                preview.onerror = () => {
                    preview.style.display = 'none';
                    if(placeholder) placeholder.style.display = 'block';
                };
            }
            if(placeholder) placeholder.style.display = 'none';
        } else {
            if(preview) preview.style.display = 'none';
            if(placeholder) placeholder.style.display = 'block';
        }
        
        Presentation.save();
    },
    
    uploadImage: async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const statusEl = document.getElementById('project-image-status');
        const preview = document.getElementById('project-image-preview');
        const placeholder = document.getElementById('project-image-placeholder');
        const input = document.getElementById('project-image-input');
        
        if (!file.type.startsWith('image/')) {
            if(statusEl) { statusEl.textContent = 'âŒ Fichier non valide'; statusEl.style.color = '#e74c3c'; }
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            if(statusEl) { statusEl.textContent = 'âŒ Max 5 Mo'; statusEl.style.color = '#e74c3c'; }
            return;
        }
        
        if(statusEl) { statusEl.textContent = 'â³ Upload...'; statusEl.style.color = 'var(--text-sec)'; }
        if(placeholder) placeholder.innerHTML = 'â³';
        
        try {
            const compressedBlob = await PublicProfile.compressImageToBlob(file, 1200, 0.85);
            const projectId = state.currentProjectId;
            const fileName = `poster_${Date.now()}.jpg`;
            const filePath = `${projectId}/${fileName}`;
            
            // Supprimer l'ancienne image si elle existe
            const oldUrl = input.value;
            if (oldUrl && oldUrl.includes('supabase')) {
                const oldPath = oldUrl.split('/projects/')[1];
                if (oldPath) {
                    await supabase.storage.from('projects').remove([oldPath]);
                }
            }
            
            const { data, error } = await supabase.storage
                .from('projects')
                .upload(filePath, compressedBlob, {
                    contentType: 'image/jpeg',
                    upsert: true
                });
            
            if (error) throw error;
            
            const { data: urlData } = supabase.storage
                .from('projects')
                .getPublicUrl(filePath);
            
            const publicUrl = urlData.publicUrl;
            
            input.value = publicUrl;
            if(preview) {
                preview.src = publicUrl;
                preview.style.display = 'block';
            }
            if(placeholder) { placeholder.style.display = 'none'; placeholder.innerHTML = 'ðŸŽ¬'; }
            if(statusEl) { statusEl.textContent = 'âœ… Image uploadÃ©e'; statusEl.style.color = '#27ae60'; }
            
            Presentation.save();
        } catch (err) {
            console.error('Erreur upload image projet:', err);
            if(placeholder) placeholder.innerHTML = 'ðŸŽ¬';
            if(statusEl) { statusEl.textContent = 'âŒ Erreur upload'; statusEl.style.color = '#e74c3c'; }
        }
    },
    
    // ========== PARTENAIRES (Associations & Entreprises) ==========
    
    // Ouvre le modal de recherche de partenaires
    openPartnerSearch: (type) => {
        const isAssociation = type === 'association';
        const title = isAssociation ? 'ðŸ›ï¸ Ajouter une Association' : 'ðŸ¢ Ajouter une Entreprise';
        const typeList = isAssociation ? CONFIG.associationTypes : CONFIG.enterpriseTypes;
        
        // Charger les partenaires disponibles depuis Universe
        const partners = Universe.allProfiles.filter(p => p.type === type);
        
        const modal = document.createElement('div');
        modal.id = 'partner-search-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10002;';
        
        let listHtml = '';
        if(partners.length === 0) {
            listHtml = `<div style="text-align: center; padding: 30px; color: var(--text-sec);">
                <div class="fs-2-mb10">${isAssociation ? 'ðŸ›ï¸' : 'ðŸ¢'}</div>
                <p>Aucun${isAssociation ? 'e association' : 'e entreprise'} disponible dans l'Univers.</p>
            </div>`;
        } else {
            listHtml = partners.map(p => {
                const name = p.name || p.assoName || p.entName || 'Sans nom';
                const typeInfo = isAssociation 
                    ? CONFIG.associationTypes.find(t => t.id === p.assoType)
                    : CONFIG.enterpriseTypes.find(t => t.id === p.entType);
                const typeName = typeInfo ? typeInfo.name : '';
                const photo = p.photo || '';
                
                return `<div onclick="app.Presentation.addPartner('${type}', '${p.id}', '${Utils.escape(name)}', '${Utils.escape(photo)}')" 
                    style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="width: 45px; height: 45px; border-radius: 50%; background: var(--panel-bg); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${photo ? `<img src="${photo}" class="img-cover">` : (isAssociation ? 'ðŸ›ï¸' : 'ðŸ¢')}
                    </div>
                    <div>
                        <div style="font-weight: 600; color: var(--text-main);">${Utils.escape(name)}</div>
                        <div class="text-sec-sm">${typeName}</div>
                        ${p.city ? `<div class="text-sec-xs-alt">ðŸ“ ${Utils.escape(p.city)}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
        }
        
        modal.innerHTML = `
            <div style="background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
                <div class="n8-flex-5">
                    <h3 class="m-0">${title}</h3>
                    <button onclick="document.getElementById('partner-search-modal').remove()" class="icon-btn-sec">âœ–</button>
                </div>
                <div style="padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                    ${listHtml}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Ajoute un partenaire au projet
    addPartner: (type, id, name, photo) => {
        if(!state.data.presentation) state.data.presentation = {};
        
        const key = type === 'association' ? 'associations' : 'enterprises';
        if(!state.data.presentation[key]) state.data.presentation[key] = [];
        
        // VÃ©rifier si dÃ©jÃ  ajoutÃ©
        if(state.data.presentation[key].find(p => p.id === id)) {
            Utils.toast('Ce partenaire est dÃ©jÃ  ajoutÃ©.', 'warning');
            return;
        }
        
        state.data.presentation[key].push({ id, name, photo });
        Store.save();
        
        Presentation.renderPartners();
        document.getElementById('partner-search-modal')?.remove();
        Utils.toast('Partenaire ajoutÃ© !', 'success');
    },
    
    // Supprime un partenaire
    removePartner: (type, id) => {
        if(!state.data.presentation) return;
        
        const key = type === 'association' ? 'associations' : 'enterprises';
        if(!state.data.presentation[key]) return;
        
        state.data.presentation[key] = state.data.presentation[key].filter(p => p.id !== id);
        Store.save();
        Presentation.renderPartners();
    },
    
    // Affiche les partenaires
    renderPartners: () => {
        const p = state.data.presentation || {};
        
        // Associations
        const assoList = document.getElementById('project-associations-list');
        if(assoList) {
            const associations = p.associations || [];
            if(associations.length === 0) {
                assoList.innerHTML = '<span class="text-sec-sm2">Aucune association ajoutÃ©e</span>';
            } else {
                assoList.innerHTML = associations.map(a => `
                    <div class="n8-flex-3">
                        <div class="n8-avatar-2">
                            ${a.photo ? `<img src="${a.photo}" class="img-cover">` : 'ðŸ›ï¸'}
                        </div>
                        <span class="fs-09">${Utils.escape(a.name)}</span>
                        <button onclick="app.Presentation.removePartner('association', '${a.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger); font-size: 0.8rem;">âœ–</button>
                    </div>
                `).join('');
            }
        }
        
        // Entreprises
        const entList = document.getElementById('project-enterprises-list');
        if(entList) {
            const enterprises = p.enterprises || [];
            if(enterprises.length === 0) {
                entList.innerHTML = '<span class="text-sec-sm2">Aucune entreprise ajoutÃ©e</span>';
            } else {
                entList.innerHTML = enterprises.map(e => `
                    <div class="n8-flex-3">
                        <div class="n8-avatar-2">
                            ${e.photo ? `<img src="${e.photo}" class="img-cover">` : 'ðŸ¢'}
                        </div>
                        <span class="fs-09">${Utils.escape(e.name)}</span>
                        <button onclick="app.Presentation.removePartner('enterprise', '${e.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger); font-size: 0.8rem;">âœ–</button>
                    </div>
                `).join('');
            }
        }
    },
    
    // ========== AUTOCOMPLÃ‰TION Ã‰QUIPE ==========
    
    // Recherche dans contacts et univers (filtrÃ©e par mÃ©tier)
    autocomplete: (input, field) => {
        const query = input.value.toLowerCase().trim();
        const dropdown = document.getElementById('autocomplete-' + field);
        
        if(!dropdown) return;
        
        // Masquer si moins de 2 caractÃ¨res
        if(query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Mots-clÃ©s par champ pour filtrer les mÃ©tiers
        const fieldKeywords = {
            'producer': ['producteur', 'productrice', 'production', 'producer'],
            'director': ['rÃ©alisateur', 'rÃ©alisatrice', 'rÃ©alisation', 'director', 'metteur en scÃ¨ne'],
            'writer': ['scÃ©nariste', 'auteur', 'autrice', 'writer', 'dialoguiste'],
            'prod-manager': ['directeur de production', 'directrice de production', 'dir. prod', 'dir prod', 'production manager']
        };
        
        const keywords = fieldKeywords[field] || [];
        
        // Fonction pour vÃ©rifier si un rÃ´le correspond au champ
        const matchesField = (role) => {
            if(keywords.length === 0) return true; // Pas de filtre dÃ©fini
            if(!role) return false; // Pas de rÃ´le = pas affichÃ©
            const roleLower = role.toLowerCase();
            return keywords.some(kw => roleLower.includes(kw));
        };
        
        // Collecter les rÃ©sultats
        const results = [];
        
        // 1. Chercher dans les contacts (favoris) - SEULEMENT techniciens pour ces champs
        const contacts = state.data.contacts || { actors: [], crew: [] };
        
        // Contacts techniciens (filtrÃ©s par mÃ©tier)
        (contacts.crew || []).forEach(c => {
            const name = c.name || '';
            const role = c.role || '';
            if(name.toLowerCase().includes(query) && matchesField(role)) {
                results.push({
                    name: name,
                    photo: c.photo || '',
                    detail: role || 'Technicien',
                    source: 'â­ Contact',
                    icon: 'ðŸŽ¥'
                });
            }
        });
        
        // 2. Chercher dans l'Univers (seulement techniciens et entreprises de prod)
        (Universe.allProfiles || []).forEach(p => {
            const name = p.name || p.assoName || p.entName || '';
            const role = p.role || '';
            
            // Ne garder que les techniciens avec le bon mÃ©tier ou les entreprises de production
            const isMatchingCrew = p.type === 'crew' && matchesField(role);
            const isMatchingEnterprise = p.type === 'enterprise' && field === 'producer' && 
                (p.entType === 'production' || p.entType === 'distribution');
            
            if(name.toLowerCase().includes(query) && (isMatchingCrew || isMatchingEnterprise)) {
                // Ã‰viter les doublons
                if(!results.find(r => r.name.toLowerCase() === name.toLowerCase())) {
                    const icon = p.type === 'crew' ? 'ðŸŽ¥' : 'ðŸ¢';
                    const detail = p.type === 'crew' ? (role || 'Technicien') : 'Entreprise';
                    results.push({
                        name: name,
                        photo: p.photo || '',
                        detail: detail + (p.city ? ' â€¢ ' + p.city : ''),
                        source: 'ðŸŒ Univers',
                        icon: icon
                    });
                }
            }
        });
        
        // Afficher les rÃ©sultats (max 8)
        if(results.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        
        dropdown.innerHTML = results.slice(0, 8).map(r => `
            <div class="autocomplete-dropdown-item" onclick="app.Presentation.selectAutocomplete('${field}', '${Utils.escape(r.name)}')">
                ${r.photo ? `<img src="${r.photo}" alt="">` : `<div class="ac-icon">${r.icon}</div>`}
                <div class="ac-info">
                    <div class="ac-name">${Utils.escape(r.name)}</div>
                    <div class="ac-detail">${Utils.escape(r.detail)}</div>
                </div>
                <span class="ac-source">${r.source}</span>
            </div>
        `).join('');
        
        dropdown.style.display = 'block';
    },
    
    // SÃ©lectionner un rÃ©sultat
    selectAutocomplete: (field, name) => {
        const inputId = field === 'prod-manager' ? 'project-prod-manager' : 'project-' + field;
        const input = document.getElementById(inputId);
        if(input) {
            input.value = name;
            Presentation.save();
        }
        
        const dropdown = document.getElementById('autocomplete-' + field);
        if(dropdown) dropdown.style.display = 'none';
    },
    
    // Fermer les dropdowns au clic ailleurs
    closeAutocompletes: () => {
        document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.style.display = 'none');
    }
};

// Fermer autocomplete au clic ailleurs
document.addEventListener('click', (e) => {
    if(!e.target.closest('.autocomplete-dropdown') && !e.target.matches('input[oninput*="autocomplete"]')) {
        Presentation.closeAutocompletes();
    }
});

const Expenses = {
    currentExpenseId: null,
    expenses: [],
    filterDept: '',
    filterStatus: '',
    filterSearch: '',
    mode: 'simple', // 'simple' ou 'advanced'
    
    // CatÃ©gories CNC officielles (nomenclature devis de production)
    CNC_CATEGORIES: [
        { 
            id: 'droits', code: '1', name: 'Droits artistiques', icon: 'ðŸ“œ',
            subcats: [
                { id: 'droits_scenario', name: 'ScÃ©nario / Adaptation' },
                { id: 'droits_musique', name: 'Droits musicaux' },
                { id: 'droits_autres', name: 'Autres droits' }
            ]
        },
        { 
            id: 'personnel', code: '2', name: 'Personnel', icon: 'ðŸ‘¥',
            subcats: [
                { id: 'personnel_realisation', name: 'RÃ©alisation' },
                { id: 'personnel_technique', name: 'Ã‰quipe technique' },
                { id: 'personnel_production', name: 'Production' }
            ]
        },
        { 
            id: 'interpretation', code: '3', name: 'InterprÃ©tation', icon: 'ðŸŽ­',
            subcats: [
                { id: 'interpretation_principaux', name: 'RÃ´les principaux' },
                { id: 'interpretation_secondaires', name: 'RÃ´les secondaires' },
                { id: 'interpretation_figuration', name: 'Figuration' }
            ]
        },
        { 
            id: 'charges', code: '4', name: 'Charges sociales', icon: 'ðŸ“Š',
            subcats: [
                { id: 'charges_artistiques', name: 'Charges artistes' },
                { id: 'charges_techniques', name: 'Charges techniciens' }
            ]
        },
        { 
            id: 'decors', code: '5', name: 'DÃ©cors & Costumes', icon: 'ðŸŽ¨',
            subcats: [
                { id: 'decors_construction', name: 'Construction dÃ©cors' },
                { id: 'decors_naturels', name: 'DÃ©cors naturels' },
                { id: 'costumes', name: 'Costumes' },
                { id: 'maquillage', name: 'Maquillage / Coiffure' }
            ]
        },
        { 
            id: 'transport', code: '6', name: 'Transports & RÃ©gie', icon: 'ðŸš—',
            subcats: [
                { id: 'transport_voyages', name: 'Voyages' },
                { id: 'transport_vehicules', name: 'VÃ©hicules' },
                { id: 'regie_defraiements', name: 'DÃ©fraiements' },
                { id: 'regie_catering', name: 'RÃ©gie / Catering' }
            ]
        },
        { 
            id: 'moyens_tech', code: '7', name: 'Moyens techniques', icon: 'ðŸŽ¥',
            subcats: [
                { id: 'tech_camera', name: 'MatÃ©riel camÃ©ra' },
                { id: 'tech_lumiere', name: 'LumiÃ¨re' },
                { id: 'tech_son', name: 'Son' },
                { id: 'tech_machinerie', name: 'Machinerie' },
                { id: 'tech_effets', name: 'Effets spÃ©ciaux plateau' }
            ]
        },
        { 
            id: 'postprod', code: '8', name: 'Post-production', icon: 'ðŸŽžï¸',
            subcats: [
                { id: 'postprod_montage', name: 'Montage' },
                { id: 'postprod_son', name: 'Post-prod son / Mixage' },
                { id: 'postprod_image', name: 'Ã‰talonnage' },
                { id: 'postprod_vfx', name: 'Effets visuels' }
            ]
        },
        { 
            id: 'assurances', code: '9', name: 'Assurances & Divers', icon: 'ðŸ“‹',
            subcats: [
                { id: 'assurances_prod', name: 'Assurances' },
                { id: 'frais_generaux', name: 'Frais gÃ©nÃ©raux' },
                { id: 'imprevus', name: 'ImprÃ©vus' }
            ]
        }
    ],
    
    // Mapping anciennes catÃ©gories â†’ nouvelles CNC
    MIGRATION_MAP: {
        'production': 'personnel',
        'technique': 'moyens_tech',
        'artistique': 'decors',
        'logistique': 'transport',
        'salaires': 'personnel', // Les salaires acteurs seront remappÃ©s vers 'interpretation'
        'divers': 'assurances',
        // Anciens dÃ©partements dÃ©taillÃ©s
        'image': 'moyens_tech',
        'lumiere': 'moyens_tech',
        'son': 'moyens_tech',
        'realisation': 'personnel',
        'decoration': 'decors',
        'costumes': 'decors',
        'maquillage': 'decors',
        'regie': 'transport',
        'transport': 'transport',
        'catering': 'transport',
        'postprod': 'postprod',
        'location': 'decors',
        'assurance': 'assurances'
    },
    
    // Taux de TVA courants
    VAT_RATES: [
        { value: 0, label: '0% (ExonÃ©rÃ©)' },
        { value: 5.5, label: '5.5% (RÃ©duit)' },
        { value: 10, label: '10% (IntermÃ©diaire)' },
        { value: 20, label: '20% (Normal)' }
    ],
    
    // Migration des donnÃ©es existantes vers le nouveau format
    migrateData: () => {
        let migrated = false;
        
        // Migrer le budget
        if(!state.data.budget) state.data.budget = {};
        if(!state.data.budget.vatMode) {
            state.data.budget.vatMode = 'HT';
            state.data.budget.defaultVatRate = 20;
            migrated = true;
        }
        if(!state.data.budget.previsionnel) {
            state.data.budget.previsionnel = {};
            // Migrer les anciennes enveloppes vers le prÃ©visionnel
            if(state.data.budget.envelopes) {
                Object.entries(state.data.budget.envelopes).forEach(([oldCat, amount]) => {
                    const newCat = Expenses.MIGRATION_MAP[oldCat] || 'assurances';
                    if(!state.data.budget.previsionnel[newCat]) {
                        state.data.budget.previsionnel[newCat] = { budgetHT: 0, budgetTTC: 0 };
                    }
                    state.data.budget.previsionnel[newCat].budgetHT += amount;
                    state.data.budget.previsionnel[newCat].budgetTTC += amount * 1.2;
                });
                migrated = true;
            }
        }
        if(!state.data.budget.alertThresholds) {
            state.data.budget.alertThresholds = { warning: 80, danger: 100 };
        }
        
        // Migrer les dÃ©penses
        (state.data.expenses || []).forEach(exp => {
            // Migrer la catÃ©gorie
            if(exp.department && !exp.category) {
                // Cas spÃ©cial : salaires acteurs â†’ interprÃ©tation
                if(exp.department === 'salaires' && exp.salaryPersonType === 'actor') {
                    exp.category = 'interpretation';
                    exp.subcategory = 'interpretation_principaux';
                } else if(exp.department === 'salaires' && exp.salaryPersonType === 'crew') {
                    exp.category = 'personnel';
                    exp.subcategory = 'personnel_technique';
                } else {
                    exp.category = Expenses.MIGRATION_MAP[exp.department] || 'assurances';
                }
                migrated = true;
            }
            
            // Migrer les montants HT/TTC
            if(exp.amount !== undefined && exp.amountHT === undefined) {
                exp.amountHT = exp.amount;
                exp.vatRate = 0; // Par dÃ©faut, pas de TVA sur les anciennes
                exp.amountTTC = exp.amount;
                migrated = true;
            }
            
            // Migrer photo vers attachments
            if(exp.photo && (!exp.attachments || exp.attachments.length === 0)) {
                exp.attachments = [{
                    id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    name: 'justificatif.jpg',
                    url: exp.photo,
                    type: 'photo'
                }];
                migrated = true;
            }
        });
        
        if(migrated) {
            console.log('ðŸ“Š Migration budget/dÃ©penses effectuÃ©e');
            Store.save();
        }
        
        return migrated;
    },
    
    // Obtenir une catÃ©gorie par ID
    getCategory: (catId) => {
        return Expenses.CNC_CATEGORIES.find(c => c.id === catId);
    },
    
    // Obtenir toutes les sous-catÃ©gories Ã  plat
    getAllSubcategories: () => {
        const result = [];
        Expenses.CNC_CATEGORIES.forEach(cat => {
            cat.subcats.forEach(sub => {
                result.push({ ...sub, parentId: cat.id, parentName: cat.name, parentIcon: cat.icon });
            });
        });
        return result;
    },
    
    // Calculer le montant TTC Ã  partir du HT
    calculateTTC: (amountHT, vatRate) => {
        return Math.round(amountHT * (1 + vatRate / 100) * 100) / 100;
    },
    
    // Calculer le montant HT Ã  partir du TTC
    calculateHT: (amountTTC, vatRate) => {
        return Math.round(amountTTC / (1 + vatRate / 100) * 100) / 100;
    },
    
    // Initialise le module
    init: () => {
        if(!state.data.expenses) state.data.expenses = [];
        if(!state.data.budget) state.data.budget = { total: 0, currency: 'â‚¬', manager: '', envelopes: {}, deptManagers: {}, previsionnel: {}, vatMode: 'HT', defaultVatRate: 20 };
        if(!state.data.budget.envelopes) state.data.budget.envelopes = {};
        if(!state.data.budget.deptManagers) state.data.budget.deptManagers = {};
        if(!state.data.budget.previsionnel) state.data.budget.previsionnel = {};
        
        // Migration des anciennes donnÃ©es
        Expenses.migrateData();
        
        Expenses.expenses = state.data.expenses;
        
        // Charger le mode depuis localStorage
        const savedMode = localStorage.getItem('moteur_expenses_mode_' + (state.currentUser?.uid || 'guest'));
        Expenses.mode = savedMode || 'simple';
        
        Expenses.populateCategories();
        Expenses.populateManager();
        Expenses.loadBudget();
        Expenses.loadFinanceParams();
        Expenses.loadManagerEmailPref();
        Expenses.renderCategoryManagers();
        Expenses.applyMode();
        Expenses.render();
    },
    
    // Changer de mode Simple/AvancÃ©
    setMode: (mode) => {
        Expenses.mode = mode;
        localStorage.setItem('moteur_expenses_mode_' + (state.currentUser?.uid || 'guest'), mode);
        Expenses.applyMode();
        Expenses.render();
    },
    
    // Appliquer le mode visuel
    applyMode: () => {
        const isSimple = Expenses.mode === 'simple';
        
        // Boutons toggle
        const btnSimple = document.getElementById('expenses-mode-simple');
        const btnAdvanced = document.getElementById('expenses-mode-advanced');
        if(btnSimple) {
            btnSimple.style.background = isSimple ? 'var(--primary)' : 'var(--bg)';
            btnSimple.style.color = isSimple ? 'white' : 'var(--text-main)';
            btnSimple.style.borderColor = isSimple ? 'var(--primary)' : 'var(--border)';
        }
        if(btnAdvanced) {
            btnAdvanced.style.background = isSimple ? 'var(--bg)' : 'var(--primary)';
            btnAdvanced.style.color = isSimple ? 'var(--text-main)' : 'white';
            btnAdvanced.style.borderColor = isSimple ? 'var(--border)' : 'var(--primary)';
        }
        
        // Sidebar (avancÃ© uniquement)
        const sidebar = document.getElementById('expenses-sidebar-advanced');
        if(sidebar) sidebar.style.display = isSimple ? 'none' : 'block';
        
        // Header simple
        const simpleHeader = document.getElementById('expenses-simple-header');
        if(simpleHeader) simpleHeader.style.display = isSimple ? 'block' : 'none';
        
        // Summary avancÃ©
        const advancedSummary = document.getElementById('expenses-summary-advanced');
        if(advancedSummary) advancedSummary.style.display = isSimple ? 'none' : 'flex';
        
        // Filtres
        const advancedFilters = document.getElementById('expenses-filters-advanced');
        const simpleFilters = document.getElementById('expenses-filters-simple');
        if(advancedFilters) advancedFilters.style.display = isSimple ? 'none' : 'flex';
        if(simpleFilters) simpleFilters.style.display = isSimple ? 'block' : 'none';
        
        // Section salaires (avancÃ© uniquement)
        const salariesSection = document.getElementById('expenses-salaries-section');
        if(salariesSection) salariesSection.style.display = isSimple ? 'none' : 'block';
        
        // Ajuster la grille container
        const container = document.querySelector('.expenses-container');
        if(container) {
            container.style.gridTemplateColumns = isSimple ? '1fr' : '280px 1fr';
        }
        
        // Synchroniser le budget simple
        const budgetSimple = document.getElementById('expenses-budget-simple');
        if(budgetSimple) {
            budgetSimple.value = state.data.budget?.total || '';
        }
    },
    
    // Sauvegarder budget depuis mode simple
    saveBudgetSimple: () => {
        const value = parseFloat(document.getElementById('expenses-budget-simple')?.value) || 0;
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.total = value;
        
        // Synchroniser avec le champ avancÃ©
        const advancedInput = document.getElementById('expenses-budget-total');
        if(advancedInput) advancedInput.value = value;
        
        Store.save();
        Expenses.updateSummary();
    },
    
    // Remplit les selects avec les catÃ©gories CNC
    populateCategories: () => {
        const categories = Expenses.CNC_CATEGORIES;
        
        // Remplir les selects de catÃ©gorie
        const selects = ['expense-category', 'expenses-filter-dept'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if(!select) return;
            
            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            if(firstOption) select.appendChild(firstOption);
            
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = `${cat.icon} ${cat.code}. ${cat.name}`;
                select.appendChild(opt);
            });
        });
        
        // Liste des catÃ©gories CNC dans la sidebar
        const catList = document.getElementById('expenses-dept-list');
        if(catList) {
            catList.innerHTML = '';
            const currency = state.data.budget?.currency || 'â‚¬';
            const expenses = state.data.expenses || [];
            const previsionnel = state.data.budget?.previsionnel || {};
            const vatMode = state.data.budget?.vatMode || 'HT';
            const thresholds = state.data.budget?.alertThresholds || { warning: 80, danger: 100 };
            
            categories.forEach(cat => {
                const budget = previsionnel[cat.id]?.[vatMode === 'HT' ? 'budgetHT' : 'budgetTTC'] || 0;
                const catManager = state.data.budget?.deptManagers?.[cat.id];
                
                // Trouver le nom du responsable
                let managerName = '';
                if(catManager?.email) {
                    const person = Expenses.findPersonByEmail(catManager.email);
                    managerName = person?.name || catManager.email.split('@')[0];
                }
                
                // Calculer les dÃ©penses pour cette catÃ©gorie
                const catExpenses = expenses.filter(e => e.category === cat.id || e.department === cat.id);
                const spent = catExpenses
                    .filter(e => e.status === 'approved' || e.status === 'done')
                    .reduce((sum, e) => sum + (vatMode === 'HT' ? (e.amountHT || e.amount || 0) : (e.amountTTC || e.amount || 0)), 0);
                
                const countPending = catExpenses.filter(e => e.status === 'pending').length;
                const countApproved = catExpenses.filter(e => e.status === 'approved' || e.status === 'done').length;
                const countMissingRate = catExpenses.filter(e => e.salaryMissingRate).length;
                
                // Calculer le pourcentage et l'Ã©tat d'alerte
                const percent = budget > 0 ? Math.round((spent / budget) * 100) : 0;
                const alertState = percent >= thresholds.danger ? 'danger' : percent >= thresholds.warning ? 'warning' : 'ok';
                
                // Badges
                let badges = '';
                if(countMissingRate > 0) badges += `<span class="dept-badge red" title="Tarif manquant">${countMissingRate}</span>`;
                if(countPending > 0) badges += `<span class="dept-badge yellow" title="En attente">${countPending}</span>`;
                if(alertState === 'danger') badges += `<span class="dept-badge red" title="Budget dÃ©passÃ© !">ðŸ”´</span>`;
                else if(alertState === 'warning') badges += `<span class="dept-badge orange" title="Attention budget">âš ï¸</span>`;
                
                // Barre de progression
                const progressColor = alertState === 'danger' ? 'var(--danger)' : alertState === 'warning' ? '#f59e0b' : 'var(--success)';
                const progressBar = budget > 0 ? `
                    <div style="height:4px; background:var(--border); border-radius:2px; margin-top:4px; overflow:hidden;">
                        <div style="height:100%; width:${Math.min(percent, 100)}%; background:${progressColor}; transition:width 0.3s;"></div>
                    </div>
                ` : '';
                
                const div = document.createElement('div');
                div.className = 'expense-dept-item' + (Expenses.filterDept === cat.id ? ' active' : '');
                div.innerHTML = `
                    <div class="flex-1">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span class="dept-name">${cat.icon} ${cat.code}. ${cat.name}</span>
                            <div class="dept-badges">${badges}</div>
                        </div>
                        ${budget > 0 ? `
                            <div style="font-size:0.7rem; color:var(--text-sec);">
                                PrÃ©vu: ${budget.toLocaleString()} ${currency} ${vatMode}
                                ${percent > 0 ? `<span style="color:${progressColor}; font-weight:600;">(${percent}%)</span>` : ''}
                            </div>
                            ${progressBar}
                        ` : ''}
                        ${managerName ? `<div style="font-size:0.7rem; color:var(--primary); margin-top:2px;">ðŸ‘¤ ${Utils.escape(managerName)}</div>` : ''}
                    </div>
                    <div style="text-align:right;">
                        <span class="dept-amount" id="cat-total-${cat.id}" style="color:${alertState === 'danger' ? 'var(--danger)' : 'var(--text-main)'}">${spent.toLocaleString()} ${currency}</span>
                        <button onclick="event.stopPropagation(); app.Expenses.editCategoryBudget('${cat.id}')" style="background:none; border:none; cursor:pointer; font-size:0.8rem; padding:2px 5px; margin-left:5px;" title="ParamÃ¨tres de la catÃ©gorie">âš™ï¸</button>
                    </div>
                `;
                div.onclick = (e) => {
                    if(e.target.tagName === 'BUTTON') return;
                    Expenses.filterDept = Expenses.filterDept === cat.id ? '' : cat.id;
                    const filterSelect = document.getElementById('expenses-filter-dept');
                    if(filterSelect) filterSelect.value = Expenses.filterDept;
                    Expenses.applyFilters();
                    Expenses.populateCategories();
                };
                catList.appendChild(div);
            });
        }
    },
    
    // Alias pour rÃ©trocompatibilitÃ©
    populateDepartments: () => {
        Expenses.populateCategories();
    },
    
    // Remplit le select du responsable budget
    populateManager: () => {
        const select = document.getElementById('expenses-manager');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Choisir --</option>';
        
        // Ajouter les membres de l'Ã©quipe
        if(state.data.crew) {
            state.data.crew.forEach(member => {
                if(member.email) {
                    const opt = document.createElement('option');
                    opt.value = member.email;
                    opt.textContent = member.name + ' (' + (member.role || 'Ã‰quipe') + ')';
                    select.appendChild(opt);
                }
            });
        }
        
        // SÃ©lectionner le manager actuel
        if(state.data.budget?.manager) {
            select.value = state.data.budget.manager;
        }
    },
    
    // Charge le budget
    loadBudget: () => {
        // Synchroniser depuis la prÃ©sentation si le budget n'est pas dÃ©fini
        if(state.data.presentation?.budget && !state.data.budget?.total) {
            if(!state.data.budget) state.data.budget = { total: 0, currency: 'â‚¬', manager: '', envelopes: {}, previsionnel: {}, vatMode: 'HT', defaultVatRate: 20 };
            state.data.budget.total = parseFloat(state.data.presentation.budget) || 0;
        }
        
        const budget = state.data.budget || { total: 0, currency: 'â‚¬', vatMode: 'HT', defaultVatRate: 20 };
        const vatMode = budget.vatMode || 'HT';
        
        // Calculer le total depuis le prÃ©visionnel
        let totalHT = 0, totalTTC = 0;
        Object.values(budget.previsionnel || {}).forEach(p => {
            totalHT += p.budgetHT || 0;
            totalTTC += p.budgetTTC || 0;
        });
        
        const displayTotal = vatMode === 'HT' ? totalHT : totalTTC;
        const budgetInput = document.getElementById('expenses-budget-total');
        if(budgetInput) budgetInput.value = displayTotal || budget.total || '';
        
        const currencySelect = document.getElementById('expenses-currency');
        if(currencySelect) currencySelect.value = budget.currency || 'â‚¬';
        
        const managerSelect = document.getElementById('expenses-manager');
        if(managerSelect && budget.manager) managerSelect.value = budget.manager;
        
        // Mode HT/TTC
        const btnHT = document.getElementById('vat-mode-ht');
        const btnTTC = document.getElementById('vat-mode-ttc');
        if(btnHT) {
            btnHT.style.background = vatMode === 'HT' ? 'var(--primary)' : 'var(--bg)';
            btnHT.style.color = vatMode === 'HT' ? 'white' : 'var(--text-main)';
            btnHT.style.borderColor = vatMode === 'HT' ? 'var(--primary)' : 'var(--border)';
        }
        if(btnTTC) {
            btnTTC.style.background = vatMode === 'TTC' ? 'var(--primary)' : 'var(--bg)';
            btnTTC.style.color = vatMode === 'TTC' ? 'white' : 'var(--text-main)';
            btnTTC.style.borderColor = vatMode === 'TTC' ? 'var(--primary)' : 'var(--border)';
        }
        
        // TVA par dÃ©faut
        const vatSelect = document.getElementById('expenses-default-vat');
        if(vatSelect) vatSelect.value = budget.defaultVatRate || 20;
        
        // Seuils d'alerte
        const thresholds = budget.alertThresholds || { warning: 80, danger: 100 };
        const warnInput = document.getElementById('alert-threshold-warning');
        const dangerInput = document.getElementById('alert-threshold-danger');
        if(warnInput) warnInput.value = thresholds.warning;
        if(dangerInput) dangerInput.value = thresholds.danger;
    },
    
    // Sauvegarde le budget
    saveBudget: () => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.total = parseFloat(document.getElementById('expenses-budget-total').value) || 0;
        state.data.budget.currency = document.getElementById('expenses-currency').value;
        
        // Synchroniser avec la prÃ©sentation
        if(!state.data.presentation) state.data.presentation = {};
        state.data.presentation.budget = state.data.budget.total;
        
        // Mettre Ã  jour le champ dans la prÃ©sentation si visible
        const projectBudgetInput = document.getElementById('project-budget');
        if(projectBudgetInput) projectBudgetInput.value = state.data.budget.total || '';
        
        Store.save();
        Expenses.updateSummary();
    },
    
    // Changer le mode HT/TTC
    setVatMode: (mode) => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.vatMode = mode;
        
        // Mettre Ã  jour les boutons
        const btnHT = document.getElementById('vat-mode-ht');
        const btnTTC = document.getElementById('vat-mode-ttc');
        if(btnHT) {
            btnHT.style.background = mode === 'HT' ? 'var(--primary)' : 'var(--bg)';
            btnHT.style.color = mode === 'HT' ? 'white' : 'var(--text-main)';
            btnHT.style.borderColor = mode === 'HT' ? 'var(--primary)' : 'var(--border)';
        }
        if(btnTTC) {
            btnTTC.style.background = mode === 'TTC' ? 'var(--primary)' : 'var(--bg)';
            btnTTC.style.color = mode === 'TTC' ? 'white' : 'var(--text-main)';
            btnTTC.style.borderColor = mode === 'TTC' ? 'var(--primary)' : 'var(--border)';
        }
        
        Store.save();
        Expenses.loadBudget();
        Expenses.populateCategories();
        Expenses.updateSummary();
    },
    
    // Sauvegarder la TVA par dÃ©faut
    saveDefaultVat: () => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.defaultVatRate = parseFloat(document.getElementById('expenses-default-vat').value) || 20;
        Store.save();
    },
    
    // Sauvegarder les seuils d'alerte
    saveAlertThresholds: () => {
        if(!state.data.budget) state.data.budget = {};
        if(!state.data.budget.alertThresholds) state.data.budget.alertThresholds = {};
        state.data.budget.alertThresholds.warning = parseFloat(document.getElementById('alert-threshold-warning').value) || 80;
        state.data.budget.alertThresholds.danger = parseFloat(document.getElementById('alert-threshold-danger').value) || 100;
        Store.save();
        Expenses.populateCategories();
    },
    
    // Sauvegarde le manager
    saveManager: () => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.manager = document.getElementById('expenses-manager').value;
        Store.save();
    },
    
    // Sauvegarde la prÃ©fÃ©rence email du manager global
    saveManagerEmailPref: () => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.managerEmailNotif = document.getElementById('manager-email-notif').checked;
        Store.save();
    },
    
    // Charge la prÃ©fÃ©rence email du manager global
    loadManagerEmailPref: () => {
        const checkbox = document.getElementById('manager-email-notif');
        if(checkbox) {
            checkbox.checked = state.data.budget?.managerEmailNotif !== false; // true par dÃ©faut
        }
    },
    
    // Affiche la liste des responsables par catÃ©gorie CNC
    renderCategoryManagers: () => {
        const container = document.getElementById('dept-managers-list');
        if(!container) return;
        
        const deptManagers = state.data.budget?.deptManagers || {};
        
        if(Object.keys(deptManagers).length === 0) {
            container.innerHTML = '<div style="color: var(--text-sec); font-size: 0.85rem; padding: 10px; text-align: center;">Aucun responsable assignÃ©</div>';
            return;
        }
        
        let html = '';
        Object.entries(deptManagers).forEach(([catId, manager]) => {
            const cat = Expenses.getCategory(catId);
            if(!cat || !manager.email) return;
            
            const person = Expenses.findPersonByEmail(manager.email);
            const name = person?.name || manager.email.split('@')[0];
            
            html += `<div class="dept-manager-item">
                <div class="dept-manager-info">
                    <span class="dept-manager-dept">${cat.icon} ${cat.name}</span>
                    <span class="dept-manager-name">${Utils.escape(name)}</span>
                </div>
                <div class="dept-manager-actions">
                    <label title="Recevoir les emails" style="cursor: pointer;">
                        <input type="checkbox" ${manager.emailNotif !== false ? 'checked' : ''} onchange="app.Expenses.toggleDeptManagerEmail('${catId}', this.checked)">
                        ðŸ“§
                    </label>
                    <button onclick="app.Expenses.removeDeptManager('${catId}')" title="Retirer" style="background: none; border: none; cursor: pointer; color: var(--danger);">âœ•</button>
                </div>
            </div>`;
        });
        
        container.innerHTML = html;
    },
    
    // Alias pour rÃ©trocompatibilitÃ©
    renderDeptManagers: () => {
        Expenses.renderCategoryManagers();
    },
    
    // Trouve une personne par email
    findPersonByEmail: (email) => {
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const allPeople = [...actors, ...crew];
        return allPeople.find(p => p.email === email);
    },
    
    // Supprime un responsable dÃ©partement
    removeDeptManager: async (deptId) => {
        const dept = Expenses.departments.find(d => d.id === deptId);
        if(!await ConfirmModal.confirmDelete(`Le responsable de ${dept?.name} sera retirÃ©.`)) return;
        
        if(state.data.budget?.deptManagers) {
            delete state.data.budget.deptManagers[deptId];
            Store.save();
            Expenses.renderDeptManagers();
            Utils.toast('Responsable retirÃ©', 'success');
        }
    },
    
    // Toggle email notification pour un responsable dÃ©partement
    toggleDeptManagerEmail: (deptId, enabled) => {
        if(state.data.budget?.deptManagers?.[deptId]) {
            state.data.budget.deptManagers[deptId].emailNotif = enabled;
            Store.save();
        }
    },
    
    // VÃ©rifie si l'utilisateur est responsable d'un dÃ©partement
    isDeptManager: (deptId) => {
        const manager = state.data.budget?.deptManagers?.[deptId];
        return manager && manager.email === state.currentUser?.email;
    },
    
    // VÃ©rifie si l'utilisateur peut valider une dÃ©pense
    canValidateExpense: (expense) => {
        // Le responsable budget global peut tout valider
        if(Expenses.isBudgetManager()) return true;
        
        // Le responsable du dÃ©partement peut valider les dÃ©penses de son dÃ©partement
        if(expense.department && expense.department !== 'divers') {
            return Expenses.isDeptManager(expense.department);
        }
        
        return false;
    },
    
    // Sauvegarde les paramÃ¨tres financiers
    saveFinanceParams: () => {
        if(!state.data.budget) state.data.budget = {};
        
        state.data.budget.kmRate = parseFloat(document.getElementById('param-km-rate').value) || 0.55;
        state.data.budget.perDiemMeal = parseFloat(document.getElementById('param-perdiem-meal').value) || 19;
        state.data.budget.perDiemHotel = parseFloat(document.getElementById('param-perdiem-hotel').value) || 80;
        state.data.budget.overtimeThreshold = parseFloat(document.getElementById('param-overtime-threshold').value) || 8;
        state.data.budget.overtimeRates = {
            first: parseFloat(document.getElementById('param-overtime-1').value) || 25,
            second: parseFloat(document.getElementById('param-overtime-2').value) || 50,
            third: parseFloat(document.getElementById('param-overtime-3').value) || 100
        };
        
        Store.save();
        Utils.toast('ParamÃ¨tres financiers enregistrÃ©s', 'success');
    },
    
    // Charge les paramÃ¨tres financiers
    loadFinanceParams: () => {
        const budget = state.data.budget || {};
        
        document.getElementById('param-km-rate').value = budget.kmRate ?? 0.55;
        document.getElementById('param-perdiem-meal').value = budget.perDiemMeal ?? 19;
        document.getElementById('param-perdiem-hotel').value = budget.perDiemHotel ?? 80;
        document.getElementById('param-overtime-threshold').value = budget.overtimeThreshold ?? 8;
        
        const rates = budget.overtimeRates || { first: 25, second: 50, third: 100 };
        document.getElementById('param-overtime-1').value = rates.first ?? 25;
        document.getElementById('param-overtime-2').value = rates.second ?? 50;
        document.getElementById('param-overtime-3').value = rates.third ?? 100;
    },
    
    // Ã‰diter le budget prÃ©visionnel d'une catÃ©gorie CNC
    editCategoryBudget: (catId) => {
        const cat = Expenses.getCategory(catId);
        if(!cat) return;
        
        // Seul le responsable budget peut modifier
        if(!Expenses.isBudgetManager()) {
            Utils.toast('Seul le responsable budget peut modifier les prÃ©visionnels', 'error');
            return;
        }
        
        const currency = state.data.budget?.currency || 'â‚¬';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const current = state.data.budget?.previsionnel?.[catId] || { budgetHT: 0, budgetTTC: 0 };
        const currentManager = state.data.budget?.deptManagers?.[catId] || {};
        
        // Liste des personnes pour le responsable
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const allPeople = [...actors, ...crew].filter(p => p.email);
        
        let peopleOptions = '<option value="">-- Aucun responsable --</option>';
        allPeople.forEach(p => {
            const selected = currentManager.email === p.email ? 'selected' : '';
            peopleOptions += `<option value="${p.email}" ${selected}>${Utils.escape(p.name)} (${p.email})</option>`;
        });
        
        // Sous-catÃ©gories
        let subcatHtml = '<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);"><label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:8px;">ðŸ“‚ Sous-catÃ©gories</label>';
        cat.subcats.forEach(sub => {
            subcatHtml += `<div style="font-size:0.85rem; color:var(--text-main); padding:4px 0;">â€¢ ${sub.name}</div>`;
        });
        subcatHtml += '</div>';
        
        const modal = document.createElement('div');
        modal.id = 'category-budget-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:450px; max-width:90%; max-height:90vh; overflow-y:auto;">
                <h3 style="margin:0 0 20px; color:var(--text-main);">${cat.icon} ${cat.code}. ${cat.name}</h3>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label class="form-label-alt">ðŸ’° Budget HT (${currency})</label>
                        <input type="number" id="cat-budget-ht" value="${current.budgetHT || ''}" placeholder="0" class="n8-input-11" oninput="document.getElementById('cat-budget-ttc').value = Math.round(this.value * 1.2 * 100) / 100">
                    </div>
                    <div>
                        <label class="form-label-alt">ðŸ’° Budget TTC (${currency})</label>
                        <input type="number" id="cat-budget-ttc" value="${current.budgetTTC || ''}" placeholder="0" class="n8-input-11" oninput="document.getElementById('cat-budget-ht').value = Math.round(this.value / 1.2 * 100) / 100">
                    </div>
                </div>
                
                <div class="mb-15">
                    <label class="form-label-alt">ðŸ‘¤ Responsable de la catÃ©gorie</label>
                    <select id="cat-manager" class="n8-input-12">
                        ${peopleOptions}
                    </select>
                </div>
                
                <label style="display:flex; align-items:center; gap:8px; margin-bottom:15px; font-size:0.9rem; cursor:pointer; color:var(--text-main);">
                    <input type="checkbox" id="cat-manager-email" ${currentManager.emailNotif !== false ? 'checked' : ''}>
                    ðŸ“§ Notifier par email
                </label>
                
                ${subcatHtml}
                
                <div class="flex-end-mt20">
                    <button onclick="document.getElementById('category-budget-modal').remove()" class="btn-outline">Annuler</button>
                    <button onclick="app.Expenses.saveCategoryBudget('${catId}')" class="btn-success-compact">ðŸ’¾ Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('cat-budget-ht').focus();
    },
    
    // Sauvegarder le budget d'une catÃ©gorie
    saveCategoryBudget: (catId) => {
        const budgetHT = parseFloat(document.getElementById('cat-budget-ht').value) || 0;
        const budgetTTC = parseFloat(document.getElementById('cat-budget-ttc').value) || 0;
        const managerEmail = document.getElementById('cat-manager').value;
        const managerEmailNotif = document.getElementById('cat-manager-email').checked;
        
        if(!state.data.budget) state.data.budget = {};
        if(!state.data.budget.previsionnel) state.data.budget.previsionnel = {};
        if(!state.data.budget.deptManagers) state.data.budget.deptManagers = {};
        
        // Sauvegarder le prÃ©visionnel
        state.data.budget.previsionnel[catId] = { budgetHT, budgetTTC };
        
        // Sauvegarder le responsable
        if(managerEmail) {
            state.data.budget.deptManagers[catId] = {
                email: managerEmail,
                emailNotif: managerEmailNotif,
                assignedAt: state.data.budget.deptManagers[catId]?.assignedAt || new Date().toISOString(),
                assignedBy: state.data.budget.deptManagers[catId]?.assignedBy || state.currentUser?.email
            };
        } else {
            delete state.data.budget.deptManagers[catId];
        }
        
        // Recalculer le budget total
        let totalHT = 0;
        Object.values(state.data.budget.previsionnel).forEach(p => {
            totalHT += p.budgetHT || 0;
        });
        state.data.budget.total = totalHT;
        
        Store.save();
        
        document.getElementById('category-budget-modal').remove();
        Expenses.populateCategories();
        Expenses.updateSummary();
        Expenses.loadBudget();
        Utils.toast('Budget de la catÃ©gorie mis Ã  jour !', 'success');
    },
    
    // Renommer pour rÃ©trocompatibilitÃ© (ancienne fonction)
    editEnvelope: (deptId, deptName) => {
        // Seul le responsable budget ou le propriÃ©taire peut modifier les enveloppes
        if(!Expenses.isBudgetManager()) {
            Utils.toast('Seul le responsable budget peut modifier les paramÃ¨tres', 'error');
            return;
        }
        
        const currentEnvelope = state.data.budget?.envelopes?.[deptId] || 0;
        const currency = state.data.budget?.currency || 'â‚¬';
        const currentManager = state.data.budget?.deptManagers?.[deptId] || {};
        
        // Construire la liste des personnes pour le responsable
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const allPeople = [...actors, ...crew].filter(p => p.email);
        
        let peopleOptions = '<option value="">-- Aucun responsable --</option>';
        allPeople.forEach(p => {
            const selected = currentManager.email === p.email ? 'selected' : '';
            peopleOptions += `<option value="${p.email}" ${selected}>${Utils.escape(p.name)} (${p.email})</option>`;
        });
        
        const modal = document.createElement('div');
        modal.id = 'envelope-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:400px; max-width:90%;">
                <h3 style="margin:0 0 20px; color:var(--text-main);">âš™ï¸ ${deptName}</h3>
                
                <div class="mb-20">
                    <label class="form-label-alt">ðŸ’° Budget allouÃ© (${currency})</label>
                    <input type="number" id="envelope-amount" value="${currentEnvelope}" placeholder="0" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); font-size:1.1rem;">
                </div>
                
                <div class="mb-15">
                    <label class="form-label-alt">ðŸ‘¤ Responsable du dÃ©partement</label>
                    <select id="envelope-manager" class="n8-input-12">
                        ${peopleOptions}
                    </select>
                </div>
                
                <label style="display:flex; align-items:center; gap:8px; margin-bottom:20px; font-size:0.9rem; cursor:pointer; color:var(--text-main);">
                    <input type="checkbox" id="envelope-manager-email" ${currentManager.emailNotif !== false ? 'checked' : ''}>
                    ðŸ“§ Notifier par email
                </label>
                
                <div class="flex-end">
                    <button onclick="document.getElementById('envelope-modal').remove()" class="btn-outline">Annuler</button>
                    <button onclick="app.Expenses.saveEnvelope('${deptId}')" class="btn-success-compact">ðŸ’¾ Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('envelope-amount').focus();
    },
    
    isBudgetManager: () => {
        // Le propriÃ©taire du projet a toujours accÃ¨s
        if(state.currentRole === 'owner') return true;
        
        // VÃ©rifier si l'utilisateur est le responsable budget
        const managerEmail = state.data.budget?.manager;
        if(!managerEmail || !state.currentUser) return false;
        
        return state.currentUser.email === managerEmail;
    },
    
    saveEnvelope: (deptId) => {
        const amount = parseFloat(document.getElementById('envelope-amount').value) || 0;
        const managerEmail = document.getElementById('envelope-manager').value;
        const managerEmailNotif = document.getElementById('envelope-manager-email').checked;
        
        if(!state.data.budget) state.data.budget = {};
        if(!state.data.budget.envelopes) state.data.budget.envelopes = {};
        if(!state.data.budget.deptManagers) state.data.budget.deptManagers = {};
        
        // Sauvegarder l'enveloppe
        state.data.budget.envelopes[deptId] = amount;
        
        // Sauvegarder le responsable dÃ©partement
        if(managerEmail) {
            state.data.budget.deptManagers[deptId] = {
                email: managerEmail,
                emailNotif: managerEmailNotif,
                assignedAt: state.data.budget.deptManagers[deptId]?.assignedAt || new Date().toISOString(),
                assignedBy: state.data.budget.deptManagers[deptId]?.assignedBy || state.currentUser?.email
            };
        } else {
            // Supprimer le responsable si aucun sÃ©lectionnÃ©
            delete state.data.budget.deptManagers[deptId];
        }
        
        Store.save();
        
        document.getElementById('envelope-modal').remove();
        Expenses.populateDepartments();
        Expenses.updateDeptTotals();
        Utils.toast('ParamÃ¨tres du dÃ©partement mis Ã  jour !', 'success');
    },
    
    // Rendu principal
    render: () => {
        Expenses.updateSummary();
        Expenses.updateDeptTotals();
        Expenses.populateDepartments();
        Expenses.renderExpensesList();
        Expenses.renderSalaries();
        Expenses.updateSalariesVisibility();
    },
    
    // Met Ã  jour les totaux
    updateSummary: () => {
        const currency = state.data.budget?.currency || 'â‚¬';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const previsionnel = state.data.budget?.previsionnel || {};
        
        // Calculer le budget total depuis le prÃ©visionnel
        let budgetTotal = 0;
        Object.values(previsionnel).forEach(p => {
            budgetTotal += vatMode === 'HT' ? (p.budgetHT || 0) : (p.budgetTTC || 0);
        });
        // Fallback sur l'ancien total si pas de prÃ©visionnel
        if(budgetTotal === 0) budgetTotal = state.data.budget?.total || 0;
        
        // Calculer le total dÃ©pensÃ© (selon mode HT/TTC)
        let totalSpent = 0;
        state.data.expenses?.forEach(exp => {
            if(exp.status === 'approved' || exp.status === 'done') {
                if(vatMode === 'HT') {
                    totalSpent += parseFloat(exp.amountHT) || parseFloat(exp.amount) || 0;
                } else {
                    totalSpent += parseFloat(exp.amountTTC) || parseFloat(exp.amount) || 0;
                }
            }
        });
        
        // Ajouter les salaires calculÃ©s (mode avancÃ© uniquement)
        if(Expenses.mode === 'advanced') {
            const salariesTotal = Expenses.calculateSalariesTotal();
            totalSpent += salariesTotal;
        }
        
        const remaining = budgetTotal - totalSpent;
        const percentUsed = budgetTotal > 0 ? Math.round((totalSpent / budgetTotal) * 100) : 0;
        
        // Mode avancÃ©
        const budgetEl = document.getElementById('expenses-total-budget');
        const spentEl = document.getElementById('expenses-total-spent');
        const remainingEl = document.getElementById('expenses-total-remaining');
        
        if(budgetEl) budgetEl.textContent = budgetTotal.toLocaleString() + ' ' + currency + ' ' + vatMode;
        if(spentEl) spentEl.innerHTML = totalSpent.toLocaleString() + ' ' + currency + ` <span style="font-size:0.75rem; opacity:0.8;">(${percentUsed}%)</span>`;
        if(remainingEl) remainingEl.textContent = remaining.toLocaleString() + ' ' + currency;
        
        // Changer la couleur si dÃ©passement (mode avancÃ©)
        const remainingCard = remainingEl?.parentElement;
        if(remainingCard) {
            if(remaining < 0) {
                remainingCard.classList.remove('success');
                remainingCard.classList.add('danger');
            } else {
                remainingCard.classList.remove('danger');
                remainingCard.classList.add('success');
            }
        }
        
        // Mode simple
        const spentSimple = document.getElementById('expenses-spent-simple');
        const remainingSimple = document.getElementById('expenses-remaining-simple');
        const remainingSimpleCard = document.getElementById('expenses-remaining-simple-card');
        
        if(spentSimple) spentSimple.textContent = totalSpent.toLocaleString() + ' ' + currency;
        if(remainingSimple) remainingSimple.textContent = remaining.toLocaleString() + ' ' + currency;
        if(remainingSimpleCard) {
            remainingSimpleCard.style.background = remaining < 0 ? 'var(--danger)' : 'var(--success)';
        }
        
        // Mettre Ã  jour le champ budget total
        const budgetInput = document.getElementById('expenses-budget-total');
        if(budgetInput) budgetInput.value = budgetTotal || '';
    },
    
    // Met Ã  jour les totaux par catÃ©gorie (maintenant gÃ©rÃ© par populateCategories)
    updateDeptTotals: () => {
        // Cette fonction est maintenant gÃ©rÃ©e par populateCategories()
        // On la garde pour rÃ©trocompatibilitÃ© mais elle appelle simplement populateCategories
        Expenses.populateCategories();
    },
    
    // Applique les filtres
    applyFilters: () => {
        // Mode simple ou avancÃ©
        if(Expenses.mode === 'simple') {
            const statusFilter = document.getElementById('expenses-filter-status-simple')?.value || '';
            const searchFilter = document.getElementById('expenses-filter-search-simple')?.value?.toLowerCase() || '';
            
            // Convertir les statuts simples
            if(statusFilter === 'paid') {
                Expenses.filterStatus = 'done';
            } else if(statusFilter === 'unpaid') {
                Expenses.filterStatus = 'pending';
            } else {
                Expenses.filterStatus = '';
            }
            
            Expenses.filterDept = '';
            Expenses.filterSearch = searchFilter;
        } else {
            Expenses.filterDept = document.getElementById('expenses-filter-dept')?.value || '';
            Expenses.filterStatus = document.getElementById('expenses-filter-status')?.value || '';
            Expenses.filterSearch = document.getElementById('expenses-filter-search')?.value?.toLowerCase() || '';
        }
        
        Expenses.renderExpensesList();
        Expenses.populateDepartments();
        Expenses.updateSalariesVisibility();
    },
    
    // Afficher/masquer la section salaires selon le mode et le dÃ©partement
    updateSalariesVisibility: () => {
        const salariesSection = document.getElementById('expenses-salaries-section');
        if(salariesSection) {
            const show = Expenses.mode === 'advanced' && (Expenses.filterDept === 'salaires' || Expenses.filterDept === '');
            salariesSection.style.display = show ? 'block' : 'none';
        }
    },
    
    // VÃ©rifier les informations manquantes pour les contrats/salaires
    checkMissingInfo: () => {
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const missing = [];
        
        // VÃ©rifier les acteurs
        actors.forEach(actor => {
            if(!actor.name) return;
            const issues = [];
            
            if(!actor.email) issues.push('Email');
            if(!actor.address) issues.push('Adresse');
            if(!actor.dailyRate) issues.push('Tarif journalier');
            
            if(actor.professionalStatus === 'intermittent') {
                if(!actor.numSecu) issues.push('NÂ° SÃ©curitÃ© Sociale');
                if(!actor.numCongesSpectacles) issues.push('NÂ° CongÃ©s Spectacles');
            } else if(actor.professionalStatus === 'micro-entrepreneur') {
                if(!actor.siret) issues.push('NÂ° SIRET');
            } else if(!actor.professionalStatus) {
                issues.push('Statut professionnel');
            }
            
            if(issues.length > 0) {
                missing.push({ type: 'actor', person: actor, issues: issues });
            }
        });
        
        // VÃ©rifier les techniciens
        crew.forEach(member => {
            if(!member.name) return;
            const issues = [];
            
            if(!member.email) issues.push('Email');
            if(!member.address) issues.push('Adresse');
            if(!member.dailyRate) issues.push('Tarif journalier');
            
            if(member.professionalStatus === 'intermittent') {
                if(!member.numSecu) issues.push('NÂ° SÃ©curitÃ© Sociale');
                if(!member.numCongesSpectacles) issues.push('NÂ° CongÃ©s Spectacles');
            } else if(member.professionalStatus === 'micro-entrepreneur') {
                if(!member.siret) issues.push('NÂ° SIRET');
            } else if(!member.professionalStatus) {
                issues.push('Statut professionnel');
            }
            
            if(issues.length > 0) {
                missing.push({ type: 'crew', person: member, issues: issues });
            }
        });
        
        Expenses.showMissingInfoModal(missing);
    },
    
    // Afficher la modale des infos manquantes
    showMissingInfoModal: (missing) => {
        const modal = document.createElement('div');
        modal.id = 'missing-info-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        let content = '';
        
        if(missing.length === 0) {
            content = `
                <div style="text-align:center; padding:40px;">
                    <div style="font-size:4rem; margin-bottom:20px;">âœ…</div>
                    <h3 style="margin:0 0 10px; color:var(--success);">Tout est complet !</h3>
                    <p class="text-sec">Toutes les fiches ont les informations nÃ©cessaires.</p>
                </div>
            `;
        } else {
            content = `
                <div class="mb-20">
                    <div style="background:#FF9800; color:white; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <strong>âš ï¸ ${missing.length} fiche${missing.length > 1 ? 's' : ''} avec des informations manquantes</strong>
                    </div>
                    <div style="max-height:400px; overflow-y:auto;">
                        ${missing.map(m => `
                            <div style="background:var(--bg); border-radius:8px; padding:15px; margin-bottom:10px; border-left:4px solid #FF9800;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <strong>${m.type === 'actor' ? 'ðŸŽ­' : 'ðŸŽ¬'} ${Utils.escape(m.person.name)}</strong>
                                    ${m.person.email ? `<button onclick="app.Expenses.sendReminderEmail('${m.type}', '${m.person.id}')" style="padding:6px 12px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem;">ðŸ“§ Envoyer rappel</button>` : ''}
                                </div>
                                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                                    ${m.issues.map(issue => `<span style="background:var(--danger); color:white; padding:3px 8px; border-radius:4px; font-size:0.8rem;">âŒ ${issue}</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="flex-end">
                    <button onclick="app.Expenses.sendAllReminderEmails()" class="btn-primary">ðŸ“§ Envoyer rappel Ã  tous</button>
                </div>
            `;
        }
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:600px; max-width:90%; max-height:80vh; overflow:hidden;">
                <div class="section-header-20">
                    <h3 class="m-0">ðŸ” VÃ©rification des informations</h3>
                    <button onclick="document.getElementById('missing-info-modal').remove()" class="icon-btn">âœ•</button>
                </div>
                ${content}
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Envoyer un email de rappel
    sendReminderEmail: async (type, personId) => {
        const list = type === 'actor' ? state.data.actors : state.data.crew;
        const person = list?.find(p => p.id === personId);
        
        if(!person || !person.email) {
            Utils.toast('Aucun email disponible', 'error');
            return;
        }
        
        const issues = [];
        if(!person.address) issues.push('ton adresse');
        if(!person.dailyRate) issues.push('ton tarif journalier');
        if(!person.professionalStatus) issues.push('ton statut professionnel');
        if(person.professionalStatus === 'intermittent') {
            if(!person.numSecu) issues.push('ton numÃ©ro de SÃ©curitÃ© Sociale');
            if(!person.numCongesSpectacles) issues.push('ton numÃ©ro CongÃ©s Spectacles');
        }
        if(person.professionalStatus === 'micro-entrepreneur' && !person.siret) {
            issues.push('ton numÃ©ro SIRET');
        }
        
        const projectTitle = state.data.title || 'Sans titre';
        
        try {
            await emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, {
                to_email: person.email,
                to_name: person.name,
                from_name: state.currentUser?.displayName || state.currentUser?.email || 'L\'Ã©quipe',
                project_title: projectTitle,
                subject: `ðŸŽ¬ ${projectTitle} - Informations manquantes sur ton profil`,
                message: `Salut ${person.name} ! ðŸ‘‹\n\nLe projet "${projectTitle}" a besoin de quelques informations pour complÃ©ter ta fiche et prÃ©parer les contrats/salaires.\n\nIl manque : ${issues.join(', ')}\n\nPeux-tu mettre Ã  jour ton profil sur Moteur quand tu as 2 minutes ?\n\nMerci ! ðŸŽ¬`,
                reply_to: state.currentUser?.email || ''
            });
            
            Utils.toast(`ðŸ“§ Email envoyÃ© Ã  ${person.name}`, 'success');
        } catch(e) {
            console.error('Erreur envoi email:', e);
            Utils.toast('Erreur lors de l\'envoi', 'error');
        }
    },
    
    // Envoyer rappel Ã  tous
    sendAllReminderEmails: async () => {
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        let sent = 0;
        
        const check = async (person, type) => {
            if(!person.email) return;
            let hasMissing = !person.address || !person.dailyRate || !person.professionalStatus;
            if(person.professionalStatus === 'intermittent' && (!person.numSecu || !person.numCongesSpectacles)) hasMissing = true;
            if(person.professionalStatus === 'micro-entrepreneur' && !person.siret) hasMissing = true;
            
            if(hasMissing) {
                await Expenses.sendReminderEmail(type, person.id);
                sent++;
            }
        };
        
        for(const actor of actors) { await check(actor, 'actor'); }
        for(const member of crew) { await check(member, 'crew'); }
        
        Utils.toast(sent > 0 ? `ðŸ“§ ${sent} email${sent > 1 ? 's' : ''} envoyÃ©${sent > 1 ? 's' : ''}` : 'Aucun email Ã  envoyer', sent > 0 ? 'success' : 'info');
        document.getElementById('missing-info-modal')?.remove();
    },
    
    // Remplit le select "PayÃ© par" avec les membres du projet
    populatePaidBySelect: () => {
        const select = document.getElementById('expense-paid-by');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Production / Non remboursable --</option>';
        
        // Ajouter les comÃ©diens
        (state.data.actors || []).forEach(actor => {
            if(actor.name) {
                const opt = document.createElement('option');
                opt.value = 'actor_' + actor.id;
                opt.textContent = 'ðŸŽ­ ' + actor.name;
                select.appendChild(opt);
            }
        });
        
        // Ajouter les techniciens
        (state.data.crew || []).forEach(member => {
            if(member.name) {
                const opt = document.createElement('option');
                opt.value = 'crew_' + member.id;
                opt.textContent = 'ðŸŽ¬ ' + member.name;
                select.appendChild(opt);
            }
        });
    },
    
    // Affiche la liste des dÃ©penses
    renderExpensesList: () => {
        const container = document.getElementById('expenses-list');
        if(!container) return;
        
        let expenses = [...(state.data.expenses || [])];
        
        // Appliquer les filtres (supporte category OU department pour rÃ©trocompatibilitÃ©)
        if(Expenses.filterDept) {
            expenses = expenses.filter(e => e.category === Expenses.filterDept || e.department === Expenses.filterDept);
        }
        if(Expenses.filterStatus) {
            expenses = expenses.filter(e => e.status === Expenses.filterStatus);
        }
        if(Expenses.filterSearch) {
            expenses = expenses.filter(e => 
                e.title?.toLowerCase().includes(Expenses.filterSearch) ||
                e.description?.toLowerCase().includes(Expenses.filterSearch)
            );
        }
        
        // Trier par date (plus rÃ©cent en premier)
        expenses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        if(expenses.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’°</div>
                    <div class="empty-state-title">Aucune dÃ©pense</div>
                    <div class="empty-state-desc">Suivez le budget de votre production en enregistrant les dÃ©penses. Chaque dÃ©pense peut Ãªtre validÃ©e par un responsable.</div>
                    <button class="empty-state-btn" onclick="app.Expenses.openAddModal()">+ Ajouter une dÃ©pense</button>
                    <div class="empty-state-tips">ðŸ’¡ <strong>Astuce :</strong> DÃ©finissez le budget prÃ©visionnel par catÃ©gorie CNC dans la barre latÃ©rale.</div>
                </div>
            `;
            return;
        }
        
        const currency = state.data.budget?.currency || 'â‚¬';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const currentUserEmail = state.currentUser?.email;
        const isGlobalManager = state.data.budget?.manager === currentUserEmail || state.currentRole === 'owner';
        
        let html = '';
        expenses.forEach(exp => {
            const statusLabels = {
                pending: 'â³ En attente',
                approved: 'âœ… ValidÃ©',
                rejected: 'âŒ RefusÃ©',
                done: 'ðŸ’° PayÃ©',
                escalated: 'â¬†ï¸ RemontÃ©',
                returned: 'â†©ï¸ RenvoyÃ©'
            };
            
            // Obtenir le label de la catÃ©gorie CNC
            const cat = Expenses.getCategory(exp.category || exp.department);
            const catLabel = cat ? `${cat.icon} ${cat.code}. ${cat.name}` : (exp.category || exp.department || 'Non classÃ©');
            
            // Sous-catÃ©gorie si prÃ©sente
            let subcatLabel = '';
            if(exp.subcategory && cat) {
                const subcat = cat.subcats?.find(s => s.id === exp.subcategory);
                if(subcat) subcatLabel = subcat.name;
            }
            
            const date = exp.date ? new Date(exp.date).toLocaleDateString('fr-FR') : '';
            const isDeptManager = Expenses.isDeptManager(exp.category || exp.department);
            const isCreator = exp.createdBy === currentUserEmail;
            
            // Permissions
            const canValidateAsGlobal = isGlobalManager && (exp.status === 'pending' || exp.status === 'escalated');
            const canValidateAsDept = isDeptManager && exp.status === 'pending';
            const canValidate = canValidateAsGlobal || canValidateAsDept;
            const canEscalate = isDeptManager && exp.status === 'pending' && !isGlobalManager;
            const canReturn = (isDeptManager || isGlobalManager) && (exp.status === 'pending' || exp.status === 'escalated');
            const canEdit = isCreator || isGlobalManager;
            const canDelete = isCreator || isGlobalManager || isDeptManager;
            
            // Message de renvoi
            const returnedMsg = exp.status === 'returned' && exp.returnedReason ? 
                `<div style="background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; padding: 8px 12px; margin: 10px 0; font-size: 0.85rem;">
                    <strong>â†©ï¸ RenvoyÃ© par ${Utils.escape(exp.returnedByName || 'un responsable')}</strong><br>
                    ${Utils.escape(exp.returnedReason)}
                </div>` : '';
            
            // Montants HT/TTC
            const amountHT = exp.amountHT || exp.amount || 0;
            const amountTTC = exp.amountTTC || exp.amount || 0;
            const vatRate = exp.vatRate || 0;
            const displayAmount = vatMode === 'HT' ? amountHT : amountTTC;
            
            // Infos TVA
            const vatInfo = vatRate > 0 ? `<span style="font-size: 0.75rem; color: var(--text-sec); margin-left: 5px;">(${amountHT.toLocaleString()} HT + ${vatRate}% TVA)</span>` : '';
            
            // PiÃ¨ces jointes
            let attachmentsHtml = '';
            const attachments = exp.attachments || [];
            if(attachments.length > 0 || exp.photo) {
                const allAttachments = attachments.length > 0 ? attachments : (exp.photo ? [{ url: exp.photo, type: 'photo' }] : []);
                attachmentsHtml = `<div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">`;
                allAttachments.slice(0, 4).forEach(att => {
                    const src = att.data || att.url;
                    if(att.type === 'photo' || src?.startsWith('data:image')) {
                        attachmentsHtml += `<img src="${src}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); cursor: pointer;" onclick="window.open('${src}', '_blank')" onerror="this.style.display='none'">`;
                    } else {
                        attachmentsHtml += `<a href="${src}" target="_blank" style="width: 60px; height: 60px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; text-decoration: none;">ðŸ“„</a>`;
                    }
                });
                if(allAttachments.length > 4) {
                    attachmentsHtml += `<div style="width: 60px; height: 60px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; color: var(--text-sec);">+${allAttachments.length - 4}</div>`;
                }
                attachmentsHtml += `</div>`;
            }
            
            html += `
                <div class="expense-card ${exp.status === 'returned' ? 'returned' : ''} ${exp.salaryMissingRate ? 'missing-rate' : ''}">
                    <div class="expense-card-header">
                        <div>
                            <div class="expense-card-title">${Utils.escape(exp.title)}</div>
                            <div class="expense-card-meta">
                                <span class="expense-card-dept">${catLabel}</span>
                                ${subcatLabel ? `<span style="font-size: 0.7rem; color: var(--text-sec); margin-left: 5px;">â€º ${subcatLabel}</span>` : ''}
                                <span class="expense-card-status ${exp.status}">${statusLabels[exp.status] || exp.status}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="expense-card-amount">${parseFloat(displayAmount).toLocaleString()} ${currency} ${vatMode}</div>
                            ${vatRate > 0 ? `<div style="font-size: 0.7rem; color: var(--text-sec);">${amountHT.toLocaleString()} HT + TVA ${vatRate}%</div>` : ''}
                        </div>
                    </div>
                    ${exp.description ? `<div style="font-size: 0.9rem; color: var(--text-sec); margin-bottom: 10px;">${Utils.escape(exp.description)}</div>` : ''}
                    ${returnedMsg}
                    <div class="expense-card-meta">
                        ${date ? `ðŸ“… ${date} â€¢ ` : ''}ðŸ‘¤ ${Utils.escape(exp.createdByName || exp.createdBy || 'Inconnu')}
                        ${exp.paidByName ? ` â€¢ ðŸ’³ PayÃ© par ${Utils.escape(exp.paidByName)}` : ''}
                        ${exp.validatedBy ? ` â€¢ âœ“ ValidÃ© par ${Utils.escape(exp.validatedByName || exp.validatedBy)}` : ''}
                        ${exp.status === 'escalated' ? ` â€¢ â¬†ï¸ RemontÃ© au responsable global` : ''}
                        ${exp.salaryMissingRate ? ` â€¢ <span class="text-danger">âš ï¸ Tarif manquant</span>` : ''}
                    </div>
                    ${attachmentsHtml}
                    <div class="expense-card-actions">
                        ${canValidate ? `<button class="expense-btn-approve" onclick="app.Expenses.validateExpense('${exp.id}')">âœ… Valider</button>` : ''}
                        ${canEscalate ? `<button class="expense-btn-escalate" onclick="app.Expenses.escalateExpense('${exp.id}')">â¬†ï¸ Remonter</button>` : ''}
                        ${canReturn ? `<button class="expense-btn-return" onclick="app.Expenses.openReturnModal('${exp.id}')">â†©ï¸ Renvoyer</button>` : ''}
                        <button class="expense-btn-edit" onclick="app.Expenses.duplicateExpense('${exp.id}')" title="Dupliquer">ðŸ“‹</button>
                        ${canEdit ? `<button class="expense-btn-edit" onclick="app.Expenses.editExpense('${exp.id}')">âœï¸</button>` : ''}
                        ${canDelete ? `<button class="expense-btn-reject" onclick="app.Expenses.deleteExpense('${exp.id}')">ðŸ—‘ï¸</button>` : ''}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    // Calcule le total des salaires basÃ© sur les jours de tournage (shootingDays)
    calculateSalariesTotal: () => {
        let total = 0;
        const shootingDays = state.data.shootingDays || [];
        
        // Compter les jours par personne depuis les callSheets
        const daysByPerson = {};
        
        shootingDays.forEach(day => {
            if(!day.callSheet || day.callSheet.length === 0) return;
            
            day.callSheet.forEach(call => {
                const key = `${call.type}_${call.personId}`;
                if(!daysByPerson[key]) {
                    daysByPerson[key] = { type: call.type, personId: call.personId, days: 0 };
                }
                daysByPerson[key].days++;
            });
        });
        
        // Calculer les salaires
        Object.values(daysByPerson).forEach(info => {
            let person = null;
            
            if(info.type === 'actor') {
                person = state.data.actors?.find(a => a.id === info.personId || String(a.id) === String(info.personId));
            } else {
                person = state.data.crew?.find(c => c.id === info.personId || String(c.id) === String(info.personId));
            }
            
            if(person && person.dailyRate) {
                total += parseFloat(person.dailyRate) * info.days;
            }
        });
        
        return total;
    },
    
    // Rendu principal
    render: () => {
        Expenses.updateSummary();
        Expenses.updateDeptTotals();
        Expenses.populateDepartments();
        Expenses.renderExpensesList();
        Expenses.renderSalaries();
        Expenses.updateSalariesVisibility();
    },
    
    // Affiche les salaires calculÃ©s basÃ©s sur les jours de tournage
    renderSalaries: () => {
        const container = document.getElementById('expenses-salaries-list');
        const totalEl = document.getElementById('expenses-salaries-total');
        if(!container) return;
        
        const currency = state.data.budget?.currency || 'â‚¬';
        const shootingDays = state.data.shootingDays || [];
        
        // Compter les jours et heures par personne depuis les callSheets
        const daysByPerson = {};
        
        shootingDays.forEach(day => {
            if(!day.callSheet || day.callSheet.length === 0) return;
            
            day.callSheet.forEach(call => {
                const key = `${call.type}_${call.personId}`;
                if(!daysByPerson[key]) {
                    daysByPerson[key] = { type: call.type, personId: call.personId, days: 0, hours: 0 };
                }
                daysByPerson[key].days++;
                
                // Calculer les heures si horaires dÃ©finis
                if(call.callTime && day.estimatedWrap) {
                    const start = call.callTime.split(':').map(Number);
                    const end = day.estimatedWrap.split(':').map(Number);
                    const hours = (end[0] + end[1]/60) - (start[0] + start[1]/60);
                    if(hours > 0) daysByPerson[key].hours += hours;
                }
            });
        });
        
        let htmlWithRate = '';
        let htmlWithoutRate = '';
        let total = 0;
        
        // ComÃ©diens
        state.data.actors?.forEach(actor => {
            const key = `actor_${actor.id}`;
            const data = daysByPerson[key];
            if(!data || data.days === 0) return;
            
            const hasRate = actor.dailyRate && parseFloat(actor.dailyRate) > 0;
            const rateType = actor.rateType || 'Jour';
            
            if(hasRate) {
                let salary = 0;
                let detail = '';
                
                if(rateType === 'Heure' && data.hours > 0) {
                    salary = parseFloat(actor.dailyRate) * data.hours;
                    detail = `${data.hours.toFixed(1)}h Ã— ${actor.dailyRate} ${currency}/h`;
                } else {
                    salary = parseFloat(actor.dailyRate) * data.days;
                    detail = `${data.days} jour${data.days > 1 ? 's' : ''} Ã— ${actor.dailyRate} ${currency}`;
                }
                
                total += salary;
                htmlWithRate += `<div class="salary-item">
                    <div class="salary-info">
                        <span class="salary-name">ðŸŽ­ ${Utils.escape(actor.name)}</span>
                        <span class="salary-detail">${detail}</span>
                    </div>
                    <strong class="salary-amount">${salary.toLocaleString()} ${currency}</strong>
                </div>`;
            } else {
                htmlWithoutRate += `<div class="salary-item missing">
                    <div class="salary-info">
                        <span class="salary-name">ðŸŽ­ ${Utils.escape(actor.name)}</span>
                        <span class="salary-detail">${data.days} jour${data.days > 1 ? 's' : ''} - âš ï¸ Tarif non renseignÃ©</span>
                    </div>
                    <button onclick="app.UI.switchTab('actors')" class="salary-fix-btn">ComplÃ©ter</button>
                </div>`;
            }
        });
        
        // Techniciens
        state.data.crew?.forEach(member => {
            const key = `crew_${member.id}`;
            const data = daysByPerson[key];
            if(!data || data.days === 0) return;
            
            const hasRate = member.dailyRate && parseFloat(member.dailyRate) > 0;
            const rateType = member.rateType || 'Jour';
            
            if(hasRate) {
                let salary = 0;
                let detail = '';
                
                if(rateType === 'Heure' && data.hours > 0) {
                    salary = parseFloat(member.dailyRate) * data.hours;
                    detail = `${data.hours.toFixed(1)}h Ã— ${member.dailyRate} ${currency}/h`;
                } else {
                    salary = parseFloat(member.dailyRate) * data.days;
                    detail = `${data.days} jour${data.days > 1 ? 's' : ''} Ã— ${member.dailyRate} ${currency}`;
                }
                
                total += salary;
                htmlWithRate += `<div class="salary-item">
                    <div class="salary-info">
                        <span class="salary-name">ðŸŽ¬ ${Utils.escape(member.name)}</span>
                        <span class="salary-detail">${detail}</span>
                    </div>
                    <strong class="salary-amount">${salary.toLocaleString()} ${currency}</strong>
                </div>`;
            } else {
                htmlWithoutRate += `<div class="salary-item missing">
                    <div class="salary-info">
                        <span class="salary-name">ðŸŽ¬ ${Utils.escape(member.name)}</span>
                        <span class="salary-detail">${data.days} jour${data.days > 1 ? 's' : ''} - âš ï¸ Tarif non renseignÃ©</span>
                    </div>
                    <button onclick="app.UI.switchTab('crew')" class="salary-fix-btn">ComplÃ©ter</button>
                </div>`;
            }
        });
        
        let html = '';
        
        if(htmlWithRate) {
            html += htmlWithRate;
        }
        
        if(htmlWithoutRate) {
            html += `<div class="salary-section-warning">
                <div style="font-weight:600; margin-bottom:8px;">âš ï¸ Tarifs manquants</div>
                ${htmlWithoutRate}
            </div>`;
        }
        
        if(!html) {
            html = '<div style="color: var(--text-sec); text-align: center; padding: 10px;">Aucun salaire calculÃ©. Ajoutez des tarifs aux comÃ©diens/techniciens et planifiez des jours de tournage.</div>';
        }
        
        container.innerHTML = html;
        if(totalEl) totalEl.textContent = total.toLocaleString() + ' ' + currency;
    },
    
    // Supprime toutes les dÃ©penses salaires gÃ©nÃ©rÃ©es
    deleteSalaryExpenses: async () => {
        if(!Expenses.isBudgetManager()) {
            Utils.toast('Seul le responsable budget peut supprimer les dÃ©penses salaires', 'error');
            return;
        }
        
        const salaryExpenses = state.data.expenses?.filter(e => e.department === 'salaires' && (e.salaryPersonId || e.salaryPersonType)) || [];
        
        if(salaryExpenses.length === 0) {
            Utils.toast('Aucune dÃ©pense salaire Ã  supprimer', 'info');
            return;
        }
        
        if(!await ConfirmModal.confirmDelete(`${salaryExpenses.length} dÃ©pense(s) salaire gÃ©nÃ©rÃ©e(s) seront supprimÃ©es.`)) return;
        
        state.data.expenses = state.data.expenses.filter(e => !(e.department === 'salaires' && (e.salaryPersonId || e.salaryPersonType)));
        
        Store.save();
        Expenses.render();
        Utils.toast(`${salaryExpenses.length} dÃ©pense(s) salaire supprimÃ©e(s)`, 'success');
    },
    
    // GÃ©nÃ¨re les dÃ©penses salaires depuis le planning
    generateSalaryExpenses: () => {
        if(!Expenses.isBudgetManager()) {
            Utils.toast('Seul le responsable budget peut gÃ©nÃ©rer les dÃ©penses salaires', 'error');
            return;
        }
        
        const currency = state.data.budget?.currency || 'â‚¬';
        const shootingDays = state.data.shootingDays || [];
        
        // Compter les jours et heures par personne
        const daysByPerson = {};
        
        shootingDays.forEach(day => {
            if(!day.callSheet || day.callSheet.length === 0) return;
            
            day.callSheet.forEach(call => {
                const key = `${call.type}_${call.personId}`;
                if(!daysByPerson[key]) {
                    daysByPerson[key] = { type: call.type, personId: call.personId, days: 0, hours: 0 };
                }
                daysByPerson[key].days++;
                
                if(call.callTime && day.estimatedWrap) {
                    const start = call.callTime.split(':').map(Number);
                    const end = day.estimatedWrap.split(':').map(Number);
                    const hours = (end[0] + end[1]/60) - (start[0] + start[1]/60);
                    if(hours > 0) daysByPerson[key].hours += hours;
                }
            });
        });
        
        let generated = 0;
        let skipped = 0;
        let pending = 0;
        
        // Traiter les comÃ©diens
        state.data.actors?.forEach(actor => {
            const key = `actor_${actor.id}`;
            const data = daysByPerson[key];
            if(!data || data.days === 0) return;
            
            // VÃ©rifier si une dÃ©pense existe dÃ©jÃ  pour cette personne
            const existingExpense = state.data.expenses?.find(e => 
                e.salaryPersonId === actor.id && e.salaryPersonType === 'actor'
            );
            if(existingExpense) {
                skipped++;
                return;
            }
            
            const hasRate = actor.dailyRate && parseFloat(actor.dailyRate) > 0;
            const rateType = actor.rateType || 'Jour';
            
            let amount = 0;
            let description = '';
            
            if(hasRate) {
                if(rateType === 'Heure' && data.hours > 0) {
                    amount = parseFloat(actor.dailyRate) * data.hours;
                    description = `${data.hours.toFixed(1)}h Ã— ${actor.dailyRate} ${currency}/h`;
                } else {
                    amount = parseFloat(actor.dailyRate) * data.days;
                    description = `${data.days} jour(s) Ã— ${actor.dailyRate} ${currency}/jour`;
                }
            } else {
                description = `${data.days} jour(s) - Tarif Ã  dÃ©finir`;
                pending++;
            }
            
            const expense = {
                id: Utils.generateUniqueId(),
                title: `Salaire - ${actor.name}`,
                // Montants avec TVA (salaires gÃ©nÃ©ralement sans TVA)
                amountHT: amount,
                vatRate: 0,
                amountTTC: amount,
                amount: amount, // RÃ©trocompatibilitÃ©
                // CatÃ©gorie CNC : InterprÃ©tation pour les acteurs
                category: 'interpretation',
                subcategory: 'interpretation_principaux',
                department: 'interpretation', // RÃ©trocompatibilitÃ©
                description: description,
                status: 'pending',
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                createdBy: state.currentUser?.email,
                createdByName: state.userProfile?.displayName || state.currentUser?.email?.split('@')[0],
                salaryPersonId: actor.id,
                salaryPersonType: 'actor',
                salaryMissingRate: !hasRate
            };
            
            if(!state.data.expenses) state.data.expenses = [];
            state.data.expenses.push(expense);
            generated++;
        });
        
        // Traiter les techniciens
        state.data.crew?.forEach(member => {
            const key = `crew_${member.id}`;
            const data = daysByPerson[key];
            if(!data || data.days === 0) return;
            
            // VÃ©rifier si une dÃ©pense existe dÃ©jÃ 
            const existingExpense = state.data.expenses?.find(e => 
                e.salaryPersonId === member.id && e.salaryPersonType === 'crew'
            );
            if(existingExpense) {
                skipped++;
                return;
            }
            
            const hasRate = member.dailyRate && parseFloat(member.dailyRate) > 0;
            const rateType = member.rateType || 'Jour';
            
            let amount = 0;
            let description = '';
            
            if(hasRate) {
                if(rateType === 'Heure' && data.hours > 0) {
                    amount = parseFloat(member.dailyRate) * data.hours;
                    description = `${data.hours.toFixed(1)}h Ã— ${member.dailyRate} ${currency}/h`;
                } else {
                    amount = parseFloat(member.dailyRate) * data.days;
                    description = `${data.days} jour(s) Ã— ${member.dailyRate} ${currency}/jour`;
                }
            } else {
                description = `${data.days} jour(s) - Tarif Ã  dÃ©finir`;
                pending++;
            }
            
            const expense = {
                id: Utils.generateUniqueId(),
                title: `Salaire - ${member.name}`,
                // Montants avec TVA (salaires gÃ©nÃ©ralement sans TVA)
                amountHT: amount,
                vatRate: 0,
                amountTTC: amount,
                amount: amount, // RÃ©trocompatibilitÃ©
                // CatÃ©gorie CNC : Personnel pour les techniciens
                category: 'personnel',
                subcategory: 'personnel_technique',
                department: 'personnel', // RÃ©trocompatibilitÃ©
                description: description,
                status: 'pending',
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                createdBy: state.currentUser?.email,
                createdByName: state.userProfile?.displayName || state.currentUser?.email?.split('@')[0],
                salaryPersonId: member.id,
                salaryPersonType: 'crew',
                salaryMissingRate: !hasRate
            };
            
            if(!state.data.expenses) state.data.expenses = [];
            state.data.expenses.push(expense);
            generated++;
        });
        
        Store.save();
        Expenses.render();
        
        let message = `${generated} dÃ©pense(s) salaire gÃ©nÃ©rÃ©e(s)`;
        if(skipped > 0) message += `, ${skipped} dÃ©jÃ  existante(s)`;
        if(pending > 0) message += `. âš ï¸ ${pending} sans tarif (Ã  complÃ©ter)`;
        
        Utils.toast(message, generated > 0 ? 'success' : 'info');
    },
    
    // Stockage temporaire des piÃ¨ces jointes en cours d'Ã©dition
    tempAttachments: [],
    
    // Ouvre le modal d'ajout
    openAddModal: () => {
        document.getElementById('expense-modal-title').textContent = 'âž• Nouvelle DÃ©pense';
        document.getElementById('expense-edit-id').value = '';
        document.getElementById('expense-title').value = '';
        document.getElementById('expense-amount-ht').value = '';
        document.getElementById('expense-amount-ttc').value = '';
        document.getElementById('expense-vat-rate').value = state.data.budget?.defaultVatRate || 20;
        document.getElementById('expense-category').value = '';
        document.getElementById('expense-subcategory').innerHTML = '<option value="">-- Sous-catÃ©gorie --</option>';
        document.getElementById('expense-description').value = '';
        document.getElementById('expense-status').value = 'pending';
        document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('expense-attachment-url').value = '';
        Expenses.tempAttachments = [];
        Expenses.renderAttachmentsList();
        Expenses.populatePaidBySelect();
        Expenses.populateCategories();
        document.getElementById('expense-paid-by').value = '';
        document.getElementById('expense-modal').style.display = 'flex';
    },
    
    // Change de catÃ©gorie â†’ met Ã  jour les sous-catÃ©gories
    onCategoryChange: () => {
        const catId = document.getElementById('expense-category').value;
        const subcatSelect = document.getElementById('expense-subcategory');
        subcatSelect.innerHTML = '<option value="">-- Sous-catÃ©gorie --</option>';
        
        if(catId) {
            const cat = Expenses.getCategory(catId);
            if(cat && cat.subcats) {
                cat.subcats.forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = sub.id;
                    opt.textContent = sub.name;
                    subcatSelect.appendChild(opt);
                });
            }
        }
    },
    
    // Calcul TTC depuis HT
    calculateTTCFromHT: () => {
        const ht = parseFloat(document.getElementById('expense-amount-ht').value) || 0;
        const vatRate = parseFloat(document.getElementById('expense-vat-rate').value) || 0;
        const ttc = Expenses.calculateTTC(ht, vatRate);
        document.getElementById('expense-amount-ttc').value = ttc || '';
    },
    
    // Calcul HT depuis TTC
    calculateHTFromTTC: () => {
        const ttc = parseFloat(document.getElementById('expense-amount-ttc').value) || 0;
        const vatRate = parseFloat(document.getElementById('expense-vat-rate').value) || 0;
        const ht = Expenses.calculateHT(ttc, vatRate);
        document.getElementById('expense-amount-ht').value = ht || '';
    },
    
    // GÃ©rer l'upload de fichier
    handleFileUpload: (input) => {
        const file = input.files[0];
        if(!file) return;
        
        if(file.size > 5 * 1024 * 1024) {
            Utils.toast('Fichier trop volumineux (max 5 Mo)', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const attachment = {
                id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                name: file.name,
                data: e.target.result,
                type: file.type.startsWith('image/') ? 'photo' : 'document',
                size: file.size
            };
            Expenses.tempAttachments.push(attachment);
            Expenses.renderAttachmentsList();
            Utils.toast('Fichier ajoutÃ©', 'success');
        };
        reader.readAsDataURL(file);
        input.value = '';
    },
    
    // Ajouter une piÃ¨ce jointe par URL
    addAttachmentUrl: () => {
        const url = document.getElementById('expense-attachment-url').value.trim();
        if(!url) return;
        
        const attachment = {
            id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            name: url.split('/').pop() || 'document',
            url: url,
            type: url.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? 'photo' : 'document'
        };
        Expenses.tempAttachments.push(attachment);
        Expenses.renderAttachmentsList();
        document.getElementById('expense-attachment-url').value = '';
    },
    
    // Supprimer une piÃ¨ce jointe
    removeAttachment: (attId) => {
        Expenses.tempAttachments = Expenses.tempAttachments.filter(a => a.id !== attId);
        Expenses.renderAttachmentsList();
    },
    
    // Afficher la liste des piÃ¨ces jointes
    renderAttachmentsList: () => {
        const container = document.getElementById('expense-attachments-list');
        if(!container) return;
        
        if(Expenses.tempAttachments.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        let html = '';
        Expenses.tempAttachments.forEach(att => {
            const isImage = att.type === 'photo' || (att.data && att.data.startsWith('data:image'));
            const src = att.data || att.url;
            
            html += `<div style="position: relative; display: inline-block;">
                ${isImage ? `<img src="${src}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border);">` : 
                `<div style="width: 80px; height: 80px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; color: var(--text-sec); padding: 5px; text-align: center;">
                    ðŸ“„<br>${att.name.substring(0, 12)}${att.name.length > 12 ? '...' : ''}
                </div>`}
                <button onclick="app.Expenses.removeAttachment('${att.id}')" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); color: white; border: none; cursor: pointer; font-size: 0.7rem; line-height: 1;">âœ•</button>
            </div>`;
        });
        
        container.innerHTML = html;
    },
    
    // Ã‰dite une dÃ©pense
    editExpense: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        document.getElementById('expense-modal-title').textContent = 'âœï¸ Modifier la DÃ©pense';
        document.getElementById('expense-edit-id').value = id;
        document.getElementById('expense-title').value = expense.title || '';
        
        // Montants
        document.getElementById('expense-amount-ht').value = expense.amountHT || expense.amount || '';
        document.getElementById('expense-vat-rate').value = expense.vatRate || 0;
        document.getElementById('expense-amount-ttc').value = expense.amountTTC || expense.amount || '';
        
        // CatÃ©gorie
        Expenses.populateCategories();
        document.getElementById('expense-category').value = expense.category || expense.department || '';
        Expenses.onCategoryChange();
        if(expense.subcategory) {
            document.getElementById('expense-subcategory').value = expense.subcategory;
        }
        
        document.getElementById('expense-description').value = expense.description || '';
        document.getElementById('expense-status').value = expense.status || 'pending';
        document.getElementById('expense-date').value = expense.date || '';
        
        // PiÃ¨ces jointes
        Expenses.tempAttachments = expense.attachments ? [...expense.attachments] : [];
        if(expense.photo && Expenses.tempAttachments.length === 0) {
            Expenses.tempAttachments = [{
                id: 'att_migrated',
                name: 'justificatif.jpg',
                url: expense.photo,
                type: 'photo'
            }];
        }
        Expenses.renderAttachmentsList();
        
        Expenses.populatePaidBySelect();
        document.getElementById('expense-paid-by').value = expense.paidBy || '';
        
        document.getElementById('expense-modal').style.display = 'flex';
    },
    
    // Sauvegarde une dÃ©pense
    saveExpense: () => {
        const title = document.getElementById('expense-title').value.trim();
        const amountHT = parseFloat(document.getElementById('expense-amount-ht').value) || 0;
        const category = document.getElementById('expense-category').value;
        
        if(!title || !amountHT || !category) {
            Utils.toast('Veuillez remplir les champs obligatoires (Titre, Montant HT, CatÃ©gorie)', 'warning');
            return;
        }
        
        const editId = document.getElementById('expense-edit-id').value;
        
        if(!state.data.expenses) state.data.expenses = [];
        
        const paidByValue = document.getElementById('expense-paid-by').value;
        const paidBySelect = document.getElementById('expense-paid-by');
        const paidByName = paidByValue ? paidBySelect.options[paidBySelect.selectedIndex].text : '';
        
        const vatRate = parseFloat(document.getElementById('expense-vat-rate').value) || 0;
        const amountTTC = parseFloat(document.getElementById('expense-amount-ttc').value) || Expenses.calculateTTC(amountHT, vatRate);
        
        const expenseData = {
            title: title,
            // Nouveaux champs TVA
            amountHT: amountHT,
            vatRate: vatRate,
            amountTTC: amountTTC,
            // RÃ©trocompatibilitÃ©
            amount: amountHT,
            // CatÃ©gories CNC
            category: category,
            subcategory: document.getElementById('expense-subcategory').value || '',
            department: category, // Alias pour rÃ©trocompatibilitÃ©
            // Autres champs
            description: document.getElementById('expense-description').value.trim(),
            status: document.getElementById('expense-status').value,
            date: document.getElementById('expense-date').value,
            // PiÃ¨ces jointes
            attachments: [...Expenses.tempAttachments],
            photo: Expenses.tempAttachments.length > 0 ? (Expenses.tempAttachments[0].url || Expenses.tempAttachments[0].data || '') : '',
            paidBy: paidByValue,
            paidByName: paidByName,
            updatedAt: new Date().toISOString()
        };
        
        if(editId) {
            // Modification
            const idx = state.data.expenses.findIndex(e => e.id === editId);
            if(idx > -1) {
                state.data.expenses[idx] = { ...state.data.expenses[idx], ...expenseData };
            }
        } else {
            // CrÃ©ation
            expenseData.id = 'exp_' + Date.now();
            expenseData.createdAt = new Date().toISOString();
            expenseData.createdBy = state.currentUser?.email;
            expenseData.createdByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
            state.data.expenses.push(expenseData);
            
            // Notifier le responsable concernÃ©
            Expenses.notifyExpenseUpdate(expenseData, 'new');
        }
        
        Store.save();
        document.getElementById('expense-modal').style.display = 'none';
        Expenses.render();
        Notifications.updateBadge();
        
        // VÃ©rifier les alertes de dÃ©passement
        Expenses.checkBudgetAlerts(category);
    },
    
    // VÃ©rifier les alertes de dÃ©passement aprÃ¨s ajout/modif
    checkBudgetAlerts: (catId) => {
        const cat = Expenses.getCategory(catId);
        if(!cat) return;
        
        const budget = state.data.budget?.previsionnel?.[catId];
        if(!budget || !budget.budgetHT) return;
        
        const vatMode = state.data.budget?.vatMode || 'HT';
        const budgetAmount = vatMode === 'HT' ? budget.budgetHT : budget.budgetTTC;
        
        const expenses = state.data.expenses || [];
        const spent = expenses
            .filter(e => (e.category === catId || e.department === catId) && (e.status === 'approved' || e.status === 'done'))
            .reduce((sum, e) => sum + (vatMode === 'HT' ? (e.amountHT || e.amount || 0) : (e.amountTTC || e.amount || 0)), 0);
        
        const percent = Math.round((spent / budgetAmount) * 100);
        const thresholds = state.data.budget?.alertThresholds || { warning: 80, danger: 100 };
        
        if(percent >= thresholds.danger) {
            Utils.toast(`ðŸ”´ Attention ! Le budget "${cat.name}" est dÃ©passÃ© (${percent}%)`, 'error');
        } else if(percent >= thresholds.warning) {
            Utils.toast(`âš ï¸ Le budget "${cat.name}" atteint ${percent}%`, 'warning');
        }
    },
    
    // Supprime une dÃ©pense
    deleteExpense: async (id) => {
        if(!await ConfirmModal.confirmDelete("Cette dÃ©pense sera supprimÃ©e.")) return;
        
        state.data.expenses = state.data.expenses.filter(e => e.id !== id);
        Store.save();
        Expenses.render();
    },
    
    // Valide directement une dÃ©pense
    validateExpense: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        expense.status = 'approved';
        expense.validatedAt = new Date().toISOString();
        expense.validatedBy = state.currentUser?.email;
        expense.validatedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        
        Store.save();
        Expenses.render();
        Utils.toast('DÃ©pense validÃ©e !', 'success');
        
        // Notifier le crÃ©ateur
        Expenses.notifyExpenseUpdate(expense, 'approved');
    },
    
    // Remonte une dÃ©pense au responsable budget global
    escalateExpense: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        expense.status = 'escalated';
        expense.escalatedAt = new Date().toISOString();
        expense.escalatedBy = state.currentUser?.email;
        expense.escalatedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        
        Store.save();
        Expenses.render();
        Utils.toast('DÃ©pense remontÃ©e au responsable budget global', 'info');
        
        // Notifier le responsable budget global
        Expenses.notifyExpenseUpdate(expense, 'escalated');
    },
    
    // Ouvre le modal de renvoi
    openReturnModal: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        const currency = state.data.budget?.currency || 'â‚¬';
        
        const modal = document.createElement('div');
        modal.id = 'return-expense-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="modal-panel-450">
                <h3 style="margin:0 0 20px; color:var(--text-main);">â†©ï¸ Renvoyer la dÃ©pense</h3>
                
                <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">${Utils.escape(expense.title)}</div>
                    <div style="font-size: 1.2rem; color: var(--primary); font-weight: bold;">${parseFloat(expense.amount).toLocaleString()} ${currency}</div>
                    <div style="font-size: 0.85rem; color: var(--text-sec); margin-top: 5px;">Par : ${Utils.escape(expense.createdByName || expense.createdBy)}</div>
                </div>
                
                <label class="form-label-alt">Raison du renvoi *</label>
                <textarea id="return-reason" placeholder="Expliquez pourquoi cette dÃ©pense est renvoyÃ©e (trop chÃ¨re, mauvais choix, informations manquantes...)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); min-height:100px; resize:vertical; margin-bottom:20px;"></textarea>
                
                <div class="flex-end">
                    <button onclick="document.getElementById('return-expense-modal').remove()" class="btn-outline">Annuler</button>
                    <button onclick="app.Expenses.returnExpense('${id}')" style="padding:10px 20px; background:#f59e0b; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">â†©ï¸ Renvoyer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('return-reason').focus();
    },
    
    // Renvoie une dÃ©pense au crÃ©ateur
    returnExpense: (id) => {
        const reason = document.getElementById('return-reason').value.trim();
        if(!reason) {
            Utils.toast('Veuillez indiquer la raison du renvoi', 'warning');
            return;
        }
        
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        expense.status = 'returned';
        expense.returnedAt = new Date().toISOString();
        expense.returnedBy = state.currentUser?.email;
        expense.returnedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        expense.returnedReason = reason;
        
        Store.save();
        document.getElementById('return-expense-modal').remove();
        Expenses.render();
        Utils.toast('DÃ©pense renvoyÃ©e au demandeur', 'info');
        
        // Notifier le crÃ©ateur
        Expenses.notifyExpenseUpdate(expense, 'returned');
    },
    
    // Notifie les personnes concernÃ©es lors d'une mise Ã  jour de dÃ©pense
    notifyExpenseUpdate: async (expense, action) => {
        const projectName = state.data.title || 'Projet';
        const currency = state.data.budget?.currency || 'â‚¬';
        
        let recipientEmail = null;
        let recipientName = null;
        let subject = '';
        let content = '';
        
        if(action === 'approved') {
            // Notifier le crÃ©ateur que sa dÃ©pense est validÃ©e
            recipientEmail = expense.createdBy;
            recipientName = expense.createdByName;
            subject = `âœ… DÃ©pense validÃ©e - ${projectName}`;
            content = `Votre dÃ©pense "${expense.title}" de ${expense.amount} ${currency} a Ã©tÃ© validÃ©e par ${expense.validatedByName || 'le responsable budget'}.`;
        } else if(action === 'returned') {
            // Notifier le crÃ©ateur que sa dÃ©pense est renvoyÃ©e
            recipientEmail = expense.createdBy;
            recipientName = expense.createdByName;
            subject = `â†©ï¸ DÃ©pense renvoyÃ©e - ${projectName}`;
            content = `Votre dÃ©pense "${expense.title}" de ${expense.amount} ${currency} a Ã©tÃ© renvoyÃ©e par ${expense.returnedByName || 'le responsable'}.\n\nRaison : ${expense.returnedReason}`;
        } else if(action === 'escalated') {
            // Notifier le responsable budget global
            recipientEmail = state.data.budget?.manager;
            const managerPerson = Expenses.findPersonByEmail(recipientEmail);
            recipientName = managerPerson?.name;
            subject = `â¬†ï¸ DÃ©pense remontÃ©e - ${projectName}`;
            content = `Une dÃ©pense a Ã©tÃ© remontÃ©e pour validation :\n\n"${expense.title}" - ${expense.amount} ${currency}\nDemandÃ©e par : ${expense.createdByName}\nRemontÃ©e par : ${expense.escalatedByName}`;
        } else if(action === 'new') {
            // Notifier le responsable concernÃ© (dÃ©partement ou global)
            const deptManager = state.data.budget?.deptManagers?.[expense.department];
            if(deptManager && expense.department !== 'divers') {
                recipientEmail = deptManager.email;
                if(!deptManager.emailNotif) recipientEmail = null; // Pas de mail si dÃ©sactivÃ©
            } else {
                recipientEmail = state.data.budget?.manager;
                if(state.data.budget?.managerEmailNotif === false) recipientEmail = null;
            }
            const recipientPerson = Expenses.findPersonByEmail(recipientEmail);
            recipientName = recipientPerson?.name;
            subject = `ðŸ’° Nouvelle dÃ©pense Ã  valider - ${projectName}`;
            content = `Une nouvelle dÃ©pense attend votre validation :\n\n"${expense.title}" - ${expense.amount} ${currency}\nDemandÃ©e par : ${expense.createdByName}`;
        }
        
        // Envoyer la notification interne (messagerie du site)
        if(recipientEmail) {
            Expenses.sendInternalNotification(recipientEmail, subject, content, expense.id);
        }
        
        // Envoyer l'email si activÃ©
        // Note: L'envoi d'email dÃ©pend de la configuration Firebase
    },
    
    // Envoie une notification interne via le systÃ¨me de messagerie
    sendInternalNotification: (recipientEmail, subject, content, expenseId) => {
        // Utiliser le systÃ¨me de notifications existant ou crÃ©er un nouveau
        if(!state.data.notifications) state.data.notifications = [];
        
        state.data.notifications.push({
            id: 'notif_' + Date.now(),
            type: 'expense',
            recipientEmail: recipientEmail,
            subject: subject,
            content: content,
            expenseId: expenseId,
            read: false,
            createdAt: new Date().toISOString(),
            createdBy: state.currentUser?.email
        });
        
        Store.save();
    },
    
    // Ouvre le modal de validation
    openValidateModal: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        Expenses.currentExpenseId = id;
        const currency = state.data.budget?.currency || 'â‚¬';
        
        document.getElementById('expense-validate-content').innerHTML = `
            <div style="background: var(--bg); padding: 15px; border-radius: 8px;">
                <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 10px;">${Utils.escape(expense.title)}</div>
                <div style="font-size: 1.3rem; color: var(--primary); font-weight: bold;">${parseFloat(expense.amount).toLocaleString()} ${currency}</div>
                ${expense.description ? `<div style="margin-top: 10px; color: var(--text-sec);">${Utils.escape(expense.description)}</div>` : ''}
                <div style="margin-top: 10px; font-size: 0.85rem;">DemandÃ© par : ${Utils.escape(expense.createdByName || expense.createdBy)}</div>
            </div>
        `;
        document.getElementById('expense-validate-comment').value = '';
        document.getElementById('expense-validate-modal').style.display = 'flex';
    },
    
    // Approuve une dÃ©pense
    approveExpense: () => {
        const expense = state.data.expenses?.find(e => e.id === Expenses.currentExpenseId);
        if(!expense) return;
        
        expense.status = 'approved';
        expense.validatedAt = new Date().toISOString();
        expense.validatedBy = state.currentUser?.email;
        expense.validatedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        expense.validationComment = document.getElementById('expense-validate-comment').value.trim();
        
        Store.save();
        document.getElementById('expense-validate-modal').style.display = 'none';
        Expenses.render();
    },
    
    // Refuse une dÃ©pense
    rejectExpense: () => {
        const expense = state.data.expenses?.find(e => e.id === Expenses.currentExpenseId);
        if(!expense) return;
        
        expense.status = 'rejected';
        expense.validatedAt = new Date().toISOString();
        expense.validatedBy = state.currentUser?.email;
        expense.validatedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        expense.validationComment = document.getElementById('expense-validate-comment').value.trim();
        
        Store.save();
        document.getElementById('expense-validate-modal').style.display = 'none';
        Expenses.render();
    },
    
    // Export PDF du budget
    exportPDF: () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        const currency = state.data.budget?.currency || 'â‚¬';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const projectTitle = state.data.title || 'Projet sans titre';
        const previsionnel = state.data.budget?.previsionnel || {};
        
        // Calculer le budget total depuis le prÃ©visionnel
        let budgetTotal = 0;
        Object.values(previsionnel).forEach(p => {
            budgetTotal += vatMode === 'HT' ? (p.budgetHT || 0) : (p.budgetTTC || 0);
        });
        if(budgetTotal === 0) budgetTotal = state.data.budget?.total || 0;
        
        // Calcul des totaux par catÃ©gorie CNC
        let totalApproved = 0, totalPending = 0, totalRejected = 0;
        const catTotals = {};
        
        Expenses.CNC_CATEGORIES.forEach(cat => {
            const prev = previsionnel[cat.id] || {};
            catTotals[cat.id] = { 
                approved: 0, 
                pending: 0, 
                budget: vatMode === 'HT' ? (prev.budgetHT || 0) : (prev.budgetTTC || 0)
            };
        });
        
        (state.data.expenses || []).forEach(exp => {
            const catId = exp.category || exp.department;
            const amount = vatMode === 'HT' ? (parseFloat(exp.amountHT) || parseFloat(exp.amount) || 0) : (parseFloat(exp.amountTTC) || parseFloat(exp.amount) || 0);
            
            if(exp.status === 'approved' || exp.status === 'done') totalApproved += amount;
            else if(exp.status === 'pending' || exp.status === 'escalated') totalPending += amount;
            else if(exp.status === 'rejected') totalRejected += amount;
            
            const mappedCat = Expenses.MIGRATION_MAP[catId] || catId;
            if(!catTotals[mappedCat]) catTotals[mappedCat] = { approved: 0, pending: 0, budget: 0 };
            
            if(exp.status === 'approved' || exp.status === 'done') catTotals[mappedCat].approved += amount;
            else if(exp.status === 'pending') catTotals[mappedCat].pending += amount;
        });
        
        const salariesTotal = Expenses.calculateSalariesTotal();
        totalApproved += salariesTotal;
        
        // ===== HELPER : en-tÃªtes tableau dÃ©penses =====
        const drawExpenseHeaders = (yPos) => {
            doc.setFillColor(43, 110, 246);
            doc.rect(margin, yPos, pageWidth - margin * 2, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7.5);
            doc.setFont('helvetica', 'bold');
            doc.text('Date', margin + 2, yPos + 5);
            doc.text('Titre', margin + 22, yPos + 5);
            doc.text('CatÃ©gorie', margin + 75, yPos + 5);
            doc.text('HT', margin + 112, yPos + 5);
            doc.text('TVA', margin + 132, yPos + 5);
            doc.text('TTC', margin + 148, yPos + 5);
            doc.text('Statut', margin + 167, yPos + 5);
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            return yPos + 9;
        };
        
        let y = 0;
        
        // ===== HEADER BLEU =====
        doc.setFillColor(43, 110, 246);
        doc.rect(0, 0, pageWidth, 50, 'F');
        doc.setFillColor(30, 85, 210);
        doc.rect(0, 46, pageWidth, 4, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont('helvetica', 'bold');
        doc.text('BUDGET', pageWidth / 2, 22, { align: 'center' });
        
        doc.setFontSize(13);
        doc.setFont('helvetica', 'normal');
        doc.text(projectTitle, pageWidth / 2, 33, { align: 'center' });
        
        doc.setFontSize(9);
        doc.setTextColor(180, 210, 255);
        doc.text('Mode ' + vatMode + ' â€¢ ' + new Date().toLocaleDateString('fr-FR'), pageWidth / 2, 43, { align: 'center' });
        
        y = 60;
        
        // ===== RÃ‰SUMÃ‰ GLOBAL =====
        const reste = budgetTotal - totalApproved;
        const pct = budgetTotal > 0 ? Math.round(totalApproved / budgetTotal * 100) : 0;
        
        doc.setFillColor(245, 247, 250);
        doc.roundedRect(margin, y, pageWidth - margin * 2, 38, 3, 3, 'F');
        doc.setDrawColor(43, 110, 246);
        doc.setLineWidth(0.5);
        doc.roundedRect(margin, y, pageWidth - margin * 2, 38, 3, 3, 'S');
        doc.setLineWidth(0.2);
        
        // Titre rÃ©sumÃ©
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(43, 110, 246);
        doc.text('RÃ‰SUMÃ‰ GLOBAL', margin + 5, y + 8);
        
        // Barre de progression
        const barX = margin + 5;
        const barW = pageWidth - margin * 2 - 10;
        const barY = y + 12;
        doc.setFillColor(230, 230, 230);
        doc.roundedRect(barX, barY, barW, 4, 2, 2, 'F');
        if(pct > 0) {
            const clampedPct = Math.min(pct, 100);
            doc.setFillColor(pct > 100 ? 220 : 76, pct > 100 ? 53 : 175, pct > 100 ? 69 : 80);
            doc.roundedRect(barX, barY, barW * clampedPct / 100, 4, 2, 2, 'F');
        }
        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100);
        doc.text(pct + '% consommÃ©', barX + barW / 2, barY + 3, { align: 'center' });
        
        // Chiffres
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(80, 80, 80);
        doc.text('PrÃ©visionnel ' + vatMode, margin + 5, y + 25);
        doc.text('DÃ©pensÃ© (validÃ©)', margin + 65, y + 25);
        doc.text('En attente', margin + 120, y + 25);
        doc.text('Reste', margin + 158, y + 25);
        
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(50, 50, 50);
        doc.text(budgetTotal.toLocaleString() + ' ' + currency, margin + 5, y + 33);
        doc.setTextColor(76, 175, 80);
        doc.text(totalApproved.toLocaleString() + ' ' + currency, margin + 65, y + 33);
        doc.setTextColor(255, 152, 0);
        doc.text(totalPending.toLocaleString() + ' ' + currency, margin + 120, y + 33);
        doc.setTextColor(reste < 0 ? 220 : 43, reste < 0 ? 53 : 110, reste < 0 ? 69 : 246);
        doc.text(reste.toLocaleString() + ' ' + currency, margin + 158, y + 33);
        
        y += 48;
        
        // ===== TABLEAU CATÃ‰GORIES CNC =====
        doc.setFillColor(43, 110, 246);
        doc.roundedRect(margin, y, pageWidth - margin * 2, 9, 1.5, 1.5, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('RÃ‰PARTITION PAR CATÃ‰GORIE CNC', margin + 5, y + 6.5);
        y += 13;
        
        // En-tÃªtes
        doc.setFillColor(240, 242, 245);
        doc.rect(margin, y, pageWidth - margin * 2, 7, 'F');
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(7.5);
        doc.setFont('helvetica', 'bold');
        doc.text('CatÃ©gorie', margin + 3, y + 5);
        doc.text('PrÃ©visionnel', margin + 75, y + 5);
        doc.text('DÃ©pensÃ©', margin + 108, y + 5);
        doc.text('En attente', margin + 137, y + 5);
        doc.text('Ã‰cart', margin + 167, y + 5);
        y += 9;
        
        let rowIndex = 0;
        Expenses.CNC_CATEGORIES.forEach(cat => {
            const data = catTotals[cat.id];
            if(!data || (data.approved === 0 && data.pending === 0 && data.budget === 0)) return;
            
            if(y > pageHeight - 20) { doc.addPage(); y = margin; }
            
            if(rowIndex % 2 === 0) {
                doc.setFillColor(250, 250, 252);
                doc.rect(margin, y - 3.5, pageWidth - margin * 2, 7, 'F');
            }
            
            const ecart = data.budget - data.approved;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);
            doc.text((`${cat.code}. ${cat.name}`).substring(0, 38), margin + 3, y);
            doc.text(data.budget > 0 ? data.budget.toLocaleString() + ' ' + currency : '-', margin + 75, y);
            doc.text(data.approved.toLocaleString() + ' ' + currency, margin + 108, y);
            doc.text(data.pending > 0 ? data.pending.toLocaleString() + ' ' + currency : '-', margin + 137, y);
            if(data.budget > 0) {
                doc.setTextColor(ecart < 0 ? 220 : 76, ecart < 0 ? 53 : 175, ecart < 0 ? 69 : 80);
                doc.text(ecart.toLocaleString() + ' ' + currency, margin + 167, y);
                doc.setTextColor(50, 50, 50);
            } else {
                doc.text('-', margin + 167, y);
            }
            y += 7;
            rowIndex++;
        });
        
        // Ligne total catÃ©gories
        y += 2;
        doc.setFillColor(43, 110, 246);
        doc.rect(margin, y - 3.5, pageWidth - margin * 2, 8, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(8.5);
        doc.setFont('helvetica', 'bold');
        doc.text('TOTAL', margin + 3, y + 1);
        doc.text(budgetTotal.toLocaleString() + ' ' + currency, margin + 75, y + 1);
        doc.text(totalApproved.toLocaleString() + ' ' + currency, margin + 108, y + 1);
        doc.text(totalPending.toLocaleString() + ' ' + currency, margin + 137, y + 1);
        doc.setTextColor(50, 50, 50);
        y += 15;
        
        // ===== LISTE DES DÃ‰PENSES =====
        const statusColors = { pending: [255, 152, 0], approved: [76, 175, 80], rejected: [220, 53, 69], done: [43, 110, 246], escalated: [156, 39, 176], returned: [96, 125, 139] };
        const expenses = [...(state.data.expenses || [])].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        if(expenses.length > 0) {
            if(y > pageHeight - 50) { doc.addPage(); y = margin; }
            
            doc.setFillColor(96, 125, 139);
            doc.roundedRect(margin, y, pageWidth - margin * 2, 9, 1.5, 1.5, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('LISTE DES DÃ‰PENSES (' + expenses.length + ')', margin + 5, y + 6.5);
            y += 13;
            
            y = drawExpenseHeaders(y);
            
            expenses.forEach((exp, idx) => {
                if(y > pageHeight - 15) { 
                    doc.addPage(); 
                    y = margin;
                    y = drawExpenseHeaders(y);
                }
                
                if(idx % 2 === 0) {
                    doc.setFillColor(250, 250, 252);
                    doc.rect(margin, y - 3.5, pageWidth - margin * 2, 6.5, 'F');
                }
                
                const cat = Expenses.getCategory(exp.category || exp.department);
                const catLabel = cat ? `${cat.code}. ${cat.name}` : (exp.category || exp.department || '-');
                const amountHT = exp.amountHT || exp.amount || 0;
                const vatRate = exp.vatRate || 0;
                const amountTTC = exp.amountTTC || exp.amount || 0;
                
                doc.setFontSize(7.5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(50, 50, 50);
                doc.text(exp.date ? new Date(exp.date).toLocaleDateString('fr-FR') : '-', margin + 2, y);
                doc.text((exp.title || 'Sans titre').substring(0, 26), margin + 22, y);
                doc.text(catLabel.substring(0, 20), margin + 75, y);
                doc.text(parseFloat(amountHT).toLocaleString(), margin + 112, y);
                doc.text(vatRate > 0 ? vatRate + '%' : '-', margin + 132, y);
                doc.text(parseFloat(amountTTC).toLocaleString(), margin + 148, y);
                const sc = statusColors[exp.status] || [100, 100, 100];
                doc.setTextColor(sc[0], sc[1], sc[2]);
                doc.setFont('helvetica', 'bold');
                doc.text(EXPENSE_STATUS_LABELS[exp.status] || exp.status || '-', margin + 167, y);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(50, 50, 50);
                
                y += 6;
            });
            
            // Ligne total dÃ©penses
            y += 3;
            doc.setFillColor(96, 125, 139);
            doc.rect(margin, y - 3.5, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            let totalHT = 0, totalTTC = 0;
            expenses.filter(e => e.status === 'approved' || e.status === 'done').forEach(e => {
                totalHT += parseFloat(e.amountHT) || parseFloat(e.amount) || 0;
                totalTTC += parseFloat(e.amountTTC) || parseFloat(e.amount) || 0;
            });
            doc.text('TOTAL (validÃ©/payÃ©)', margin + 3, y + 1);
            doc.text(totalHT.toLocaleString() + ' ' + currency, margin + 112, y + 1);
            doc.text(totalTTC.toLocaleString() + ' ' + currency, margin + 148, y + 1);
        }
        
        // ===== FOOTER sur toutes les pages =====
        const totalPages = doc.internal.getNumberOfPages();
        for(let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, pageHeight - 12, pageWidth - margin, pageHeight - 12);
            doc.setFontSize(7.5);
            doc.setTextColor(150, 150, 150);
            doc.text(projectTitle + ' â€” Budget ' + vatMode, margin, pageHeight - 7);
            doc.text('GÃ©nÃ©rÃ© par Moteur â€” moteur.studio', pageWidth / 2, pageHeight - 7, { align: 'center' });
            doc.text('Page ' + i + '/' + totalPages, pageWidth - margin, pageHeight - 7, { align: 'right' });
        }
        
        // TÃ©lÃ©charger
        const filename = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'budget') + '_budget_CNC.pdf';
        doc.save(filename);
        Utils.toast('Budget PDF exportÃ© !', 'success');
        History.log('EXPORT', 'Budget PDF gÃ©nÃ©rÃ©');
    },
    
    // Export Excel du budget (format CNC avec TVA)
    exportExcel: () => {
        const currency = state.data.budget?.currency || 'â‚¬';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const projectTitle = state.data.title || 'Projet sans titre';
        const previsionnel = state.data.budget?.previsionnel || {};
        
        // Calculer le budget total
        let budgetTotal = 0;
        Object.values(previsionnel).forEach(p => {
            budgetTotal += vatMode === 'HT' ? (p.budgetHT || 0) : (p.budgetTTC || 0);
        });
        if(budgetTotal === 0) budgetTotal = state.data.budget?.total || 0;
        
        
        // Construire le CSV avec BOM UTF-8
        let csv = '\uFEFF';
        
        // En-tÃªte projet
        csv += `BUDGET - ${projectTitle}\n`;
        csv += `GÃ©nÃ©rÃ© le;${new Date().toLocaleDateString('fr-FR')}\n`;
        csv += `Mode;${vatMode}\n`;
        csv += `Budget total ${vatMode};${budgetTotal} ${currency}\n\n`;
        
        // RÃ©sumÃ© par catÃ©gorie CNC
        csv += 'RÃ‰PARTITION PAR CATÃ‰GORIE CNC\n';
        csv += 'Code;CatÃ©gorie;PrÃ©visionnel HT;PrÃ©visionnel TTC;DÃ©pensÃ© HT;DÃ©pensÃ© TTC;En attente;Ã‰cart\n';
        
        // Calculer les totaux par catÃ©gorie
        const catTotals = {};
        Expenses.CNC_CATEGORIES.forEach(cat => {
            const prev = previsionnel[cat.id] || {};
            catTotals[cat.id] = { 
                approvedHT: 0, 
                approvedTTC: 0,
                pendingHT: 0,
                budgetHT: prev.budgetHT || 0,
                budgetTTC: prev.budgetTTC || 0
            };
        });
        
        (state.data.expenses || []).forEach(exp => {
            const catId = exp.category || exp.department;
            const mappedCat = Expenses.MIGRATION_MAP[catId] || catId;
            
            if(!catTotals[mappedCat]) catTotals[mappedCat] = { approvedHT: 0, approvedTTC: 0, pendingHT: 0, budgetHT: 0, budgetTTC: 0 };
            
            const amountHT = parseFloat(exp.amountHT) || parseFloat(exp.amount) || 0;
            const amountTTC = parseFloat(exp.amountTTC) || parseFloat(exp.amount) || 0;
            
            if(exp.status === 'approved' || exp.status === 'done') {
                catTotals[mappedCat].approvedHT += amountHT;
                catTotals[mappedCat].approvedTTC += amountTTC;
            } else if(exp.status === 'pending' || exp.status === 'escalated') {
                catTotals[mappedCat].pendingHT += amountHT;
            }
        });
        
        // Ã‰crire les lignes par catÃ©gorie CNC
        let totalBudgetHT = 0, totalBudgetTTC = 0, totalApprovedHT = 0, totalApprovedTTC = 0, totalPending = 0;
        
        Expenses.CNC_CATEGORIES.forEach(cat => {
            const data = catTotals[cat.id];
            if(!data || (data.approvedHT === 0 && data.pendingHT === 0 && data.budgetHT === 0)) return;
            
            const ecart = data.budgetHT - data.approvedHT;
            csv += `${cat.code};${cat.name};${data.budgetHT};${data.budgetTTC};${data.approvedHT};${data.approvedTTC};${data.pendingHT};${ecart}\n`;
            
            totalBudgetHT += data.budgetHT;
            totalBudgetTTC += data.budgetTTC;
            totalApprovedHT += data.approvedHT;
            totalApprovedTTC += data.approvedTTC;
            totalPending += data.pendingHT;
        });
        
        // Ligne total
        csv += `;TOTAL;${totalBudgetHT};${totalBudgetTTC};${totalApprovedHT};${totalApprovedTTC};${totalPending};${totalBudgetHT - totalApprovedHT}\n`;
        
        csv += '\n';
        
        // Liste des dÃ©penses dÃ©taillÃ©e
        csv += 'LISTE DES DÃ‰PENSES\n';
        csv += 'Date;Titre;CatÃ©gorie CNC;Sous-catÃ©gorie;Montant HT;TVA %;Montant TTC;Statut;Description;CrÃ©Ã© par;ValidÃ© par;PayÃ© par\n';
        
        const expenses = [...(state.data.expenses || [])].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        expenses.forEach(exp => {
            const date = exp.date ? new Date(exp.date).toLocaleDateString('fr-FR') : '';
            const title = (exp.title || '').replace(/;/g, ',').replace(/\n/g, ' ');
            const desc = (exp.description || '').replace(/;/g, ',').replace(/\n/g, ' ');
            const createdBy = (exp.createdByName || exp.createdBy || '').replace(/;/g, ',');
            const validatedBy = (exp.validatedByName || '').replace(/;/g, ',');
            const paidBy = (exp.paidByName || '').replace(/;/g, ',');
            
            // CatÃ©gorie CNC
            const cat = Expenses.getCategory(exp.category || exp.department);
            const catLabel = cat ? `${cat.code}. ${cat.name}` : (exp.category || exp.department || '');
            
            // Sous-catÃ©gorie
            let subcatLabel = '';
            if(exp.subcategory && cat) {
                const subcat = cat.subcats?.find(s => s.id === exp.subcategory);
                if(subcat) subcatLabel = subcat.name;
            }
            
            // Montants
            const amountHT = exp.amountHT || exp.amount || 0;
            const vatRate = exp.vatRate || 0;
            const amountTTC = exp.amountTTC || exp.amount || 0;
            
            csv += `${date};${title};${catLabel};${subcatLabel};${amountHT};${vatRate};${amountTTC};${EXPENSE_STATUS_LABELS[exp.status] || exp.status};${desc};${createdBy};${validatedBy};${paidBy}\n`;
        });
        
        // TÃ©lÃ©charger
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'budget') + '_budget_CNC.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        Utils.toast('Export Excel (CSV) gÃ©nÃ©rÃ© !', 'success');
    },
    
    // Dupliquer une dÃ©pense
    duplicateExpense: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        const newExpense = {
            ...expense,
            id: 'exp_' + Date.now(),
            title: expense.title + ' (copie)',
            status: 'pending',
            date: new Date().toISOString().split('T')[0],
            createdAt: new Date().toISOString(),
            createdBy: state.currentUser?.email,
            createdByName: state.userProfile?.displayName || state.currentUser?.email?.split('@')[0],
            validatedAt: null,
            validatedBy: null,
            validatedByName: null,
            validationComment: null,
            returnedReason: null,
            returnedBy: null,
            returnedByName: null,
            escalatedAt: null,
            escalatedBy: null,
            escalatedByName: null
        };
        
        // Retirer les rÃ©fÃ©rences aux salaires si c'Ã©tait une dÃ©pense auto
        delete newExpense.salaryPersonId;
        delete newExpense.salaryPersonType;
        delete newExpense.salaryMissingRate;
        
        if(!state.data.expenses) state.data.expenses = [];
        state.data.expenses.push(newExpense);
        
        Store.save();
        Expenses.render();
        Utils.toast('DÃ©pense dupliquÃ©e !', 'success');
    }
};

// --- MODULE MATCHING ENGINE ---
const MatchingEngine = {
    // Poids des critÃ¨res (sur 100 points total)
    weights: {
        gender: 20,
        age: 15,
        location: 15,
        collabType: 12,
        availability: 12,
        corpulence: 6,
        height: 5,
        hairColor: 4,
        hairLength: 3,
        eyeColor: 3,
        ethnicity: 5,
        languages: 8,
        sports: 5,
        bonnet: 4,
        vehicle: 3
    },
    
    // Profil sÃ©lectionnÃ© pour le matching
    selectedProfile: null,
    matchedProjects: [],
    
    // Initialiser le sÃ©lecteur de profils
    initProfileSelector: () => {
        const select = document.getElementById('universe-my-profile');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- SÃ©lectionner mon profil --</option>';
        
        // RÃ©cupÃ©rer mes profils depuis Universe
        const myProfiles = Universe.myProfiles || [];
        
        if(myProfiles.length === 0) {
            select.innerHTML += '<option value="" disabled>Aucun profil crÃ©Ã©</option>';
            return;
        }
        
        myProfiles.forEach((profile, idx) => {
            const typeEmoji = profile.type === 'actor' ? 'ðŸŽ­' : (profile.type === 'crew' ? 'ðŸŽ¥' : 'ðŸ‘¤');
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = `${typeEmoji} ${profile.name || profile.actorName || 'Profil ' + (idx + 1)}`;
            select.appendChild(opt);
        });
    },
    
    // Trouver des projets pour mon profil
    findProjectsForMe: () => {
        const select = document.getElementById('universe-my-profile');
        if(!select || select.value === '') {
            Utils.toast('Veuillez sÃ©lectionner un profil', 'warning');
            return;
        }
        
        const profileIdx = parseInt(select.value);
        const profile = Universe.myProfiles[profileIdx];
        if(!profile) {
            Utils.toast('Profil introuvable', 'error');
            return;
        }
        
        MatchingEngine.selectedProfile = profile;
        
        // RÃ©cupÃ©rer tous les projets
        const projects = Universe.allProjects || [];
        if(projects.length === 0) {
            Utils.toast('Aucun projet disponible', 'info');
            return;
        }
        
        // Calculer le score pour chaque projet
        const scoredProjects = projects.map(project => {
            const score = MatchingEngine.calculateScore(profile, project);
            return { ...project, matchScore: score.total, matchDetails: score.details };
        });
        
        // Trier par score dÃ©croissant
        scoredProjects.sort((a, b) => b.matchScore - a.matchScore);
        
        // Filtrer les projets avec un score minimum de 10%
        MatchingEngine.matchedProjects = scoredProjects.filter(p => p.matchScore >= 10);
        
        // Afficher les rÃ©sultats
        MatchingEngine.displayResults();
        
        const countDiv = document.getElementById('matching-results-count');
        if(countDiv) {
            countDiv.style.display = 'block';
            countDiv.innerHTML = `<strong>${MatchingEngine.matchedProjects.length}</strong> projet(s) compatible(s)`;
        }
        
        Utils.toast(`${MatchingEngine.matchedProjects.length} projets trouvÃ©s !`, 'success');
    },
    
    // Calculer le score de compatibilitÃ©
    calculateScore: (profile, project) => {
        let totalScore = 0;
        let maxPossible = 0;
        const details = {};
        const profileType = profile.type; // 'actor' ou 'crew'
        
        // VÃ‰RIFICATION PRÃ‰ALABLE : Le projet recherche-t-il ce type de profil ?
        if(profileType === 'actor') {
            // VÃ©rifier si le projet recherche des comÃ©diens
            const hasActorNeeds = project.actorNeeds && project.actorNeeds.length > 0;
            if(!hasActorNeeds) {
                return { total: 0, details: { noMatch: { score: 0, label: 'Ne recherche pas de comÃ©diens' } }, maxPossible: 100, totalScore: 0 };
            }
            // Chercher le meilleur rÃ´le correspondant
            const bestRole = MatchingEngine.findBestActorRole(profile, project.actorNeeds);
            if(bestRole) {
                // RÃ´le correspondant trouvÃ©
                details.roleMatch = { score: 100, label: `RÃ´le : ${bestRole.roleName || 'Non spÃ©cifiÃ©'}` };
                totalScore += 25;
                maxPossible += 25;
            } else {
                // Pas de rÃ´le exact mais le projet cherche des comÃ©diens
                details.roleMatch = { score: 20, label: 'Recherche comÃ©diens (autre profil)' };
                totalScore += 5;
                maxPossible += 25;
            }
        } else if(profileType === 'crew') {
            // VÃ©rifier si le projet recherche des techniciens
            const hasCrewNeeds = (project.crewNeeds && Object.values(project.crewNeeds).some(n => n.needed)) || 
                                 (project.customCrewNeeds && project.customCrewNeeds.length > 0);
            if(!hasCrewNeeds) {
                return { total: 0, details: { noMatch: { score: 0, label: 'Ne recherche pas de techniciens' } }, maxPossible: 100, totalScore: 0 };
            }
            // VÃ©rifier si le mÃ©tier du profil correspond aux besoins
            const profileRole = (profile.role || profile.crewRole || '').toLowerCase();
            const profileDept = profile.department || profile.group_id || '';
            const matchingNeed = MatchingEngine.findMatchingCrewNeed(profileRole, profileDept, project);
            if(matchingNeed) {
                // Poste correspondant trouvÃ©
                details.roleMatch = { score: 100, label: `Poste : ${matchingNeed}` };
                totalScore += 25;
                maxPossible += 25;
            } else {
                // Pas de poste exact mais le projet cherche des techniciens
                details.roleMatch = { score: 20, label: 'Recherche techniciens (autre poste)' };
                totalScore += 5;
                maxPossible += 25;
            }
        }
        
        // 1. GENRE (pour comÃ©diens)
        if(profileType === 'actor' && (project.searchGender || project.castingGender || project.actorNeeds)) {
            maxPossible += MatchingEngine.weights.gender;
            const projectGender = (project.searchGender || project.castingGender || '').toLowerCase();
            const profileGender = (profile.gender || '').toLowerCase();
            if(projectGender && profileGender) {
                if(projectGender === profileGender || projectGender === 'tous' || projectGender === '') {
                    totalScore += MatchingEngine.weights.gender;
                    details.gender = { score: 100, label: 'Genre compatible' };
                } else {
                    details.gender = { score: 0, label: 'Genre diffÃ©rent' };
                }
            }
        }
        
        // 2. Ã‚GE
        if(project.searchAgeMin || project.searchAgeMax || project.castingAgeMin || project.castingAgeMax) {
            maxPossible += MatchingEngine.weights.age;
            const profileAge = parseInt(profile.age) || 0;
            const minAge = parseInt(project.searchAgeMin || project.castingAgeMin) || 0;
            const maxAge = parseInt(project.searchAgeMax || project.castingAgeMax) || 999;
            
            if(profileAge > 0) {
                if(profileAge >= minAge && profileAge <= maxAge) {
                    totalScore += MatchingEngine.weights.age;
                    details.age = { score: 100, label: 'Ã‚ge parfait' };
                } else {
                    // Score partiel si proche
                    const diff = profileAge < minAge ? minAge - profileAge : profileAge - maxAge;
                    if(diff <= 5) {
                        totalScore += MatchingEngine.weights.age * 0.5;
                        details.age = { score: 50, label: 'Ã‚ge proche (Â±5 ans)' };
                    } else if(diff <= 10) {
                        totalScore += MatchingEngine.weights.age * 0.25;
                        details.age = { score: 25, label: 'Ã‚ge Ã©loignÃ© (Â±10 ans)' };
                    } else {
                        details.age = { score: 0, label: 'Ã‚ge incompatible' };
                    }
                }
            }
        }
        
        // 3. LOCALISATION (distance)
        if(project.location || project.city) {
            maxPossible += MatchingEngine.weights.location;
            const projectCity = (project.location || project.city || '').toLowerCase();
            const profileCity = (profile.city || '').toLowerCase();
            
            if(projectCity && profileCity) {
                if(profileCity.includes(projectCity) || projectCity.includes(profileCity)) {
                    totalScore += MatchingEngine.weights.location;
                    details.location = { score: 100, label: 'MÃªme ville' };
                } else {
                    // Bonus partiel si mÃªme rÃ©gion/dÃ©partement
                    const profileDept = MatchingEngine.extractDepartment(profileCity);
                    const projectDept = MatchingEngine.extractDepartment(projectCity);
                    if(profileDept && projectDept && profileDept === projectDept) {
                        totalScore += MatchingEngine.weights.location * 0.7;
                        details.location = { score: 70, label: 'MÃªme rÃ©gion' };
                    } else {
                        totalScore += MatchingEngine.weights.location * 0.3;
                        details.location = { score: 30, label: 'Lieu diffÃ©rent' };
                    }
                }
            }
        }
        
        // 4. TYPE DE COLLABORATION (pro/bÃ©nÃ©vole)
        if(project.collabType || project.budget) {
            maxPossible += MatchingEngine.weights.collabType;
            const projectCollab = (project.collabType || '').toLowerCase();
            const profileCollab = (profile.collabType || '').toLowerCase();
            
            if(projectCollab && profileCollab) {
                if(projectCollab === profileCollab) {
                    totalScore += MatchingEngine.weights.collabType;
                    details.collabType = { score: 100, label: 'Type collab identique' };
                } else if(profileCollab === 'tous' || profileCollab.includes('flexible')) {
                    totalScore += MatchingEngine.weights.collabType * 0.8;
                    details.collabType = { score: 80, label: 'Flexible' };
                } else {
                    totalScore += MatchingEngine.weights.collabType * 0.3;
                    details.collabType = { score: 30, label: 'Type collab diffÃ©rent' };
                }
            }
        }
        
        // 5. DISPONIBILITÃ‰S
        if(project.shootingDates || project.startDate) {
            maxPossible += MatchingEngine.weights.availability;
            const profileDates = profile.availabilityDates || [];
            const projectStart = project.startDate || project.shootingDates;
            
            if(profileDates.length > 0 && projectStart) {
                // VÃ©rifier si au moins une date correspond
                const hasMatch = profileDates.some(d => {
                    const pDate = new Date(d);
                    const projDate = new Date(projectStart);
                    return Math.abs(pDate - projDate) < 30 * 24 * 60 * 60 * 1000; // 30 jours
                });
                if(hasMatch) {
                    totalScore += MatchingEngine.weights.availability;
                    details.availability = { score: 100, label: 'Disponible' };
                } else {
                    details.availability = { score: 0, label: 'Non disponible' };
                }
            } else {
                // Pas d'info = neutre
                totalScore += MatchingEngine.weights.availability * 0.5;
                details.availability = { score: 50, label: 'DisponibilitÃ© inconnue' };
            }
        }
        
        // 6. CORPULENCE
        if(project.searchCorpulence || project.castingCorpulence) {
            maxPossible += MatchingEngine.weights.corpulence;
            const projectCorp = (project.searchCorpulence || project.castingCorpulence || '').toLowerCase();
            const profileCorp = (profile.corpulence || '').toLowerCase();
            
            if(projectCorp && profileCorp && projectCorp === profileCorp) {
                totalScore += MatchingEngine.weights.corpulence;
                details.corpulence = { score: 100, label: 'Corpulence OK' };
            }
        }
        
        // 7. TAILLE
        if(project.searchHeightMin || project.searchHeightMax) {
            maxPossible += MatchingEngine.weights.height;
            const profileHeight = parseInt(profile.height) || 0;
            const minH = parseInt(project.searchHeightMin) || 0;
            const maxH = parseInt(project.searchHeightMax) || 999;
            
            if(profileHeight > 0 && profileHeight >= minH && profileHeight <= maxH) {
                totalScore += MatchingEngine.weights.height;
                details.height = { score: 100, label: 'Taille OK' };
            }
        }
        
        // 8. COULEUR CHEVEUX
        if(project.searchHairColor || project.castingHairColor) {
            maxPossible += MatchingEngine.weights.hairColor;
            const projectHair = (project.searchHairColor || project.castingHairColor || '').toLowerCase();
            const profileHair = (profile.hairColor || '').toLowerCase();
            
            if(projectHair && profileHair && projectHair === profileHair) {
                totalScore += MatchingEngine.weights.hairColor;
                details.hairColor = { score: 100, label: 'Cheveux OK' };
            }
        }
        
        // 9. LONGUEUR CHEVEUX
        if(project.searchHairLength) {
            maxPossible += MatchingEngine.weights.hairLength;
            const projectLen = (project.searchHairLength || '').toLowerCase();
            const profileLen = (profile.hairLength || '').toLowerCase();
            
            if(projectLen && profileLen && projectLen === profileLen) {
                totalScore += MatchingEngine.weights.hairLength;
                details.hairLength = { score: 100, label: 'Longueur cheveux OK' };
            }
        }
        
        // 10. COULEUR YEUX
        if(project.searchEyeColor || project.castingEyeColor) {
            maxPossible += MatchingEngine.weights.eyeColor;
            const projectEyes = (project.searchEyeColor || project.castingEyeColor || '').toLowerCase();
            const profileEyes = (profile.eyeColor || '').toLowerCase();
            
            if(projectEyes && profileEyes && projectEyes === profileEyes) {
                totalScore += MatchingEngine.weights.eyeColor;
                details.eyeColor = { score: 100, label: 'Yeux OK' };
            }
        }
        
        // 11. ETHNICITÃ‰
        if(project.searchEthnicity || project.castingEthnicity) {
            maxPossible += MatchingEngine.weights.ethnicity;
            const projectEth = (project.searchEthnicity || project.castingEthnicity || '').toLowerCase();
            const profileEth = (profile.ethnicity || '').toLowerCase();
            
            if(projectEth && profileEth && (projectEth === profileEth || projectEth === 'tous')) {
                totalScore += MatchingEngine.weights.ethnicity;
                details.ethnicity = { score: 100, label: 'EthnicitÃ© OK' };
            }
        }
        
        // 12. LANGUES
        if(project.searchLanguages || project.languages) {
            maxPossible += MatchingEngine.weights.languages;
            const projectLangs = (project.searchLanguages || project.languages || '').toLowerCase().split(/[,;]/);
            const profileLangs = (profile.languages || '').toLowerCase().split(/[,;]/);
            
            const commonLangs = projectLangs.filter(l => 
                profileLangs.some(pl => pl.trim().includes(l.trim()) || l.trim().includes(pl.trim()))
            );
            
            if(commonLangs.length > 0) {
                const ratio = commonLangs.length / projectLangs.length;
                totalScore += MatchingEngine.weights.languages * ratio;
                details.languages = { score: Math.round(ratio * 100), label: `${commonLangs.length} langue(s) commune(s)` };
            }
        }
        
        // 13. SPORTS / COMPÃ‰TENCES
        if(project.searchSports || project.skills) {
            maxPossible += MatchingEngine.weights.sports;
            const projectSports = (project.searchSports || project.skills || '').toLowerCase().split(/[,;]/);
            const profileSports = (profile.sports || '').toLowerCase().split(/[,;]/);
            
            const commonSports = projectSports.filter(s => 
                profileSports.some(ps => ps.trim().includes(s.trim()) || s.trim().includes(ps.trim()))
            );
            
            if(commonSports.length > 0) {
                const ratio = Math.min(1, commonSports.length / projectSports.length);
                totalScore += MatchingEngine.weights.sports * ratio;
                details.sports = { score: Math.round(ratio * 100), label: `${commonSports.length} compÃ©tence(s)` };
            }
        }
        
        // 14. BONNET (si applicable)
        if(project.searchBonnet && profile.gender?.toLowerCase() === 'femme') {
            maxPossible += MatchingEngine.weights.bonnet;
            const projectBonnet = (project.searchBonnet || '').toUpperCase();
            const profileBonnet = (profile.bonnet || '').toUpperCase();
            
            if(projectBonnet && profileBonnet) {
                const bonnetOrder = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
                const projIdx = bonnetOrder.indexOf(projectBonnet);
                const profIdx = bonnetOrder.indexOf(profileBonnet);
                
                if(projIdx === profIdx) {
                    totalScore += MatchingEngine.weights.bonnet;
                    details.bonnet = { score: 100, label: 'Bonnet exact' };
                } else if(Math.abs(projIdx - profIdx) === 1) {
                    totalScore += MatchingEngine.weights.bonnet * 0.7;
                    details.bonnet = { score: 70, label: 'Bonnet proche' };
                }
            }
        }
        
        // 15. VÃ‰HICULE
        if(project.needsVehicle || project.requiresVehicle) {
            maxPossible += MatchingEngine.weights.vehicle;
            if(profile.hasVehicle) {
                totalScore += MatchingEngine.weights.vehicle;
                details.vehicle = { score: 100, label: 'VÃ©hicule disponible' };
            } else {
                details.vehicle = { score: 0, label: 'Pas de vÃ©hicule' };
            }
        }
        
        // Calcul du pourcentage final
        const finalScore = maxPossible > 0 ? Math.round((totalScore / maxPossible) * 100) : 50;
        
        return {
            total: finalScore,
            details: details,
            maxPossible: maxPossible,
            totalScore: totalScore
        };
    },
    
    // Extraire le dÃ©partement d'une ville
    extractDepartment: (city) => {
        if(!city) return null;
        const match = city.match(/\b(\d{2})\b/);
        return match ? match[1] : null;
    },
    
    // Trouver le meilleur rÃ´le correspondant pour un comÃ©dien
    findBestActorRole: (profile, actorNeeds) => {
        if(!actorNeeds || actorNeeds.length === 0) return null;
        
        const profileGender = (profile.gender || '').toLowerCase();
        const profileAge = parseInt(profile.age) || 0;
        
        let bestMatch = null;
        let bestScore = -1;
        
        actorNeeds.forEach(need => {
            let score = 0;
            
            // Match genre
            const needGender = (need.gender || '').toLowerCase();
            if(!needGender || needGender === 'tous' || needGender === profileGender) {
                score += 50;
            } else {
                return; // Genre incompatible, passer au suivant
            }
            
            // Match Ã¢ge
            const minAge = parseInt(need.ageMin) || 0;
            const maxAge = parseInt(need.ageMax) || 999;
            if(profileAge >= minAge && profileAge <= maxAge) {
                score += 50;
            } else if(profileAge > 0) {
                const diff = profileAge < minAge ? minAge - profileAge : profileAge - maxAge;
                if(diff <= 10) score += 25;
            }
            
            if(score > bestScore) {
                bestScore = score;
                bestMatch = need;
            }
        });
        
        return bestMatch;
    },
    
    // Trouver si le mÃ©tier du technicien correspond aux besoins du projet
    findMatchingCrewNeed: (profileRole, profileDept, project) => {
        const profileRoleLower = profileRole.toLowerCase();
        
        // VÃ©rifier dans crewNeeds (postes standards)
        if(project.crewNeeds) {
            for(const [posId, need] of Object.entries(project.crewNeeds)) {
                if(need.needed) {
                    const pos = Presentation?.crewPositions?.find(p => p.id === posId);
                    if(pos) {
                        const posName = pos.name.toLowerCase();
                        if(posName.includes(profileRoleLower) || profileRoleLower.includes(posName.split(' ')[0])) {
                            return pos.name;
                        }
                    }
                }
            }
        }
        
        // VÃ©rifier dans customCrewNeeds (postes personnalisÃ©s)
        if(project.customCrewNeeds) {
            for(const custom of project.customCrewNeeds) {
                const customName = (custom.name || '').toLowerCase();
                if(customName.includes(profileRoleLower) || profileRoleLower.includes(customName.split(' ')[0])) {
                    return custom.name;
                }
            }
        }
        
        // VÃ©rifier par dÃ©partement si pas de match exact
        if(profileDept && project.crewNeeds) {
            const deptMapping = {
                'gc1': ['image', 'cadreur', 'chef op', 'directeur photo'],
                'gc3': ['rÃ©alisation', 'rÃ©alisateur', 'assistant rÃ©al'],
                'gc4': ['son', 'ingÃ©nieur son', 'perchman', 'mixeur'],
                'gc5': ['lumiÃ¨re', 'Ã©lectro', 'chef Ã©lectro', 'gaffer'],
                'gc6': ['dÃ©cor', 'chef dÃ©cor', 'accessoiriste'],
                'gc7': ['costume', 'costumier', 'habilleur'],
                'gc8': ['maquillage', 'maquilleur', 'coiffeur'],
                'gc9': ['production', 'directeur prod', 'rÃ©gisseur'],
                'gc10': ['post-prod', 'monteur', 'Ã©talonnage', 'vfx'],
                'gc11': ['scripte', 'script']
            };
            
            const deptKeywords = deptMapping[profileDept] || [];
            for(const [posId, need] of Object.entries(project.crewNeeds)) {
                if(need.needed) {
                    const pos = Presentation?.crewPositions?.find(p => p.id === posId);
                    if(pos && deptKeywords.some(kw => pos.name.toLowerCase().includes(kw))) {
                        return pos.name + ' (dÃ©partement)';
                    }
                }
            }
        }
        
        return null;
    },
    
    // Afficher les rÃ©sultats sur la carte
    displayResults: () => {
        if(!Universe.map) return;
        
        // Supprimer l'ancien layer de matching s'il existe
        if(MatchingEngine.matchingLayer) {
            Universe.map.removeLayer(MatchingEngine.matchingLayer);
        }
        
        // CrÃ©er un nouveau layer SANS clustering pour les rÃ©sultats de matching
        MatchingEngine.matchingLayer = L.layerGroup();
        
        // Compteur pour dÃ©caler les marqueurs Ã  la mÃªme position
        const positionOffsets = {};
        
        // Ajouter les projets matchÃ©s comme marqueurs
        MatchingEngine.matchedProjects.forEach(async (project, index) => {
            const city = project.location || project.city || '';
            if(!city) return;
            
            const coords = await Universe.geocodeCity(city);
            if(!coords) return;
            
            // DÃ©calage pour Ã©viter superposition
            const key = `${coords.lat.toFixed(3)},${coords.lng.toFixed(3)}`;
            if(!positionOffsets[key]) positionOffsets[key] = 0;
            const offset = positionOffsets[key] * 0.002;
            positionOffsets[key]++;
            
            const finalLat = coords.lat + offset;
            const finalLng = coords.lng + offset;
            
            // Couleur selon le score
            const scoreColor = project.matchScore >= 70 ? '#22c55e' : 
                              project.matchScore >= 40 ? '#f59e0b' : '#ef4444';
            
            // CrÃ©er le marqueur avec l'affiche du projet
            const hasImage = project.image && project.image.length > 5;
            const icon = L.divIcon({
                className: 'match-marker-card',
                html: `
                    <div style="position: relative; cursor: pointer;" onclick="app.MatchingEngine.openMatchedProject('${project.id}')">
                        <div style="width: 70px; height: 95px; border-radius: 6px; overflow: hidden; border: 3px solid ${scoreColor}; box-shadow: 0 4px 12px rgba(0,0,0,0.4); background: #1a1a2e;">
                            ${hasImage 
                                ? `<img src="${project.image}" class="img-cover">` 
                                : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">ðŸŽ¬</div>`
                            }
                        </div>
                        <div style="position: absolute; top: -8px; right: -8px; background: ${scoreColor}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${project.matchScore}%</div>
                    </div>
                `,
                iconSize: [70, 95],
                iconAnchor: [35, 95]
            });
            
            const marker = L.marker([finalLat, finalLng], { icon });
            MatchingEngine.matchingLayer.addLayer(marker);
        });
        
        Universe.map.addLayer(MatchingEngine.matchingLayer);
        
        // Ajuster la vue pour montrer tous les marqueurs
        if(MatchingEngine.matchedProjects.length > 0) {
            setTimeout(() => {
                try {
                    const bounds = MatchingEngine.matchingLayer.getBounds();
                    if(bounds && bounds.isValid()) {
                        Universe.map.fitBounds(bounds, { padding: [50, 50] });
                    }
                } catch(e) {
                    console.warn('Impossible d\'ajuster la vue:', e);
                }
            }, 500);
        }
    },
    
    // Layer pour les rÃ©sultats de matching (sans clustering)
    matchingLayer: null,
    
    // Ouvrir un projet matchÃ©
    openMatchedProject: (projectId) => {
        const project = MatchingEngine.matchedProjects.find(p => p.id === projectId);
        if(project) {
            Universe.openProjectModal(project);
        } else {
            Utils.toast('Projet introuvable', 'error');
        }
    }
};

// --- MODULE ADMIN ---
const Admin = {
    allUsers: [],
    allReports: [],
    
    isAdmin: () => {
        return state.currentUser && CONFIG.adminEmails.includes(state.currentUser.email.toLowerCase());
    },
    
    init: () => {
        // Afficher le bouton admin si l'utilisateur est admin
        const btn = document.getElementById('admin-btn');
        if(btn) {
            btn.style.display = Admin.isAdmin() ? 'inline-block' : 'none';
        }
    },
    
    show: async () => {
        if(!Admin.isAdmin()) {
            Utils.toast('AccÃ¨s non autorisÃ©', 'error');
            return;
        }
        
        // Admin est dans dashboard-view, donc on cache juste le hub
        document.getElementById('hub-content').style.display = 'none';
        document.getElementById('universe-view').style.display = 'none';
        document.getElementById('projects-view').style.display = 'none';
        document.getElementById('admin-view').style.display = 'flex';
        
        await Admin.loadStats();
        await Admin.loadReports();
    },
    
    close: () => {
        UI.hideAllViews();
        document.getElementById('dashboard-view').style.display = 'flex';
        // Scroller en haut de la page
        window.scrollTo(0, 0);
    },
    
    statsData: {
        profiles: [],
        projects: [],
        actors: [],
        connections: [],
        reports: [],
        // MÃ©tiers tech
        crew_gc1: [], crew_gc2: [], crew_gc3: [], crew_gc4: [], crew_gc5: [],
        crew_gc6: [], crew_gc7: [], crew_gc8: [], crew_gc9: [], crew_gc10: [],
        crew_gc11: [], crew_gc12: [], crew_gc13: [], crew_gc14: [], crew_gc15: [],
        crew_gc16: [], crew_gc17: [],
        // Associations
        asso_video: [], asso_comediens: [], asso_realisateurs: [], asso_techniciens: [],
        asso_scenaristes: [], asso_producteurs: [], asso_figurants: [], asso_court_metrage: [],
        asso_documentaire: [], asso_animation: [], asso_musique: [], asso_theatre: [],
        asso_formation: [], asso_autre: [],
        // Entreprises
        ent_production: [], ent_postprod: [], ent_montage: [], ent_vfx: [],
        ent_doublage: [], ent_son: [], ent_musique: [], ent_location: [],
        ent_vente: [], ent_studio: [], ent_casting: [], ent_distribution: [],
        ent_technique: [], ent_formation: [], ent_autre: []
    },
    
    activeStatCategory: null,
    
    loadStats: async () => {
        try {
            // Charger les profils
            const { data: profiles } = await supabase.from('user_profiles').select('*');
            Admin.statsData.profiles = profiles || [];
            
            // RÃ©initialiser les compteurs dÃ©taillÃ©s
            Object.keys(Admin.statsData).forEach(k => {
                if(k.startsWith('crew_') || k.startsWith('asso_') || k.startsWith('ent_')) {
                    Admin.statsData[k] = [];
                }
            });
            
            // Mapping des rÃ´les vers dÃ©partements
            const roleToDept = {
                'RÃ©alisateur-rice': 'gc3', '1er assistant rÃ©alisateur': 'gc3', '2Ã¨me assistant rÃ©alisateur': 'gc3', 'Scripte': 'gc3',
                'Directeur-rice de la photo': 'gc1', 'Cadreur-se': 'gc1', '1er assistant camÃ©ra': 'gc1', '2Ã¨me assistant camÃ©ra': 'gc1', 'Steadicamer': 'gc1', 'Chef opÃ©rateur drone': 'gc1',
                'Chef Ã©lectro': 'gc2', 'Electricien-ne': 'gc2', 'Chef machino': 'gc2', 'Machiniste': 'gc2',
                'Chef opÃ©rateur son': 'gc4', 'Perchiste': 'gc4', 'IngÃ©nieur du son': 'gc4',
                'Chef dÃ©corateur': 'gc5', 'Ensemblier': 'gc5', 'Accessoiriste': 'gc5', 'RÃ©gisseur plateau': 'gc5',
                'Chef costumier': 'gc6', 'Costumier-Ã¨re': 'gc6', 'Habilleur-se': 'gc6',
                'Chef maquilleur': 'gc7', 'Maquilleur-se': 'gc7', 'Coiffeur-se': 'gc7',
                'Script/ContinuitÃ©': 'gc8',
                'RÃ©gisseur gÃ©nÃ©ral': 'gc9', 'RÃ©gisseur adjoint': 'gc9',
                'Directeur de production': 'gc10', 'Directeur de post-production': 'gc10', 'Producteur-rice': 'gc10',
                'Chef cuisinier': 'gc11', 'Intendant': 'gc11',
                'Chauffeur': 'gc12', 'RÃ©gisseur transport': 'gc12',
                'Monteur-se': 'gc13', 'Etalonneur-se': 'gc13', 'Infographiste': 'gc13',
                'ScÃ©nariste': 'gc14', 'Dialoguiste': 'gc14',
                'Compositeur-rice': 'gc15', 'Musicien-ne': 'gc15',
                'Cascadeur-se': 'gc16', 'Coordinateur cascades': 'gc16'
            };
            
            // Compter les types de profils
            let actorCount = 0;
            profiles?.forEach(p => {
                const profileType = p.profile_type;
                const data = p.data || {};
                const created = p.created_at || p.updated_at || new Date().toISOString();
                
                if(profileType === 'actor') actorCount++;
                if(profileType === 'crew') {
                    let dept = data.department;
                    if(!dept && data.role) {
                        dept = roleToDept[data.role] || 'gc17';
                    }
                    if(dept) {
                        const key = 'crew_' + dept;
                        if(Admin.statsData[key] !== undefined) {
                            Admin.statsData[key].push(created);
                        }
                    }
                }
                if(profileType === 'association' && data.assoType) {
                    if(Admin.statsData[data.assoType] !== undefined) {
                        Admin.statsData[data.assoType].push(created);
                    }
                }
                if(profileType === 'enterprise' && data.entType) {
                    if(Admin.statsData[data.entType] !== undefined) {
                        Admin.statsData[data.entType].push(created);
                    }
                }
            });
            Admin.statsData.actors = new Array(actorCount);
            
            // Charger les projets avec dates
            const { data: projects } = await supabase.from('projects').select('created_at');
            Admin.statsData.projects = projects?.map(p => p.created_at) || [];
            
            // Charger les connexions
            const { data: connections } = await supabase.from('user_logins').select('logged_at');
            Admin.statsData.connections = connections?.map(c => c.logged_at) || [];
            
            // Charger les signalements
            const { data: reports } = await supabase.from('reports').select('created_at');
            Admin.statsData.reports = reports?.map(r => r.created_at) || [];
            
            // Mettre Ã  jour les totaux
            document.getElementById('stat-profiles-total').textContent = Admin.statsData.profiles.length;
            document.getElementById('stat-projects-total').textContent = Admin.statsData.projects.length;
            document.getElementById('stat-actors-total').textContent = Admin.statsData.actors.length;
            document.getElementById('stat-connections-total').textContent = Admin.statsData.connections.length;
            document.getElementById('stat-reports-total').textContent = Admin.statsData.reports.length;
            
            // Config
            const { data: authCount } = await supabase.rpc('get_auth_users_count');
            document.getElementById('config-current-users').textContent = authCount || 0;
            document.getElementById('config-max-users').value = CONFIG.preAlpha.maxUsers || 150;
            document.getElementById('config-current-limit').textContent = CONFIG.preAlpha.maxUsers || 150;
            
            // Dessiner le graphique
            Admin.updateStatsChart();
            
        } catch(e) {
            console.error('Erreur chargement stats:', e);
        }
    },
    
    toggleStatCategory: (category) => {
        const container = document.getElementById('stats-detail-toggles');
        const btn = document.getElementById('stat-cat-' + category);
        
        // Toggle le bouton actif
        document.querySelectorAll('.stat-cat-btn').forEach(b => {
            b.style.background = 'var(--bg)';
            b.style.color = 'var(--text-main)';
        });
        
        if(Admin.activeStatCategory === category) {
            Admin.activeStatCategory = null;
            container.innerHTML = '';
            return;
        }
        
        Admin.activeStatCategory = category;
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        
        // GÃ©nÃ©rer les toggles pour cette catÃ©gorie
        let items = [];
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#14b8a6', '#a855f7', '#eab308', '#22c55e', '#0ea5e9', '#d946ef', '#64748b', '#fb7185'];
        
        if(category === 'crew') {
            items = CONFIG.crewGroups.map((g, i) => ({
                id: 'crew_' + g.id,
                name: g.name,
                color: colors[i % colors.length],
                count: Admin.statsData['crew_' + g.id]?.length || 0
            }));
        } else if(category === 'asso') {
            items = CONFIG.associationTypes.map((t, i) => ({
                id: t.id,
                name: t.name,
                color: colors[i % colors.length],
                count: Admin.statsData[t.id]?.length || 0
            }));
        } else if(category === 'ent') {
            items = CONFIG.enterpriseTypes.map((t, i) => ({
                id: t.id,
                name: t.name,
                color: colors[i % colors.length],
                count: Admin.statsData[t.id]?.length || 0
            }));
        }
        
        container.innerHTML = items.map(item => `
            <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px 8px; background: var(--bg); border-radius: 4px; font-size: 0.75rem;">
                <input type="checkbox" data-stat="${item.id}" onchange="app.Admin.updateStatsChart()" style="accent-color: ${item.color}; width: 12px; height: 12px;">
                <span style="color: ${item.color};">${item.name}</span>
                <strong style="color: ${item.color};">${item.count}</strong>
            </label>
        `).join('');
    },
    updateStatsChart: () => {
        const canvas = document.getElementById('admin-stats-chart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        const days = parseInt(document.getElementById('stats-period').value) || 30;
        const now = new Date();
        
        // GÃ©nÃ©rer les labels (dates)
        const labels = [];
        for (let i = days - 1; i >= 0; i--) {
            const d = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
            labels.push(d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }));
        }
        
        // Fonction pour compter les Ã©lÃ©ments cumulÃ©s par jour
        const getCumulativeData = (dates) => {
            const counts = [];
            for (let i = days - 1; i >= 0; i--) {
                const dayEnd = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                dayEnd.setHours(23, 59, 59, 999);
                const count = (dates || []).filter(d => new Date(d) <= dayEnd).length;
                counts.push(count);
            }
            return counts;
        };
        
        // Fonction pour compter par jour (non cumulÃ© - pour connexions)
        const getDailyData = (dates) => {
            const counts = [];
            for (let i = days - 1; i >= 0; i--) {
                const dayStart = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(dayStart);
                dayEnd.setHours(23, 59, 59, 999);
                const count = (dates || []).filter(d => {
                    const date = new Date(d);
                    return date >= dayStart && date <= dayEnd;
                }).length;
                counts.push(count);
            }
            return counts;
        };
        
        // Collecter les datasets actifs
        const datasets = [];
        const baseColors = {
            profiles: '#3b82f6',
            projects: '#10b981',
            actors: '#8b5cf6',
            connections: '#06b6d4',
            reports: '#ef4444'
        };
        
        const detailColors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#14b8a6', '#a855f7', '#eab308', '#22c55e', '#0ea5e9', '#d946ef', '#64748b', '#fb7185'];
        
        // Stats principales
        document.querySelectorAll('#stats-toggles input[type="checkbox"]').forEach(cb => {
            if (cb.checked) {
                const stat = cb.dataset.stat;
                if (Admin.statsData[stat]) {
                    const data = stat === 'connections' 
                        ? getDailyData(Admin.statsData[stat])
                        : getCumulativeData(Admin.statsData[stat]);
                    datasets.push({ name: stat, data, color: baseColors[stat] || '#888' });
                }
            }
        });
        
        // Stats dÃ©taillÃ©es (mÃ©tiers, asso, entreprises)
        let colorIndex = 0;
        document.querySelectorAll('#stats-detail-toggles input[type="checkbox"]').forEach(cb => {
            if (cb.checked) {
                const stat = cb.dataset.stat;
                if (Admin.statsData[stat]) {
                    const data = getCumulativeData(Admin.statsData[stat]);
                    const color = detailColors[colorIndex % detailColors.length];
                    datasets.push({ name: stat, data, color });
                    colorIndex++;
                }
            }
        });
        
        // Dessiner le graphique
        Admin.drawLineChart(ctx, canvas, labels, datasets);
    },
    
    drawLineChart: (ctx, canvas, labels, datasets) => {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * 2;
        canvas.height = rect.height * 2;
        ctx.scale(2, 2);
        
        const width = rect.width;
        const height = rect.height;
        const padding = { top: 20, right: 20, bottom: 40, left: 50 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;
        
        ctx.clearRect(0, 0, width, height);
        
        let maxVal = 1;
        datasets.forEach(ds => {
            const dsMax = Math.max(...ds.data);
            if (dsMax > maxVal) maxVal = dsMax;
        });
        maxVal = Math.ceil(maxVal * 1.1);
        
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-sec').trim() || '#666';
        
        // Grille
        ctx.strokeStyle = 'rgba(128,128,128,0.2)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
            const y = padding.top + (chartHeight / 5) * i;
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.stroke();
            
            ctx.fillStyle = textColor;
            ctx.font = '10px Arial';
            ctx.textAlign = 'right';
            ctx.fillText(Math.round(maxVal - (maxVal / 5) * i), padding.left - 8, y + 3);
        }
        
        // Labels X
        ctx.textAlign = 'center';
        const step = Math.ceil(labels.length / 10);
        labels.forEach((label, i) => {
            if (i % step === 0 || i === labels.length - 1) {
                const x = padding.left + (i / (labels.length - 1)) * chartWidth;
                ctx.fillStyle = textColor;
                ctx.font = '9px Arial';
                ctx.fillText(label, x, height - 10);
            }
        });
        
        // Lignes
        datasets.forEach(ds => {
            ctx.strokeStyle = ds.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            ds.data.forEach((val, i) => {
                const x = padding.left + (i / (ds.data.length - 1)) * chartWidth;
                const y = padding.top + chartHeight - (val / maxVal) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            ctx.fillStyle = ds.color;
            ds.data.forEach((val, i) => {
                const x = padding.left + (i / (ds.data.length - 1)) * chartWidth;
                const y = padding.top + chartHeight - (val / maxVal) * chartHeight;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        });
    },
    
    loadReports: async () => {
        const container = document.getElementById('admin-reports-list');
        container.innerHTML = '<div style="text-align: center; color: var(--text-sec); padding: 20px;">Chargement...</div>';
        
        try {
            const { data: reports, error } = await supabase
                .from('reports')
                .select('*')
                .order('created_at', { ascending: false });
            
            if(error) throw error;
            
            Admin.allReports = reports || [];
            
            if(!reports || reports.length === 0) {
                container.innerHTML = '<div class="empty-state">âœ… Aucun signalement</div>';
                return;
            }
            
            const reasonLabels = {
                'fake': 'ðŸ‘¤ Faux profil',
                'inappropriate': 'ðŸš« InappropriÃ©',
                'spam': 'ðŸ“§ Spam',
                'harassment': 'âš ï¸ HarcÃ¨lement',
                'scam': 'ðŸ’° Arnaque',
                'other': 'â“ Autre'
            };
            
            const statusLabels = {
                'pending': { label: 'â³ En attente', color: '#f59e0b' },
                'reviewed': { label: 'ðŸ‘ï¸ ExaminÃ©', color: '#3b82f6' },
                'resolved': { label: 'âœ… RÃ©solu', color: '#10b981' },
                'dismissed': { label: 'âŒ RejetÃ©', color: '#6b7280' }
            };
            
            container.innerHTML = reports.map(r => `
                <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                    <div class="flex-1">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: ${statusLabels[r.status]?.color || '#6b7280'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem;">${statusLabels[r.status]?.label || r.status}</span>
                            <span class="fw-bold">${reasonLabels[r.reason] || r.reason}</span>
                            <span class="text-sec-sm2">â€¢ ${r.reported_type}</span>
                        </div>
                        <div style="margin-bottom: 5px;"><strong>SignalÃ© :</strong> ${Utils.escape(r.reported_name || 'Inconnu')} ${r.reported_email ? `(${r.reported_email})` : ''}</div>
                        <div style="margin-bottom: 5px; color: var(--text-sec); font-size: 0.85rem;"><strong>Par :</strong> ${r.reporter_email}</div>
                        ${r.details ? `<div style="margin-top: 8px; padding: 10px; background: var(--panel-bg); border-radius: 6px; font-size: 0.9rem;">${Utils.escape(r.details)}</div>` : ''}
                        <div style="margin-top: 8px; color: var(--text-sec); font-size: 0.8rem;">ðŸ“… ${new Date(r.created_at).toLocaleDateString('fr-FR')} Ã  ${new Date(r.created_at).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                    <div class="flex-col-gap5">
                        ${r.status === 'pending' ? `
                            <button onclick="app.Admin.updateReportStatus('${r.id}', 'resolved')" style="padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">âœ… RÃ©solu</button>
                            <button onclick="app.Admin.updateReportStatus('${r.id}', 'dismissed')" style="padding: 6px 12px; background: var(--border); color: var(--text-main); border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">âŒ Rejeter</button>
                        ` : ''}
                        <button onclick="app.Admin.deleteReport('${r.id}')" style="padding: 6px 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ðŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
            
        } catch(e) {
            console.error('Erreur chargement signalements:', e);
            container.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 40px;">Erreur de chargement</div>';
        }
    },
    
    updateReportStatus: async (reportId, status) => {
        try {
            const { error } = await supabase
                .from('reports')
                .update({ 
                    status: status, 
                    reviewed_at: new Date().toISOString(),
                    reviewed_by: state.currentUser.email
                })
                .eq('id', reportId);
            
            if(error) throw error;
            
            Utils.toast('Statut mis Ã  jour', 'success');
            await Admin.loadReports();
            await Admin.loadStats();
        } catch(e) {
            console.error('Erreur mise Ã  jour:', e);
            Utils.toast('Erreur', 'error');
        }
    },
    
    deleteReport: async (reportId) => {
        if(!await ConfirmModal.show({ title: 'Supprimer ?', message: 'Supprimer dÃ©finitivement ce signalement ?', icon: 'ðŸ—‘ï¸', confirmText: 'Supprimer' })) return;
        
        try {
            const { error } = await supabase.from('reports').delete().eq('id', reportId);
            if(error) throw error;
            
            Utils.toast('Signalement supprimÃ©', 'success');
            await Admin.loadReports();
            await Admin.loadStats();
        } catch(e) {
            console.error('Erreur suppression:', e);
            Utils.toast('Erreur', 'error');
        }
    },
    
    loadUsers: async () => {
        const container = document.getElementById('admin-users-list');
        container.innerHTML = '<div style="text-align: center; color: var(--text-sec); padding: 20px;">Chargement...</div>';
        
        try {
            // Charger les profils
            const { data: users, error } = await supabase
                .from('user_profiles')
                .select('*')
                .order('created_at', { ascending: false });
            
            if(error) throw error;
            
            // Charger tous les projets
            const { data: projects } = await supabase
                .from('projects')
                .select('title, owner_email, created_at')
                .order('created_at', { ascending: false });
            
            // Associer les projets aux utilisateurs
            Admin.allProjects = projects || [];
            Admin.allUsers = (users || []).map(u => {
                const userProjects = projects?.filter(p => p.owner_email === u.email) || [];
                return { ...u, projects: userProjects };
            });
            
            Admin.renderUsers(Admin.allUsers);
            
        } catch(e) {
            console.error('Erreur chargement utilisateurs:', e);
            container.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 40px;">Erreur de chargement</div>';
        }
    },
    
    renderUsers: (users) => {
        const container = document.getElementById('admin-users-list');
        
        if(!users || users.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucun utilisateur</div>';
            return;
        }
        
        container.innerHTML = `
            <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--border); background: var(--bg);">
                        <th class="td-padded">Email</th>
                        <th class="td-padded">Nom du profil</th>
                        <th style="padding: 12px 10px; text-align: center; font-size: 0.85rem;">Types</th>
                        <th class="td-padded">Inscription</th>
                        <th class="td-padded">Projets</th>
                    </tr>
                </thead>
                <tbody>
                    ${users.map(u => {
                        const data = u.profile_data || {};
                        const profileTypes = [];
                        if(data.actor) profileTypes.push('<span title="ComÃ©dien">ðŸŽ­</span>');
                        if(data.crew) profileTypes.push('<span title="Technicien">ðŸŽ¥</span>');
                        if(data.association) profileTypes.push('<span title="Association">ðŸ›ï¸</span>');
                        if(data.enterprise) profileTypes.push('<span title="Entreprise">ðŸ¢</span>');
                        
                        // Projets de l'utilisateur
                        const projectsHtml = u.projects && u.projects.length > 0 
                            ? u.projects.map(p => `<div style="font-size: 0.8rem; margin-bottom: 3px;">
                                <span style="color: var(--text-main);">${Utils.escape(p.title || 'Sans titre')}</span>
                                <span style="color: var(--text-sec); font-size: 0.75rem;">(${new Date(p.created_at).toLocaleDateString('fr-FR')})</span>
                            </div>`).join('')
                            : '<span style="color: var(--text-sec); font-size: 0.8rem;">-</span>';
                        
                        return `
                            <tr style="border-bottom: 1px solid var(--border);" onmouseover="this.style.background='var(--highlight)'" onmouseout="this.style.background=''">
                                <td style="padding: 10px; font-size: 0.85rem;">
                                    <a href="mailto:${u.email}" style="color: var(--primary); text-decoration: none;">${u.email || '-'}</a>
                                </td>
                                <td class="p-10">
                                    <strong>${Utils.escape(u.name || '-')}</strong>
                                </td>
                                <td style="padding: 10px; text-align: center; font-size: 1.1rem;">
                                    ${profileTypes.join(' ') || '<span class="text-sec">-</span>'}
                                </td>
                                <td style="padding: 10px; color: var(--text-sec); font-size: 0.85rem;">
                                    ${u.created_at ? new Date(u.created_at).toLocaleDateString('fr-FR') : '-'}
                                </td>
                                <td class="p-10">
                                    ${projectsHtml}
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            </div>
        `;
    },
    
    filterUsers: (search) => {
        const filtered = Admin.allUsers.filter(u => {
            const s = search.toLowerCase();
            return (u.email && u.email.toLowerCase().includes(s)) || 
                   (u.name && u.name.toLowerCase().includes(s));
        });
        Admin.renderUsers(filtered);
    },
    
    // ===== STATISTIQUES CONNEXIONS =====
    connectionStats: null,
    
    loadConnectionStats: async () => {
        try {
            const { data: logins, error } = await supabase
                .from('user_logins')
                .select('logged_at')
                .order('logged_at', { ascending: false });
            
            if (error) throw error;
            
            Admin.connectionStats = logins || [];
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Compteurs
            let todayCount = 0, weekCount = 0, monthCount = 0;
            logins.forEach(l => {
                const d = new Date(l.logged_at);
                if (d >= today) todayCount++;
                if (d >= weekAgo) weekCount++;
                if (d >= monthAgo) monthCount++;
            });
            
            document.getElementById('stat-today').textContent = todayCount;
            document.getElementById('stat-week').textContent = weekCount;
            document.getElementById('stat-month').textContent = monthCount;
            document.getElementById('stat-total-logins').textContent = logins.length;
            
            // Graphiques
            Admin.drawDailyChart(logins);
            Admin.drawWeeklyChart(logins);
            Admin.drawMonthlyChart(logins);
            
        } catch(e) {
            console.error('Erreur chargement stats connexions:', e);
        }
    },
    
    drawDailyChart: (logins) => {
        const canvas = document.getElementById('chart-daily');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        // PrÃ©parer les donnÃ©es des 7 derniers jours
        const days = [];
        const counts = [];
        const now = new Date();
        
        for (let i = 6; i >= 0; i--) {
            const d = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
            const dayStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);
            
            days.push(d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }));
            counts.push(logins.filter(l => {
                const ld = new Date(l.logged_at);
                return ld >= dayStart && ld < dayEnd;
            }).length);
        }
        
        Admin.drawBarChart(ctx, canvas, days, counts, '#3b82f6');
    },
    
    drawWeeklyChart: (logins) => {
        const canvas = document.getElementById('chart-weekly');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        const weeks = [];
        const counts = [];
        const now = new Date();
        
        for (let i = 3; i >= 0; i--) {
            const weekEnd = new Date(now.getTime() - i * 7 * 24 * 60 * 60 * 1000);
            const weekStart = new Date(weekEnd.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            weeks.push(`Sem. ${weekEnd.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}`);
            counts.push(logins.filter(l => {
                const ld = new Date(l.logged_at);
                return ld >= weekStart && ld < weekEnd;
            }).length);
        }
        
        Admin.drawBarChart(ctx, canvas, weeks, counts, '#8b5cf6');
    },
    
    drawMonthlyChart: (logins) => {
        const canvas = document.getElementById('chart-monthly');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        const months = [];
        const counts = [];
        const now = new Date();
        
        for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const monthStart = new Date(d.getFullYear(), d.getMonth(), 1);
            const monthEnd = new Date(d.getFullYear(), d.getMonth() + 1, 1);
            
            months.push(d.toLocaleDateString('fr-FR', { month: 'short' }));
            counts.push(logins.filter(l => {
                const ld = new Date(l.logged_at);
                return ld >= monthStart && ld < monthEnd;
            }).length);
        }
        
        Admin.drawBarChart(ctx, canvas, months, counts, '#10b981');
    },
    
    drawBarChart: (ctx, canvas, labels, data, color) => {
        // Ajuster la rÃ©solution du canvas
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * 2;
        canvas.height = rect.height * 2;
        ctx.scale(2, 2);
        
        const width = rect.width;
        const height = rect.height;
        const padding = 40;
        const barWidth = (width - padding * 2) / labels.length * 0.7;
        const gap = (width - padding * 2) / labels.length * 0.3;
        const maxVal = Math.max(...data, 1);
        
        // Effacer
        ctx.clearRect(0, 0, width, height);
        
        // Style texte
        const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-sec').trim() || '#666';
        ctx.fillStyle = textColor;
        ctx.font = '11px Arial';
        ctx.textAlign = 'center';
        
        // Dessiner les barres
        labels.forEach((label, i) => {
            const x = padding + i * (barWidth + gap) + gap / 2;
            const barHeight = (data[i] / maxVal) * (height - padding * 2);
            const y = height - padding - barHeight;
            
            // Barre
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(x, y, barWidth, barHeight, 4);
            ctx.fill();
            
            // Valeur au-dessus
            ctx.fillStyle = textColor;
            ctx.fillText(data[i], x + barWidth / 2, y - 5);
            
            // Label en bas
            ctx.fillText(label, x + barWidth / 2, height - 10);
        });
        
        // Ligne de base
        ctx.strokeStyle = textColor;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding, height - padding);
        ctx.lineTo(width - padding / 2, height - padding);
        ctx.stroke();
    },
    
    switchTab: (tabName) => {
        // Cacher tous les contenus
        document.querySelectorAll('.admin-tab-content').forEach(el => el.style.display = 'none');
        // DÃ©sactiver tous les onglets
        document.querySelectorAll('.admin-tab').forEach(el => {
            el.style.background = 'var(--panel-bg)';
            el.style.color = 'var(--text-main)';
            el.classList.remove('active');
        });
        
        // Afficher le contenu sÃ©lectionnÃ©
        document.getElementById('admin-tab-' + tabName).style.display = 'block';
        // Activer l'onglet
        const activeTab = document.querySelector(`.admin-tab[data-tab="${tabName}"]`);
        if(activeTab) {
            activeTab.style.background = 'var(--primary)';
            activeTab.style.color = 'white';
            activeTab.classList.add('active');
        }
        
        // Charger les donnÃ©es si nÃ©cessaire
        if(tabName === 'users' && Admin.allUsers.length === 0) {
            Admin.loadUsers();
        }
        if(tabName === 'analytics') {
            Admin.loadConnectionStats();
        }
        if(tabName === 'config') {
            Admin.loadPrealphaConfig();
        }
    },
    
    // ===== MESSAGE PRÃ‰-ALPHA =====
    loadPrealphaConfig: async () => {
        try {
            const { data, error } = await supabase
                .from('app_config')
                .select('key, value')
                .in('key', ['prealpha_title', 'prealpha_message']);
            
            if (data) {
                data.forEach(item => {
                    if (item.key === 'prealpha_title') {
                        const el = document.getElementById('prealpha-title');
                        if (el) el.textContent = item.value;
                        const input = document.getElementById('config-prealpha-title');
                        if (input) input.value = item.value;
                    }
                    if (item.key === 'prealpha_message') {
                        const el = document.getElementById('prealpha-message');
                        if (el) el.textContent = item.value;
                        const textarea = document.getElementById('config-prealpha-message');
                        if (textarea) textarea.value = item.value;
                    }
                });
            }
        } catch(e) {
            console.log('Erreur chargement config prealpha:', e);
        }
    },
    
    savePrealphaMessage: async () => {
        const title = document.getElementById('config-prealpha-title').value.trim();
        const message = document.getElementById('config-prealpha-message').value.trim();
        
        if (!title || !message) {
            Utils.toast('Veuillez remplir tous les champs', 'error');
            return;
        }
        
        try {
            // Upsert title
            const {error: cfgErr1} = await supabase.from('app_config').upsert({ 
                key: 'prealpha_title', 
                value: title,
                updated_at: new Date().toISOString()
            });
            if(cfgErr1) throw cfgErr1;
            
            // Upsert message
            const {error: cfgErr2} = await supabase.from('app_config').upsert({ 
                key: 'prealpha_message', 
                value: message,
                updated_at: new Date().toISOString()
            });
            if(cfgErr2) throw cfgErr2;
            
            // Mettre Ã  jour l'affichage
            document.getElementById('prealpha-title').textContent = title;
            document.getElementById('prealpha-message').textContent = message;
            
            Utils.toast('Message prÃ©-alpha mis Ã  jour !', 'success');
        } catch(e) {
            console.error('Erreur sauvegarde message prealpha:', e);
            Utils.toast('Erreur de sauvegarde', 'error');
        }
    },
    
    previewPrealphaMessage: () => {
        const title = document.getElementById('config-prealpha-title').value;
        const message = document.getElementById('config-prealpha-message').value;
        
        document.getElementById('prealpha-title').textContent = title;
        document.getElementById('prealpha-message').textContent = message;
        
        Utils.toast('PrÃ©visualisation appliquÃ©e (non sauvegardÃ©e)', 'info');
    },
    
    updateMaxUsers: () => {
        const newLimit = parseInt(document.getElementById('config-max-users').value);
        if(isNaN(newLimit) || newLimit < 1) {
            Utils.toast('Valeur invalide', 'error');
            return;
        }
        CONFIG.preAlpha.maxUsers = newLimit;
        document.getElementById('config-current-limit').textContent = newLimit;
        Utils.toast('Limite mise Ã  jour : ' + newLimit + ' utilisateurs', 'success');
    },
    
    // ===== EMAILING =====
    emailRecipients: [],
    
    updateEmailFilter: async () => {
        if(Admin.allUsers.length === 0) {
            await Admin.loadUsers();
        }
        
        const filters = {
            incompleteProfile: document.getElementById('filter-incomplete-profile')?.checked,
            noPublicProfile: document.getElementById('filter-no-public-profile')?.checked,
            noProject: document.getElementById('filter-no-project')?.checked,
            inactiveProject: document.getElementById('filter-inactive-project')?.checked,
            newUsers: document.getElementById('filter-new-users')?.checked,
            inactiveUsers: document.getElementById('filter-inactive-users')?.checked,
            typeActor: document.getElementById('filter-type-actor')?.checked,
            typeCrew: document.getElementById('filter-type-crew')?.checked,
            typeAssociation: document.getElementById('filter-type-association')?.checked,
            typeEnterprise: document.getElementById('filter-type-enterprise')?.checked
        };
        
        const now = new Date();
        const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
        const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
        
        // Charger les projets pour les filtres liÃ©s aux projets
        let userProjects = {};
        if(filters.noProject || filters.inactiveProject) {
            try {
                const { data: projects } = await supabase.from('projects').select('owner_email, updated_at');
                projects?.forEach(p => {
                    if(!userProjects[p.owner_email]) userProjects[p.owner_email] = [];
                    userProjects[p.owner_email].push(p);
                });
            } catch(e) { console.error(e); }
        }
        
        Admin.emailRecipients = Admin.allUsers.filter(user => {
            const data = user.profile_data || {};
            const email = user.email?.toLowerCase();
            const createdAt = new Date(user.created_at);
            const updatedAt = new Date(user.updated_at || user.created_at);
            
            // Calculer le % de complÃ©tion du profil
            let profileCompletion = 0;
            let hasPublicProfile = false;
            let profileTypes = [];
            
            ['actor', 'crew', 'association', 'enterprise'].forEach(type => {
                if(data[type]) {
                    profileTypes.push(type);
                    if(data[type].isPublic) hasPublicProfile = true;
                    // Calculer complÃ©tion basique
                    const fields = Object.values(data[type]).filter(v => v && v !== '' && v !== false);
                    profileCompletion = Math.max(profileCompletion, Math.min(100, fields.length * 10));
                }
            });
            
            // Appliquer les filtres
            let matches = true;
            
            if(filters.incompleteProfile && profileCompletion >= 50) matches = false;
            if(filters.noPublicProfile && hasPublicProfile) matches = false;
            if(filters.noProject && userProjects[email]?.length > 0) matches = false;
            if(filters.inactiveProject) {
                const projects = userProjects[email] || [];
                const hasInactive = projects.some(p => new Date(p.updated_at) < thirtyDaysAgo);
                if(!hasInactive) matches = false;
            }
            if(filters.newUsers && createdAt < sevenDaysAgo) matches = false;
            if(filters.inactiveUsers && updatedAt > thirtyDaysAgo) matches = false;
            
            // Filtres par type de profil
            const typeFiltersActive = filters.typeActor || filters.typeCrew || filters.typeAssociation || filters.typeEnterprise;
            if(typeFiltersActive) {
                let typeMatch = false;
                if(filters.typeActor && data.actor) typeMatch = true;
                if(filters.typeCrew && data.crew) typeMatch = true;
                if(filters.typeAssociation && data.association) typeMatch = true;
                if(filters.typeEnterprise && data.enterprise) typeMatch = true;
                if(!typeMatch) matches = false;
            }
            
            // Si aucun filtre actif, ne sÃ©lectionner personne
            const anyFilterActive = Object.values(filters).some(v => v);
            if(!anyFilterActive) return false;
            
            return matches;
        });
        
        document.getElementById('email-recipients-count').textContent = Admin.emailRecipients.length;
    },
    
    showRecipientsList: () => {
        if(Admin.emailRecipients.length === 0) {
            Utils.toast('Aucun destinataire sÃ©lectionnÃ©', 'warning');
            return;
        }
        
        const listHtml = Admin.emailRecipients.map(u => `
            <div style="padding: 8px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                <span>${Utils.escape(u.name || 'Sans nom')}</span>
                <span class="text-sec">${u.email}</span>
            </div>
        `).join('');
        
        ConfirmModal.show({
            title: `ðŸ“§ ${Admin.emailRecipients.length} destinataires`,
            message: `<div style="max-height: 400px; overflow-y: auto; background: var(--bg); border-radius: 8px;">${listHtml}</div>`,
            confirmText: 'Fermer',
            icon: 'ðŸ‘¥'
        });
    },
    
    loadEmailTemplate: (template) => {
        const templates = {
            'welcome': {
                subject: 'ðŸ‘‹ Bienvenue sur Moteur !',
                body: `Bonjour {nom},

Bienvenue sur Moteur, la plateforme de gestion de production audiovisuelle !

Nous sommes ravis de vous compter parmi nos utilisateurs. N'hÃ©sitez pas Ã  explorer toutes les fonctionnalitÃ©s :
- CrÃ©ez votre profil public pour Ãªtre visible dans l'Univers
- Lancez votre premier projet
- Connectez-vous avec d'autres professionnels

Si vous avez des questions, n'hÃ©sitez pas Ã  nous contacter.

Ã€ trÃ¨s vite sur Moteur !
L'Ã©quipe Moteur ðŸŽ¬`
            },
            'complete-profile': {
                subject: 'ðŸ‘¤ ComplÃ©tez votre profil Moteur',
                body: `Bonjour {nom},

Nous avons remarquÃ© que votre profil sur Moteur n'est pas encore complet.

Un profil complet vous permet :
- D'Ãªtre visible dans l'Univers par les autres professionnels
- De recevoir des propositions de projets adaptÃ©es
- De gagner en crÃ©dibilitÃ© auprÃ¨s de la communautÃ©

Prenez 5 minutes pour complÃ©ter votre profil et maximisez vos opportunitÃ©s !

ðŸ‘‰ Connectez-vous sur moteur.studio

L'Ã©quipe Moteur ðŸŽ¬`
            },
            'reactivation': {
                subject: 'ðŸ”„ Moteur vous manque !',
                body: `Bonjour {nom},

Cela fait un moment que nous ne vous avons pas vu sur Moteur !

Depuis votre derniÃ¨re visite, nous avons ajoutÃ© de nouvelles fonctionnalitÃ©s :
- L'Univers pour dÃ©couvrir des profils et projets
- Le systÃ¨me de matching intelligent
- De nouveaux outils de gestion de projet

Revenez dÃ©couvrir tout Ã§a !

ðŸ‘‰ Connectez-vous sur moteur.studio

L'Ã©quipe Moteur ðŸŽ¬`
            },
            'new-feature': {
                subject: 'ðŸ†• Nouvelle fonctionnalitÃ© sur Moteur !',
                body: `Bonjour {nom},

Nous avons le plaisir de vous annoncer une nouvelle fonctionnalitÃ© sur Moteur !

[DÃ©crivez la fonctionnalitÃ© ici]

Connectez-vous pour la dÃ©couvrir !

ðŸ‘‰ moteur.studio

L'Ã©quipe Moteur ðŸŽ¬`
            },
            'feedback': {
                subject: 'ðŸ’¬ Votre avis compte !',
                body: `Bonjour {nom},

Vous utilisez Moteur depuis votre inscription le {date_inscription}, et nous aimerions avoir votre retour.

Quelques questions rapides :
- Qu'est-ce qui vous plaÃ®t sur Moteur ?
- Qu'est-ce qui pourrait Ãªtre amÃ©liorÃ© ?
- Quelle fonctionnalitÃ© aimeriez-vous voir ajoutÃ©e ?

RÃ©pondez simplement Ã  cet email, nous lisons tous les retours !

Merci pour votre aide prÃ©cieuse.

L'Ã©quipe Moteur ðŸŽ¬`
            }
        };
        
        if(templates[template]) {
            document.getElementById('email-subject').value = templates[template].subject;
            document.getElementById('email-body').value = templates[template].body;
        }
    },
    
    previewEmail: () => {
        const subject = document.getElementById('email-subject').value;
        const body = document.getElementById('email-body').value;
        
        if(!subject || !body) {
            Utils.toast('Remplissez l\'objet et le message', 'warning');
            return;
        }
        
        // Exemple avec le premier destinataire ou des valeurs par dÃ©faut
        const example = Admin.emailRecipients[0] || { name: 'Jean Dupont', email: 'exemple@email.com', created_at: new Date().toISOString() };
        
        const previewBody = body
            .replace(/\{nom\}/g, example.name || 'Utilisateur')
            .replace(/\{email\}/g, example.email || '')
            .replace(/\{date_inscription\}/g, new Date(example.created_at).toLocaleDateString('fr-FR'));
        
        ConfirmModal.show({
            title: 'ðŸ‘ï¸ PrÃ©visualisation',
            message: `
                <div style="background: var(--bg); border-radius: 8px; padding: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                        ðŸ“§ ${Utils.escape(subject)}
                    </div>
                    <div style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;">
${Utils.escape(previewBody)}
                    </div>
                </div>
            `,
            confirmText: 'Fermer',
            icon: 'ðŸ“§'
        });
    },
    
    sendEmails: async () => {
        const subject = document.getElementById('email-subject').value;
        const body = document.getElementById('email-body').value;
        
        if(!subject || !body) {
            Utils.toast('Remplissez l\'objet et le message', 'warning');
            return;
        }
        
        if(Admin.emailRecipients.length === 0) {
            Utils.toast('Aucun destinataire sÃ©lectionnÃ©', 'warning');
            return;
        }
        
        const confirmed = await ConfirmModal.show({
            title: 'ðŸ“¤ Confirmer l\'envoi',
            message: `Vous Ãªtes sur le point d'envoyer cet email Ã  <strong>${Admin.emailRecipients.length} destinataires</strong>.<br><br>Cette action est irrÃ©versible.`,
            confirmText: 'Envoyer',
            icon: 'ðŸ“§'
        });
        
        if(!confirmed) return;
        
        Utils.toast('Envoi en cours...', 'info');
        
        let sent = 0;
        let errors = 0;
        
        for(const recipient of Admin.emailRecipients) {
            try {
                const personalizedBody = body
                    .replace(/\{nom\}/g, recipient.name || 'Utilisateur')
                    .replace(/\{email\}/g, recipient.email || '')
                    .replace(/\{date_inscription\}/g, new Date(recipient.created_at).toLocaleDateString('fr-FR'));
                
                // Utiliser EmailJS
                await emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, {
                    to_email: recipient.email,
                    to_name: recipient.name || 'Utilisateur',
                    subject: subject,
                    message: personalizedBody
                });
                
                sent++;
                
                // Pause pour Ã©viter le rate limiting
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch(e) {
                console.error('Erreur envoi email Ã ', recipient.email, e);
                errors++;
            }
        }
        
        if(errors === 0) {
            Utils.toast(`âœ… ${sent} emails envoyÃ©s avec succÃ¨s !`, 'success');
        } else {
            Utils.toast(`ðŸ“§ ${sent} envoyÃ©s, ${errors} erreurs`, 'warning');
        }
    }
};

// --- MODULE UNIVERSE V86 ---
// â•â•â•â•â•â•â• V2.1.6 â€” HUB CENTRAL â•â•â•â•â•â•â•
const Hub = {
    customizing: false,
    
    // Cartes disponibles (id, iconKey, title, desc, action)
    allCards: [
        { id:'projects', iconKey:'folder', title:'Mes Projets', desc:'GÃ©rer mes projets de film', action:'app.Universe.showProjects()' },
        { id:'universe', iconKey:'universe', title:'Univers', desc:'Explorer la carte des profils', action:'app.Universe.openFromMenu()' },
        { id:'profile', iconKey:'user', title:'Mon Profil', desc:'Modifier mes profils publics', action:'app.PublicProfile.open()' },
        { id:'contacts', iconKey:'contact', title:'Contacts', desc:'Mes favoris et l\'annuaire', action:'app.Contacts.open()' },
        { id:'forum', iconKey:'forum', title:'Forum', desc:'Discussions communautaires', action:'app.Forum.open()' },
        { id:'feed', iconKey:'feed', title:'Le Fil', desc:'Publications de la communautÃ©', action:'app.Feed.open()' },
        { id:'courses', iconKey:'course', title:'Cours', desc:'Apprendre le cinÃ©ma', action:'app.Courses.open()' },
        { id:'guide', iconKey:'guide', title:'Guide', desc:'Tutoriel de l\'application', action:'app.Tutorial.open()' },
        { id:'messages', iconKey:'message', title:'Messages', desc:'Ma messagerie', action:"app.PublicProfile.open(); setTimeout(()=>app.PublicProfile.showTab('messages'),100)" },
    ],
    
    getCardIcon: (card) => {
        return Icons.render(card.iconKey);
    },
    
    defaultCards: ['projects','universe','profile','contacts','forum','courses'],
    
    getActiveCards: () => {
        try {
            const saved = localStorage.getItem('moteur_hub_cards');
            if(saved) return JSON.parse(saved);
        } catch(e) {}
        return [...Hub.defaultCards];
    },
    
    saveCards: (cards) => {
        PreferencesSync.save('moteur_hub_cards', JSON.stringify(cards));
    },
    
    render: () => {
        // Welcome
        const email = state.currentUser ? state.currentUser.email : '';
        const name = state.userProfile?.displayName || state.userProfile?.name || email.split('@')[0] || '';
        const titleEl = document.getElementById('hub-welcome-title');
        if(titleEl) titleEl.innerHTML = 'Bonjour <span>' + Utils.escape(name) + '</span> ðŸ‘‹';
        const accountType = state.userProfile?.accountType || 'producer';
        const typeLabel = accountType === 'actor' ? 'ðŸŽ­ ComÃ©dien.ne' : (accountType === 'crew' ? 'ðŸŽ¥ Technicien.ne' : 'ðŸŽ¬ RÃ©alisateur');
        const subEl = document.getElementById('hub-welcome-sub');
        if(subEl) subEl.textContent = typeLabel + ' â€¢ ' + email;
        
        // Onboarding
        try {
            const dismissed = localStorage.getItem('moteur_ob_dismissed');
            const obEl = document.getElementById('hub-onboarding');
            if(obEl && !dismissed) {
                const profileDone = state.userProfile?.profileComplete;
                const stepProfile = document.getElementById('hub-ob-profile');
                const stepProject = document.getElementById('hub-ob-project');
                if(stepProfile) { stepProfile.textContent = profileDone ? 'âœ“ Profil complÃ©tÃ©' : 'â—‹ Profil complÃ©tÃ©'; if(profileDone) stepProfile.classList.add('done'); }
                // Le projet sera mis Ã  jour aprÃ¨s le chargement des stats
                obEl.style.display = 'flex';
                if(profileDone) {
                    // VÃ©rifier projets de maniÃ¨re async
                    Store.getProjectsList().then(list => {
                        if(stepProject) { stepProject.textContent = list.length > 0 ? 'âœ“ Premier projet' : 'â—‹ Premier projet'; if(list.length > 0) stepProject.classList.add('done'); }
                        if(profileDone && list.length > 0) obEl.style.display = 'none';
                    });
                }
            }
        } catch(e) {}
        
        // Cards
        Hub.renderCards();
        
        // Stats (async)
        Hub.loadStats();
    },
    
    renderCards: () => {
        const container = document.getElementById('hub-cards');
        if(!container) return;
        const activeIds = Hub.getActiveCards();
        
        container.innerHTML = activeIds.map((id, index) => {
            const card = Hub.allCards.find(c => c.id === id);
            if(!card) return '';
            return `<div class="hub-card pos-relative" onclick="${Hub.customizing ? '' : card.action}">
                <span class="hub-card-icon">${Icons.render(card.iconKey)}</span>
                <div class="hub-card-title">${card.title}</div>
                <div class="hub-card-desc">${card.desc}</div>
                <span class="hub-card-badge d-none" id="hub-badge-${card.id}"></span>
                ${Hub.customizing ? '<button class="hub-card-edit" style="opacity:1;" onclick="event.stopPropagation(); app.Hub.changeCard('+index+', this)">âœï¸</button>' : ''}
            </div>`;
        }).join('');
    },
    
    toggleCustomize: () => {
        Hub.customizing = !Hub.customizing;
        const btn = document.querySelector('.hub-customize-btn');
        if(btn) btn.innerHTML = Hub.customizing ? 'âœ… TerminÃ©' : 'âš™ï¸ Personnaliser';
        Hub.renderCards();
    },
    
    changeCard: (index, btnEl) => {
        const activeIds = Hub.getActiveCards();
        const cardEl = btnEl.closest('.hub-card');
        
        // Fermer selector existant
        const existing = document.querySelector('.hub-card-selector.show');
        if(existing) { existing.remove(); return; }
        
        const selector = document.createElement('div');
        selector.className = 'hub-card-selector show';
        
        // Lister les cartes disponibles (pas dÃ©jÃ  utilisÃ©es, sauf celle qu'on remplace)
        const available = Hub.allCards.filter(c => !activeIds.includes(c.id) || c.id === activeIds[index]);
        selector.innerHTML = available.map(c => 
            `<div class="hub-card-option" onclick="event.stopPropagation(); app.Hub.selectCard(${index}, '${c.id}')">${Icons.render(c.iconKey)} ${c.title}</div>`
        ).join('');
        
        cardEl.style.zIndex = '999';
        cardEl.appendChild(selector);
        
        // Fermer au clic ailleurs
        setTimeout(() => {
            const close = (e) => { if(!selector.contains(e.target)) { selector.remove(); cardEl.style.zIndex = ''; document.removeEventListener('click', close); } };
            document.addEventListener('click', close);
        }, 10);
    },
    
    selectCard: (index, newId) => {
        const activeIds = Hub.getActiveCards();
        activeIds[index] = newId;
        Hub.saveCards(activeIds);
        Hub.renderCards();
        // Fermer le selector
        const sel = document.querySelector('.hub-card-selector.show');
        if(sel) sel.remove();
    },
    
    loadStats: async () => {
        try {
            // Projets
            const projects = await Store.getProjectsList();
            const projEl = document.getElementById('hub-stat-projects');
            if(projEl) projEl.textContent = projects.length;
            
            // Badge sur carte projets
            const projBadge = document.getElementById('hub-badge-projects');
            if(projBadge && projects.length > 0) { projBadge.textContent = projects.length; projBadge.style.display = 'block'; }
            
            // Onboarding : mise Ã  jour projet
            const stepProject = document.getElementById('hub-ob-project');
            if(stepProject && projects.length > 0) { stepProject.textContent = 'âœ“ Premier projet'; stepProject.classList.add('done'); }
        } catch(e) {}
        
        try {
            // Profils Univers
            const { count } = await supabase.from('user_profiles').select('*', { count: 'exact', head: true }).eq('is_public', true);
            const profEl = document.getElementById('hub-stat-profiles');
            if(profEl) profEl.textContent = count || 0;
        } catch(e) {}
        
        try {
            // Sujets Forum
            const { count } = await supabase.from('forum_threads').select('*', { count: 'exact', head: true });
            const forumEl = document.getElementById('hub-stat-forum');
            if(forumEl) forumEl.textContent = count || 0;
        } catch(e) {}
        
        try {
            // Messages non lus
            const email = state.currentUser?.email;
            if(email) {
                const { count } = await supabase.from('messages').select('*', { count: 'exact', head: true }).eq('to_email', email).eq('read', false);
                const msgEl = document.getElementById('hub-stat-messages');
                if(msgEl) msgEl.textContent = count || 0;
                
                // Badge sur carte messages
                const msgBadge = document.getElementById('hub-badge-messages');
                if(msgBadge && count > 0) { msgBadge.textContent = count; msgBadge.style.display = 'block'; }
            }
        } catch(e) {}
    }
};

const Universe = {
    filteredProfiles: [],
    allProjects: [],
    filteredProjects: [],
    currentProfile: null,
    cards: [],
    animationRunning: false,
    sceneRect: null,
    myProfiles: [], // Profils de l'utilisateur
    myProjects: [], // Projets de l'utilisateur
    
    // Carte Leaflet
    map: null,
    markersLayer: null,
    tileLayer: null,
    viewMode: 'map', // 'map' ou 'fan'
    geoCache: {}, // Cache des gÃ©olocalisations
    hoverCard: null,
    
    
    // Initialiser la carte
    initMap: () => {
        if(Universe.map) return; // DÃ©jÃ  initialisÃ©e
        
        const mapContainer = document.getElementById('universe-map');
        if(!mapContainer) return;
        
        // CrÃ©er la carte centrÃ©e sur la France
        Universe.map = L.map('universe-map', {
            center: [46.603354, 1.888334],
            zoom: 5,
            minZoom: 2,
            maxZoom: 18,
            zoomControl: true
        });
        
        // Tuiles selon le thÃ¨me
        Universe.updateMapTheme();
        
        // Groupe de marqueurs avec clustering
        Universe.markersLayer = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            disableClusteringAtZoom: 14,
            spiderfyDistanceMultiplier: 1.5,
            iconCreateFunction: (cluster) => {
                const count = cluster.getChildCount();
                let size = 'small';
                if(count > 10) size = 'medium';
                if(count > 50) size = 'large';
                return L.divIcon({
                    html: `<div>${count}</div>`,
                    className: `marker-cluster marker-cluster-${size}`,
                    iconSize: [40, 40]
                });
            }
        });
        
        Universe.map.addLayer(Universe.markersLayer);
        
        // Ã‰vÃ©nement hover sur cluster
        Universe.markersLayer.on('clustermouseover', (e) => {
            const cluster = e.layer;
            const markers = cluster.getAllChildMarkers();
            if(markers.length > 0) {
                const randomMarker = markers[Math.floor(Math.random() * markers.length)];
                Universe.showHoverCard(randomMarker.options.profileData, e.originalEvent);
            }
        });
        
        Universe.markersLayer.on('clustermouseout', () => {
            Universe.hideHoverCard();
        });
        
        // NOTE: On ne recharge plus les marqueurs au dÃ©placement/zoom
        // car les positions sont maintenant fixes (dÃ©terministes)
    },
    
    // Ajoute un lÃ©ger dÃ©calage alÃ©atoire pour Ã©viter la superposition
    addCoordOffset: (lat, lng) => {
        const offset = 0.002; // ~200m de dÃ©calage max
        const randomLat = lat + (Math.random() - 0.5) * offset;
        const randomLng = lng + (Math.random() - 0.5) * offset;
        return { lat: randomLat, lng: randomLng };
    },
    
    // GÃ©nÃ¨re un dÃ©calage dÃ©terministe basÃ© sur l'ID du profil (toujours le mÃªme pour un mÃªme profil)
    getDeterministicOffset: (profileId, lat, lng) => {
        // Hash simple basÃ© sur l'ID pour gÃ©nÃ©rer un nombre pseudo-alÃ©atoire reproductible
        let hash = 0;
        const str = String(profileId);
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        
        // Utiliser le hash pour gÃ©nÃ©rer un dÃ©calage entre -0.003 et +0.003 (~300m)
        const offsetRange = 0.003;
        const latOffset = ((hash % 1000) / 1000 - 0.5) * offsetRange * 2;
        const lngOffset = (((hash >> 10) % 1000) / 1000 - 0.5) * offsetRange * 2;
        
        return {
            lat: lat + latOffset,
            lng: lng + lngOffset
        };
    },
    
    // DÃ©termine si l'adresse doit Ãªtre masquÃ©e pour ce profil
    shouldHideAddress: (profile) => {
        // ComÃ©diens et techniciens : toujours masquÃ© dans l'Univers
        if (profile.type === 'actor' || profile.type === 'crew') {
            return true;
        }
        // Associations et entreprises : selon leur choix
        if (profile.type === 'association' || profile.type === 'enterprise') {
            return profile.hideAddress === true;
        }
        // Projets : hÃ©rite du porteur de projet
        if (profile.type === 'project') {
            return true; // On masque par dÃ©faut pour les projets
        }
        return false;
    },
    
    // GÃ©ocoder une ville (avec cache et API Nominatim)
    geocodeCity: async (city) => {
        if(!city) return null;
        
        const cityKey = city.toLowerCase().trim();
        
        // VÃ©rifier le cache
        if(Universe.geoCache[cityKey]) {
            return Universe.geoCache[cityKey];
        }
        
        // VÃ©rifier le localStorage
        try {
            const cached = localStorage.getItem('fmp_geocache');
            if(cached) {
                const cacheData = JSON.parse(cached);
                if(cacheData[cityKey]) {
                    Universe.geoCache[cityKey] = cacheData[cityKey];
                    return cacheData[cityKey];
                }
            }
        } catch(e) {}
        
        // Appeler l'API Nominatim
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`, {
                headers: { 'User-Agent': 'Moteur/1.9' }
            });
            const data = await response.json();
            
            if(data && data.length > 0) {
                const result = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                Universe.geoCache[cityKey] = result;
                
                // Sauvegarder dans localStorage
                try {
                    const cached = localStorage.getItem('fmp_geocache');
                    const cacheData = cached ? JSON.parse(cached) : {};
                    cacheData[cityKey] = result;
                    localStorage.setItem('fmp_geocache', JSON.stringify(cacheData));
                } catch(e) {}
                
                return result;
            }
        } catch(e) {
            console.warn('Geocoding error:', e);
        }
        
        return null;
    },
    
    // CrÃ©er un marqueur pour un profil
    createMapMarker: (profile, coords) => {
        const isProject = profile.type === 'project';
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        
        let markerClass = 'map-profile-marker';
        if(isProject) markerClass += ' project-marker';
        else if(isActor) markerClass += ' actor-marker';
        else if(isCrew) markerClass += ' crew-marker';
        else if(isAssociation) markerClass += ' association-marker';
        else if(isEnterprise) markerClass += ' enterprise-marker';
        
        const photoUrl = profile.photoURL || profile.mainPhoto || '';
        const defaultIcon = isProject ? 'ðŸŽ¬' : (isActor ? 'ðŸŽ­' : 'ðŸŽ¥');
        const name = profile.displayName || profile.title || profile.name || 'Sans nom';
        
        const iconHtml = `
            <div class="${markerClass}">
                ${photoUrl ? `<img src="${photoUrl}" alt="${name}" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:40px;display:flex;align-items:center;justify-content:center;background:var(--panel-bg);border-radius:6px;font-size:20px;\\'>${defaultIcon}</div>'">` : `<div style="width:100%;height:40px;display:flex;align-items:center;justify-content:center;background:var(--panel-bg);border-radius:6px;border:2px solid var(--primary);font-size:20px;">${defaultIcon}</div>`}
                <div class="marker-label">${name}</div>
            </div>
        `;
        
        const icon = L.divIcon({
            html: iconHtml,
            className: 'map-marker-container',
            iconSize: [40, 50],
            iconAnchor: [20, 50]
        });
        
        // Ajouter un lÃ©ger dÃ©calage pour Ã©viter la superposition
        const offsetCoords = Universe.addCoordOffset(coords.lat, coords.lng);
        const marker = L.marker([offsetCoords.lat, offsetCoords.lng], { 
            icon: icon,
            profileData: profile
        });
        
        // Ã‰vÃ©nements hover
        marker.on('mouseover', (e) => {
            Universe.showHoverCard(profile, e.originalEvent);
        });
        
        marker.on('mouseout', () => {
            Universe.hideHoverCard();
        });
        
        // Clic pour ouvrir le profil ou projet
        marker.on('click', () => {
            Universe.hideHoverCard();
            if(isProject) {
                Universe.openProjectModal(profile);
            } else {
                Universe.openProfileModal(profile);
            }
        });
        
        return marker;
    },
    
    // Afficher la modale de profil (pour tous les profils)
    showProfileModal: async (profile) => {
        const isProject = profile.type === 'project';
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        
        // Charger les donnÃ©es complÃ¨tes depuis Supabase
        let fullProfile = profile;
        if(!isProject) {
            try {
                const { data: profileData } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', profile.id)
                    .single();
                
                if(profileData) {
                    const extraData = profileData.data || {};
                    fullProfile = { 
                        ...profileData, 
                        ...extraData,
                        id: profile.id, 
                        type: profileData.profile_type || profile.type,
                        hasVehicle: profileData.vehicle || false,
                        availabilityText: profileData.availability || ''
                    };
                }
            } catch(e) { console.warn('Erreur chargement profil:', e); }
        }
        
        // Pour les projets, les donnÃ©es sont dÃ©jÃ  dans le profil passÃ© en paramÃ¨tre
        if(isProject) {
            // Les projets publics sont stockÃ©s dans les donnÃ©es du projet
            fullProfile = { ...profile, id: profile.id, type: 'project' };
        }
        
        const name = fullProfile.displayName || fullProfile.name || fullProfile.title || fullProfile.assoName || fullProfile.entName || 'Sans nom';
        const city = fullProfile.city || fullProfile.location || 'Non renseignÃ©';
        const photo = fullProfile.photoURL || fullProfile.mainPhoto || fullProfile.poster || '';
        
        let typeLabel = 'ðŸ‘¤ Profil';
        let typeColor = 'var(--primary)';
        if(isProject) { typeLabel = 'ðŸŽ¬ Projet'; typeColor = '#e94560'; }
        else if(isActor) { typeLabel = 'ðŸŽ­ ComÃ©dienÂ·ne'; typeColor = '#4CAF50'; }
        else if(isCrew) { typeLabel = 'ðŸŽ¥ TechnicienÂ·ne'; typeColor = '#2196F3'; }
        else if(isAssociation) { typeLabel = 'ðŸ›ï¸ Association'; typeColor = '#FF9800'; }
        else if(isEnterprise) { typeLabel = 'ðŸ¢ Entreprise'; typeColor = '#9C27B0'; }
        
        // Construire les dÃ©tails selon le type
        let detailsHTML = '';
        
        if(isActor) {
            detailsHTML = `
                ${fullProfile.gender ? `<p><strong>Genre:</strong> ${fullProfile.gender}</p>` : ''}
                ${fullProfile.age ? `<p><strong>Ã‚ge:</strong> ${fullProfile.age} ans</p>` : ''}
                ${fullProfile.height ? `<p><strong>Taille:</strong> ${fullProfile.height} cm</p>` : ''}
                ${fullProfile.eyeColor ? `<p><strong>Yeux:</strong> ${fullProfile.eyeColor}</p>` : ''}
                ${fullProfile.hairColor ? `<p><strong>Cheveux:</strong> ${fullProfile.hairColor}${fullProfile.hairLength ? ' (' + fullProfile.hairLength + ')' : ''}</p>` : ''}
                ${fullProfile.ethnicity ? `<p><strong>Origine:</strong> ${fullProfile.ethnicity}</p>` : ''}
                ${fullProfile.sports ? `<p><strong>Sports:</strong> ${fullProfile.sports}</p>` : ''}
                ${fullProfile.languages ? `<p><strong>Langues:</strong> ${fullProfile.languages}</p>` : ''}
            `;
        } else if(isCrew) {
            detailsHTML = `
                ${fullProfile.department ? `<p><strong>DÃ©partement:</strong> ${fullProfile.department}</p>` : ''}
                ${fullProfile.role ? `<p><strong>Fonction:</strong> ${fullProfile.role}</p>` : ''}
                ${fullProfile.experience ? `<p><strong>ExpÃ©rience:</strong> ${fullProfile.experience}</p>` : ''}
            `;
        } else if(isProject) {
            detailsHTML = `
                ${fullProfile.projectType ? `<p><strong>Type:</strong> ${fullProfile.projectType}</p>` : ''}
                ${fullProfile.genre ? `<p><strong>Genre:</strong> ${fullProfile.genre}</p>` : ''}
                ${fullProfile.director ? `<p><strong>RÃ©alisateur:</strong> ${fullProfile.director}</p>` : ''}
                ${fullProfile.producer ? `<p><strong>Producteur:</strong> ${fullProfile.producer}</p>` : ''}
                ${fullProfile.synopsis ? `<p><strong>Synopsis:</strong> ${fullProfile.synopsis}</p>` : ''}
            `;
        } else if(isAssociation) {
            detailsHTML = `
                ${fullProfile.assoType ? `<p><strong>Type:</strong> ${fullProfile.assoType}</p>` : ''}
                ${fullProfile.description ? `<p><strong>Description:</strong> ${fullProfile.description}</p>` : ''}
            `;
        } else if(isEnterprise) {
            detailsHTML = `
                ${fullProfile.entType ? `<p><strong>Type:</strong> ${fullProfile.entType}</p>` : ''}
                ${fullProfile.description ? `<p><strong>Description:</strong> ${fullProfile.description}</p>` : ''}
            `;
        }
        
        // Galerie photos
        let galleryHTML = '';
        const photos = fullProfile.gallery || fullProfile.photos || [];
        if(photos.length > 0) {
            galleryHTML = `
                <div style="margin:15px 0;">
                    <strong>BIO</strong>
                    <div style="display:flex; gap:10px; margin-top:10px; overflow-x:auto; padding:5px 0;">
                        ${photos.slice(0, 5).map(p => `<img src="${p}" style="width:80px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer;" onclick="window.open('${p}', '_blank')">`).join('')}
                    </div>
                </div>
            `;
        }
        
        // Contact
        let contactHTML = '';
        if(fullProfile.email || fullProfile.phone) {
            contactHTML = `
                <div style="background:var(--bg); padding:15px; border-radius:8px; margin:15px 0;">
                    <strong>CONTACT</strong>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                        ${fullProfile.email ? `<div><small class="text-sec">Email</small><br>${fullProfile.email}</div>` : ''}
                        ${fullProfile.phone ? `<div><small class="text-sec">TÃ©lÃ©phone</small><br>${fullProfile.phone}</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:20000; padding:20px; box-sizing:border-box;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:16px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto; position:relative; animation:fadeInCard 0.3s ease;">
                ${fullProfile.isFavorite ? '<span style="position:absolute; top:15px; left:15px; font-size:1.5rem;">â­</span>' : ''}
                <button onclick="this.closest('div[style*=fixed]').remove()" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">âœ•</button>
                
                <div style="text-align:center; padding:30px 20px 20px;">
                    <div style="width:120px; height:120px; border-radius:50%; margin:0 auto 15px; overflow:hidden; border:4px solid ${typeColor}; background:var(--bg); display:flex; align-items:center; justify-content:center;">
                        ${photo ? `<img src="${photo}" class="img-cover">` : `<span style="font-size:3rem;">${isProject ? 'ðŸŽ¬' : (isActor ? 'ðŸŽ­' : (isCrew ? 'ðŸŽ¥' : (isAssociation ? 'ðŸ›ï¸' : 'ðŸ¢')))}</span>`}
                    </div>
                    <h2 style="margin:0 0 5px; color:var(--text-main);">${Utils.escape(name)}</h2>
                    <span style="color:${typeColor}; font-weight:500;">${typeLabel}</span>
                    <p style="margin:5px 0 0; color:var(--text-sec);">ðŸ“ ${city}</p>
                </div>
                
                ${galleryHTML}
                
                ${detailsHTML ? `<div style="padding:0 20px;"><div style="background:var(--bg); padding:15px; border-radius:8px;"><strong>INFORMATIONS</strong><div style="margin-top:10px; color:var(--text-sec); line-height:1.8;">${detailsHTML}</div></div></div>` : ''}
                
                ${contactHTML ? `<div style="padding:0 20px;">${contactHTML}</div>` : ''}
                
                <div style="padding:20px; display:flex; gap:10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1; padding:12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text-main);">Fermer</button>
                    ${!isProject ? `<button onclick="app.Messages.openCompose('${fullProfile.email || ''}'); this.closest('div[style*=fixed]').remove();" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">âœ‰ï¸ Contacter</button>` : ''}
                    ${isProject ? `<button onclick="app.Messages.openCompose('${fullProfile.ownerEmail || ''}'); this.closest('div[style*=fixed]').remove();" style="flex:1; padding:12px; background:#e94560; color:white; border:none; border-radius:8px; cursor:pointer;">âœ‰ï¸ Contacter le projet</button>` : ''}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },

    // Afficher un profil de dÃ©monstration
    showDemoProfile: (profile) => {
        const isProject = profile.type === 'project';
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        
        let typeLabel = 'ðŸ‘¤ Profil';
        if(isProject) typeLabel = 'ðŸŽ¬ Projet';
        else if(isActor) typeLabel = 'ðŸŽ­ ComÃ©dienÂ·ne';
        else if(isCrew) typeLabel = 'ðŸŽ¥ TechnicienÂ·ne';
        else if(isAssociation) typeLabel = 'ðŸ›ï¸ Association';
        else if(isEnterprise) typeLabel = 'ðŸ¢ Entreprise';
        
        const name = profile.displayName || profile.name || profile.title || 'Sans nom';
        const city = profile.city || 'Non renseignÃ©';
        
        let details = `<p><strong>Ville :</strong> ${city}</p>`;
        
        if(isActor) {
            details += `<p><strong>Genre :</strong> ${profile.gender === 'homme' ? 'Homme' : 'Femme'}</p>`;
            if(profile.age) details += `<p><strong>Ã‚ge :</strong> ${profile.age} ans</p>`;
        } else if(isCrew) {
            if(profile.role) details += `<p><strong>Fonction :</strong> ${profile.role}</p>`;
        } else if(isProject) {
            if(profile.projectType) details += `<p><strong>Type :</strong> ${profile.projectType}</p>`;
            if(profile.genre) details += `<p><strong>Genre :</strong> ${profile.genre}</p>`;
        } else if(isAssociation) {
            if(profile.assoType) details += `<p><strong>Type :</strong> ${profile.assoType}</p>`;
        } else if(isEnterprise) {
            if(profile.entType) details += `<p><strong>Type :</strong> ${profile.entType}</p>`;
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:20000;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:16px; padding:30px; max-width:400px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.3); animation:fadeInCard 0.3s ease;">
                <div style="text-align:center; margin-bottom:20px;">
                    <div style="font-size:3rem; margin-bottom:10px;">${isProject ? 'ðŸŽ¬' : (isActor ? 'ðŸŽ­' : (isCrew ? 'ðŸŽ¥' : (isAssociation ? 'ðŸ›ï¸' : 'ðŸ¢')))}</div>
                    <h2 style="margin:0; color:var(--text-main);">${name}</h2>
                    <span style="color:var(--primary); font-size:0.9rem;">${typeLabel}</span>
                </div>
                <div style="color:var(--text-sec); line-height:1.8;">
                    ${details}
                </div>
                <p style="text-align:center; margin-top:20px; padding:10px; background:var(--bg); border-radius:8px; color:var(--text-sec); font-size:0.85rem;">
                    âš ï¸ Ceci est un profil de dÃ©monstration
                </p>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="width:100%; margin-top:15px; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Fermer</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    },

    // Afficher la carte de survol
    showHoverCard: (profile, event) => {
        const hoverDiv = document.getElementById('map-hover-card');
        if(!hoverDiv) return;
        
        const card = Universe.createFanCard(profile, false);
        hoverDiv.innerHTML = '';
        hoverDiv.appendChild(card);
        
        // Positionner prÃ¨s de la souris
        const x = event.clientX + 15;
        const y = event.clientY - 100;
        
        hoverDiv.style.left = Math.min(x, window.innerWidth - 220) + 'px';
        hoverDiv.style.top = Math.max(y, 10) + 'px';
        hoverDiv.style.display = 'block';
    },
    
    // Masquer la carte de survol
    hideHoverCard: () => {
        const hoverDiv = document.getElementById('map-hover-card');
        if(hoverDiv) hoverDiv.style.display = 'none';
    },
    
    // Compteur de positions par ville pour la spirale
    cityPositionCounters: {},

    // Charger les marqueurs sur la carte
    loadMapMarkers: async () => {
        // Si des filtres sont actifs, utiliser les rÃ©sultats filtrÃ©s
        if(Universe.filteredProfiles.length > 0 || Universe.filteredProjects.length > 0) {
            await Universe.loadFilteredMapMarkers();
        } else {
            await Universe.loadMapMarkersInView();
        }
    },
    
    // Charge max 100 profils visibles dans la zone de la carte
    loadMapMarkersInView: async () => {
        if(!Universe.map || !Universe.markersLayer) return;
        
        Universe.markersLayer.clearLayers();
        Universe.cityPositionCounters = {}; // Reset des compteurs
        
        // RÃ©cupÃ©rer le type sÃ©lectionnÃ© pour filtrer mÃªme sans recherche
        const selectedType = document.getElementById('universe-type')?.value;
        
        let profiles = [...Universe.allProfiles];
        let projects = [...Universe.allProjects];
        
        // Filtrer par type si sÃ©lectionnÃ©
        if(selectedType) {
            if(selectedType === 'project') {
                profiles = [];
            } else {
                profiles = profiles.filter(p => p.type === selectedType);
                projects = [];
            }
        }
        
        // Combiner les rÃ©sultats filtrÃ©s
        const allItems = [...profiles, ...projects];
        
        // MÃ©langer alÃ©atoirement
        const shuffled = Universe.shuffleArray(allItems);
        
        // Limiter Ã  100 profils max
        const maxProfiles = 100;
        const limitedItems = shuffled.slice(0, maxProfiles);
        
        // Obtenir les bounds actuels de la carte
        const bounds = Universe.map.getBounds();
        
        // Charger les marqueurs par batch
        const batchSize = 10;
        
        for(let i = 0; i < limitedItems.length; i += batchSize) {
            const batch = limitedItems.slice(i, i + batchSize);
            
            await Promise.all(batch.map(async (item) => {
                const city = item.city || item.location || '';
                if(!city) return;
                
                const coords = await Universe.geocodeCity(city);
                if(coords) {
                    // DÃ©calage dÃ©terministe basÃ© sur l'ID du profil (fixe, pas alÃ©atoire)
                    const shouldHide = Universe.shouldHideAddress(item);
                    let finalCoords;
                    if(shouldHide) {
                        finalCoords = Universe.getDeterministicOffset(item.id, coords.lat, coords.lng);
                        item._hasApproximateLocation = true;
                    } else {
                        finalCoords = { lat: coords.lat, lng: coords.lng };
                        item._hasApproximateLocation = false;
                    }
                    
                    const marker = Universe.createMapMarker(item, finalCoords);
                    Universe.markersLayer.addLayer(marker);
                }
            }));
            
            // Petit dÃ©lai entre les batches pour respecter les limites API
            if(i + batchSize < limitedItems.length) {
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }
    },
    
    // Mettre Ã  jour le thÃ¨me de la carte
    updateMapTheme: () => {
        if(!Universe.map) return;
        
        const isDark = document.body.classList.contains('dark-mode');
        
        // Supprimer l'ancien layer
        if(Universe.tileLayer) {
            Universe.map.removeLayer(Universe.tileLayer);
        }
        
        // Ajouter le nouveau layer selon le thÃ¨me
        if(isDark) {
            Universe.tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            });
        } else {
            Universe.tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            });
        }
        
        Universe.tileLayer.addTo(Universe.map);
        
        // Mettre Ã  jour le fond du conteneur
        const mapContainer = document.getElementById('universe-map');
        if(mapContainer) {
            mapContainer.style.background = isDark ? '#1a1a2e' : '#f4f6f8';
        }
    },

    // Changer le mode de vue
    setViewMode: (mode) => {
        Universe.viewMode = mode;
        
        const mapBtn = document.getElementById('view-mode-map');
        const fanBtn = document.getElementById('view-mode-fan');
        let mapContainer = document.getElementById('universe-map');
        const scene = document.getElementById('universe-scene');
        
        if(mode === 'map') {
            mapBtn.style.background = 'var(--primary)';
            mapBtn.style.color = 'white';
            mapBtn.style.border = 'none';
            fanBtn.style.background = 'var(--bg)';
            fanBtn.style.color = 'var(--text-main)';
            fanBtn.style.border = '1px solid var(--border)';
            
            // Retirer le contenu fan s'il existe
            const fanContainer = scene.querySelector('.universe-fan-container');
            if(fanContainer) fanContainer.remove();
            
            // RecrÃ©er le conteneur de carte s'il n'existe plus
            if(!mapContainer) {
                mapContainer = document.createElement('div');
                mapContainer.id = 'universe-map';
                scene.insertBefore(mapContainer, scene.firstChild);
                
                // RÃ©initialiser la carte
                Universe.map = null;
                Universe.markersLayer = null;
                Universe.initMap();
            }
            
            mapContainer.style.display = 'block';
            
            // RafraÃ®chir la carte et charger les marqueurs (filtrÃ©s ou non)
            setTimeout(() => {
                if(Universe.map) {
                    Universe.map.invalidateSize();
                    Universe.loadMapMarkers();
                }
            }, 100);
        } else {
            fanBtn.style.background = 'var(--primary)';
            fanBtn.style.color = 'white';
            fanBtn.style.border = 'none';
            mapBtn.style.background = 'var(--bg)';
            mapBtn.style.color = 'var(--text-main)';
            mapBtn.style.border = '1px solid var(--border)';
            
            mapContainer.style.display = 'none';
            Universe.renderFanView(scene);
        }
    },
    
	// DonnÃ©es des rÃ´les par dÃ©partement
    crewRolesByDept: {
        'realisation': ['RÃ©alisateur', '1er Assistant RÃ©alisateur', '2Ã¨me Assistant RÃ©alisateur', 'Scripte', 'Dialoguiste'],
        'image': ['Chef OpÃ©rateur / DOP', 'Cadreur', 'Assistant CamÃ©ra', 'Steadicamer', 'DIT'],
        'lumiere': ['Chef Ã‰lectricien', 'Ã‰lectricien', 'Pupitreur'],
        'machinerie': ['Chef Machiniste', 'Machiniste'],
        'son': ['IngÃ©nieur du Son', 'Perchman', 'Assistant Son'],
        'decoration': ['Chef DÃ©corateur', 'Ensemblier', 'Accessoiriste', 'Peintre', 'Constructeur'],
        'costumes': ['Chef Costumier', 'Costumier', 'Habilleur'],
        'maquillage': ['Chef Maquilleur', 'Maquilleur', 'Coiffeur', 'ProthÃ©siste'],
        'regie': ['Directeur de Production', 'RÃ©gisseur GÃ©nÃ©ral', 'RÃ©gisseur Adjoint', 'Assistant RÃ©gie'],
        'casting': ['Directeur de Casting', 'Assistant Casting'],
        'postprod': ['Monteur', 'Assistant Monteur', 'Ã‰talonneur', 'Mixeur Son', 'Bruiteur', 'Compositeur', 'VFX Artist'],
        'production': ['Producteur', 'Producteur ExÃ©cutif', 'Directeur de Production', 'Comptable de Production']
    },

    // Affiche/masque les filtres selon le type sÃ©lectionnÃ©
    onTypeChange: () => {
        const type = document.getElementById('universe-type').value;
        
        document.getElementById('universe-filters-crew').style.display = 'none';
        document.getElementById('universe-filters-actor').style.display = 'none';
        document.getElementById('universe-filters-project').style.display = 'none';
        document.getElementById('universe-filters-collab').style.display = 'none';
        document.getElementById('universe-filters-production-type').style.display = 'none';
        document.getElementById('universe-filters-association').style.display = 'none';
        document.getElementById('universe-filters-enterprise').style.display = 'none';
        
        // RÃ©initialiser les filtres pour forcer le rechargement par type
        Universe.filteredProfiles = [];
        Universe.filteredProjects = [];
        
        // Mettre Ã  jour l'affichage selon le type sÃ©lectionnÃ©
        if(Universe.viewMode === 'map') {
            Universe.loadMapMarkersInView();
        } else {
            Universe.render();
        }
        
        if(type === 'crew') {
            document.getElementById('universe-filters-crew').style.display = 'flex';
            document.getElementById('universe-filters-collab').style.display = 'flex';
            Universe.populateCrewRoles();
        } else if(type === 'actor') {
            document.getElementById('universe-filters-actor').style.display = 'flex';
            document.getElementById('universe-filters-collab').style.display = 'flex';
        } else if(type === 'project') {
            document.getElementById('universe-filters-project').style.display = 'flex';
            document.getElementById('universe-filters-production-type').style.display = 'flex';
        } else if(type === 'association') {
            document.getElementById('universe-filters-association').style.display = 'flex';
            Universe.populateAssociationTypes();
        } else if(type === 'enterprise') {
            document.getElementById('universe-filters-enterprise').style.display = 'flex';
            Universe.populateEnterpriseTypes();
        }
    },

    // Remplit la liste des fonctions techniciens selon le dÃ©partement
    populateCrewRoles: (dept) => {
        const select = document.getElementById('universe-crew-role');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Fonction --</option>';
        
        let roles = [];
        
        if(dept && Universe.crewRolesByDept[dept]) {
            roles = Universe.crewRolesByDept[dept];
        } else {
            Object.values(Universe.crewRolesByDept).forEach(deptRoles => {
                roles = roles.concat(deptRoles);
            });
            roles = [...new Set(roles)];
        }
        
        roles.sort().forEach(role => {
            const opt = document.createElement('option');
            opt.value = role.toLowerCase();
            opt.textContent = role;
            select.appendChild(opt);
        });
    },

    // Quand on change le dÃ©partement
    onDepartmentChange: () => {
        const dept = document.getElementById('universe-department').value;
        Universe.populateCrewRoles(dept);
    },
    
    // Remplit la liste des types d'associations
    populateAssociationTypes: () => {
        const select = document.getElementById('universe-association-type');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Type d\'association --</option>';
        CONFIG.associationTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type.id;
            opt.textContent = type.name;
            select.appendChild(opt);
        });
    },
    
    // Remplit la liste des types d'entreprises
    populateEnterpriseTypes: () => {
        const select = document.getElementById('universe-enterprise-type');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Type d\'entreprise --</option>';
        CONFIG.enterpriseTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type.id;
            opt.textContent = type.name;
            select.appendChild(opt);
        });
    },
	
    // Initialise l'univers
    init: async () => {
        await Universe.loadAllProfiles();
        Universe.populateDepartments();
        
        // RÃ©initialiser le type Ã  "Tous"
        const typeSelect = document.getElementById('universe-type');
        if(typeSelect) typeSelect.value = '';
        
        // Masquer tous les filtres spÃ©cifiques
        if(document.getElementById('universe-filters-crew')) document.getElementById('universe-filters-crew').style.display = 'none';
        if(document.getElementById('universe-filters-actor')) document.getElementById('universe-filters-actor').style.display = 'none';
        if(document.getElementById('universe-filters-association')) document.getElementById('universe-filters-association').style.display = 'none';
        if(document.getElementById('universe-filters-enterprise')) document.getElementById('universe-filters-enterprise').style.display = 'none';
        if(document.getElementById('universe-filters-project')) document.getElementById('universe-filters-project').style.display = 'none';
        
// Initialiser la carte monde
        Universe.initMap();
        Universe.setViewMode('map');
    },
    
    // Charge tous les profils publics et projets
    loadAllProfiles: async () => {
        Universe.allProfiles = [];
        Universe.allProjects = [];
        
        try {
            // Charger tous les profils publics depuis Supabase
            const { data: profiles, error } = await supabase
                .from('user_profiles')
                .select('*')
                .eq('is_public', true);
            
            if(!error && profiles) {
                profiles.forEach(p => {
                    if(p.name) {
                        const type = p.profile_type || 'crew';
                        const extraData = p.data || {};
                        Universe.allProfiles.push({ 
                            ...p, 
                            ...extraData,
                            type: type,
                            hasVehicle: p.vehicle || false,
                            availabilityText: p.availability || '',
                            profileComplete: true 
                        });
                    }
                });
            }
            
            // Charger les projets publics depuis la table projects
            try {
                const { data: projects, error: projError } = await supabase
                    .from('projects')
                    .select('id, title, data, owner_email')
                    .limit(500);
                
                if(!projError && projects) {
                    projects.forEach(proj => {
                        const d = proj.data || {};
                        if(d.isPublicProject && d.publicProjectData) {
                            const pubData = d.publicProjectData;
                            Universe.allProjects.push({
                                ...pubData,
                                id: proj.id,
                                type: 'project',
                                title: pubData.title || proj.title || 'Sans titre',
                                location: pubData.city || '',
                                ownerEmail: pubData.ownerEmail || proj.owner_email,
                                projectId: proj.id
                            });
                        }
                    });
                    console.log('Projets publics chargÃ©s:', Universe.allProjects.length);
                }
            } catch(e) {
                console.error('Erreur chargement projets publics:', e);
            }
            
            // Stocker mes profils pour le matching
            const myEmail = state.currentUser?.email;
            const myEmailKey = myEmail ? Utils.sanitizeEmail(myEmail) : null;
            const myEmailLower = myEmail ? myEmail.toLowerCase() : null;
            Universe.myProfiles = Universe.allProfiles.filter(p => 
                p.ownerEmail === myEmail || 
                p.ownerEmail === myEmailLower ||
                p.email === myEmail ||
                p.email === myEmailLower ||
                p.id === myEmailKey ||
                (p.id && myEmailKey && p.id.toLowerCase() === myEmailKey.toLowerCase())
            );
            console.log('Mes profils trouvÃ©s:', Universe.myProfiles.length, Universe.myProfiles);
            
            // Initialiser le sÃ©lecteur de profils pour le matching
            MatchingEngine.initProfileSelector();
            
        } catch(e) {
            console.error('Erreur chargement profils:', e);
        }
        
        },
    
    // Remplit le select des dÃ©partements
    populateDepartments: () => {
        const select = document.getElementById('universe-department');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- DÃ©partement --</option>';
        CONFIG.crewGroups.forEach(grp => {
            const opt = document.createElement('option');
            opt.value = grp.id;
            opt.textContent = grp.name;
            select.appendChild(opt);
        });
    },
    
  // Rendu principal
    render: () => {
        const scene = document.getElementById('universe-scene');
        if(!scene) return;
        
        // Si mode carte, mettre Ã  jour les marqueurs
        if(Universe.viewMode === 'map') {
            Universe.loadMapMarkers();
            return;
        }
        
        // Mode fan/liste
        Universe.renderFanView(scene);
    },
    
    // Placeholder pour animationRunning
    animationRunning: false,
    
    // Boucle d'animation
    animate: () => {
        if(!Universe.animationRunning) return;
        
        const scene = document.getElementById('universe-scene');
        if(!scene) return;
        
        const rect = scene.getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;
        const cardWidth = 170;
        const cardHeight = 130;
        
        // Mettre Ã  jour chaque carte
        Universe.cards.forEach(card => {
            // Mouvement
            card.x += card.vx;
            card.y += card.vy;
            card.rotation += card.rotationSpeed;
            
            // Limiter la rotation
            if(card.rotation > 8) { card.rotation = 8; card.rotationSpeed *= -0.5; }
            if(card.rotation < -8) { card.rotation = -8; card.rotationSpeed *= -0.5; }
            
            // Rebond sur les bords
            if(card.x <= 5) { card.x = 5; card.vx *= -0.8; card.rotationSpeed += (Math.random() - 0.5) * 0.1; }
            if(card.x >= width - cardWidth - 5) { card.x = width - cardWidth - 5; card.vx *= -0.8; card.rotationSpeed += (Math.random() - 0.5) * 0.1; }
            if(card.y <= 5) { card.y = 5; card.vy *= -0.8; card.rotationSpeed += (Math.random() - 0.5) * 0.1; }
            if(card.y >= height - cardHeight - 5) { card.y = height - cardHeight - 5; card.vy *= -0.8; card.rotationSpeed += (Math.random() - 0.5) * 0.1; }
            
            // Appliquer la position
            card.el.style.left = card.x + 'px';
            card.el.style.top = card.y + 'px';
            card.el.style.transform = `rotate(${card.rotation}deg)`;
        });
        
        // Collision entre cartes nettes (search-result et main)
        const netCards = Universe.cards.filter(c => !c.isBlurred);
        for(let i = 0; i < netCards.length; i++) {
            for(let j = i + 1; j < netCards.length; j++) {
                Universe.handleCollision(netCards[i], netCards[j]);
            }
        }
        
        // LÃ©gÃ¨re friction pour ralentir progressivement
        Universe.cards.forEach(card => {
            card.vx *= 0.999;
            card.vy *= 0.999;
            
            // Ajouter un peu de mouvement alÃ©atoire pour garder les cartes en mouvement
            if(Math.random() < 0.01) {
                card.vx += (Math.random() - 0.5) * 0.1;
                card.vy += (Math.random() - 0.5) * 0.1;
            }
            
            // Vitesse max (rÃ©duite pour mouvement plus calme)
            const maxSpeed = card.isMain ? 0.5 : 0.8;
            const speed = Math.sqrt(card.vx * card.vx + card.vy * card.vy);
            if(speed > maxSpeed) {
                card.vx = (card.vx / speed) * maxSpeed;
                card.vy = (card.vy / speed) * maxSpeed;
            }
            
            // Vitesse min pour Ã©viter l'arrÃªt complet
            if(speed < 0.05) {
                card.vx += (Math.random() - 0.5) * 0.1;
                card.vy += (Math.random() - 0.5) * 0.1;
            }
        });
        
        requestAnimationFrame(Universe.animate);
    },
    
    // Gestion des collisions entre cartes
    handleCollision: (card1, card2) => {
        const dx = card2.x - card1.x;
        const dy = card2.y - card1.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const minDist = 160;
        
        if(dist < minDist && dist > 0) {
            // Repousser les cartes
            const overlap = minDist - dist;
            const nx = dx / dist;
            const ny = dy / dist;
            
            const pushForce = overlap * 0.15;
            
            if(!card1.isMain) {
                card1.x -= nx * pushForce;
                card1.y -= ny * pushForce;
                card1.vx -= nx * 0.2;
                card1.vy -= ny * 0.2;
            }
            
            if(!card2.isMain) {
                card2.x += nx * pushForce;
                card2.y += ny * pushForce;
                card2.vx += nx * 0.2;
                card2.vy += ny * 0.2;
            }
            
            // Petite rotation lors de la collision
            card1.rotationSpeed += (Math.random() - 0.5) * 0.05;
       card2.rotationSpeed += (Math.random() - 0.5) * 0.2;
        }
    },
    
    // Rendu en mode Ã‰ventail
    renderFanView: (scene) => {
        scene.innerHTML = '';
        scene.style.overflow = 'auto';
        
        const container = document.createElement('div');
        container.className = 'universe-fan-container';
        
        const myEmail = state.currentUser?.email;
        const myEmailKey = myEmail ? Utils.sanitizeEmail(myEmail) : null;
        
        // DÃ©dupliquer les profils par email
        const uniqueProfiles = [];
        const seenEmails = new Set();
        Universe.allProfiles.forEach(p => {
            const key = p.email || p.id;
            if(!seenEmails.has(key)) {
                seenEmails.add(key);
                uniqueProfiles.push(p);
            }
        });
        
        // DÃ©dupliquer les projets par ID
        const uniqueProjects = [];
        const seenProjectIds = new Set();
        Universe.allProjects.forEach(p => {
            const key = p.id || p.projectId;
            if(key && !seenProjectIds.has(key)) {
                seenProjectIds.add(key);
                uniqueProjects.push(p);
            }
        });
        
        // CatÃ©goriser les profils
        const actors = uniqueProfiles.filter(p => p.type === 'actor');
        const crew = uniqueProfiles.filter(p => p.type === 'crew');
        const projects = uniqueProjects;
        
        // Trouver mon profil
        const myProfile = Universe.allProfiles.find(p => p.id === myEmailKey);
        
        // Ma carte en premier (catÃ©gorie spÃ©ciale)
        if(myProfile) {
            const myCategory = Universe.createFanCategory('ðŸ‘¤ Mon Profil', [myProfile], true);
            container.appendChild(myCategory);
        }
        
        // CatÃ©gorie ComÃ©diens
        if(actors.length > 0) {
            const actorCategory = Universe.createFanCategory('ðŸŽ­ ComÃ©diens', actors.slice(0, 15), false);
            container.appendChild(actorCategory);
        }
        
        // CatÃ©gorie Techniciens
        if(crew.length > 0) {
            const crewCategory = Universe.createFanCategory('ðŸŽ¥ Techniciens', crew.slice(0, 15), false);
            container.appendChild(crewCategory);
        }
        
        // CatÃ©gorie Projets
        if(projects.length > 0) {
            const projectCategory = Universe.createFanCategory('ðŸŽ¬ Projets', projects.slice(0, 10), false);
            container.appendChild(projectCategory);
        }
        
        scene.appendChild(container);
    },
    
    // CrÃ©e une catÃ©gorie avec grille de cartes
    createFanCategory: (label, items, isMyProfile) => {
        const category = document.createElement('div');
        category.className = 'fan-category';
        
        // Header avec label et compteur
        const header = document.createElement('div');
        header.className = 'fan-category-header';
        const labelEl = document.createElement('span');
        labelEl.className = 'fan-category-label';
        labelEl.innerHTML = label;
        header.appendChild(labelEl);
        
        if(items.length > 0) {
            const countEl = document.createElement('span');
            countEl.className = 'fan-category-count';
            countEl.textContent = `${items.length} rÃ©sultat${items.length > 1 ? 's' : ''}`;
            header.appendChild(countEl);
        }
        category.appendChild(header);
        
        if(items.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.style.cssText = 'text-align: center; color: var(--text-sec); padding: 40px;';
            emptyMsg.textContent = 'Aucun rÃ©sultat';
            category.appendChild(emptyMsg);
            return category;
        }
        
        // Grille de cartes
        const grid = document.createElement('div');
        grid.className = 'fan-grid';
        
        // Afficher toutes les cartes (max 20)
        const maxCards = Math.min(items.length, 20);
        
        items.slice(0, maxCards).forEach((item) => {
            const card = Universe.createFanCard(item, isMyProfile);
            grid.appendChild(card);
        });
        
        // Message si plus de rÃ©sultats
        if(items.length > maxCards) {
            const moreMsg = document.createElement('div');
            moreMsg.style.cssText = 'text-align: center; color: var(--text-sec); padding: 15px; width: 100%;';
            moreMsg.textContent = `+ ${items.length - maxCards} autres rÃ©sultats. Affinez votre recherche.`;
            grid.appendChild(moreMsg);
        }
        
        category.appendChild(grid);
        
        return category;
    },
    
    // CrÃ©e une carte pour la vue Ã©ventail
    createFanCard: (item, isMain) => {
        const card = document.createElement('div');
        const isProject = item.type === 'project';
        
        card.className = 'fan-card' + (isProject ? ' project-card' : '') + (isMain ? ' main-card' : '');
        card.dataset.profileId = item.id;
        
        if(isProject) {
            const photoHtml = item.image 
                ? `<img src="${item.image}" alt="${Utils.escape(item.title)}" onerror="this.parentElement.innerHTML='ðŸŽ¬'">`
                : 'ðŸŽ¬';
            
            card.innerHTML = `
                <div class="card-photo project-photo">${photoHtml}</div>
                <div class="card-name">${Utils.escape(item.title)}</div>
                <div class="card-role project-type">${item.projectType || 'Projet'}</div>
                ${item.city ? `<div class="card-city">ðŸ“ ${Utils.escape(item.city)}</div>` : ''}
            `;
            card.onclick = () => Universe.openProjectModal(item);
        } else {
            // IcÃ´ne selon le type
            const defaultIcon = item.type === 'actor' ? 'ðŸŽ­' : 
                               item.type === 'crew' ? 'ðŸŽ¥' : 
                               item.type === 'association' ? 'ðŸ›ï¸' : 
                               item.type === 'enterprise' ? 'ðŸ¢' : 'ðŸ‘¤';
            
            const photoHtml = item.photo 
                ? `<img src="${item.photo}" alt="${Utils.escape(item.name)}" onerror="this.parentElement.innerHTML='${defaultIcon}'">`
                : defaultIcon;
            
            // RÃ´le/description selon le type
            let role = '';
            if(item.type === 'actor') {
                role = item.gender === 'homme' ? 'ComÃ©dien' : item.gender === 'femme' ? 'ComÃ©dienne' : 'ComÃ©dienÂ·ne';
            } else if(item.type === 'crew') {
                role = item.role || item.department || 'TechnicienÂ·ne';
            } else if(item.type === 'association') {
                const assoType = CONFIG.associationTypes.find(t => t.id === item.assoType);
                role = assoType ? assoType.name : 'Association';
            } else if(item.type === 'enterprise') {
                const entType = CONFIG.enterpriseTypes.find(t => t.id === item.entType);
                role = entType ? entType.name : 'Entreprise';
            }
            
            // Message si adresse approximative
            const approxMsg = item._hasApproximateLocation ? 
                `<div class="card-approx-location" style="font-size: 0.7rem; color: var(--text-sec); background: var(--bg); padding: 4px 6px; border-radius: 4px; margin-top: 4px;">ðŸ“ Position approximative</div>` : '';
            
            card.innerHTML = `
                <div class="card-photo">${photoHtml}</div>
                <div class="card-name">${Utils.escape(item.name)}</div>
                <div class="card-role">${Utils.escape(role)}</div>
                ${item.city ? `<div class="card-city">ðŸ“ ${Utils.escape(item.city)}</div>` : ''}
                ${approxMsg}
            `;
            card.onclick = () => Universe.showProfileModal(item);
        }
        
        return card;
    },

    // CrÃ©e une carte flottante (profil ou projet)
    createCard: (item, isMain) => {
        const card = document.createElement('div');
        const isProject = item.type === 'project';
        
        card.className = 'floating-card' + (isMain ? ' main-card' : ' blurred') + (isProject ? ' project-card' : '');
        card.dataset.profileId = item.id;
        
        if(isProject) {
            // Carte projet
            const photoHtml = item.image 
                ? `<img src="${item.image}" alt="${Utils.escape(item.title)}" onerror="this.parentElement.innerHTML='ðŸŽ¬'">`
                : 'ðŸŽ¬';
            
            const typeLabels = {
                'court-metrage': 'Court-mÃ©trage',
                'long-metrage': 'Long-mÃ©trage',
                'serie': 'SÃ©rie',
                'documentaire': 'Documentaire',
                'clip': 'Clip',
                'pub': 'PublicitÃ©',
                'corporate': 'Corporate'
            };
            const typeText = typeLabels[item.projectType] || item.projectType || 'Projet';
            
            const actorNeedsCount = (item.actorNeeds || []).length;
            const crewNeedsCount = Object.values(item.crewNeeds || {}).filter(n => n.needed).length + (item.customCrewNeeds || []).length;
            const needsText = [];
            if(actorNeedsCount > 0) needsText.push(`${actorNeedsCount} rÃ´le${actorNeedsCount > 1 ? 's' : ''}`);
            if(crewNeedsCount > 0) needsText.push(`${crewNeedsCount} poste${crewNeedsCount > 1 ? 's' : ''}`);
            
            card.innerHTML = `
                <div class="card-photo project-photo">${photoHtml}</div>
                <div class="card-name">${Utils.escape(item.title || 'Sans titre')}</div>
                <div class="project-type">${Utils.escape(typeText)}</div>
                ${item.city ? `<div class="card-city">ðŸ“ ${Utils.escape(item.city)}</div>` : ''}
                ${needsText.length > 0 ? `<div class="card-needs">ðŸ”Ž ${needsText.join(', ')}</div>` : ''}
            `;
            
            card.onclick = () => Universe.openProjectModal(item);
        } else {
            // Carte profil (acteur, technicien, association ou entreprise)
            const defaultIcon = item.type === 'actor' ? 'ðŸŽ­' : 
                               item.type === 'crew' ? 'ðŸŽ¥' : 
                               item.type === 'association' ? 'ðŸ›ï¸' : 
                               item.type === 'enterprise' ? 'ðŸ¢' : 'ðŸ‘¤';
            
            const photoHtml = item.photo 
                ? `<img src="${item.photo}" alt="${Utils.escape(item.name)}" onerror="this.parentElement.innerHTML='${defaultIcon}'">`
                : defaultIcon;
            
            let roleText = '';
            if(item.type === 'actor') {
                roleText = 'ComÃ©dien.ne';
            } else if(item.type === 'crew') {
                roleText = item.role || 'Technicien.ne';
            } else if(item.type === 'association') {
                const assoType = CONFIG.associationTypes.find(t => t.id === item.assoType);
                roleText = assoType ? assoType.name : 'Association';
            } else if(item.type === 'enterprise') {
                const entType = CONFIG.enterpriseTypes.find(t => t.id === item.entType);
                roleText = entType ? entType.name : 'Entreprise';
            }
            
            card.innerHTML = `
                <div class="card-photo">${photoHtml}</div>
                <div class="card-name">${Utils.escape(item.name)}</div>
                <div class="card-role">${Utils.escape(roleText)}</div>
                ${item.city ? `<div class="card-city">ðŸ“ ${Utils.escape(item.city)}</div>` : ''}
            `;
            
            card.onclick = () => Universe.openProfileModal(item);
        }
        
        return card;
    },
    
    // Recherche
    search: async () => {
        const type = document.getElementById('universe-type').value;
        const city = document.getElementById('universe-city').value.trim().toLowerCase();
        
        // Si on cherche des projets
        if(type === 'project') {
            let results = [...Universe.allProjects];
            
            const projectType = document.getElementById('universe-project-type')?.value;
            const projectGenre = document.getElementById('universe-project-genre')?.value;
            const hasActorNeeds = document.getElementById('universe-project-has-actor-needs')?.checked;
            const hasCrewNeeds = document.getElementById('universe-project-has-crew-needs')?.checked;
            
            if(projectType) {
                results = results.filter(p => p.projectType === projectType);
            }
            if(projectGenre) {
                results = results.filter(p => p.genre === projectGenre);
            }
            if(hasActorNeeds) {
                results = results.filter(p => p.actorNeeds && p.actorNeeds.length > 0);
            }
            if(hasCrewNeeds) {
                results = results.filter(p => {
                    const crewCount = Object.values(p.crewNeeds || {}).filter(n => n.needed).length;
                    const customCount = (p.customCrewNeeds || []).length;
                    return crewCount + customCount > 0;
                });
            }
            if(city) {
                results = results.filter(p => p.city && p.city.toLowerCase().includes(city));
            }
            
            // Filtre type de production
            const productionType = document.getElementById('universe-production-type')?.value;
            if(productionType) {
                results = results.filter(p => p.productionType === productionType);
            }
            
            Universe.filteredProjects = results;
            Universe.filteredProfiles = [];
            Universe.renderSearchResults();
            
            // Toast de rÃ©sultats projets
            const count = results.length;
            if(count === 0) {
                Utils.toast('Aucun projet trouvÃ©', 'warning');
            } else {
                Utils.toast(`${count} projet${count > 1 ? 's' : ''} trouvÃ©${count > 1 ? 's' : ''}`, 'success');
            }
            return;
        }
        
        // Sinon on cherche des profils (comÃ©diens ou techniciens)
        let results = [...Universe.allProfiles];
        
        // Filtrer par type
        if(type) {
            results = results.filter(p => p.type === type || p.accountType === type);
        }
        
        // Filtrer par ville
        if(city) {
            results = results.filter(p => p.city && p.city.toLowerCase().includes(city));
        }
        
        // Filtre vÃ©hicule (commun)
        const hasVehicle = document.getElementById('universe-has-vehicle')?.checked;
        if(hasVehicle) {
            results = results.filter(p => p.hasVehicle === true);
        }
        
        // Filtre type de collaboration (commun acteurs/techniciens)
        const collabType = document.getElementById('universe-collab-type')?.value;
        if(collabType) {
            results = results.filter(p => {
                // collabTypes est un tableau (ex: ['pro', 'semi-pro', 'benevole'])
                if(Array.isArray(p.collabTypes)) {
                    return p.collabTypes.includes(collabType);
                }
                // CompatibilitÃ© ancienne structure (collabType string)
                return p.collabType === collabType;
            });
        }
        
        // Filtre statut professionnel (commun acteurs/techniciens)
        const statusType = document.getElementById('universe-status-type')?.value;
        if(statusType) {
            results = results.filter(p => p.professionalStatus === statusType);
        }
        
        // Filtres techniciens
        if(type === 'crew') {
            const dept = document.getElementById('universe-department')?.value;
            const role = document.getElementById('universe-crew-role')?.value;
            
            if(dept) {
                results = results.filter(p => p.department === dept);
            }
            if(role) {
                results = results.filter(p => p.role && p.role.toLowerCase().includes(role));
            }
        }
        
        // Filtres comÃ©diens
        if(type === 'actor') {
            const gender = document.getElementById('universe-actor-gender')?.value;
            const ageMin = document.getElementById('universe-actor-age-min')?.value;
            const ageMax = document.getElementById('universe-actor-age-max')?.value;
            const heightMin = document.getElementById('universe-actor-height-min')?.value;
            const heightMax = document.getElementById('universe-actor-height-max')?.value;
            const weightMin = document.getElementById('universe-actor-weight-min')?.value;
            const weightMax = document.getElementById('universe-actor-weight-max')?.value;
            const eyes = document.getElementById('universe-actor-eyes')?.value;
            const hair = document.getElementById('universe-actor-hair')?.value;
            const hairLength = document.getElementById('universe-actor-hair-length')?.value;
            const ethnicity = document.getElementById('universe-actor-ethnicity')?.value;
            const corpulence = document.getElementById('universe-actor-corpulence')?.value;
            const sports = document.getElementById('universe-actor-sports')?.value.trim().toLowerCase();
            const languages = document.getElementById('universe-actor-languages')?.value.trim().toLowerCase();
            
            if(gender) results = results.filter(p => p.gender === gender);
            if(ageMin) results = results.filter(p => p.age && parseInt(p.age) >= parseInt(ageMin));
            if(ageMax) results = results.filter(p => p.age && parseInt(p.age) <= parseInt(ageMax));
            if(heightMin) results = results.filter(p => p.height && parseInt(p.height) >= parseInt(heightMin));
            if(heightMax) results = results.filter(p => p.height && parseInt(p.height) <= parseInt(heightMax));
            if(weightMin) results = results.filter(p => p.weight && parseInt(p.weight) >= parseInt(weightMin));
            if(weightMax) results = results.filter(p => p.weight && parseInt(p.weight) <= parseInt(weightMax));
            if(eyes) results = results.filter(p => p.eyeColor === eyes);
            if(hair) results = results.filter(p => p.hairColor === hair);
            if(hairLength) results = results.filter(p => p.hairLength === hairLength);
            if(ethnicity) results = results.filter(p => p.ethnicity === ethnicity);
            if(corpulence) results = results.filter(p => p.corpulence === corpulence);
            if(sports) results = results.filter(p => p.sports && p.sports.toLowerCase().includes(sports));
            if(languages) results = results.filter(p => p.languages && p.languages.toLowerCase().includes(languages));
            
            const bonnet = document.getElementById('universe-actor-bonnet')?.value;
            const bustType = document.getElementById('universe-actor-bust-type')?.value;
            
            if(bonnet) results = results.filter(p => p.bonnet === bonnet);
            if(bustType) results = results.filter(p => p.bustType === bustType);
        }
        
        // Filtres associations
        if(type === 'association') {
            const assoType = document.getElementById('universe-association-type')?.value;
            if(assoType) {
                results = results.filter(p => p.assoType === assoType);
            }
        }
        
        // Filtres entreprises
        if(type === 'enterprise') {
            const entType = document.getElementById('universe-enterprise-type')?.value;
            if(entType) {
                results = results.filter(p => p.entType === entType);
            }
        }
        
        Universe.filteredProfiles = results;
        Universe.filteredProjects = [];
        Universe.renderSearchResults();
        
        // Toast de rÃ©sultats
        const count = results.length;
        if(count === 0) {
            Utils.toast('Aucun rÃ©sultat trouvÃ©', 'warning');
        } else {
            Utils.toast(`${count} profil${count > 1 ? 's' : ''} trouvÃ©${count > 1 ? 's' : ''}`, 'success');
        }
    },
    
    // Affiche les rÃ©sultats de recherche
    renderSearchResults: async () => {
        const scene = document.getElementById('universe-scene');
        if(!scene) return;
        
        // ArrÃªter l'animation prÃ©cÃ©dente
        Universe.animationRunning = false;
        Universe.cards = [];
        
        // Si mode carte, mettre Ã  jour les marqueurs filtrÃ©s
        if(Universe.viewMode === 'map') {
            await Universe.loadFilteredMapMarkers();
            return;
        }
        
        // Sinon afficher en mode Ã©ventail
        scene.innerHTML = '';
        Universe.renderSearchResultsFan(scene);
    },
    
    // Charger les marqueurs filtrÃ©s sur la carte
    loadFilteredMapMarkers: async () => {
        if(!Universe.map || !Universe.markersLayer) return;
        
        Universe.markersLayer.clearLayers();
        Universe.cityPositionCounters = {}; // Reset des compteurs
        
        // Utiliser les rÃ©sultats filtrÃ©s
        const items = [...Universe.filteredProfiles, ...Universe.filteredProjects];
        
        if(items.length === 0) {
            Utils.toast('Aucun rÃ©sultat Ã  afficher sur la carte', 'info');
            return;
        }
        
        for(let i = 0; i < items.length; i += 10) {
            const batch = items.slice(i, i + 10);
            
            await Promise.all(batch.map(async (item) => {
                const city = item.city || item.location || '';
                if(!city) return;
                
const coords = await Universe.geocodeCity(city);
                if(coords) {
                    // DÃ©calage dÃ©terministe basÃ© sur l'ID du profil (fixe, pas alÃ©atoire)
                    const shouldHide = Universe.shouldHideAddress(item);
                    let finalCoords;
                    if(shouldHide) {
                        finalCoords = Universe.getDeterministicOffset(item.id, coords.lat, coords.lng);
                        item._hasApproximateLocation = true;
                    } else {
                        finalCoords = { lat: coords.lat, lng: coords.lng };
                        item._hasApproximateLocation = false;
                    }
                    
                    const marker = Universe.createMapMarker(item, finalCoords);
                    Universe.markersLayer.addLayer(marker);
                }
            }));
            
            if(i + 10 < items.length) {
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }
        
        // Zoomer sur les rÃ©sultats
        if(Universe.markersLayer.getLayers().length > 0) {
            Universe.map.fitBounds(Universe.markersLayer.getBounds(), { padding: [50, 50] });
        }
    },
    
    // Rendu des rÃ©sultats de recherche en mode Ã‰ventail
    renderSearchResultsFan: (scene) => {
        scene.innerHTML = '';
        scene.style.overflow = 'auto';
        
        const container = document.createElement('div');
        container.className = 'universe-fan-container';
        
        // SÃ©parer profils et projets des rÃ©sultats
        const actors = Universe.filteredProfiles.filter(p => p.type === 'actor');
        const crew = Universe.filteredProfiles.filter(p => p.type === 'crew');
        const associations = Universe.filteredProfiles.filter(p => p.type === 'association');
        const enterprises = Universe.filteredProfiles.filter(p => p.type === 'enterprise');
        const projects = Universe.filteredProjects;
        
        // Message si aucun rÃ©sultat
        if(actors.length === 0 && crew.length === 0 && associations.length === 0 && enterprises.length === 0 && projects.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: var(--text-sec);">
                    <div style="font-size: 3rem; margin-bottom: 15px;">ðŸ”</div>
                    <h3>Aucun rÃ©sultat</h3>
                    <p>Essayez avec d'autres critÃ¨res de recherche.</p>
                </div>
            `;
            scene.appendChild(container);
            return;
        }
        
        // CatÃ©gorie ComÃ©diens trouvÃ©s
        if(actors.length > 0) {
            const actorCategory = Universe.createFanCategory(`ðŸŽ­ ComÃ©diens trouvÃ©s`, actors.slice(0, 20), false);
            container.appendChild(actorCategory);
        }
        
        // CatÃ©gorie Techniciens trouvÃ©s
        if(crew.length > 0) {
            const crewCategory = Universe.createFanCategory(`ðŸŽ¥ Techniciens trouvÃ©s`, crew.slice(0, 20), false);
            container.appendChild(crewCategory);
        }
        
        // CatÃ©gorie Associations trouvÃ©es
        if(associations.length > 0) {
            const assoCategory = Universe.createFanCategory(`ðŸ›ï¸ Associations trouvÃ©es`, associations.slice(0, 20), false);
            container.appendChild(assoCategory);
        }
        
        // CatÃ©gorie Entreprises trouvÃ©es
        if(enterprises.length > 0) {
            const entCategory = Universe.createFanCategory(`ðŸ¢ Entreprises trouvÃ©es`, enterprises.slice(0, 20), false);
            container.appendChild(entCategory);
        }
        
        // CatÃ©gorie Projets trouvÃ©s
        if(projects.length > 0) {
            const projectCategory = Universe.createFanCategory(`ðŸŽ¬ Projets trouvÃ©s`, projects.slice(0, 15), false);
            container.appendChild(projectCategory);
        }
        
        scene.appendChild(container);
    },
    
    // Reset la recherche
    reset: () => {
        document.getElementById('universe-type').value = '';
        document.getElementById('universe-department').value = '';
        document.getElementById('universe-city').value = '';
        document.getElementById('universe-distance').value = '500';
        document.getElementById('universe-distance-label').textContent = 'âˆž';
        
        // Reset filtres comÃ©diens
        if(document.getElementById('universe-actor-gender')) document.getElementById('universe-actor-gender').value = '';
        if(document.getElementById('universe-actor-age-min')) document.getElementById('universe-actor-age-min').value = '';
        if(document.getElementById('universe-actor-age-max')) document.getElementById('universe-actor-age-max').value = '';
        if(document.getElementById('universe-actor-height-min')) document.getElementById('universe-actor-height-min').value = '';
        if(document.getElementById('universe-actor-height-max')) document.getElementById('universe-actor-height-max').value = '';
        if(document.getElementById('universe-actor-weight-min')) document.getElementById('universe-actor-weight-min').value = '';
        if(document.getElementById('universe-actor-weight-max')) document.getElementById('universe-actor-weight-max').value = '';
        if(document.getElementById('universe-actor-eyes')) document.getElementById('universe-actor-eyes').value = '';
        if(document.getElementById('universe-actor-hair')) document.getElementById('universe-actor-hair').value = '';
        if(document.getElementById('universe-actor-hair-length')) document.getElementById('universe-actor-hair-length').value = '';
        if(document.getElementById('universe-actor-ethnicity')) document.getElementById('universe-actor-ethnicity').value = '';
        if(document.getElementById('universe-actor-corpulence')) document.getElementById('universe-actor-corpulence').value = '';
        if(document.getElementById('universe-actor-sports')) document.getElementById('universe-actor-sports').value = '';
        if(document.getElementById('universe-actor-languages')) document.getElementById('universe-actor-languages').value = '';
        if(document.getElementById('universe-actor-bonnet')) document.getElementById('universe-actor-bonnet').value = '';
        if(document.getElementById('universe-actor-bust-type')) document.getElementById('universe-actor-bust-type').value = '';
        
        // Reset filtres techniciens
        if(document.getElementById('universe-crew-role')) document.getElementById('universe-crew-role').value = '';
        
        // Reset filtres projets
        if(document.getElementById('universe-project-type')) document.getElementById('universe-project-type').value = '';
        if(document.getElementById('universe-project-genre')) document.getElementById('universe-project-genre').value = '';
        if(document.getElementById('universe-project-has-actor-needs')) document.getElementById('universe-project-has-actor-needs').checked = false;
        if(document.getElementById('universe-project-has-crew-needs')) document.getElementById('universe-project-has-crew-needs').checked = false;
        
        // Reset filtres associations
        if(document.getElementById('universe-association-type')) document.getElementById('universe-association-type').value = '';
        
        // Reset filtres entreprises
        if(document.getElementById('universe-enterprise-type')) document.getElementById('universe-enterprise-type').value = '';
        
        // Masquer les filtres spÃ©cifiques
        document.getElementById('universe-filters-crew').style.display = 'none';
        document.getElementById('universe-filters-actor').style.display = 'none';
        document.getElementById('universe-filters-project').style.display = 'none';
        document.getElementById('universe-filters-association').style.display = 'none';
        document.getElementById('universe-filters-enterprise').style.display = 'none';
        
        Universe.filteredProfiles = [];
        Universe.filteredProjects = [];
        Universe.render();
    },
    
    // Ouvre le modal de profil
	// Ouvre le modal d'un projet
	
	
	
    openProjectModal: (project) => {
        const typeLabels = {
            'court-metrage': 'Court-mÃ©trage',
            'long-metrage': 'Long-mÃ©trage',
            'serie': 'SÃ©rie',
            'documentaire': 'Documentaire',
            'clip': 'Clip',
            'pub': 'PublicitÃ©',
            'corporate': 'Corporate'
        };
        const genreLabels = {
            'drame': 'Drame', 'comedie': 'ComÃ©die', 'thriller': 'Thriller',
            'horreur': 'Horreur', 'sf': 'Science-Fiction', 'fantastique': 'Fantastique',
            'action': 'Action', 'romance': 'Romance', 'animation': 'Animation',
            'experimental': 'ExpÃ©rimental'
        };
        const productionTypeLabels = {
            'pro': 'ðŸŽ¬ Production Professionnelle',
            'semi-pro': 'âš¡ Production Semi-pro',
            'benevole': 'â¤ï¸ Production BÃ©nÃ©vole'
        };
        
        const typeText = typeLabels[project.projectType] || project.projectType || '';
        const genreText = genreLabels[project.genre] || project.genre || '';
        
        // Options de visibilitÃ© (par dÃ©faut tout visible sauf legal)
        const vis = project.visibility || { description: true, team: true, dates: true, casting: true, crew: true, location: true, productionType: true, partners: true, legal: false };
        
        // Localisation
        let locationHtml = '';
        if(vis.location !== false && project.city) {
            locationHtml = `<div class="mb-15-bg">
                <strong>ðŸ“ Localisation :</strong> ${Utils.escape(project.city)}${project.region ? ', ' + Utils.escape(project.region) : ''}${project.country && project.country !== 'France' ? ' (' + Utils.escape(project.country) + ')' : ''}
            </div>`;
        }
        
        // Dates
        let datesHtml = '';
        if(vis.dates !== false && (project.datePreprodStart || project.dateShootingStart || project.dateRelease)) {
            datesHtml = '<div class="mb-15-bg"><strong>ðŸ“… Calendrier :</strong><div style="margin-top: 8px; display: grid; gap: 5px;">';
            if(project.datePreprodStart) datesHtml += `<div>â€¢ PrÃ©-prod : ${project.datePreprodStart}${project.datePreprodEnd ? ' â†’ ' + project.datePreprodEnd : ''}</div>`;
            if(project.dateShootingStart) datesHtml += `<div>â€¢ Tournage : ${project.dateShootingStart}${project.dateShootingEnd ? ' â†’ ' + project.dateShootingEnd : ''}</div>`;
            if(project.datePostprodStart) datesHtml += `<div>â€¢ Post-prod : ${project.datePostprodStart}${project.datePostprodEnd ? ' â†’ ' + project.datePostprodEnd : ''}</div>`;
            if(project.dateRelease) datesHtml += `<div>â€¢ Sortie prÃ©vue : ${project.dateRelease}</div>`;
            datesHtml += '</div></div>';
        }
        
        // Ã‰quipe
        let teamHtml = '';
        if(vis.team !== false && (project.director || project.producer || project.budget || (project.team && project.team.length > 0))) {
            teamHtml = '<div class="mb-15-bg"><strong>ðŸ‘¥ Ã‰quipe :</strong><div style="margin-top: 8px; display: grid; gap: 5px;">';
            if(project.director) teamHtml += `<div>â€¢ RÃ©alisateur : ${Utils.escape(project.director)}</div>`;
            if(project.producer) teamHtml += `<div>â€¢ Producteur : ${Utils.escape(project.producer)}</div>`;
            if(project.team && project.team.length > 0) {
                project.team.forEach(member => {
                    teamHtml += `<div>â€¢ ${Utils.escape(member.role || 'Membre')} : ${Utils.escape(member.name || '')}</div>`;
                });
            }
            if(project.budget) teamHtml += `<div style="margin-top: 8px; font-weight: 600;">ðŸ’° Budget : ${Number(project.budget).toLocaleString('fr-FR')} â‚¬</div>`;
            teamHtml += '</div></div>';
        }
        
        // Type de production
        let productionTypeHtml = '';
        if(vis.productionType !== false && project.productionType) {
            productionTypeHtml = `<div class="mb-15-bg">
                <strong>Type de production :</strong> ${productionTypeLabels[project.productionType] || project.productionType}
            </div>`;
        }
        
        // Partenaires
        let partnersHtml = '';
        if(vis.partners !== false && ((project.associations && project.associations.length > 0) || (project.enterprises && project.enterprises.length > 0))) {
            partnersHtml = '<div class="mb-15-bg"><strong>ðŸ¤ Partenaires :</strong><div class="mt-8">';
            if(project.associations && project.associations.length > 0) {
                partnersHtml += '<div style="margin-bottom: 5px;"><em>Associations :</em> ' + project.associations.map(a => Utils.escape(a.name || a)).join(', ') + '</div>';
            }
            if(project.enterprises && project.enterprises.length > 0) {
                partnersHtml += '<div><em>Entreprises :</em> ' + project.enterprises.map(e => Utils.escape(e.name || e)).join(', ') + '</div>';
            }
            partnersHtml += '</div></div>';
        }
        
        // Description
        let descriptionHtml = '';
        if(vis.description !== false && project.description) {
            descriptionHtml = `<div class="mb-15-bg">
                <strong>ðŸ“ Note d'intention :</strong>
                <div style="margin-top: 8px; color: var(--text-sec); line-height: 1.6; white-space: pre-wrap;">${Utils.escape(project.description)}</div>
            </div>`;
        }
        
        // Besoins comÃ©diens
        let actorNeedsHtml = '';
        if(vis.casting !== false && project.actorNeeds && project.actorNeeds.length > 0) {
            actorNeedsHtml = '<div class="mt-15"><strong>ðŸŽ­ RÃ´les recherchÃ©s :</strong><div class="mt-10">';
            project.actorNeeds.forEach(need => {
                const ageRange = (need.ageMin || need.ageMax) ? ` â€¢ ${need.ageMin || '?'}-${need.ageMax || '?'} ans` : '';
                actorNeedsHtml += `<div style="background: var(--bg); padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                    <strong>${Utils.escape(need.roleName || 'RÃ´le')}</strong> (${need.type || 'principal'})
                    ${need.gender ? ' â€¢ ' + need.gender : ''}${ageRange}
                    ${need.description ? `<div style="font-size: 0.85rem; color: var(--text-sec); margin-top: 5px;">${Utils.escape(need.description)}</div>` : ''}
                </div>`;
            });
            actorNeedsHtml += '</div></div>';
        }
        
        // Besoins techniciens
        let crewNeedsHtml = '';
        const crewNeeded = [];
        if(vis.crew !== false && project.crewNeeds) {
            Object.entries(project.crewNeeds).forEach(([id, need]) => {
                if(need.needed) {
                    const pos = Presentation.crewPositions.find(p => p.id === id);
                    crewNeeded.push(pos ? pos.name : id);
                }
            });
        }
        if(project.customCrewNeeds) {
            project.customCrewNeeds.forEach(c => crewNeeded.push(c.name));
        }
        if(crewNeeded.length > 0) {
            crewNeedsHtml = `<div class="mt-15"><strong>ðŸŽ¬ Postes recherchÃ©s :</strong><div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                ${crewNeeded.map(n => `<span style="background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;">${Utils.escape(n)}</span>`).join('')}
            </div></div>`;
        }
        
        // Stocker le projet courant pour les favoris
        Universe.currentProfile = { ...project, type: 'project', id: project.id || project.projectId };
        const isFav = Universe.isFavorite(project.id || project.projectId, 'project');
        
        const modalHtml = `
            <div class="profile-modal-overlay" onclick="if(event.target === this) this.remove();">
                <div class="profile-modal-box">
                    <div class="profile-modal-header" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; position: relative;">
                        <button class="favorite-btn ${isFav ? 'active' : ''}" id="project-favorite-btn" onclick="app.Universe.toggleProjectFavorite()" style="position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.2); border: none; font-size: 1.5rem; cursor: pointer; padding: 5px 10px; border-radius: 8px; color: ${isFav ? '#f59e0b' : 'white'};" title="Ajouter aux favoris">${isFav ? 'â˜…' : 'â˜†'}</button>
                        <button class="report-btn" onclick="app.Universe.reportProject('${project.id || project.projectId}')" style="position: absolute; top: 15px; left: 60px; background: rgba(255,255,255,0.2); border: none; font-size: 1.2rem; cursor: pointer; padding: 5px 10px; border-radius: 8px; color: white; opacity: 0.7;" title="Signaler ce projet">ðŸš©</button>
                        <button class="profile-modal-close" onclick="this.closest('.profile-modal-overlay').remove()" style="color: white;">âœ•</button>
                        ${project.image ? `<img src="${project.image}" style="width: 150px; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e94560;">` : '<div style="font-size: 4rem; margin-bottom: 15px;">ðŸŽ¬</div>'}
                        <div class="profile-modal-name">${Utils.escape(project.title || 'Sans titre')}</div>
                        <div style="color: #e94560; font-weight: bold;">${Utils.escape(typeText)}${genreText ? ' â€¢ ' + genreText : ''}</div>
                        ${project.city ? `<div style="margin-top: 5px; opacity: 0.8;">ðŸ“ ${Utils.escape(project.city)}${project.region ? ', ' + project.region : ''}</div>` : ''}
                    </div>
                    <div class="profile-modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                        ${locationHtml}
                        ${datesHtml}
                        ${teamHtml}
                        ${productionTypeHtml}
                        ${partnersHtml}
                        ${descriptionHtml}
                        ${actorNeedsHtml}
                        ${crewNeedsHtml}
                        
                        <div class="profile-modal-actions mt-20">
                            <button onclick="app.Universe.contactProject('${project.projectId}', '${Utils.escape(project.title)}', '${Utils.escape(project.ownerEmail)}')" style="flex: 1; padding: 12px; background: #e94560; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">ðŸ“§ Contacter le projet</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    },
    
    // Contacter un projet
    contactProject: async (projectId, projectTitle, ownerEmail) => {
        const subject = await ConfirmModal.prompt(`Objet du message pour "${projectTitle}"`, "Contacter le projet", "Objet...");
        if(!subject) return;
        
        const content = await ConfirmModal.prompt("Ã‰crivez votre message.", "Votre message", "Message...");
        if(!content) return;
        
        try {
            await Messages.send(ownerEmail, { subject: `[Projet] ${projectTitle} - ${subject}`, content: content });
            
            // Envoyer un email de notification
            if(typeof emailjs !== 'undefined' && CONFIG.emailJS.publicKey && CONFIG.emailJS.publicKey !== 'VOTRE_PUBLIC_KEY') {
                const myProfile = await PublicProfile.loadProfile(state.currentUser.uid);
                const myName = Messages.sanitizeForEmail(myProfile?.name || state.currentUser.email || 'Un utilisateur');
                const sanitize = Messages.sanitizeForEmail;
                
                emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, {
                    to_email: sanitize(ownerEmail),
                    name: sanitize(ownerEmail.split('@')[0]) || 'Utilisateur',
                    email: sanitize(ownerEmail),
                    project_title: sanitize(projectTitle) || 'Projet',
                    role: 'Message',
                    inviter_name: myName,
                    message: sanitize(myName + ' vous a contacte concernant votre projet ' + projectTitle + '. Sujet: ' + subject + '. Connectez-vous a Moteur pour lire le message.'),
                    app_url: sanitize(window.location.origin + window.location.pathname)
                }, CONFIG.emailJS.publicKey).catch((e) => console.warn('Email non envoye:', e));
            }
            
            Utils.toast('Message envoyÃ© !', 'success');
            document.querySelector('.profile-modal-overlay')?.remove();
        } catch(e) {
            console.error('Erreur envoi message:', e);
            Utils.toast('Erreur lors de l\'envoi du message.', 'error');
        }
    },
    
    // Toggle favori pour les projets
    toggleProjectFavorite: async () => {
        const project = Universe.currentProfile;
        if(!project || !state.currentUser) return;
        
        const btn = document.getElementById('project-favorite-btn');
        if(!btn) return;
        
        // S'assurer que state.contacts existe
        if(!state.contacts) state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
        if(!state.contacts.projects) state.contacts.projects = [];
        
        const projectId = project.id || project.projectId;
        const ownerEmail = project.ownerEmail || '';
        
        // VÃ©rifier si dÃ©jÃ  en favoris (vÃ©rifier toutes les possibilitÃ©s)
        const existingIndex = state.contacts.projects.findIndex(c => {
            // VÃ©rifier par publicProfileId
            if(c.publicProfileId === projectId) return true;
            // VÃ©rifier par contact_email (peut Ãªtre ownerEmail ou projectId)
            if(c.contact_email === projectId || c.contact_email === ownerEmail) return true;
            // VÃ©rifier dans les notes parsÃ©es
            try {
                const notes = typeof c.notes === 'string' ? JSON.parse(c.notes) : c.notes;
                if(notes && (notes.projectId === projectId || notes.publicProfileId === projectId)) return true;
            } catch(e) {}
            return false;
        });
        
        if(existingIndex >= 0) {
            // Retirer des favoris
            const contactToRemove = state.contacts.projects[existingIndex];
            state.contacts.projects.splice(existingIndex, 1);
            await supabase.from('contacts').delete().eq('id', contactToRemove.id);
            btn.textContent = 'â˜†';
            btn.style.color = 'white';
            btn.classList.remove('active');
            Utils.toast('Projet retirÃ© des favoris', 'info');
        } else {
            // Ajouter aux favoris (utiliser projectId comme contact_email pour garantir l'unicitÃ©)
            const contactData = {
                owner_email: state.currentUser.email.toLowerCase(),
                contact_email: projectId || '',
                contact_type: 'project',
                name: project.title || 'Sans titre',
                notes: JSON.stringify({ 
                    publicProfileId: projectId,
                    projectId: projectId,
                    title: project.title,
                    type: 'project',
                    city: project.city,
                    projectType: project.projectType,
                    genre: project.genre,
                    ownerEmail: project.ownerEmail
                }),
                created_at: new Date().toISOString()
            };
            // Utiliser upsert pour Ã©viter les doublons (basÃ© sur owner_email + contact_email)
            const { data: newContact, error } = await supabase
                .from('contacts')
                .upsert(contactData, { onConflict: 'owner_email,contact_email' })
                .select()
                .single();
            if(error) {
                console.error('Erreur ajout favori:', error);
                // Si erreur de conflit, le favori existe dÃ©jÃ  - on le considÃ¨re comme ajoutÃ©
                if(error.code === '23505') {
                    btn.textContent = 'â˜…';
                    btn.style.color = '#f59e0b';
                    btn.classList.add('active');
                    Utils.toast('Projet dÃ©jÃ  dans vos favoris !', 'info');
                    return;
                }
                Utils.toast('Erreur lors de l\'ajout aux favoris', 'error');
                return;
            }
            if(newContact) {
                state.contacts.projects.push({ 
                    ...project, 
                    id: newContact.id, 
                    publicProfileId: projectId,
                    type: 'project'
                });
            }
            btn.textContent = 'â˜…';
            btn.style.color = '#f59e0b';
            btn.classList.add('active');
            Utils.toast('Projet ajoutÃ© aux favoris !', 'success');
        }
    },
    
    reportProfile: async () => {
        const profile = Universe.currentProfile;
        if(!profile || !state.currentUser) {
            Utils.toast('Vous devez Ãªtre connectÃ© pour signaler', 'warning');
            return;
        }
        
        const reasons = [
            { id: 'fake', label: 'ðŸ‘¤ Faux profil / Usurpation d\'identitÃ©' },
            { id: 'inappropriate', label: 'ðŸš« Contenu inappropriÃ©' },
            { id: 'spam', label: 'ðŸ“§ Spam / PublicitÃ©' },
            { id: 'harassment', label: 'âš ï¸ HarcÃ¨lement' },
            { id: 'other', label: 'â“ Autre raison' }
        ];
        
        const reasonHtml = reasons.map(r => `<option value="${r.id}">${r.label}</option>`).join('');
        
        const result = await ConfirmModal.show({
            title: 'ðŸš© Signaler ce profil',
            message: `
                <p class="mb-15">Vous Ãªtes sur le point de signaler le profil <strong>${Utils.escape(profile.name || 'Sans nom')}</strong>.</p>
                <label class="label-bold-block-5">Motif du signalement :</label>
                <select id="report-reason" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px;">
                    ${reasonHtml}
                </select>
                <label class="label-bold-block-5">DÃ©tails (optionnel) :</label>
                <textarea id="report-details" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; min-height: 80px;" placeholder="DÃ©crivez le problÃ¨me..."></textarea>
            `,
            confirmText: 'Envoyer le signalement',
            icon: 'ðŸš©'
        });
        
        if(result) {
            const reason = document.getElementById('report-reason')?.value || 'other';
            const details = document.getElementById('report-details')?.value || '';
            
            const { error } = await supabase.from('reports').insert({
                reporter_email: state.currentUser.email.toLowerCase(),
                reported_type: profile.type || 'profile',
                reported_id: profile.id || profile.publicProfileId,
                reported_name: profile.name || 'Sans nom',
                reported_email: profile.email || '',
                reason: reason,
                details: details,
                status: 'pending',
                created_at: new Date().toISOString()
            });
            
            if(error) {
                console.error('Erreur signalement:', error);
                Utils.toast('Erreur lors du signalement', 'error');
            } else {
                Utils.toast('Signalement envoyÃ©. Merci !', 'success');
            }
        }
    },
    
    reportProject: async (projectId) => {
        const project = Universe.currentProfile;
        if(!state.currentUser) {
            Utils.toast('Vous devez Ãªtre connectÃ© pour signaler', 'warning');
            return;
        }
        
        const reasons = [
            { id: 'fake', label: 'ðŸŽ¬ Faux projet / Arnaque' },
            { id: 'inappropriate', label: 'ðŸš« Contenu inappropriÃ©' },
            { id: 'spam', label: 'ðŸ“§ Spam / PublicitÃ©' },
            { id: 'scam', label: 'ðŸ’° Tentative d\'escroquerie' },
            { id: 'other', label: 'â“ Autre raison' }
        ];
        
        const reasonHtml = reasons.map(r => `<option value="${r.id}">${r.label}</option>`).join('');
        
        const result = await ConfirmModal.show({
            title: 'ðŸš© Signaler ce projet',
            message: `
                <p class="mb-15">Vous Ãªtes sur le point de signaler le projet <strong>${Utils.escape(project?.title || 'Sans titre')}</strong>.</p>
                <label class="label-bold-block-5">Motif du signalement :</label>
                <select id="report-reason" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px;">
                    ${reasonHtml}
                </select>
                <label class="label-bold-block-5">DÃ©tails (optionnel) :</label>
                <textarea id="report-details" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; min-height: 80px;" placeholder="DÃ©crivez le problÃ¨me..."></textarea>
            `,
            confirmText: 'Envoyer le signalement',
            icon: 'ðŸš©'
        });
        
        if(result) {
            const reason = document.getElementById('report-reason')?.value || 'other';
            const details = document.getElementById('report-details')?.value || '';
            
            const { error } = await supabase.from('reports').insert({
                reporter_email: state.currentUser.email.toLowerCase(),
                reported_type: 'project',
                reported_id: projectId || project?.projectId || project?.id,
                reported_name: project?.title || 'Sans titre',
                reported_email: project?.ownerEmail || '',
                reason: reason,
                details: details,
                status: 'pending',
                created_at: new Date().toISOString()
            });
            
            if(error) {
                console.error('Erreur signalement:', error);
                Utils.toast('Erreur lors du signalement', 'error');
            } else {
                Utils.toast('Signalement envoyÃ©. Merci !', 'success');
            }
        }
    },
	
    // VÃ©rifie si une section est visible selon le contexte (public ou projet)
    isSectionVisible: (profile, section, context = 'public') => {
        if(!profile) return true;
        const hiddenArray = context === 'public' ? (profile.hiddenPublic || []) : (profile.hiddenProject || []);
        return !hiddenArray.includes(section);
    },
    
    openProfileModal: async (profile) => {
        // DÃ©terminer le type
        const isProject = profile.type === 'project';
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        // Charger les donnÃ©es complÃ¨tes depuis Supabase si nÃ©cessaire
        let fullProfile = profile;
        if(!isProject) {
            try {
                const { data: profileData } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', profile.id)
                    .single();
                
                if(profileData) {
                    // Extraire les donnÃ©es du champ JSONB
                    const extraData = profileData.data || {};
                    fullProfile = { 
                        ...profileData, 
                        ...extraData,
                        id: profile.id, 
                        type: profileData.profile_type || profile.type,
                        hasVehicle: profileData.vehicle || false,
                        availabilityText: profileData.availability || ''
                    };
                }
            } catch(e) { console.warn('Erreur chargement profil:', e); }
        }
        
        Universe.currentProfile = fullProfile;
        
        // Photo
        const photoEl = document.getElementById('pm-photo');
        const photo = fullProfile.photo || fullProfile.photoURL || fullProfile.mainPhoto || fullProfile.poster || null;
        let defaultIcon = 'ðŸ‘¤';
        if(isProject) defaultIcon = 'ðŸŽ¬';
        else if(isActor) defaultIcon = 'ðŸŽ­';
        else if(isCrew) defaultIcon = 'ðŸŽ¥';
        else if(isAssociation) defaultIcon = 'ðŸ›ï¸';
        else if(isEnterprise) defaultIcon = 'ðŸ¢';
        
        if(photo) {
            photoEl.innerHTML = `<img src="${photo}" alt="${Utils.escape(fullProfile.name || fullProfile.title || '')}" onerror="this.parentElement.innerHTML='${defaultIcon}'">`;
        } else {
            photoEl.innerHTML = defaultIcon;
        }
        
        // Nom
        const name = fullProfile.name || fullProfile.displayName || fullProfile.title || fullProfile.assoName || fullProfile.entName || 'Sans nom';
        document.getElementById('pm-name').textContent = name;
        
        // RÃ´le / Type - chercher dans data si pas trouvÃ© directement
        const extraData = fullProfile.data || {};
        let roleText = '';
        if(isProject) roleText = fullProfile.projectType || 'Projet';
        else if(isActor) roleText = fullProfile.role || extraData.role || 'ComÃ©dienÂ·ne';
        else if(isCrew) roleText = fullProfile.role || extraData.role || extraData.department || 'TechnicienÂ·ne';
        else if(isAssociation) roleText = fullProfile.assoType || extraData.assoType || 'Association';
        else if(isEnterprise) roleText = fullProfile.entType || extraData.entType || 'Entreprise';
        document.getElementById('pm-role').textContent = roleText;
        
        // Ville
        const city = fullProfile.city || fullProfile.location || '';
        document.getElementById('pm-city').textContent = city ? 'ðŸ“ ' + city : '';
        
        // Galerie photos (vÃ©rifier visibilitÃ©)
        let galleryHtml = '';
        const gallerySection = fullProfile.type === 'crew' ? 'crew-gallery' : 'gallery';
        const photos = fullProfile.galleryPhotos || fullProfile.crewGalleryPhotos || fullProfile.gallery || fullProfile.photos || [];
        if(photos.length > 0 && Universe.isSectionVisible(fullProfile, gallerySection, 'public')) {
            galleryHtml = '<div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;">';
            photos.slice(0, 5).forEach(url => {
                if(url) {
                    galleryHtml += `<div style="width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                        <img src="${url}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="window.open('${url}', '_blank')" onerror="this.parentElement.style.display='none'">
                    </div>`;
                }
            });
            galleryHtml += '</div>';
        }
        
        // Bio / Description
        const bioSection = document.getElementById('pm-bio-section');
        const bioEl = document.getElementById('pm-bio');
        const bioText = fullProfile.bio || fullProfile.description || fullProfile.synopsis || '';
        if(bioText || galleryHtml) {
            bioSection.style.display = 'block';
            bioEl.innerHTML = galleryHtml + (bioText ? '<p>' + Utils.escape(bioText) + '</p>' : '');
        } else {
            bioSection.style.display = 'none';
        }
        
        // Infos selon le type
        const infoEl = document.getElementById('pm-info');
        let infoHtml = '';
        
        if(isActor) {
            // Section IdentitÃ© (toujours visible sauf si cachÃ©e)
            if(fullProfile.gender && Universe.isSectionVisible(fullProfile, 'identity', 'public')) infoHtml += `<div class="profile-modal-info-item"><label>Genre</label><span>${fullProfile.gender}</span></div>`;
            
            // Section Description Physique
            if(Universe.isSectionVisible(fullProfile, 'physical', 'public')) {
                if(fullProfile.age) infoHtml += `<div class="profile-modal-info-item"><label>Ã‚ge</label><span>${fullProfile.age} ans</span></div>`;
                if(fullProfile.height) infoHtml += `<div class="profile-modal-info-item"><label>Taille</label><span>${fullProfile.height} cm</span></div>`;
                if(fullProfile.weight) infoHtml += `<div class="profile-modal-info-item"><label>Poids</label><span>${fullProfile.weight} kg</span></div>`;
                if(fullProfile.eyeColor) infoHtml += `<div class="profile-modal-info-item"><label>Yeux</label><span>${fullProfile.eyeColor}</span></div>`;
                if(fullProfile.hairColor) infoHtml += `<div class="profile-modal-info-item"><label>Cheveux</label><span>${fullProfile.hairColor}${fullProfile.hairLength ? ' (' + fullProfile.hairLength + ')' : ''}</span></div>`;
                if(fullProfile.corpulence) infoHtml += `<div class="profile-modal-info-item"><label>Corpulence</label><span>${fullProfile.corpulence}</span></div>`;
                if(fullProfile.bonnet || fullProfile.bustSize) infoHtml += `<div class="profile-modal-info-item"><label>Poitrine</label><span>${fullProfile.bonnet ? 'Bonnet ' + fullProfile.bonnet : ''}${fullProfile.bustSize ? ' (' + fullProfile.bustSize + ' cm)' : ''}${fullProfile.bustType ? ' - ' + fullProfile.bustType : ''}</span></div>`;
                if(fullProfile.ethnicity) infoHtml += `<div class="profile-modal-info-item"><label>Origine</label><span>${fullProfile.ethnicity}</span></div>`;
            }
            if(fullProfile.languages) infoHtml += `<div class="profile-modal-info-item"><label>Langues</label><span>${fullProfile.languages}</span></div>`;
            if(fullProfile.sports) infoHtml += `<div class="profile-modal-info-item"><label>Sports</label><span>${fullProfile.sports}</span></div>`;
            
            // Section Tarif
            if(Universe.isSectionVisible(fullProfile, 'tarif', 'public')) {
                if(fullProfile.dailyRate) infoHtml += `<div class="profile-modal-info-item"><label>Tarif</label><span>${fullProfile.dailyRate} ${fullProfile.rateCurrency || 'â‚¬'}/${fullProfile.rateType || 'Jour'}</span></div>`;
            }
            
            // Section VÃ©hicule
            if(Universe.isSectionVisible(fullProfile, 'vehicle', 'public')) {
                if(fullProfile.hasVehicle) infoHtml += `<div class="profile-modal-info-item"><label>VÃ©hicule</label><span>ðŸš— ${fullProfile.vehicleType || 'Oui'}${fullProfile.vehicleSeats ? ' (' + fullProfile.vehicleSeats + ' places)' : ''}</span></div>`;
            }
        } else if(isCrew) {
            // Section IdentitÃ©
            if(Universe.isSectionVisible(fullProfile, 'identity', 'public')) {
                if(fullProfile.gender) infoHtml += `<div class="profile-modal-info-item"><label>Genre</label><span>${fullProfile.gender}</span></div>`;
            }
            
            // Section MÃ©tier & CompÃ©tences
            if(Universe.isSectionVisible(fullProfile, 'skills', 'public')) {
                if(fullProfile.department) {
                    const deptName = CONFIG.crewGroups.find(g => g.id === fullProfile.department)?.name || fullProfile.department;
                    infoHtml += `<div class="profile-modal-info-item"><label>DÃ©partement</label><span>${deptName}</span></div>`;
                }
                if(fullProfile.experience) infoHtml += `<div class="profile-modal-info-item"><label>ExpÃ©rience</label><span>${fullProfile.experience}</span></div>`;
            }
            
            // Section Tarif
            if(Universe.isSectionVisible(fullProfile, 'tarif', 'public')) {
                if(fullProfile.dailyRate) infoHtml += `<div class="profile-modal-info-item"><label>Tarif</label><span>${fullProfile.dailyRate} ${fullProfile.rateCurrency || 'â‚¬'}/${fullProfile.rateType || 'Jour'}</span></div>`;
            }
            
            // Section VÃ©hicule
            if(Universe.isSectionVisible(fullProfile, 'vehicle', 'public')) {
                if(fullProfile.hasVehicle) infoHtml += `<div class="profile-modal-info-item"><label>VÃ©hicule</label><span>ðŸš— ${fullProfile.vehicleType || 'Oui'}${fullProfile.vehicleSeats ? ' (' + fullProfile.vehicleSeats + ' places)' : ''}</span></div>`;
            }
        } else if(isProject) {
            if(fullProfile.genre) infoHtml += `<div class="profile-modal-info-item"><label>Genre</label><span>${fullProfile.genre}</span></div>`;
            if(fullProfile.director) infoHtml += `<div class="profile-modal-info-item"><label>RÃ©alisateur</label><span>${fullProfile.director}</span></div>`;
            if(fullProfile.producer) infoHtml += `<div class="profile-modal-info-item"><label>Producteur</label><span>${fullProfile.producer}</span></div>`;
            if(fullProfile.status) infoHtml += `<div class="profile-modal-info-item"><label>Statut</label><span>${fullProfile.status}</span></div>`;
        } else if(isAssociation || isEnterprise) {
            if(fullProfile.siret) infoHtml += `<div class="profile-modal-info-item"><label>SIRET</label><span>${fullProfile.siret}</span></div>`;
            if(fullProfile.services) infoHtml += `<div class="profile-modal-info-item col-span-2"><label>Services</label><span>${fullProfile.services}</span></div>`;
        }
        
        if(fullProfile.availabilityText) infoHtml += `<div class="profile-modal-info-item col-span-2"><label>DisponibilitÃ©</label><span>${fullProfile.availabilityText}</span></div>`;
        
        infoEl.innerHTML = infoHtml || '<p class="text-sec">Pas d\'informations supplÃ©mentaires</p>';
        
        // Contact (vÃ©rifier visibilitÃ© de la section identitÃ©)
        const contactEl = document.getElementById('pm-contact');
        let contactHtml = '';
        if(Universe.isSectionVisible(fullProfile, 'identity', 'public')) {
            const email = fullProfile.email || fullProfile.ownerEmail || '';
            const phone = fullProfile.phone || '';
            const website = fullProfile.website || '';
            if(email) contactHtml += `<div class="profile-modal-info-item"><label>Email</label><span>${email}</span></div>`;
            if(phone) contactHtml += `<div class="profile-modal-info-item"><label>TÃ©lÃ©phone</label><span>${phone}</span></div>`;
            if(website) contactHtml += `<div class="profile-modal-info-item col-span-2"><label>Site web</label><span><a href="${website}" target="_blank">${website}</a></span></div>`;
        }
        contactEl.innerHTML = contactHtml || '<p class="text-sec">Pas de contact public</p>';
        
        // Dates de tournage prÃ©vues
        const shootingSection = document.getElementById('pm-shooting-section');
        const shootingEl = document.getElementById('pm-shooting-dates');
        const shootingDates = fullProfile.shootingDates || [];
        
        // Filtrer les dates futures uniquement
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const futureDates = shootingDates.filter(sd => new Date(sd.date) >= today).sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if(futureDates.length > 0) {
            shootingSection.style.display = 'block';
            let shootingHtml = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            futureDates.slice(0, 5).forEach(sd => {
                const dateObj = new Date(sd.date);
                const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
                shootingHtml += `<div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; border-radius: 6px;">
                    <span style="font-size: 1.2rem;">ðŸŽ¬</span>
                    <div class="flex-1">
                        <div class="fw-bold">${dateStr}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">${Utils.escape(sd.projectName || 'Projet')}${sd.location ? ' - ' + Utils.escape(sd.location) : ''}</div>
                    </div>
                    ${sd.callTime ? `<div class="fs-085">â° ${sd.callTime}</div>` : ''}
                </div>`;
            });
            if(futureDates.length > 5) {
                shootingHtml += `<div style="text-align: center; color: var(--text-sec); font-size: 0.85rem;">+ ${futureDates.length - 5} autre(s) date(s)...</div>`;
            }
            shootingHtml += '</div>';
            shootingEl.innerHTML = shootingHtml;
        } else {
            shootingSection.style.display = 'none';
            shootingEl.innerHTML = '';
        }
        
        // Bande DÃ©mo (vÃ©rifier visibilitÃ©)
        const demoreelSection = document.getElementById('pm-demoreel-section');
        const demoreelEl = document.getElementById('pm-demoreel');
        const demoreelSectionKey = fullProfile.type === 'crew' ? 'crew-demoreel' : 'demoreel';
        if(fullProfile.demoreel && Universe.isSectionVisible(fullProfile, demoreelSectionKey, 'public')) {
            demoreelSection.style.display = 'block';
            const embedUrl = ProfileRenderer.getEmbedUrl(fullProfile.demoreel);
            demoreelEl.innerHTML = `<iframe src="${embedUrl}" width="100%" height="250" frameborder="0" allowfullscreen class="br-8"></iframe>`;
        } else {
            demoreelSection.style.display = 'none';
            demoreelEl.innerHTML = '';
        }
        
        // ActualitÃ© du profil (derniÃ¨re publication du jour)
        const actualiteSection = document.getElementById('pm-actualite-section');
        const actualiteEl = document.getElementById('pm-actualite');
        try {
            const { data: actualites } = await supabase
                .from('profile_actualites')
                .select('*')
                .eq('author_email', fullProfile.email)
                .order('created_at', { ascending: false })
                .limit(5);
            
            if(actualites && actualites.length > 0) {
                actualiteSection.style.display = 'block';
                actualiteEl.innerHTML = actualites.map(a => `
                    <div style="display: inline-block; min-width: 250px; max-width: 300px; padding: 15px; margin-right: 10px; background: var(--bg); border-radius: 10px; border: 1px solid var(--border); white-space: normal; vertical-align: top;">
                        <div style="font-size: 0.8rem; color: var(--text-sec); margin-bottom: 8px;">${Utils.timeAgo(a.created_at)}</div>
                        <div style="font-size: 0.95rem;">${a.content}</div>
                        ${a.image ? `<img src="${a.image}" style="width: 100%; border-radius: 6px; margin-top: 10px;">` : ''}
                    </div>
                `).join('');
            } else {
                actualiteSection.style.display = 'none';
            }
        } catch(e) {
            actualiteSection.style.display = 'none';
        }
        
        document.getElementById('profile-modal-overlay').style.display = 'flex';
        Universe.updateFavoriteButton();
    },
    
    // Ferme le modal
    closeProfileModal: () => {
        document.getElementById('profile-modal-overlay').style.display = 'none';
        Universe.currentProfile = null;
    },
    
    // Export PDF du profil
    exportProfilePDF: async () => {
        const profile = Universe.currentProfile;
        if(!profile) return;
        
        Utils.toast('GÃ©nÃ©ration du PDF en cours...', 'info');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = 0;
        
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        
        const name = profile.name || profile.displayName || profile.assoName || profile.entName || 'Sans nom';
        const extraData = profile.data || {};
        let roleText = '';
        if(isActor) roleText = profile.role || extraData.role || 'ComÃ©dienÂ·ne';
        else if(isCrew) roleText = profile.role || extraData.role || extraData.department || 'TechnicienÂ·ne';
        else if(isAssociation) roleText = profile.assoType || extraData.assoType || 'Association';
        else if(isEnterprise) roleText = profile.entType || extraData.entType || 'Entreprise';
        const city = profile.city || profile.location || '';
        const photoUrl = profile.photo || profile.photoURL || profile.mainPhoto || null;
        
        // ===== HELPER : Charger image en base64 =====
        const loadImg = (url) => new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                try {
                    const c = document.createElement('canvas');
                    c.width = img.naturalWidth; c.height = img.naturalHeight;
                    c.getContext('2d').drawImage(img, 0, 0);
                    resolve(c.toDataURL('image/jpeg', 0.85));
                } catch(e) { resolve(null); }
            };
            img.onerror = () => resolve(null);
            setTimeout(() => resolve(null), 5000);
            img.src = url;
        });
        
        // ===== HELPER : Section colorÃ©e =====
        const addSection = (title, rgb) => {
            if(y > pageHeight - 30) { doc.addPage(); y = margin; }
            doc.setFillColor(rgb[0], rgb[1], rgb[2]);
            doc.roundedRect(margin, y, pageWidth - margin * 2, 9, 1.5, 1.5, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(title, margin + 5, y + 6.5);
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            y += 14;
        };
        
        // ===== HELPER : Ligne label/valeur =====
        const addInfo = (label, value, opts) => {
            if(!value) return;
            if(y > pageHeight - 15) { doc.addPage(); y = margin; }
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(120, 120, 120);
            doc.text(label, margin + 3, y);
            doc.setFont('helvetica', 'normal');
            if(opts && opts.color) doc.setTextColor(opts.color[0], opts.color[1], opts.color[2]);
            else doc.setTextColor(50, 50, 50);
            const val = String(value);
            if(val.length > 55) {
                const lines = doc.splitTextToSize(val, pageWidth - margin - 50);
                doc.text(lines, margin + 45, y);
                y += lines.length * 4.5 + 2;
            } else {
                doc.text(val, margin + 45, y);
                y += 6;
            }
        };
        
        // ===== HEADER BLEU =====
        doc.setFillColor(43, 110, 246);
        doc.rect(0, 0, pageWidth, 55, 'F');
        doc.setFillColor(30, 85, 210);
        doc.rect(0, 50, pageWidth, 5, 'F');
        
        // Photo de profil
        let photoLoaded = false;
        if(photoUrl) {
            try {
                const imgData = await loadImg(photoUrl);
                if(imgData) {
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(margin + 1, 9, 32, 37, 3, 3, 'F');
                    doc.addImage(imgData, 'JPEG', margin + 2, 10, 30, 35);
                    photoLoaded = true;
                }
            } catch(e) {}
        }
        
        const textX = photoLoaded ? margin + 40 : pageWidth / 2;
        const textAlign = photoLoaded ? { align: 'left' } : { align: 'center' };
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text(name.length > 30 ? name.substring(0, 30) + '...' : name, textX, 24, textAlign);
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(200, 220, 255);
        doc.text(roleText, textX, 33, textAlign);
        
        if(city) {
            doc.setFontSize(10);
            doc.setTextColor(170, 200, 255);
            doc.text(city, textX, 42, textAlign);
        }
        
        y = 65;
        
        // ===== BIO / DESCRIPTION =====
        const bio = profile.bio || profile.description || profile.assoMission || profile.entDescription || '';
        if(bio) {
            addSection(isAssociation ? 'MISSION' : isEnterprise ? 'DESCRIPTION' : 'BIOGRAPHIE', [43, 110, 246]);
            doc.setFontSize(9.5);
            doc.setTextColor(60, 60, 60);
            const bioLines = doc.splitTextToSize(bio, pageWidth - margin * 2 - 6);
            bioLines.forEach(line => {
                if(y > pageHeight - 15) { doc.addPage(); y = margin; }
                doc.text(line, margin + 3, y);
                y += 4.8;
            });
            y += 6;
        }
        
        // ===== INFOS COMÃ‰DIEN =====
        if(isActor) {
            const hasPhysical = profile.gender || profile.age || profile.height || profile.weight || profile.eyeColor || profile.hairColor || profile.corpulence || profile.ethnicity;
            if(hasPhysical) {
                addSection('DESCRIPTION PHYSIQUE', [76, 175, 80]);
                addInfo('Genre', profile.gender);
                addInfo('Ã‚ge', profile.age ? profile.age + ' ans' : '');
                addInfo('Taille', profile.height ? profile.height + ' cm' : '');
                addInfo('Poids', profile.weight ? profile.weight + ' kg' : '');
                addInfo('Yeux', profile.eyeColor);
                addInfo('Cheveux', profile.hairColor ? profile.hairColor + (profile.hairLength ? ' (' + profile.hairLength + ')' : '') : '');
                addInfo('Corpulence', profile.corpulence);
                addInfo('Origine', profile.ethnicity);
                y += 4;
            }
            if(profile.languages || profile.sports) {
                addSection('COMPÃ‰TENCES', [156, 39, 176]);
                addInfo('Langues', profile.languages);
                addInfo('Sports', profile.sports);
                y += 4;
            }
        }
        
        // ===== INFOS TECHNICIEN =====
        if(isCrew) {
            addSection('COMPÃ‰TENCES & MÃ‰TIER', [76, 175, 80]);
            if(profile.department) {
                const deptName = CONFIG.crewGroups.find(g => g.id === profile.department)?.name || profile.department;
                addInfo('DÃ©partement', deptName);
            }
            addInfo('ExpÃ©rience', profile.experience);
            if(profile.equipment && profile.equipment.length > 0) {
                addInfo('MatÃ©riel', profile.equipment.join(', '));
            }
            y += 4;
        }
        
        // ===== INFOS ASSOCIATION =====
        if(isAssociation) {
            addSection('INFORMATIONS', [76, 175, 80]);
            addInfo('Type', profile.assoType);
            addInfo('SIRET', profile.siret);
            addInfo('Services', profile.services);
            y += 4;
        }
        
        // ===== INFOS ENTREPRISE =====
        if(isEnterprise) {
            addSection('INFORMATIONS', [76, 175, 80]);
            addInfo('Type', profile.entType);
            addInfo('SIRET', profile.siret);
            addInfo('Services', profile.services);
            y += 4;
        }
        
        // ===== TARIF & DISPONIBILITÃ‰ =====
        if(profile.dailyRate || profile.availabilityText || profile.hasVehicle) {
            addSection('TARIF & DISPONIBILITÃ‰', [255, 152, 0]);
            addInfo('Tarif', profile.dailyRate ? profile.dailyRate + ' ' + (profile.rateCurrency || 'â‚¬') + ' / ' + (profile.rateType || 'Jour') : '');
            addInfo('DisponibilitÃ©', profile.availabilityText);
            if(profile.hasVehicle) addInfo('VÃ©hicule', (profile.vehicleType || 'Oui') + (profile.vehicleSeats ? ' (' + profile.vehicleSeats + ' places)' : ''));
            y += 4;
        }
        
        // ===== CONTACT =====
        const email = profile.email || profile.ownerEmail || '';
        const phone = profile.phone || '';
        const website = profile.website || '';
        const demoreel = profile.demoreel || '';
        if(email || phone || website || demoreel) {
            addSection('CONTACT', [96, 125, 139]);
            addInfo('Email', email, { color: [43, 110, 246] });
            addInfo('TÃ©lÃ©phone', phone);
            addInfo('Site web', website, { color: [43, 110, 246] });
            addInfo('Bande dÃ©mo', demoreel, { color: [43, 110, 246] });
            y += 4;
        }
        
        // ===== GALERIE PHOTOS =====
        const galleryPhotos = profile.galleryPhotos || profile.crewGalleryPhotos || [];
        if(galleryPhotos.length > 0) {
            addSection('GALERIE', [233, 30, 99]);
            let photoX = margin + 3;
            for(const url of galleryPhotos.slice(0, 3)) {
                if(!url) continue;
                try {
                    const imgData = await loadImg(url);
                    if(imgData) {
                        if(y + 52 > pageHeight - 15) { doc.addPage(); y = margin; }
                        doc.setDrawColor(220, 220, 220);
                        doc.roundedRect(photoX - 0.5, y - 0.5, 51, 51, 2, 2, 'S');
                        doc.addImage(imgData, 'JPEG', photoX, y, 50, 50);
                        photoX += 55;
                    }
                } catch(e) {}
            }
            if(photoX > margin + 3) y += 58;
        }
        
        // ===== FOOTER sur toutes les pages =====
        const totalPages = doc.internal.getNumberOfPages();
        for(let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, pageHeight - 12, pageWidth - margin, pageHeight - 12);
            doc.setFontSize(7.5);
            doc.setTextColor(150, 150, 150);
            doc.text('GÃ©nÃ©rÃ© par Moteur â€” moteur.studio', margin, pageHeight - 7);
            doc.text(new Date().toLocaleDateString('fr-FR'), pageWidth / 2, pageHeight - 7, { align: 'center' });
            doc.text('Page ' + i + '/' + totalPages, pageWidth - margin, pageHeight - 7, { align: 'right' });
        }
        
        // TÃ©lÃ©charger
        const fileName = name.replace(/[^a-zA-Z0-9\u00C0-\u00FF ]/g, '').replace(/\s+/g, '_') + '_Profil.pdf';
        doc.save(fileName);
        Utils.toast('PDF profil exportÃ© !', 'success');
    },
    
    // Favoris (utilise maintenant state.contacts via Contacts.loadAndRender)
    
    isFavorite: (profileId, profileType) => {
        if(!state.contacts) return false;
        const typeMap = {
            actor: 'actors',
            crew: 'crew',
            project: 'projects',
            association: 'associations',
            enterprise: 'enterprises'
        };
        const contactType = typeMap[profileType] || 'actors';
        if(!state.contacts[contactType]) return false;
        return state.contacts[contactType].some(c => c.publicProfileId === profileId || c.contact_email === profileId);
    },
    
    toggleFavorite: async () => {
        const profile = Universe.currentProfile;
        if(!profile || !state.currentUser) return;
        
        const btn = document.getElementById('pm-favorite-btn');
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        // DÃ©terminer le type de contact
        const typeMap = {
            actor: 'actors',
            crew: 'crew',
            project: 'projects',
            association: 'associations',
            enterprise: 'enterprises'
        };
        const contactType = typeMap[profile.type] || 'actors';
        
        // S'assurer que state.contacts existe
        if(!state.contacts) state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
        if(!state.contacts[contactType]) state.contacts[contactType] = [];
        
        // VÃ©rifier si dÃ©jÃ  en favoris
        const profileId = profile.id || profile.projectId;
        const existingIndex = state.contacts[contactType].findIndex(c => c.publicProfileId === profileId || c.contact_email === profileId || c.publicProfileId === profile.projectId);
        
        if(existingIndex >= 0) {
            // Retirer des favoris
            const contactToRemove = state.contacts[contactType][existingIndex];
            state.contacts[contactType].splice(existingIndex, 1);
            const {error: delFavErr2} = await supabase.from('contacts').delete().eq('id', contactToRemove.id);
            if(delFavErr2) { console.error('Erreur suppression favori:', delFavErr2); Toast.show('Erreur suppression favori', 'error'); return; }
            btn.textContent = 'â˜†';
            btn.classList.remove('active');
            Utils.toast('RetirÃ© des favoris', 'info');
        } else {
            // Ajouter aux favoris
            // Convertir le type pluriel en singulier pour la base de donnÃ©es
            const dbTypeMap = { actors: 'actor', crew: 'crew', projects: 'project', associations: 'association', enterprises: 'enterprise' };
            const dbContactType = dbTypeMap[contactType] || profile.type || 'actor';
            
            const contactData = {
                owner_email: state.currentUser.email.toLowerCase(),
                contact_email: profile.email || profile.id || '',
                contact_type: dbContactType,
                name: profile.name || profile.title || profile.assoName || profile.entName || '',
                notes: JSON.stringify({ ...profile, publicProfileId: profile.id }),
                created_at: new Date().toISOString()
            };
            
            const { data: newContact, error } = await supabase
                .from('contacts')
                .upsert(contactData, { onConflict: 'owner_email,contact_email' })
                .select()
                .single();
            
            if(error) {
                if(error.code === '23505') {
                    btn.textContent = 'â˜…';
                    btn.classList.add('active');
                    Utils.toast('DÃ©jÃ  dans vos favoris !', 'info');
                    return;
                }
                console.error('Erreur ajout favori:', error);
                Utils.toast('Erreur lors de l\'ajout', 'error');
                return;
            }
            
            if(newContact) {
                state.contacts[contactType].push({ ...profile, id: newContact.id, publicProfileId: profile.id });
            }
            btn.textContent = 'â˜…';
            btn.classList.add('active');
            Utils.toast('AjoutÃ© aux favoris !', 'success');
        }
    },
    
    updateFavoriteButton: () => {
        const profile = Universe.currentProfile;
        const btn = document.getElementById('pm-favorite-btn');
        if(!profile || !btn) return;
        
        if(Universe.isFavorite(profile.id, profile.type)) {
            btn.textContent = 'â˜…';
            btn.classList.add('active');
        } else {
            btn.textContent = 'â˜†';
            btn.classList.remove('active');
        }
    },
    
    
    
    // Contacter un profil
    contactProfile: () => {
        if(!Universe.currentProfile) return;
        
        const profile = Universe.currentProfile;
        const profileName = profile.name || profile.assoName || profile.entName || 'ce profil';
        
        // CrÃ©er le modal de contact
        const modal = document.createElement('div');
        modal.id = 'contact-profile-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10002;';
        
        modal.innerHTML = `
            <div style="background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 500px; padding: 20px;">
                <div class="section-header-20">
                    <h3 class="m-0">ðŸ“§ Contacter ${Utils.escape(profileName)}</h3>
                    <button onclick="document.getElementById('contact-profile-modal').remove()" class="icon-btn-sec">âœ–</button>
                </div>
                <div class="mb-15">
                    <label class="label-bold">Objet</label>
                    <input type="text" id="contact-subject" placeholder="Sujet du message" class="form-input">
                </div>
                <div class="mb-20">
                    <label class="label-bold">Message</label>
                    <textarea id="contact-message" placeholder="Votre message..." rows="5" class="n8-input-6"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="document.getElementById('contact-profile-modal').remove()" class="btn-border">Annuler</button>
                    <button onclick="app.Universe.sendContactMessage()" style="padding: 10px 20px; background: #e94560; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ðŸ“§ Envoyer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('contact-subject').focus();
    },
    
    // Envoyer le message de contact
    sendContactMessage: async () => {
        const profile = Universe.currentProfile;
        if(!profile) return;
        
        const subject = document.getElementById('contact-subject').value.trim();
        const message = document.getElementById('contact-message').value.trim();
        
        if(!subject || !message) {
            Utils.toast('Veuillez remplir l\'objet et le message.', 'warning');
            return;
        }
        
        try {
            // Envoyer le message au profil destinataire
            await Messages.send(profile.email || profile.ownerId?.replace(/,/g, '.'), {
                type: 'info',
                title: subject,
                content: message
            }, profile.id); // profile.id = profileId du destinataire
            
            Utils.toast('Message envoyÃ© !', 'success');
            document.getElementById('contact-profile-modal').remove();
        } catch(e) {
            console.error('Erreur envoi message:', e);
            Utils.toast('Erreur lors de l\'envoi du message.', 'error');
        }
    },
    
    // Ajouter Ã  un projet
    addToProject: async () => {
        if(!Universe.currentProfile) return;
        
        // Charger mes projets oÃ¹ je suis owner
        const { data: memberData, error } = await supabase
            .from('project_members')
            .select('project_id, role, projects(id, title)')
            .eq('user_id', state.currentUser.id)
            .eq('role', 'owner');
        
        if(error) {
            console.error('Erreur chargement projets:', error);
            return;
        }
        
        const myProjects = (memberData || [])
            .filter(m => m.projects)
            .map(m => ({ id: m.project_id, title: m.projects.title }));
        
        if(myProjects.length === 0) {
            Utils.toast('Vous n\'avez pas encore de projet. CrÃ©ez-en un d\'abord !', 'warning');
            return;
        }
        
        // Afficher la liste des projets
        const listEl = document.getElementById('select-project-list');
        listEl.innerHTML = '';
        
        myProjects.forEach(p => {
            const btn = document.createElement('button');
            btn.style.cssText = 'width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; text-align: left; font-size: 0.95rem;';
            btn.innerHTML = `ðŸ“ ${Utils.escape(p.title)}`;
            btn.onmouseover = () => btn.style.borderColor = 'var(--primary)';
            btn.onmouseout = () => btn.style.borderColor = 'var(--border)';
            btn.onclick = () => Universe.sendProjectRequest(p);
            listEl.appendChild(btn);
        });
        
        document.getElementById('select-project-modal').style.display = 'flex';
    },
    
    // Envoyer une demande de participation
    sendProjectRequest: async (project) => {
        const profile = Universe.currentProfile;
        if(!profile) return;
        
        try {
            // Envoyer un message interne au profil destinataire
            await Messages.send(profile.email, {
                type: 'invitation',
                title: `Demande de collaboration sur "${project.title}"`,
                content: `${state.userProfile?.displayName || state.currentUser.email.split('@')[0]} souhaite vous ajouter au projet "${project.title}".\n\nSi vous acceptez, vous pourrez collaborer sur ce projet dans Moteur.`,
                projectId: project.id,
                projectTitle: project.title
            }, profile.id); // profile.id = profileId du destinataire
            
            // Ping email
            await Messages.sendEmailPing(profile.email, profile.name, 'invitation', {
                senderName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
                projectTitle: project.title,
                role: 'collaborateur'
            });
            
            document.getElementById('select-project-modal').style.display = 'none';
            Universe.closeProfileModal();
            
            Utils.toast(`Demande envoyÃ©e Ã  ${profile.name} !`, 'success');
            
        } catch(e) {
            console.error('Erreur envoi demande:', e);
            Utils.toast('Erreur lors de l\'envoi de la demande', 'error');
        }
    },
    
    // V2.1.6 : Ouvrir l'univers depuis le menu CommunautÃ©
    openFromMenu: async () => {
        UI.hideAllViews();
        document.getElementById('universe-view').style.display = 'flex';
        if(!Universe._initialized) {
            await Universe.init();
            Universe._initialized = true;
        } else {
            Universe.render();
            setTimeout(() => { if(Universe.map) Universe.map.invalidateSize(); }, 100);
        }
    },

    // V2.1.6 : Fermer l'univers â†’ retour hub
    closeToHub: () => {
        UI.hideAllViews();
        document.getElementById('dashboard-view').style.display = 'flex';
    },

    // V2.1.6 : Fermer les projets â†’ retour hub
    closeProjects: () => {
        UI.hideAllViews();
        document.getElementById('dashboard-view').style.display = 'flex';
    },

    // Afficher la vue projets
    showProjects: () => {
        UI.hideAllViews();
        document.getElementById('projects-view').style.display = 'flex';
        UI.renderProjectList();
    },
    
    // Afficher l'univers
    showUniverse: () => {
        UI.hideAllViews();
        document.getElementById('universe-view').style.display = 'flex';
        Universe.render();
        // Forcer Leaflet Ã  recalculer la taille de la carte
        setTimeout(() => {
            if(Universe.map) {
                Universe.map.invalidateSize();
            }
        }, 100);
    },
    
    // Utilitaire : mÃ©langer un tableau
    shuffleArray: (array) => {
        const arr = [...array];
        for(let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }
};

// --- MODULE MESSAGES V85 ---
const Messages = {
    currentMessageId: null,
    messages: [],
    allMessages: [],
    filteredMessages: [],
    
    // Initialise les filtres de profils
    initFilters: () => {
        const select = document.getElementById('messages-filter-profile');
        if(!select) return;
        
        select.innerHTML = '<option value="">ðŸ“¬ Tous les profils</option>';
        
        const profiles = PublicProfile.profiles || [];
        profiles.forEach(profile => {
            const opt = document.createElement('option');
            opt.value = profile.id;
            const icon = profile.type === 'actor' ? 'ðŸŽ­' : 
                        profile.type === 'crew' ? 'ðŸŽ¥' : 
                        profile.type === 'association' ? 'ðŸ›ï¸' : 
                        profile.type === 'enterprise' ? 'ðŸ¢' : 'ðŸ‘¤';
            const name = profile.name || profile.assoName || profile.entName || 'Profil';
            opt.textContent = `${icon} ${name}`;
            select.appendChild(opt);
        });
    },
    
    // Applique les filtres
    applyFilters: () => {
        const profileFilter = document.getElementById('messages-filter-profile')?.value || '';
        const typeFilter = document.getElementById('messages-filter-type')?.value || '';
        const statusFilter = document.getElementById('messages-filter-status')?.value || '';
        
        // ID du premier profil (pour les messages sans profileId)
        const firstProfileId = (PublicProfile.profiles && PublicProfile.profiles.length > 0) 
            ? PublicProfile.profiles[0].id 
            : null;
        
        Messages.filteredMessages = Messages.allMessages.filter(msg => {
            // Filtre par profil - les messages sans profileId sont attribuÃ©s au premier profil
            if(profileFilter) {
                const msgProfileId = msg.profileId || firstProfileId;
                if(msgProfileId !== profileFilter) return false;
            }
            // Filtre par type
            if(typeFilter && msg.type !== typeFilter) return false;
            // Filtre par statut
            if(statusFilter === 'unread' && msg.read) return false;
            if(statusFilter === 'read' && !msg.read) return false;
            return true;
        });
        
        Messages.render();
    },
    
    // Trouve le nom du profil par son ID
    getProfileName: (profileId) => {
        const profiles = PublicProfile.profiles || [];
        
        // Si pas de profileId, retourner le premier profil ou un dÃ©faut
        if(!profileId) {
            if(profiles.length > 0) {
                const profile = profiles[0];
                const icon = profile.type === 'actor' ? 'ðŸŽ­' : 
                            profile.type === 'crew' ? 'ðŸŽ¥' : 
                            profile.type === 'association' ? 'ðŸ›ï¸' : 
                            profile.type === 'enterprise' ? 'ðŸ¢' : 'ðŸ‘¤';
                const name = profile.name || profile.assoName || profile.entName || 'Mon profil';
                return { icon, name, photo: profile.photo };
            }
            return { icon: 'ðŸ‘¤', name: 'Mon compte', photo: null };
        }
        
        const profile = profiles.find(p => p.id === profileId);
        if(!profile) return { icon: 'ðŸ‘¤', name: 'Profil inconnu', photo: null };
        
        const icon = profile.type === 'actor' ? 'ðŸŽ­' : 
                    profile.type === 'crew' ? 'ðŸŽ¥' : 
                    profile.type === 'association' ? 'ðŸ›ï¸' : 
                    profile.type === 'enterprise' ? 'ðŸ¢' : 'ðŸ‘¤';
        const name = profile.name || profile.assoName || profile.entName || 'Profil';
        return { icon, name, photo: profile.photo };
    },
    
    // Charge les messages de l'utilisateur
    load: async () => {
        if(!state.currentUser) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        Messages.initFilters();
        
        try {
            const { data: messagesData } = await supabase.from('messages').select('*').or(`to_email.eq.${state.currentUser.email.toLowerCase()},from_email.eq.${state.currentUser.email.toLowerCase()}`).order('created_at', { ascending: false });
            const snap = { val: () => messagesData ? messagesData.reduce((acc, m) => { acc[m.id] = m; return acc; }, {}) : {} };
            const data = snap.val();
            
            Messages.allMessages = [];
            
            if(data) {
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    if(item.createdAt) {
                        Messages.allMessages.push({ id: key, ...item });
                    }
                });
                
                // Trier par date dÃ©croissante
                Messages.allMessages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }
            
            Messages.filteredMessages = [...Messages.allMessages];
            Messages.updateBadge();
            Messages.render();
        } catch(e) {
            console.error('Erreur chargement messages:', e);
        }
    },
    
    // Met Ã  jour le badge de notification
    updateBadge: () => {
        const totalUnread = Messages.allMessages.filter(m => !m.read).length;
        
        const badge = document.getElementById('messages-badge');
        if(badge) {
            if(totalUnread > 0) {
                badge.textContent = totalUnread;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
    },
    
    // Affiche la liste des messages
    render: () => {
        const container = document.getElementById('messages-list');
        if(!container) return;
        
        if(Messages.filteredMessages.length === 0) {
            container.innerHTML = '<div class="message-empty">ðŸ“­ Aucun message.</div>';
            return;
        }
        
        let html = '';
        Messages.filteredMessages.forEach(msg => {
            const date = new Date(msg.createdAt).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            const typeLabel = msg.type === 'invitation' ? 'ðŸŽ¬ Invitation' : (msg.type === 'convocation' ? 'ðŸ“… Convocation' : 'â„¹ï¸ Information');
            const preview = msg.content ? msg.content.substring(0, 100) + (msg.content.length > 100 ? '...' : '') : '';
            
            // Info du profil destinataire
            const profileInfo = Messages.getProfileName(msg.profileId);
            const defaultAvatar = `<div style="width: 20px; height: 20px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; font-size: 10px;">${profileInfo.icon}</div>`;
            const profileBadge = `<div style="display: inline-flex; align-items: center; gap: 6px; background: var(--bg); padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; border: 1px solid var(--border);">
                    ${profileInfo.photo ? `<img src="${profileInfo.photo}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover;">` : defaultAvatar}
                    <span style="color: var(--text-main); font-weight: 500;">${Utils.escape(profileInfo.name)}</span>
                   </div>`;
            
            html += `
                <div class="message-card ${msg.read ? '' : 'unread'}" onclick="app.Messages.openDetail('${msg.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                        <span class="message-card-type ${msg.type}">${typeLabel}</span>
                        ${profileBadge}
                    </div>
                    <div class="message-card-header">
                        <div class="message-card-title">${Utils.escape(msg.title)}</div>
                        <div class="message-card-date">${date}</div>
                    </div>
                    <div class="message-card-from">De : ${Utils.escape(msg.fromName || msg.fromUser)}</div>
                    ${msg.projectTitle ? `<div style="font-size:0.8rem; color:var(--text-sec); margin-bottom:5px;">ðŸ“ ${Utils.escape(msg.projectTitle)}</div>` : ''}
                    <div class="message-card-preview">${Utils.escape(preview)}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    // Ouvre le dÃ©tail d'un message
    openDetail: async (messageId) => {
        const msg = Messages.allMessages.find(m => m.id === messageId);
        if(!msg) return;
        
        Messages.currentMessageId = messageId;
        
        // Marquer comme lu
        if(!msg.read) {
            msg.read = true;
            // Mettre Ã  jour aussi dans filteredMessages
            const filteredMsg = Messages.filteredMessages.find(m => m.id === messageId);
            if(filteredMsg) filteredMsg.read = true;
            
            const emailKey = Utils.sanitizeEmail(state.currentUser.email);
            const {error: readErr} = await supabase.from('messages').update({ read: true }).eq('id', messageId);
            if(readErr) console.error('Erreur marquage lu:', readErr);
            Messages.updateBadge();
            Messages.render();
        }
        
        // Afficher le modal
        const date = new Date(msg.createdAt).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        document.getElementById('message-detail-title').textContent = msg.title;
        document.getElementById('message-detail-meta').innerHTML = `
            <div><strong>De :</strong> ${Utils.escape(msg.fromName || msg.fromUser)}</div>
            <div><strong>Date :</strong> ${date}</div>
            ${msg.projectTitle ? `<div><strong>Projet :</strong> ${Utils.escape(msg.projectTitle)}</div>` : ''}
        `;
        document.getElementById('message-detail-content').textContent = msg.content;
        
        // Afficher les actions selon le type de message
        const quickActions = document.getElementById('message-detail-quick-actions');
        if(msg.type === 'claim') {
            quickActions.innerHTML = `
                <div class="flex-wrap-center">
                    <button onclick="app.PublicProfile.open(); app.Messages.closeDetail();" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        âœ¨ Voir / Revendiquer mon profil
                    </button>
                    <button onclick="app.Messages.proposeExistingProfile('${msg.fromUser}', '${msg.projectId || ''}', '${Utils.escape(msg.projectTitle || '')}', '${msg.claimId || ''}')" style="background: var(--warning); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ðŸ“¤ J'ai dÃ©jÃ  un profil (autre email)
                    </button>
                    <button onclick="app.Messages.replyTo('${msg.fromUser}')" class="btn-primary-r8">
                        ðŸ’¬ Contacter ${Utils.escape(msg.fromName || 'l\'expÃ©diteur')}
                    </button>
                    <button onclick="app.Messages.quickReply('${msg.fromUser}', 'info')" class="n8-badge-13">
                        â“ Demande d'information
                    </button>
                </div>
            `;
            quickActions.style.display = 'block';
        } else if(msg.type === 'invitation') {
            quickActions.innerHTML = `
                <div class="flex-wrap-center">
                    ${msg.projectId ? `<button onclick="app.Store.loadProject('${msg.projectId}'); app.Messages.closeDetail();" style="background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        âœ… Ouvrir le projet
                    </button>` : ''}
                    <button onclick="app.Messages.replyTo('${msg.fromUser}')" class="btn-primary-r8">
                        ðŸ’¬ Contacter ${Utils.escape(msg.fromName || 'l\'expÃ©diteur')}
                    </button>
                    <button onclick="app.Messages.quickReply('${msg.fromUser}', 'accept')" style="background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        ðŸ‘ Accepter
                    </button>
                    <button onclick="app.Messages.quickReply('${msg.fromUser}', 'decline')" class="n8-badge-16">
                        ðŸ‘Ž DÃ©cliner
                    </button>
                    <button onclick="app.Messages.quickReply('${msg.fromUser}', 'info')" class="n8-badge-13">
                        â“ Demande d'information
                    </button>
                </div>
            `;
            quickActions.style.display = 'block';
        } else if(msg.type === 'profile_proposal' && msg.proposedProfile) {
            const profile = msg.proposedProfile;
            const photoHtml = profile.photo 
                ? `<img src="${profile.photo}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;">` 
                : `<div style="width:60px;height:60px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:white;">${(profile.name || '?')[0].toUpperCase()}</div>`;
            const typeIcon = profile.type === 'actor' ? 'ðŸŽ­' : profile.type === 'crew' ? 'ðŸŽ¥' : 'ðŸ“';
            
            quickActions.innerHTML = `
                <div style="background:var(--bg);border-radius:10px;padding:15px;margin-bottom:15px;">
                    <div style="display:flex;align-items:center;gap:15px;">
                        ${photoHtml}
                        <div>
                            <div style="font-weight:bold;font-size:1.1rem;color:var(--text-main);">${typeIcon} ${Utils.escape(profile.name)}</div>
                            <div class="text-sec">${Utils.escape(profile.city || '')} ${profile.role ? 'â€¢ ' + Utils.escape(profile.role) : ''}</div>
                            <div style="color:var(--primary);font-size:0.9rem;">${Utils.escape(profile.email)}</div>
                        </div>
                    </div>
                </div>
                <div class="flex-wrap-center">
                    <button onclick="app.Messages.acceptProfileProposal('${msg.id}')" style="background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        âœ… Accepter ce profil
                    </button>
                    <button onclick="app.Messages.replyTo('${msg.fromUser}')" class="btn-primary-r8">
                        ðŸ’¬ Contacter ${Utils.escape(msg.fromName || 'l\'expÃ©diteur')}
                    </button>
                    <button onclick="app.Messages.declineProfileProposal('${msg.fromUser}')" class="n8-badge-16">
                        âŒ Refuser
                    </button>
                </div>
            `;
            quickActions.style.display = 'block';
        } else {
            quickActions.innerHTML = `
                <div class="flex-wrap-center">
                    <button onclick="app.Messages.replyTo('${msg.fromUser}')" class="btn-primary-r8">
                        ðŸ’¬ RÃ©pondre
                    </button>
                </div>
            `;
            quickActions.style.display = 'block';
        }
        
        document.getElementById('message-detail-modal').style.display = 'flex';
    },
    
    // Ferme le dÃ©tail
    closeDetail: () => {
        document.getElementById('message-detail-modal').style.display = 'none';
        Messages.currentMessageId = null;
    },
    
    // RÃ©pondre Ã  un message
    replyTo: (toEmail) => {
        Messages.closeDetail();
        // Ouvrir le modal de nouveau message avec destinataire prÃ©-rempli
        const modal = document.createElement('div');
        modal.id = 'reply-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:10002;';
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; max-width:500px; width:90%;">
                <h3 class="mb-15">ðŸ’¬ RÃ©pondre Ã  ${Utils.escape(toEmail)}</h3>
                <textarea id="reply-message-content" placeholder="Votre message..." class="n8-input-2"></textarea>
                <div class="flex-end">
                    <button onclick="document.getElementById('reply-modal').remove();" class="btn-border-r8">Annuler</button>
                    <button onclick="app.Messages.sendReply('${toEmail}')" class="n8-btn-5">ðŸ“¤ Envoyer</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('reply-message-content').focus();
    },
    
    // Envoyer la rÃ©ponse
    sendReply: async (toEmail) => {
        const content = document.getElementById('reply-message-content').value.trim();
        if(!content) {
            Utils.toast('Veuillez Ã©crire un message', 'warning');
            return;
        }
        
        await Messages.send(toEmail, {
            title: 'RÃ©ponse de ' + (state.userProfile?.displayName || state.currentUser.email.split('@')[0]),
            content: content,
            type: 'message'
        });
        
        document.getElementById('reply-modal').remove();
        Utils.toast('Message envoyÃ© !', 'success');
    },
    
    // RÃ©ponse rapide prÃ©-dÃ©finie
    quickReply: async (toEmail, replyType) => {
        let title = '';
        let content = '';
        
        switch(replyType) {
            case 'accept':
                title = 'âœ… Invitation acceptÃ©e';
                content = 'Bonjour,\n\nJe vous confirme ma participation au projet. Merci pour cette invitation !\n\nCordialement';
                break;
            case 'decline':
                title = 'âŒ Invitation dÃ©clinÃ©e';
                content = 'Bonjour,\n\nMalheureusement, je ne pourrai pas participer Ã  ce projet. Merci quand mÃªme pour cette proposition.\n\nCordialement';
                break;
            case 'info':
                title = 'â“ Demande d\'information';
                content = 'Bonjour,\n\nAvant de donner ma rÃ©ponse, pourriez-vous me donner plus d\'informations sur :\n- Les dates de tournage\n- Le lieu\n- Les conditions\n\nMerci d\'avance !';
                break;
            default:
                return;
        }
        
        // Ouvrir le modal de rÃ©ponse avec le contenu prÃ©-rempli
        Messages.closeDetail();
        const modal = document.createElement('div');
        modal.id = 'reply-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:10002;';
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; max-width:500px; width:90%;">
                <h3 class="mb-15">${title}</h3>
                <textarea id="reply-message-content" class="n8-input-2">${content}</textarea>
                <div class="flex-end">
                    <button onclick="document.getElementById('reply-modal').remove();" class="btn-border-r8">Annuler</button>
                    <button onclick="app.Messages.sendQuickReply('${toEmail}', '${title}')" class="n8-btn-5">ðŸ“¤ Envoyer</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    },
    
    // Envoyer la rÃ©ponse rapide
    sendQuickReply: async (toEmail, title) => {
        const content = document.getElementById('reply-message-content').value.trim();
        if(!content) {
            Utils.toast('Veuillez Ã©crire un message', 'warning');
            return;
        }
        
        await Messages.send(toEmail, {
            title: title,
            content: content,
            type: 'message'
        });
        
        document.getElementById('reply-modal').remove();
        Utils.toast('Message envoyÃ© !', 'success');
    },
    
    // Proposer un profil existant au porteur de projet
    proposeExistingProfile: async (toEmail, projectId, projectTitle, claimId) => {
        Messages.closeDetail();
        
        // Charger les profils de l'utilisateur
        if(!PublicProfile.profiles || PublicProfile.profiles.length === 0) {
            await PublicProfile.loadProfiles();
        }
        
        if(PublicProfile.profiles.length === 0) {
            Utils.toast('Vous n\'avez pas encore de profil. CrÃ©ez-en un d\'abord !', 'warning');
            PublicProfile.open();
            return;
        }
        
        // CrÃ©er le modal de sÃ©lection de profil
        const modal = document.createElement('div');
        modal.id = 'propose-profile-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10002;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        let profilesHtml = '';
        PublicProfile.profiles.forEach((profile, idx) => {
            if(!profile.type) return; // Ignorer les profils incomplets
            
            const icon = profile.type === 'actor' ? 'ðŸŽ­' : profile.type === 'crew' ? 'ðŸŽ¥' : profile.type === 'association' ? 'ðŸ›ï¸' : 'ðŸ¢';
            const name = profile.name || profile.assoName || profile.entName || 'Sans nom';
            const photoHtml = profile.photo 
                ? `<img src="${profile.photo}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">` 
                : `<div style="width:50px;height:50px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:white;">${name[0].toUpperCase()}</div>`;
            
            profilesHtml += `
                <div onclick="app.Messages.sendProfileProposal('${toEmail}', '${projectId}', '${projectTitle}', '${claimId}', ${idx})" style="display:flex;align-items:center;gap:15px;padding:15px;background:var(--bg);border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                    ${photoHtml}
                    <div class="flex-1">
                        <div style="font-weight:bold;color:var(--text-main);">${icon} ${Utils.escape(name)}</div>
                        <div style="font-size:0.85rem;color:var(--text-sec);">${Utils.escape(profile.city || '')} ${profile.role ? 'â€¢ ' + Utils.escape(profile.role) : ''}</div>
                        <div style="font-size:0.8rem;color:var(--primary);">${profile.email || state.currentUser.email}</div>
                    </div>
                </div>
            `;
        });
        
        modal.innerHTML = `
            <div class="modal-panel">
                <h3 style="margin:0 0 10px;color:var(--text-main);">ðŸ“¤ Proposer mon profil existant</h3>
                <p style="color:var(--text-sec);margin-bottom:20px;">SÃ©lectionnez le profil Ã  envoyer au porteur de projet :</p>
                
                <div style="display:flex;flex-direction:column;gap:10px;">
                    ${profilesHtml || '<p style="color:var(--text-sec);text-align:center;">Aucun profil disponible</p>'}
                </div>
                
                <div style="margin-top:20px;text-align:center;">
                    <button onclick="document.getElementById('propose-profile-modal').remove()" style="padding:10px 25px;background:var(--border);color:var(--text-main);border:none;border-radius:8px;cursor:pointer;">Annuler</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Envoyer la proposition de profil au porteur
    sendProfileProposal: async (toEmail, projectId, projectTitle, claimId, profileIdx) => {
        const profile = PublicProfile.profiles[profileIdx];
        if(!profile) return;
        
        document.getElementById('propose-profile-modal')?.remove();
        
        const myName = profile.name || profile.assoName || profile.entName || state.currentUser.email.split('@')[0];
        const typeLabel = profile.type === 'actor' ? 'comÃ©dien' : profile.type === 'crew' ? 'technicien' : profile.type;
        
        try {
            await Messages.send(toEmail, {
                type: 'profile_proposal',
                title: `ðŸ“¤ ${myName} vous propose son profil ${typeLabel} existant`,
                content: `Bonjour,\n\nVous m'avez ajoutÃ© au projet "${projectTitle}" mais j'ai dÃ©jÃ  un profil ${typeLabel} sur Moteur avec une autre adresse email.\n\nJe vous propose d'utiliser mon profil existant pour que mes informations soient Ã  jour.\n\nCordialement,\n${myName}`,
                projectId: projectId,
                projectTitle: projectTitle,
                claimId: claimId,
                proposedProfile: {
                    id: profile.id,
                    type: profile.type,
                    name: myName,
                    email: profile.email || state.currentUser.email,
                    photo: profile.photo || '',
                    city: profile.city || '',
                    role: profile.role || '',
                    department: profile.department || ''
                }
            });
            
            Utils.toast('Votre profil a Ã©tÃ© proposÃ© au porteur de projet !', 'success');
        } catch(e) {
            console.error('Erreur envoi proposition:', e);
            Utils.toast('Erreur lors de l\'envoi', 'error');
        }
    },
    
    // Accepter une proposition de profil
    acceptProfileProposal: async (messageId) => {
        const msg = Messages.allMessages.find(m => m.id === messageId);
        if(!msg || !msg.proposedProfile || !msg.projectId) {
            Utils.toast('DonnÃ©es de proposition incomplÃ¨tes', 'error');
            return;
        }
        
        const profile = msg.proposedProfile;
        
        try {
            // Charger le projet depuis Supabase
            const { data: projectRow, error: projectError } = await supabase
                .from('projects')
                .select('data')
                .eq('id', msg.projectId)
                .single();
            
            if(projectError || !projectRow) {
                Utils.toast('Projet introuvable', 'error');
                return;
            }
            
            const projectData = projectRow.data || {};
            
            // Trouver et mettre Ã  jour le membre correspondant
            const dataArray = profile.type === 'actor' ? projectData.actors : projectData.crew;
            const tableName = profile.type === 'actor' ? 'public_actors' : 'public_crew';
            
            if(dataArray && Array.isArray(dataArray)) {
                // Chercher par claimId ou par ancien email
                let memberIdx = -1;
                
                // D'abord essayer de trouver via le pending claim
                if(msg.claimId) {
                    memberIdx = dataArray.findIndex(m => m.id && msg.claimId.includes(m.id.replace('act_', '').replace('crew_', '')));
                }
                
                // Sinon chercher par email de l'expÃ©diteur
                if(memberIdx === -1) {
                    memberIdx = dataArray.findIndex(m => m.email && m.email.toLowerCase() === msg.fromUser.toLowerCase());
                }
                
                if(memberIdx !== -1) {
                    // Charger les donnÃ©es complÃ¨tes du profil public depuis Supabase
                    const { data: publicData } = await supabase
                        .from(tableName)
                        .select('*')
                        .eq('id', profile.id)
                        .single();
                    
                    if(publicData) {
                        // Mettre Ã  jour avec les donnÃ©es du profil public
                        dataArray[memberIdx] = {
                            ...dataArray[memberIdx],
                            ...publicData,
                            id: dataArray[memberIdx].id, // Garder l'ID local
                            publicProfileId: profile.id,
                            email: profile.email
                        };
                        
                        // Sauvegarder dans Supabase
                        const updatePath = profile.type === 'actor' ? 'actors' : 'crew';
                        const newData = { ...projectData, [updatePath]: dataArray };
                        await supabase
                            .from('projects')
                            .update({ data: newData, updated_at: new Date().toISOString() })
                            .eq('id', msg.projectId);
                        
                        // Note: pending_profile_claims gÃ©rÃ© via messages systÃ¨me
                        // Rien Ã  supprimer ici, le claim est traitÃ©
                        
                        // Notifier la personne
                        await Messages.send(msg.fromUser, {
                            type: 'info',
                            title: 'âœ… Votre profil a Ã©tÃ© acceptÃ© !',
                            content: `Bonne nouvelle ! Votre profil existant a Ã©tÃ© liÃ© au projet "${msg.projectTitle}".\n\nVos informations sont maintenant synchronisÃ©es.`,
                            projectId: msg.projectId,
                            projectTitle: msg.projectTitle
                        });
                        
                        Messages.closeDetail();
                        Utils.toast('Profil acceptÃ© et liÃ© au projet !', 'success');
                        
                        // Recharger le projet si on est dessus
                        if(state.currentProjectId === msg.projectId) {
                            Store.loadProject(msg.projectId);
                        }
                        
                        return;
                    }
                }
            }
            
            Utils.toast('Impossible de trouver le membre dans le projet', 'error');
        } catch(e) {
            console.error('Erreur acceptation profil:', e);
            Utils.toast('Erreur lors de l\'acceptation', 'error');
        }
    },
    
    // Refuser une proposition de profil
    declineProfileProposal: async (fromEmail) => {
        if(!await ConfirmModal.show({ title: 'Refuser cette proposition ?', message: 'La proposition de profil sera refusÃ©e.', icon: 'âŒ', confirmText: 'Refuser', dangerous: true })) return;
        
        await Messages.send(fromEmail, {
            type: 'info',
            title: 'âŒ Proposition de profil dÃ©clinÃ©e',
            content: 'Le porteur de projet a dÃ©clinÃ© votre proposition de profil. Il souhaite peut-Ãªtre que vous crÃ©iez un nouveau profil spÃ©cifique pour ce projet.\n\nN\'hÃ©sitez pas Ã  le contacter pour plus d\'informations.'
        });
        
        Messages.closeDetail();
        Utils.toast('Proposition refusÃ©e', 'info');
    },
    
    // Supprime un message
    deleteMessage: async () => {
        if(!Messages.currentMessageId) return;
        if(!await ConfirmModal.confirmDelete("Ce message sera supprimÃ©.")) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        const {error: delMsgErr} = await supabase.from('messages').delete().eq('id', Messages.currentMessageId);
        if(delMsgErr) { console.error('Erreur suppression message:', delMsgErr); Toast.show('Erreur suppression message', 'error'); return; }
        
        Messages.messages = Messages.messages.filter(m => m.id !== Messages.currentMessageId);
        Messages.closeDetail();
        Messages.updateBadge();
        Messages.render();
    },
    
    // Envoie un message Ã  un utilisateur
    send: async (toEmail, message, toProfileId = null) => {
        const emailKey = Utils.sanitizeEmail(toEmail.toLowerCase());
        const messageId = Utils.generateUniqueId();
        
        // Trouver le profil de l'expÃ©diteur actuel
        const fromProfileId = Messages.currentProfileId || (PublicProfile.profiles[0]?.id) || null;
        
        const messageData = {
            ...message,
            fromUser: state.currentUser.email,
            fromName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            fromProfileId: fromProfileId,
            profileId: toProfileId, // Profil destinataire
            createdAt: new Date().toISOString(),
            read: false
        };
        
        // Sauvegarder dans Supabase
        const { error } = await supabase
            .from('messages')
            .insert({
                id: messageId,
                to_email: toEmail,
                from_email: state.currentUser.email,
                from_name: messageData.fromName,
                type: messageData.type || 'message',
                subject: messageData.subject || messageData.title || '',
                content: messageData.content || '',
                data: messageData,
                read: false,
                created_at: messageData.createdAt
            });
        
        if(error) {
            console.error('Erreur envoi message:', error);
            throw error;
        }
        
        // Envoyer une notification pour la cloche
        try {
            await Notifications.send(
                toEmail,
                'message',
                `ðŸ’¬ ${messageData.fromName} vous a envoyÃ© un message : "${message.subject || 'Nouveau message'}"`,
                message.projectId || null
            );
        } catch(e) {
            console.warn('Erreur notification message:', e);
        }
        
        return messageId;
    },
    
    // Envoie une notification par email (ping simple)
    // Nettoie une string pour EmailJS (supprime caractÃ¨res problÃ©matiques)
    sanitizeForEmail: (str) => {
        if(str === null || str === undefined) return '';
        return String(str)
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Supprime accents
            .replace(/[\n\r\t]/g, ' ')
            .replace(/[""''Â«Â»]/g, "'")
            .replace(/[Ã Ã¢Ã¤]/g, 'a').replace(/[Ã©Ã¨ÃªÃ«]/g, 'e').replace(/[Ã¯Ã®]/g, 'i')
            .replace(/[Ã´Ã¶]/g, 'o').replace(/[Ã¹Ã»Ã¼]/g, 'u').replace(/[Ã§]/g, 'c')
            .replace(/[Ã€Ã‚Ã„Ã]/g, 'A').replace(/[Ã‰ÃˆÃŠÃ‹]/g, 'E').replace(/[ÃÃŽ]/g, 'I')
            .replace(/[Ã”Ã–]/g, 'O').replace(/[Ã™Ã›ÃœÃš]/g, 'U').replace(/[Ã‡]/g, 'C')
            .replace(/[^\x20-\x7E]/g, '') // Garde uniquement ASCII imprimable
            .replace(/\s+/g, ' ')
            .trim()
            .substring(0, 500) || 'N/A';
    },
    
    // Templates d'email selon le type
    emailTemplates: {
        'claim': (data) => ({
            title: 'Profil cree pour vous',
            message: `${data.senderName} a cree un profil ${data.typeLabel} a votre nom pour le projet "${data.projectTitle}". Connectez-vous a Moteur pour revendiquer ce profil, le completer et apparaitre dans l'Univers !`
        }),
        'invitation': (data) => ({
            title: 'Invitation projet',
            message: `${data.senderName} vous invite a rejoindre le projet "${data.projectTitle}" en tant que ${data.role}. Connectez-vous a Moteur pour acceder au projet.`
        }),
        'contact': (data) => ({
            title: 'Nouveau message',
            message: `${data.senderName} vous a contacte. Connectez-vous a Moteur pour lire le message et repondre.`
        }),
        'project_contact': (data) => ({
            title: 'Message pour votre projet',
            message: `${data.senderName} vous a contacte concernant votre projet "${data.projectTitle}". Sujet: ${data.subject}. Connectez-vous a Moteur pour lire le message.`
        }),
        'reply': (data) => ({
            title: 'Reponse recue',
            message: `${data.senderName} vous a repondu. Connectez-vous a Moteur pour lire la reponse.`
        }),
        'callsheet': (data) => ({
            title: 'Convocation tournage',
            message: `Vous etes convoque pour le tournage de "${data.projectName}" le ${data.shootDate}. Lieu: ${data.location}. Heure de convocation: ${data.callTime}. Voir et imprimer votre feuille de service: ${data.publicLink || 'https://moteur.studio'}`
        }),
        'default': (data) => ({
            title: 'Notification',
            message: data.customMessage || 'Vous avez recu une notification sur Moteur. Connectez-vous pour en savoir plus.'
        })
    },
    
    sendEmailPing: async (toEmail, toName, emailType = 'default', data = {}) => {
        if(!CONFIG.emailJS.publicKey || CONFIG.emailJS.publicKey === 'VOTRE_PUBLIC_KEY') {
            console.warn('EmailJS non configurÃ© - ping email ignorÃ©');
            return;
        }
        
        const sanitize = Messages.sanitizeForEmail;
        const safeToEmail = sanitize(toEmail);
        const safeToName = sanitize(toName) || safeToEmail.split('@')[0] || 'Utilisateur';
        
        if(!safeToEmail) {
            console.warn('Email invalide - ping ignorÃ©');
            return;
        }
        
        // RÃ©cupÃ©rer le template appropriÃ©
        const templateFn = Messages.emailTemplates[emailType] || Messages.emailTemplates['default'];
        const template = templateFn({
            senderName: sanitize(data.senderName) || 'Un utilisateur',
            projectTitle: sanitize(data.projectTitle) || 'Projet',
            typeLabel: sanitize(data.typeLabel) || 'membre',
            role: sanitize(data.role) || 'collaborateur',
            subject: sanitize(data.subject) || 'Sans sujet',
            customMessage: sanitize(data.customMessage) || ''
        });
        
        try {
            const emailData = {
                to_email: safeToEmail,
                name: safeToName,
                email: safeToEmail,
                project_title: sanitize(template.title) || 'Moteur',
                role: 'Notification',
                inviter_name: sanitize(data.senderName) || 'Moteur',
                message: sanitize(template.message),
                app_url: 'https://moteur.studio'
            };
            // console.log('EmailJS Data:', emailData);
            await emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, emailData, CONFIG.emailJS.publicKey);
        } catch(e) {
            console.error('Erreur ping email:', e);
        }
    },

    openCompose: (toEmail) => {
        if(!toEmail) return Utils.toast('Pas d\'email disponible', 'warning');
        PublicProfile.open();
        setTimeout(() => {
            PublicProfile.showTab('messages');
            setTimeout(() => Messages.quickReply(toEmail), 200);
        }, 200);
    }
};

// --- MODULE INVITATIONS V84 ---
const Invitations = {
    // VÃ©rifie si l'email existe dÃ©jÃ  dans Firebase
    checkEmail: async (email) => {
        const statusEl = document.getElementById('share-email-status');
        const messageSection = document.getElementById('share-message-section');
        
        if(!email || !email.includes('@')) {
            statusEl.style.display = 'none';
            messageSection.style.display = 'none';
            return;
        }
        
        const emailKey = Utils.sanitizeEmail(email);
        
        try {
            const { data: profileData } = await supabase.from('user_profiles').select('*').eq('email', state.currentUser.email.toLowerCase()).single();
            const profileSnap = { val: () => profileData };
            
            if(profileSnap.exists()) {
                statusEl.innerHTML = 'âœ… <strong>Utilisateur existant</strong> - Il aura accÃ¨s immÃ©diatement';
                statusEl.style.background = 'rgba(40,167,69,0.1)';
                statusEl.style.color = 'var(--success)';
                statusEl.style.display = 'block';
                messageSection.style.display = 'none';
            } else {
                statusEl.innerHTML = 'ðŸ“§ <strong>Nouvel utilisateur</strong> - Une invitation sera envoyÃ©e par email';
                statusEl.style.background = 'rgba(43,110,246,0.1)';
                statusEl.style.color = 'var(--primary)';
                statusEl.style.display = 'block';
                messageSection.style.display = 'block';
            }
        } catch(e) {
            statusEl.style.display = 'none';
            messageSection.style.display = 'block';
        }
    },
    
    // Envoie l'invitation
    sendInvitation: async () => {
        // VÃ©rifier si l'email est dans la whitelist
        const email = document.getElementById('share-email')?.value?.trim()?.toLowerCase();
        
        if(!email || !email.includes('@')) {
            Utils.toast('Veuillez entrer un email valide.', 'warning');
            return;
        }
        
        // Si l'email n'est pas dans la whitelist, bloquer
        if(!CONFIG.preAlpha.whitelist.includes(email)) {
            Utils.toast('ðŸš§ Fonction limitÃ©e en prÃ©-alpha. Seuls les utilisateurs de la whitelist peuvent Ãªtre invitÃ©s.', 'warning', 5000);
            return;
        }
        
        const role = document.getElementById('share-role').value;
        const message = document.getElementById('share-message')?.value?.trim() || '';
        
        if(!state.currentProjectId) return;
        
        const btn = document.getElementById('share-confirm-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Envoi...';
        btn.classList.add('btn-loading');
        
        const emailKey = Utils.sanitizeEmail(email);
        const pid = state.currentProjectId;
        const projectTitle = state.data.title || 'Sans titre';
        const inviterEmail = state.currentUser.email;
        const inviterName = state.currentUser.email.split('@')[0];
        
        try {
            // VÃ©rifier si l'utilisateur existe dans Supabase
            const { data: existingProfile } = await supabase
                .from('user_profiles')
                .select('id, email')
                .eq('email', email.toLowerCase())
                .single();
            
            const userExists = !!existingProfile;
            
            // Ajouter le membre au projet dans Supabase
            let invitedUserId = existingProfile?.id || null;
            
            if(invitedUserId) {
                // L'utilisateur existe, on l'ajoute directement comme membre
                await supabase
                    .from('project_members')
                    .upsert({
                        project_id: pid,
                        user_id: invitedUserId,
                        role: role,
                        invited_by: state.currentUser.id,
                        invited_at: new Date().toISOString()
                    }, { onConflict: 'project_id,user_id' });
            }
            
            // Stocker l'invitation en attente pour les utilisateurs qui n'existent pas encore
            if(!userExists) {
                await supabase
                    .from('messages')
                    .insert({
                        id: 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        to_email: email,
                        from_email: inviterEmail,
                        from_name: inviterName,
                        type: 'pending_invitation',
                        subject: `Invitation au projet "${projectTitle}"`,
                        content: message || '',
                        data: {
                            projectId: pid,
                            projectTitle: projectTitle,
                            role: role,
                            invitedBy: inviterEmail,
                            invitedAt: new Date().toISOString(),
                            message: message
                        },
                        read: false,
                        created_at: new Date().toISOString()
                    });
            }
            
            // Envoyer un message interne
            const roleLabel = role === 'editor' ? 'Ã‰diteur' : 'Lecteur';
            await Messages.send(email, {
                type: 'invitation',
                title: `Invitation au projet "${projectTitle}"`,
                content: `${inviterName} vous invite Ã  rejoindre le projet "${projectTitle}" en tant que ${roleLabel}.\n\n${message ? 'Message : ' + message : ''}\n\nVous trouverez ce projet dans votre liste de projets.`,
                projectId: pid,
                projectTitle: projectTitle
            });
            
            // Envoyer un ping email
            if(!userExists) {
                await Invitations.sendEmail(email, projectTitle, role, inviterName, message);
            } else {
                await Messages.sendEmailPing(email, email.split('@')[0], 'invitation', {
                    senderName: inviterName,
                    projectTitle: projectTitle,
                    role: roleLabel
                });
            }
            
            Utils.toast(userExists 
                ? `${email} a maintenant accÃ¨s au projet !` 
                : `Invitation envoyÃ©e Ã  ${email} !`, 'success');
            
            document.getElementById('share-modal').style.display = 'none';
            document.getElementById('share-email').value = '';
            document.getElementById('share-message').value = '';
            document.getElementById('share-email-status').style.display = 'none';
            document.getElementById('share-message-section').style.display = 'none';
            
        } catch(e) {
            Utils.toast('Erreur: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'ðŸ“§ Inviter';
            btn.classList.remove('btn-loading');
        }
    },
    
    // Envoie l'email via EmailJS
    sendEmail: async (toEmail, projectTitle, role, inviterName, message) => {
        // VÃ©rifier si EmailJS est configurÃ©
        if(!CONFIG.emailJS.publicKey || CONFIG.emailJS.publicKey === 'VOTRE_PUBLIC_KEY') {
            console.warn('EmailJS non configurÃ© - email non envoyÃ©');
            Invitations.openMailto(toEmail, projectTitle, role, inviterName, message);
            return;
        }
        
        // S'assurer que toutes les variables sont des strings valides
        const safeToEmail = String(toEmail || '').trim();
        const safeProjectTitle = String(projectTitle || 'Projet').trim();
        const safeRole = role === 'editor' ? 'Editeur' : 'Lecteur';
        const safeInviterName = String(inviterName || 'Un utilisateur').trim();
        const safeMessage = String(message || 'Vous Ãªtes invitÃ© Ã  collaborer sur ce projet.').trim();
        const safeAppUrl = String(window.location.origin + window.location.pathname || 'https://moteur.studio').trim();
        
        if(!safeToEmail) {
            console.warn('Email invalide - envoi ignorÃ©');
            return;
        }
        
        try {
            const sanitize = Messages.sanitizeForEmail;
            await emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, {
                to_email: sanitize(safeToEmail),
                name: sanitize(safeToEmail.split('@')[0]) || 'Utilisateur',
                email: sanitize(safeToEmail),
                project_title: sanitize(safeProjectTitle) || 'Projet',
                role: sanitize(safeRole) || 'Invite',
                inviter_name: sanitize(safeInviterName) || 'Un utilisateur',
                message: sanitize(safeMessage) || 'Vous etes invite a collaborer.',
                app_url: sanitize(safeAppUrl) || 'https://moteur.studio'
            }, CONFIG.emailJS.publicKey);
            
        } catch(e) {
            console.error('Erreur EmailJS:', e);
            // Fallback mailto si EmailJS Ã©choue
            Invitations.openMailto(toEmail, projectTitle, role, inviterName, message);
        }
    },
    
    // Ouvre le client mail en fallback
    openMailto: (toEmail, projectTitle, role, inviterName, message) => {
        const roleLabel = role === 'editor' ? 'Ã‰diteur' : 'Lecteur';
        const subject = encodeURIComponent(`Invitation Ã  collaborer sur "${projectTitle}" - Moteur`);
        const body = encodeURIComponent(
`Bonjour,

${inviterName} vous invite Ã  collaborer sur le projet "${projectTitle}" en tant que ${roleLabel}.

${message ? 'Message: ' + message + '\n\n' : ''}Pour acceder au projet, creez votre compte gratuit sur Moteur :
${window.location.origin}${window.location.pathname}

Ã€ bientÃ´t !`
        );
        window.open(`mailto:${toEmail}?subject=${subject}&body=${body}`, '_blank');
    },

    // VÃ©rifie les invitations en attente Ã  la connexion
    checkPendingInvitations: async () => {
        if(!state.currentUser) return;
        
        try {
            // Chercher les invitations en attente dans les messages
            const { data: pendingInvitations, error } = await supabase
                .from('messages')
                .select('*')
                .eq('to_email', state.currentUser.email.toLowerCase())
                .eq('type', 'pending_invitation')
                .eq('read', false);
            
            if(error) throw error;
            
            if(pendingInvitations && pendingInvitations.length > 0) {
                const count = pendingInvitations.length;
                const projects = pendingInvitations.map(inv => inv.data?.projectTitle || 'Projet').join(', ');
                
                // Traiter chaque invitation - ajouter l'utilisateur au projet
                for(const inv of pendingInvitations) {
                    const invData = inv.data || {};
                    if(invData.projectId) {
                        // Ajouter comme membre du projet
                        await supabase
                            .from('project_members')
                            .upsert({
                                project_id: invData.projectId,
                                user_id: state.currentUser.id,
                                role: invData.role || 'viewer',
                                invited_by: null,
                                invited_at: invData.invitedAt || new Date().toISOString()
                            }, { onConflict: 'project_id,user_id' });
                    }
                    
                    // Marquer l'invitation comme lue
                    await supabase
                        .from('messages')
                        .update({ read: true })
                        .eq('id', inv.id);
                }
                
                // Notifier l'utilisateur
                setTimeout(() => {
                    Utils.toast(`ðŸŽ‰ ${count} invitation(s) en attente : ${projects}`, 'success', 6000);
                }, 500);
            }
        } catch(e) {
            console.error('Erreur vÃ©rification invitations:', e);
        }
    }
};

  // === MODULE TUTORIEL & AIDE CONTEXTUELLE ===
  const Tutorial = {
    sections: [
      {
        id: 'intro',
        title: 'ðŸŽ¬ Introduction',
        content: `
          <h3>Bienvenue dans Moteur !</h3>
          <p>Moteur est l'application tout-en-un pour gÃ©rer ton projet de film. Que tu sois rÃ©alisateur, producteur, ou passionnÃ© de cinÃ©ma, Moteur centralise tout : Ã©criture du scÃ©nario, casting, planning, budget, storyboard...</p>
          <p>Plus besoin de jongler entre dix logiciels diffÃ©rents. Moteur gÃ¨re tout, du premier mot Ã  la derniÃ¨re prise.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Astuce :</strong> Sur le dashboard, clique sur "Nouveau projet" pour commencer. Tu arrives sur l'espace de travail avec tous les onglets Ã  gauche et les menus en haut.</div>
          <p>Et le plus cool ? Tu peux collaborer en temps rÃ©el avec toute ton Ã©quipe !</p>
        `
      },
      {
        id: 'univers',
        title: 'ðŸŒ L\'Univers',
        content: `
          <h3>L'annuaire de la communautÃ©</h3>
          <p>L'Univers, c'est l'annuaire de la communautÃ© Moteur ! Tu y trouves des profils et projets sur une carte interactive.</p>
          <p>Tu vois les professionnels du cinÃ©ma gÃ©olocalisÃ©s : comÃ©diens, techniciens, associations, boÃ®tes de prod... Clique sur un marqueur pour voir la fiche complÃ¨te.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Filtres :</strong> Tu peux filtrer par mÃ©tier, par compÃ©tence, par zone gÃ©ographique. Trouve le perchman ou le chef op de tes rÃªves !</div>
          <p>Les projets publics apparaissent aussi sur la carte. Tu vois qui tourne quoi, et oÃ¹.</p>
          <p>L'Ã©toile sur les fiches ajoute la personne ou le projet Ã  tes favoris. Tu les retrouves dans Contacts.</p>
        `
      },
      {
        id: 'scenario',
        title: 'ðŸ“ ScÃ©nario',
        content: `
          <h3>Le cÅ“ur du projet</h3>
          <p>C'est ici que tout commence ! Tu as trois options : Ã©crire depuis zÃ©ro, importer un PDF, ou importer un fichier Final Draft.</p>
          <p>L'Ã©diteur propose tous les types de paragraphes : action, personnage, dialogue, transition...</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Raccourcis :</strong> Tab pour basculer entre les types. Ctrl+1 pour Action, Ctrl+2 pour Personnage, Ctrl+3 pour Dialogue...</div>
          <p><strong>Import PDF :</strong> Tu uploades ton scÃ©nario, et un assistant t'aide Ã  identifier chaque Ã©lÃ©ment. Clique sur une ligne, dis "Ã§a c'est un personnage", et toutes les lignes similaires sont dÃ©tectÃ©es !</p>
          <p><strong>Modes de vue :</strong> Vue ScÃ¨nes pour travailler scÃ¨ne par scÃ¨ne, ou Vue Script pour tout voir d'un coup.</p>
          <p><strong>Mode Focus (F11) :</strong> L'interface disparaÃ®t pour te concentrer sur le texte. Ã‰chap pour quitter.</p>
          <p><strong>Export :</strong> PDF formatÃ© pro, Fountain universel, ou Final Draft FDX.</p>
        `
      },
      {
        id: 'synopsis',
        title: 'ðŸ“„ Synopsis & Titre',
        content: `
          <h3>Les bases de ton projet</h3>
          <p><strong>Synopsis :</strong> C'est ton pitch, ton rÃ©sumÃ©. Ã‰cris quelques lignes qui donnent envie. C'est ce que les producteurs liront en premier !</p>
          <p><strong>Page de Titre :</strong> Ta couverture pro avec titre, auteur, contact, version, date... Ces infos apparaissent automatiquement Ã  l'export.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Pro tip :</strong> Ajoute un copyright et des notes. Tout est prÃªt pour envoyer ton scÃ©nario !</div>
        `
      },
      {
        id: 'sequencier',
        title: 'ðŸ“‹ SÃ©quencier & Beat Board',
        content: `
          <h3>La vue d'ensemble de ton film</h3>
          <p><strong>SÃ©quencier :</strong> Toutes tes scÃ¨nes organisÃ©es visuellement. Chaque scÃ¨ne est une fiche avec numÃ©ro, dÃ©cor, rÃ©sumÃ©, effet jour/nuit. RÃ©organise par glisser-dÃ©poser.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Couleurs :</strong> Regroupe tes scÃ¨nes par acte, lieu, ambiance... Ã  toi de voir !</div>
          <p><strong>Beat Board :</strong> Mode visuel oÃ¹ tes scÃ¨nes deviennent des fiches sur un grand canvas. DÃ©place-les librement, zoome, dÃ©zoome.</p>
          <p>Le fil rouge relie tes scÃ¨nes dans l'ordre - c'est la timeline visuelle ! Maintiens Shift et glisse pour dÃ©placer une scÃ¨ne dans le fil.</p>
          <p>Ctrl+clic pour sÃ©lectionner plusieurs scÃ¨nes et les dÃ©placer ensemble.</p>
        `
      },
      {
        id: 'depouillement',
        title: 'ðŸ” DÃ©pouillement',
        content: `
          <h3>L'Ã©tape clÃ© entre Ã©criture et production</h3>
          <p>On analyse chaque scÃ¨ne pour identifier tous les Ã©lÃ©ments nÃ©cessaires au tournage.</p>
          <div class="tuto-tip"><strong>âš ï¸ Important :</strong> Une scÃ¨ne doit Ãªtre finalisÃ©e pour Ãªtre dÃ©pouillÃ©e (sinon le texte peut encore changer).</div>
          <p><strong>Comment faire :</strong> Surligne un mot dans le texte, clic droit, choisis la catÃ©gorie (personnage, accessoire, costume...).</p>
          <p>Le systÃ¨me est intelligent : si "Ã©pÃ©e" apparaÃ®t dans d'autres scÃ¨nes, il propose de les lier automatiquement.</p>
          <p>Les personnages des dialogues sont ajoutÃ©s automatiquement. Tout ce que tu dÃ©pouilles remonte dans les autres onglets : Ressources, Casting, Planning...</p>
        `
      },
      {
        id: 'storyboard',
        title: 'ðŸŽ¨ Storyboard',
        content: `
          <h3>Ton film en images</h3>
          <p>Chaque plan dessinÃ© pour visualiser tes intentions. Ã€ gauche, la liste des scÃ¨nes. Clique pour voir et crÃ©er les plans.</p>
          <p>Pour chaque plan : type (gros plan, plan large...), mouvement camÃ©ra (travelling, panoramique...), angle, durÃ©e estimÃ©e.</p>
          <p><strong>Ã‰diteur de dessin intÃ©grÃ© :</strong> Clique sur la vignette pour dessiner. Crayon, formes, texte, couleurs, import d'images de rÃ©fÃ©rence.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Pas besoin d'Ãªtre artiste :</strong> Des bonhommes bÃ¢tons suffisent pour communiquer ta vision !</div>
          <p><strong>Export PDF :</strong> Grille 2x2, format paysage, prÃªt Ã  distribuer Ã  l'Ã©quipe.</p>
        `
      },
      {
        id: 'moodboard',
        title: 'ðŸŽ­ MoodBoard',
        content: `
          <h3>Ton tableau d'inspiration</h3>
          <p>Ambiances, couleurs, rÃ©fÃ©rences visuelles... CrÃ©e plusieurs planches : dÃ©cors, costumes, Ã©clairage...</p>
          <p>Glisse-dÃ©pose des images, redimensionne, tourne, superpose. 30 formes gÃ©omÃ©triques disponibles.</p>
          <p><strong>GÃ©nÃ©rateur de palettes :</strong> Roue chromatique style Adobe Color. Choisis une harmonie (complÃ©mentaire, triade, analogue) et hop, 5 couleurs assorties !</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Astuce :</strong> Clique sur une couleur de palette pour copier son code hex.</div>
          <p>Export en PNG ou PDF haute qualitÃ©.</p>
        `
      },
      {
        id: 'casting',
        title: 'ðŸŽ­ Casting',
        content: `
          <h3>GÃ¨re tous tes comÃ©diens</h3>
          <p>Deux vues : par Personnages du scÃ©nario, ou par ComÃ©diens avec fiches complÃ¨tes.</p>
          <p>Chaque personnage peut Ãªtre liÃ© Ã  un comÃ©dien. Tu vois qui joue qui en un coup d'Å“il.</p>
          <p><strong>Fiche comÃ©dien :</strong> Photo, contact, mensurations, compÃ©tences, disponibilitÃ©s. Jusqu'Ã  3 photos pour la galerie (essais costumes !).</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Contrats :</strong> Le bouton Contrat sur chaque fiche gÃ©nÃ¨re directement le document. Les jours de tournage sont calculÃ©s depuis le planning.</div>
        `
      },
      {
        id: 'equipe',
        title: 'ðŸŽ¥ Ã‰quipe Technique',
        content: `
          <h3>Ton organigramme technique</h3>
          <p>Tous les postes, tous les dÃ©partements : rÃ©alisateur, chef op, ingÃ© son, scripte, machino...</p>
          <p>Chaque fiche technicien : contact, dispo, compÃ©tences, matÃ©riel technique (camÃ©ra, objectifs, micros...).</p>
          <p><strong>Contrats :</strong> GÃ©nÃ¨re un CDDU ou contrat de prestation selon le statut.</p>
          <p>L'export PDF liste tout le monde par dÃ©partement avec coordonnÃ©es. Parfait pour le premier jour !</p>
        `
      },
      {
        id: 'planning',
        title: 'ðŸ“… Planning & Feuilles de Service',
        content: `
          <h3>Le calendrier de ton tournage</h3>
          <p>Chaque jour, chaque scÃ¨ne, organisÃ©s visuellement. Clique sur une date pour voir/crÃ©er le dÃ©tail.</p>
          <p><strong>Feuille de Service :</strong> LE document que tout le monde attend ! Lieu, horaires, mÃ©tÃ©o, programme, Ã©quipe convoquÃ©e...</p>
          <div class="tuto-tip"><strong>ðŸ’¡ MÃ©tÃ©o auto :</strong> RÃ©cupÃ©rÃ©e automatiquement via API. TempÃ©rature, pluie, vent, lever du soleil !</div>
          <p>Le lieu affiche une carte interactive avec lien Google Maps.</p>
          <p><strong>Transport intelligent :</strong> Si Lila amÃ¨ne Sarah, alors Sarah est automatiquement marquÃ©e "part avec Lila".</p>
          <p>Export PDF avec nom : Projet_FDS_Lieu_Date. PrÃªt Ã  envoyer !</p>
        `
      },
      {
        id: 'budget',
        title: 'ðŸ’° Budget & DÃ©penses',
        content: `
          <h3>Le nerf de la guerre</h3>
          <p><strong>Mode Simple :</strong> Budget global + liste de dÃ©penses (Ã  payer / payÃ©).</p>
          <p><strong>Mode AvancÃ© :</strong> CatÃ©gories, enveloppes, responsables par poste, workflow de validation.</p>
          <p>Les salaires peuvent Ãªtre calculÃ©s automatiquement depuis les fiches comÃ©diens/techniciens.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Graphiques :</strong> Visualise la rÃ©partition par catÃ©gorie. Tu vois oÃ¹ part ton budget.</div>
          <p>Export Excel dÃ©taillÃ© pour ton comptable, ou rapport PDF de synthÃ¨se.</p>
        `
      },
      {
        id: 'contrats',
        title: 'ðŸ“‹ Contrats',
        content: `
          <h3>Documents conformes au droit franÃ§ais</h3>
          <p><strong>Types disponibles :</strong> Droit Ã  l'image (RGPD), CDDU (intermittents), Prestation (auto-entrepreneur), Accord bÃ©nÃ©vole.</p>
          <p>Le CDDU inclut toutes les mentions lÃ©gales : motif de recours, DPAE, congÃ©s spectacles...</p>
          <div class="tuto-tip"><strong>ðŸ’¡ VÃ©rification :</strong> Le systÃ¨me vÃ©rifie que toutes les infos sont renseignÃ©es avant de gÃ©nÃ©rer. Sinon, il t'alerte !</div>
          <p>Les infos lÃ©gales de ta production se remplissent dans l'onglet PrÃ©sentation (SIRET, licence...).</p>
        `
      },
      {
        id: 'profil',
        title: 'ðŸ‘¤ Mon Profil Public',
        content: `
          <h3>Ta carte de visite pro</h3>
          <p>Pour apparaÃ®tre dans l'Univers, crÃ©e un profil : ComÃ©dien, Technicien, Association, ou Entreprise.</p>
          <p><strong>Profil ComÃ©dien :</strong> Mensurations, compÃ©tences, langues, sports (avec niveaux). Jusqu'Ã  3 photos.</p>
          <p><strong>Profil Technicien :</strong> MÃ©tiers, matos, expÃ©riences, showreel.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ VisibilitÃ© :</strong> Chaque section a un bouton pour masquer ce que tu ne veux pas montrer publiquement.</div>
          <p>Tarif, zone de mobilitÃ©, calendrier de dispos... Tout pour faciliter les contacts !</p>
        `
      },
      {
        id: 'collaboration',
        title: 'ðŸ‘¥ Collaboration',
        content: `
          <h3>Travaille en Ã©quipe</h3>
          <p>Invite des collaborateurs par email avec un rÃ´le : Lecteur, Contributeur, ou Admin.</p>
          <p>Les modifications se synchronisent en temps rÃ©el. Tout le monde voit les changements instantanÃ©ment.</p>
          <p><strong>Chat intÃ©grÃ© :</strong> Discutez sans quitter l'application.</p>
          <p><strong>Commentaires :</strong> Sur les scÃ¨nes du sÃ©quencier pour garder l'historique des discussions crÃ©atives.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ ContrÃ´le :</strong> Seul le propriÃ©taire peut supprimer le projet ou changer les permissions.</div>
        `
      },
      {
        id: 'export',
        title: 'ðŸ“¤ Exports',
        content: `
          <h3>Tous les formats pro</h3>
          <p><strong>ScÃ©nario :</strong> PDF formatÃ©, Fountain, Final Draft FDX</p>
          <p><strong>Autres :</strong> SÃ©quencier, casting, Ã©quipe, dÃ©cors en PDF. Budget en Excel. Storyboard en grille PDF. MoodBoard en PNG/PDF.</p>
          <p><strong>Rapport de production :</strong> Compile stats, Ã©quipe, budget, planning en un document de synthÃ¨se.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Export ZIP :</strong> Tous tes PDFs et CSVs dans un dossier, avec fichier projet JSON pour backup/transfert.</div>
        `
      },
      {
        id: 'personnalisation',
        title: 'ðŸŽ¨ Personnalisation',
        content: `
          <h3>Fais de Moteur TON outil</h3>
          <p><strong>11 thÃ¨mes :</strong> Classique, Glass, Cinema (noir et or), Cyberpunk (nÃ©on), Nature, Sunset, OcÃ©an, Lavande, Minimal, Terminal...</p>
          <p>Mode clair/sombre en un clic. Ton choix est sauvegardÃ©.</p>
          <p><strong>5 styles d'icÃ´nes :</strong> Emoji, ColorÃ©, Duotone, Minimal, Gradient.</p>
          <div class="tuto-tip"><strong>ðŸ’¡ Menu Design :</strong> Tout se trouve dans le menu Design en haut Ã  droite.</div>
        `
      }
    ],
    
    helpTexts: {
      'synopsis': { title: 'ðŸ“„ Synopsis', text: 'Ton pitch et rÃ©sumÃ© du film. C\'est ce que les producteurs liront en premier ! Ã‰cris quelques lignes qui donnent envie.' },
      'board': { title: 'ðŸ“‹ SÃ©quencier / Beat Board', text: 'Vue d\'ensemble de toutes tes scÃ¨nes. RÃ©organise par glisser-dÃ©poser. Le Beat Board offre une vue canvas libre avec fil rouge.' },
      'titlepage': { title: 'ðŸ“ƒ Page de Titre', text: 'Ta couverture pro : titre, auteur, contact, version. Ces infos apparaissent Ã  l\'export Fountain/FDX.' },
      'script': { title: 'ðŸ“ ScÃ©nario', text: 'L\'Ã©diteur de scÃ©nario. Tab pour changer de type, Ctrl+1-7 pour les raccourcis. F11 = Mode Focus.' },
      'moodboard': { title: 'ðŸŽ­ MoodBoard', text: 'Tableau d\'inspiration visuel. Glisse des images, ajoute des formes, gÃ©nÃ¨re des palettes de couleurs.' },
      'storyboard': { title: 'ðŸŽ¨ Storyboard', text: 'Dessine chaque plan de ton film. Ã‰diteur intÃ©grÃ© avec formes et couleurs. Export PDF en grille.' },
      'presentation': { title: 'ðŸŽ¬ PrÃ©sentation', text: 'Infos gÃ©nÃ©rales du projet : titre, genre, Ã©quipe, dates, infos lÃ©gales pour les contrats.' },
      'characters': { title: 'ðŸ‘¥ Personnages', text: 'Liste des personnages de ton scÃ©nario. Lie-les aux comÃ©diens dans l\'onglet Casting.' },
      'locations': { title: 'ðŸ“ DÃ©cors', text: 'Tous les lieux de tournage. Ajoute photos, adresses, contacts des propriÃ©taires.' },
      'actors': { title: 'ðŸŽ­ ComÃ©diens', text: 'Fiches complÃ¨tes des comÃ©diens : photo, contact, mensurations, disponibilitÃ©s. GÃ©nÃ¨re les contrats.' },
      'crew': { title: 'ðŸŽ¥ Ã‰quipe', text: 'Organigramme technique par dÃ©partement. Fiches avec contact, matos, contrats.' },
      'breakdown': { title: 'ðŸ” DÃ©pouillement', text: 'Analyse chaque scÃ¨ne finalisÃ©e. Surligne + clic droit pour catÃ©goriser (accessoires, costumes...).' },
      'resources': { title: 'ðŸ“¦ Ressources', text: 'Tout le matÃ©riel : accessoires, costumes, vÃ©hicules. LiÃ© au dÃ©pouillement.' },
      'schedule': { title: 'ðŸ“… Planning', text: 'Calendrier de tournage. CrÃ©e les journÃ©es et gÃ©nÃ¨re les feuilles de service avec mÃ©tÃ©o auto.' },
      'budget': { title: 'ðŸ’° Budget', text: 'Mode Simple ou AvancÃ©. Salaires auto, validation workflow, graphiques, export Excel.' },
      'contracts': { title: 'ðŸ“‹ Contrats', text: 'GÃ©nÃ¨re Droit Ã  l\'image, CDDU, Prestation, Accord bÃ©nÃ©vole. Conformes au droit franÃ§ais.' },
      'reports': { title: 'ðŸ“Š Rapport Script', text: 'La mÃ©moire du tournage. Note chaque prise avec qualitÃ© son/image/acting. Ã‰toiles Or/Argent pour les meilleures.' },
      'universe': { title: 'ðŸŒ L\'Univers', text: 'Annuaire de la communautÃ© sur carte. Trouve des talents, partage ton projet, ajoute en favoris.' }
    },
    
    currentSection: 'intro',
    
    open: () => {
      const overlay = document.getElementById('tuto-modal-overlay');
      overlay.classList.add('show');
      Tutorial.renderSidebar();
      Tutorial.showSection('intro');
    },
    
    close: () => {
      document.getElementById('tuto-modal-overlay').classList.remove('show');
    },
    
    renderSidebar: () => {
      const sidebar = document.getElementById('tuto-sidebar');
      sidebar.innerHTML = Tutorial.sections.map(s => `
        <div class="tuto-sidebar-item ${s.id === Tutorial.currentSection ? 'active' : ''}" 
             onclick="app.Tutorial.showSection('${s.id}')">
          ${s.title}
        </div>
      `).join('');
    },
    
    showSection: (id) => {
      Tutorial.currentSection = id;
      const section = Tutorial.sections.find(s => s.id === id);
      if(section) {
        document.getElementById('tuto-content').innerHTML = section.content;
      }
      Tutorial.renderSidebar();
    },
    
    showHelp: (tabId, event) => {
      event?.stopPropagation();
      const help = Tutorial.helpTexts[tabId];
      if(!help) return;
      
      const popup = document.getElementById('help-popup');
      document.getElementById('help-popup-title').textContent = help.title;
      document.getElementById('help-popup-content').textContent = help.text;
      
      // Position prÃ¨s du clic
      const rect = event.target.getBoundingClientRect();
      popup.style.top = (rect.bottom + 10) + 'px';
      popup.style.left = Math.min(rect.left, window.innerWidth - 370) + 'px';
      
      popup.classList.add('show');
      
      // Fermer au clic ailleurs
      setTimeout(() => {
        document.addEventListener('click', Tutorial.closeHelpOnClickOutside);
      }, 100);
    },
    
    closeHelp: () => {
      document.getElementById('help-popup').classList.remove('show');
      document.removeEventListener('click', Tutorial.closeHelpOnClickOutside);
    },
    
    closeHelpOnClickOutside: (e) => {
      const popup = document.getElementById('help-popup');
      if(!popup.contains(e.target) && !e.target.classList.contains('help-icon')) {
        Tutorial.closeHelp();
      }
    }
  };

  Icons.init();
  setTimeout(Auth.init, 50);

  // ===== DÃ‰TECTION FEUILLE DE SERVICE PUBLIQUE =====
  (function checkPublicCallSheet() {
      const urlParams = new URLSearchParams(window.location.search);
      const callsheetToken = urlParams.get('callsheet');
      if(callsheetToken) {
          // Attendre que Firebase soit initialisÃ©
          setTimeout(() => {
              Planning.loadPublicCallSheet(callsheetToken);
          }, 500);
      }
  })();

  // ===== RACCOURCIS CLAVIER =====
  document.addEventListener('keydown', (e) => {
      // Ã‰chap - Fermer les modales
      if(e.key === 'Escape') {
          // Quitter mode prÃ©sentation en prioritÃ©
          if(PresentMode.isActive) {
              PresentMode.exit();
              return;
          }
          // Fermer modal profil
          const profileModal = document.getElementById('profile-modal-overlay');
          if(profileModal && profileModal.style.display !== 'none') {
              Universe.closeProfileModal();
              return;
          }
          // Fermer modal sÃ©lection projet
          const selectProjectModal = document.getElementById('select-project-modal');
          if(selectProjectModal && selectProjectModal.style.display !== 'none') {
              selectProjectModal.style.display = 'none';
              return;
          }
          // Fermer modal partage
          const shareModal = document.getElementById('share-modal');
          if(shareModal && shareModal.style.display !== 'none') {
              shareModal.style.display = 'none';
              return;
          }
          // Fermer modal export
          const exportModal = document.getElementById('export-modal');
          if(exportModal && exportModal.style.display !== 'none') {
              exportModal.style.display = 'none';
              return;
          }
          // Fermer modal tag
          const tagModal = document.getElementById('tag-modal');
          if(tagModal && tagModal.style.display !== 'none') {
              tagModal.style.display = 'none';
              return;
          }
          // Fermer menu couleur onglet
          const tabColorMenu = document.getElementById('tab-color-menu');
          if(tabColorMenu && tabColorMenu.classList.contains('visible')) {
              UI.closeTabColorMenu();
              return;
          }
          // Fermer sidebar mobile
          const mobileSidebar = document.querySelector('.board-sidebar.mobile-open');
          if(mobileSidebar) {
              UI.closeMobileSidebar();
              return;
          }
      }
      
      // Ctrl+S - Sauvegarder
      if(e.ctrlKey && e.key === 's') {
          e.preventDefault();
          if(state.currentProjectId && els.appView.style.display !== 'none') {
              Store.save();
              Utils.toast('Projet sauvegardÃ© !', 'success');
          } else if(document.getElementById('public-profile-view')?.classList.contains('active')) {
              PublicProfile.saveCurrentProfile();
          }
          return;
      }
      
      // Ignorer Shift seul en Vue Script (Ã©viter perte de focus)
      if(e.key === 'Shift') {
          const continuousContainer = document.getElementById('scriptContinuousContainer');
          if(continuousContainer && continuousContainer.style.display !== 'none') {
              e.preventDefault();
              e.stopPropagation();
              return;
          }
      }
      
      // Ctrl+flÃ¨ches - Navigation onglets (seulement dans l'app)
      if(e.ctrlKey && els.appView.style.display !== 'none') {
          const tabs = Array.from(document.querySelectorAll('.tab-btn'));
          const activeIndex = tabs.findIndex(t => t.classList.contains('active'));
          
          if(e.key === 'ArrowRight' && activeIndex < tabs.length - 1) {
              e.preventDefault();
              tabs[activeIndex + 1].click();
          } else if(e.key === 'ArrowLeft' && activeIndex > 0) {
              e.preventDefault();
              tabs[activeIndex - 1].click();
          }
      }
  });

  const StoryboardPreview = {
    currentSceneId: null,
    
    open: (sceneId) => {
        StoryboardPreview.currentSceneId = sceneId;
        const scene = state.data.scenes.find(s => s.id === sceneId);
        document.getElementById('storyboard-preview-title').textContent = scene ? `Storyboard - ${scene.title}` : 'Storyboard';
        StoryboardPreview.load();
        document.getElementById('storyboard-preview-panel').classList.add('open');
    },
    
    close: () => {
        document.getElementById('storyboard-preview-panel').classList.remove('open');
        StoryboardPreview.currentSceneId = null;
    },
    
    load: () => {
        const container = document.getElementById('storyboard-preview-list');
        const sceneId = StoryboardPreview.currentSceneId;
        const scene = state.data.scenes.find(s => s.id === sceneId);
        const sceneIndex = state.data.scenes.indexOf(scene) + 1;
        const shots = state.data.shots ? state.data.shots.filter(s => s.sceneId === sceneId).sort((a, b) => a.order - b.order) : [];
        
        if(shots.length === 0) {
            container.innerHTML = '<div class="storyboard-preview-empty">Aucun plan pour cette scÃ¨ne<br><br><button onclick="app.UI.goToStoryboard(\'' + sceneId + '\'); app.StoryboardPreview.close();" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer;">+ CrÃ©er des plans</button></div>';
            return;
        }
        
        container.innerHTML = '';
        const grid = document.createElement('div');
        grid.className = 'sb-print-grid';
        
        shots.forEach((shot, idx) => {
            const card = Storyboard.createPrintShot(shot, sceneIndex, idx + 1);
            card.onclick = () => {
                app.UI.goToStoryboard(sceneId);
                app.StoryboardPreview.close();
            };
            grid.appendChild(card);
        });
        
        container.appendChild(grid);
    }
};

const Comments = {
    currentSceneId: null,
    
    open: (sceneId) => {
        Comments.currentSceneId = sceneId;
        const scene = state.data.scenes.find(s => s.id === sceneId);
        const sceneIndex = state.data.scenes.findIndex(s => s.id === sceneId) + 1;
        document.getElementById('comments-scene-title').innerText = `ScÃ¨ne ${sceneIndex} - ${scene?.title || ''}`;
        document.getElementById('comments-panel').classList.add('open');
        document.getElementById('comment-input').value = '';
        Comments.load();
    },
    
    close: () => {
        document.getElementById('comments-panel').classList.remove('open');
        Comments.currentSceneId = null;
    },
    
    load: async () => {
        if(!Comments.currentSceneId || !state.currentProjectId) return;
        
        const listEl = document.getElementById('comments-list');
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sec);">Chargement...</div>';
        
        try {
            // Les commentaires sont stockÃ©s dans state.data.comments (chargÃ©s avec le projet)
            const allComments = state.data?.comments || {};
            const comments = allComments[Comments.currentSceneId] || {};
            
            const sortedComments = Object.entries(comments)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => b.date - a.date);
            
            if(sortedComments.length === 0) {
                listEl.innerHTML = '<div class="no-comments">Aucun commentaire pour cette scÃ¨ne.<br>Soyez le premier Ã  commenter !</div>';
                return;
            }
            
            listEl.innerHTML = sortedComments.map(c => Comments.renderComment(c)).join('');
        } catch(e) {
            console.error('Erreur chargement commentaires:', e);
            listEl.innerHTML = '<div class="no-comments">Erreur de chargement</div>';
        }
    },
    
    renderComment: (comment) => {
        const date = new Date(comment.date).toLocaleString();
        const isOwn = state.currentUser?.email === comment.author;
        const canResolve = state.currentRole === 'owner' || state.currentRole === 'editor';
        const canDelete = isOwn || state.currentRole === 'owner';
        
        const replies = comment.replies ? Object.entries(comment.replies)
            .map(([id, r]) => ({ id, ...r }))
            .sort((a, b) => a.date - b.date)
            .map(r => `
                <div class="comment-item" style="margin-top: 8px; padding: 8px;">
                    <div class="comment-author">
                        <span class="comment-author-name">${Utils.escape(r.authorName || r.author)}</span>
                        <span class="comment-date">${new Date(r.date).toLocaleString()}</span>
                    </div>
                    <div class="comment-text">${Utils.escape(r.text)}</div>
                </div>
            `).join('') : '';
        
        return `
            <div class="comment-item ${comment.resolved ? 'resolved' : ''}" data-id="${comment.id}">
                <div class="comment-author">
                    <span class="comment-author-name">${Utils.escape(comment.authorName || comment.author)}</span>
                    <span class="comment-date">${date} ${comment.resolved ? 'âœ… RÃ©solu' : ''}</span>
                </div>
                <div class="comment-text">${Utils.escape(comment.text)}</div>
                <div class="comment-actions">
                    <button class="comment-action-btn" onclick="app.Comments.toggleReply('${comment.id}')">â†©ï¸ RÃ©pondre</button>
                    ${canResolve && !comment.resolved ? `<button class="comment-action-btn" onclick="app.Comments.resolve('${comment.id}')">âœ… RÃ©soudre</button>` : ''}
                    ${canDelete ? `<button class="comment-action-btn" onclick="app.Comments.delete('${comment.id}')" class="text-danger">ðŸ—‘ï¸ Supprimer</button>` : ''}
                </div>
                <div class="comment-reply-input" id="reply-${comment.id}">
                    <textarea class="comment-input" rows="2" placeholder="Votre rÃ©ponse..." id="reply-text-${comment.id}"></textarea>
                    <button class="comment-submit" style="margin-top:5px; padding:8px;" onclick="app.Comments.addReply('${comment.id}')">RÃ©pondre</button>
                </div>
                ${replies ? `<div class="comment-replies">${replies}</div>` : ''}
            </div>
        `;
    },
    
    add: async () => {
        const text = document.getElementById('comment-input').value.trim();
        if(!text || !Comments.currentSceneId || !state.currentProjectId) return;
        
        const commentId = 'cmt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const comment = {
            author: state.currentUser.email,
            authorName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            date: Date.now(),
            text: text,
            resolved: false
        };
        
        try {
            // Ajouter le commentaire dans state.data.comments
            if(!state.data.comments) state.data.comments = {};
            if(!state.data.comments[Comments.currentSceneId]) state.data.comments[Comments.currentSceneId] = {};
            state.data.comments[Comments.currentSceneId][commentId] = comment;
            
            // Sauvegarder dans Supabase
            await supabase
                .from('projects')
                .update({ 
                    data: state.data,
                    updated_at: new Date().toISOString()
                })
                .eq('id', state.currentProjectId);
            
            document.getElementById('comment-input').value = '';
            Comments.load();
            Comments.updateBadge(Comments.currentSceneId);
            Utils.toast('Commentaire ajoutÃ©', 'success');
        } catch(e) {
            console.error('Erreur ajout commentaire:', e);
            Utils.toast('Erreur lors de l\'ajout', 'error');
        }
    },
    
    toggleReply: (commentId) => {
        const replyDiv = document.getElementById(`reply-${commentId}`);
        replyDiv.classList.toggle('active');
    },
    
    addReply: async (commentId) => {
        const text = document.getElementById(`reply-text-${commentId}`).value.trim();
        if(!text) return;
        
        const replyId = 'rpl_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const reply = {
            author: state.currentUser.email,
            authorName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            date: Date.now(),
            text: text
        };
        
        try {
            // Ajouter la rÃ©ponse dans state.data.comments
            if(!state.data.comments[Comments.currentSceneId][commentId].replies) {
                state.data.comments[Comments.currentSceneId][commentId].replies = {};
            }
            state.data.comments[Comments.currentSceneId][commentId].replies[replyId] = reply;
            
            // Sauvegarder dans Supabase
            await supabase
                .from('projects')
                .update({ 
                    data: state.data,
                    updated_at: new Date().toISOString()
                })
                .eq('id', state.currentProjectId);
            
            Comments.load();
            Utils.toast('RÃ©ponse ajoutÃ©e', 'success');
        } catch(e) {
            Utils.toast('Erreur lors de l\'ajout', 'error');
        }
    },
    
    resolve: async (commentId) => {
        try {
            // Marquer comme rÃ©solu dans state.data.comments
            if(state.data.comments?.[Comments.currentSceneId]?.[commentId]) {
                state.data.comments[Comments.currentSceneId][commentId].resolved = true;
            }
            
            // Sauvegarder dans Supabase
            await supabase
                .from('projects')
                .update({ 
                    data: state.data,
                    updated_at: new Date().toISOString()
                })
                .eq('id', state.currentProjectId);
            
            Comments.load();
            Comments.updateBadge(Comments.currentSceneId);
            Utils.toast('Commentaire marquÃ© comme rÃ©solu', 'success');
        } catch(e) {
            Utils.toast('Erreur', 'error');
        }
    },
    
    delete: async (commentId) => {
        if(!await ConfirmModal.confirmDelete("Ce commentaire sera supprimÃ©.")) return;
        
        try {
            // Supprimer le commentaire dans state.data.comments
            if(state.data.comments?.[Comments.currentSceneId]?.[commentId]) {
                delete state.data.comments[Comments.currentSceneId][commentId];
            }
            
            // Sauvegarder dans Supabase
            await supabase
                .from('projects')
                .update({ 
                    data: state.data,
                    updated_at: new Date().toISOString()
                })
                .eq('id', state.currentProjectId);
            
            Comments.load();
            Comments.updateBadge(Comments.currentSceneId);
            Utils.toast('Commentaire supprimÃ©', 'success');
        } catch(e) {
            Utils.toast('Erreur', 'error');
        }
    },
    
    getCount: async (sceneId) => {
        if(!state.currentProjectId) return { total: 0, unresolved: 0 };
        
        try {
            // Les commentaires sont stockÃ©s dans state.data.comments
            const allComments = state.data?.comments || {};
            const comments = allComments[sceneId] || {};
            const list = Object.values(comments);
            return {
                total: list.length,
                unresolved: list.filter(c => !c.resolved).length
            };
        } catch(e) {
            return { total: 0, unresolved: 0 };
        }
    },
    
    updateBadge: async (sceneId) => {
        const count = await Comments.getCount(sceneId);
        const badge = document.querySelector(`.comment-badge[data-scene="${sceneId}"]`);
        if(badge) {
            if(count.total === 0) {
                badge.style.display = 'none';
            } else {
                badge.style.display = 'inline-flex';
                badge.innerText = count.unresolved || 'âœ“';
                badge.classList.toggle('resolved', count.unresolved === 0);
            }
        }
    },
    
    updateAllBadges: async () => {
        for(const scene of state.data.scenes) {
            await Comments.updateBadge(scene.id);
        }
    }
};

// ==================== MODULE HELP ====================
const Courses = {
    currentTab: 'scenario',
    
    open: () => {
        UI.hideAllViews();
        document.getElementById('courses-view').classList.add('active');
        Courses.render();
    },
    
    close: () => {
        UI.hideAllViews();
        document.getElementById('dashboard-view').style.display = 'flex';
    },
    
    switchTab: (tabName) => {
        Courses.currentTab = tabName;
        document.querySelectorAll('.courses-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.courses-tab[onclick*="${tabName}"]`).classList.add('active');
        Courses.render();
    },
    
    render: () => {
        const content = document.getElementById('courses-content');
        const courses = Courses.getCourses();
        content.innerHTML = courses[Courses.currentTab] || '<p>Contenu Ã  venir...</p>';
        Courses.initNotions();
    },
    
    // SystÃ¨me d'infobulles pour les notions
    initNotions: () => {
        document.querySelectorAll('.notion').forEach(el => {
            el.addEventListener('mouseenter', Courses.showNotion);
            el.addEventListener('mouseleave', Courses.scheduleHideNotion);
        });
    },
    
    scheduleHideNotion: () => {
        // DÃ©lai pour permettre Ã  la souris d'aller sur le tooltip
        Courses.hideTimeout = setTimeout(() => {
            const tooltip = document.querySelector('.notion-tooltip');
            if (tooltip && !tooltip.matches(':hover')) {
                tooltip.remove();
            }
        }, 100);
    },
    
    showNotion: (e) => {
        const key = e.target.getAttribute('data-notion');
        const notion = Courses.notions[key];
        if (!notion) return;
        
        // Supprimer tooltip existant
        const existing = document.querySelector('.notion-tooltip');
        if (existing) existing.remove();
        
        // CrÃ©er tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'notion-tooltip';
        tooltip.innerHTML = `
            <div class="notion-tooltip-title">${notion.title}</div>
            <div class="notion-tooltip-content">
                ${notion.description}
                ${notion.image ? `<div class="notion-tooltip-image">${notion.image}</div>` : ''}
                ${notion.example ? `<div class="notion-tooltip-example">ðŸŽ¬ ${notion.example}</div>` : ''}
            </div>
        `;
        document.body.appendChild(tooltip);
        
        // Positionner - d'abord rendre visible pour calculer dimensions
        tooltip.style.visibility = 'hidden';
        tooltip.style.display = 'block';
        
        const rect = e.target.getBoundingClientRect();
        const tooltipWidth = tooltip.offsetWidth;
        const tooltipHeight = tooltip.offsetHeight;
        const margin = 15;
        
        let top = rect.bottom + 10;
        let left = rect.left;
        
        // Ajuster si dÃ©passe Ã  droite
        if (left + tooltipWidth > window.innerWidth - margin) {
            left = window.innerWidth - tooltipWidth - margin;
        }
        // Ajuster si dÃ©passe Ã  gauche
        if (left < margin) {
            left = margin;
        }
        // Ajuster si dÃ©passe en bas - mettre au-dessus
        if (top + tooltipHeight > window.innerHeight - margin) {
            top = rect.top - tooltipHeight - 10;
        }
        // Ajuster si dÃ©passe en haut (aprÃ¨s avoir mis au-dessus)
        if (top < margin) {
            top = margin;
        }
        // Si vraiment trop grand, centrer verticalement
        if (tooltipHeight > window.innerHeight - 2 * margin) {
            top = margin;
            tooltip.style.maxHeight = (window.innerHeight - 2 * margin) + 'px';
            tooltip.style.overflowY = 'auto';
        }
        
        tooltip.style.top = top + 'px';
        tooltip.style.left = left + 'px';
        tooltip.style.visibility = 'visible';
        tooltip.classList.add('visible');
        
        // Garder le tooltip visible quand on le survole
        tooltip.addEventListener('mouseenter', () => {
            if (Courses.hideTimeout) {
                clearTimeout(Courses.hideTimeout);
            }
        });
        tooltip.addEventListener('mouseleave', () => {
            tooltip.remove();
        });
    },
    
    hideNotion: () => {
        const tooltip = document.querySelector('.notion-tooltip');
        if (tooltip) tooltip.remove();
    },
    
    hideTimeout: null,
    
    // Dictionnaire des notions avec descriptions dÃ©taillÃ©es
    notions: {
        // === VALEURS DE PLAN ===
        'plan-ensemble': {
            title: 'Plan d\'ensemble (PE)',
            description: `<p>Le plan d'ensemble est le plus large des plans cinÃ©matographiques. Il embrasse un vaste espace et situe l'action dans son environnement global.</p>
            <p>Ce plan Ã©tablit la <strong>gÃ©ographie</strong> d'une scÃ¨ne et donne au spectateur tous les repÃ¨res spatiaux nÃ©cessaires. Il rÃ©pond aux questions : OÃ¹ sommes-nous ? Quelle est l'atmosphÃ¨re du lieu ?</p>
            <p>Souvent utilisÃ© en ouverture de sÃ©quence (establishing shot), il permet de "poser le dÃ©cor" avant de resserrer sur les personnages.</p>`,
            image: `<img src="images/cours/plan-ensemble.jpeg" alt="Plan d'ensemble" class="w-full-r8">`,
            example: 'L\'ouverture de "Lawrence d\'Arabie" - le dÃ©sert immense Ã©crase le personnage.'
        },
        'plan-large': {
            title: 'Plan large / Plan de demi-ensemble (PL)',
            description: `<p>Le plan large montre les personnages en pied dans leur environnement, mais avec plus de proximitÃ© que le plan d'ensemble.</p>
            <p>Il permet de voir les <strong>interactions entre les personnages</strong> et leur espace, leurs dÃ©placements, leur gestuelle corporelle complÃ¨te.</p>
            <p>C'est le plan idÃ©al pour les scÃ¨nes de groupe, les chorÃ©graphies, ou pour montrer un personnage qui entre dans un lieu.</p>`,
            image: `<img src="images/cours/plan-large.jpeg" alt="Plan large" class="w-full-r8">`,
            example: 'Les duels dans les westerns de Sergio Leone.'
        },
        'plan-moyen': {
            title: 'Plan moyen (PM)',
            description: `<p>Le plan moyen cadre le personnage Ã  mi-cuisse, parfois appelÃ© "plan italien" car trÃ¨s utilisÃ© dans le cinÃ©ma nÃ©orÃ©aliste italien.</p>
            <p>Il Ã©tablit un <strong>Ã©quilibre</strong> entre le personnage et son environnement. On voit suffisamment le corps pour percevoir la gestuelle, tout en gardant le contexte spatial.</p>
            <p>C'est un plan de transition, souvent utilisÃ© pour les dialogues Ã  plusieurs personnages ou les scÃ¨nes de mouvement modÃ©rÃ©.</p>`,
            image: `<img src="images/cours/plan-moyen.jpeg" alt="Plan moyen" class="w-full-r8">`,
            example: 'Les scÃ¨nes de marche et discussion dans les films d\'Aaron Sorkin.'
        },
        'plan-americain': {
            title: 'Plan amÃ©ricain (PA)',
            description: `<p>Le plan amÃ©ricain cadre le personnage Ã  mi-cuisse, juste au-dessus des genoux. Son nom vient des westerns hollywoodiens oÃ¹ il permettait de voir le colt Ã  la ceinture.</p>
            <p>Ce plan offre une <strong>proximitÃ© accrue</strong> avec le personnage tout en conservant une partie de sa gestuelle corporelle. IdÃ©al pour les confrontations et les dialogues tendus.</p>
            <p>Il est lÃ©gÃ¨rement plus serrÃ© que le plan moyen et crÃ©e une prÃ©sence plus affirmÃ©e du personnage dans le cadre.</p>`,
            image: `<img src="images/cours/plan-americain.jpeg" alt="Plan amÃ©ricain" class="w-full-r8">`,
            example: 'Les face-Ã -face dans "Le Bon, la Brute et le Truand".'
        },
        'plan-rapproche': {
            title: 'Plan rapprochÃ© (PR)',
            description: `<p>Le plan rapprochÃ© cadre le personnage Ã  la poitrine ou aux Ã©paules. On distingue parfois le "plan rapprochÃ© taille" et le "plan rapprochÃ© poitrine".</p>
            <p>Ce plan crÃ©e une vÃ©ritable <strong>intimitÃ©</strong> avec le personnage. Les expressions du visage deviennent lisibles, les Ã©motions plus palpables.</p>
            <p>C'est le plan privilÃ©giÃ© pour les dialogues intimes, les rÃ©vÃ©lations, les moments d'Ã©motion. Le spectateur entre dans la sphÃ¨re personnelle du personnage.</p>`,
            image: `<img src="images/cours/plan-rapproche.jpeg" alt="Plan rapprochÃ©" class="w-full-r8">`,
            example: 'Les conversations entre Rick et Ilsa dans "Casablanca".'
        },
        'gros-plan': {
            title: 'Gros plan (GP)',
            description: `<p>Le gros plan isole le visage du personnage ou un objet significatif, remplissant la majeure partie du cadre.</p>
            <p>C'est le plan de l'<strong>Ã©motion pure</strong>. Chaque micro-expression devient visible : un frÃ©missement de paupiÃ¨re, une larme naissante, un sourire esquissÃ©.</p>
            <p>Le gros plan crÃ©e une connexion Ã©motionnelle intense avec le spectateur. Il est souvent rÃ©servÃ© aux moments clÃ©s pour ne pas perdre son impact.</p>`,
            image: `<img src="images/cours/gros-plan.jpeg" alt="Gros plan" class="w-full-r8">`,
            example: 'Le regard final d\'Antoine Doinel dans "Les 400 Coups".'
        },
        'tres-gros-plan': {
            title: 'TrÃ¨s gros plan / Insert (TGP)',
            description: `<p>Le trÃ¨s gros plan isole un dÃ©tail : un Å“il, une bouche, une main, un objet. Il extrait un fragment de rÃ©alitÃ© pour lui donner une importance capitale.</p>
            <p>Ce plan crÃ©e un effet de <strong>loupe dramatique</strong>. Il dirige impÃ©rativement l'attention du spectateur vers ce dÃ©tail et lui confÃ¨re une signification narrative.</p>
            <p>L'insert sur un objet (lettre, arme, clÃ©) est une variante narrative qui rÃ©vÃ¨le une information cruciale.</p>`,
            image: `<img src="images/cours/tres-gros-plan.jpeg" alt="TrÃ¨s gros plan" class="w-full-r8">`,
            example: 'L\'Å“il en ouverture de "Blade Runner" ou la douille dans "Il faut sauver le soldat Ryan".'
        },
        // === ANGLES ===
        'plongee': {
            title: 'PlongÃ©e',
            description: `<p>La camÃ©ra est placÃ©e au-dessus du sujet et regarde vers le bas. Cet angle Ã©crase le personnage, le diminue visuellement.</p>
            <p>La plongÃ©e traduit souvent la <strong>vulnÃ©rabilitÃ©</strong>, la soumission, l'infÃ©rioritÃ© ou l'Ã©crasement d'un personnage. Elle peut aussi reprÃ©senter le point de vue d'un personnage dominant.</p>
            <p>Plus l'angle est prononcÃ©, plus l'effet est dramatique. La plongÃ©e totale (90Â°) est parfois appelÃ©e "vue de Dieu".</p>`,
            image: `<img src="images/cours/plongee.jpeg" alt="PlongÃ©e" class="w-full-r8">`,
            example: 'Norman Bates vu d\'en haut aprÃ¨s le meurtre dans "Psychose".'
        },
        'contre-plongee': {
            title: 'Contre-plongÃ©e',
            description: `<p>La camÃ©ra est placÃ©e en dessous du sujet et regarde vers le haut. Cet angle grandit le personnage, lui confÃ¨re puissance et autoritÃ©.</p>
            <p>La contre-plongÃ©e traduit la <strong>domination</strong>, la menace, l'hÃ©roÃ¯sme ou la supÃ©rioritÃ©. Elle peut crÃ©er un sentiment d'intimidation chez le spectateur.</p>
            <p>C'est l'angle classique pour filmer les figures d'autoritÃ©, les monuments, ou les moments de triomphe.</p>`,
            image: `<img src="images/cours/contre-plongee.jpeg" alt="Contre-plongÃ©e" class="w-full-r8">`,
            example: 'Dark Vador dans toutes ses apparitions dans "Star Wars".'
        },
        'dutch-angle': {
            title: 'Dutch Angle (Angle nÃ©erlandais)',
            description: `<p>La camÃ©ra est inclinÃ©e sur son axe, crÃ©ant un horizon penchÃ©. Le monde semble basculer, perdre son Ã©quilibre.</p>
            <p>Le dutch angle traduit le <strong>dÃ©sÃ©quilibre psychologique</strong>, la folie, le malaise, l'Ã©trangetÃ©. Il signale que quelque chose ne va pas.</p>
            <p>Son nom vient d'une dÃ©formation de "Deutsch" (allemand), car cette technique Ã©tait populaire dans l'expressionnisme allemand des annÃ©es 1920.</p>`,
            image: `<img src="images/cours/dutch-angle.jpeg" alt="Dutch angle" class="w-full-r8">`,
            example: 'OmniprÃ©sent dans "Le TroisiÃ¨me Homme" et les films de Tim Burton.'
        },
        // === MOUVEMENTS ===
        'panoramique': {
            title: 'Panoramique',
            description: `<p>La camÃ©ra pivote sur son axe (horizontal ou vertical) sans se dÃ©placer. Elle "balaie" l'espace comme une tÃªte qui tourne.</p>
            <p>Le panoramique permet d'<strong>explorer un espace</strong>, de suivre un personnage en mouvement, ou de relier deux Ã©lÃ©ments dans le mÃªme plan.</p>
            <p>On distingue le panoramique horizontal (gauche-droite), vertical (haut-bas), et le panoramique filÃ© (trÃ¨s rapide, crÃ©ant un flou).</p>`,
            image: `<img src="images/cours/panoramique.jpeg" alt="Panoramique" class="w-full-r8">`,
            example: 'Les panoramiques contemplatifs sur les paysages dans les films de Terrence Malick.'
        },
        'travelling': {
            title: 'Travelling',
            description: `<p>La camÃ©ra se dÃ©place physiquement dans l'espace, gÃ©nÃ©ralement sur des rails, un chariot, ou tout autre support mobile.</p>
            <p>Le travelling crÃ©e une <strong>immersion dynamique</strong>. Il peut accompagner un personnage (travelling d'accompagnement), s'en approcher (travelling avant) ou s'en Ã©loigner (travelling arriÃ¨re).</p>
            <p>Le travelling latÃ©ral est particuliÃ¨rement efficace pour les scÃ¨nes de dialogue en marche ou pour rÃ©vÃ©ler progressivement un dÃ©cor.</p>`,
            image: `<img src="images/cours/travelling.jpeg" alt="Travelling" class="w-full-r8">`,
            example: 'Le travelling arriÃ¨re infini dans "Les Affranchis" (scÃ¨ne du Copacabana).'
        },
        'steadicam': {
            title: 'Steadicam',
            description: `<p>SystÃ¨me de stabilisation portÃ© par l'opÃ©rateur, permettant des mouvements fluides et libres impossibles sur rails.</p>
            <p>Le Steadicam offre une <strong>fluiditÃ© onirique</strong> tout en permettant de suivre les acteurs dans des espaces complexes (escaliers, foules, couloirs).</p>
            <p>InventÃ© par Garrett Brown en 1975, il a rÃ©volutionnÃ© le cinÃ©ma en permettant des plans-sÃ©quences mobiles d'une fluiditÃ© inÃ©dite.</p>`,
            image: `<img src="images/cours/steadicam.jpeg" alt="Steadicam" class="w-full-r8">`,
            example: 'La poursuite dans les couloirs de l\'Overlook Hotel dans "Shining".'
        },
        'zoom': {
            title: 'Zoom',
            description: `<p>Changement de focale optique qui rapproche ou Ã©loigne le sujet sans dÃ©placer la camÃ©ra. Contrairement au travelling, il modifie la perspective.</p>
            <p>Le zoom est souvent considÃ©rÃ© comme moins "cinÃ©matographique" que le travelling car il <strong>aplatit l'image</strong>. Mais utilisÃ© intentionnellement, il peut crÃ©er des effets puissants.</p>
            <p>Le zoom rapide Ã©tait caractÃ©ristique des annÃ©es 70 (films de kung-fu, gialli italiens). Il connaÃ®t un renouveau ironique ou stylistique.</p>`,
            image: `<img src="images/cours/zoom.jpeg" alt="Zoom" class="w-full-r8">`,
            example: 'Les zooms brutaux de Quentin Tarantino en hommage aux films d\'exploitation.'
        },
        'vertigo-effect': {
            title: 'Effet Vertigo (Dolly Zoom)',
            description: `<p>Combinaison d'un travelling et d'un zoom en sens inverse. La camÃ©ra avance pendant que l'objectif dÃ©zoome (ou l'inverse).</p>
            <p>Le sujet garde la mÃªme taille mais le fond semble s'Ã©tirer ou se comprimer, crÃ©ant un effet de <strong>vertige et de dissociation</strong>.</p>
            <p>InventÃ© par Irmin Roberts pour "Vertigo" d'Hitchcock (1958), il traduit visuellement le malaise, la prise de conscience brutale, ou le choc Ã©motionnel.</p>`,
            image: `<img src="images/cours/vertigo-effect.jpeg" alt="Effet Vertigo" class="w-full-r8">`,
            example: 'La scÃ¨ne du clocher dans "Vertigo" et la plage dans "Les Dents de la Mer".'
        },
        // === IMAGE - COMPOSITION ===
        'regle-tiers': {
            title: 'RÃ¨gle des tiers',
            description: `<p>Principe de composition divisant l'image en 9 zones Ã©gales par 2 lignes horizontales et 2 verticales.</p>
            <p>Les Ã©lÃ©ments importants (visage, horizon, sujet principal) gagnent en <strong>dynamisme</strong> lorsqu'ils sont placÃ©s sur ces lignes ou Ã  leurs intersections, appelÃ©es "points forts".</p>
            <p>Centrer le sujet crÃ©e une image statique ; le dÃ©centrer selon la rÃ¨gle des tiers crÃ©e tension et mouvement.</p>`,
            image: `<img src="images/cours/regle-tiers.jpeg" alt="RÃ¨gle des tiers" class="w-full-r8">`,
            example: 'Quasi tous les grands directeurs photo utilisent cette rÃ¨gle comme base.'
        },
        'profondeur-champ': {
            title: 'Profondeur de champ',
            description: `<p>Zone de nettetÃ© devant et derriÃ¨re le point de mise au point. Peut Ãªtre courte (flou d'arriÃ¨re-plan) ou grande (tout net).</p>
            <p>Une <strong>faible profondeur</strong> isole le sujet et crÃ©e de l'intimitÃ©. Une <strong>grande profondeur</strong> permet de voir tous les plans simultanÃ©ment.</p>
            <p>ContrÃ´lÃ©e par l'ouverture (f/1.4 = faible, f/16 = grande), la focale et la distance au sujet.</p>`,
            image: `<img src="images/cours/profondeur-champ.jpeg" alt="Profondeur de champ" class="w-full-r8">`,
            example: 'Wong Kar-wai utilise une trÃ¨s faible profondeur pour crÃ©er l intimitÃ©.'
        },
        'key-light': {
            title: 'Key Light (LumiÃ¨re principale)',
            description: `<p>Source lumineuse principale qui dÃ©finit la direction et la qualitÃ© de l'Ã©clairage d'une scÃ¨ne.</p>
            <p>C'est elle qui crÃ©e les <strong>ombres principales</strong> et donne le "caractÃ¨re" Ã  l'image. Sa position dÃ©termine le modelÃ© du visage.</p>
            <p>GÃ©nÃ©ralement placÃ©e Ã  45Â° du sujet (horizontalement et verticalement), mais peut varier selon l'effet recherchÃ©.</p>`,
            image: `<img src="images/cours/key-light.jpeg" alt="Key Light" class="w-full-r8">`,
            example: 'Position classique "Rembrandt" Ã  45Â° pour les portraits.'
        },
        'fill-light': {
            title: 'Fill Light (LumiÃ¨re de remplissage)',
            description: `<p>Source secondaire qui adoucit les ombres crÃ©Ã©es par la Key Light, sans les Ã©liminer complÃ¨tement.</p>
            <p>ContrÃ´le le <strong>ratio de contraste</strong> : plus elle est forte, plus l'image est douce. Absente, les ombres sont noires (low-key).</p>
            <p>Souvent placÃ©e du cÃ´tÃ© opposÃ© Ã  la Key, peut Ãªtre un rÃ©flecteur plutÃ´t qu'une vraie source.</p>`,
            image: `<img src="images/cours/fill-light.jpeg" alt="Fill Light" class="w-full-r8">`,
            example: 'Un ratio Key:Fill de 2:1 donne un look naturel.'
        },
        'back-light': {
            title: 'Back Light (Contre-jour)',
            description: `<p>LumiÃ¨re placÃ©e derriÃ¨re le sujet qui crÃ©e un liserÃ© lumineux sur les contours, sÃ©parant le sujet du fond.</p>
            <p>Apporte <strong>profondeur et relief</strong> Ã  l'image. Sans elle, le sujet peut se "fondre" dans l'arriÃ¨re-plan.</p>
            <p>Aussi appelÃ©e "rim light" ou "hair light" quand elle Ã©claire spÃ©cifiquement les cheveux.</p>`,
            image: `<img src="images/cours/back-light.jpeg" alt="Back Light" class="w-full-r8">`,
            example: 'Indispensable dans les interviews pour dÃ©coller le sujet du fond.'
        },
        'high-key': {
            title: 'Ã‰clairage High-Key',
            description: `<p>Style d'Ã©clairage uniforme et lumineux avec trÃ¨s peu d'ombres. L'image est globalement claire.</p>
            <p>CrÃ©e une atmosphÃ¨re <strong>lÃ©gÃ¨re, optimiste, accessible</strong>. AssociÃ© aux comÃ©dies, sitcoms, publicitÃ©s, clips pop.</p>
            <p>NÃ©cessite beaucoup de fill light pour Ã©liminer les ombres. Ratio Key:Fill proche de 1:1.</p>`,
            image: `<img src="images/cours/high-key.jpeg" alt="High-Key" class="w-full-r8">`,
            example: 'Les comÃ©dies romantiques, les pubs de cosmÃ©tiques.'
        },
        'low-key': {
            title: 'Ã‰clairage Low-Key',
            description: `<p>Style d'Ã©clairage contrastÃ© avec des ombres profondes et des zones sombres dominantes.</p>
            <p>CrÃ©e une atmosphÃ¨re <strong>dramatique, mystÃ©rieuse, menaÃ§ante</strong>. Signature du film noir, thriller, horreur.</p>
            <p>Peu ou pas de fill light. Les ombres sont noires, les sources souvent hors-champ.</p>`,
            image: `<img src="images/cours/low-key.jpeg" alt="Low-Key" class="w-full-r8">`,
            example: 'Film noir, Se7en, Blade Runner, Le Parrain.'
        },
        'magic-hour': {
            title: 'Magic Hour (Heure dorÃ©e)',
            description: `<p>PÃ©riode juste aprÃ¨s le lever ou avant le coucher du soleil oÃ¹ la lumiÃ¨re est dorÃ©e, douce et directionnelle.</p>
            <p>Produit une lumiÃ¨re <strong>naturellement flatteuse</strong> avec des ombres longues et une qualitÃ© "magique" impossible Ã  reproduire artificiellement.</p>
            <p>FenÃªtre de tournage trÃ¨s courte (20-40 min). Demande une prÃ©paration minutieuse.</p>`,
            image: `<img src="images/cours/magic-hour.jpeg" alt="Magic Hour" class="w-full-r8">`,
            example: 'Terrence Malick (Days of Heaven, The Tree of Life) tourne quasi exclusivement en magic hour.'
        },
        // === IMAGE - OPTIQUES ===
        'focale-courte': {
            title: 'Focale courte (Grand-angle)',
            description: `<p>Objectif de 16-35mm qui offre un champ de vision large et exagÃ¨re les perspectives.</p>
            <p>Les objets proches paraissent <strong>plus grands</strong>, les distances semblent <strong>Ã©tirÃ©es</strong>. DÃ©forme les bords de l'image.</p>
            <p>IdÃ©al pour : espaces confinÃ©s, sentiment d'oppression, immensitÃ© des paysages, effets comiques (visage dÃ©formÃ©).</p>`,
            image: `<img src="images/cours/focale-courte.jpeg" alt="Focale courte" class="w-full-r8">`,
            example: 'Kubrick dans Orange MÃ©canique, les scÃ¨nes de poursuite de Mad Max.'
        },
        'focale-longue': {
            title: 'Focale longue (TÃ©lÃ©objectif)',
            description: `<p>Objectif de 85-200mm+ qui compresse les distances et isole le sujet avec un fort flou d'arriÃ¨re-plan.</p>
            <p>Les plans semblent <strong>rapprochÃ©s</strong> les uns des autres. CrÃ©e une sensation d'<strong>intimitÃ©</strong> ou d'<strong>Ã©crasement</strong>.</p>
            <p>IdÃ©al pour : portraits, isoler un sujet dans une foule, crÃ©er une sensation de surveillance ou filature.</p>`,
            image: `<img src="images/cours/focale-longue.jpeg" alt="Focale longue" class="w-full-r8">`,
            example: 'Les portraits de Gordon Willis dans Le Parrain.'
        },
        'anamorphique': {
            title: 'Objectif anamorphique',
            description: `<p>Optique spÃ©ciale qui compresse l'image horizontalement Ã  la prise de vue, puis l'Ã©tire Ã  la projection.</p>
            <p>Produit le format <strong>CinemaScope 2.39:1</strong>, des flares horizontaux caractÃ©ristiques et un bokeh ovale.</p>
            <p>ConsidÃ©rÃ© comme le "look cinÃ©ma" par excellence. Plus coÃ»teux et complexe Ã  utiliser.</p>`,
            image: `<img src="images/cours/anamorphique.jpeg" alt="Anamorphique" class="w-full-r8">`,
            example: 'Blade Runner 2049, Star Wars, La La Land.'
        },
        // === IMAGE - RATIOS ===
        'grue-jib': {
            title: 'Grue / Jib',
            description: `<p>Dispositif mÃ©canique permettant des mouvements de camÃ©ra verticaux amples et fluides.</p>
            <p>La <strong>grue</strong> peut porter l'opÃ©rateur, le <strong>jib</strong> est tÃ©lÃ©commandÃ©. Permet des mouvements impossibles autrement.</p>
            <p>IdÃ©al pour les rÃ©vÃ©lations spectaculaires, les survols, les mouvements du sol au ciel.</p>`,
            image: `<img src="images/cours/grue-jib.jpeg" alt="Grue / Jib" class="w-full-r8">`,
            example: 'Le plan final de La Haine, les survols de foule.'
        },
        'chiaroscuro': {
            title: 'Chiaroscuro (Clair-obscur)',
            description: `<p>Technique d'Ã©clairage inspirÃ©e de la peinture baroque (Caravage, Rembrandt) utilisant des contrastes extrÃªmes.</p>
            <p>Des zones de <strong>lumiÃ¨re intense</strong> cÃ´toient des <strong>ombres profondes</strong>, crÃ©ant un effet dramatique et sculptural.</p>
            <p>Renforce le mystÃ¨re, la tension, la dimension psychologique des personnages.</p>`,
            image: `<img src="images/cours/chiaroscuro.jpeg" alt="Chiaroscuro" class="w-full-r8">`,
            example: 'Le Parrain, Blade Runner, les films de Fincher.'
        },
        'rembrandt-lighting': {
            title: 'Ã‰clairage Rembrandt',
            description: `<p>Technique de portrait oÃ¹ la lumiÃ¨re crÃ©e un triangle lumineux sous l'Å“il du cÃ´tÃ© ombrÃ© du visage.</p>
            <p>NommÃ© d'aprÃ¨s le peintre qui utilisait ce motif. ConsidÃ©rÃ© comme l'<strong>Ã©clairage portrait classique</strong> par excellence.</p>
            <p>La key light est placÃ©e Ã  45Â° en hauteur et sur le cÃ´tÃ©, crÃ©ant ce triangle caractÃ©ristique.</p>`,
            image: `<img src="images/cours/rembrandt-lighting.jpeg" alt="Ã‰clairage Rembrandt" class="w-full-r8">`,
            example: 'Portraits classiques, interviews cinÃ©ma.'
        },
        'lumiere-pratique': {
            title: 'LumiÃ¨re pratique',
            description: `<p>Source de lumiÃ¨re visible Ã  l'Ã©cran : lampes, bougies, nÃ©ons, Ã©crans, phares de voiture.</p>
            <p>Justifie la lumiÃ¨re de la scÃ¨ne de maniÃ¨re <strong>diÃ©gÃ©tique</strong> (dans l'univers du film).</p>
            <p>Souvent renforcÃ©e par des sources cachÃ©es car les pratiques seules sont rarement suffisantes.</p>`,
            image: `<img src="images/cours/lumiere-pratique.jpeg" alt="LumiÃ¨re pratique" class="w-full-r8">`,
            example: 'Barry Lyndon (bougies), Taxi Driver (nÃ©ons).'
        },
        'temperature-couleur': {
            title: 'TempÃ©rature de couleur',
            description: `<p>Mesure en Kelvin (K) de la teinte d'une source lumineuse, du chaud (orange) au froid (bleu).</p>
            <p><strong>2700-3200K</strong> = tungstÃ¨ne, bougie (chaud). <strong>5500-6500K</strong> = lumiÃ¨re du jour (neutre Ã  froid).</p>
            <p>MÃ©langer des sources de tempÃ©ratures diffÃ©rentes crÃ©e des dominantes colorÃ©es (voulues ou non).</p>`,
            image: `<img src="images/cours/temperature-couleur.jpeg" alt="TempÃ©rature de couleur" class="w-full-r8">`,
            example: 'MÃ©lange tungstÃ¨ne/daylight dans les scÃ¨nes intÃ©rieur/fenÃªtre.'
        },
        'ratio-scope': {
            title: 'Format Scope (2.39:1)',
            description: `<p>Format cinÃ©matographique ultra-large, aussi appelÃ© CinemaScope ou Panavision.</p>
            <p>IdÃ©al pour les <strong>paysages Ã©piques</strong>, les westerns, la science-fiction. Permet de composer avec beaucoup d'espace horizontal.</p>
            <p>Peut crÃ©er un sentiment d'isolement quand un personnage seul occupe ce format large.</p>`,
            image: `<img src="images/cours/ratio-scope.jpeg" alt="Format Scope" class="w-full-r8">`,
            example: 'Lawrence d Arabie, Dune, les westerns de Leone.'
        },
        'ratio-185': {
            title: 'Format 1.85:1',
            description: `<p>Format standard du cinÃ©ma amÃ©ricain depuis les annÃ©es 50. Plus large que le 16:9 TV.</p>
            <p>Bon <strong>compromis</strong> entre l'intimitÃ© du 4:3 et l'ampleur du Scope. Polyvalent pour tous les genres.</p>
            <p>Souvent appelÃ© "Flat" par opposition au "Scope".</p>`,
            example: 'La majoritÃ© des films amÃ©ricains : Spielberg, Nolan (hors IMAX).'
        },
        'ratio-imax': {
            title: 'Format IMAX (1.43:1)',
            description: `<p>Format gÃ©ant dÃ©veloppÃ© pour les Ã©crans IMAX, presque carrÃ©, offrant une immersion maximale.</p>
            <p>Utilise des pellicules ou capteurs beaucoup plus grands que le 35mm standard. RÃ©solution et dÃ©tails exceptionnels.</p>
            <p>Certains films alternent entre IMAX et Scope selon les scÃ¨nes (Nolan, Villeneuve).</p>`,
            image: `<img src="images/cours/ratio-imax.jpeg" alt="Format IMAX" class="w-full-r8">`,
            example: 'Dunkirk, Oppenheimer, Interstellar (sÃ©quences IMAX).'
        },
        'cadre-ferme': {
            title: 'Cadre fermÃ©',
            description: `<p>Composition oÃ¹ des Ã©lÃ©ments du dÃ©cor (portes, fenÃªtres, barreaux) encadrent et "emprisonnent" le sujet.</p>
            <p>CrÃ©e un sentiment d'<strong>oppression, d'enfermement, de piÃ¨ge</strong>. Le personnage semble coincÃ©.</p>
            <p>Contraste avec le cadre ouvert qui suggÃ¨re la libertÃ© et les possibilitÃ©s.</p>`,
            image: `<img src="images/cours/cadre-ferme.jpeg" alt="Cadre fermÃ©" class="w-full-r8">`,
            example: 'Les plans Ã  travers les barreaux dans Le Silence des Agneaux.'
        },
        'cadre-ouvert': {
            title: 'Cadre ouvert',
            description: `<p>Composition oÃ¹ le personnage dispose d'espace pour "sortir" du cadre, suggÃ©rant libertÃ© et possibilitÃ©s.</p>
            <p>Le regard ou le mouvement du personnage indique un <strong>hors-champ accessible</strong>.</p>
            <p>CrÃ©e une dynamique, une invitation au mouvement, un sentiment d'ouverture.</p>`,
            image: `<img src="images/cours/cadre-ouvert.jpeg" alt="Cadre ouvert" class="w-full-r8">`,
            example: 'Plans larges de westerns, fins ouvertes.'
        },
        'log-raw': {
            title: 'LOG / RAW',
            description: `<p>Profils d'enregistrement qui capturent un maximum d'informations pour l'Ã©talonnage en post-production.</p>
            <p><strong>LOG</strong> : image plate et dÃ©saturÃ©e, prÃ©serve les hautes et basses lumiÃ¨res. <strong>RAW</strong> : donnÃ©es brutes du capteur.</p>
            <p>NÃ©cessite un Ã©talonnage obligatoire mais offre une flexibilitÃ© crÃ©ative maximale.</p>`,
            image: `<img src="images/cours/log-raw.jpeg" alt="LOG / RAW" class="w-full-r8">`,
            example: 'Standard sur toutes les productions cinÃ©ma actuelles.'
        },
        'lut': {
            title: 'LUT (Look-Up Table)',
            description: `<p>Fichier de transformation colorimÃ©trique appliquant un "look" prÃ©dÃ©fini Ã  l'image.</p>
            <p><strong>LUT technique</strong> : convertit LOG vers un espace standard. <strong>LUT crÃ©ative</strong> : applique un style (film, vintage, etc.).</p>
            <p>Permet de prÃ©visualiser le rendu final sur le plateau et d'accÃ©lÃ©rer l'Ã©talonnage.</p>`,
            example: 'Rec709, Cineon, looks "Teal & Orange".'
        },
        'ratio-43': {
            title: 'Format 4:3 (1.33:1)',
            description: `<p>Format "Academy" classique, aussi format de la tÃ©lÃ©vision ancienne. Presque carrÃ©.</p>
            <p>Ressenti <strong>intime, rÃ©tro, claustrophobe</strong>. RedÃ©couvert par des cinÃ©astes contemporains pour son caractÃ¨re distinctif.</p>
            <p>Force Ã  des compositions plus verticales, met l'accent sur les visages.</p>`,
            example: 'The Lighthouse, Elephant de Van Sant, First Reformed.'
        },
        // === IMAGE - CADRE NARRATIF ===
        'hors-champ': {
            title: 'Hors-champ',
            description: `<p>Tout ce qui existe dans l'univers du film mais n'est pas visible dans le cadre Ã  un moment donnÃ©.</p>
            <p>Outil narratif <strong>puissant</strong> : ce qu'on ne voit pas peut Ãªtre plus effrayant/intrigant que ce qu'on montre.</p>
            <p>Le regard d'un personnage, un son, une ombre peuvent suggÃ©rer une prÃ©sence hors-champ.</p>`,
            image: `<img src="images/cours/hors-champ.jpeg" alt="Hors-champ" class="w-full-r8">`,
            example: 'Alien - le monstre reste hors-champ la majoritÃ© du film.'
        },
        'amorce': {
            title: 'Amorce',
            description: `<p>Ã‰lÃ©ment (souvent flou) placÃ© au premier plan du cadre, partiellement visible, qui crÃ©e de la profondeur.</p>
            <p>Donne une sensation de <strong>voyeurisme</strong>, d'espionnage, ou simplement de profondeur spatiale.</p>
            <p>Souvent une Ã©paule, une tÃªte, un objet. FrÃ©quent dans les champs/contre-champs.</p>`,
            image: `<img src="images/cours/amorce.jpeg" alt="Amorce" class="w-full-r8">`,
            example: 'Quasi tous les champs/contre-champs utilisent des amorces.'
        },
        'surcadrage': {
            title: 'Surcadrage',
            description: `<p>Technique de composition oÃ¹ un cadre dans l'image (porte, fenÃªtre, miroir) encadre le sujet.</p>
            <p>CrÃ©e une <strong>mise en abyme</strong>, isole le personnage, peut suggÃ©rer l'enfermement ou le voyeurisme.</p>
            <p>TrÃ¨s utilisÃ© par John Ford (portes) et Wong Kar-wai (fenÃªtres, miroirs).</p>`,
            image: `<img src="images/cours/surcadrage.jpeg" alt="Surcadrage" class="w-full-r8">`,
            example: 'In the Mood for Love, La PrisonniÃ¨re du dÃ©sert (plan final).'
        },
        // === SON - MICROPHONES ===
        'micro-canon': {
            title: 'Micro canon (Shotgun)',
            description: `<p>Microphone trÃ¨s directionnel en forme de tube, conÃ§u pour capter le son dans un angle Ã©troit devant lui.</p>
            <p>IdÃ©al pour <strong>isoler une source</strong> (voix d'un acteur) tout en rejetant les sons latÃ©raux et arriÃ¨re.</p>
            <p>MontÃ© sur une perche tenue par le perchiste, il doit pointer vers la bouche de l'acteur, gÃ©nÃ©ralement par-dessus.</p>`,
            example: 'Standard sur tous les plateaux professionnels.'
        },
        'micro-cravate': {
            title: 'Micro cravate (Lavalier)',
            description: `<p>Microphone miniature omnidirectionnel qui se fixe sur le vÃªtement de l'acteur, prÃ¨s de la poitrine.</p>
            <p>Avantage : <strong>discret et sÃ©curisant</strong> (toujours Ã  distance constante). InconvÃ©nient : risque de frottements, son moins naturel.</p>
            <p>Souvent utilisÃ© en backup du micro perche, ou quand la perche ne peut pas atteindre l'acteur (plan large).</p>`,
            example: 'Indispensable pour les interviews et documentaires.'
        },
        // === SON - COUCHES SONORES ===
        'foley': {
            title: 'Foley (Bruitage)',
            description: `<p>Art de recrÃ©er en studio les sons synchrones du quotidien : pas, vÃªtements, manipulations d'objets.</p>
            <p>NommÃ© d'aprÃ¨s <strong>Jack Foley</strong>, pionnier de la technique Ã  Universal dans les annÃ©es 1920.</p>
            <p>Le bruiteur (foley artist) regarde l'image et reproduit les sons en temps rÃ©el avec des accessoires variÃ©s.</p>`,
            example: 'Ben Burtt a crÃ©Ã© le son de R2-D2 et le sabre laser.'
        },
        'ambiance-son': {
            title: 'Ambiance sonore (Room Tone)',
            description: `<p>Son continu caractÃ©ristique d'un lieu : rumeur de ville, vent, forÃªt, bourdonnement d'intÃ©rieur.</p>
            <p>Indispensable pour <strong>crÃ©er l'espace sonore</strong> et assurer la continuitÃ© entre les plans d'une mÃªme scÃ¨ne.</p>
            <p>On enregistre toujours 1-2 minutes de "silence" de chaque lieu pour avoir de l'ambiance de raccord.</p>`,
            example: 'Le bourdonnement oppressant dans No Country for Old Men.'
        },
        // === SON - DIÃ‰GÃˆSE ===
        'son-diegetique': {
            title: 'Son diÃ©gÃ©tique',
            description: `<p>Son dont la source existe dans l'univers du film et que les personnages peuvent entendre.</p>
            <p>Exemples : radio Ã  l'Ã©cran, musicien qui joue, dialogue, bruit de pas, klaxon dans la rue.</p>
            <p>Ancre le spectateur dans la <strong>rÃ©alitÃ© de la fiction</strong> et renforce l'immersion.</p>`,
            example: 'La radio dans le taxi de Travis Bickle (Taxi Driver).'
        },
        'son-extra-diegetique': {
            title: 'Son extra-diÃ©gÃ©tique',
            description: `<p>Son ajoutÃ© au film que les personnages n'entendent pas : musique de score, voix-off narrative.</p>
            <p>S'adresse <strong>directement au spectateur</strong>, guide ses Ã©motions, commente l'action.</p>
            <p>Outil puissant mais son usage excessif peut devenir manipulateur ou envahissant.</p>`,
            example: 'La musique de John Williams dans Star Wars.'
        },
        // === SON - SOUND DESIGN ===
        'worldizing': {
            title: 'Worldizing',
            description: `<p>Technique inventÃ©e par Walter Murch consistant Ã  rejouer un son dans un espace rÃ©el et le rÃ©enregistrer.</p>
            <p>Donne au son les <strong>caractÃ©ristiques acoustiques</strong> d'un lieu : rÃ©verbÃ©ration, filtrage, coloration.</p>
            <p>Plus organique que les reverbs numÃ©riques car capture la vraie physique du son dans l'espace.</p>`,
            example: 'UtilisÃ© pour les voix radio dans Apocalypse Now.'
        },
        'layering': {
            title: 'Layering (Superposition)',
            description: `<p>Technique de sound design consistant Ã  superposer plusieurs sons pour en crÃ©er un nouveau, unique.</p>
            <p>Un son de monstre peut combiner : cri animal, mÃ©tal, voix humaine ralentie, grondement...</p>
            <p>Permet de crÃ©er des sons <strong>inÃ©dits et Ã©vocateurs</strong> qui n'existent pas dans la rÃ©alitÃ©.</p>`,
            example: 'Le T-Rex de Jurassic Park = bÃ©bÃ© Ã©lÃ©phant + alligator + tigre.'
        },
        // === SON - FORMATS ===
        'surround-51': {
            title: '5.1 Surround',
            description: `<p>Format audio standard du cinÃ©ma avec 6 canaux : 5 enceintes + 1 caisson de basses (LFE).</p>
            <p>Configuration : Gauche, Centre, Droite (devant) + Surround Gauche, Surround Droite (arriÃ¨re) + Subwoofer.</p>
            <p>Permet de <strong>placer les sons dans l'espace</strong> autour du spectateur pour une immersion totale.</p>`,
            example: 'Standard depuis Toy Story (1995) et Saving Private Ryan.'
        },
        'surround-51': {
            title: '5.1 Surround',
            description: `<p>Format audio standard du cinÃ©ma avec 6 canaux : 5 enceintes + 1 caisson de basses (LFE).</p>
            <p>Configuration : Gauche, Centre, Droite (devant) + Surround Gauche, Surround Droite (arriÃ¨re) + Subwoofer.</p>
            <p>Permet de <strong>placer les sons dans l'espace</strong> autour du spectateur pour une immersion totale.</p>`,
            example: 'Standard depuis Toy Story (1995) et Saving Private Ryan.'
        },
        'meta-diegetique': {
            title: 'Son mÃ©ta-diÃ©gÃ©tique',
            description: `<p>Son subjectif reprÃ©sentant l'intÃ©rioritÃ© d'un personnage : pensÃ©es, souvenirs, hallucinations.</p>
            <p>Le personnage l'entend mais pas les autres : <strong>acouphÃ¨ne, battement de cÅ“ur, voix intÃ©rieure, flashback sonore</strong>.</p>
            <p>Permet d'accÃ©der Ã  la psychologie du personnage de maniÃ¨re immersive.</p>`,
            example: 'L acouphÃ¨ne aprÃ¨s l explosion dans Saving Private Ryan.'
        },
        'wild-tracks': {
            title: 'Wild Tracks',
            description: `<p>Enregistrements sonores rÃ©alisÃ©s sans image, captant ambiances, effets ou dialogues sÃ©parÃ©ment.</p>
            <p>Permet de <strong>complÃ©ter la bande-son</strong> en post-production avec des sons propres et isolÃ©s.</p>
            <p>L'ingÃ©nieur du son profite des pauses pour enregistrer l'ambiance du lieu, des sons spÃ©cifiques.</p>`,
            example: 'Ambiances de rue, bruits de machines, room tone.'
        },
        'pitch-shifting': {
            title: 'Pitch Shifting',
            description: `<p>Modification de la hauteur (frÃ©quence) d'un son sans changer sa durÃ©e, ou inversement.</p>
            <p>Ralentir un son le rend plus <strong>grave et menaÃ§ant</strong>. L'accÃ©lÃ©rer le rend aigu et Ã©nergique.</p>
            <p>Technique fondamentale du sound design pour crÃ©er des sons de crÃ©atures, monstres, vaisseaux.</p>`,
            example: 'Le T-Rex (bÃ©bÃ© Ã©lÃ©phant ralenti), Godzilla.'
        },
        'leitmotiv-sonore': {
            title: 'Leitmotiv sonore',
            description: `<p>Son ou motif musical rÃ©current associÃ© Ã  un personnage, un lieu, une Ã©motion ou un thÃ¨me.</p>
            <p>CrÃ©e une <strong>association pavlovienne</strong> : le spectateur reconnaÃ®t le motif et anticipe.</p>
            <p>Peut Ãªtre subtil (texture, frÃ©quence) ou Ã©vident (thÃ¨me musical complet).</p>`,
            example: 'La Marche ImpÃ©riale (Vader), le thÃ¨me des Dents de la Mer.'
        },
        'micro-omni': {
            title: 'Micro omnidirectionnel',
            description: `<p>Microphone captant le son de maniÃ¨re Ã©gale dans toutes les directions (360Â°).</p>
            <p>IdÃ©al pour les <strong>ambiances</strong>, les enregistrements d'ensemble, ou quand la direction change constamment.</p>
            <p>Moins sensible aux bruits de manipulation mais capte aussi les sons indÃ©sirables environnants.</p>`,
            example: 'Enregistrement d ambiances, micros cravate.'
        },
        'double-systeme': {
            title: 'Double systÃ¨me',
            description: `<p>Enregistrement du son sur un appareil sÃ©parÃ© de la camÃ©ra (enregistreur externe type Sound Devices).</p>
            <p>QualitÃ© <strong>professionnelle supÃ©rieure</strong> aux prÃ©amplis intÃ©grÃ©s des camÃ©ras. Standard sur les tournages pro.</p>
            <p>NÃ©cessite une synchronisation en post (clap, timecode). Le son camÃ©ra sert de rÃ©fÃ©rence.</p>`,
            example: 'Standard sur tous les tournages cinÃ©ma.'
        },
        'ducking': {
            title: 'Ducking',
            description: `<p>Technique de mixage oÃ¹ un signal audio baisse automatiquement quand un autre est prÃ©sent.</p>
            <p>Usage classique : la <strong>musique baisse sous les dialogues</strong> puis remonte quand ils s'arrÃªtent.</p>
            <p>Peut Ãªtre fait manuellement ou via un compresseur side-chain en temps rÃ©el.</p>`,
            example: 'Toutes les scÃ¨nes dialogue + musique au cinÃ©ma.'
        },
        'stems': {
            title: 'Stems (PrÃ©mix)',
            description: `<p>Groupes de pistes audio sÃ©parÃ©s par catÃ©gorie : Dialogues (DX), Musique (MX), Effets (FX).</p>
            <p>Permet de crÃ©er des <strong>versions internationales</strong> (VI) en remplaÃ§ant uniquement les dialogues.</p>
            <p>Livrables essentiels pour la distribution : le mixage final peut Ãªtre reconstituÃ© depuis les stems.</p>`,
            example: 'Livrable obligatoire pour toute distribution internationale.'
        },
        'dolby-atmos': {
            title: 'Dolby Atmos',
            description: `<p>Format audio immersif basÃ© sur des "objets sonores" positionnables en 3D, incluant le plafond.</p>
            <p>Contrairement au 5.1/7.1 basÃ© sur des canaux, Atmos place chaque son prÃ©cisÃ©ment dans l'espace <strong>x, y, z</strong>.</p>
            <p>Permet des effets de survol, de pluie tombant du plafond, de son qui se dÃ©place avec prÃ©cision.</p>`,
            example: 'Gravity, Blade Runner 2049, Dune.'
        },
        // === MONTAGE - RACCORDS ===
        'raccord-regard': {
            title: 'Raccord regard',
            description: `<p>Technique de montage oÃ¹ l'on montre d'abord un personnage qui regarde, puis ce qu'il voit.</p>
            <p>CrÃ©e un lien <strong>psychologique</strong> entre le spectateur et le personnage : on partage son point de vue.</p>
            <p>Le regard doit Ãªtre cohÃ©rent en direction : s'il regarde Ã  droite, l'objet doit "venir" de la gauche.</p>`,
            example: 'Hitchcock Ã©tait maÃ®tre du raccord regard (FenÃªtre sur cour).'
        },
        'match-cut': {
            title: 'Match Cut',
            description: `<p>Raccord qui relie deux plans par une similaritÃ© visuelle : forme, mouvement, couleur ou composition.</p>
            <p>CrÃ©e une <strong>transition poÃ©tique</strong> et peut suggÃ©rer un lien thÃ©matique entre deux Ã©lÃ©ments distincts.</p>
            <p>Souvent utilisÃ© pour les ellipses temporelles ou les associations d'idÃ©es.</p>`,
            example: '2001 de Kubrick : l os prÃ©historique â†’ station spatiale.'
        },
        'jump-cut': {
            title: 'Jump Cut',
            description: `<p>Coupe entre deux plans trÃ¨s similaires du mÃªme sujet, crÃ©ant un "saut" visuel perturbant.</p>
            <p>Traditionnellement considÃ©rÃ© comme une <strong>erreur</strong>, il est devenu un outil stylistique depuis la Nouvelle Vague.</p>
            <p>Exprime l'urgence, le passage du temps, l'instabilitÃ© mentale, ou brise volontairement l'illusion.</p>`,
            example: 'Godard dans Ã€ bout de souffle - rÃ©volution stylistique.'
        },
        'champ-contrechamp': {
            title: 'Champ / Contre-champ',
            description: `<p>Alternance entre deux points de vue opposÃ©s, typiquement lors d'un dialogue entre deux personnages.</p>
            <p>Technique <strong>fondamentale</strong> du cinÃ©ma narratif. Chaque personnage est filmÃ© sÃ©parÃ©ment regardant vers l'autre.</p>
            <p>Doit respecter la rÃ¨gle des 180Â° pour maintenir la cohÃ©rence spatiale.</p>`,
            example: 'PrÃ©sent dans 90% des scÃ¨nes de dialogue au cinÃ©ma.'
        },
        // === MONTAGE - THÃ‰ORIES ===
        'effet-koulechov': {
            title: 'Effet Koulechov',
            description: `<p>ExpÃ©rience de Lev Koulechov (annÃ©es 1920) prouvant que le sens naÃ®t du montage, pas des plans isolÃ©s.</p>
            <p>Un mÃªme visage neutre juxtaposÃ© Ã  diffÃ©rentes images (soupe, cercueil, enfant) est perÃ§u comme exprimant faim, tristesse ou tendresse.</p>
            <p>DÃ©montre que le spectateur <strong>crÃ©e le sens</strong> en connectant mentalement les plans.</p>`,
            example: 'Fondement du cinÃ©ma soviÃ©tique (Eisenstein, Poudovkine).'
        },
        'montage-parallele': {
            title: 'Montage parallÃ¨le (Cross-cutting)',
            description: `<p>Alternance entre deux ou plusieurs actions se dÃ©roulant simultanÃ©ment dans des lieux diffÃ©rents.</p>
            <p>CrÃ©e la <strong>tension</strong> (course contre la montre), la <strong>comparaison</strong> (riches vs pauvres) ou le <strong>suspense</strong>.</p>
            <p>InventÃ© par D.W. Griffith, c'est devenu un outil narratif fondamental.</p>`,
            example: 'Le Parrain : baptÃªme + assassinats. Inception : rÃªves imbriquÃ©s.'
        },
        // === MONTAGE - TECHNIQUES ===
        'ellipse': {
            title: 'Ellipse',
            description: `<p>Saut temporel entre deux plans, omettant une partie de l'action jugÃ©e non essentielle.</p>
            <p>Permet l'<strong>Ã©conomie narrative</strong> : on ne montre pas le trajet, la nuit de sommeil, les annÃ©es qui passent.</p>
            <p>L'ellipse peut Ãªtre de quelques secondes (sauter une action banale) ou de plusieurs annÃ©es.</p>`,
            example: '2001 : l os lancÃ© en l air â†’ station spatiale (millions d annÃ©es).'
        },
        'l-cut-j-cut': {
            title: 'L-Cut / J-Cut',
            description: `<p>Techniques oÃ¹ le son et l'image ne coupent pas au mÃªme moment, crÃ©ant un chevauchement.</p>
            <p><strong>L-Cut</strong> : l'image change mais le son du plan prÃ©cÃ©dent continue. <strong>J-Cut</strong> : le son du plan suivant commence avant l'image.</p>
            <p>Fluidifie les transitions et crÃ©e de l'anticipation ou de la continuitÃ© Ã©motionnelle.</p>`,
            example: 'OmniprÃ©sent dans les dialogues de films modernes.'
        },
        // === MONTAGE - WORKFLOW ===
        'picture-lock': {
            title: 'Picture Lock',
            description: `<p>Moment oÃ¹ le montage image est dÃ©finitivement validÃ©. Plus aucune modification de durÃ©e ou d'ordre des plans.</p>
            <p>Ã‰tape <strong>cruciale</strong> car elle dÃ©clenche la post-production lourde : Ã©talonnage, VFX, mixage son.</p>
            <p>AprÃ¨s le picture lock, tout changement coÃ»te trÃ¨s cher car il impacte tous les dÃ©partements.</p>`,
            example: 'Modifier aprÃ¨s picture lock peut coÃ»ter des milliers d euros.'
        },
        'etalonnage': {
            title: 'Ã‰talonnage (Color Grading)',
            description: `<p>Correction colorimÃ©trique et crÃ©ation du "look" visuel final du film en post-production.</p>
            <p>Deux Ã©tapes : <strong>correction primaire</strong> (Ã©quilibrer les plans) et <strong>secondaire</strong> (crÃ©er l'atmosphÃ¨re, styliser).</p>
            <p>Peut transformer radicalement l'ambiance : froid/chaud, dÃ©saturÃ©, teal & orange, etc.</p>`,
            example: 'Le look orange/teal de Mad Max Fury Road. Le dÃ©saturÃ© de Saving Private Ryan.'
        },
        // === SCÃ‰NARIO - STRUCTURE ===
        'structure-3-actes': {
            title: 'Structure en 3 Actes',
            description: `<p>ModÃ¨le dramaturgique fondamental divisant le rÃ©cit en trois parties : Exposition, Confrontation, RÃ©solution.</p>
            <p>HÃ©ritÃ© de la <strong>PoÃ©tique d'Aristote</strong> (dÃ©but, milieu, fin), c'est la structure dominante du cinÃ©ma narratif classique.</p>
            <p>Proportions classiques : Acte I (25%), Acte II (50%), Acte III (25%).</p>`,
            example: 'Quasi tous les blockbusters suivent ce modÃ¨le.'
        },
        'protagoniste': {
            title: 'Protagoniste',
            description: `<p>Personnage principal de l'histoire, celui dont on suit le parcours et Ã  travers lequel le spectateur vit l'aventure.</p>
            <p>Doit avoir un <strong>objectif clair</strong>, des <strong>obstacles</strong> Ã  surmonter et des <strong>enjeux</strong> (ce qu'il risque de perdre).</p>
            <p>Son arc transformationnel (comment il change) est souvent le cÅ“ur Ã©motionnel du film.</p>`,
            example: 'Luke Skywalker, Clarice Starling, Woody dans Toy Story.'
        },
        'antagoniste': {
            title: 'Antagoniste',
            description: `<p>Force qui s'oppose au protagoniste et l'empÃªche d'atteindre son objectif.</p>
            <p>Peut Ãªtre une <strong>personne</strong> (mÃ©chant), une <strong>institution</strong>, la <strong>nature</strong>, la <strong>sociÃ©tÃ©</strong> ou le protagoniste <strong>lui-mÃªme</strong>.</p>
            <p>Un bon antagoniste croit avoir raison et a ses propres motivations comprÃ©hensibles.</p>`,
            example: 'Darth Vader, Hannibal Lecter, le requin dans Les Dents de la Mer.'
        },
        'voyage-heros': {
            title: 'Voyage du HÃ©ros',
            description: `<p>Structure narrative universelle en 12 Ã©tapes identifiÃ©e par Joseph Campbell dans "Le HÃ©ros aux mille visages" (1949).</p>
            <p>DÃ©crit le parcours archÃ©typal : dÃ©part du monde ordinaire, Ã©preuves dans un monde extraordinaire, retour <strong>transformÃ©</strong>.</p>
            <p>AdaptÃ© pour Hollywood par Christopher Vogler, c'est le squelette de nombreux blockbusters.</p>`,
            example: 'Star Wars, Le Seigneur des Anneaux, Matrix, Le Roi Lion.'
        },
        'plot-point': {
            title: 'Plot Point (Point de basculement)',
            description: `<p>Ã‰vÃ©nement majeur qui fait basculer l'histoire dans une nouvelle direction, concept clÃ© du paradigme de Syd Field.</p>
            <p><strong>Plot Point 1</strong> (fin Acte I) : Lance le protagoniste dans l'aventure. <strong>Plot Point 2</strong> (fin Acte II) : Propulse vers le climax.</p>
            <p>Ces moments sont des "portes" : une fois franchies, le protagoniste ne peut plus revenir en arriÃ¨re.</p>`,
            example: 'Matrix : Neo choisit la pilule rouge (PP1).'
        },
        'midpoint': {
            title: 'Midpoint (Point mÃ©dian)',
            description: `<p>Moment pivot au centre exact du film (vers la page 60) qui change la dynamique de l'histoire.</p>
            <p>Peut Ãªtre une <strong>fausse victoire</strong> (tout semble gagnÃ©, mais...) ou une <strong>fausse dÃ©faite</strong> (tout semble perdu, mais...).</p>
            <p>Souvent le moment oÃ¹ le protagoniste passe de rÃ©actif Ã  proactif, ou dÃ©couvre une vÃ©ritÃ© importante.</p>`,
            example: 'Titanic : Jack et Rose font l amour (fausse victoire avant le naufrage).'
        },
        'arc-transformationnel': {
            title: 'Arc Transformationnel',
            description: `<p>Ã‰volution intÃ©rieure du personnage au cours de l'histoire, sa transformation psychologique ou morale.</p>
            <p>Le personnage commence avec une <strong>croyance limitante</strong> (Lie) nÃ©e d'une <strong>blessure</strong> (Ghost), et doit dÃ©couvrir la <strong>vÃ©ritÃ©</strong> (Truth).</p>
            <p>Ce qu'il VEUT (dÃ©sir) â‰  ce dont il a BESOIN. Le film rÃ©concilie souvent les deux.</p>`,
            example: 'Scrooge dans A Christmas Carol, Carl dans LÃ -Haut.'
        },
        // === PRODUCTION - Ã‰TAPES ===
        'pre-production': {
            title: 'PrÃ©-production',
            description: `<p>Phase de prÃ©paration entre le dÃ©veloppement du projet et le tournage. Dure gÃ©nÃ©ralement 8-12 semaines.</p>
            <p>Comprend : casting, repÃ©rages, dÃ©coupage technique, storyboard, constitution de l'Ã©quipe, planning, budget dÃ©taillÃ©.</p>
            <p>Une <strong>bonne prÃ©paration</strong> est la clÃ© d'un tournage rÃ©ussi. "Chaque euro investi en prÃ©pa en Ã©conomise dix en tournage."</p>`,
            example: '8-12 semaines de prÃ©pa pour un long-mÃ©trage standard.'
        },
        'post-production': {
            title: 'Post-production',
            description: `<p>Phase finale aprÃ¨s le tournage : montage, Ã©talonnage, VFX, sound design, mixage, mastering.</p>
            <p>Peut durer de quelques semaines (court-mÃ©trage) Ã  plus d'un an (blockbuster avec VFX lourds).</p>
            <p>Le film se "rÃ©Ã©crit" souvent au montage. C'est lÃ  que naÃ®t le rythme et l'Ã©motion finale.</p>`,
            example: 'Avatar 2 : plus de 3 ans de post-production.'
        },
        // === PRODUCTION - DOCUMENTS ===
        'feuille-service': {
            title: 'Feuille de service',
            description: `<p>Document quotidien distribuÃ© la veille Ã  toute l'Ã©quipe, dÃ©taillant le programme du lendemain.</p>
            <p>Contient : horaires (convocations Ã©chelonnÃ©es), lieux, scÃ¨nes tournÃ©es, comÃ©diens nÃ©cessaires, besoins spÃ©ciaux.</p>
            <p>La "bible" de chaque journÃ©e. PrÃ©parÃ©e par le 2Ã¨me assistant rÃ©alisateur.</p>`,
            example: 'EnvoyÃ©e chaque soir vers 19h pour le lendemain.'
        },
        'depouillement': {
            title: 'DÃ©pouillement',
            description: `<p>Analyse dÃ©taillÃ©e du scÃ©nario pour lister tous les besoins de chaque scÃ¨ne.</p>
            <p>RÃ©pertorie : personnages, figurants, dÃ©cors, accessoires, costumes, maquillages, vÃ©hicules, effets spÃ©ciaux...</p>
            <p>Base essentielle pour Ã©tablir le budget et le plan de travail. Chaque dÃ©partement fait son propre dÃ©pouillement.</p>`,
            example: 'Un bon dÃ©pouillement Ã©vite les mauvaises surprises en tournage.'
        },
        // === PRODUCTION - POSTES ===
        'scripte': {
            title: 'Scripte (Script Supervisor)',
            description: `<p>Garant(e) de la continuitÃ© du film : raccords de gestes, positions, accessoires, costumes, maquillage entre les plans.</p>
            <p>Note chaque prise (durÃ©e, commentaires, sÃ©lection du rÃ©alisateur) et rÃ©dige le rapport image pour le montage.</p>
            <p>MÃ©moire vivante du tournage. Travaille en Ã©troite collaboration avec le rÃ©alisateur et le monteur.</p>`,
            example: 'Le scripte note tout : verre plein ou vide, main gauche ou droite...'
        },
        'chef-op': {
            title: 'Directeur de la Photographie (Chef Op)',
            description: `<p>Responsable de l'image du film : Ã©clairage, cadrage, choix des optiques, atmosphÃ¨re visuelle.</p>
            <p>Traduit la vision du rÃ©alisateur en lumiÃ¨re. Supervise les Ã©quipes camÃ©ra et Ã©lectricitÃ©.</p>
            <p>Collaboration crÃ©ative Ã©troite avec le rÃ©alisateur. Peut dÃ©finir le "look" signature d'un film.</p>`,
            example: 'Roger Deakins (Skyfall, Blade Runner 2049), Emmanuel Lubezki (Gravity).'
        },
        // === PRODUCTION - BUDGET ===
        'above-below-line': {
            title: 'Above / Below the Line',
            description: `<p>Division traditionnelle du budget en deux catÃ©gories, sÃ©parÃ©es par une "ligne" symbolique.</p>
            <p><strong>Above the line</strong> : coÃ»ts crÃ©atifs (droits, scÃ©nario, rÃ©alisateur, producteur, acteurs principaux).</p>
            <p><strong>Below the line</strong> : coÃ»ts de fabrication (Ã©quipe technique, matÃ©riel, dÃ©cors, post-production).</p>`,
            example: 'Un star-systÃ¨me gonflÃ© = Above the line disproportionnÃ©.'
        },
        // === RÃ‰ALISATION - POINTS DE VUE ===
        'plan-subjectif': {
            title: 'Plan subjectif (POV)',
            description: `<p>La camÃ©ra prend la place des yeux d'un personnage. Le spectateur voit exactement ce que le personnage voit.</p>
            <p>CrÃ©e une <strong>identification forte</strong> et une immersion totale. Souvent prÃ©cÃ©dÃ© d'un plan sur le personnage qui regarde.</p>
            <p>Peut Ãªtre troublant si prolongÃ© (vertige, malaise). UtilisÃ© pour les scÃ¨nes de tension, dÃ©couverte, poursuite.</p>`,
            example: 'Halloween (Michael Myers), Enter the Void, Strange Days.'
        },
        'plan-objectif': {
            title: 'Plan objectif',
            description: `<p>Point de vue neutre d'un observateur extÃ©rieur. La camÃ©ra ne reprÃ©sente les yeux d'aucun personnage.</p>
            <p>Position <strong>omnisciente</strong> classique du cinÃ©ma narratif. Le spectateur observe la scÃ¨ne comme un tÃ©moin invisible.</p>
            <p>CrÃ©e une distance analytique, permet de voir ce que les personnages ne voient pas.</p>`,
            example: 'La majoritÃ© des plans dans le cinÃ©ma classique.'
        },
        'plan-semi-subjectif': {
            title: 'Plan semi-subjectif',
            description: `<p>La camÃ©ra est proche d'un personnage, dans son espace, mais ne reprÃ©sente pas exactement ses yeux.</p>
            <p>Souvent <strong>par-dessus l'Ã©paule</strong> (over-the-shoulder). Partage l'expÃ©rience sans l'identification totale.</p>
            <p>Compromis entre subjectivitÃ© et objectivitÃ©. TrÃ¨s utilisÃ© dans les dialogues et scÃ¨nes d'action.</p>`,
            example: 'Champs/contre-champs avec amorce d Ã©paule.'
        },
        'ligne-180': {
            title: 'Ligne des 180Â° (RÃ¨gle)',
            description: `<p>Axe imaginaire entre deux sujets qui ne doit pas Ãªtre franchi sans transition pour maintenir la cohÃ©rence spatiale.</p>
            <p>Si la camÃ©ra passe de l'autre cÃ´tÃ©, les personnages semblent <strong>inverser leurs positions</strong> et le spectateur perd ses repÃ¨res.</p>
            <p>Peut Ãªtre franchie volontairement pour crÃ©er confusion ou malaise (Kubrick, Ozu).</p>`,
            example: 'RÃ¨gle fondamentale du dÃ©coupage classique hollywoodien.'
        },
        'plan-sequence': {
            title: 'Plan-sÃ©quence',
            description: `<p>Une scÃ¨ne entiÃ¨re tournÃ©e en un seul plan continu, sans aucune coupe de montage.</p>
            <p>Demande une <strong>chorÃ©graphie parfaite</strong> des acteurs, de la camÃ©ra et de la technique. TrÃ¨s exigeant mais immersif.</p>
            <p>CrÃ©e une tension continue car le spectateur sait qu'il n'y a pas d'Ã©chappatoire au temps rÃ©el.</p>`,
            image: `<img src="images/cours/plan-sequence.jpeg" alt="Plan-sÃ©quence" class="w-full-r8">`,
            example: 'La Corde (Hitchcock), Birdman, 1917, Copacabana dans Les Affranchis.'
        },
        'blocking': {
            title: 'Blocking (Mise en place)',
            description: `<p>Placement et dÃ©placement des acteurs dans le dÃ©cor. L'art de raconter l'histoire par les positions et mouvements.</p>
            <p>Un bon blocking <strong>exprime les relations</strong> sans dialogue : distance = froideur, rapprochement = intimitÃ©, dos tournÃ© = rejet.</p>
            <p>Le rÃ©alisateur "chorÃ©graphie" la scÃ¨ne avant mÃªme de placer la camÃ©ra.</p>`,
            example: 'David Fincher et ses blocking millimÃ©trÃ©s.'
        },
        'staging': {
            title: 'Staging (Mise en cadre)',
            description: `<p>Organisation des Ã©lÃ©ments visuels dans le cadre pour guider le regard du spectateur.</p>
            <p>Combine <strong>blocking</strong> (acteurs) + <strong>dÃ©cor</strong> + <strong>lumiÃ¨re</strong> + <strong>profondeur</strong> pour crÃ©er une composition signifiante.</p>
            <p>Chaque Ã©lÃ©ment du cadre doit avoir une raison d'Ãªtre et contribuer Ã  la narration.</p>`,
            example: 'Les compositions gÃ©omÃ©triques de Wes Anderson.'
        },
        'oner': {
            title: 'Oner (Plan-sÃ©quence virtuose)',
            description: `<p>Plan-sÃ©quence techniquement complexe, souvent avec mouvements de camÃ©ra Ã©laborÃ©s et chorÃ©graphie prÃ©cise.</p>
            <p>DiffÃ©rent du plan-sÃ©quence simple par son <strong>ambition technique</strong> et sa durÃ©e (parfois plusieurs minutes).</p>
            <p>Peut impliquer grues, steadicam, transitions cachÃ©es, coordination de dizaines de figurants.</p>`,
            example: 'Copacabana (Goodfellas), Atonement, 1917, Birdman.'
        },
        'split-focus': {
            title: 'Split Focus (Diopter)',
            description: `<p>Technique optique utilisant une lentille fendue pour avoir deux plans de nettetÃ© simultanÃ©s.</p>
            <p>Permet de garder nets Ã  la fois un sujet <strong>trÃ¨s proche</strong> et un autre <strong>trÃ¨s Ã©loignÃ©</strong> dans le mÃªme plan.</p>
            <p>Signature visuelle de Brian De Palma. CrÃ©e une tension entre deux zones d'action.</p>`,
            example: 'Les films de Brian De Palma (Blow Out, Carrie).'
        },
        'camera-epaule': {
            title: 'CamÃ©ra Ã©paule (Handheld)',
            description: `<p>Technique oÃ¹ l'opÃ©rateur porte la camÃ©ra sur l'Ã©paule, crÃ©ant une image lÃ©gÃ¨rement instable.</p>
            <p>Apporte <strong>urgence, rÃ©alisme, immersion documentaire</strong>. Le spectateur ressent la prÃ©sence physique du filmeur.</p>
            <p>Signature des frÃ¨res Dardenne, Paul Greengrass. Ã€ utiliser avec intention, pas par dÃ©faut.</p>`,
            image: `<img src="images/cours/camera-epaule.jpeg" alt="CamÃ©ra Ã©paule" class="w-full-r8">`,
            example: 'La Haine, Bourne Identity, films des Dardenne.'
        },
        'storyboard': {
            title: 'Storyboard',
            description: `<p>Suite de dessins reprÃ©sentant chaque plan du film, comme une bande dessinÃ©e du dÃ©coupage.</p>
            <p>Permet de <strong>visualiser</strong> le film avant le tournage et de communiquer la vision du rÃ©alisateur Ã  l'Ã©quipe.</p>
            <p>Indispensable pour les scÃ¨nes complexes (action, VFX). Peut Ãªtre simple croquis ou trÃ¨s dÃ©taillÃ©.</p>`,
            example: 'Hitchcock storyboardait chaque plan. Mad Max Fury Road entiÃ¨rement dessinÃ©.'
        },
        'reperages': {
            title: 'RepÃ©rages (Location Scouting)',
            description: `<p>Recherche et validation des lieux de tournage avant la production.</p>
            <p>Ã‰value : <strong>esthÃ©tique</strong>, lumiÃ¨re naturelle, acoustique, accessibilitÃ©, contraintes techniques et lÃ©gales.</p>
            <p>Le rÃ©alisateur, chef op et rÃ©gisseur visitent ensemble. Photos et vidÃ©os pour prÃ©parer le dÃ©coupage.</p>`,
            example: 'Le Seigneur des Anneaux : 3 ans de repÃ©rages en Nouvelle-ZÃ©lande.'
        },
        'ligne-30': {
            title: 'RÃ¨gle des 30Â°',
            description: `<p>Entre deux plans consÃ©cutifs du mÃªme sujet, la camÃ©ra doit bouger d'au moins 30Â° pour Ã©viter un jump cut.</p>
            <p>Un changement d'angle insuffisant crÃ©e une <strong>saute</strong> visuelle dÃ©sagrÃ©able et dÃ©sorientante.</p>
            <p>Alternative : changer significativement la valeur de plan (passer de PM Ã  GP par exemple).</p>`,
            example: 'La Nouvelle Vague a volontairement brisÃ© cette rÃ¨gle (Ã€ bout de souffle).'
        },
        'headroom': {
            title: 'Headroom (Air au-dessus)',
            description: `<p>Espace entre le haut de la tÃªte du sujet et le bord supÃ©rieur du cadre.</p>
            <p><strong>Trop de headroom</strong> = sujet Ã©crasÃ©, perdu. <strong>Pas assez</strong> = sujet Ã©touffÃ©, tÃªte coupÃ©e.</p>
            <p>Varie selon la valeur de plan : plus serrÃ© = moins de headroom nÃ©cessaire.</p>`,
            image: `<img src="images/cours/headroom.jpeg" alt="Headroom" class="w-full-r8">`,
            example: 'Erreur frÃ©quente des dÃ©butants : trop ou pas assez d air.'
        },
        'looking-room': {
            title: 'Looking Room (Regard)',
            description: `<p>Espace laissÃ© devant le regard ou la direction du mouvement d'un sujet.</p>
            <p>Si le personnage regarde Ã  droite, laisser de l'espace Ã  droite. Sinon, il semble <strong>coincÃ©</strong> contre le bord.</p>
            <p>CrÃ©e une composition Ã©quilibrÃ©e et suggÃ¨re ce que le personnage regarde (hors-champ).</p>`,
            image: `<img src="images/cours/looking-room.jpeg" alt="Looking Room" class="w-full-r8">`,
            example: 'RÃ¨gle de base pour les interviews et dialogues.'
        },
        // === SCÃ‰NARIO - Ã‰LÃ‰MENTS DRAMATIQUES ===
        'enjeu': {
            title: 'Enjeu (Stakes)',
            description: `<p>Ce que le protagoniste risque de <strong>perdre</strong> s'il Ã©choue dans sa quÃªte.</p>
            <p>Plus l'enjeu est Ã©levÃ© (vie, amour, humanitÃ©), plus le spectateur est investi Ã©motionnellement.</p>
            <p>Peut Ãªtre externe (sauver le monde) ou interne (trouver sa place, se pardonner).</p>`,
            example: 'Titanic : l amour et la vie. Le Parrain : l Ã¢me de Michael.'
        },
        'conflit': {
            title: 'Conflit',
            description: `<p>Opposition fondamentale qui crÃ©e la <strong>tension dramatique</strong> et fait avancer l'histoire.</p>
            <p>Types : Homme vs Homme, Homme vs Nature, Homme vs SociÃ©tÃ©, Homme vs Lui-mÃªme, Homme vs Technologie.</p>
            <p>Sans conflit, pas d'histoire. Le conflit rÃ©vÃ¨le le vrai caractÃ¨re des personnages.</p>`,
            example: 'Les Dents de la Mer : Homme vs Nature. Fight Club : Homme vs Lui-mÃªme.'
        },
        // === RÃ‰ALISATION - STYLES ===
        'casting': {
            title: 'Casting (Direction de casting)',
            description: `<p>Processus de sÃ©lection des comÃ©diens pour les rÃ´les du film.</p>
            <p>Comprend : lecture du scÃ©nario, auditions, essais camÃ©ra, chemistry reads (alchimie entre acteurs).</p>
            <p>Le directeur de casting propose, le rÃ©alisateur et producteur dÃ©cident. Un bon casting = 90% du travail.</p>`,
            example: 'Heath Ledger choisi pour le Joker malgrÃ© les doutes initiaux.'
        },
        'decoupage-classique': {
            title: 'DÃ©coupage classique (Hollywood)',
            description: `<p>MÃ©thode de tournage standard : un <strong>master shot</strong> (plan large de toute la scÃ¨ne) + coverage (plans rapprochÃ©s).</p>
            <p>Permet un montage fluide et "invisible". Le spectateur ne remarque pas les coupes.</p>
            <p>SÃ©curitÃ© maximale en post-production : toutes les options de montage sont couvertes.</p>`,
            example: 'Standard hollywoodien depuis les annÃ©es 30.'
        },
        'decoupage-europeen': {
            title: 'DÃ©coupage europÃ©en',
            description: `<p>Approche privilÃ©giant les <strong>plans longs</strong>, moins de coupes, laissant "respirer" les scÃ¨nes.</p>
            <p>Fait confiance au jeu des acteurs et Ã  la mise en scÃ¨ne plutÃ´t qu'au montage.</p>
            <p>Moins de coverage, plus de risques, mais authenticitÃ© et immersion accrues.</p>`,
            example: 'Bergman, Tarkovski, Haneke, les frÃ¨res Dardenne.'
        },
        'minimalisme': {
            title: 'Minimalisme cinÃ©matographique',
            description: `<p>Ã‰conomie de moyens : cadres fixes, peu de mouvements, temps rÃ©el, peu de musique.</p>
            <p>Laisse l'<strong>espace et le temps</strong> aux spectateurs pour observer et rÃ©flÃ©chir.</p>
            <p>Souvent associÃ© au cinÃ©ma d'auteur iranien, japonais, ou europÃ©en contemplatif.</p>`,
            example: 'Kiarostami, Ozu, Haneke, Tsai Ming-liang.'
        },
        // === IMAGE - OPTIQUES ===
        'focale-normale': {
            title: 'Focale normale (50mm)',
            description: `<p>Objectif dont l'angle de champ est proche de la <strong>vision humaine</strong> (environ 46Â°).</p>
            <p>Rendu naturel, sans distorsion ni compression. ConsidÃ©rÃ©e comme "neutre" et polyvalente.</p>
            <p>La focale de rÃ©fÃ©rence, souvent recommandÃ©e pour apprendre la composition.</p>`,
            image: `<img src="images/cours/focale-normale.jpeg" alt="Focale normale" class="w-full-r8">`,
            example: 'Kubrick adorait le 50mm. IdÃ©al pour les portraits naturels.'
        },
        'macro': {
            title: 'Objectif Macro',
            description: `<p>Optique permettant des <strong>trÃ¨s gros plans</strong> sur de petits objets (ratio 1:1 ou plus).</p>
            <p>RÃ©vÃ¨le des dÃ©tails invisibles Ã  l'Å“il nu : textures, insectes, gouttes d'eau, mÃ©canismes.</p>
            <p>Profondeur de champ extrÃªmement rÃ©duite. Demande stabilisation et Ã©clairage prÃ©cis.</p>`,
            image: `<img src="images/cours/macro.jpeg" alt="Macro" class="w-full-r8">`,
            example: 'Microcosmos, les inserts de Se7en, Planet Earth.'
        },
        'balance-blancs': {
            title: 'Balance des blancs',
            description: `<p>RÃ©glage de la camÃ©ra pour que le <strong>blanc apparaisse neutre</strong> quelle que soit la source lumineuse.</p>
            <p>Compense la tempÃ©rature de couleur de la lumiÃ¨re (tungstÃ¨ne = chaud, daylight = froid).</p>
            <p>Peut Ãªtre rÃ©glÃ©e manuellement (Kelvin) ou avec des presets (Daylight, Tungsten, Cloudy...).</p>`,
            example: 'Erreur frÃ©quente : peau orange en intÃ©rieur tungstÃ¨ne.'
        },
        // === SON - COUCHES SONORES ===
        'silence-cinematographique': {
            title: 'Silence (outil dramatique)',
            description: `<p>Absence volontaire de son, utilisÃ©e comme <strong>outil narratif puissant</strong>.</p>
            <p>CrÃ©e tension, malaise, suspension. Amplifie l'impact du son qui suit.</p>
            <p>Souvent sous-estimÃ©. Le silence avant un moment fort dÃ©cuple son effet.</p>`,
            example: 'No Country for Old Men, A Quiet Place, 2001 l OdyssÃ©e.'
        },
        // === SCÃ‰NARIO - FORMAT ===
        'entete-scene': {
            title: 'En-tÃªte de scÃ¨ne (Slugline)',
            description: `<p>PremiÃ¨re ligne de chaque scÃ¨ne indiquant : <strong>INT./EXT.</strong> (intÃ©rieur/extÃ©rieur) - <strong>LIEU</strong> - <strong>MOMENT</strong> (JOUR/NUIT).</p>
            <p>Exemple : INT. APPARTEMENT DE MARIE - CUISINE - NUIT</p>
            <p>Permet Ã  l'Ã©quipe de production de planifier les dÃ©cors, l'Ã©clairage et le planning. Toujours en MAJUSCULES.</p>`,
            example: 'Standard universel dans tous les scÃ©narios professionnels.'
        },
        'action-scenario': {
            title: 'Action (Description)',
            description: `<p>Paragraphes dÃ©crivant ce qu'on <strong>voit et entend</strong> Ã  l'Ã©cran. Toujours au prÃ©sent, style concis et visuel.</p>
            <p>Ã‰viter : pensÃ©es des personnages, explications, adverbes inutiles. Ã‰crire uniquement ce que la camÃ©ra peut capter.</p>
            <p>Maximum 4 lignes par paragraphe. AÃ©rer pour faciliter la lecture et le rythme.</p>`,
            example: '"Marie entre. Elle pose ses clÃ©s. Regarde le rÃ©pondeur. Trois messages."'
        },
        'dialogue-scenario': {
            title: 'Dialogue',
            description: `<p>Ce que dit le personnage. PrÃ©cÃ©dÃ© du nom du personnage en MAJUSCULES, centrÃ©.</p>
            <p>Un bon dialogue : rÃ©vÃ¨le le caractÃ¨re, fait avancer l'intrigue, semble naturel mais est travaillÃ©.</p>
            <p>Ã‰viter l'exposition maladroite ("Comme tu sais, nous sommes frÃ¨res depuis 30 ans...").</p>`,
            example: 'Tarantino, Sorkin et Mamet sont maÃ®tres du dialogue mÃ©morable.'
        },
        'didascalie': {
            title: 'Didascalie (Parenthetical)',
            description: `<p>Indication de jeu entre parenthÃ¨ses, placÃ©e entre le nom du personnage et son dialogue.</p>
            <p>UtilisÃ©e avec parcimonie pour : ton particulier (ironique), action pendant le dialogue (versant le cafÃ©), ou destinataire (Ã  Marie).</p>
            <p>Ã‰viter de surcharger : faire confiance aux acteurs et au rÃ©alisateur pour l'interprÃ©tation.</p>`,
            example: '(murmurant) ou (sans lever les yeux) ou (Ã  lui-mÃªme)'
        },
        // === SCÃ‰NARIO - ARC PERSONNAGE ===
        'ghost': {
            title: 'Ghost (Blessure)',
            description: `<p>Trauma ou Ã©vÃ©nement du passÃ© qui <strong>dÃ©finit les peurs</strong> et comportements actuels du personnage.</p>
            <p>Souvent rÃ©vÃ©lÃ© progressivement. Explique pourquoi le personnage est "cassÃ©" au dÃ©but de l'histoire.</p>
            <p>Le climax force gÃ©nÃ©ralement le personnage Ã  affronter ce Ghost pour Ã©voluer.</p>`,
            example: 'Bruce Wayne et le meurtre de ses parents. Will Hunting et la maltraitance.'
        },
        'lie': {
            title: 'Lie (Croyance limitante)',
            description: `<p>Ce que le personnage <strong>croit Ã  tort</strong> sur lui-mÃªme ou le monde, consÃ©quence du Ghost.</p>
            <p>"Je ne mÃ©rite pas d'Ãªtre aimÃ©", "Le monde est cruel", "Je dois tout contrÃ´ler pour survivre".</p>
            <p>L'arc transformationnel consiste Ã  dÃ©construire cette croyance pour la remplacer par la VÃ©ritÃ©.</p>`,
            example: 'Carl (LÃ -haut) croit que s aventurer seul trahit Ellie.'
        },
        'verite-personnage': {
            title: 'Truth (VÃ©ritÃ©)',
            description: `<p>Ce que le personnage doit <strong>apprendre</strong> pour complÃ©ter son arc et trouver la paix/rÃ©ussite.</p>
            <p>OpposÃ©e Ã  la Lie. Souvent thÃ©matiquement liÃ©e au message du film.</p>
            <p>Le personnage l'accepte gÃ©nÃ©ralement au climax, ce qui lui permet de triompher (ou de tragiquement Ã©chouer s'il la refuse).</p>`,
            example: 'Marlin (Nemo) : "Je dois faire confiance Ã  mon fils et le laisser grandir."'
        },
        'besoin-vs-desir': {
            title: 'Besoin vs DÃ©sir (Need vs Want)',
            description: `<p><strong>DÃ©sir (Want)</strong> : ce que le personnage poursuit consciemment (objectif externe visible).</p>
            <p><strong>Besoin (Need)</strong> : ce dont il a vraiment besoin pour Ãªtre complet (souvent inconscient, interne).</p>
            <p>Les meilleures histoires crÃ©ent une tension entre les deux. Le personnage obtient ce dont il a besoin, pas toujours ce qu'il veut.</p>`,
            example: 'Michael Corleone veut protÃ©ger sa famille, mais a besoin de ne pas devenir son pÃ¨re.'
        },
        // === RÃ‰ALISATION - DIRECTION D'ACTEURS ===
        'stanislavski': {
            title: 'MÃ©thode Stanislavski',
            description: `<p>SystÃ¨me de jeu dÃ©veloppÃ© par Constantin Stanislavski, fondement du jeu moderne.</p>
            <p>Principes clÃ©s : <strong>mÃ©moire affective</strong> (puiser dans ses Ã©motions vÃ©cues), <strong>objectif</strong> (que veut le personnage ?), <strong>circonstances donnÃ©es</strong> (contexte complet).</p>
            <p>Recherche de la "vÃ©ritÃ©" du personnage plutÃ´t que la simple imitation externe.</p>`,
            example: 'Base de formation de la plupart des Ã©coles de thÃ©Ã¢tre mondiales.'
        },
        'actors-studio': {
            title: 'Actors Studio (MÃ©thode)',
            description: `<p>Ã‰cole new-yorkaise fondÃ©e en 1947, cÃ©lÃ¨bre pour la "Method Acting" de Lee Strasberg.</p>
            <p>Pousse le Stanislavski plus loin : <strong>immersion totale</strong> dans le personnage, parfois pendant des mois hors plateau.</p>
            <p>CritiquÃ©e pour ses excÃ¨s mais a produit des performances iconiques.</p>`,
            example: 'De Niro (Taxi Driver), Day-Lewis, Brando, Pacino, Hoffman.'
        },
        'meisner': {
            title: 'Technique Meisner',
            description: `<p>MÃ©thode dÃ©veloppÃ©e par Sanford Meisner, axÃ©e sur la <strong>rÃ©action instinctive</strong> et l'Ã©coute du partenaire.</p>
            <p>Exercice clÃ© : la rÃ©pÃ©tition. Deux acteurs rÃ©pÃ¨tent une phrase en variant selon les rÃ©actions de l'autre.</p>
            <p>Moins d'introspection que Stanislavski, plus d'attention Ã  l'instant prÃ©sent et au partenaire.</p>`,
            example: 'Robert Duvall, Diane Keaton, Grace Kelly, Tom Cruise.'
        },
        'approche-bresson': {
            title: 'Approche Bresson',
            description: `<p>Philosophie radicale de Robert Bresson : utiliser des "modÃ¨les" (non-acteurs) plutÃ´t que des acteurs professionnels.</p>
            <p>RÃ©pÃ©ter chaque prise jusqu'Ã  <strong>Ã©puisement du jeu conscient</strong>. Ce qui reste est authentique, dÃ©pouillÃ©.</p>
            <p>Refus de la psychologie, de l'expressivitÃ©. Laisser le montage et le contexte crÃ©er l'Ã©motion.</p>`,
            example: 'Pickpocket, Au hasard Balthazar, L Argent.'
        },
        'improvisation-dirigee': {
            title: 'Improvisation dirigÃ©e',
            description: `<p>Le rÃ©alisateur dÃ©finit un <strong>cadre</strong> (situation, objectifs, enjeux) mais laisse les acteurs improviser le dialogue et les actions.</p>
            <p>CrÃ©e une spontanÃ©itÃ© et un naturel impossibles Ã  scÃ©nariser. Demande des acteurs trÃ¨s prÃ©parÃ©s et un rÃ©alisateur rÃ©actif.</p>
            <p>Le scÃ©nario final est parfois Ã©crit aprÃ¨s le tournage, Ã  partir des rushes.</p>`,
            example: 'Cassavetes, Mike Leigh, Kechiche, les frÃ¨res Dardenne.'
        },
        // === IMAGE - COMPOSITION ===
        'lignes-directrices': {
            title: 'Lignes directrices (Leading Lines)',
            description: `<p>Ã‰lÃ©ments visuels naturels (routes, rampes, regards, architecture) qui <strong>guident l'Å“il du spectateur</strong> vers le sujet principal.</p>
            <p>Peuvent converger vers un point (perspective), encadrer le sujet, ou crÃ©er une dynamique de mouvement.</p>
            <p>Outil fondamental de composition pour contrÃ´ler oÃ¹ le spectateur regarde dans le cadre.</p>`,
            example: 'Les couloirs de Kubrick, les rails dans Il Ã©tait une fois dans l Ouest.'
        },
        // === SON - AVANCÃ‰ ===
        'trans-diegetique': {
            title: 'Son trans-diÃ©gÃ©tique',
            description: `<p>Son qui <strong>passe d'un Ã©tat Ã  l'autre</strong> : de diÃ©gÃ©tique Ã  extra-diÃ©gÃ©tique ou inversement.</p>
            <p>Exemple : une musique de film (extra-diÃ©gÃ©tique) qui devient la radio d'une voiture (diÃ©gÃ©tique), ou l'inverse.</p>
            <p>CrÃ©e des transitions Ã©lÃ©gantes et joue avec la frontiÃ¨re entre le monde du film et sa narration.</p>`,
            example: 'Apocalypse Now : "The End" passe de la bande-son Ã  la radio de l hÃ©lico.'
        },
        'sound-metaphor': {
            title: 'MÃ©taphore sonore',
            description: `<p>Son utilisÃ© pour <strong>reprÃ©senter une idÃ©e, une Ã©motion ou un concept</strong> au-delÃ  de sa source rÃ©elle.</p>
            <p>Le battement de cÅ“ur = tension/peur. Le tic-tac = temps qui presse. Le vent = solitude ou changement.</p>
            <p>Permet d'exprimer l'intÃ©rioritÃ© des personnages ou les thÃ¨mes du film de maniÃ¨re subtile.</p>`,
            example: 'Le battement de cÅ“ur rÃ©vÃ©lateur dans The Tell-Tale Heart (Poe).'
        },
        // === SON - COUCHES ET TECHNIQUES ===
        'dialogues-son': {
            title: 'Dialogues',
            description: `<p>Voix des personnages, Ã©lÃ©ment <strong>le plus important</strong> de la bande-son narrative.</p>
            <p>Doivent toujours Ãªtre intelligibles sauf choix artistique dÃ©libÃ©rÃ©. PrioritÃ© absolue lors de l'enregistrement et du mixage.</p>
            <p>EnregistrÃ©s sur le plateau (son direct) et/ou en post-synchronisation (ADR/doublage).</p>`,
            example: 'Un dialogue inaudible = spectateur perdu. Toujours protÃ©ger les voix.'
        },
        'musique-film': {
            title: 'Musique de film (Score)',
            description: `<p>Composition originale ou morceaux existants accompagnant l'image pour renforcer l'Ã©motion.</p>
            <p><strong>Score</strong> = musique originale composÃ©e pour le film. <strong>Soundtrack</strong> = compilation de morceaux existants.</p>
            <p>Peut Ãªtre diÃ©gÃ©tique (radio dans la scÃ¨ne) ou extra-diÃ©gÃ©tique (que le spectateur entend).</p>`,
            example: 'John Williams (Star Wars), Hans Zimmer (Inception), Ennio Morricone.'
        },
        'multi-pistes': {
            title: 'Enregistrement multi-pistes',
            description: `<p>Chaque source sonore (micro) enregistrÃ©e sur une <strong>piste sÃ©parÃ©e</strong> pour flexibilitÃ© au mixage.</p>
            <p>Permet d'ajuster individuellement chaque micro en post : niveau, Ã©galisation, effets.</p>
            <p>Standard professionnel. Enregistreurs 4, 8 ou 16 pistes (Sound Devices, Zoom F8, etc.).</p>`,
            example: 'Un acteur avec cravate + perche = 2 pistes sÃ©parÃ©es pour choisir au mix.'
        },
        'ms-stereo': {
            title: 'MS (Mid-Side)',
            description: `<p>Configuration stÃ©rÃ©o utilisant un micro cardioÃ¯de (Mid) et un micro bidirectionnel (Side).</p>
            <p>Avantage : la <strong>largeur stÃ©rÃ©o est ajustable en post</strong>-production. Compatible mono parfait.</p>
            <p>IdÃ©al pour les ambiances quand on ne connaÃ®t pas encore les besoins du mixage final.</p>`,
            example: 'Technique prisÃ©e des preneurs de son documentaire.'
        },
        'boom-vs-lav': {
            title: 'Boom vs Lavallier',
            description: `<p><strong>Perche (boom)</strong> : son naturel, perspective cohÃ©rente avec l'image, mais risque d'entrer dans le cadre.</p>
            <p><strong>Cravate (lav)</strong> : sÃ©curitÃ©, toujours proche de la source, mais son moins naturel et risque de frottements.</p>
            <p>IdÃ©alement : les deux en mÃªme temps pour avoir le choix au mixage.</p>`,
            example: 'Plan large = cravate en sÃ©curitÃ©. Plan serrÃ© = perche privilÃ©giÃ©e.'
        },
        'plant-mic': {
            title: 'Plant mic (Micro plantÃ©)',
            description: `<p>Micro <strong>cachÃ© dans le dÃ©cor</strong>, fixe, pour capter le son quand la perche ne peut pas approcher.</p>
            <p>UtilisÃ© pour les plans trÃ¨s larges, les scÃ¨nes avec mouvement complexe, ou les dÃ©cors difficiles.</p>
            <p>PlacÃ© stratÃ©giquement : dans un bouquet, sous une table, derriÃ¨re un objet.</p>`,
            example: 'ScÃ¨ne de dÃ®ner filmÃ©e en plan large avec plusieurs convives.'
        },
        'panning': {
            title: 'Panoramique audio (Panning)',
            description: `<p>Placement d'un son dans l'espace stÃ©rÃ©o ou surround, de gauche Ã  droite (et avant/arriÃ¨re en surround).</p>
            <p>Doit gÃ©nÃ©ralement <strong>suivre l'image</strong> : un personnage Ã  gauche de l'Ã©cran = voix lÃ©gÃ¨rement Ã  gauche.</p>
            <p>Les dialogues restent souvent centrÃ©s pour stabilitÃ©, les ambiances et effets sont spatialisÃ©s.</p>`,
            example: 'Une voiture traverse l Ã©cran : le son passe de gauche Ã  droite.'
        },
        'formats-audio': {
            title: 'Formats audio (Mono/StÃ©rÃ©o/Surround)',
            description: `<p><strong>Mono</strong> : 1 canal, historique, encore utilisÃ© pour dialogues centrÃ©s.</p>
            <p><strong>StÃ©rÃ©o (2.0)</strong> : Gauche/Droite, standard minimal TV et web.</p>
            <p><strong>5.1/7.1</strong> : Surround cinÃ©ma avec canaux arriÃ¨re. <strong>Atmos</strong> : son 3D avec canaux au plafond.</p>`,
            example: 'CinÃ©ma = minimum 5.1. Streaming = souvent stÃ©rÃ©o avec option 5.1.'
        },
        'lfe': {
            title: 'LFE (Low Frequency Effects)',
            description: `<p>Canal dÃ©diÃ© aux <strong>basses frÃ©quences</strong> (20-120 Hz) dans les systÃ¨mes surround (le ".1" de 5.1).</p>
            <p>Reproduit par le caisson de basses (subwoofer). UtilisÃ© pour les explosions, impacts, grondements, tension physique.</p>
            <p>Ressenti autant que entendu. CrÃ©e une expÃ©rience viscÃ©rale, physique.</p>`,
            example: 'Les explosions de Nolan, le rugissement du T-Rex dans Jurassic Park.'
        },
        // === MONTAGE - RACCORDS ===
        'raccord-axe': {
            title: 'Raccord dans l\'axe',
            description: `<p>Changement de valeur de plan (PE â†’ PM â†’ GP) en restant sur le <strong>mÃªme axe de camÃ©ra</strong>.</p>
            <p>Permet de se rapprocher ou s'Ã©loigner du sujet sans changer d'angle, crÃ©ant une intensification ou un recul Ã©motionnel.</p>
            <p>Doit respecter la rÃ¨gle des 30Â° implicitement : le changement de valeur doit Ãªtre suffisamment significatif.</p>`,
            example: 'Les zooms avant de Spielberg sur les visages en rÃ©action.'
        },
        'raccord-mouvement': {
            title: 'Raccord mouvement',
            description: `<p>Coupe effectuÃ©e <strong>pendant une action</strong> (un geste, un dÃ©placement) pour fluidifier la transition.</p>
            <p>Le mouvement commencÃ© dans le plan A se poursuit dans le plan B. L'Å“il suit l'action et "oublie" la coupe.</p>
            <p>Technique fondamentale du montage invisible hollywoodien.</p>`,
            example: 'Un personnage se lÃ¨ve : coupe pendant le mouvement, pas avant ni aprÃ¨s.'
        },
        'franchissement-axe': {
            title: 'Franchissement d\'axe',
            description: `<p>Passage de la camÃ©ra de l'autre cÃ´tÃ© de la <strong>ligne des 180Â°</strong>, inversant les positions apparentes des sujets.</p>
            <p>GÃ©nÃ©ralement considÃ©rÃ© comme une erreur dÃ©sorientante. Mais peut Ãªtre volontaire pour crÃ©er confusion, rupture ou malaise.</p>
            <p>Pour franchir proprement : plan neutre (sur la ligne), plan de coupe, ou mouvement de camÃ©ra visible.</p>`,
            example: 'Kubrick franchit volontairement dans Shining pour dÃ©sorienter.'
        },
        'faux-raccord': {
            title: 'Faux raccord',
            description: `<p>IncohÃ©rence visuelle entre deux plans : accessoire qui change de place, niveau de verre diffÃ©rent, lumiÃ¨re incohÃ©rente.</p>
            <p>Erreur de <strong>continuitÃ©</strong> (script supervisor). Peut sortir le spectateur du film s'il est visible.</p>
            <p>Parfois inÃ©vitable (tournÃ© sur plusieurs jours), le monteur essaie de les masquer ou les minimiser.</p>`,
            example: 'Les compilations de "movie mistakes" sur YouTube.'
        },
        // === MONTAGE - THÃ‰ORIES ===
        'montage-intellectuel': {
            title: 'Montage intellectuel (Eisenstein)',
            description: `<p>ThÃ©orie de Sergei Eisenstein : la <strong>collision</strong> de deux plans crÃ©e une idÃ©e nouvelle absente des deux.</p>
            <p>Plan A + Plan B = Concept C (thÃ¨se + antithÃ¨se = synthÃ¨se). Le sens Ã©merge du choc, pas des images individuelles.</p>
            <p>Montage comme outil de pensÃ©e et d'argumentation, pas seulement de narration.</p>`,
            example: 'La sÃ©quence des escaliers d Odessa dans Le CuirassÃ© Potemkine.'
        },
        'montage-invisible': {
            title: 'Montage invisible (Classique)',
            description: `<p>Style hollywoodien classique oÃ¹ les coupes sont si <strong>fluides</strong> que le spectateur oublie qu'il regarde un film montÃ©.</p>
            <p>Utilise : raccords regard, raccords mouvement, rÃ¨gle des 180Â°, continuitÃ© parfaite. Le montage sert l'histoire, pas lui-mÃªme.</p>
            <p>Objectif : immersion totale, suspension d'incrÃ©dulitÃ© maximale.</p>`,
            example: 'Les films de Spielberg, la plupart des blockbusters modernes.'
        },
        'montage-visible': {
            title: 'Montage visible (Moderne)',
            description: `<p>Style qui <strong>assume et exhibe</strong> les coupes : jump cuts, faux raccords volontaires, ruptures de rythme.</p>
            <p>Rappelle constamment au spectateur qu'il regarde un film. AssociÃ© Ã  la Nouvelle Vague, au cinÃ©ma d'auteur.</p>
            <p>Peut crÃ©er Ã©nergie, malaise, modernitÃ© ou distanciation brechtienne.</p>`,
            example: 'Ã€ bout de souffle (Godard), les films de Wong Kar-wai.'
        },
        // === MONTAGE - MÃ‰THODES EISENSTEIN ===
        'montage-metrique': {
            title: 'Montage mÃ©trique',
            description: `<p>Coupes Ã  <strong>intervalles rÃ©guliers</strong>, indÃ©pendamment du contenu des plans.</p>
            <p>CrÃ©e un rythme mÃ©canique, hypnotique ou oppressant. La durÃ©e des plans est mathÃ©matiquement dÃ©terminÃ©e.</p>
            <p>PremiÃ¨re des 5 mÃ©thodes de montage thÃ©orisÃ©es par Eisenstein.</p>`,
            example: 'SÃ©quences de tension avec accÃ©lÃ©ration progressive des coupes.'
        },
        'montage-rythmique': {
            title: 'Montage rythmique',
            description: `<p>Coupes dictÃ©es par le <strong>mouvement dans le plan</strong>, pas par une durÃ©e fixe.</p>
            <p>Le contenu visuel dÃ©termine le rythme : action rapide = coupe rapide, contemplation = plan long.</p>
            <p>Plus organique que le montage mÃ©trique, suit l'Ã©nergie interne des images.</p>`,
            example: 'Les poursuites en voiture, les scÃ¨nes de combat.'
        },
        'montage-tonal': {
            title: 'Montage tonal',
            description: `<p>Coupes basÃ©es sur l'<strong>Ã©motion dominante</strong> du plan : lumiÃ¨re, atmosphÃ¨re, texture.</p>
            <p>CrÃ©e une continuitÃ© Ã©motionnelle plutÃ´t que narrative. Les plans "sonnent" ensemble.</p>
            <p>UtilisÃ© pour les sÃ©quences poÃ©tiques, contemplatives ou expressionnistes.</p>`,
            example: 'Les sÃ©quences oniriques, les montages atmosphÃ©riques.'
        },
        // === MONTAGE - TECHNIQUES ===
        'montage-alterne': {
            title: 'Montage alternÃ© (Cross-cutting)',
            description: `<p>Alternance entre <strong>deux actions simultanÃ©es</strong> dans des lieux diffÃ©rents.</p>
            <p>CrÃ©e suspense et tension : "Arrivera-t-il Ã  temps ?" Les deux lignes convergent vers un climax commun.</p>
            <p>InventÃ© par D.W. Griffith. Outil fondamental du suspense cinÃ©matographique.</p>`,
            example: 'Le sauvetage de derniÃ¨re minute, la course contre la montre.'
        },
        'flashback': {
            title: 'Flashback / Flash-forward',
            description: `<p><strong>Flashback</strong> : retour dans le passÃ© pour rÃ©vÃ©ler information, trauma ou souvenir.</p>
            <p><strong>Flash-forward</strong> : saut dans le futur, plus rare, crÃ©e anticipation ou ironie dramatique.</p>
            <p>SignalÃ© visuellement (fondu, couleur diffÃ©rente) ou par le son (Ã©cho, musique spÃ©cifique).</p>`,
            example: 'Citizen Kane, Memento (structure inversÃ©e), Arrival.'
        },
        'sequence-montage': {
            title: 'SÃ©quence de montage',
            description: `<p>Suite de plans courts <strong>condensant le temps</strong> : entraÃ®nement, transformation, passage des saisons.</p>
            <p>Souvent accompagnÃ©e de musique. Montre une Ã©volution qui prendrait trop de temps en temps rÃ©el.</p>
            <p>ClichÃ© quand mal utilisÃ©e, puissante quand justifiÃ©e narrativement.</p>`,
            example: 'Rocky (entraÃ®nement), Scarface (ascension), tout film de sport.'
        },
        'split-screen': {
            title: 'Split screen (Ã‰cran divisÃ©)',
            description: `<p>Ã‰cran divisÃ© en plusieurs zones montrant des <strong>actions simultanÃ©es</strong> visibles en mÃªme temps.</p>
            <p>Alternative au montage alternÃ© : le spectateur voit tout sans coupe. CrÃ©e comparaison ou tension.</p>
            <p>Peut diviser en 2, 3, 4 zones ou plus. Signature de Brian De Palma.</p>`,
            example: 'Requiem for a Dream, 24 (sÃ©rie TV), Conversations secrÃ¨tes.'
        },
        'smash-cut': {
            title: 'Smash cut',
            description: `<p>Coupe <strong>brutale et inattendue</strong>, souvent d'une scÃ¨ne calme vers une scÃ¨ne intense (ou l'inverse).</p>
            <p>CrÃ©e un effet de choc, de surprise, de rupture. Aucune transition, aucun avertissement.</p>
            <p>Souvent utilisÃ© pour les rÃ©veils brutaux, les contrastes comiques ou dramatiques.</p>`,
            example: '"C est impossible !" SMASH CUT vers la scÃ¨ne oÃ¹ c est fait.'
        },
        // === MONTAGE - WORKFLOW ===
        'bout-a-bout': {
            title: 'Bout-Ã -bout (Assembly)',
            description: `<p>Premier assemblage chronologique des <strong>meilleures prises</strong> retenues.</p>
            <p>Pas encore du montage artistique : juste mettre les scÃ¨nes dans l'ordre. Peut durer 3-4h pour un film de 2h.</p>
            <p>Permet de voir l'ensemble du matÃ©riel et d'identifier les problÃ¨mes majeurs.</p>`,
            example: 'PremiÃ¨re Ã©tape aprÃ¨s le dÃ©rushage et la synchronisation.'
        },
        'rough-cut': {
            title: 'Ours / Rough cut',
            description: `<p>Premier <strong>montage complet</strong> du film, encore long et imparfait.</p>
            <p>Structure narrative en place, mais rythme pas encore affinÃ©. Contient souvent des scÃ¨nes qui seront coupÃ©es.</p>
            <p>Base de travail pour les retours du rÃ©alisateur et des producteurs.</p>`,
            example: 'GÃ©nÃ©ralement 20-30% plus long que le film final.'
        },
        'fine-cut': {
            title: 'Fine cut',
            description: `<p>Montage <strong>affinÃ©</strong> : rythme ajustÃ©, scÃ¨nes inutiles supprimÃ©es, timing prÃ©cis.</p>
            <p>Le film approche sa durÃ©e finale. Les choix majeurs sont faits, on peaufine les dÃ©tails.</p>
            <p>PrÃ©cÃ¨de le picture lock (verrouillage image) aprÃ¨s lequel on ne touche plus au montage.</p>`,
            example: 'Ã‰tape cruciale oÃ¹ chaque frame compte.'
        },
        // === PRODUCTION - Ã‰TAPES ===
        'developpement': {
            title: 'DÃ©veloppement',
            description: `<p>PremiÃ¨re phase d'un projet : <strong>Ã©criture du scÃ©nario</strong>, recherche de financements, montage du projet.</p>
            <p>Peut durer des mois ou des annÃ©es. Inclut : traitement, versions du script, recherche de producteur, casting prÃ©liminaire.</p>
            <p>Phase la plus incertaine : beaucoup de projets ne dÃ©passent jamais ce stade.</p>`,
            example: 'Certains scripts passent 10+ ans en dÃ©veloppement avant d Ãªtre tournÃ©s.'
        },
        'pre-production': {
            title: 'PrÃ©-production',
            description: `<p>Phase de <strong>prÃ©paration</strong> entre le feu vert et le premier jour de tournage.</p>
            <p>Inclut : dÃ©coupage technique, storyboard, casting, repÃ©rages, constitution de l'Ã©quipe, plan de travail, budget dÃ©taillÃ©.</p>
            <p>DurÃ©e typique : 2-6 mois selon l'ampleur du projet. Une bonne prÃ©pa = un tournage serein.</p>`,
            example: '"Un film se gagne ou se perd en prÃ©-production."'
        },
        'production-tournage': {
            title: 'Production (Tournage)',
            description: `<p>Phase de <strong>rÃ©alisation effective</strong> : camÃ©ra qui tourne, acteurs qui jouent.</p>
            <p>PÃ©riode la plus intense et la plus coÃ»teuse (Ã©quipe complÃ¨te sur le terrain chaque jour).</p>
            <p>DurÃ©e typique : 4-12 semaines pour un long-mÃ©trage. Chaque jour de retard coÃ»te trÃ¨s cher.</p>`,
            example: 'On dit "tourner un film" mais le tournage n est qu une phase parmi d autres.'
        },
        'post-production': {
            title: 'Post-production',
            description: `<p>Tout ce qui se passe <strong>aprÃ¨s le tournage</strong> : montage, Ã©talonnage, mixage, VFX, musique.</p>
            <p>Souvent plus longue que le tournage lui-mÃªme. C'est lÃ  que le film prend vraiment forme.</p>
            <p>DurÃ©e typique : 3-12 mois selon complexitÃ© (VFX lourds = plus long).</p>`,
            example: 'Un film Marvel peut passer 18 mois en post-production pour les VFX.'
        },
        'distribution': {
            title: 'Distribution',
            description: `<p>Phase de <strong>commercialisation</strong> : festivals, ventes internationales, sortie en salles, VOD, TV.</p>
            <p>Le distributeur achÃ¨te les droits et gÃ¨re : copies, marketing, programmation, relations presse.</p>
            <p>Un bon film mal distribuÃ© peut passer inaperÃ§u. La distribution est cruciale pour le succÃ¨s.</p>`,
            example: 'Cannes, Venise, Toronto = vitrines pour trouver des distributeurs.'
        },
        // === PRODUCTION - DOCUMENTS ===
        'budget-film': {
            title: 'Budget',
            description: `<p>Estimation dÃ©taillÃ©e de <strong>tous les coÃ»ts</strong> du film, divisÃ©e en postes et sous-postes.</p>
            <p><strong>Above the line</strong> : droits, scÃ©nario, rÃ©alisateur, producteur, acteurs principaux (coÃ»ts crÃ©atifs).</p>
            <p><strong>Below the line</strong> : Ã©quipe technique, matÃ©riel, dÃ©cors, post-production (coÃ»ts de fabrication).</p>`,
            example: 'Un budget bien fait prÃ©voit 10% de contingence pour les imprÃ©vus.'
        },
        'contrats-film': {
            title: 'Contrats',
            description: `<p>Documents juridiques <strong>encadrant les relations</strong> entre la production et tous les intervenants.</p>
            <p>Types : contrats d'engagement (Ã©quipe, acteurs), cession de droits (musique, scÃ©nario), accord de coproduction.</p>
            <p>Doivent prÃ©ciser : rÃ©munÃ©ration, droits cÃ©dÃ©s, crÃ©dits, durÃ©e, territoire, obligations.</p>`,
            example: 'CDDU (intermittents), contrats de cession de droits d auteur.'
        },
        // === PRODUCTION - POSTES CLÃ‰S ===
        'producteur': {
            title: 'Producteur',
            description: `<p>Responsable <strong>global du projet</strong> : financement, supervision crÃ©ative et logistique.</p>
            <p>Trouve l'argent, engage le rÃ©alisateur, supervise la production, prend les dÃ©cisions stratÃ©giques.</p>
            <p>Plusieurs types : producteur dÃ©lÃ©guÃ© (patron), exÃ©cutif (supervise), associÃ© (apporte quelque chose).</p>`,
            example: 'Le producteur a le final cut aux USA, le rÃ©alisateur en France (souvent).'
        },
        'directeur-production': {
            title: 'Directeur de production',
            description: `<p>Bras droit du producteur, gÃ¨re le <strong>budget et la logistique</strong> au quotidien.</p>
            <p>Ã‰tablit le budget dÃ©taillÃ©, nÃ©gocie les contrats, surveille les dÃ©penses, rÃ©sout les problÃ¨mes concrets.</p>
            <p>Interface entre les besoins artistiques et les contraintes financiÃ¨res.</p>`,
            example: 'C est lui qui dit "on n a pas le budget pour Ã§a" (ou trouve comment l avoir).'
        },
        'premier-assistant': {
            title: '1er Assistant rÃ©alisateur',
            description: `<p><strong>Chef d'orchestre du plateau</strong> : gÃ¨re le planning, le timing, la coordination de toute l'Ã©quipe.</p>
            <p>Ã‰tablit le plan de travail, organise chaque journÃ©e, annonce les ordres ("Silence, on tourne !").</p>
            <p>LibÃ¨re le rÃ©alisateur des contraintes logistiques pour qu'il se concentre sur l'artistique.</p>`,
            example: 'Le 1er AD connaÃ®t le plan de travail par cÅ“ur et anticipe tout.'
        },
        'regisseur': {
            title: 'RÃ©gisseur',
            description: `<p>Responsable de la <strong>logistique quotidienne</strong> : lieux, transports, repas, hÃ©bergement.</p>
            <p>NÃ©gocie les autorisations de tournage, organise les dÃ©cors, gÃ¨re les imprÃ©vus pratiques.</p>
            <p>Le "couteau suisse" de la production, doit rÃ©soudre tous les problÃ¨mes concrets.</p>`,
            example: 'Trouver 50 figurants pour demain, un camion de pompiers, et un repas vÃ©gan.'
        },
        // === IMAGE - FORMAT ===
        'ratio-169': {
            title: 'Format 16:9 (1.78:1)',
            description: `<p>Ratio <strong>standard actuel</strong> pour la tÃ©lÃ©vision HD, le streaming et la plupart des Ã©crans.</p>
            <p>Compromis entre le 4:3 tÃ©lÃ©visuel historique et le 1.85:1 cinÃ©ma. AdoptÃ© mondialement depuis les annÃ©es 2000.</p>
            <p>Format natif des capteurs HD, 4K, des Ã©crans TV et ordinateurs modernes.</p>`,
            example: 'Netflix, YouTube, tÃ©lÃ©vision HD, la majoritÃ© du contenu actuel.'
        },
        // === SCÃ‰NARIO - FORMAT ===
        'personnage-scenario': {
            title: 'Personnage (Character cue)',
            description: `<p>Nom du personnage en <strong>MAJUSCULES</strong>, centrÃ©, avant chaque rÃ©plique de dialogue.</p>
            <p>PremiÃ¨re apparition : nom suivi de (Ã¢ge) et brÃ¨ve description. Ensuite : juste le nom.</p>
            <p>CohÃ©rence obligatoire : toujours le mÃªme nom (pas "MARIE" puis "LA FEMME" pour le mÃªme personnage).</p>`,
            example: 'MARIE (30 ans, nerveuse, Ã©lÃ©gante malgrÃ© elle) entre dans le cafÃ©.'
        },
        'sfx': {
            title: 'Effets sonores (SFX)',
            description: `<p>Sons ponctuels synchronisÃ©s Ã  l'image : portes, pas, coups, vÃ©hicules, explosions.</p>
            <p>Peuvent Ãªtre <strong>rÃ©alistes</strong> (enregistrÃ©s) ou <strong>stylisÃ©s</strong> (crÃ©Ã©s pour l'effet dramatique).</p>
            <p>DiffÃ©rent du Foley (bruitage en studio) : SFX = sons prÃ©-enregistrÃ©s en bibliothÃ¨que ou crÃ©Ã©s en sound design.</p>`,
            example: 'Le sabre laser de Star Wars (SFX crÃ©Ã© par Ben Burtt).'
        },
        'lumiere-naturelle': {
            title: 'LumiÃ¨re naturelle',
            description: `<p>Utilisation exclusive ou principale du soleil comme source de lumiÃ¨re, sans Ã©clairage artificiel.</p>
            <p>CrÃ©e un <strong>rÃ©alisme</strong> et une authenticitÃ© uniques. Demande une grande maÃ®trise des horaires et de la mÃ©tÃ©o.</p>
            <p>Signature de Terrence Malick et Emmanuel Lubezki. Contraignant mais rÃ©sultats organiques.</p>`,
            image: `<img src="images/cours/lumiere-naturelle.jpeg" alt="LumiÃ¨re naturelle" class="w-full-r8">`,
            example: 'The Tree of Life, The Revenant, Days of Heaven.'
        },
        'decoupage-technique': {
            title: 'DÃ©coupage technique',
            description: `<p>Document dÃ©taillant plan par plan comment le scÃ©nario sera filmÃ© : valeurs de plan, mouvements, axes.</p>
            <p>Ã‰tabli par le rÃ©alisateur en prÃ©-production, c'est la <strong>partition</strong> du tournage.</p>
            <p>Peut Ãªtre accompagnÃ© d'un storyboard pour visualiser les plans complexes.</p>`,
            example: 'PrÃ©parÃ© par le rÃ©alisateur avec le 1er assistant.'
        },
        'plan-travail': {
            title: 'Plan de travail',
            description: `<p>Calendrier dÃ©taillÃ© du tournage, jour par jour, rÃ©partissant les scÃ¨nes du scÃ©nario.</p>
            <p>OptimisÃ© par dÃ©cor, disponibilitÃ© des comÃ©diens, contraintes jour/nuit, mÃ©tÃ©o, difficultÃ©s techniques.</p>
            <p>Document Ã©volutif, constamment ajustÃ© par le 1er assistant rÃ©alisateur. La colonne vertÃ©brale du tournage.</p>`,
            example: 'On ne tourne JAMAIS dans l ordre du scÃ©nario.'
        }
    },
    
    getCourses: () => ({
        scenario: `
            <div class="courses-section">
                <h2>ðŸ“ Les Fondamentaux du ScÃ©nario</h2>
                
                <h3><span class="notion" data-notion="structure-3-actes">La Structure en 3 Actes</span></h3>
                <p>La structure classique d'un scÃ©nario se divise en trois actes :</p>
                <ul>
                    <li><strong>Acte I - L'Exposition (25%)</strong> : PrÃ©sentation du personnage, de son monde et de l'Ã©lÃ©ment dÃ©clencheur qui lance l'histoire.</li>
                    <li><strong>Acte II - La Confrontation (50%)</strong> : Le personnage fait face Ã  des obstacles croissants. Contient le <span class="notion" data-notion="midpoint">point mÃ©dian</span> et la crise.</li>
                    <li><strong>Acte III - La RÃ©solution (25%)</strong> : Climax et dÃ©nouement. Le personnage atteint (ou non) son objectif.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Astuce :</strong> Une page de scÃ©nario = environ 1 minute de film. Un long-mÃ©trage fait gÃ©nÃ©ralement 90-120 pages.
                </div>
                
                <h3>Les Ã‰lÃ©ments ClÃ©s</h3>
                <ul>
                    <li><span class="notion" data-notion="protagoniste">Le protagoniste</span> : Personnage principal avec un objectif clair et des obstacles Ã  surmonter.</li>
                    <li><span class="notion" data-notion="antagoniste">L'antagoniste</span> : Force qui s'oppose au protagoniste (personne, institution, nature, lui-mÃªme).</li>
                    <li><span class="notion" data-notion="enjeu">L'enjeu</span> : Ce que le protagoniste risque de perdre s'il Ã©choue.</li>
                    <li><span class="notion" data-notion="conflit">Le conflit</span> : Moteur de l'histoire, crÃ©e la tension dramatique.</li>
                </ul>
                
                <h3>Le Format du ScÃ©nario</h3>
                <ul>
                    <li><span class="notion" data-notion="entete-scene">En-tÃªte de scÃ¨ne</span> : INT./EXT. - LIEU - MOMENT (ex: INT. APPARTEMENT - JOUR)</li>
                    <li><span class="notion" data-notion="action-scenario">Action</span> : Description au prÃ©sent, ce qu'on voit et entend.</li>
                    <li><span class="notion" data-notion="personnage-scenario">Personnage</span> : Nom en majuscules centrÃ© avant chaque dialogue.</li>
                    <li><span class="notion" data-notion="dialogue-scenario">Dialogue</span> : Ce que dit le personnage.</li>
                    <li><span class="notion" data-notion="didascalie">Didascalie</span> : Indication de jeu entre parenthÃ¨ses.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>âš ï¸ Attention :</strong> N'Ã©crivez jamais ce qu'on ne peut pas voir ou entendre (pensÃ©es, backstory non montrÃ©e).
                </div>
            </div>
            
            <div class="courses-section">
                <h2>ðŸŽ“ Pour Aller Plus Loin</h2>
                
                <h3><span class="notion" data-notion="voyage-heros">Le Voyage du HÃ©ros</span> (Joseph Campbell)</h3>
                <p>ThÃ©orisÃ© dans <em>"Le HÃ©ros aux mille visages"</em> (1949), ce modÃ¨le universel dÃ©crit le parcours archÃ©typal du hÃ©ros en 12 Ã©tapes :</p>
                <ul>
                    <li><strong>1. Le monde ordinaire</strong> : Le hÃ©ros dans son quotidien avant l'aventure.</li>
                    <li><strong>2. L'appel de l'aventure</strong> : Un Ã©vÃ©nement perturbe l'Ã©quilibre.</li>
                    <li><strong>3. Le refus de l'appel</strong> : HÃ©sitation, peur de l'inconnu.</li>
                    <li><strong>4. La rencontre avec le mentor</strong> : Un guide apporte sagesse ou outils.</li>
                    <li><strong>5. Le passage du premier seuil</strong> : EntrÃ©e dans le monde extraordinaire.</li>
                    <li><strong>6. Ã‰preuves, alliÃ©s et ennemis</strong> : Apprentissage des nouvelles rÃ¨gles.</li>
                    <li><strong>7. L'approche de la caverne</strong> : PrÃ©paration Ã  l'Ã©preuve centrale.</li>
                    <li><strong>8. L'Ã©preuve suprÃªme</strong> : Confrontation avec la plus grande peur.</li>
                    <li><strong>9. La rÃ©compense</strong> : Le hÃ©ros s'empare du trÃ©sor.</li>
                    <li><strong>10. Le chemin du retour</strong> : Course-poursuite vers le monde ordinaire.</li>
                    <li><strong>11. La rÃ©surrection</strong> : DerniÃ¨re Ã©preuve, transformation finale.</li>
                    <li><strong>12. Le retour avec l'Ã©lixir</strong> : Le hÃ©ros revient changÃ© avec un don pour les siens.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Application :</strong> Christopher Vogler a adaptÃ© ce modÃ¨le pour Hollywood dans <em>"The Writer's Journey"</em> (1992), devenu une rÃ©fÃ©rence dans les studios.
                </div>
                
                <h3>Le Paradigme de Syd Field</h3>
                <p>Dans <em>"Screenplay"</em> (1979), Syd Field formalise la structure en 3 actes avec des points prÃ©cis :</p>
                <ul>
                    <li><span class="notion" data-notion="plot-point">Plot Point 1 (page 25-27)</span> : Ã‰vÃ©nement qui fait basculer l'histoire vers l'Acte II.</li>
                    <li><span class="notion" data-notion="midpoint">Midpoint (page 60)</span> : RÃ©vÃ©lation ou retournement au milieu de l'Acte II.</li>
                    <li><span class="notion" data-notion="plot-point">Plot Point 2 (page 85-90)</span> : Lance le hÃ©ros vers le climax de l'Acte III.</li>
                </ul>
                
                <h3>Save the Cat! (Blake Snyder)</h3>
                <p><em>"Save the Cat!"</em> (2005) propose une structure ultra-prÃ©cise en 15 "beats" :</p>
                <ul>
                    <li><strong>Opening Image</strong> (p.1) : Ton et atmosphÃ¨re du film.</li>
                    <li><strong>Theme Stated</strong> (p.5) : Le thÃ¨me Ã©noncÃ© (souvent dans un dialogue).</li>
                    <li><strong>Set-Up</strong> (p.1-10) : PrÃ©sentation du monde et des personnages.</li>
                    <li><strong>Catalyst</strong> (p.12) : L'Ã©lÃ©ment dÃ©clencheur.</li>
                    <li><strong>Debate</strong> (p.12-25) : HÃ©sitation du hÃ©ros.</li>
                    <li><strong>Break into Two</strong> (p.25) : Choix d'entrer dans l'aventure.</li>
                    <li><strong>B Story</strong> (p.30) : Histoire secondaire (souvent l'amour).</li>
                    <li><strong>Fun and Games</strong> (p.30-55) : La "promesse du pitch".</li>
                    <li><strong>Midpoint</strong> (p.55) : Fausse victoire ou fausse dÃ©faite.</li>
                    <li><strong>Bad Guys Close In</strong> (p.55-75) : Pression croissante.</li>
                    <li><strong>All Is Lost</strong> (p.75) : Le point le plus bas.</li>
                    <li><strong>Dark Night of the Soul</strong> (p.75-85) : DÃ©sespoir avant la renaissance.</li>
                    <li><strong>Break into Three</strong> (p.85) : Solution trouvÃ©e.</li>
                    <li><strong>Finale</strong> (p.85-110) : ExÃ©cution du plan, climax.</li>
                    <li><strong>Final Image</strong> (p.110) : Miroir de l'image d'ouverture, preuve du changement.</li>
                </ul>
                
                <h3><span class="notion" data-notion="arc-transformationnel">L'Arc Transformationnel</span> du Personnage</h3>
                <p>Un personnage mÃ©morable subit une transformation intÃ©rieure :</p>
                <ul>
                    <li><span class="notion" data-notion="ghost">La Blessure (Ghost)</span> : Trauma du passÃ© qui dÃ©finit ses peurs.</li>
                    <li><span class="notion" data-notion="lie">La Croyance limitante (Lie)</span> : Ce que le personnage croit Ã  tort.</li>
                    <li><span class="notion" data-notion="besoin-vs-desir">Le Besoin vs le DÃ©sir</span> : Ce qu'il veut â‰  ce dont il a vraiment besoin.</li>
                    <li><span class="notion" data-notion="verite-personnage">La VÃ©ritÃ© (Truth)</span> : Ce qu'il doit apprendre pour Ã©voluer.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>âš ï¸ Attention :</strong> Certains films utilisent des arcs "nÃ©gatifs" (le personnage empire) ou "plats" (il reste fidÃ¨le Ã  ses valeurs malgrÃ© tout). Ces variations sont volontaires et puissantes.
                </div>
                
                <h3>ThÃ©ories Alternatives</h3>
                <ul>
                    <li><strong>Structure en 4 Actes</strong> (Kristin Thompson) : Divise l'Acte II en deux parties distinctes.</li>
                    <li><strong>SÃ©quences de 8</strong> (Frank Daniel) : 8 sÃ©quences de 12-15 minutes chacune.</li>
                    <li><strong>Story Circle</strong> (Dan Harmon) : Version simplifiÃ©e du voyage du hÃ©ros en 8 Ã©tapes.</li>
                    <li><strong>Kishotenketsu</strong> : Structure japonaise en 4 parties sans conflit central.</li>
                    <li><strong>Anti-structure</strong> (Robert McKee) : Films d'auteur qui dÃ©construisent les conventions.</li>
                </ul>
                
                <h3>ðŸ“š Ouvrages de RÃ©fÃ©rence</h3>
                <ul>
                    <li><strong>"Story"</strong> - Robert McKee (1997) : La bible de la narration, analyse approfondie des principes dramatiques.</li>
                    <li><strong>"Screenplay"</strong> - Syd Field (1979) : Le livre fondateur de la structure moderne.</li>
                    <li><strong>"Save the Cat!"</strong> - Blake Snyder (2005) : Approche pragmatique et commerciale.</li>
                    <li><strong>"The Writer's Journey"</strong> - Christopher Vogler (1992) : Adaptation du voyage du hÃ©ros.</li>
                    <li><strong>"Into the Woods"</strong> - John Yorke (2013) : Pourquoi les histoires fonctionnent.</li>
                    <li><strong>"L'anatomie du scÃ©nario"</strong> - John Truby (2010) : 22 Ã©tapes pour une histoire organique.</li>
                    <li><strong>"Le HÃ©ros aux mille visages"</strong> - Joseph Campbell (1949) : L'Å“uvre mythologique originelle.</li>
                    <li><strong>"PoÃ©tique"</strong> - Aristote (~335 av. J.-C.) : Les fondements millÃ©naires de la dramaturgie.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Conseil :</strong> Ã‰tudiez ces thÃ©ories, puis oubliez-les en Ã©crivant. Elles servent Ã  analyser et rÃ©Ã©crire, pas Ã  brider la crÃ©ativitÃ© du premier jet.
                </div>
            </div>
        `,
        
        realisation: `
            <div class="courses-section">
                <h2>ðŸŽ¬ Les Bases de la RÃ©alisation</h2>
                
                <h3>La PrÃ©paration (PrÃ©-production)</h3>
                <ul>
                    <li><span class="notion" data-notion="decoupage-technique">DÃ©coupage technique</span> : Transformer le scÃ©nario en plans Ã  tourner.</li>
                    <li><span class="notion" data-notion="storyboard">Storyboard</span> : Dessiner chaque plan pour visualiser le film.</li>
                    <li><span class="notion" data-notion="reperages">RepÃ©rages</span> : Trouver et valider les lieux de tournage.</li>
                    <li><span class="notion" data-notion="casting">Casting</span> : SÃ©lectionner les comÃ©diens.</li>
                    <li><span class="notion" data-notion="plan-travail">Plan de travail</span> : Organiser les journÃ©es de tournage.</li>
                </ul>
                
                <h3>Les Valeurs de Plan</h3>
                <ul>
                    <li><span class="notion" data-notion="plan-ensemble">Plan d'ensemble (PE)</span> : Situe l'action dans un dÃ©cor large.</li>
                    <li><span class="notion" data-notion="plan-large">Plan large (PL)</span> : Montre les personnages en pied dans leur environnement.</li>
                    <li><span class="notion" data-notion="plan-moyen">Plan moyen (PM)</span> : Personnage cadrÃ© Ã  mi-cuisse.</li>
                    <li><span class="notion" data-notion="plan-americain">Plan amÃ©ricain (PA)</span> : Personnage cadrÃ© au niveau des genoux.</li>
                    <li><span class="notion" data-notion="plan-rapproche">Plan rapprochÃ© (PR)</span> : CadrÃ© Ã  la poitrine ou aux Ã©paules.</li>
                    <li><span class="notion" data-notion="gros-plan">Gros plan (GP)</span> : Visage ou objet en entier.</li>
                    <li><span class="notion" data-notion="tres-gros-plan">TrÃ¨s gros plan (TGP)</span> : DÃ©tail (Å“il, main, objet).</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ RÃ¨gle des 180Â°</strong> : Imaginez une ligne entre deux personnages. Restez toujours du mÃªme cÃ´tÃ© pour maintenir la cohÃ©rence spatiale.
                </div>
                
                <h3>Diriger les ComÃ©diens</h3>
                <ul>
                    <li>Donnez des <strong>objectifs</strong> plutÃ´t que des Ã©motions ("tu veux le convaincre" vs "sois triste").</li>
                    <li>CrÃ©ez un <strong>climat de confiance</strong> sur le plateau.</li>
                    <li>Faites des <strong>rÃ©pÃ©titions</strong> avant le tournage.</li>
                    <li>Laissez les acteurs <strong>proposer</strong> et ajustez.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>ðŸŽ“ Pour Aller Plus Loin</h2>
                
                <h3>La Grammaire CinÃ©matographique</h3>
                <p>Chaque choix de plan est un mot, chaque sÃ©quence une phrase. Le rÃ©alisateur construit un langage visuel :</p>
                <ul>
                    <li><span class="notion" data-notion="plan-subjectif">Plan subjectif (POV)</span> : La camÃ©ra devient les yeux du personnage. CrÃ©e identification et immersion.</li>
                    <li><span class="notion" data-notion="plan-objectif">Plan objectif</span> : Point de vue neutre, observateur extÃ©rieur.</li>
                    <li><span class="notion" data-notion="plan-semi-subjectif">Plan semi-subjectif</span> : CamÃ©ra proche du personnage, partage son espace sans Ãªtre ses yeux.</li>
                    <li><span class="notion" data-notion="plongee">PlongÃ©e</span> : CamÃ©ra au-dessus du sujet. Ã‰crase, diminue, rend vulnÃ©rable.</li>
                    <li><span class="notion" data-notion="contre-plongee">Contre-plongÃ©e</span> : CamÃ©ra en dessous. Grandit, hÃ©roÃ¯se, menace.</li>
                    <li><span class="notion" data-notion="dutch-angle">Dutch angle</span> : CamÃ©ra inclinÃ©e. Malaise, dÃ©sÃ©quilibre, folie.</li>
                </ul>
                
                <h3>Les Axes de Regard et la GÃ©ographie</h3>
                <ul>
                    <li><span class="notion" data-notion="ligne-180">Ligne des 180Â°</span> : Axe imaginaire entre deux sujets. Ne jamais la franchir sans transition.</li>
                    <li><span class="notion" data-notion="ligne-30">Ligne des 30Â°</span> : Entre deux plans, changez au minimum de 30Â° pour Ã©viter le jump cut.</li>
                    <li><span class="notion" data-notion="raccord-regard">Raccord regard</span> : Si A regarde Ã  droite, B doit regarder Ã  gauche au plan suivant.</li>
                    <li><span class="notion" data-notion="champ-contrechamp">Champ/Contre-champ</span> : Alterner entre deux points de vue opposÃ©s (dialogue).</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>âš ï¸ Franchissement volontaire :</strong> Certains rÃ©alisateurs franchissent la ligne intentionnellement pour crÃ©er confusion ou rupture (ex: Kubrick dans Shining).
                </div>
                
                <h3>Les Techniques de Mise en ScÃ¨ne</h3>
                <ul>
                    <li><span class="notion" data-notion="blocking">Blocking</span> : Placement et dÃ©placement des acteurs dans le dÃ©cor. Un bon blocking raconte sans dialogue.</li>
                    <li><span class="notion" data-notion="staging">Staging</span> : Organisation des Ã©lÃ©ments dans le cadre pour guider le regard.</li>
                    <li><span class="notion" data-notion="plan-sequence">Plan-sÃ©quence</span> : Toute une scÃ¨ne en un seul plan. Demande chorÃ©graphie parfaite.</li>
                    <li><span class="notion" data-notion="oner">Oner</span> : Plan-sÃ©quence virtuose souvent en travelling complexe.</li>
                    <li><span class="notion" data-notion="split-focus">Split focus (diopter)</span> : Deux plans de nettetÃ© simultanÃ©s (De Palma).</li>
                </ul>
                
                <h3>Styles et Approches de RÃ©alisation</h3>
                <ul>
                    <li><span class="notion" data-notion="decoupage-classique">DÃ©coupage classique (Hollywood)</span> : Master shot + coverage. Montage fluide, invisible.</li>
                    <li><span class="notion" data-notion="decoupage-europeen">DÃ©coupage europÃ©en</span> : Plans plus longs, moins de coupes, respiration.</li>
                    <li><span class="notion" data-notion="camera-epaule">CamÃ©ra-Ã©paule</span> : Immersion documentaire, urgence, rÃ©alisme (Dardenne, Greengrass).</li>
                    <li><span class="notion" data-notion="steadicam">Steadicam</span> : FluiditÃ© onirique, exploration spatiale (Kubrick, Scorsese).</li>
                    <li><span class="notion" data-notion="oner">Style "oner"</span> : Tout ou partie du film en faux plan-sÃ©quence (Birdman, 1917).</li>
                    <li><span class="notion" data-notion="minimalisme">Minimalisme</span> : Ã‰conomie de moyens, cadres fixes, temps rÃ©el (Kiarostami, Haneke).</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Citation :</strong> "Un film se fait trois fois : Ã  lÃ©criture, au tournage et au montage." - Robert Bresson
                </div>
                
                <h3>Direction dActeurs : MÃ©thodes AvancÃ©es</h3>
                <ul>
                    <li><span class="notion" data-notion="stanislavski">MÃ©thode Stanislavski</span> : Recherche de la vÃ©ritÃ© Ã©motionnelle, mÃ©moire affective.</li>
                    <li><span class="notion" data-notion="actors-studio">Actors Studio (Lee Strasberg)</span> : Immersion totale dans le personnage.</li>
                    <li><span class="notion" data-notion="meisner">Technique Meisner</span> : RÃ©action instinctive, Ã©coute du partenaire.</li>
                    <li><span class="notion" data-notion="approche-bresson">Approche Bresson</span> : "ModÃ¨les" non-acteurs, rÃ©pÃ©tition jusquÃ  Ã©puisement du jeu.</li>
                    <li><span class="notion" data-notion="improvisation-dirigee">Improvisation dirigÃ©e</span> : Cadre dÃ©fini, libertÃ© dans lexÃ©cution (Cassavetes, Leigh).</li>
                </ul>
                
                <h3>ðŸ“š Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"Hitchcock/Truffaut"</strong> - FranÃ§ois Truffaut (1966) : Masterclass du maÃ®tre du suspense.</li>
                    <li><strong>"Notes sur le cinÃ©matographe"</strong> - Robert Bresson (1975) : Aphorismes dun puriste.</li>
                    <li><strong>"Faire un film"</strong> - Sidney Lumet (1995) : Guide pratique dun vÃ©tÃ©ran.</li>
                    <li><strong>"In the Blink of an Eye"</strong> - Walter Murch (2001) : RÃ©flexions sur le montage.</li>
                    <li><strong>"Rebel Without a Crew"</strong> - Robert Rodriguez (1995) : CinÃ©ma guÃ©rilla et dÃ©brouille.</li>
                    <li><strong>"On Directing Film"</strong> - David Mamet (1991) : Approche minimaliste et efficace.</li>
                    <li><strong>"Le Plaisir des yeux"</strong> - FranÃ§ois Truffaut : Ã‰crits sur le cinÃ©ma.</li>
                </ul>
                
                <h3>ðŸŽ¬ Films Ã  Ã‰tudier (Mise en ScÃ¨ne)</h3>
                <ul>
                    <li><strong>Citizen Kane</strong> (Welles, 1941) : Profondeur de champ, plongÃ©es, narration Ã©clatÃ©e.</li>
                    <li><strong>Vertigo</strong> (Hitchcock, 1958) : Effet vertigo (zoom/travelling opposÃ©s), obsession visuelle.</li>
                    <li><strong>Les Affranchis</strong> (Scorsese, 1990) : Steadicam lÃ©gendaire du Copacabana.</li>
                    <li><strong>Oldboy</strong> (Park Chan-wook, 2003) : Plan-sÃ©quence de combat latÃ©ral.</li>
                    <li><strong>Children of Men</strong> (CuarÃ³n, 2006) : Longs plans-sÃ©quences immersifs.</li>
                    <li><strong>Birdman</strong> (IÃ±Ã¡rritu, 2014) : Faux plan-sÃ©quence intÃ©gral.</li>
                </ul>
            </div>
        `,
        
        image: `
            <div class="courses-section">
                <h2>ðŸ“· L'Image CinÃ©matographique</h2>
                <h2>ðŸ“· L'Image CinÃ©matographique</h2>
                
                <h3>La Composition</h3>
                <ul>
                    <li><span class="notion" data-notion="regle-tiers">RÃ¨gle des tiers</span> : Placez les Ã©lÃ©ments importants sur les intersections d'une grille 3Ã—3.</li>
                    <li><span class="notion" data-notion="lignes-directrices">Lignes directrices</span> : Utilisez les lignes naturelles pour guider le regard.</li>
                    <li><span class="notion" data-notion="profondeur-champ">Profondeur de champ</span> : Jouez avec le flou pour isoler le sujet.</li>
                    <li><span class="notion" data-notion="headroom">Headroom</span> : Espace au-dessus de la tÃªte du sujet.</li>
                    <li><span class="notion" data-notion="looking-room">Looking room</span> : Espace devant le regard du personnage.</li>
                </ul>
                
                <h3>L'Ã‰clairage - Le Triangle de Base</h3>
                <ul>
                    <li><span class="notion" data-notion="key-light">Key Light (lumiÃ¨re principale)</span> : Source principale, dÃ©finit les ombres.</li>
                    <li><span class="notion" data-notion="fill-light">Fill Light (lumiÃ¨re de remplissage)</span> : Adoucit les ombres crÃ©Ã©es par la key.</li>
                    <li><span class="notion" data-notion="back-light">Back Light (contre-jour)</span> : SÃ©pare le sujet du fond, crÃ©e du relief.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Ratio d'Ã©clairage :</strong> Pour un look naturel, la fill light est 2 stops en dessous de la key. Pour un look dramatique, augmentez l'Ã©cart.
                </div>
                
                <h3>Les Mouvements de CamÃ©ra</h3>
                <ul>
                    <li><span class="notion" data-notion="panoramique">Panoramique</span> : Rotation horizontale ou verticale sur pied fixe.</li>
                    <li><span class="notion" data-notion="travelling">Travelling</span> : DÃ©placement physique de la camÃ©ra (avant, arriÃ¨re, latÃ©ral).</li>
                    <li><span class="notion" data-notion="zoom">Zoom</span> : Changement de focale (diffÃ©rent du travelling !).</li>
                    <li><span class="notion" data-notion="steadicam">Steadicam</span> : Travelling fluide avec harnais stabilisateur.</li>
                    <li><span class="notion" data-notion="grue-jib">Grue/Jib</span> : Mouvements verticaux amples.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>ðŸŽ“ Pour Aller Plus Loin</h2>
                
                <h3>Les Optiques et Leurs Effets</h3>
                <ul>
                    <li><span class="notion" data-notion="focale-courte">Focale courte (grand-angle, 16-35mm)</span> : ExagÃ¨re les perspectives, dÃ©forme les bords, agrandit les espaces. IdÃ©al pour oppression ou immensitÃ©.</li>
                    <li><span class="notion" data-notion="focale-normale">Focale normale (50mm)</span> : Proche de la vision humaine, naturelle et neutre.</li>
                    <li><span class="notion" data-notion="focale-longue">Focale longue (85-200mm)</span> : Compresse les distances, isole le sujet, flou darriÃ¨re-plan prononcÃ©. Portrait, intimitÃ©.</li>
                    <li><span class="notion" data-notion="anamorphique">Objectifs anamorphiques</span> : Ratio 2.39:1, flares horizontaux caractÃ©ristiques, bokeh ovale. Look "cinÃ©ma".</li>
                    <li><span class="notion" data-notion="macro">Macro</span> : TrÃ¨s gros plans sur petits objets (insectes, textures).</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Astuce focale :</strong> Spielberg utilise souvent des focales courtes prÃ¨s des visages pour crÃ©er malaise. Kubrick prÃ©fÃ©rait les focales trÃ¨s courtes (9.8mm dans Barry Lyndon).
                </div>
                
                <h3>Techniques dÃ‰clairage AvancÃ©es</h3>
                <ul>
                    <li><span class="notion" data-notion="high-key">High-key</span> : Ã‰clairage uniforme, peu dombres. ComÃ©dies, sitcoms, publicitÃ©.</li>
                    <li><span class="notion" data-notion="low-key">Low-key</span> : Forts contrastes, ombres marquÃ©es. Film noir, thriller, horreur.</li>
                    <li><span class="notion" data-notion="chiaroscuro">Chiaroscuro</span> : Clair-obscur inspirÃ© de la peinture (Caravage). Drame intense.</li>
                    <li><span class="notion" data-notion="rembrandt-lighting">Rembrandt lighting</span> : Triangle de lumiÃ¨re sous un Å“il. Portrait classique.</li>
                    <li><span class="notion" data-notion="lumiere-pratique">LumiÃ¨re pratique</span> : Sources visibles Ã  lÃ©cran (lampes, bougies, Ã©crans).</li>
                    <li><span class="notion" data-notion="lumiere-naturelle">LumiÃ¨re naturelle</span> : Utilisation exclusive du soleil (Malick, Lubezki).</li>
                    <li><span class="notion" data-notion="magic-hour">Magic hour</span> : Tournage Ã  laube ou au crÃ©puscule pour lumiÃ¨re dorÃ©e.</li>
                </ul>
                
                <h3>La ColorimÃ©trie</h3>
                <ul>
                    <li><span class="notion" data-notion="temperature-couleur">TempÃ©rature de couleur</span> : Kelvin (K). 3200K = tungstÃ¨ne chaud, 5600K = lumiÃ¨re du jour.</li>
                    <li><span class="notion" data-notion="balance-blancs">Balance des blancs</span> : Calibrer la camÃ©ra pour que le blanc soit neutre.</li>
                    <li><span class="notion" data-notion="lut">LUT (Look-Up Table)</span> : PrÃ©rÃ©glage de correction colorimÃ©trique.</li>
                    <li><span class="notion" data-notion="log-raw">LOG / RAW</span> : Profils plats qui conservent maximum dinformations pour lÃ©talonnage.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>âš ï¸ MÃ©lange de sources :</strong> Attention aux mÃ©langes tungstÃ¨ne/daylight non voulus. Utilisez des gÃ©latines (CTO/CTB) pour harmoniser.
                </div>
                
                <h3>Formats et Ratios dImage</h3>
                <ul>
                    <li><span class="notion" data-notion="ratio-43">1.33:1 (4:3)</span> : Format classique, tÃ©lÃ©vision ancienne, intimiste.</li>
                    <li><span class="notion" data-notion="ratio-185">1.85:1</span> : Standard cinÃ©ma amÃ©ricain.</li>
                    <li><span class="notion" data-notion="ratio-scope">2.39:1 (Scope)</span> : CinÃ©mascope, Ã©pique, paysages.</li>
                    <li><span class="notion" data-notion="ratio-169">16:9 (1.78:1)</span> : Standard HD/TV actuel.</li>
                    <li><span class="notion" data-notion="ratio-imax">IMAX (1.43:1)</span> : Format gÃ©ant immersif.</li>
                </ul>
                
                <h3>Le Cadre comme Outil Narratif</h3>
                <ul>
                    <li><span class="notion" data-notion="cadre-ferme">Cadre fermÃ©</span> : Ã‰lÃ©ments qui emprisonnent (portes, fenÃªtres). Oppression.</li>
                    <li><span class="notion" data-notion="cadre-ouvert">Cadre ouvert</span> : Espace libre, personnage peut sortir du champ. LibertÃ©.</li>
                    <li><span class="notion" data-notion="surcadrage">Surcadrage</span> : Cadre dans le cadre (miroir, Ã©cran, porte). Mise en abyme.</li>
                    <li><span class="notion" data-notion="amorce">Amorce</span> : Ã‰lÃ©ment flou au premier plan. Profondeur, voyeurisme.</li>
                    <li><span class="notion" data-notion="hors-champ">Hors-champ</span> : Ce quon ne voit pas mais devine. Suggestion puissante.</li>
                </ul>
                
                <h3>ðŸ“š Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"Painting with Light"</strong> - John Alton (1949) : Bible de lÃ©clairage hollywoodien.</li>
                    <li><strong>"Cinematography: Theory and Practice"</strong> - Blain Brown : Manuel technique complet.</li>
                    <li><strong>"Masters of Light"</strong> - Dennis Schaefer : Interviews de grands directeurs photo.</li>
                    <li><strong>"FilmCraft: Cinematography"</strong> - Mike Goodridge : TÃ©moignages contemporains.</li>
                    <li><strong>"The Visual Story"</strong> - Bruce Block : Narration visuelle et composition.</li>
                </ul>
                
                <h3>ðŸŽ¬ Films Ã  Ã‰tudier (Direction Photo)</h3>
                <ul>
                    <li><strong>Blade Runner</strong> (Jordan Cronenweth, 1982) : NÃ©ons, fumÃ©e, low-key futuriste.</li>
                    <li><strong>Barry Lyndon</strong> (John Alcott, 1975) : Ã‰clairage Ã  la bougie, lumiÃ¨re naturelle.</li>
                    <li><strong>The Revenant</strong> (Emmanuel Lubezki, 2015) : LumiÃ¨re naturelle exclusive.</li>
                    <li><strong>In the Mood for Love</strong> (Christopher Doyle, 2000) : Couleurs saturÃ©es, surcadrages.</li>
                    <li><strong>Skyfall</strong> (Roger Deakins, 2012) : Silhouettes, contre-jours, couleurs symboliques.</li>
                    <li><strong>AmÃ©lie Poulain</strong> (Bruno Delbonnel, 2001) : Palette verte/rouge distinctive.</li>
                </ul>
            </div>
        `,
        
        son: `
            <div class="courses-section">
                <h2>ðŸŽ¤ La Prise de Son</h2>
                
                <h3>Les Types de Microphones</h3>
                <ul>
                    <li><span class="notion" data-notion="micro-canon">Canon (shotgun)</span> : Directionnel, idÃ©al pour isoler une source. UtilisÃ© sur perche.</li>
                    <li><span class="notion" data-notion="micro-cravate">Cravate (lavalier)</span> : Micro miniature fixÃ© sur le comÃ©dien. Discret mais risque de frottements.</li>
                    <li><span class="notion" data-notion="micro-omni">Omnidirectionnel</span> : Capte dans toutes les directions. Bon pour les ambiances.</li>
                </ul>
                
                <h3>RÃ¨gles de Base</h3>
                <ul>
                    <li><strong>ProximitÃ©</strong> : Plus le micro est proche, meilleur est le son (sans entrer dans le cadre !).</li>
                    <li><strong>Orientation</strong> : Le micro canon doit pointer vers la bouche de l'acteur.</li>
                    <li><strong>Ambiance</strong> : Toujours enregistrer 1-2 min de "silence" de chaque lieu.</li>
                    <li><strong>Son tÃ©moin</strong> : Le son de la camÃ©ra sert uniquement Ã  la synchronisation.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>âš ï¸ Ennemis du son :</strong> Climatisation, frigos, nÃ©ons, avions, circulation, vent, vÃªtements synthÃ©tiques.
                </div>
                
                <h3>Les Niveaux</h3>
                <ul>
                    <li>Dialogues : viser <strong>-12 dB Ã  -6 dB</strong> en crÃªte.</li>
                    <li>Ne jamais dÃ©passer <strong>0 dB</strong> (saturation = irrÃ©cupÃ©rable).</li>
                    <li>Toujours surveiller au <strong>casque</strong> pendant l'enregistrement.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>ðŸŽ“ Pour Aller Plus Loin</h2>
                
                <h3>Les Couches Sonores dun Film</h3>
                <p>Le son au cinÃ©ma se compose de plusieurs Ã©lÃ©ments superposÃ©s :</p>
                <ul>
                    <li><span class="notion" data-notion="dialogues-son">Dialogues</span> : Voix des personnages, Ã©lÃ©ment principal Ã  protÃ©ger.</li>
                    <li><span class="notion" data-notion="ambiance-son">Ambiances</span> : Son continu dun lieu (ville, forÃªt, intÃ©rieur). CrÃ©e lespace.</li>
                    <li><span class="notion" data-notion="sfx">Effets sonores (SFX)</span> : Sons ponctuels synchronisÃ©s (portes, pas, objets).</li>
                    <li><span class="notion" data-notion="foley">Foley</span> : Bruitages recrÃ©Ã©s en studio (pas, vÃªtements, manipulations).</li>
                    <li><span class="notion" data-notion="musique-film">Musique</span> : Score original ou morceaux existants.</li>
                    <li><span class="notion" data-notion="silence-cinematographique">Silence</span> : Outil dramatique puissant, souvent sous-estimÃ©.</li>
                </ul>
                
                <h3>Son DiÃ©gÃ©tique vs Extra-diÃ©gÃ©tique</h3>
                <ul>
                    <li><span class="notion" data-notion="son-diegetique">DiÃ©gÃ©tique</span> : Source sonore prÃ©sente dans lunivers du film (radio, musicien Ã  lÃ©cran).</li>
                    <li><span class="notion" data-notion="son-extra-diegetique">Extra-diÃ©gÃ©tique</span> : Son ajoutÃ© que les personnages nentendent pas (musique de film, voix-off).</li>
                    <li><span class="notion" data-notion="meta-diegetique">Meta-diÃ©gÃ©tique</span> : Son subjectif (acouphÃ¨ne, battement de cÅ“ur, souvenir sonore).</li>
                    <li><span class="notion" data-notion="trans-diegetique">Trans-diÃ©gÃ©tique</span> : Passage dun Ã©tat Ã  lautre (musique qui devient diÃ©gÃ©tique).</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Exemple :</strong> Dans Apocalypse Now, "The End" des Doors passe de musique extra-diÃ©gÃ©tique Ã  la radio de lhÃ©licoptÃ¨re (diÃ©gÃ©tique).
                </div>
                
                <h3>Techniques de Prise de Son AvancÃ©es</h3>
                <ul>
                    <li><span class="notion" data-notion="double-systeme">Double systÃ¨me</span> : Enregistrement sÃ©parÃ© camÃ©ra/enregistreur. QualitÃ© professionnelle.</li>
                    <li><span class="notion" data-notion="multi-pistes">Multi-pistes</span> : Chaque micro sur une piste sÃ©parÃ©e pour flexibilitÃ© au mixage.</li>
                    <li><span class="notion" data-notion="ms-stereo">MS (Mid-Side)</span> : Configuration stÃ©rÃ©o avec contrÃ´le de largeur en post.</li>
                    <li><span class="notion" data-notion="boom-vs-lav">Boom vs Lav</span> : Perche = naturel mais risquÃ© / Cravate = sÃ©curitÃ© mais moins naturel.</li>
                    <li><span class="notion" data-notion="plant-mic">Plant mic</span> : Micro cachÃ© dans le dÃ©cor pour plans larges.</li>
                    <li><span class="notion" data-notion="wild-tracks">Wild tracks</span> : Enregistrements sonores sans image (ambiances, effets).</li>
                </ul>
                
                <h3>Le Sound Design</h3>
                <ul>
                    <li><span class="notion" data-notion="worldizing">Worldizing</span> : Rejouer un son dans un espace rÃ©el et le rÃ©enregistrer (Walter Murch).</li>
                    <li><span class="notion" data-notion="layering">Layering</span> : Superposer plusieurs sons pour en crÃ©er un nouveau.</li>
                    <li><span class="notion" data-notion="pitch-shifting">Pitch shifting</span> : Modifier la hauteur (ralentir un cri animal = monstre).</li>
                    <li><span class="notion" data-notion="sound-metaphor">Sound metaphor</span> : Son qui reprÃ©sente une idÃ©e (battement = tension).</li>
                    <li><span class="notion" data-notion="leitmotiv-sonore">Leitmotiv sonore</span> : Son rÃ©current associÃ© Ã  un personnage ou thÃ¨me.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>âš ï¸ PiÃ¨ge frÃ©quent :</strong> Trop de musique tue lÃ©motion. Le silence avant un moment fort amplifie limpact.
                </div>
                
                <h3>Le Mixage - Ã‰quilibrer les Ã‰lÃ©ments</h3>
                <ul>
                    <li><span class="notion" data-notion="dialogues-son">PrioritÃ© dialogues</span> : Toujours intelligibles sauf choix artistique.</li>
                    <li><span class="notion" data-notion="ducking">Ducking</span> : Baisser automatiquement la musique sous les dialogues.</li>
                    <li><span class="notion" data-notion="panning">Panoramique (panning)</span> : Placer les sons dans lespace stÃ©rÃ©o/surround.</li>
                    <li><span class="notion" data-notion="lfe">LFE (caisson de basses)</span> : Canal dÃ©diÃ© aux basses frÃ©quences (explosions, impacts).</li>
                    <li><span class="notion" data-notion="stems">Stems</span> : Groupes sÃ©parÃ©s (DX, MX, FX) pour versions internationales.</li>
                </ul>
                
                <h3>Formats Audio au CinÃ©ma</h3>
                <ul>
                    <li><span class="notion" data-notion="formats-audio">Mono</span> : Un seul canal. Historique.</li>
                    <li><span class="notion" data-notion="formats-audio">StÃ©rÃ©o (2.0)</span> : Gauche/Droite. Standard minimal.</li>
                    <li><span class="notion" data-notion="surround-51">5.1 Surround</span> : 5 canaux + 1 LFE. Standard cinÃ©ma actuel.</li>
                    <li><span class="notion" data-notion="formats-audio">7.1</span> : Ajout de surrounds latÃ©raux.</li>
                    <li><span class="notion" data-notion="dolby-atmos">Dolby Atmos</span> : Son objet, placement 3D prÃ©cis, plafond.</li>
                </ul>
                
                <h3>ðŸ“š Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"Sound Design"</strong> - David Sonnenschein : ThÃ©orie et pratique du design sonore.</li>
                    <li><strong>"The Filmmaker Handbook"</strong> - Ascher & Pincus : Chapitre son trÃ¨s complet.</li>
                    <li><strong>"Audio-Vision"</strong> - Michel Chion (1990) : ThÃ©orie du son au cinÃ©ma, rÃ©fÃ©rence acadÃ©mique.</li>
                    <li><strong>"Sound for Film and Television"</strong> - Tomlinson Holman : Manuel technique.</li>
                    <li><strong>"Practical Art of Motion Picture Sound"</strong> - David Yewdall : ExpÃ©rience de terrain.</li>
                </ul>
                
                <h3>ðŸŽ¬ Films Ã  Ã‰tudier (Sound Design)</h3>
                <ul>
                    <li><strong>Apocalypse Now</strong> (Walter Murch, 1979) : RÃ©volution du sound design, premier 5.1.</li>
                    <li><strong>Gravity</strong> (Glenn Freemantle, 2013) : Son dans le vide, vibrations par contact.</li>
                    <li><strong>A Quiet Place</strong> (2018) : Le silence comme tension, son subjectif.</li>
                    <li><strong>No Country for Old Men</strong> (Skip Lievsay, 2007) : Absence quasi-totale de musique.</li>
                    <li><strong>WALL-E</strong> (Ben Burtt, 2008) : Personnages dÃ©finis par leurs sons.</li>
                    <li><strong>Dunkirk</strong> (Richard King, 2017) : Son immersif, Shepard tone.</li>
                </ul>
            </div>
        `,
        
        montage: `
            <div class="courses-section">
                <h2>âœ‚ï¸ Le Montage</h2>
                
                <h3>Les Types de Raccords</h3>
                <ul>
                    <li><span class="notion" data-notion="raccord-axe">Raccord dans l'axe</span> : Changement de valeur sur le mÃªme axe (PE â†’ GP).</li>
                    <li><span class="notion" data-notion="raccord-regard">Raccord regard</span> : On montre ce que voit le personnage.</li>
                    <li><span class="notion" data-notion="raccord-mouvement">Raccord mouvement</span> : Coupe pendant une action pour fluidifier.</li>
                    <li><span class="notion" data-notion="champ-contrechamp">Champ/Contre-champ</span> : Alternance entre deux personnages qui dialoguent.</li>
                    <li><span class="notion" data-notion="match-cut">Match cut</span> : Raccord sur une forme ou mouvement similaire.</li>
                </ul>
                
                <h3>Erreurs Ã  Ã‰viter</h3>
                <ul>
                    <li><span class="notion" data-notion="jump-cut">Jump cut</span> : Saute dans le temps sur le mÃªme plan (sauf effet voulu).</li>
                    <li><span class="notion" data-notion="franchissement-axe">Franchissement d'axe</span> : Passer de l'autre cÃ´tÃ© de la ligne des 180Â°.</li>
                    <li><span class="notion" data-notion="faux-raccord">Faux raccord</span> : IncohÃ©rence d'accessoire, position, lumiÃ¨re entre deux plans.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ RÃ¨gle du 30Â°</strong> : Entre deux plans de la mÃªme scÃ¨ne, changez l'angle d'au moins 30Â° pour Ã©viter le jump cut.
                </div>
                
                <h3>Le Rythme</h3>
                <ul>
                    <li>Coupez sur l'<strong>action</strong>, pas avant ni aprÃ¨s.</li>
                    <li>Laissez les plans <strong>respirer</strong> - ne coupez pas trop vite.</li>
                    <li>Le rythme suit l'<strong>Ã©motion</strong> : rapide = tension, lent = contemplation.</li>
                    <li>Utilisez les <strong>rÃ©actions</strong> autant que les actions.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>ðŸŽ“ Pour Aller Plus Loin</h2>
                
                <h3>Les ThÃ©ories du Montage</h3>
                <p>Le montage nest pas quune technique, cest un langage avec ses thÃ©oriciens :</p>
                <ul>
                    <li><span class="notion" data-notion="effet-koulechov">Effet Koulechov</span> : Un mÃªme visage neutre + images diffÃ©rentes = Ã©motions diffÃ©rentes perÃ§ues. Le montage crÃ©e le sens.</li>
                    <li><span class="notion" data-notion="montage-intellectuel">Montage intellectuel (Eisenstein)</span> : La collision de deux plans crÃ©e une idÃ©e nouvelle (thÃ¨se + antithÃ¨se = synthÃ¨se).</li>
                    <li><span class="notion" data-notion="montage-invisible">Montage invisible (Hollywood classique)</span> : Coupes fluides, le spectateur oublie quil regarde un film.</li>
                    <li><span class="notion" data-notion="montage-visible">Montage visible (Godard, Nouvelle Vague)</span> : Jump cuts assumÃ©s, rappel constant du mÃ©dium.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Citation :</strong> "Le cinÃ©ma, cest 24 fois la vÃ©ritÃ© par seconde" - Jean-Luc Godard. Mais le montage choisit quelles vÃ©ritÃ©s.
                </div>
                
                <h3>Les 5 Types de Montage selon Eisenstein</h3>
                <ul>
                    <li><span class="notion" data-notion="montage-metrique">MÃ©trique</span> : Coupe Ã  intervalles rÃ©guliers, indÃ©pendamment du contenu. CrÃ©e un rythme mÃ©canique.</li>
                    <li><span class="notion" data-notion="montage-rythmique">Rythmique</span> : Coupe selon le mouvement dans le plan. Le contenu dicte le rythme.</li>
                    <li><span class="notion" data-notion="montage-tonal">Tonal</span> : Coupe selon lÃ©motion dominante du plan (lumiÃ¨re, atmosphÃ¨re).</li>
                    <li><strong>Harmonique</strong> : Combinaison de tous les Ã©lÃ©ments (rythme, ton, mouvement).</li>
                    <li><span class="notion" data-notion="montage-intellectuel">Intellectuel</span> : Juxtaposition pour crÃ©er une mÃ©taphore ou une idÃ©e abstraite.</li>
                </ul>
                
                <h3>Techniques de Montage AvancÃ©es</h3>
                <ul>
                    <li><span class="notion" data-notion="montage-parallele">Montage parallÃ¨le (cross-cutting)</span> : Alterner entre deux actions simultanÃ©es. Tension, comparaison.</li>
                    <li><span class="notion" data-notion="montage-alterne">Montage alternÃ©</span> : Deux temporalitÃ©s diffÃ©rentes entrelacÃ©es.</li>
                    <li><span class="notion" data-notion="flashback">Flashback / Flash-forward</span> : Rupture temporelle vers le passÃ© ou le futur.</li>
                    <li><span class="notion" data-notion="ellipse">Ellipse</span> : Saut dans le temps. Ã‰conomie narrative.</li>
                    <li><span class="notion" data-notion="sequence-montage">SÃ©quence de montage</span> : Condensation du temps (entraÃ®nement, transformation).</li>
                    <li><span class="notion" data-notion="split-screen">Split screen</span> : Ã‰cran divisÃ©, actions simultanÃ©es visibles.</li>
                    <li><span class="notion" data-notion="smash-cut">Smash cut</span> : Coupe brutale et inattendue pour effet de choc.</li>
                    <li><span class="notion" data-notion="l-cut-j-cut">L-cut / J-cut</span> : Le son prÃ©cÃ¨de ou suit limage. FluiditÃ©, anticipation.</li>
                </ul>
                
                <h3>Le Workflow de Post-production</h3>
                <ul>
                    <li><strong>Synchro/DÃ©rushage</strong> : Synchroniser son et image, organiser les mÃ©dias.</li>
                    <li><span class="notion" data-notion="bout-a-bout">Bout-Ã -bout</span> : Premier assemblage chronologique des prises retenues.</li>
                    <li><span class="notion" data-notion="rough-cut">Ours (rough cut)</span> : Premier montage complet, encore long.</li>
                    <li><span class="notion" data-notion="fine-cut">Fine cut</span> : Montage affinÃ©, rythme ajustÃ©.</li>
                    <li><span class="notion" data-notion="picture-lock">Picture lock</span> : Montage image validÃ©, plus de modifications.</li>
                    <li><strong>Conformation</strong> : Remplacement des proxies par les fichiers haute qualitÃ©.</li>
                    <li><span class="notion" data-notion="etalonnage">Ã‰talonnage</span> : Correction colorimÃ©trique et crÃ©ation du look.</li>
                    <li><strong>Mixage</strong> : Ã‰quilibrage final de toutes les pistes audio.</li>
                    <li><strong>Mastering</strong> : Export final dans les formats de diffusion.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>âš ï¸ Kill your darlings :</strong> Parfois les meilleures scÃ¨nes doivent Ãªtre coupÃ©es pour le bien du film. Le monteur doit Ãªtre objectif.
                </div>
                
                <h3>Psychologie du Montage</h3>
                <ul>
                    <li><strong>Point de coupe idÃ©al</strong> : Souvent sur un clignement dyeux ou un mouvement de tÃªte.</li>
                    <li><strong>Regard du spectateur</strong> : Guider lÅ“il dun plan Ã  lautre (eye trace).</li>
                    <li><strong>RÃ¨gle des 6 (Walter Murch)</strong> : Ã‰motion (51%) > Histoire (23%) > Rythme (10%) > Eye trace (7%) > PlanÃ©itÃ© 2D (5%) > Espace 3D (4%).</li>
                    <li><strong>DurÃ©e des plans</strong> : Plus le plan est complexe visuellement, plus il peut durer.</li>
                </ul>
                
                <h3>Outils et Logiciels</h3>
                <ul>
                    <li><strong>Adobe Premiere Pro</strong> : Standard industrie, intÃ©gration Creative Cloud.</li>
                    <li><strong>DaVinci Resolve</strong> : Gratuit et pro, excellent Ã©talonnage intÃ©grÃ©.</li>
                    <li><strong>Final Cut Pro X</strong> : Ã‰cosystÃ¨me Apple, timeline magnÃ©tique.</li>
                    <li><strong>Avid Media Composer</strong> : Standard cinÃ©ma/TV haut de gamme.</li>
                </ul>
                
                <h3>ðŸ“š Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"In the Blink of an Eye"</strong> - Walter Murch (2001) : Philosophie du montage par un maÃ®tre.</li>
                    <li><strong>"The Technique of Film Editing"</strong> - Karel Reisz (1953) : Classique technique britannique.</li>
                    <li><strong>"Film Editing: Theory and Practice"</strong> - Christopher Llewellyn Reed : Manuel contemporain.</li>
                    <li><strong>"The Conversations"</strong> - Michael Ondaatje & Walter Murch : Dialogue fascinant sur le mÃ©tier.</li>
                    <li><strong>"Cut by Cut"</strong> - Gael Chandler : Guide pratique moderne.</li>
                </ul>
                
                <h3>ðŸŽ¬ Films Ã  Ã‰tudier (Montage)</h3>
                <ul>
                    <li><strong>Le CuirassÃ© Potemkine</strong> (Eisenstein, 1925) : Escalier dOdessa, montage intellectuel.</li>
                    <li><strong>Ã€ bout de souffle</strong> (Godard, 1960) : Jump cuts rÃ©volutionnaires.</li>
                    <li><strong>Apocalypse Now</strong> (Walter Murch, 1979) : Montage et son visionnaires.</li>
                    <li><strong>Requiem for a Dream</strong> (2000) : Montage hip-hop, split screens.</li>
                    <li><strong>Mad Max: Fury Road</strong> (2015) : Centre du cadre constant, rythme effrÃ©nÃ©.</li>
                    <li><strong>Whiplash</strong> (2014) : Montage musical, tension rythmique.</li>
                </ul>
            </div>
        `,
        
        production: `
            <div class="courses-section">
                <h2>ðŸ’¼ La Production</h2>
                
                <h3>Les Ã‰tapes d'un Film</h3>
                <ul>
                    <li><span class="notion" data-notion="developpement">DÃ©veloppement</span> : Ã‰criture, recherche de financements, montage du projet.</li>
                    <li><span class="notion" data-notion="pre-production">PrÃ©-production</span> : Casting, repÃ©rages, planning, constitution de l'Ã©quipe.</li>
                    <li><span class="notion" data-notion="production-tournage">Production (tournage)</span> : RÃ©alisation effective du film.</li>
                    <li><span class="notion" data-notion="post-production">Post-production</span> : Montage, Ã©talonnage, mixage, VFX.</li>
                    <li><span class="notion" data-notion="distribution">Distribution</span> : Festivals, vente, diffusion.</li>
                </ul>
                
                <h3>Documents Essentiels</h3>
                <ul>
                    <li><span class="notion" data-notion="plan-travail">Plan de travail</span> : Calendrier dÃ©taillÃ© du tournage jour par jour.</li>
                    <li><span class="notion" data-notion="feuille-service">Feuille de service</span> : Programme quotidien (horaires, lieux, scÃ¨nes, Ã©quipe).</li>
                    <li><span class="notion" data-notion="depouillement">DÃ©pouillement</span> : Liste des besoins par scÃ¨ne (dÃ©cors, costumes, accessoires).</li>
                    <li><span class="notion" data-notion="budget-film">Budget</span> : Estimation dÃ©taillÃ©e des coÃ»ts.</li>
                    <li><span class="notion" data-notion="contrats-film">Contrats</span> : Engagements avec l'Ã©quipe et les comÃ©diens.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ Ordre de tournage :</strong> On ne tourne pas dans l'ordre du scÃ©nario ! On regroupe par lieu, disponibilitÃ© des acteurs, et conditions (jour/nuit).
                </div>
                
                <h3>Postes ClÃ©s</h3>
                <ul>
                    <li><span class="notion" data-notion="producteur">Producteur</span> : Finance et supervise l'ensemble du projet.</li>
                    <li><span class="notion" data-notion="directeur-production">Directeur de production</span> : GÃ¨re le budget et la logistique.</li>
                    <li><span class="notion" data-notion="premier-assistant">1er assistant rÃ©alisateur</span> : Organise le tournage, gÃ¨re le planning.</li>
                    <li><span class="notion" data-notion="regisseur">RÃ©gisseur</span> : Logistique quotidienne (lieux, repas, transport).</li>
                    <li><span class="notion" data-notion="scripte">Scripte</span> : Garant de la continuitÃ© entre les plans.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>ðŸŽ“ Pour Aller Plus Loin</h2>
                
                <h3>Organigramme Complet dun Tournage</h3>
                <p><strong>DÃ©partement RÃ©alisation :</strong></p>
                <ul>
                    <li><strong>RÃ©alisateur</strong> : Vision artistique, direction des acteurs et de lÃ©quipe.</li>
                    <li><strong>1er Assistant RÃ©alisateur</strong> : Planning, organisation plateau, annonces.</li>
                    <li><strong>2Ã¨me Assistant RÃ©alisateur</strong> : Feuilles de service, coordination comÃ©diens.</li>
                    <li><strong>3Ã¨me Assistant / Stagiaire</strong> : Appui logistique, clap.</li>
                    <li><strong>Scripte</strong> : ContinuitÃ©, raccords, chronomÃ©trage, rapport image.</li>
                </ul>
                
                <p><strong>DÃ©partement Image :</strong></p>
                <ul>
                    <li><span class="notion" data-notion="chef-op">Directeur de la Photographie (Chef Op)</span> : Ã‰clairage, cadre, look.</li>
                    <li><strong>Cadreur</strong> : OpÃ¨re la camÃ©ra selon les directives.</li>
                    <li><strong>1er Assistant CamÃ©ra (Pointeur)</strong> : Mise au point, gestion optiques.</li>
                    <li><strong>2Ã¨me Assistant CamÃ©ra</strong> : Clap, rapport camÃ©ra, mÃ©dias.</li>
                    <li><strong>Chef Ã‰lectricien</strong> : Installation et rÃ©glage des Ã©clairages.</li>
                    <li><strong>Chef Machiniste</strong> : Mouvements de camÃ©ra, grip.</li>
                    <li><strong>DIT (Digital Imaging Technician)</strong> : Gestion des mÃ©dias, backups, LUTs.</li>
                </ul>
                
                <p><strong>DÃ©partement Son :</strong></p>
                <ul>
                    <li><strong>Chef OpÃ©rateur Son</strong> : Mixage plateau, choix des micros.</li>
                    <li><strong>Perchiste</strong> : Manipulation de la perche.</li>
                </ul>
                
                <p><strong>DÃ©partement Artistique :</strong></p>
                <ul>
                    <li><strong>Chef DÃ©corateur</strong> : Conception et rÃ©alisation des dÃ©cors.</li>
                    <li><strong>Accessoiriste</strong> : Objets manipulÃ©s par les acteurs.</li>
                    <li><strong>Chef Costumier</strong> : Conception et gestion des costumes.</li>
                    <li><strong>Habilleur</strong> : Aide les comÃ©diens, entretien costumes.</li>
                    <li><strong>Chef Maquilleur</strong> : Maquillage beautÃ© et effets.</li>
                    <li><strong>Chef Coiffeur</strong> : Coiffures et perruques.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>ðŸ’¡ HiÃ©rarchie :</strong> Sur un plateau, on sadresse toujours au chef de dÃ©partement, jamais directement Ã  son Ã©quipe (sauf urgence).
                </div>
                
                <h3>Le Financement en France</h3>
                <ul>
                    <li><strong>Apport producteur</strong> : Fonds propres de la sociÃ©tÃ© de production.</li>
                    <li><strong>Avance sur recettes (CNC)</strong> : Aide sÃ©lective sur scÃ©nario et rÃ©alisateur.</li>
                    <li><strong>Aides rÃ©gionales</strong> : Fonds des rÃ©gions (tournage local requis).</li>
                    <li><strong>SOFICA</strong> : SociÃ©tÃ©s dinvestissement dÃ©fiscalisÃ©es.</li>
                    <li><strong>CrÃ©dit dimpÃ´t cinÃ©ma</strong> : 30% des dÃ©penses franÃ§aises Ã©ligibles.</li>
                    <li><strong>PrÃ©ventes TV</strong> : ChaÃ®nes qui prÃ©achÃ¨tent les droits de diffusion.</li>
                    <li><strong>Minimum garanti distributeur</strong> : Avance du distributeur salle.</li>
                    <li><strong>Coproduction internationale</strong> : Partenaires Ã©trangers (accÃ¨s Ã  leurs aides).</li>
                    <li><strong>Crowdfunding</strong> : Financement participatif (courts-mÃ©trages, documentaires).</li>
                </ul>
                
                <h3>Les Conventions Collectives</h3>
                <ul>
                    <li><strong>Convention Production CinÃ©ma</strong> : Salaires minimums, heures supplÃ©mentaires.</li>
                    <li><strong>Convention Production Audiovisuelle</strong> : TV, publicitÃ©, clips.</li>
                    <li><strong>Heures de travail</strong> : Base 8h/jour, 39h/semaine. Au-delÃ  = heures sup majorÃ©es.</li>
                    <li><strong>Repos</strong> : 11h minimum entre deux journÃ©es de travail.</li>
                    <li><strong>Repas</strong> : Obligatoires, max 6h entre deux repas.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>âš ï¸ Assurances obligatoires :</strong> ResponsabilitÃ© civile, accidents du travail, matÃ©riel, nÃ©gatif/mÃ©dias, interruption de tournage.
                </div>
                
                <h3>Gestion du Budget</h3>
                <ul>
                    <li><span class="notion" data-notion="above-below-line">Above the line</span> : Droits, scÃ©nario, rÃ©alisateur, acteurs principaux (coÃ»ts crÃ©atifs).</li>
                    <li><span class="notion" data-notion="above-below-line">Below the line</span> : Ã‰quipe technique, matÃ©riel, dÃ©cors, post-prod (coÃ»ts de fabrication).</li>
                    <li><strong>Contingence</strong> : RÃ©serve de 5-10% pour imprÃ©vus.</li>
                    <li><strong>Frais gÃ©nÃ©raux</strong> : 5-7% pour la structure de production.</li>
                    <li><strong>Completion bond</strong> : Garantie de bonne fin (gros budgets).</li>
                </ul>
                
                <h3>Le Plan de Travail - Principes dOptimisation</h3>
                <ul>
                    <li><strong>Regrouper par dÃ©cor</strong> : Minimiser les dÃ©mÃ©nagements.</li>
                    <li><strong>DisponibilitÃ© acteurs</strong> : Concentrer les scÃ¨nes dun mÃªme comÃ©dien.</li>
                    <li><strong>Jour/Nuit</strong> : Regrouper les nuits (Ã©viter alternances Ã©puisantes).</li>
                    <li><strong>Ordre de difficultÃ©</strong> : ScÃ¨nes complexes en milieu de tournage (Ã©quipe rodÃ©e).</li>
                    <li><strong>MÃ©tÃ©o</strong> : PrÃ©voir des scÃ¨nes de repli en intÃ©rieur.</li>
                    <li><strong>Enfants</strong> : Restrictions horaires lÃ©gales strictes.</li>
                </ul>
                
                <h3>Distribution et Exploitation</h3>
                <ul>
                    <li><strong>Agent de ventes (Sales Agent)</strong> : Vend le film Ã  linternational.</li>
                    <li><strong>Distributeur</strong> : Commercialise le film sur un territoire.</li>
                    <li><strong>Exploitant</strong> : PropriÃ©taire des salles de cinÃ©ma.</li>
                    <li><strong>Chronologie des mÃ©dias</strong> : Salle â†’ VOD â†’ TV payante â†’ TV gratuite â†’ SVOD.</li>
                    <li><strong>P&A (Prints and Advertising)</strong> : Budget copies et publicitÃ©.</li>
                </ul>
                
                <h3>ðŸ“š Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"Producing for the Screen"</strong> - Kathi Lipman : Guide pratique de production.</li>
                    <li><strong>"The Independent Film Producers Survival Guide"</strong> - Gunnar Erickson : Juridique et financier.</li>
                    <li><strong>"Film Production Management"</strong> - Bastian Cleve : Organisation et logistique.</li>
                    <li><strong>"Le Guide du producteur"</strong> - CNC : RÃ©fÃ©rence franÃ§aise (tÃ©lÃ©chargeable).</li>
                    <li><strong>"Movie Money"</strong> - Bill Daniels : Comprendre lÃ©conomie du cinÃ©ma.</li>
                </ul>
                
                <h3>ðŸ”— Ressources Utiles</h3>
                <ul>
                    <li><strong>CNC (cnc.fr)</strong> : Aides, rÃ©glementations, statistiques France.</li>
                    <li><strong>Film France</strong> : Commission du film nationale, autorisations.</li>
                    <li><strong>Commissions du film rÃ©gionales</strong> : Aides locales, repÃ©rages.</li>
                    <li><strong>CST (Commission SupÃ©rieure Technique)</strong> : Normes techniques.</li>
                    <li><strong>SACD / SCAM</strong> : Droits dauteur scÃ©naristes/rÃ©alisateurs.</li>
                </ul>
            </div>
        `,
        
        glossaire: `
            <div class="courses-section">
                <h2>ðŸ“– Glossaire du CinÃ©ma</h2>
                
                <div class="courses-term"><dt>Axe</dt><dd>Direction dans laquelle la camÃ©ra regarde le sujet.</dd></div>
                <div class="courses-term"><dt>Champ</dt><dd>Ce qui est visible dans le cadre.</dd></div>
                <div class="courses-term"><dt>Hors-champ</dt><dd>Ce qui est en dehors du cadre mais fait partie de la scÃ¨ne.</dd></div>
                <div class="courses-term"><dt>DiÃ©gÃ¨se</dt><dd>L'univers fictif du film, tout ce qui "existe" dans l'histoire.</dd></div>
                <div class="courses-term"><dt>DiÃ©gÃ©tique</dt><dd>Son ou musique dont la source est dans l'univers du film (radio, personnage qui chante).</dd></div>
                <div class="courses-term"><dt>Extra-diÃ©gÃ©tique</dt><dd>Son ajoutÃ© (musique de film, voix-off narrative).</dd></div>
                <div class="courses-term"><dt>Clap</dt><dd>Ardoise identifiant chaque prise. Le claquement permet la synchronisation son/image.</dd></div>
                <div class="courses-term"><dt>Rushes</dt><dd>Images brutes tournÃ©es, non montÃ©es.</dd></div>
                <div class="courses-term"><dt>Bout-Ã -bout</dt><dd>Premier assemblage chronologique des rushes sÃ©lectionnÃ©s.</dd></div>
                <div class="courses-term"><dt>Ours</dt><dd>Premier montage complet mais non finalisÃ©.</dd></div>
                <div class="courses-term"><dt>Ã‰talonnage</dt><dd>Correction colorimÃ©trique pour harmoniser l'image et crÃ©er une ambiance.</dd></div>
                <div class="courses-term"><dt>Mixage</dt><dd>Ã‰quilibrage final de toutes les pistes audio.</dd></div>
                <div class="courses-term"><dt>DCP</dt><dd>Digital Cinema Package - Format de diffusion en salle.</dd></div>
                <div class="courses-term"><dt>Ratio</dt><dd>Rapport largeur/hauteur de l'image (1.85:1, 2.39:1 Scope, 16:9...).</dd></div>
                <div class="courses-term"><dt>Amorce</dt><dd>Partie d'un personnage ou objet au premier plan, partiellement visible.</dd></div>
                <div class="courses-term"><dt>Insert</dt><dd>Gros plan sur un dÃ©tail significatif (objet, main, texte).</dd></div>
                <div class="courses-term"><dt>Plan-sÃ©quence</dt><dd>ScÃ¨ne tournÃ©e en un seul plan sans coupe.</dd></div>
                <div class="courses-term"><dt>Raccord</dt><dd>CohÃ©rence visuelle et sonore entre deux plans consÃ©cutifs.</dd></div>
            </div>
        `
    })
};

// ==================== MODULE EDITOR (Formatage texte) ====================
const Editor = {
    currentTarget: null,
    
    format: (command, btn) => {
        document.execCommand(command, false, null);
        // Mettre Ã  jour l'Ã©tat des boutons aprÃ¨s le formatage
        Editor.updateToolbarState();
    },
    
    // Met Ã  jour l'Ã©tat visuel de tous les boutons de la toolbar
    updateToolbarState: () => {
        document.querySelectorAll('.editor-toolbar button[data-command]').forEach(btn => {
            const command = btn.dataset.command;
            if(command && document.queryCommandState(command)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    },
    
    // Initialise les listeners pour une zone d'Ã©dition
    initEditor: (editorSelector) => {
        const editor = document.querySelector(editorSelector);
        if(!editor) return;
        
        // Mettre Ã  jour les boutons quand la sÃ©lection change
        editor.addEventListener('keyup', Editor.updateToolbarState);
        editor.addEventListener('mouseup', Editor.updateToolbarState);
        editor.addEventListener('focus', Editor.updateToolbarState);
    },
    
    fontSize: (size) => {
        if(!size) return;
        const sel = window.getSelection();
        if(sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            const span = document.createElement('span');
            span.style.fontSize = size;
            range.surroundContents(span);
        }
    },
    
    getContent: (elementId) => {
        const el = document.getElementById(elementId);
        return el ? el.innerHTML : '';
    },
    
    setContent: (elementId, content) => {
        const el = document.getElementById(elementId);
        if(el) el.innerHTML = content;
    },
    
    clear: (elementId) => {
        const el = document.getElementById(elementId);
        if(el) el.innerHTML = '';
    }
};

// ==================== MODULE FORUM COMMUNAUTAIRE ====================
const Forum = {
    currentCategory: 'general',
    currentSort: 'recent',
    threads: [],
    
    categories: {
        general: { icon: 'ðŸ’¬', name: 'GÃ©nÃ©ral', desc: 'Discussions libres' },
        comediens: { icon: 'ðŸŽ­', name: 'ComÃ©diens', desc: 'Auditions, conseils, retours' },
        techniciens: { icon: 'ðŸŽ¥', name: 'Techniciens', desc: 'MatÃ©riel, techniques, formations' },
        scenario: { icon: 'ðŸ“', name: 'ScÃ©nario', desc: 'Ã‰criture, structure, dialogues' },
        realisation: { icon: 'ðŸŽ¬', name: 'RÃ©alisation', desc: 'Mise en scÃ¨ne, direction' },
        production: { icon: 'ðŸ’¼', name: 'Production', desc: 'Financement, logistique' },
        postprod: { icon: 'âœ‚ï¸', name: 'Post-production', desc: 'Montage, VFX, son' },
        retours_general: { icon: 'ðŸ›', name: 'ðŸ› GÃ©nÃ©ral', desc: 'Bugs gÃ©nÃ©raux', parent: 'retours' },
        retours_editeur: { icon: 'ðŸ“', name: 'ðŸ“ Ã‰diteur ScÃ©nario', desc: 'Ã‰diteur de scÃ©nario', parent: 'retours' },
        retours_sequencier: { icon: 'ðŸŽ¬', name: 'ðŸŽ¬ SÃ©quencier', desc: 'SÃ©quencier et planning', parent: 'retours' },
        retours_depouillement: { icon: 'ðŸ“‹', name: 'ðŸ“‹ DÃ©pouillement', desc: 'DÃ©pouillement', parent: 'retours' },
        retours_storyboard: { icon: 'ðŸŽ¨', name: 'ðŸŽ¨ Storyboard', desc: 'Storyboard', parent: 'retours' },
        retours_moodboard: { icon: 'ðŸ–¼ï¸', name: 'ðŸ–¼ï¸ Moodboard', desc: 'Moodboard', parent: 'retours' },
        retours_equipe: { icon: 'ðŸ‘¥', name: 'ðŸ‘¥ Ã‰quipe', desc: 'Gestion Ã©quipe', parent: 'retours' },
        retours_budget: { icon: 'ðŸ’°', name: 'ðŸ’° Budget', desc: 'Budget et dÃ©penses', parent: 'retours' },
        retours_contrats: { icon: 'ðŸ“„', name: 'ðŸ“„ Contrats', desc: 'Contrats', parent: 'retours' },
        retours_univers: { icon: 'ðŸŒ', name: 'ðŸŒ Univers', desc: 'Univers et profils', parent: 'retours' },
        retours_forum: { icon: 'ðŸ’¬', name: 'ðŸ’¬ Forum', desc: 'Forum communautaire', parent: 'retours' },
        retours_fil: { icon: 'ðŸ“°', name: 'ðŸ“° Le Fil', desc: 'Le Fil actualitÃ©', parent: 'retours' },
        retours_guide: { icon: 'â“', name: 'â“ Guide', desc: 'Guide et aide', parent: 'retours' },
        retours_cours: { icon: 'ðŸŽ“', name: 'ðŸŽ“ Cours', desc: 'Cours cinÃ©ma', parent: 'retours' },
        retours_profil: { icon: 'ðŸ‘¤', name: 'ðŸ‘¤ Mon Profil', desc: 'Profil utilisateur', parent: 'retours' },
        retours_messages: { icon: 'âœ‰ï¸', name: 'âœ‰ï¸ Messages', desc: 'Messagerie', parent: 'retours' },
        retours_design: { icon: 'ðŸŽ¨', name: 'ðŸŽ¨ Design/ThÃ¨mes', desc: 'Design et thÃ¨mes', parent: 'retours' }
    },
    
    open: () => {
        UI.hideAllViews();
        document.getElementById('forum-view').classList.add('active');
        Forum.loadThreads();
    },
    
    close: () => {
        UI.hideAllViews();
        document.getElementById('dashboard-view').style.display = 'flex';
    },
    
    switchCategory: (category) => {
        Forum.currentCategory = category;
        document.querySelectorAll('.forum-category').forEach(c => c.classList.remove('active'));
        document.querySelector(`.forum-category[data-category="${category}"]`).classList.add('active');
        const cat = Forum.categories[category];
        document.getElementById('forum-category-title').textContent = `${cat.icon} ${cat.name}`;
        Forum.renderThreads();
    },
    
    sort: (sortType) => {
        Forum.currentSort = sortType;
        document.querySelectorAll('.forum-sort-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        Forum.renderThreads();
    },
    
    loadThreads: async () => {
        try {
            const { data: threads, error } = await supabase
                .from('forum_threads')
                .select('*')
                .order('created_at', { ascending: false });
            
            if(error) throw error;
            
            Forum.threads = (threads || []).map(t => ({
                id: t.id,
                title: t.title,
                content: t.content,
                image: t.image,
                category: t.category,
                authorEmail: t.author_email,
                authorName: t.author_name,
                createdAt: t.created_at,
                votes: t.votes || 0,
                replyCount: t.reply_count || 0,
                resolved: t.resolved || false,
                pinned: t.pinned || false
            }));
            
            Forum.updateCounts();
            Forum.renderThreads();
        } catch(e) {
            console.error('Erreur chargement forum:', e);
        }
    },
    
    updateCounts: () => {
        Object.keys(Forum.categories).forEach(cat => {
            const count = Forum.threads.filter(t => t.category === cat).length;
            const el = document.getElementById(`forum-count-${cat}`);
            if(el) el.textContent = count;
        });
    },
    
    renderThreads: () => {
        let threads = Forum.threads.filter(t => t.category === Forum.currentCategory);
        
        if(Forum.currentSort === 'recent') {
            threads.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        } else if(Forum.currentSort === 'popular') {
            threads.sort((a, b) => (b.votes || 0) - (a.votes || 0));
        } else if(Forum.currentSort === 'unresolved') {
            threads = threads.filter(t => !t.resolved);
            threads.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }
        
        const container = document.getElementById('forum-threads-list');
        if(threads.length === 0) {
            container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-sec);">Aucun sujet dans cette catÃ©gorie. Soyez le premier Ã  crÃ©er un sujet !</div>';
            return;
        }
        
        container.innerHTML = threads.map(t => `
            <div class="forum-thread" onclick="app.Forum.openThread('${t.id}')">
                <div class="forum-thread-title">
                    ${t.pinned ? '<span class="badge pinned">ðŸ“Œ Ã‰pinglÃ©</span>' : ''}
                    ${t.resolved ? '<span class="badge resolved">âœ… RÃ©solu</span>' : ''}
                    ${t.title}
                </div>
                <div class="forum-thread-meta">
                    <div class="forum-thread-votes">
                        <span class="upvote" onclick="event.stopPropagation(); app.Forum.vote('${t.id}', 1)">â–²</span>
                        <span class="score">${t.votes || 0}</span>
                        <span class="downvote" onclick="event.stopPropagation(); app.Forum.vote('${t.id}', -1)">â–¼</span>
                    </div>
                    <span>ðŸ‘¤ ${t.authorName || 'Anonyme'}</span>
                    <span>ðŸ’¬ ${t.replyCount || 0} rÃ©ponses</span>
                    <span>ðŸ• ${Utils.timeAgo(t.createdAt)}</span>
                </div>
            </div>
        `).join('');
    },
    
    vote: async (threadId, value) => {
        if(!state.currentUser) return;
        
        try {
            // VÃ©rifier le vote actuel
            const { data: existingVote } = await supabase
                .from('forum_votes')
                .select('vote_type')
                .eq('thread_id', threadId)
                .eq('user_email', state.currentUser.email)
                .single();
            
            const currentVote = existingVote?.vote_type || 0;
            const newVote = currentVote === value ? 0 : value;
            const diff = newVote - currentVote;
            
            // Upsert le vote
            if(newVote === 0) {
                await supabase
                    .from('forum_votes')
                    .delete()
                    .eq('thread_id', threadId)
                    .eq('user_email', state.currentUser.email);
            } else {
                await supabase
                    .from('forum_votes')
                    .upsert({
                        thread_id: threadId,
                        user_email: state.currentUser.email,
                        vote_type: newVote
                    }, { onConflict: 'thread_id,user_email' });
            }
            
            // Mettre Ã  jour le compteur du thread
            const thread = Forum.threads.find(t => t.id === threadId);
            if(thread) {
                const newTotal = (thread.votes || 0) + diff;
                await supabase
                    .from('forum_threads')
                    .update({ votes: newTotal })
                    .eq('id', threadId);
                thread.votes = newTotal;
                Forum.renderThreads();
            }
        } catch(e) {
            console.error('Erreur vote:', e);
        }
    },
    
    selectedImage: null,
    
    openNewThread: () => {
        const cat = Forum.categories[Forum.currentCategory];
        Forum.selectedImage = null;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:700px; width:90%;">
                <div class="modal-header">
                    <h2>${cat.icon} Nouveau sujet - ${cat.name}</h2>
                    <button onclick="this.closest('.modal-overlay').remove()" class="modal-close">âœ–</button>
                </div>
                <div class="p-20">
                    <input type="text" id="new-thread-title" placeholder="Titre du sujet" class="n8-input-1">
                    <div class="editor-box">
                        <div class="editor-toolbar">
                            <button data-command="bold" onclick="app.Editor.format('bold')" title="Gras"><b>G</b></button>
                            <button data-command="italic" onclick="app.Editor.format('italic')" title="Italique"><i>I</i></button>
                            <button data-command="underline" onclick="app.Editor.format('underline')" title="SoulignÃ©"><u>S</u></button>
                            <div class="separator"></div>
                            <button data-command="insertUnorderedList" onclick="app.Editor.format('insertUnorderedList')" title="Liste Ã  puces">â€¢</button>
                        </div>
                        <div id="new-thread-content" class="editor-content" contenteditable="true" data-placeholder="Votre message..." style="min-height:150px;" onkeyup="app.Editor.updateToolbarState()" onmouseup="app.Editor.updateToolbarState()"></div>
                        <div id="forum-image-preview"></div>
                        <div class="editor-actions">
                            <div class="editor-actions-left">
                                <button class="editor-btn" onclick="document.getElementById('forum-image-input').click()">ðŸ–¼ï¸ Image</button>
                                <input type="file" id="forum-image-input" accept="image/*" class="d-none" onchange="app.Forum.handleImageSelect(event)">
                            </div>
                            <button class="editor-btn editor-btn-primary" onclick="app.Forum.createThread()">ðŸ“¤ Publier</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    },
    
    handleImageSelect: (event) => {
        const file = event.target.files[0];
        if(!file) return;
        
        if(file.size > 5 * 1024 * 1024) {
            Utils.toast('Image trop volumineuse (max 5 Mo)', 'warning');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            Forum.selectedImage = e.target.result;
            document.getElementById('forum-image-preview').innerHTML = `
                <div class="image-preview-container">
                    <img src="${e.target.result}" class="image-preview" alt="AperÃ§u">
                    <button class="remove-image" onclick="app.Forum.removeImage()">âœ•</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    },
    
    removeImage: () => {
        Forum.selectedImage = null;
        const preview = document.getElementById('forum-image-preview');
        if(preview) preview.innerHTML = '';
        const input = document.getElementById('forum-image-input');
        if(input) input.value = '';
    },
    
    createThread: () => {
        const title = document.getElementById('new-thread-title').value.trim();
        const contentEl = document.getElementById('new-thread-content');
        const content = contentEl.innerHTML.trim();
        
        if(!title || !content || content === '<br>') {
            Utils.toast('Veuillez remplir le titre et le contenu', 'warning');
            return;
        }
        
        const thread = {
            title: title,
            content: content,
            image: Forum.selectedImage || null,
            category: Forum.currentCategory,
            authorEmail: state.currentUser.email,
            authorName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            createdAt: new Date().toISOString(),
            votes: 0,
            replyCount: 0,
            resolved: false,
            pinned: false
        };
        
        supabase
            .from('forum_threads')
            .insert({
                title: thread.title,
                content: thread.content,
                image: thread.image,
                category: thread.category,
                author_email: thread.authorEmail,
                author_name: thread.authorName,
                votes: 0,
                resolved: false
            })
            .then(({ error }) => {
                if(error) {
                    console.error('Erreur crÃ©ation thread:', error);
                    Utils.toast('Erreur lors de la crÃ©ation', 'error');
                    return;
                }
                document.querySelector('.modal-overlay').remove();
                Forum.selectedImage = null;
                Forum.loadThreads();
                Utils.toast('Sujet crÃ©Ã© !', 'success');
            });
    },
    
    openThread: async (threadId) => {
        const thread = Forum.threads.find(t => t.id === threadId);
        if(!thread) return;
        
        try {
            const { data: repliesData, error } = await supabase
                .from('forum_replies')
                .select('*')
                .eq('thread_id', threadId)
                .order('created_at', { ascending: true });
            
            if(error) throw error;
            
            const replies = (repliesData || []).map(r => ({
                id: r.id,
                content: r.content,
                authorEmail: r.author_email,
                authorName: r.author_name,
                createdAt: r.created_at
            }));
            
            Forum.showThreadModal(thread, replies);
        } catch(e) {
            console.error('Erreur chargement rÃ©ponses:', e);
        }
    },
    
    showThreadModal: (thread, replies) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:800px; max-height:90vh; overflow-y:auto;">
                <div class="modal-header">
                    <h2>${thread.title}</h2>
                    <button onclick="this.closest('.modal-overlay').remove()" class="modal-close">âœ–</button>
                </div>
                <div class="p-20">
                    <div class="forum-post">
                        <div class="forum-post-header">
                            <div class="forum-post-avatar">${(thread.authorName || '?')[0].toUpperCase()}</div>
                            <div>
                                <div class="forum-post-author">${thread.authorName || 'Anonyme'}</div>
                                <div class="forum-post-date">${Utils.timeAgo(thread.createdAt)}</div>
                            </div>
                        </div>
                        <div class="forum-post-content">${thread.content}</div>
                        ${thread.image ? `<img src="${thread.image}" style="max-width:100%; border-radius:8px; margin-bottom:15px;" alt="Image">` : ''}
                        <div class="forum-post-actions">
                            <span class="forum-post-action" onclick="app.Forum.vote('${thread.id}', 1)">â–² ${thread.votes || 0}</span>
                            ${thread.authorEmail === state.currentUser?.email ? `<span class="forum-post-action" onclick="app.Forum.markResolved('${thread.id}')">âœ… Marquer rÃ©solu</span>` : ''}
                        </div>
                    </div>
                    <h3 style="margin:20px 0 15px;">ðŸ’¬ ${replies.length} rÃ©ponse${replies.length > 1 ? 's' : ''}</h3>
                    <div class="forum-replies">
                        ${replies.map(r => `
                            <div class="forum-post mb-10">
                                <div class="forum-post-header">
                                    <div class="forum-post-avatar" style="width:32px; height:32px; font-size:0.9rem;">${(r.authorName || '?')[0].toUpperCase()}</div>
                                    <div>
                                        <div class="forum-post-author fs-09">${r.authorName || 'Anonyme'}</div>
                                        <div class="forum-post-date" style="font-size:0.8rem;">${Utils.timeAgo(r.createdAt)}</div>
                                    </div>
                                </div>
                                <div class="forum-post-content" style="font-size:0.95rem;">${r.content.replace(/\n/g, '<br>')}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-20">
                        <textarea id="reply-content" placeholder="Votre rÃ©ponse..." style="width:100%; min-height:80px; padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text-main);"></textarea>
                        <button onclick="app.Forum.postReply('${thread.id}')" style="margin-top:10px; padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">RÃ©pondre</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    },
    
    postReply: async (threadId) => {
        const content = document.getElementById('reply-content').value.trim();
        if(!content) return;
        
        try {
            // InsÃ©rer la rÃ©ponse
            await supabase
                .from('forum_replies')
                .insert({
                    thread_id: threadId,
                    content: content,
                    author_email: state.currentUser.email,
                    author_name: state.userProfile?.displayName || state.currentUser.email.split('@')[0]
                });
            
            // Mettre Ã  jour le compteur de rÃ©ponses
            const thread = Forum.threads.find(t => t.id === threadId);
            if(thread) {
                const newCount = (thread.replyCount || 0) + 1;
                await supabase
                    .from('forum_threads')
                    .update({ reply_count: newCount })
                    .eq('id', threadId);
            }
            
            document.querySelector('.modal-overlay').remove();
            Forum.loadThreads();
            Forum.openThread(threadId);
            Utils.toast('RÃ©ponse publiÃ©e !', 'success');
        } catch(e) {
            console.error('Erreur rÃ©ponse:', e);
            Utils.toast('Erreur lors de la publication', 'error');
        }
    },
    
    markResolved: async (threadId) => {
        try {
            await supabase
                .from('forum_threads')
                .update({ resolved: true })
                .eq('id', threadId);
            
            const thread = Forum.threads.find(t => t.id === threadId);
            if(thread) thread.resolved = true;
            
            Forum.renderThreads();
            Utils.toast('Sujet marquÃ© comme rÃ©solu', 'success');
        } catch(e) {
            console.error('Erreur:', e);
        }
    }
};

// ==================== MODULE MUR SOCIAL (FEED) ====================
const Feed = {
    posts: [],
    
    open: () => {
        UI.hideAllViews();
        document.getElementById('feed-view').classList.add('active');
        Feed.updateComposerAvatar();
        Feed.loadPosts();
    },
    
    close: () => {
        UI.hideAllViews();
        document.getElementById('dashboard-view').style.display = 'flex';
    },
    
    updateComposerAvatar: () => {
        const avatar = document.getElementById('feed-user-avatar');
        if(!avatar) return;
        if(state.userProfile?.displayName) {
            avatar.textContent = state.userProfile.displayName[0].toUpperCase();
        } else if(state.currentUser?.email) {
            avatar.textContent = state.currentUser.email[0].toUpperCase();
        }
    },
    
    loadPosts: async () => {
        try {
            const { data: posts, error } = await supabase
                .from('feed_posts')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if(error) throw error;
            
            // RÃ©cupÃ©rer les likes de l'utilisateur actuel
            let userLikes = {};
            if(state.currentUser) {
                const { data: likesData } = await supabase
                    .from('feed_likes')
                    .select('post_id')
                    .eq('user_email', state.currentUser.email);
                
                if(likesData) {
                    likesData.forEach(l => userLikes[l.post_id] = true);
                }
            }
            
            Feed.posts = (posts || []).map(p => ({
                id: p.id,
                content: p.content,
                type: p.post_type,
                image: p.image,
                authorEmail: p.author_email,
                authorName: p.author_name,
                createdAt: p.created_at,
                likes: { [state.currentUser?.email]: userLikes[p.id] || false },
                comments: {},
                likeCount: p.like_count || p.likes || 0,
                commentCount: p.comment_count || 0
            }));
            
            Feed.renderPosts();
        } catch(e) {
            console.error('Erreur chargement feed:', e);
        }
    },
    
    renderPosts: () => {
        const container = document.getElementById('feed-posts');
        if(Feed.posts.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);">Aucune publication pour le moment. Soyez le premier Ã  publier !</div>';
            return;
        }
        
        container.innerHTML = Feed.posts.map(post => {
            const typeClass = post.type === 'annonce' ? 'annonce' : (post.type === 'recherche' ? 'recherche' : '');
            const typeLabel = post.type === 'annonce' ? 'ðŸ“¢ Annonce' : (post.type === 'recherche' ? 'ðŸ” Recherche' : 'ðŸ’­ Statut');
            const isLiked = state.currentUser && post.likes && post.likes[state.currentUser.email];
            const likeCount = post.likeCount || 0;
            const commentCount = post.commentCount || 0;
            
            return `
                <div class="feed-post">
                    <div class="feed-post-header">
                        <div class="feed-post-avatar">${(post.authorName || '?')[0].toUpperCase()}</div>
                        <div class="feed-post-info">
                            <div class="feed-post-author">${post.authorName || 'Anonyme'}</div>
                            <div class="feed-post-meta">
                                <span class="feed-post-type ${typeClass}">${typeLabel}</span>
                                <span>â€¢</span>
                                <span>${Utils.timeAgo(post.createdAt)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="feed-post-content">${post.content.replace(/\n/g, '<br>')}</div>
                    ${post.image ? `<img src="${post.image}" class="feed-post-image" alt="Image du post">` : ''}
                    <div class="feed-post-actions">
                        <div class="feed-post-action ${isLiked ? 'liked' : ''}" onclick="app.Feed.toggleLike('${post.id}')">
                            ${isLiked ? 'â¤ï¸' : 'ðŸ¤'} ${likeCount > 0 ? likeCount : ''} J'aime
                        </div>
                        <div class="feed-post-action" onclick="app.Feed.toggleComments('${post.id}')">
                            ðŸ’¬ ${commentCount > 0 ? commentCount : ''} Commenter
                        </div>
                        <div class="feed-post-action" onclick="app.Feed.share('${post.id}')">
                            ðŸ”— Partager
                        </div>
                    </div>
                    <div class="feed-post-comments d-none" id="comments-${post.id}">
                        <div id="comments-list-${post.id}"></div>
                        <div class="feed-comment-input">
                            <input type="text" id="comment-input-${post.id}" placeholder="Ã‰crire un commentaire..." onkeypress="if(event.key==='Enter') app.Feed.postComment('${post.id}')">
                            <button onclick="app.Feed.postComment('${post.id}')">Envoyer</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    publish: async () => {
        const contentEl = document.getElementById('feed-post-text');
        const content = contentEl.innerHTML.trim();
        const type = document.getElementById('feed-post-type').value;
        
        if(!content || content === '<br>') {
            Utils.toast('Ã‰crivez quelque chose avant de publier', 'warning');
            return;
        }
        
        // VÃ©rifier la limite d'une publication par semaine (dimanche Ã  dimanche)
        const now = new Date();
        const dayOfWeek = now.getDay(); // 0 = dimanche
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - dayOfWeek);
        startOfWeek.setHours(0, 0, 0, 0);
        
        const { data: recentPosts, error: checkError } = await supabase
            .from('feed_posts')
            .select('id, created_at')
            .eq('author_email', state.currentUser.email)
            .gte('created_at', startOfWeek.toISOString());
        
        if(!checkError && recentPosts && recentPosts.length > 0) {
            const nextSunday = new Date(startOfWeek);
            nextSunday.setDate(startOfWeek.getDate() + 7);
            const joursRestants = Math.ceil((nextSunday - now) / (1000 * 60 * 60 * 24));
            Utils.toast(`ðŸš« Vous avez dÃ©jÃ  publiÃ© cette semaine. Prochaine publication possible dans ${joursRestants} jour(s).`, 'warning', 5000);
            return;
        }
        
        try {
            const { error } = await supabase
                .from('feed_posts')
                .insert({
                    content: content,
                    post_type: type,
                    image: Feed.selectedImage || null,
                    author_email: state.currentUser.email,
                    author_name: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
                    likes: 0,
                    like_count: 0,
                    comment_count: 0
                });
            
            if(error) throw error;
            
            contentEl.innerHTML = '';
            Feed.removeImage();
            Feed.loadPosts();
            Utils.toast('Publication partagÃ©e !', 'success');
        } catch(e) {
            console.error('Erreur publication:', e);
            Utils.toast('Erreur lors de la publication', 'error');
        }
    },
    
    selectedImage: null,
    
    selectImage: () => {
        document.getElementById('feed-image-input').click();
    },
    
    handleImageSelect: (event) => {
        const file = event.target.files[0];
        if(!file) return;
        
        if(file.size > 5 * 1024 * 1024) {
            Utils.toast('Image trop volumineuse (max 5 Mo)', 'warning');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            Feed.selectedImage = e.target.result;
            document.getElementById('feed-image-preview').innerHTML = `
                <div class="image-preview-container">
                    <img src="${e.target.result}" class="image-preview" alt="AperÃ§u">
                    <button class="remove-image" onclick="app.Feed.removeImage()">âœ•</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    },
    
    removeImage: () => {
        Feed.selectedImage = null;
        document.getElementById('feed-image-preview').innerHTML = '';
        document.getElementById('feed-image-input').value = '';
    },
    
    toggleLike: async (postId) => {
        if(!state.currentUser) return;
        
        try {
            // VÃ©rifier si dÃ©jÃ  likÃ©
            const { data: existingLike } = await supabase
                .from('feed_likes')
                .select('id')
                .eq('post_id', postId)
                .eq('user_email', state.currentUser.email)
                .single();
            
            if(existingLike) {
                // Supprimer le like
                await supabase
                    .from('feed_likes')
                    .delete()
                    .eq('post_id', postId)
                    .eq('user_email', state.currentUser.email);
                
                // DÃ©crÃ©menter le compteur
                const post = Feed.posts.find(p => p.id === postId);
                if(post) {
                    const newCount = Math.max(0, (post.likeCount || 1) - 1);
                    await supabase
                        .from('feed_posts')
                        .update({ like_count: newCount })
                        .eq('id', postId);
                }
            } else {
                // Ajouter le like
                await supabase
                    .from('feed_likes')
                    .insert({
                        post_id: postId,
                        user_email: state.currentUser.email
                    });
                
                // IncrÃ©menter le compteur
                const post = Feed.posts.find(p => p.id === postId);
                if(post) {
                    const newCount = (post.likeCount || 0) + 1;
                    await supabase
                        .from('feed_posts')
                        .update({ like_count: newCount })
                        .eq('id', postId);
                }
            }
            
            Feed.loadPosts();
        } catch(e) {
            console.error('Erreur like:', e);
        }
    },
    
    toggleComments: (postId) => {
        const commentsSection = document.getElementById(`comments-${postId}`);
        const isVisible = commentsSection.style.display !== 'none';
        
        if(isVisible) {
            commentsSection.style.display = 'none';
        } else {
            commentsSection.style.display = 'block';
            Feed.loadComments(postId);
        }
    },
    
    loadComments: async (postId) => {
        try {
            const { data: comments, error } = await supabase
                .from('feed_comments')
                .select('*')
                .eq('post_id', postId)
                .order('created_at', { ascending: true });
            
            if(error) throw error;
            
            const container = document.getElementById(`comments-list-${postId}`);
            container.innerHTML = (comments || []).map(c => `
                <div class="feed-comment">
                    <div class="feed-comment-avatar">${(c.author_name || '?')[0].toUpperCase()}</div>
                    <div class="feed-comment-content">
                        <div class="feed-comment-author">${c.author_name || 'Anonyme'}</div>
                        <div class="feed-comment-text">${c.content}</div>
                    </div>
                </div>
            `).join('');
        } catch(e) {
            console.error('Erreur chargement commentaires:', e);
        }
    },
    
    postComment: async (postId) => {
        const input = document.getElementById(`comment-input-${postId}`);
        const content = input.value.trim();
        
        if(!content) return;
        
        try {
            // InsÃ©rer le commentaire
            await supabase
                .from('feed_comments')
                .insert({
                    post_id: postId,
                    content: content,
                    author_email: state.currentUser.email,
                    author_name: state.userProfile?.displayName || state.currentUser.email.split('@')[0]
                });
            
            // Mettre Ã  jour le compteur
            const post = Feed.posts.find(p => p.id === postId);
            if(post) {
                const newCount = (post.commentCount || 0) + 1;
                await supabase
                    .from('feed_posts')
                    .update({ comment_count: newCount })
                    .eq('id', postId);
            }
            
            input.value = '';
            Feed.loadComments(postId);
            Feed.loadPosts();
        } catch(e) {
            console.error('Erreur commentaire:', e);
        }
    },
    
    share: (postId) => {
        const url = window.location.origin + '?post=' + postId;
        navigator.clipboard.writeText(url).then(() => {
            Utils.toast('Lien copiÃ© dans le presse-papier !', 'success');
        }).catch(() => {
            Utils.toast('Impossible de copier le lien', 'error');
        });
    }
};

// --- MODULE CARD MODAL (Vue compacte + Ã©dition) ---
const CardModal = {
    currentType: null,
    currentIdx: null,
    viewMode: {}, // Stocke le mode de vue par type: 'compact' ou 'detailed'
    
    init: () => {
        // Charger les prÃ©fÃ©rences de vue
        try {
            CardModal.viewMode = JSON.parse(localStorage.getItem('fmp_card_view_mode') || '{}');
        } catch(e) {
            CardModal.viewMode = {};
        }
    },
    
    getViewMode: (type) => {
        return CardModal.viewMode[type] || 'compact';
    },
    
    setViewMode: (type, mode) => {
        CardModal.viewMode[type] = mode;
        PreferencesSync.save('fmp_card_view_mode', JSON.stringify(CardModal.viewMode));
        // Re-render
        if(type === 'characters') UI.renderDataTab('characters', els.charContainer);
        else if(type === 'actors') UI.renderDataTab('actors', els.actorContainer);
        else if(type === 'locations') UI.renderDataTab('locations', els.locContainer);
        else if(type === 'crew') UI.renderCrewTab();
    },
    
    open: (type, idx) => {
        CardModal.currentType = type;
        CardModal.currentIdx = idx;
        const item = state.data[type][idx];
        if(!item) return;
        
        const modal = document.getElementById('card-edit-modal');
        const title = document.getElementById('card-edit-modal-title');
        const body = document.getElementById('card-edit-modal-body');
        
        const typeLabels = { characters: 'ðŸŽ­ Personnage', actors: 'ðŸŽ¬ ComÃ©dienÂ·ne', locations: 'ðŸ  DÃ©cor' };
        title.textContent = typeLabels[type] + ' : ' + (item.name || 'Sans nom');
        
        // RÃ©utiliser le mÃªme code que les fiches dÃ©taillÃ©es
        const tempContainer = document.createElement('div');
        tempContainer.className = 'data-grid';
        
        let groupType = '';
        if(type === 'characters') groupType = 'perso';
        else if(type === 'actors') groupType = 'actor';
        else if(type === 'locations') groupType = 'lieu';
        const relevantGroups = state.data.groups.filter(g => g.type === groupType);
        
        // Utiliser exactement le mÃªme rendu que le mode dÃ©taillÃ©
        UI.renderDataCards([item], type, tempContainer, relevantGroups);
        
        // Extraire et adapter la carte pour le modal
        const cardContent = tempContainer.querySelector('.data-card');
        body.innerHTML = '';
        if(cardContent) {
            cardContent.style.border = 'none';
            cardContent.style.boxShadow = 'none';
            cardContent.style.maxWidth = 'none';
            cardContent.style.margin = '0';
            body.appendChild(cardContent);
        }
        
        modal.classList.add('visible');
        
        // Initialiser les calendriers si nÃ©cessaire
        if(type === 'actors') {
            setTimeout(() => {
                const calContainer = document.getElementById('actor-calendar-' + idx);
                if(calContainer && state.currentRole !== 'viewer') {
                    UI.renderAvailabilityCalendar('actor-calendar-' + idx, 'actor', idx);
                }
            }, 100);
        }
    },
    
    close: () => {
        const modal = document.getElementById('card-edit-modal');
        modal.classList.remove('visible');
        CardModal.currentType = null;
        CardModal.currentIdx = null;
        // RafraÃ®chir les vues compactes aprÃ¨s fermeture
        const activeTab = document.querySelector('.tab-content.active');
        if(activeTab) {
            const tabId = activeTab.id;
            if(tabId === 'tab-chars') UI.renderDataTab('characters', els.charContainer);
            else if(tabId === 'tab-actors') UI.renderDataTab('actors', els.actorContainer);
            else if(tabId === 'tab-locs') UI.renderDataTab('locations', els.locContainer);
            else if(tabId === 'tab-crew') UI.renderCrewTab();
        }
    },
    
    // Rendu des cartes compactes pour l'Ã©quipe
    renderCompactCrewCards: (members, container, isView) => {
        members.forEach((member) => {
            const idx = state.data.crew.indexOf(member);
            const card = document.createElement('div');
            card.className = 'compact-card';
            card.onclick = () => CardModal.openCrew(idx);
            
            const photoContent = member.photo ? `<img src="${member.photo}">` : 'ðŸ‘¤';
            const roleInfo = member.role || '<em style="opacity:0.6">Fonction non dÃ©finie</em>';
            const badge = member.publicProfileId ? 'ðŸ”’' : '';
            
            card.innerHTML = `
                ${!isView ? `
                <div class="compact-card-actions">
                    <button class="edit-btn" onclick="event.stopPropagation(); app.CardModal.openCrew(${idx})" title="Modifier">âœï¸</button>
                    <button class="delete-btn" onclick="event.stopPropagation(); app.Crew.deleteMember(${idx})" title="Supprimer">ðŸ—‘ï¸</button>
                </div>
                ` : ''}
                ${badge ? `<div class="compact-card-badge">${badge}</div>` : ''}
                <div class="compact-card-photo">${photoContent}</div>
                <div class="compact-card-name">${Utils.escape(member.name || 'Sans nom')}</div>
                <div class="compact-card-role">${roleInfo}</div>
            `;
            
            container.appendChild(card);
        });
    },
    
    // Ouvrir le modal pour un membre de l'Ã©quipe
    openCrew: (idx) => {
        CardModal.currentType = 'crew';
        CardModal.currentIdx = idx;
        const member = state.data.crew[idx];
        if(!member) return;
        
        const modal = document.getElementById('card-edit-modal');
        const title = document.getElementById('card-edit-modal-title');
        const body = document.getElementById('card-edit-modal-body');
        
        title.textContent = 'ðŸŽ¥ Technicien : ' + (member.name || 'Sans nom');
        
        // RÃ©utiliser le mÃªme code que les fiches dÃ©taillÃ©es
        const isView = state.currentRole === 'viewer' || !Permissions.canEdit('equipe');
        const crewGroups = state.data.groups.filter(g => g.type === 'crew');
        const cardElement = UI.createCrewCard(member, idx, crewGroups, isView);
        
        // Adapter le style pour le modal
        cardElement.style.border = 'none';
        cardElement.style.boxShadow = 'none';
        cardElement.style.maxWidth = 'none';
        cardElement.style.margin = '0';
        
        body.innerHTML = '';
        body.appendChild(cardElement);
        
        modal.classList.add('visible');
        
        // Initialiser le calendrier
        setTimeout(() => {
            const calContainer = document.getElementById('crew-calendar-' + idx);
            if(calContainer && state.currentRole !== 'viewer') {
                UI.renderAvailabilityCalendar('crew-calendar-' + idx, 'crew', idx);
            }
        }, 100);
    },
    
    // Formulaire Personnage
    renderCharacterForm: (item, idx) => {
        const isView = state.currentRole === 'viewer' || !Permissions.canEdit('personnages');
        const linkedActor = state.data.actors.find(a => a.id === item.actor_id);
        
        let actorOptions = '<option value="">-- Aucun comÃ©dien --</option>';
        state.data.actors.forEach(a => {
            actorOptions += `<option value="${a.id}" ${item.actor_id === a.id ? 'selected' : ''}>${Utils.escape(a.name)}</option>`;
        });
        
        return `
            <div class="grid-gap20">
                <div class="flex-gap20-start">
                    <div class="text-center">
                        <div class="n8-avatar-1">
                            ${item.photo ? `<img src="${item.photo}" class="img-cover">` : 'ðŸŽ­'}
                        </div>
                        <input type="text" class="actor-input" placeholder="URL photo" value="${item.photo || ''}" onchange="app.CardModal.updateField('photo', this.value)" style="width: 100px; font-size: 0.75rem;" ${isView ? 'disabled' : ''}>
                    </div>
                    <div class="flex-1">
                        <label class="label-sec">Nom du personnage</label>
                        <input type="text" class="actor-input" value="${Utils.escape(item.name || '')}" onchange="app.CardModal.updateField('name', this.value)" style="font-size: 1.1rem; font-weight: 600;" ${isView ? 'disabled' : ''}>
                        
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec); margin-top: 15px; display: block;">InterprÃ©tÃ© par</label>
                        <select class="actor-input" onchange="app.CardModal.updateField('actor_id', this.value)" ${isView ? 'disabled' : ''}>
                            ${actorOptions}
                        </select>
                        ${linkedActor ? `<div style="color: var(--success); font-size: 0.85rem; margin-top: 5px;">âœ“ ${Utils.escape(linkedActor.name)}</div>` : ''}
                    </div>
                </div>
                
                <div>
                    <label class="label-sec">Description / Biographie</label>
                    <textarea class="data-desc" style="min-height: 120px;" placeholder="Description du personnage, son histoire, sa personnalitÃ©..." onchange="app.CardModal.updateField('desc', this.value)" ${isView ? 'disabled' : ''}>${item.desc || ''}</textarea>
                </div>
            </div>
        `;
    },
    
    // Formulaire ComÃ©dien
    renderActorForm: (item, idx) => {
        const isLocked = !!item.publicProfileId;
        const isView = state.currentRole === 'viewer' || isLocked;
        const linkedCharacter = state.data.characters.find(c => c.actor_id === item.id);
        
        return `
            <div class="grid-gap20">
                <div class="flex-gap20-start">
                    <div class="text-center">
                        <div class="n8-avatar-1">
                            ${item.photo ? `<img src="${item.photo}" class="img-cover">` : 'ðŸŽ¬'}
                        </div>
                        ${!isView ? `<input type="text" class="actor-input" placeholder="URL photo" value="${item.photo || ''}" onchange="app.CardModal.updateField('photo', this.value)" style="width: 100px; font-size: 0.75rem;">` : ''}
                        ${isLocked ? '<div style="font-size:0.7rem; color:var(--primary); margin-top:5px;">ðŸ”’ Profil revendiquÃ©</div>' : ''}
                    </div>
                    <div class="flex-1">
                        <label class="label-sec">Nom</label>
                        <input type="text" class="actor-input" value="${Utils.escape(item.name || '')}" onchange="app.CardModal.updateField('name', this.value)" style="font-size: 1.1rem; font-weight: 600;" ${isView ? 'disabled' : ''}>
                        
                        ${linkedCharacter ? `<div style="color: var(--primary); font-size: 0.9rem; margin-top: 10px;">ðŸŽ­ Joue : <strong>${Utils.escape(linkedCharacter.name)}</strong></div>` : '<div style="color: var(--text-sec); font-size: 0.85rem; margin-top: 10px; font-style: italic;">Aucun personnage liÃ©</div>'}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <div>
                                <label class="text-sec-sm">Email</label>
                                <input type="email" class="actor-input" value="${item.email || ''}" onchange="app.CardModal.updateField('email', this.value)" ${isView ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label class="text-sec-sm">TÃ©lÃ©phone</label>
                                <input type="tel" class="actor-input" value="${item.phone || ''}" onchange="app.CardModal.updateField('phone', this.value)" ${isView ? 'disabled' : ''}>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid-2col">
                    <div>
                        <label class="label-sec">Ville / RÃ©gion</label>
                        <input type="text" class="actor-input" value="${item.city || ''}" onchange="app.CardModal.updateField('city', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label class="label-sec">Site Web</label>
                        <input type="url" class="actor-input" value="${item.website || ''}" onchange="app.CardModal.updateField('website', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div>
                    <label class="label-sec">Bio</label>
                    <textarea class="data-desc" style="min-height: 80px;" placeholder="Biographie..." onchange="app.CardModal.updateField('bio', this.value)" ${isView ? 'disabled' : ''}>${item.bio || ''}</textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div>
                        <label class="text-sec-sm">Taille (cm)</label>
                        <input type="number" class="actor-input" value="${item.height || ''}" onchange="app.CardModal.updateField('height', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label class="text-sec-sm">Ã‚ge</label>
                        <input type="number" class="actor-input" value="${item.age || ''}" onchange="app.CardModal.updateField('age', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label class="text-sec-sm">Tarif jour</label>
                        <input type="number" class="actor-input" value="${item.dailyRate || ''}" onchange="app.CardModal.updateField('dailyRate', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div style="padding: 15px; background: var(--bg); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">ðŸ¤ Type de collaboration</div>
                    <div class="flex-gap10">
                        <label style="flex:1; padding: 10px; border: 2px solid ${item.collabType === 'pro' ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; text-align: center; background: ${item.collabType === 'pro' ? 'rgba(43,110,246,0.1)' : 'transparent'};">
                            <input type="radio" name="modal-collab" value="pro" ${item.collabType === 'pro' ? 'checked' : ''} onchange="app.CardModal.updateField('collabType', 'pro')" class="d-none" ${isView ? 'disabled' : ''}>
                            ðŸŽ¬ Pro
                        </label>
                        <label style="flex:1; padding: 10px; border: 2px solid ${item.collabType === 'semi-pro' ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; text-align: center; background: ${item.collabType === 'semi-pro' ? 'rgba(43,110,246,0.1)' : 'transparent'};">
                            <input type="radio" name="modal-collab" value="semi-pro" ${item.collabType === 'semi-pro' ? 'checked' : ''} onchange="app.CardModal.updateField('collabType', 'semi-pro')" class="d-none" ${isView ? 'disabled' : ''}>
                            âš¡ Semi-pro
                        </label>
                        <label style="flex:1; padding: 10px; border: 2px solid ${item.collabType === 'benevole' ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; text-align: center; background: ${item.collabType === 'benevole' ? 'rgba(43,110,246,0.1)' : 'transparent'};">
                            <input type="radio" name="modal-collab" value="benevole" ${item.collabType === 'benevole' ? 'checked' : ''} onchange="app.CardModal.updateField('collabType', 'benevole')" class="d-none" ${isView ? 'disabled' : ''}>
                            â¤ï¸ BÃ©nÃ©vole
                        </label>
                    </div>
                </div>
            </div>
        `;
    },
    
    // Formulaire DÃ©cor
    renderLocationForm: (item, idx) => {
        const isView = state.currentRole === 'viewer' || !Permissions.canEdit('lieux');
        const scenesInLocation = state.data.scenes.filter(s => s.title && s.title.toLowerCase().includes(item.name.toLowerCase()));
        
        return `
            <div class="grid-gap20">
                <div class="flex-gap20-start">
                    <div class="text-center">
                        <div style="width: 100px; height: 100px; border-radius: 12px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; overflow: hidden; border: 3px solid var(--border);">
                            ${item.photo ? `<img src="${item.photo}" class="img-cover">` : 'ðŸ '}
                        </div>
                        <input type="text" class="actor-input" placeholder="URL photo" value="${item.photo || ''}" onchange="app.CardModal.updateField('photo', this.value)" style="width: 100px; font-size: 0.75rem; margin-top: 10px;" ${isView ? 'disabled' : ''}>
                    </div>
                    <div class="flex-1">
                        <label class="label-sec">Nom du dÃ©cor (scÃ©nario)</label>
                        <input type="text" class="actor-input" value="${Utils.escape(item.name || '')}" onchange="app.CardModal.updateField('name', this.value)" style="font-size: 1.1rem; font-weight: 600;" ${isView ? 'disabled' : ''}>
                        
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec); margin-top: 15px; display: block;">Lieu rÃ©el de tournage</label>
                        <input type="text" class="actor-input" value="${Utils.escape(item.realLocationName || '')}" placeholder="Ex: ChÃ¢teau de Versailles" onchange="app.CardModal.updateField('realLocationName', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div>
                    <label class="label-sec">Adresse</label>
                    <input type="text" class="actor-input" value="${Utils.escape(item.address || '')}" placeholder="Adresse complÃ¨te..." onchange="app.CardModal.updateField('address', this.value)" ${isView ? 'disabled' : ''}>
                </div>
                
                <div class="grid-2col">
                    <div>
                        <label class="label-sec">Contact sur place</label>
                        <input type="text" class="actor-input" value="${item.contactName || ''}" placeholder="Nom du contact" onchange="app.CardModal.updateField('contactName', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label class="label-sec">TÃ©lÃ©phone</label>
                        <input type="tel" class="actor-input" value="${item.contactPhone || ''}" onchange="app.CardModal.updateField('contactPhone', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div>
                    <label class="label-sec">Description / Notes d'accÃ¨s</label>
                    <textarea class="data-desc" style="min-height: 80px;" placeholder="Description du lieu, notes d'accÃ¨s, parking..." onchange="app.CardModal.updateField('desc', this.value)" ${isView ? 'disabled' : ''}>${item.desc || ''}</textarea>
                </div>
                
                ${scenesInLocation.length > 0 ? `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">ðŸŽ¬ ScÃ¨nes dans ce dÃ©cor (${scenesInLocation.length})</div>
                    <div class="flex-wrap-gap8">
                        ${scenesInLocation.slice(0, 10).map(s => `<span style="padding: 4px 10px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 15px; font-size: 0.8rem;">${Utils.escape(s.title)}</span>`).join('')}
                        ${scenesInLocation.length > 10 ? `<span style="padding: 4px 10px; color: var(--text-sec); font-size: 0.8rem;">+${scenesInLocation.length - 10} autres</span>` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    },
    
    updateField: (field, value) => {
        if(CardModal.currentType && CardModal.currentIdx !== null) {
            const item = state.data[CardModal.currentType][CardModal.currentIdx];
            if(item) {
                item[field] = value;
                Store.save();
                // Mettre Ã  jour le titre du modal si c'est le nom
                if(field === 'name') {
                    const typeLabels = { characters: 'ðŸŽ­ Personnage', actors: 'ðŸŽ¬ ComÃ©dienÂ·ne', locations: 'ðŸ  DÃ©cor' };
                    document.getElementById('card-edit-modal-title').textContent = typeLabels[CardModal.currentType] + ' : ' + (value || 'Sans nom');
                }
            }
        }
    },
    
    // Rendu des cartes compactes
    renderCompactCards: (items, type, container) => {
        const isView = state.currentRole === 'viewer';
        
        items.forEach((item) => {
            const idx = state.data[type].indexOf(item);
            const card = document.createElement('div');
            card.className = 'compact-card';
            card.onclick = () => CardModal.open(type, idx);
            
            let photoContent = '';
            let roleInfo = '';
            let badge = '';
            
            if(type === 'characters') {
                photoContent = item.photo ? `<img src="${item.photo}">` : 'ðŸŽ­';
                const linkedActor = state.data.actors.find(a => a.id === item.actor_id);
                roleInfo = linkedActor ? Utils.escape(linkedActor.name) : '<em style="opacity:0.5">Non castÃ©</em>';
            } else if(type === 'actors') {
                photoContent = item.photo ? `<img src="${item.photo}">` : 'ðŸŽ¬';
                const linkedChar = state.data.characters.find(c => c.actor_id === item.id);
                roleInfo = linkedChar ? 'ðŸŽ­ ' + Utils.escape(linkedChar.name) : '<em style="opacity:0.5">Pas de rÃ´le</em>';
                if(item.publicProfileId) badge = 'ðŸ”’';
            } else if(type === 'locations') {
                photoContent = item.photo ? `<img src="${item.photo}">` : 'ðŸ ';
                roleInfo = item.realLocationName ? Utils.escape(item.realLocationName) : '<em style="opacity:0.5">Lieu non dÃ©fini</em>';
            }
            
            card.innerHTML = `
                ${!isView ? `
                <div class="compact-card-actions">
                    <button class="edit-btn" onclick="event.stopPropagation(); app.CardModal.open('${type}', ${idx})" title="Modifier">âœï¸</button>
                    <button class="delete-btn" onclick="event.stopPropagation(); app.Actions.deleteDataItem('${type}', ${idx})" title="Supprimer">ðŸ—‘ï¸</button>
                </div>
                ` : ''}
                ${badge ? `<div class="compact-card-badge">${badge}</div>` : ''}
                <div class="compact-card-photo">${photoContent}</div>
                <div class="compact-card-name">${Utils.escape(item.name || 'Sans nom')}</div>
                <div class="compact-card-role">${roleInfo}</div>
            `;
            
            container.appendChild(card);
        });
    }
};

const TitlePage = {
    load: () => {
        const tp = state.data.titlePage || {};
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('tp-title', tp.title);
        setVal('tp-author', tp.author);
        setVal('tp-coauthor', tp.coauthor);
        setVal('tp-contact', tp.contact);
        setVal('tp-draft', tp.draft);
        setVal('tp-date', tp.date);
        setVal('tp-source', tp.source);
        setVal('tp-copyright', tp.copyright);
        setVal('tp-notes', tp.notes);
    },
    save: () => {
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
        const newTitle = getVal('tp-title');
        state.data.titlePage = {
            title: newTitle,
            author: getVal('tp-author'),
            coauthor: getVal('tp-coauthor'),
            contact: getVal('tp-contact'),
            draft: getVal('tp-draft'),
            date: getVal('tp-date'),
            source: getVal('tp-source'),
            copyright: getVal('tp-copyright'),
            notes: getVal('tp-notes')
        };
        // Synchroniser avec le titre du projet
        if(newTitle && newTitle !== state.data.title) {
            state.data.title = newTitle;
            const projectTitleEl = document.getElementById('projectTitle');
            if(projectTitleEl) projectTitleEl.value = newTitle;
            Store.updateTitle(newTitle);
        }
        Store.save();
    }
};

const SceneVersions = {
    maxVersions: 10,
    
    // Sauvegarder une version de la scÃ¨ne
    save: (sceneId) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene) return;
        
        if(!scene.versions) scene.versions = [];
        
        // CrÃ©er la version
        const version = {
            id: 'v_' + Date.now(),
            date: new Date().toISOString(),
            dateDisplay: new Date().toLocaleString('fr-FR'),
            title: scene.title,
            scriptContent: scene.scriptContent,
            resume: scene.resume,
            perso: scene.perso,
            time: scene.time,
            savedBy: state.currentUser?.email?.split('@')[0] || 'Inconnu'
        };
        
        // Ajouter au dÃ©but
        scene.versions.unshift(version);
        
        // Limiter Ã  maxVersions
        if(scene.versions.length > SceneVersions.maxVersions) {
            scene.versions = scene.versions.slice(0, SceneVersions.maxVersions);
        }
        
        Store.save();
        UI.renderScript();
        Utils.toast(`Version sauvegardÃ©e (${scene.versions.length}/${SceneVersions.maxVersions})`, 'success');
    },
    
    // Ouvrir la modale des versions
    openModal: (sceneId) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene) return;
        
        const versions = scene.versions || [];
        
        let versionsHtml = '';
        
        if(versions.length === 0) {
            versionsHtml = `
                <div style="text-align: center; padding: 40px; color: var(--text-sec);">
                    <div style="font-size: 3rem; margin-bottom: 15px;">ðŸ“œ</div>
                    <p>Aucune version sauvegardÃ©e</p>
                    <p class="fs-085">Cliquez sur ðŸ“¸ pour sauvegarder une version</p>
                </div>
            `;
        } else {
            versions.forEach((v, idx) => {
                const preview = SceneVersions.getTextPreview(v.scriptContent);
                versionsHtml += `
                    <div class="scene-version-item">
                        <div class="scene-version-info">
                            <div class="scene-version-date">
                                ${v.dateDisplay || new Date(v.date).toLocaleString('fr-FR')}
                                <span style="font-weight: normal; color: var(--text-sec); font-size: 0.85rem;">par ${v.savedBy || 'Inconnu'}</span>
                            </div>
                            <div class="scene-version-preview">${Utils.escape(preview)}</div>
                        </div>
                        <div class="scene-version-actions">
                            <button class="scene-version-btn preview" onclick="app.SceneVersions.preview('${sceneId}', ${idx})">ðŸ‘ï¸</button>
                            <button class="scene-version-btn restore" onclick="app.SceneVersions.restore('${sceneId}', ${idx})">â†©ï¸ Restaurer</button>
                            <button class="scene-version-btn delete" onclick="app.SceneVersions.delete('${sceneId}', ${idx})">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            });
        }
        
        const sceneIdx = state.data.scenes.findIndex(s => s.id === sceneId);
        
        const modal = document.createElement('div');
        modal.className = 'scene-versions-modal';
        modal.id = 'scene-versions-modal';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="scene-versions-box">
                <div class="scene-versions-header">
                    <h3>ðŸ“œ Versions - ScÃ¨ne #${sceneIdx + 1}</h3>
                    <div class="flex-row-gap10">
                        <span class="text-sec-sm2">${versions.length}/${SceneVersions.maxVersions}</span>
                        <button onclick="app.SceneVersions.save('${sceneId}'); document.getElementById('scene-versions-modal').remove(); app.SceneVersions.openModal('${sceneId}');" class="n8-badge-10">ðŸ“¸ Nouvelle version</button>
                        <button onclick="this.closest('.scene-versions-modal').remove()" class="icon-btn-sec">âœ•</button>
                    </div>
                </div>
                <div class="scene-versions-content">
                    ${versionsHtml}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Extraire un aperÃ§u texte du contenu HTML
    getTextPreview: (html) => {
        if(!html) return '(vide)';
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const text = temp.innerText.trim();
        return text.length > 100 ? text.substring(0, 100) + '...' : text;
    },
    
    // PrÃ©visualiser une version
    preview: (sceneId, versionIdx) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene || !scene.versions || !scene.versions[versionIdx]) return;
        
        const v = scene.versions[versionIdx];
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:10002;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div class="n8-flex-5">
                    <h3 class="m-0">ðŸ‘ï¸ AperÃ§u - ${v.dateDisplay}</h3>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">âœ•</button>
                </div>
                <div style="padding: 20px; overflow-y: auto; flex: 1;">
                    <div class="mb-15-bg">
                        <strong>${Utils.escape(v.title)}</strong><br>
                        <span class="text-sec-sm2">${Utils.escape(v.perso)} â€¢ ${v.time} min</span>
                    </div>
                    <div class="mb-15">
                        <strong>RÃ©sumÃ© :</strong><br>
                        <p class="text-sec">${Utils.escape(v.resume) || '(vide)'}</p>
                    </div>
                    <div style="background: white; color: #333; padding: 20px; border-radius: 8px; font-family: 'Courier Prime', monospace;">
                        ${v.scriptContent || '<em style="color:#999">(vide)</em>'}
                    </div>
                </div>
                <div style="padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" class="btn-outline-r6">Fermer</button>
                    <button onclick="this.closest('div[style*=fixed]').remove(); app.SceneVersions.restore('${sceneId}', ${versionIdx})" class="btn-primary">â†©ï¸ Restaurer cette version</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Restaurer une version
    restore: async (sceneId, versionIdx) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene || !scene.versions || !scene.versions[versionIdx]) return;
        
        if(!await ConfirmModal.show({ title: 'Restaurer cette version ?', message: 'Le contenu actuel de la scÃ¨ne sera remplacÃ©.', icon: 'ðŸ“œ', confirmText: 'Restaurer' })) return;
        
        const v = scene.versions[versionIdx];
        
        // Sauvegarder l'Ã©tat actuel avant restauration
        const currentVersion = {
            id: 'v_' + Date.now(),
            date: new Date().toISOString(),
            dateDisplay: new Date().toLocaleString('fr-FR'),
            title: scene.title,
            scriptContent: scene.scriptContent,
            resume: scene.resume,
            perso: scene.perso,
            time: scene.time,
            savedBy: state.currentUser?.email?.split('@')[0] || 'Inconnu',
            autoSave: true
        };
        scene.versions.unshift(currentVersion);
        
        // Restaurer
        scene.title = v.title;
        scene.scriptContent = v.scriptContent;
        scene.resume = v.resume;
        scene.perso = v.perso;
        scene.time = v.time;
        
        // Limiter les versions
        if(scene.versions.length > SceneVersions.maxVersions) {
            scene.versions = scene.versions.slice(0, SceneVersions.maxVersions);
        }
        
        Store.save();
        UI.renderScript();
        UI.renderBoard();
        
        // Fermer la modale
        const modal = document.getElementById('scene-versions-modal');
        if(modal) modal.remove();
        
        Utils.toast('Version restaurÃ©e !', 'success');
        Utils.notifyImpact('script', ['board', 'breakdown'], 'restaurÃ©');
    },
    
    // Supprimer une version
    delete: async (sceneId, versionIdx) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene || !scene.versions || !scene.versions[versionIdx]) return;
        
        if(!await ConfirmModal.confirmDelete("Cette version sera supprimÃ©e.")) return;
        
        scene.versions.splice(versionIdx, 1);
        
        Store.save();
        
        // RafraÃ®chir la modale
        const modal = document.getElementById('scene-versions-modal');
        if(modal) {
            modal.remove();
            SceneVersions.openModal(sceneId);
        }
        
        Utils.toast('Version supprimÃ©e', 'success');
    }
};

const Synopsis = {
    getEditor: (type) => {
        const id = type === 'synopsis' ? 'synopsisEditor' : (type === 'short' ? 'shortEditor' : 'longEditor');
        return document.getElementById(id);
    },
    
    _saveTimer: null,
    _savedRange: null,
    
    saveSelection: () => {
        const sel = window.getSelection();
        if(sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            // VÃ©rifier que la sÃ©lection est dans un de nos Ã©diteurs
            const container = range.commonAncestorContainer;
            const editorBox = container.nodeType === 3 ? container.parentElement : container;
            if(editorBox && editorBox.closest && editorBox.closest('.synopsis-editor-box')) {
                Synopsis._savedRange = range.cloneRange();
            }
        }
    },
    
    restoreSelection: () => {
        if(Synopsis._savedRange) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(Synopsis._savedRange);
        }
    },
    
    save: (type, notify = false) => {
        const editor = Synopsis.getEditor(type);
        if(!editor) return;
        
        const key = type === 'synopsis' ? 'synopsis' : (type === 'short' ? 'synopsisShort' : 'synopsisLong');
        state.data[key] = editor.innerHTML;
        
        Synopsis.updateBoard();
        
        clearTimeout(Synopsis._saveTimer);
        Synopsis._saveTimer = setTimeout(() => Store.save(), 500);
        
        if(notify) Utils.notifyImpact('synopsis', 'board');
    },
    
    load: (type) => {
        const editor = Synopsis.getEditor(type);
        if(!editor) return;
        
        const key = type === 'synopsis' ? 'synopsis' : (type === 'short' ? 'synopsisShort' : 'synopsisLong');
        const content = state.data[key] || '';
        
        if(content && !content.includes('<')) {
            editor.innerHTML = content.split('\n').filter(l => l.trim()).map(l => '<p>' + l + '</p>').join('') || '';
        } else {
            editor.innerHTML = content;
        }
    },
    
    render: (type) => { Synopsis.load(type); },
    renderTree: (type) => { Synopsis.load(type); },
    
    updateBoard: () => {
        const strip = (html) => { if(!html) return '(Vide)'; const d = document.createElement('div'); d.innerHTML = html; return d.innerText.trim() || '(Vide)'; };
        if(els.boardSynopsis) els.boardSynopsis.innerText = strip(state.data.synopsis);
        if(els.boardShort) els.boardShort.innerText = strip(state.data.synopsisShort);
        if(els.boardLong) els.boardLong.innerText = strip(state.data.synopsisLong);
    },
    
    getFullText: (type) => {
        const editor = Synopsis.getEditor(type);
        if(!editor) return '';
        return editor.innerText || '';
    },
    
    exec: (cmd, value = null) => {
        Synopsis.restoreSelection();
        document.execCommand(cmd, false, value);
        Synopsis.saveSelection();
    },
    
    formatBlock: (tag, type) => {
        if(!tag) return;
        Synopsis.restoreSelection();
        document.execCommand('formatBlock', false, '<' + tag + '>');
        Synopsis.saveSelection();
    },
    
    insertImage: (type) => {
        Synopsis.saveSelection();
        const url = prompt('URL de l\'image :');
        if(url) {
            Synopsis.restoreSelection();
            document.execCommand('insertImage', false, url);
        }
    },
    
    insertTable: (type) => {
        Synopsis.saveSelection();
        const rows = parseInt(prompt('Nombre de lignes :', '3')) || 3;
        const cols = parseInt(prompt('Nombre de colonnes :', '3')) || 3;
        let html = '<table><thead><tr>';
        for(let c = 0; c < cols; c++) html += '<th>En-tÃªte</th>';
        html += '</tr></thead><tbody>';
        for(let r = 0; r < rows - 1; r++) {
            html += '<tr>';
            for(let c = 0; c < cols; c++) html += '<td>&nbsp;</td>';
            html += '</tr>';
        }
        html += '</tbody></table><p><br></p>';
        Synopsis.restoreSelection();
        document.execCommand('insertHTML', false, html);
    },
    
    init: () => {
        const types = ['synopsis', 'short', 'long'];
        types.forEach(type => {
            const editor = Synopsis.getEditor(type);
            if(editor) {
                editor.addEventListener('keyup', () => Synopsis.saveSelection());
                editor.addEventListener('mouseup', () => Synopsis.saveSelection());
                
                editor.addEventListener('input', () => Synopsis.save(type));
                
                editor.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const html = e.clipboardData.getData('text/html');
                    const text = e.clipboardData.getData('text/plain');
                    if(html) {
                        const temp = document.createElement('div');
                        temp.innerHTML = html;
                        temp.querySelectorAll('*').forEach(el => {
                            el.removeAttribute('style');
                            el.removeAttribute('class');
                        });
                        document.execCommand('insertHTML', false, temp.innerHTML);
                    } else {
                        document.execCommand('insertText', false, text);
                    }
                });
            }
        });
    }
};
    
// Module Help remplacÃ© par Tutorial


// ========== MODULE EXPORT SCÃ‰NARIO ==========
const ScriptExport = {
    // Toggle menu export
    toggleExportMenu: () => {
        const menu = document.getElementById('script-export-menu');
        if(menu.style.display === 'none') {
            menu.style.display = 'block';
            // Fermer au clic extÃ©rieur
            setTimeout(() => {
                document.addEventListener('click', ScriptExport.closeExportMenu, { once: true });
            }, 10);
        } else {
            menu.style.display = 'none';
        }
    },
    
    closeExportMenu: (e) => {
        const menu = document.getElementById('script-export-menu');
        if(menu && !menu.contains(e?.target)) {
            menu.style.display = 'none';
        }
    },
    
    // Modal page de titre
    openTitlePageModal: () => {
        const modal = document.getElementById('title-page-modal');
        if(!state.data.scriptMeta) {
            state.data.scriptMeta = { author: '', coAuthor: '', contact: '', copyright: '', draft: 'Premier jet', draftDate: '', source: '', notes: '' };
        }
        
        // Remplir les champs
        document.getElementById('script-meta-title').value = state.data.title || '';
        document.getElementById('script-meta-author').value = state.data.scriptMeta.author || '';
        document.getElementById('script-meta-coauthor').value = state.data.scriptMeta.coAuthor || '';
        document.getElementById('script-meta-contact').value = state.data.scriptMeta.contact || '';
        document.getElementById('script-meta-draft').value = state.data.scriptMeta.draft || 'Premier jet';
        document.getElementById('script-meta-date').value = state.data.scriptMeta.draftDate || '';
        document.getElementById('script-meta-source').value = state.data.scriptMeta.source || '';
        document.getElementById('script-meta-copyright').value = state.data.scriptMeta.copyright || '';
        document.getElementById('script-meta-notes').value = state.data.scriptMeta.notes || '';
        
        modal.style.display = 'flex';
    },
    
    closeTitlePageModal: () => {
        document.getElementById('title-page-modal').style.display = 'none';
    },
    
    saveTitlePage: () => {
        if(!state.data.scriptMeta) state.data.scriptMeta = {};
        
        state.data.title = document.getElementById('script-meta-title').value;
        state.data.scriptMeta.author = document.getElementById('script-meta-author').value;
        state.data.scriptMeta.coAuthor = document.getElementById('script-meta-coauthor').value;
        state.data.scriptMeta.contact = document.getElementById('script-meta-contact').value;
        state.data.scriptMeta.draft = document.getElementById('script-meta-draft').value;
        state.data.scriptMeta.draftDate = document.getElementById('script-meta-date').value;
        state.data.scriptMeta.source = document.getElementById('script-meta-source').value;
        state.data.scriptMeta.copyright = document.getElementById('script-meta-copyright').value;
        state.data.scriptMeta.notes = document.getElementById('script-meta-notes').value;
        
        Store.save();
        ScriptExport.closeTitlePageModal();
        Utils.toast('Page de titre enregistrÃ©e !', 'success');
    },
    
    // Convertit le HTML du scÃ©nario en texte brut avec type de bloc
    parseScriptContent: (html) => {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const blocks = [];
        
        temp.querySelectorAll('div, p').forEach(el => {
            const text = el.innerText.trim();
            if(!text) return;
            
            let type = 'action';
            if(el.classList.contains('sc-action')) type = 'action';
            else if(el.classList.contains('sc-perso')) type = 'character';
            else if(el.classList.contains('sc-dial')) type = 'dialogue';
            else if(el.classList.contains('sc-paren')) type = 'parenthetical';
            else if(el.classList.contains('sc-trans')) type = 'transition';
            else if(el.classList.contains('sc-centered')) type = 'centered';
            else if(el.classList.contains('sc-note')) type = 'note';
            else if(el.classList.contains('sc-general')) type = 'general';
            
            blocks.push({ type, text });
        });
        
        return blocks;
    },
    
    // ========== EXPORT FOUNTAIN ==========
    toFountain: () => {
        if(!state.data.scenes || state.data.scenes.length === 0) {
            Utils.toast('Aucune scÃ¨ne Ã  exporter', 'warning');
            return;
        }
        
        let fountain = '';
        const meta = state.data.scriptMeta || {};
        
        // Page de titre (format Fountain)
        fountain += `Title: ${state.data.title || 'Sans titre'}\n`;
        if(meta.author) {
            fountain += `Author: ${meta.author}`;
            if(meta.coAuthor) fountain += ` & ${meta.coAuthor}`;
            fountain += '\n';
        }
        if(meta.draft) fountain += `Draft date: ${meta.draft}${meta.draftDate ? ' - ' + meta.draftDate : ''}\n`;
        if(meta.contact) fountain += `Contact: ${meta.contact}\n`;
        if(meta.copyright) fountain += `Copyright: ${meta.copyright}\n`;
        if(meta.source) fountain += `Credit: BasÃ© sur ${meta.source}\n`;
        if(meta.notes) fountain += `Notes: ${meta.notes}\n`;
        fountain += '\n';
        
        // ScÃ¨nes
        state.data.scenes.forEach((scene, idx) => {
            // Scene heading (forcer avec .)
            const heading = scene.title.toUpperCase();
            if(heading.match(/^(INT|EXT|I\/E|INT\.\/EXT)/)) {
                fountain += `\n${heading}\n\n`;
            } else {
                fountain += `\n.${heading}\n\n`;
            }
            
            // Contenu de la scÃ¨ne
            const blocks = ScriptExport.parseScriptContent(scene.scriptContent || '');
            
            blocks.forEach(block => {
                switch(block.type) {
                    case 'action':
                        fountain += `${block.text}\n\n`;
                        break;
                    case 'character':
                        fountain += `${block.text.toUpperCase()}\n`;
                        break;
                    case 'dialogue':
                        fountain += `${block.text}\n\n`;
                        break;
                    case 'parenthetical':
                        const paren = block.text.startsWith('(') ? block.text : `(${block.text})`;
                        fountain += `${paren}\n`;
                        break;
                    case 'transition':
                        fountain += `> ${block.text.toUpperCase()}\n\n`;
                        break;
                    case 'centered':
                        fountain += `> ${block.text} <\n\n`;
                        break;
                    case 'note':
                        fountain += `[[${block.text}]]\n\n`;
                        break;
                    case 'general':
                        fountain += `/* ${block.text} */\n\n`;
                        break;
                }
            });
        });
        
        // TÃ©lÃ©charger le fichier
        const filename = (state.data.title || 'scenario').replace(/[^a-z0-9]/gi, '_') + '.fountain';
        ScriptExport.downloadFile(fountain, filename, 'text/plain');
        Utils.toast('Export Fountain rÃ©ussi !', 'success');
    },
    
    // ========== EXPORT FDX (Final Draft) ==========
    toFDX: () => {
        if(!state.data.scenes || state.data.scenes.length === 0) {
            Utils.toast('Aucune scÃ¨ne Ã  exporter', 'warning');
            return;
        }
        
        const meta = state.data.scriptMeta || {};
        
        // Construire le XML FDX
        let fdx = `<?xml version="1.0" encoding="UTF-8"?>
<FinalDraft DocumentType="Script" Template="No" Version="5">
  <Content>
    <TitlePage>
      <Content>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text>${ScriptExport.escapeXml(state.data.title || 'Sans titre')}</Text>
        </Paragraph>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text></Text>
        </Paragraph>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text>Ã©crit par</Text>
        </Paragraph>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text>${ScriptExport.escapeXml(meta.author || '')}${meta.coAuthor ? ' & ' + ScriptExport.escapeXml(meta.coAuthor) : ''}</Text>
        </Paragraph>`;
        
        if(meta.source) {
            fdx += `
        <Paragraph Alignment="Center" Type="Title Page">
          <Text></Text>
        </Paragraph>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text>BasÃ© sur ${ScriptExport.escapeXml(meta.source)}</Text>
        </Paragraph>`;
        }
        
        fdx += `
        <Paragraph Alignment="Left" Type="Title Page">
          <Text></Text>
        </Paragraph>
        <Paragraph Alignment="Left" Type="Title Page">
          <Text>${ScriptExport.escapeXml(meta.draft || '')}${meta.draftDate ? ' - ' + meta.draftDate : ''}</Text>
        </Paragraph>
        <Paragraph Alignment="Left" Type="Title Page">
          <Text>${ScriptExport.escapeXml(meta.contact || '')}</Text>
        </Paragraph>`;
        
        if(meta.copyright) {
            fdx += `
        <Paragraph Alignment="Left" Type="Title Page">
          <Text>${ScriptExport.escapeXml(meta.copyright)}</Text>
        </Paragraph>`;
        }
        
        fdx += `
      </Content>
    </TitlePage>
`;
        
        // ScÃ¨nes
        state.data.scenes.forEach((scene, idx) => {
            // Scene Heading
            fdx += `    <Paragraph Type="Scene Heading" Number="${idx + 1}">
      <Text>${ScriptExport.escapeXml(scene.title.toUpperCase())}</Text>
    </Paragraph>\n`;
            
            // Contenu
            const blocks = ScriptExport.parseScriptContent(scene.scriptContent || '');
            
            blocks.forEach(block => {
                let fdxType = 'Action';
                switch(block.type) {
                    case 'action': fdxType = 'Action'; break;
                    case 'character': fdxType = 'Character'; break;
                    case 'dialogue': fdxType = 'Dialogue'; break;
                    case 'parenthetical': fdxType = 'Parenthetical'; break;
                    case 'transition': fdxType = 'Transition'; break;
                    case 'centered': fdxType = 'Action'; break; // FDX n'a pas de type centrÃ© natif
                    case 'note': fdxType = 'Action'; break;
                    case 'general': fdxType = 'General'; break;
                }
                
                let text = block.text;
                if(block.type === 'note') text = `[NOTE: ${text}]`;
                
                fdx += `    <Paragraph Type="${fdxType}"${block.type === 'centered' ? ' Alignment="Center"' : ''}>
      <Text>${ScriptExport.escapeXml(text)}</Text>
    </Paragraph>\n`;
            });
        });
        
        fdx += `  </Content>
</FinalDraft>`;
        
        // TÃ©lÃ©charger le fichier
        const filename = (state.data.title || 'scenario').replace(/[^a-z0-9]/gi, '_') + '.fdx';
        ScriptExport.downloadFile(fdx, filename, 'application/xml');
        Utils.toast('Export Final Draft rÃ©ussi !', 'success');
    },
    
    // Utilitaires
    escapeXml: (str) => {
        if(!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&apos;');
    },
    
    downloadFile: (content, filename, mimeType) => {
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
};

// ========== MODULE RAPPORT DE SCRIPT / CONTINUITÃ‰ ==========
const ScriptReport = {
    currentSceneId: null,
    currentShotId: null,
    currentReportIdx: 0,
    
    init: () => {
        ScriptReport.renderScenesList();
    },
    
    // Rendu de la liste des scÃ¨nes et plans (sidebar gauche)
    renderScenesList: () => {
        const container = document.getElementById('sr-scenes-list');
        if(!container) return;
        
        const scenes = state.data.scenes || [];
        if(scenes.length === 0) {
            container.innerHTML = '<div style="padding: 20px; color: var(--text-sec); text-align: center;">Aucune scÃ¨ne crÃ©Ã©e</div>';
            return;
        }
        
        let html = '';
        scenes.forEach((scene, idx) => {
            const sceneNum = idx + 1;
            const shots = (state.data.shots || []).filter(s => s.sceneId === scene.id);
            const isActive = ScriptReport.currentSceneId === scene.id && !ScriptReport.currentShotId;
            
            html += `
                <div class="sr-scene-item ${isActive ? 'active' : ''}" onclick="app.ScriptReport.selectScene('${scene.id}')">
                    <div class="sr-scene-title">Sc.${sceneNum} - ${Utils.escape(scene.title || 'Sans titre')}</div>
                    <div style="font-size: 0.8rem; opacity: 0.7;">${shots.length} plan(s)</div>
                </div>
                <div class="sr-shot-list" id="sr-shots-${scene.id}">
                    ${shots.map((shot, shotIdx) => {
                        const hasReport = ScriptReport.hasReport(scene.id, shot.id);
                        const isActiveShot = ScriptReport.currentShotId === shot.id;
                        return `<div class="sr-shot-item ${isActiveShot ? 'active' : ''} ${hasReport ? 'has-report' : ''}" onclick="event.stopPropagation(); app.ScriptReport.selectShot('${scene.id}', '${shot.id}')">
                            Plan ${shotIdx + 1}${shot.name ? ' - ' + Utils.escape(shot.name) : ''}
                        </div>`;
                    }).join('')}
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    hasReport: (sceneId, shotId) => {
        if(!state.data.scriptReports) return false;
        const key = `${sceneId}_${shotId}`;
        return state.data.scriptReports[key] && state.data.scriptReports[key].length > 0;
    },
    
    selectScene: (sceneId) => {
        ScriptReport.currentSceneId = sceneId;
        ScriptReport.currentShotId = null;
        ScriptReport.renderScenesList();
        ScriptReport.showSceneOverview(sceneId);
    },
    
    selectShot: (sceneId, shotId) => {
        ScriptReport.currentSceneId = sceneId;
        ScriptReport.currentShotId = shotId;
        ScriptReport.currentReportIdx = 0;
        ScriptReport.renderScenesList();
        ScriptReport.renderSheet(sceneId, shotId);
    },
    
    showSceneOverview: (sceneId) => {
        const container = document.getElementById('sr-sheet-container');
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene) return;
        
        const sceneIdx = state.data.scenes.indexOf(scene) + 1;
        const shots = (state.data.shots || []).filter(s => s.sceneId === sceneId);
        
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <h2 class="mb-10">ScÃ¨ne ${sceneIdx} - ${Utils.escape(scene.title || 'Sans titre')}</h2>
                <p class="text-sec-mb20">${Utils.escape(scene.perso || 'Personnages non dÃ©finis')}</p>
                <p style="margin-bottom: 30px;">${shots.length} plan(s) dans cette scÃ¨ne</p>
                ${shots.length > 0 ? '<p class="text-sec">Cliquez sur un plan dans la liste pour remplir sa fiche.</p>' : '<p style="color: var(--warning);">Ajoutez des plans dans le Storyboard pour crÃ©er des fiches de script.</p>'}
            </div>
        `;
    },
    
    // RÃ©cupÃ©rer les infos auto-remplies
    getAutoFillData: (sceneId, shotId) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        const shot = (state.data.shots || []).find(s => s.id === shotId);
        const sceneIdx = state.data.scenes.indexOf(scene) + 1;
        const shots = (state.data.shots || []).filter(s => s.sceneId === sceneId);
        const shotIdx = shots.indexOf(shot) + 1;
        
        // Trouver le jour de tournage liÃ© Ã  cette scÃ¨ne
        let shootDay = null;
        (state.data.shootingDays || []).forEach(day => {
            if((day.scenes || []).some(s => s.sceneId === sceneId)) {
                shootDay = day;
            }
        });
        
        // Chercher le cadreur (groupe camÃ©ra gc3 ou chercher "cadreur" dans le rÃ´le)
        let cadreur = '';
        const crew = state.data.crew || [];
        const cadreurMember = crew.find(c => c.group_id === 'gc3' || (c.role || '').toLowerCase().includes('cadreur') || (c.role || '').toLowerCase().includes('camera'));
        if(cadreurMember) cadreur = cadreurMember.name;
        
        // Parser le titre de la scÃ¨ne pour INT/EXT et JOUR/NUIT
        const title = scene?.title || '';
        const isInt = /\bINT\b/i.test(title);
        const isExt = /\bEXT\b/i.test(title);
        const isJour = /\bJOUR\b/i.test(title);
        const isNuit = /\bNUIT\b/i.test(title);
        
        // RÃ©cupÃ©rer les dialogues depuis le contenu de la scÃ¨ne (personnages + dialogues + didascalies)
        // Le contenu est dans scriptContent sous forme HTML avec classes sc-perso, sc-dial, sc-paren
        let dialogues = '';
        if(scene?.scriptContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = scene.scriptContent;
            const dialogueLines = [];
            
            // Parcourir tous les Ã©lÃ©ments du script
            tempDiv.querySelectorAll('.sc-perso, .sc-dial, .sc-paren').forEach(el => {
                const text = el.textContent.trim();
                if(!text) return;
                
                if(el.classList.contains('sc-perso')) {
                    // Nom du personnage
                    dialogueLines.push('');
                    dialogueLines.push(text.toUpperCase());
                } else if(el.classList.contains('sc-paren')) {
                    // Didascalie
                    dialogueLines.push('  (' + text.replace(/^\(|\)$/g, '') + ')');
                } else if(el.classList.contains('sc-dial')) {
                    // Dialogue
                    dialogueLines.push('  ' + text);
                }
            });
            
            dialogues = dialogueLines.join('\n').trim();
        }
        
        // DÃ©terminer effet jour/nuit et int/ext
        const effet = isJour ? 'jour' : (isNuit ? 'nuit' : '');
        const lieu = isInt ? 'int' : (isExt ? 'ext' : '');
        
        return {
            film: state.data.title || '',
            decor: scene?.location || title.split('-')[0]?.replace(/INT|EXT/gi, '').trim() || '',
            date: shootDay?.startDate ? new Date(shootDay.startDate).toLocaleDateString('fr-FR') : '',
            plan: `${sceneIdx}-${shotIdx}`,
            planNom: shot?.name || '',
            camera: cadreur,
            objectif: shot?.lens || '',
            effet: effet,
            lieu: lieu,
            description: shot?.description || shot?.notes || '',
            dialogues: dialogues
        };
    },
    
    // Rendu de la fiche de script
    renderSheet: (sceneId, shotId) => {
        const container = document.getElementById('sr-sheet-container');
        if(!container) return;
        
        // Initialiser le stockage si nÃ©cessaire
        if(!state.data.scriptReports) state.data.scriptReports = {};
        const key = `${sceneId}_${shotId}`;
        if(!state.data.scriptReports[key]) state.data.scriptReports[key] = [];
        
        const reports = state.data.scriptReports[key];
        const autoFill = ScriptReport.getAutoFillData(sceneId, shotId);
        
        // Si aucun rapport, en crÃ©er un nouveau
        if(reports.length === 0) {
            reports.push(ScriptReport.createNewReport(autoFill));
            Store.save();
        }
        
        const idx = Math.min(ScriptReport.currentReportIdx, reports.length - 1);
        const report = reports[idx] || {};
        
        // Navigation entre les fiches
        let navHtml = '';
        if(reports.length > 1 || true) {
            navHtml = `<div class="sr-nav-reports">
                ${reports.map((r, i) => `<button class="sr-nav-btn ${i === idx ? 'active' : ''}" onclick="app.ScriptReport.switchReport(${i})">Fiche ${i + 1}</button>`).join('')}
                <button class="sr-nav-btn" onclick="app.ScriptReport.addReport('${sceneId}', '${shotId}')" style="background: var(--success); color: white;">+ Nouvelle fiche</button>
                ${reports.length > 1 ? `<button class="sr-nav-btn" onclick="app.ScriptReport.deleteReport('${sceneId}', '${shotId}', ${idx})" style="background: var(--danger); color: white;">ðŸ—‘ï¸</button>` : ''}
            </div>`;
        }
        
        container.innerHTML = `
            ${navHtml}
            <div class="sr-sheet">
                <!-- Ligne 1: FILM / DÃ‰COR / DATE / PLAN / EFFET -->
                <div class="sr-sheet-row" style="grid-template-columns: 1fr 1fr 120px 100px 180px;">
                    <div class="sr-sheet-cell"><strong>FILM :</strong><br><input type="text" value="${Utils.escape(report.film || autoFill.film)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'film', this.value)" class="w-full"></div>
                    <div class="sr-sheet-cell"><strong>DÃ‰COR :</strong><br><input type="text" value="${Utils.escape(report.decor || autoFill.decor)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'decor', this.value)" class="w-full"></div>
                    <div class="sr-sheet-cell"><strong>DATE :</strong><br><input type="text" value="${Utils.escape(report.date || autoFill.date)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'date', this.value)" class="w-full"></div>
                    <div class="sr-sheet-cell"><strong>PLAN :</strong><br>${Utils.escape(report.plan || autoFill.plan)}</div>
                    <div class="sr-sheet-cell">
                        <strong>EFFET :</strong><br>
                        <select style="padding: 4px;" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'effet', this.value)">
                            <option value="" ${!(report.effet || autoFill.effet) ? 'selected' : ''}>-</option>
                            <option value="jour" ${(report.effet || autoFill.effet) === 'jour' ? 'selected' : ''}>JOUR</option>
                            <option value="nuit" ${(report.effet || autoFill.effet) === 'nuit' ? 'selected' : ''}>NUIT</option>
                        </select>
                        <select style="padding: 4px;" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'lieu', this.value)">
                            <option value="" ${!(report.lieu || autoFill.lieu) ? 'selected' : ''}>-</option>
                            <option value="int" ${(report.lieu || autoFill.lieu) === 'int' ? 'selected' : ''}>INT</option>
                            <option value="ext" ${(report.lieu || autoFill.lieu) === 'ext' ? 'selected' : ''}>EXT</option>
                        </select>
                    </div>
                </div>
                
                <!-- Ligne 2: SON / SUPPORTS / CAMÃ‰RA / OBJECTIF -->
                <div class="sr-sheet-row" style="grid-template-columns: 100px 1fr 150px 150px;">
                    <div class="sr-sheet-cell">
                        <strong>SON :</strong><br>
                        <select style="padding: 4px; width: 100%;" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'son', this.value)">
                            <option value="sonore" ${report.son !== 'muet' ? 'selected' : ''}>SONORE</option>
                            <option value="muet" ${report.son === 'muet' ? 'selected' : ''}>MUET</option>
                        </select>
                    </div>
                    <div class="sr-sheet-cell"><strong>Supports :</strong><br><input type="text" value="${Utils.escape(report.supports || '')}" placeholder="Noms des supports..." onchange="app.ScriptReport.updateField('${key}', ${idx}, 'supports', this.value)" class="w-full"></div>
                    <div class="sr-sheet-cell"><strong>CAMÃ‰RA :</strong><br><input type="text" value="${Utils.escape(report.camera || autoFill.camera)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'camera', this.value)" class="w-full"></div>
                    <div class="sr-sheet-cell"><strong>OBJECTIF :</strong><br><input type="text" value="${Utils.escape(report.objectif || autoFill.objectif)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'objectif', this.value)" class="w-full"></div>
                </div>
                
                <!-- Ligne 3: NOTE (texte libre) -->
                <div class="sr-sheet-row" style="grid-template-columns: 1fr;">
                    <div class="sr-sheet-cell"><strong>NOTE :</strong><br><textarea style="width: 100%; height: 50px; border: none; resize: vertical;" placeholder="Notes libres..." onchange="app.ScriptReport.updateField('${key}', ${idx}, 'note', this.value)">${Utils.escape(report.note || '')}</textarea></div>
                </div>
                
                <!-- Tableau des prises -->
                <div class="p-10">
                    <div class="section-header-10">
                        <strong>PRISES</strong>
                        <button onclick="app.ScriptReport.addTake('${key}', ${idx})" style="padding: 5px 10px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">+ Prise</button>
                    </div>
                    <table class="sr-takes-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Prise</th>
                                <th style="width: 70px;">NÂ° Son</th>
                                <th style="width: 70px;">NÂ° Image</th>
                                <th style="width: 200px;">QualitÃ©</th>
                                <th>Notes</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(report.takes || []).map((take, tIdx) => `
                                <tr>
                                    <td style="text-align: center; vertical-align: top; padding-top: 10px;">
                                        <div class="fw-bold">${tIdx + 1}</div>
                                        <div class="mt-5">
                                            <span style="font-size: 1.3rem; color: ${take.star === 'gold' ? '#FFD700' : take.star === 'silver' ? '#A0A0A0' : '#CCC'}; cursor: pointer;" onclick="app.ScriptReport.showStarMenu(event, '${key}', ${idx}, ${tIdx})" title="Marquer cette prise">${take.star ? 'â˜…' : 'â˜†'}</span>
                                        </div>
                                    </td>
                                    <td style="vertical-align: top; padding-top: 8px;"><input type="text" value="${Utils.escape(take.numSon || '')}" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'numSon', this.value)" style="width: 100%; border: none; text-align: center;"></td>
                                    <td style="vertical-align: top; padding-top: 8px;"><input type="text" value="${Utils.escape(take.numImage || '')}" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'numImage', this.value)" style="width: 100%; border: none; text-align: center;"></td>
                                    <td style="padding: 5px; vertical-align: top;">
                                        <div class="sr-quality-row">
                                            <span class="sr-quality-label">Son</span>
                                            <select class="sr-quality-select" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'qualitySon', this.value)">
                                                <option value="" ${!take.qualitySon ? 'selected' : ''}>-</option>
                                                <option value="5" ${take.qualitySon === '5' ? 'selected' : ''}>â˜…â˜…â˜…â˜…â˜… Excellent</option>
                                                <option value="4" ${take.qualitySon === '4' ? 'selected' : ''}>â˜…â˜…â˜…â˜…â˜† TrÃ¨s bien</option>
                                                <option value="3" ${take.qualitySon === '3' ? 'selected' : ''}>â˜…â˜…â˜…â˜†â˜† Bien</option>
                                                <option value="2" ${take.qualitySon === '2' ? 'selected' : ''}>â˜…â˜…â˜†â˜†â˜† Moyen</option>
                                                <option value="1" ${take.qualitySon === '1' ? 'selected' : ''}>â˜…â˜†â˜†â˜†â˜† Pas bien</option>
                                            </select>
                                        </div>
                                        <div class="sr-quality-row">
                                            <span class="sr-quality-label">Image</span>
                                            <select class="sr-quality-select" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'qualityImage', this.value)">
                                                <option value="" ${!take.qualityImage ? 'selected' : ''}>-</option>
                                                <option value="5" ${take.qualityImage === '5' ? 'selected' : ''}>â˜…â˜…â˜…â˜…â˜… Excellent</option>
                                                <option value="4" ${take.qualityImage === '4' ? 'selected' : ''}>â˜…â˜…â˜…â˜…â˜† TrÃ¨s bien</option>
                                                <option value="3" ${take.qualityImage === '3' ? 'selected' : ''}>â˜…â˜…â˜…â˜†â˜† Bien</option>
                                                <option value="2" ${take.qualityImage === '2' ? 'selected' : ''}>â˜…â˜…â˜†â˜†â˜† Moyen</option>
                                                <option value="1" ${take.qualityImage === '1' ? 'selected' : ''}>â˜…â˜†â˜†â˜†â˜† Pas bien</option>
                                            </select>
                                        </div>
                                        <div class="sr-quality-row">
                                            <span class="sr-quality-label">Acting</span>
                                            <select class="sr-quality-select" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'qualityActing', this.value)">
                                                <option value="" ${!take.qualityActing ? 'selected' : ''}>-</option>
                                                <option value="5" ${take.qualityActing === '5' ? 'selected' : ''}>â˜…â˜…â˜…â˜…â˜… Excellent</option>
                                                <option value="4" ${take.qualityActing === '4' ? 'selected' : ''}>â˜…â˜…â˜…â˜…â˜† TrÃ¨s bien</option>
                                                <option value="3" ${take.qualityActing === '3' ? 'selected' : ''}>â˜…â˜…â˜…â˜†â˜† Bien</option>
                                                <option value="2" ${take.qualityActing === '2' ? 'selected' : ''}>â˜…â˜…â˜†â˜†â˜† Moyen</option>
                                                <option value="1" ${take.qualityActing === '1' ? 'selected' : ''}>â˜…â˜†â˜†â˜†â˜† Pas bien</option>
                                            </select>
                                        </div>
                                    </td>
                                    <td style="vertical-align: top;"><textarea placeholder="Notes, raccords, remarques..." onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'notes', this.value)" style="width: 100%; min-height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; font-size: 0.85rem;">${Utils.escape(take.notes || '')}</textarea></td>
                                    <td style="vertical-align: top; padding-top: 8px;"><button onclick="app.ScriptReport.removeTake('${key}', ${idx}, ${tIdx})" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Ã—</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Description du plan et Dialogues -->
                <div class="sr-sheet-row" style="grid-template-columns: 1fr 1fr;">
                    <div class="sr-sheet-cell p-10">
                        <strong>Description du Plan</strong>
                        <textarea class="n8-misc-3" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'description', this.value)">${Utils.escape(report.description || autoFill.description)}</textarea>
                    </div>
                    <div class="sr-sheet-cell p-10">
                        <strong>Dialogues</strong>
                        <textarea class="n8-misc-3" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'dialogues', this.value)">${Utils.escape(report.dialogues || autoFill.dialogues)}</textarea>
                    </div>
                </div>
            </div>
        `;
    },
    
    createNewReport: (autoFill = {}) => ({
        film: autoFill.film || '',
        date: autoFill.date || '',
        plan: autoFill.plan || '',
        decor: autoFill.decor || '',
        camera: autoFill.camera || '',
        objectif: autoFill.objectif || '',
        effet: autoFill.effet || '',
        lieu: autoFill.lieu || '',
        bobine: '',
        son: 'sonore',
        supports: '',
        description: autoFill.description || '',
        dialogues: autoFill.dialogues || '',
        takes: [],
        createdAt: Date.now()
    }),
    
    updateField: (key, idx, field, value) => {
        if(!state.data.scriptReports[key]) return;
        if(!state.data.scriptReports[key][idx]) return;
        state.data.scriptReports[key][idx][field] = value;
        Store.save();
    },
    
    addTake: (key, reportIdx) => {
        if(!state.data.scriptReports[key]) return;
        if(!state.data.scriptReports[key][reportIdx]) return;
        if(!state.data.scriptReports[key][reportIdx].takes) state.data.scriptReports[key][reportIdx].takes = [];
        
        state.data.scriptReports[key][reportIdx].takes.push({
            numSon: '',
            numImage: '',
            qualitySon: '',
            qualityImage: '',
            qualityActing: '',
            notes: ''
        });
        
        Store.save();
        const [sceneId, shotId] = key.split('_');
        ScriptReport.renderSheet(sceneId, shotId);
    },
    
    updateTake: (key, reportIdx, takeIdx, field, value) => {
        if(!state.data.scriptReports[key]?.[reportIdx]?.takes?.[takeIdx]) return;
        state.data.scriptReports[key][reportIdx].takes[takeIdx][field] = value;
        Store.save();
    },
    
    setTakeStar: (key, reportIdx, takeIdx, value) => {
        if(!state.data.scriptReports[key]?.[reportIdx]?.takes?.[takeIdx]) return;
        state.data.scriptReports[key][reportIdx].takes[takeIdx].star = value;
        Store.save();
        const [sceneId, shotId] = key.split('_');
        ScriptReport.renderSheet(sceneId, shotId);
    },
    
    showStarMenu: (event, key, reportIdx, takeIdx) => {
        event.stopPropagation();
        // Fermer tout menu existant
        document.querySelectorAll('.sr-star-menu').forEach(m => m.remove());
        
        const menu = document.createElement('div');
        menu.className = 'sr-star-menu';
        menu.style.cssText = 'position: absolute; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; padding: 5px 0;';
        menu.innerHTML = `
            <div style="padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="app.ScriptReport.setTakeStar('${key}', ${reportIdx}, ${takeIdx}, 'gold'); this.parentElement.remove();">
                <span style="font-size: 1.3rem; color: #FFD700;">â˜…</span> <span>Or</span>
            </div>
            <div style="padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="app.ScriptReport.setTakeStar('${key}', ${reportIdx}, ${takeIdx}, 'silver'); this.parentElement.remove();">
                <span style="font-size: 1.3rem; color: #A0A0A0;">â˜…</span> <span>Argent</span>
            </div>
            <div style="padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="app.ScriptReport.setTakeStar('${key}', ${reportIdx}, ${takeIdx}, ''); this.parentElement.remove();">
                <span style="font-size: 1.3rem; color: #CCC;">â˜†</span> <span>Aucune</span>
            </div>
        `;
        
        document.body.appendChild(menu);
        
        // Positionner le menu
        const rect = event.target.getBoundingClientRect();
        menu.style.left = rect.left + 'px';
        menu.style.top = (rect.bottom + 5) + 'px';
        
        // Fermer au clic ailleurs
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }, { once: true });
        }, 10);
    },
    
    removeTake: async (key, reportIdx, takeIdx) => {
        if(!await ConfirmModal.confirmDelete('Supprimer cette prise ?')) return;
        if(!state.data.scriptReports[key]?.[reportIdx]?.takes) return;
        state.data.scriptReports[key][reportIdx].takes.splice(takeIdx, 1);
        Store.save();
        const [sceneId, shotId] = key.split('_');
        ScriptReport.renderSheet(sceneId, shotId);
    },
    
       
    switchReport: (idx) => {
        ScriptReport.currentReportIdx = idx;
        if(ScriptReport.currentSceneId && ScriptReport.currentShotId) {
            ScriptReport.renderSheet(ScriptReport.currentSceneId, ScriptReport.currentShotId);
        }
    },
    
    addReport: (sceneId, shotId) => {
        const key = `${sceneId}_${shotId}`;
        if(!state.data.scriptReports[key]) state.data.scriptReports[key] = [];
        const autoFill = ScriptReport.getAutoFillData(sceneId, shotId);
        state.data.scriptReports[key].push(ScriptReport.createNewReport(autoFill));
        ScriptReport.currentReportIdx = state.data.scriptReports[key].length - 1;
        Store.save();
        ScriptReport.renderScenesList();
        ScriptReport.renderSheet(sceneId, shotId);
        Utils.toast('Nouvelle fiche crÃ©Ã©e', 'success');
    },
    
    deleteReport: async (sceneId, shotId, idx) => {
        if(!await ConfirmModal.confirmDelete('Supprimer cette fiche de script ?')) return;
        const key = `${sceneId}_${shotId}`;
        if(!state.data.scriptReports[key]) return;
        state.data.scriptReports[key].splice(idx, 1);
        ScriptReport.currentReportIdx = Math.max(0, idx - 1);
        Store.save();
        ScriptReport.renderScenesList();
        ScriptReport.renderSheet(sceneId, shotId);
        Utils.toast('Fiche supprimÃ©e', 'success');
    },
    
    exportCurrentPDF: () => {
        if(!ScriptReport.currentSceneId || !ScriptReport.currentShotId) {
            Utils.toast('SÃ©lectionnez d\'abord un plan', 'warning');
            return;
        }
        ScriptReport.generatePDF(ScriptReport.currentSceneId, ScriptReport.currentShotId, ScriptReport.currentReportIdx);
    },
    
    exportAllPDF: () => {
        Utils.toast('Export de toutes les fiches...', 'info');
        // Export toutes les fiches dans un seul PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        let firstPage = true;
        
        Object.entries(state.data.scriptReports || {}).forEach(([key, reports]) => {
            reports.forEach((report, idx) => {
                if(!firstPage) doc.addPage();
                firstPage = false;
                ScriptReport.renderPDFPage(doc, report, key);
            });
        });
        
        if(firstPage) {
            Utils.toast('Aucune fiche Ã  exporter', 'warning');
            return;
        }
        
        const filename = `${state.data.title || 'Projet'}_Rapports_Script.pdf`;
        doc.save(filename.replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§_-]/gi, '_'));
        Utils.toast('PDF exportÃ© !', 'success');
    },
    
    generatePDF: (sceneId, shotId, reportIdx) => {
        const key = `${sceneId}_${shotId}`;
        const report = state.data.scriptReports?.[key]?.[reportIdx];
        if(!report) return;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        ScriptReport.renderPDFPage(doc, report, key);
        
        const filename = `Fiche_Script_${report.plan || 'Plan'}.pdf`;
        doc.save(filename.replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§_-]/gi, '_'));
        Utils.toast('PDF exportÃ© !', 'success');
    },
    
    renderPDFPage: (doc, report, key) => {
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = margin;
        
        // RÃ©cupÃ©rer les dialogues depuis autoFill si report.dialogues est vide
        let dialoguesText = report.dialogues || '';
        if(!dialoguesText && key) {
            const [sceneId, shotId] = key.split('_');
            const autoFill = ScriptReport.getAutoFillData(sceneId, shotId);
            dialoguesText = autoFill.dialogues || '';
        }
        
        doc.setDrawColor(50, 50, 50);
        doc.setLineWidth(0.4);
        
        // === TITRE / EN-TÃŠTE ===
        doc.setFillColor(51, 51, 51);
        doc.rect(margin, y, pageWidth - 2*margin, 12, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('FICHE DE SCRIPT', pageWidth / 2, y + 8, { align: 'center' });
        doc.setTextColor(0, 0, 0);
        y += 15;
        
        // === LIGNE 1 : FILM / DATE / PLAN ===
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        const row1Height = 12;
        doc.rect(margin, y, pageWidth - 2*margin, row1Height);
        doc.line(margin + 90, y, margin + 90, y + row1Height);
        doc.line(pageWidth - margin - 60, y, pageWidth - margin - 60, y + row1Height);
        
        doc.text('FILM :', margin + 3, y + 5);
        doc.text('DATE :', margin + 93, y + 5);
        doc.text('PLAN :', pageWidth - margin - 57, y + 5);
        
        doc.setFont('helvetica', 'normal');
        doc.text(report.film || '', margin + 3, y + 10);
        doc.text(report.date || '', margin + 93, y + 10);
        doc.text(report.plan || '', pageWidth - margin - 57, y + 10);
        y += row1Height;
        
        // === LIGNE 2 : DÃ‰COR / EFFET ===
        doc.rect(margin, y, pageWidth - 2*margin, row1Height);
        doc.line(pageWidth - margin - 70, y, pageWidth - margin - 70, y + row1Height);
        
        doc.setFont('helvetica', 'bold');
        doc.text('DÃ‰COR :', margin + 3, y + 5);
        doc.text('EFFET :', pageWidth - margin - 67, y + 5);
        
        doc.setFont('helvetica', 'normal');
        doc.text(report.decor || '', margin + 3, y + 10);
        const effetStr = [(report.effet || '').toUpperCase(), (report.lieu || '').toUpperCase()].filter(Boolean).join(' - ');
        doc.text(effetStr, pageWidth - margin - 67, y + 10);
        y += row1Height;
        
        // === LIGNE 3 : SON / SUPPORTS / CAM / OBJ ===
        doc.rect(margin, y, pageWidth - 2*margin, row1Height);
        doc.line(margin + 30, y, margin + 30, y + row1Height);
        doc.line(margin + 90, y, margin + 90, y + row1Height);
        doc.line(pageWidth - margin - 45, y, pageWidth - margin - 45, y + row1Height);
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.text('SON', margin + 3, y + 4);
        doc.text('SUPPORTS', margin + 33, y + 4);
        doc.text('CAMERA', margin + 93, y + 4);
        doc.text('OBJECTIF', pageWidth - margin - 42, y + 4);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text(report.son === 'muet' ? 'MUET' : 'SONORE', margin + 3, y + 10);
        doc.text(report.supports || '-', margin + 33, y + 10);
        doc.text(report.camera || '-', margin + 93, y + 10);
        doc.text(report.objectif || '-', pageWidth - margin - 42, y + 10);
        y += row1Height;
        
        // === LIGNE 4 : NOTE (si prÃ©sente) ===
        if(report.note) {
            doc.setFontSize(9);
            const noteLines = doc.splitTextToSize(report.note, pageWidth - 2*margin - 25);
            const noteHeight = Math.max(10, noteLines.length * 4 + 6);
            doc.rect(margin, y, pageWidth - 2*margin, noteHeight);
            doc.setFont('helvetica', 'bold');
            doc.text('NOTE :', margin + 3, y + 5);
            doc.setFont('helvetica', 'normal');
            noteLines.forEach((line, i) => doc.text(line, margin + 22, y + 5 + i*4));
            y += noteHeight;
        }
        
        y += 5;
        
        // === TABLEAU DES PRISES ===
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('PRISES', margin, y + 4);
        y += 7;
        
        doc.setFontSize(8);
        const tableWidth = pageWidth - 2*margin;
        const col1 = 18; // Prise
        const col2 = 25; // NÂ° Son
        const col3 = 28; // NÂ° Image
        const col4 = tableWidth - col1 - col2 - col3; // QualitÃ© & Notes
        
        // En-tÃªte tableau
        doc.setFillColor(230, 230, 230);
        doc.rect(margin, y, tableWidth, 8, 'FD');
        doc.setFont('helvetica', 'bold');
        doc.text('Prise', margin + 2, y + 5);
        doc.text('NÂ° Son', margin + col1 + 2, y + 5);
        doc.text('NÂ° Image', margin + col1 + col2 + 2, y + 5);
        doc.text('QualitÃ© & Notes', margin + col1 + col2 + col3 + 2, y + 5);
        y += 8;
        
        // Lignes de prises
        doc.setFont('helvetica', 'normal');
        (report.takes || []).forEach((take, idx) => {
            const hasStar = take.star === 'gold' || take.star === 'silver';
            const qualArr = [];
            if(take.qualitySon) qualArr.push('Son:' + take.qualitySon + '/5');
            if(take.qualityImage) qualArr.push('Img:' + take.qualityImage + '/5');
            if(take.qualityActing) qualArr.push('Act:' + take.qualityActing + '/5');
            const qualStr = qualArr.length > 0 ? qualArr.join(' | ') : '';
            const notesStr = take.notes || '';
            const fullDesc = qualStr + (qualStr && notesStr ? ' - ' : '') + notesStr;
            
            const descLines = doc.splitTextToSize(fullDesc, col4 - 6);
            const rowHeight = Math.max(8, descLines.length * 4 + 3);
            
            if(y + rowHeight > pageHeight - 70) {
                doc.addPage();
                y = margin;
            }
            
            doc.rect(margin, y, tableWidth, rowHeight);
            doc.line(margin + col1, y, margin + col1, y + rowHeight);
            doc.line(margin + col1 + col2, y, margin + col1 + col2, y + rowHeight);
            doc.line(margin + col1 + col2 + col3, y, margin + col1 + col2 + col3, y + rowHeight);
            
            doc.setFont('helvetica', 'bold');
            doc.text(`${idx + 1}`, margin + 2, y + 5);
            
            // Dessiner une Ã©toile si nÃ©cessaire
            if(hasStar) {
                const starX = margin + 12;
                const starY = y + 3;
                const starSize = 2.5;
                
                // Couleur de l'Ã©toile
                if(take.star === 'gold') {
                    doc.setFillColor(255, 215, 0); // Or
                } else {
                    doc.setFillColor(180, 180, 180); // Argent
                }
                
                // Dessiner une Ã©toile Ã  5 branches
                const points = [];
                for(let i = 0; i < 10; i++) {
                    const radius = i % 2 === 0 ? starSize : starSize * 0.4;
                    const angle = (i * 36 - 90) * Math.PI / 180;
                    points.push({
                        x: starX + radius * Math.cos(angle),
                        y: starY + radius * Math.sin(angle)
                    });
                }
                
                doc.setDrawColor(150, 150, 150);
                doc.setLineWidth(0.1);
                doc.moveTo(points[0].x, points[0].y);
                for(let i = 1; i < points.length; i++) {
                    doc.lineTo(points[i].x, points[i].y);
                }
                doc.lineTo(points[0].x, points[0].y);
                doc.fillStroke();
                
                // Reset couleurs
                doc.setDrawColor(50, 50, 50);
                doc.setLineWidth(0.4);
            }
            doc.setFont('helvetica', 'normal');
            doc.text(take.numSon || '', margin + col1 + 2, y + 5);
            doc.text(take.numImage || '', margin + col1 + col2 + 2, y + 5);
            descLines.forEach((line, i) => doc.text(line, margin + col1 + col2 + col3 + 2, y + 5 + i*4));
            
            y += rowHeight;
        });
        
        if((report.takes || []).length === 0) {
            doc.rect(margin, y, tableWidth, 10);
            doc.setTextColor(150, 150, 150);
            doc.text('Aucune prise enregistrÃ©e', margin + tableWidth/2, y + 6, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            y += 10;
        }
        
        y += 8;
        
        // === DESCRIPTION ET DIALOGUES ===
        if(y > pageHeight - 80) {
            doc.addPage();
            y = margin;
        }
        
        const halfWidth = (pageWidth - 2*margin - 5) / 2;
        const boxHeight = Math.min(70, pageHeight - y - 15);
        
        // Description
        doc.rect(margin, y, halfWidth, boxHeight);
        doc.setFillColor(245, 245, 245);
        doc.rect(margin, y, halfWidth, 8, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text('Description du Plan', margin + 3, y + 6);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        const descLines2 = doc.splitTextToSize(report.description || '', halfWidth - 6);
        descLines2.slice(0, 15).forEach((line, i) => doc.text(line, margin + 3, y + 14 + i*4));
        
        // Dialogues
        doc.rect(margin + halfWidth + 5, y, halfWidth, boxHeight);
        doc.setFillColor(245, 245, 245);
        doc.rect(margin + halfWidth + 5, y, halfWidth, 8, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text('Dialogues', margin + halfWidth + 8, y + 6);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        const dialLines2 = doc.splitTextToSize(dialoguesText, halfWidth - 6);
        dialLines2.slice(0, 15).forEach((line, i) => doc.text(line, margin + halfWidth + 8, y + 14 + i*4));
    }
};

// ========== MODULE MÃ‰TÃ‰O (Open-Meteo API - 100% gratuit) ==========
const Weather = {
    cache: {},
    
    weatherCodes: {
        0: { icon: 'â˜€ï¸', desc: 'Ciel dÃ©gagÃ©' },
        1: { icon: 'ðŸŒ¤ï¸', desc: 'Principalement dÃ©gagÃ©' },
        2: { icon: 'â›…', desc: 'Partiellement nuageux' },
        3: { icon: 'â˜ï¸', desc: 'Couvert' },
        45: { icon: 'ðŸŒ«ï¸', desc: 'Brouillard' },
        48: { icon: 'ðŸŒ«ï¸', desc: 'Brouillard givrant' },
        51: { icon: 'ðŸŒ§ï¸', desc: 'Bruine lÃ©gÃ¨re' },
        53: { icon: 'ðŸŒ§ï¸', desc: 'Bruine modÃ©rÃ©e' },
        55: { icon: 'ðŸŒ§ï¸', desc: 'Bruine dense' },
        61: { icon: 'ðŸŒ§ï¸', desc: 'Pluie lÃ©gÃ¨re' },
        63: { icon: 'ðŸŒ§ï¸', desc: 'Pluie modÃ©rÃ©e' },
        65: { icon: 'ðŸŒ§ï¸', desc: 'Pluie forte' },
        71: { icon: 'ðŸŒ¨ï¸', desc: 'Neige lÃ©gÃ¨re' },
        73: { icon: 'ðŸŒ¨ï¸', desc: 'Neige modÃ©rÃ©e' },
        75: { icon: 'ðŸŒ¨ï¸', desc: 'Neige forte' },
        80: { icon: 'ðŸŒ¦ï¸', desc: 'Averses lÃ©gÃ¨res' },
        81: { icon: 'ðŸŒ¦ï¸', desc: 'Averses modÃ©rÃ©es' },
        82: { icon: 'ðŸŒ¦ï¸', desc: 'Averses violentes' },
        85: { icon: 'ðŸŒ¨ï¸', desc: 'Averses de neige' },
        95: { icon: 'â›ˆï¸', desc: 'Orage' },
        96: { icon: 'â›ˆï¸', desc: 'Orage avec grÃªle' },
        99: { icon: 'â›ˆï¸', desc: 'Orage violent' }
    },
    
    getWindDirection: (degrees) => {
        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
        return directions[Math.round(degrees / 45) % 8];
    },
    
    fetch: async (lat, lng, date) => {
        if(!lat || !lng || !date) return null;
        
        const cacheKey = `${lat.toFixed(2)}_${lng.toFixed(2)}_${date}`;
        if(Weather.cache[cacheKey]) return Weather.cache[cacheKey];
        
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,precipitation_sum,precipitation_probability_max,windspeed_10m_max,winddirection_10m_dominant,sunrise,sunset&timezone=Europe/Paris&start_date=${date}&end_date=${date}`;
            
            const response = await fetch(url);
            if(!response.ok) throw new Error('Erreur API mÃ©tÃ©o');
            
            const data = await response.json();
            if(!data.daily || !data.daily.time?.length) return null;
            
            const weatherCode = data.daily.weathercode[0];
            const weatherInfo = Weather.weatherCodes[weatherCode] || { icon: 'â“', desc: 'Inconnu' };
            
            const result = {
                icon: weatherInfo.icon,
                description: weatherInfo.desc,
                tempMax: Math.round(data.daily.temperature_2m_max[0]),
                tempMin: Math.round(data.daily.temperature_2m_min[0]),
                feelsLike: Math.round(data.daily.apparent_temperature_max[0]),
                precipitation: data.daily.precipitation_sum[0],
                precipitationProb: data.daily.precipitation_probability_max[0],
                windSpeed: Math.round(data.daily.windspeed_10m_max[0]),
                windDirection: Weather.getWindDirection(data.daily.winddirection_10m_dominant[0]),
                sunrise: data.daily.sunrise[0]?.split('T')[1] || '--:--',
                sunset: data.daily.sunset[0]?.split('T')[1] || '--:--'
            };
            
            Weather.cache[cacheKey] = result;
            return result;
        } catch(e) {
            console.error('Erreur mÃ©tÃ©o:', e);
            return null;
        }
    },
    
    renderCard: (weather) => {
        if(!weather) return `<div class="fds-weather-loading">ðŸŒ¤ï¸ MÃ©tÃ©o non disponible</div>`;
        
        return `
            <div class="fds-weather-card">
                <div class="fds-weather-icon">${weather.icon}</div>
                <div class="fds-weather-main">
                    <div class="fds-weather-temp">${weather.tempMax}Â°C</div>
                    <div class="fds-weather-desc">${weather.description}</div>
                    <div class="fds-sun-times">
                        <span class="fds-sun-item">ðŸŒ… ${weather.sunrise}</span>
                        <span class="fds-sun-item">ðŸŒ‡ ${weather.sunset}</span>
                    </div>
                </div>
                <div class="fds-weather-details">
                    <span>Min: ${weather.tempMin}Â°C</span>
                    <span>Ressenti: ${weather.feelsLike}Â°C</span>
                </div>
            </div>
            <div class="fds-weather-row">
                <div class="fds-weather-item">ðŸ’§ ${weather.precipitationProb}% pluie</div>
                ${weather.precipitation > 0 ? `<div class="fds-weather-item">ðŸŒ§ï¸ ${weather.precipitation}mm</div>` : ''}
                <div class="fds-weather-item">ðŸ’¨ ${weather.windSpeed} km/h ${weather.windDirection}</div>
            </div>
        `;
    }
};

  window.ColorWheel = ColorWheel;
  // ==================== MODULE BEAT BOARD ====================
  // ========== MODE FOCUS (Plein Ã©cran onglet) ==========
  const FocusMode = {
      isActive: false,
      tabOrder: ['presentation', 'synopsis', 'board', 'titlepage', 'script', 'moodboard', 'storyboard', 'chars', 'actors', 'locs', 'resources', 'crew', 'breakdown', 'stats', 'planning', 'scriptreport', 'expenses', 'chat'],
      tabNames: {
          'presentation': 'ðŸ“‹ PrÃ©sentation',
          'synopsis': 'ðŸ“ Synopsis', 
          'board': 'ðŸŽ¬ SÃ©quencier / BB',
          'titlepage': 'ðŸŽžï¸ Page de Titre',
          'script': 'ðŸ“„ ScÃ©nario',
          'moodboard': 'ðŸŽ¨ Mood Board',
          'storyboard': 'ðŸ–¼ï¸ Storyboard',
          'chars': 'ðŸ‘¤ Personnages',
          'actors': 'ðŸŽ­ ComÃ©diens',
          'locs': 'ðŸ  DÃ©cors',
          'resources': 'ðŸ“¦ Ressources',
          'crew': 'ðŸ‘¥ Ã‰quipes',
          'breakdown': 'ðŸ“‹ DÃ©pouillement',
          'stats': 'ðŸ“Š Statistiques',
          'planning': 'ðŸ“… Planning',
          'scriptreport': 'ðŸ“ Rapport',
          'expenses': 'ðŸ’° DÃ©penses',
          'chat': 'ðŸ’¬ Chat'
      },
      
      toggle: () => {
          if(FocusMode.isActive) {
              FocusMode.exit();
          } else {
              FocusMode.enter();
          }
      },
      
      enter: () => {
          FocusMode.isActive = true;
          document.body.classList.add('focus-mode');
          document.getElementById('focus-toolbar').style.display = 'flex';
          FocusMode.updateTitle();
          document.getElementById('focus-project-title').textContent = state.data.title || 'Mon Film';
          Utils.toast('Mode Focus activÃ© (Ã‰chap pour quitter)', 'info');
      },
      
      exit: () => {
          FocusMode.isActive = false;
          document.body.classList.remove('focus-mode');
          document.getElementById('focus-toolbar').style.display = 'none';
      },
      
      updateTitle: () => {
          const activeTab = document.querySelector('.tab-content.active');
          if(activeTab) {
              const tabId = activeTab.id.replace('tab-', '');
              document.getElementById('focus-tab-title').textContent = FocusMode.tabNames[tabId] || tabId;
          }
      },
      
      getCurrentIndex: () => {
          const activeTab = document.querySelector('.tab-content.active');
          if(activeTab) {
              const tabId = activeTab.id.replace('tab-', '');
              return FocusMode.tabOrder.indexOf(tabId);
          }
          return 0;
      },
      
      nextTab: () => {
          const currentIdx = FocusMode.getCurrentIndex();
          const nextIdx = (currentIdx + 1) % FocusMode.tabOrder.length;
          app.UI.switchTab(FocusMode.tabOrder[nextIdx]);
          FocusMode.updateTitle();
      },
      
      prevTab: () => {
          const currentIdx = FocusMode.getCurrentIndex();
          const prevIdx = (currentIdx - 1 + FocusMode.tabOrder.length) % FocusMode.tabOrder.length;
          app.UI.switchTab(FocusMode.tabOrder[prevIdx]);
          FocusMode.updateTitle();
      }
  };

  const BeatBoard = {
      viewMode: 'sequencer', // 'sequencer' ou 'beatboard'
      zoom: 1,
      panX: 0,
      panY: 0,
      isPanning: false,
      panStartX: 0,
      panStartY: 0,
      draggedCard: null,
      showLine: true,
      showTagLines: false,
      activeTagLines: {}, // { tagId: true/false } pour toggle individuel
      selectedCards: [], // IDs des cartes sÃ©lectionnÃ©es
      
      setViewMode: (mode) => {
          BeatBoard.viewMode = mode;
          const seqView = document.getElementById('sequencer-view');
          const bbView = document.getElementById('beatboard-view');
          const seqOpts = document.getElementById('sequencer-options');
          const bbOpts = document.getElementById('beatboard-options');
          const btnSeq = document.getElementById('view-mode-sequencer');
          const btnBB = document.getElementById('view-mode-beatboard');
          
          if(mode === 'sequencer') {
              seqView.style.display = 'block';
              bbView.style.display = 'none';
              seqOpts.style.display = 'block';
              bbOpts.style.display = 'none';
              btnSeq.style.background = 'var(--primary)';
              btnSeq.style.color = 'white';
              btnBB.style.background = 'var(--bg)';
              btnBB.style.color = 'var(--text-main)';
          } else {
              seqView.style.display = 'none';
              bbView.style.display = 'block';
              seqOpts.style.display = 'none';
              bbOpts.style.display = 'block';
              btnSeq.style.background = 'var(--bg)';
              btnSeq.style.color = 'var(--text-main)';
              btnBB.style.background = 'var(--primary)';
              btnBB.style.color = 'white';
              BeatBoard.render();
          }
      },
      
      render: () => {
          const canvas = document.getElementById('beatboardCanvas');
          if(!canvas) return;
          
          // Supprimer les anciennes cartes et zones
          canvas.querySelectorAll('.beatboard-card, .beatboard-out-timeline-zone').forEach(c => c.remove());
          
          // SÃ©parer les scÃ¨nes in/out timeline
          const inTimeline = state.data.scenes.filter(s => s.inTimeline !== false);
          const outTimeline = state.data.scenes.filter(s => s.inTimeline === false);
          
          // Initialiser positions si nÃ©cessaire
          inTimeline.forEach((scene, idx) => {
              if(!scene.beatboardX || !scene.beatboardY) {
                  scene.beatboardX = 50 + (idx % 6) * 220;
                  scene.beatboardY = 50 + Math.floor(idx / 6) * 160;
              }
          });
          
          // Positionner les scÃ¨nes hors timeline en bas
          outTimeline.forEach((scene, idx) => {
              if(!scene.beatboardX || !scene.beatboardY) {
                  scene.beatboardX = 50 + (idx % 8) * 200;
                  scene.beatboardY = 800 + Math.floor(idx / 8) * 140;
              }
          });
          
          // CrÃ©er les cartes in timeline avec numÃ©ros
          inTimeline.forEach((scene, idx) => {
              const card = BeatBoard.createCard(scene, idx, true);
              canvas.appendChild(card);
          });
          
          // CrÃ©er les cartes out timeline sans numÃ©ros
          outTimeline.forEach((scene) => {
              const card = BeatBoard.createCard(scene, null, false);
              canvas.appendChild(card);
          });
          
          // Zone visuelle "Hors timeline" si il y a des scÃ¨nes dedans
          if(outTimeline.length > 0) {
              const zone = document.createElement('div');
              zone.className = 'beatboard-out-timeline-zone';
              zone.innerHTML = '<span class="beatboard-out-timeline-label">ðŸ“Œ Hors timeline</span>';
              zone.style.bottom = '20px';
              zone.style.left = '20px';
              zone.style.transform = 'none';
              zone.style.position = 'absolute';
              zone.style.top = '750px';
              canvas.appendChild(zone);
          }
          
          // Dessiner le fil rouge (seulement les scÃ¨nes in timeline)
          BeatBoard.drawLine();
          
          // Dessiner les lignes de tags
          BeatBoard.drawTagLines();
          
          // Mettre Ã  jour la liste des tags
          BeatBoard.renderTagList();
          
          // Mettre Ã  jour la liste des lignes de tags
          BeatBoard.renderTagLinesList();
          
          // Mettre Ã  jour la minimap
          BeatBoard.updateMinimap();
          
          // Initialiser le pan
          BeatBoard.initPan();
      },
      
      createCard: (scene, idx, isInTimeline = true) => {
          const card = document.createElement('div');
          card.className = 'beatboard-card' + (isInTimeline ? '' : ' out-of-timeline');
          card.dataset.id = scene.id;
          card.dataset.inTimeline = isInTimeline;
          if(idx !== null) card.dataset.index = idx;
          card.style.left = scene.beatboardX + 'px';
          card.style.top = scene.beatboardY + 'px';
          
          // Marquer comme sÃ©lectionnÃ© si dans la liste
          if(BeatBoard.selectedCards.includes(scene.id)) {
              card.classList.add('selected');
          }
          
          const tag = state.data.tags.find(t => t.id === scene.tag_id) || {name:'', color: 'transparent'};
          const status = scene.status || 'not-verified';
          
          const numberBadge = isInTimeline ? `<div class="beatboard-card-number">${idx + 1}</div>` : '';
          const timelineIcon = isInTimeline ? '' : '<span style="position:absolute;top:8px;right:8px;font-size:0.7rem;color:var(--text-sec);">ðŸ“Œ</span>';
          
          card.innerHTML = `
              <div class="beatboard-card-tag" style="background: ${tag.color !== 'transparent' ? tag.color : 'var(--border)'}"></div>
              ${numberBadge}
              ${timelineIcon}
              <div class="beatboard-card-connector in"></div>
              <div class="beatboard-card-connector out"></div>
              <div class="beatboard-card-title">${Utils.escape(scene.title)}</div>
              <div class="beatboard-card-meta">${Utils.escape(scene.perso || '-')} â€¢ ${scene.time || '?'} min</div>
              <div class="beatboard-card-resume">${Utils.escape(scene.resume || '')}</div>
              <div class="beatboard-card-status">${SCENE_STATUS_LABELS[status]}</div>
          `;
          
          // Clic avec Ctrl = sÃ©lection multiple
          card.addEventListener('click', (e) => {
              if(e.ctrlKey || e.metaKey) {
                  e.preventDefault();
                  e.stopPropagation();
                  BeatBoard.toggleSelection(scene.id);
              }
          });
          
          // Drag & Drop
          card.addEventListener('mousedown', (e) => {
              if(e.ctrlKey || e.metaKey) return; // Ctrl = sÃ©lection, pas drag
              BeatBoard.startDrag(e, card, scene);
          });
          card.addEventListener('dblclick', () => Actions.editScene(scene.id));
          card.addEventListener('contextmenu', (e) => Actions.openTagMenu(e, scene.id));
          
          return card;
      },
      
      toggleSelection: (sceneId) => {
          const idx = BeatBoard.selectedCards.indexOf(sceneId);
          if(idx === -1) {
              BeatBoard.selectedCards.push(sceneId);
          } else {
              BeatBoard.selectedCards.splice(idx, 1);
          }
          // Mettre Ã  jour visuellement
          const card = document.querySelector(`.beatboard-card[data-id="${sceneId}"]`);
          if(card) card.classList.toggle('selected');
      },
      
      clearSelection: () => {
          BeatBoard.selectedCards = [];
          document.querySelectorAll('.beatboard-card.selected').forEach(c => c.classList.remove('selected'));
      },
      
      createScene: () => {
          // Ouvrir le formulaire de crÃ©ation de scÃ¨ne
          const form = document.getElementById('edit-scene-form');
          if(form) {
              // RÃ©initialiser le formulaire
              document.getElementById('inpPre').value = 'INT';
              document.getElementById('inpLoc').value = '';
              document.getElementById('inpSuff').value = 'JOUR';
              document.getElementById('inpTime').value = '';
              document.getElementById('inpPerso').value = '';
              document.getElementById('inpResume').value = '';
          }
          
          // CrÃ©er un modal pour le formulaire dans le beatboard
          const existingModal = document.getElementById('beatboard-scene-modal');
          if(existingModal) existingModal.remove();
          
          const modal = document.createElement('div');
          modal.id = 'beatboard-scene-modal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:10001;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:90%; max-width:500px; border:1px solid var(--border);">
                  <h3 style="margin:0 0 20px; display:flex; justify-content:space-between; align-items:center;">
                      âž• Nouvelle scÃ¨ne (hors timeline)
                      <button onclick="document.getElementById('beatboard-scene-modal').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-sec);">Ã—</button>
                  </h3>
                  <div style="display:flex; gap:8px; margin-bottom:15px;">
                      <input id="bb-inpPre" placeholder="INT" value="INT" style="width:60px; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                      <span style="display:flex; align-items:center;">.</span>
                      <input id="bb-inpLoc" placeholder="LIEU" style="flex:1; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                      <span style="display:flex; align-items:center;">-</span>
                      <input id="bb-inpSuff" placeholder="JOUR" value="JOUR" style="width:80px; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                  </div>
                  <input id="bb-inpTime" placeholder="DurÃ©e (min)" class="n8-input-8">
                  <input id="bb-inpPerso" placeholder="Personnages..." class="n8-input-8">
                  <textarea id="bb-inpResume" rows="3" placeholder="RÃ©sumÃ©..." style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); resize:vertical; margin-bottom:20px;"></textarea>
                  <div class="flex-end">
                      <button onclick="document.getElementById('beatboard-scene-modal').remove()" class="n8-btn-3">Annuler</button>
                      <button onclick="app.BeatBoard.addScene()" class="btn-primary">âž• CrÃ©er</button>
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
          document.getElementById('bb-inpLoc').focus();
      },
      
      addScene: () => {
          const pre = document.getElementById('bb-inpPre').value.trim() || 'INT';
          const loc = document.getElementById('bb-inpLoc').value.trim();
          const suff = document.getElementById('bb-inpSuff').value.trim() || 'JOUR';
          
          if(!loc) {
              Utils.toast('Entrez un lieu', 'warning');
              return;
          }
          
          const title = `${pre}. ${loc} - ${suff}`;
          
          const newScene = {
              id: Utils.generateUniqueId(),
              title: title,
              perso: document.getElementById('bb-inpPerso').value.trim(),
              time: document.getElementById('bb-inpTime').value.trim(),
              resume: document.getElementById('bb-inpResume').value.trim(),
              scriptContent: "<div class='sc-action'><br></div>",
              breakdown: {},
              tag_id: 't1',
              inTimeline: false, // Hors timeline par dÃ©faut
              beatboardX: 50 + Math.random() * 200,
              beatboardY: 800 + Math.random() * 100,
              lastModified: Date.now(),
              lastModifiedBy: state.currentUser?.email || 'unknown'
          };
          
          state.data.scenes.push(newScene);
          Store.save();
          
          document.getElementById('beatboard-scene-modal').remove();
          BeatBoard.render();
          UI.renderBoard();
          
          Utils.toast('ScÃ¨ne crÃ©Ã©e (hors timeline)', 'success');
      },
      
      startDrag: (e, card, scene) => {
          if(e.button !== 0) return;
          e.preventDefault();
          
          const isReorderMode = e.shiftKey;
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          const sceneIndex = inTimelineScenes.findIndex(s => s.id === scene.id);
          const isCurrentlyInTimeline = scene.inTimeline !== false;
          
          // Multi-sÃ©lection : si la scÃ¨ne draggÃ©e est dans la sÃ©lection, on dÃ©place tout le groupe
          const isMultiDrag = BeatBoard.selectedCards.length > 1 && BeatBoard.selectedCards.includes(scene.id);
          const selectedScenes = isMultiDrag 
              ? state.data.scenes.filter(s => BeatBoard.selectedCards.includes(s.id))
              : [scene];
          
          // Stocker les positions originales de toutes les cartes sÃ©lectionnÃ©es
          const originalPositions = selectedScenes.map(s => ({
              scene: s,
              origX: s.beatboardX,
              origY: s.beatboardY,
              card: document.querySelector(`.beatboard-card[data-id="${s.id}"]`)
          }));
          
          BeatBoard.draggedCard = { 
              card, 
              scene, 
              sceneIndex,
              startX: e.clientX, 
              startY: e.clientY, 
              origX: scene.beatboardX, 
              origY: scene.beatboardY,
              isReorderMode,
              isMultiDrag,
              originalPositions
          };
          
          // Ajouter la classe dragging Ã  toutes les cartes sÃ©lectionnÃ©es
          originalPositions.forEach(p => {
              if(p.card) p.card.classList.add('dragging');
          });
          
          if(isReorderMode) {
              card.style.zIndex = '2000';
              card.style.boxShadow = '0 20px 60px rgba(231, 76, 60, 0.4)';
              card.style.border = '3px solid #e74c3c';
              BeatBoard.showDropZones();
          }
          
          const onMove = (ev) => {
              const dx = (ev.clientX - BeatBoard.draggedCard.startX) / BeatBoard.zoom;
              const dy = (ev.clientY - BeatBoard.draggedCard.startY) / BeatBoard.zoom;
              
              // DÃ©placer toutes les cartes sÃ©lectionnÃ©es
              BeatBoard.draggedCard.originalPositions.forEach(p => {
                  const newX = Math.max(0, p.origX + dx);
                  const newY = Math.max(0, p.origY + dy);
                  if(p.card) {
                      p.card.style.left = newX + 'px';
                      p.card.style.top = newY + 'px';
                  }
                  if(!isReorderMode) {
                      p.scene.beatboardX = newX;
                      p.scene.beatboardY = newY;
                  }
              });
              
              BeatBoard.drawLine();
              BeatBoard.drawTagLines();
              BeatBoard.updateMinimap();
              
              if(isReorderMode) {
                  BeatBoard.highlightDropZone(ev.clientX, ev.clientY);
              }
          };
          
          const onUp = (ev) => {
              // Retirer la classe dragging de toutes les cartes
              BeatBoard.draggedCard.originalPositions.forEach(p => {
                  if(p.card) {
                      p.card.classList.remove('dragging');
                      p.card.style.zIndex = '';
                      p.card.style.boxShadow = '';
                      p.card.style.border = '';
                  }
              });
              
              if(isReorderMode) {
                  const dropResult = BeatBoard.getDropIndex(ev.clientX, ev.clientY);
                  BeatBoard.hideDropZones();
                  
                  // Remettre toutes les fiches Ã  leur position d'origine en mode reorder
                  BeatBoard.draggedCard.originalPositions.forEach(p => {
                      p.scene.beatboardX = p.origX;
                      p.scene.beatboardY = p.origY;
                  });
                  
                  if(dropResult.type === 'remove') {
                      BeatBoard.removeFromTimeline(scene);
                  } else if(dropResult.type === 'insert') {
                      const dropIndex = dropResult.index;
                      if(!isCurrentlyInTimeline || (dropIndex !== sceneIndex && dropIndex !== sceneIndex + 1)) {
                          BeatBoard.reorderScene(sceneIndex, dropIndex, scene);
                      } else {
                          BeatBoard.render();
                      }
                  } else {
                      BeatBoard.render();
                  }
              } else {
                  // Appliquer les nouvelles positions Ã  toutes les cartes
                  BeatBoard.draggedCard.originalPositions.forEach(p => {
                      if(p.card) {
                          p.scene.beatboardX = parseFloat(p.card.style.left);
                          p.scene.beatboardY = parseFloat(p.card.style.top);
                      }
                  });
                  // RÃ©ordonner uniquement si Shift est maintenu au moment du lÃ¢cher
                  if(ev.shiftKey) {
                      BeatBoard.checkReorder();
                  }
              }
              
              BeatBoard.draggedCard = null;
              document.removeEventListener('mousemove', onMove);
              document.removeEventListener('mouseup', onUp);
              Store.save();
          };
          
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
      },
      
      showDropZones: () => {
          const canvas = document.getElementById('beatboardCanvas');
          if(!canvas) return;
          
          // Supprimer les anciennes zones
          canvas.querySelectorAll('.beatboard-dropzone').forEach(z => z.remove());
          
          // Ne considÃ©rer que les scÃ¨nes in timeline
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          const draggedScene = BeatBoard.draggedCard?.scene;
          const draggedIndex = BeatBoard.draggedCard?.sceneIndex;
          const isCurrentlyInTimeline = draggedScene?.inTimeline !== false;
          
          // CrÃ©er une zone avant la premiÃ¨re carte (si on n'est pas la premiÃ¨re)
          if(inTimelineScenes.length > 0 && draggedIndex !== 0) {
              const firstScene = inTimelineScenes[0];
              const zone = BeatBoard.createDropZone(0, firstScene.beatboardX - 50, firstScene.beatboardY);
              canvas.appendChild(zone);
          }
          
          // Si aucune scÃ¨ne in timeline, crÃ©er une zone de dÃ©part
          if(inTimelineScenes.length === 0) {
              const zone = BeatBoard.createDropZone(0, 100, 100);
              canvas.appendChild(zone);
          }
          
          // CrÃ©er une zone aprÃ¨s chaque carte in timeline
          inTimelineScenes.forEach((scene, idx) => {
              // Ne pas crÃ©er de zone autour de la carte qu'on dÃ©place
              if(isCurrentlyInTimeline && (idx === draggedIndex || idx === draggedIndex - 1)) return;
              
              const nextScene = inTimelineScenes[idx + 1];
              let zoneX, zoneY;
              
              if(nextScene) {
                  zoneX = (scene.beatboardX + nextScene.beatboardX + 180) / 2 - 20;
                  zoneY = (scene.beatboardY + nextScene.beatboardY) / 2;
              } else {
                  zoneX = scene.beatboardX + 200;
                  zoneY = scene.beatboardY;
              }
              
              const zone = BeatBoard.createDropZone(idx + 1, zoneX, zoneY);
              canvas.appendChild(zone);
          });
          
          // Ajouter une zone "Retirer du fil rouge" si la scÃ¨ne est in timeline
          if(isCurrentlyInTimeline) {
              const removeZone = document.createElement('div');
              removeZone.className = 'beatboard-dropzone beatboard-dropzone-remove';
              removeZone.dataset.action = 'remove-from-timeline';
              removeZone.style.cssText = `
                  position: absolute;
                  left: 20px;
                  top: 700px;
                  width: 200px;
                  height: 80px;
                  background: rgba(150, 150, 150, 0.3);
                  border: 3px dashed #999;
                  border-radius: 10px;
                  z-index: 500;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 0.85rem;
                  color: var(--text-sec);
                  transition: all 0.2s;
              `;
              removeZone.innerHTML = 'ðŸ“Œ Retirer du fil rouge';
              canvas.appendChild(removeZone);
          }
      },
      
      createDropZone: (insertIndex, x, y) => {
          const zone = document.createElement('div');
          zone.className = 'beatboard-dropzone';
          zone.dataset.insertIndex = insertIndex;
          zone.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              width: 40px;
              height: 100px;
              background: rgba(231, 76, 60, 0.2);
              border: 3px dashed #e74c3c;
              border-radius: 10px;
              z-index: 500;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.5rem;
              color: #e74c3c;
              transition: all 0.2s;
          `;
          zone.innerHTML = 'â†“';
          return zone;
      },
      
      highlightDropZone: (clientX, clientY) => {
          const container = document.getElementById('beatboardContainer');
          const rect = container.getBoundingClientRect();
          const x = (clientX - rect.left - BeatBoard.panX) / BeatBoard.zoom;
          const y = (clientY - rect.top - BeatBoard.panY) / BeatBoard.zoom;
          
          document.querySelectorAll('.beatboard-dropzone').forEach(zone => {
              const zoneX = parseFloat(zone.style.left);
              const zoneY = parseFloat(zone.style.top);
              const zoneW = parseFloat(zone.style.width) || 40;
              const zoneH = parseFloat(zone.style.height) || 100;
              const dist = Math.sqrt(Math.pow(x - zoneX - zoneW/2, 2) + Math.pow(y - zoneY - zoneH/2, 2));
              
              const isRemoveZone = zone.dataset.action === 'remove-from-timeline';
              
              if(dist < 100) {
                  if(isRemoveZone) {
                      zone.style.background = 'rgba(150, 150, 150, 0.6)';
                      zone.style.borderColor = '#666';
                  } else {
                      zone.style.background = 'rgba(231, 76, 60, 0.5)';
                  }
                  zone.style.transform = 'scale(1.1)';
                  zone.style.borderStyle = 'solid';
              } else {
                  if(isRemoveZone) {
                      zone.style.background = 'rgba(150, 150, 150, 0.3)';
                      zone.style.borderColor = '#999';
                  } else {
                      zone.style.background = 'rgba(231, 76, 60, 0.2)';
                  }
                  zone.style.transform = 'scale(1)';
                  zone.style.borderStyle = 'dashed';
              }
          });
      },
      
      getDropIndex: (clientX, clientY) => {
          const container = document.getElementById('beatboardContainer');
          const rect = container.getBoundingClientRect();
          const x = (clientX - rect.left - BeatBoard.panX) / BeatBoard.zoom;
          const y = (clientY - rect.top - BeatBoard.panY) / BeatBoard.zoom;
          
          let closestZone = null;
          let closestDist = Infinity;
          
          document.querySelectorAll('.beatboard-dropzone').forEach(zone => {
              const zoneX = parseFloat(zone.style.left);
              const zoneY = parseFloat(zone.style.top);
              const zoneW = parseFloat(zone.style.width) || 40;
              const zoneH = parseFloat(zone.style.height) || 100;
              const dist = Math.sqrt(Math.pow(x - zoneX - zoneW/2, 2) + Math.pow(y - zoneY - zoneH/2, 2));
              
              if(dist < 120 && dist < closestDist) {
                  closestDist = dist;
                  closestZone = zone;
              }
          });
          
          if(!closestZone) return { type: null };
          
          if(closestZone.dataset.action === 'remove-from-timeline') {
              return { type: 'remove' };
          }
          
          return { type: 'insert', index: parseInt(closestZone.dataset.insertIndex) };
      },
      
      hideDropZones: () => {
          document.querySelectorAll('.beatboard-dropzone').forEach(z => z.remove());
      },
      
      reorderScene: (fromIndex, toIndex, scene) => {
          // RÃ©cupÃ©rer les scÃ¨nes in timeline
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          const wasInTimeline = scene.inTimeline !== false;
          
          if(wasInTimeline && fromIndex !== -1) {
              // Retirer de sa position actuelle dans le tableau global
              // On doit trouver l'index global de cette scÃ¨ne
              const globalIndex = state.data.scenes.findIndex(s => s.id === scene.id);
              if(globalIndex !== -1) {
                  state.data.scenes.splice(globalIndex, 1);
              }
          }
          
          // Marquer comme in timeline
          scene.inTimeline = true;
          
          // Trouver oÃ¹ insÃ©rer dans le tableau global
          // On veut insÃ©rer aprÃ¨s la scÃ¨ne qui est Ã  toIndex-1 dans inTimeline
          if(toIndex === 0) {
              // InsÃ©rer au tout dÃ©but
              state.data.scenes.unshift(scene);
          } else {
              const sceneBeforeInTimeline = inTimelineScenes[toIndex - 1];
              if(sceneBeforeInTimeline) {
                  const globalIndexBefore = state.data.scenes.findIndex(s => s.id === sceneBeforeInTimeline.id);
                  state.data.scenes.splice(globalIndexBefore + 1, 0, scene);
              } else {
                  state.data.scenes.push(scene);
              }
          }
          
          BeatBoard.render();
          Utils.toast(`ScÃ¨ne insÃ©rÃ©e en position ${toIndex + 1}`, 'success');
          UI.renderBoard();
      },
      
      removeFromTimeline: (scene) => {
          scene.inTimeline = false;
          // DÃ©placer visuellement vers la zone hors timeline
          scene.beatboardY = 800 + Math.random() * 50;
          Store.save();
          BeatBoard.render();
          UI.renderBoard();
          Utils.toast('ScÃ¨ne retirÃ©e du fil rouge', 'info');
      },
      
      checkReorder: () => {
          // RÃ©ordonner les scÃ¨nes selon leur position X puis Y
          const cards = Array.from(document.querySelectorAll('.beatboard-card'));
          if(cards.length === 0) return;
          
          const sorted = cards.map(c => ({
              id: c.dataset.id,
              x: parseFloat(c.style.left) || 0,
              y: parseFloat(c.style.top) || 0
          })).sort((a, b) => {
              const rowA = Math.floor(a.y / 140);
              const rowB = Math.floor(b.y / 140);
              if(rowA !== rowB) return rowA - rowB;
              return a.x - b.x;
          });
          
          const newOrder = sorted.map(s => s.id);
          const currentOrder = state.data.scenes.map(s => s.id);
          
          // VÃ©rifier si l'ordre a changÃ©
          if(JSON.stringify(newOrder) !== JSON.stringify(currentOrder)) {
              // CrÃ©er le nouveau tableau en s'assurant que toutes les scÃ¨nes existent
              const reorderedScenes = [];
              for(const id of newOrder) {
                  const scene = state.data.scenes.find(s => s.id === id);
                  if(scene) reorderedScenes.push(scene);
              }
              
              // Ne mettre Ã  jour que si on a toutes les scÃ¨nes
              if(reorderedScenes.length === state.data.scenes.length) {
                  state.data.scenes = reorderedScenes;
                  Utils.toast('Ordre mis Ã  jour', 'success');
                  BeatBoard.render();
                  UI.renderBoard();
              }
          }
      },
      
      drawLine: () => {
          const svg = document.getElementById('beatboardSvg');
          if(!svg) return;
          svg.innerHTML = '';
          
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          
          if(!BeatBoard.showLine || inTimelineScenes.length < 2) return;
          
          const points = inTimelineScenes.map(scene => {
              const card = document.querySelector(`.beatboard-card[data-id="${scene.id}"]`);
              if(!card) return null;
              const left = parseFloat(card.style.left);
              const top = parseFloat(card.style.top);
              const h = card.offsetHeight || 100;
              return {
                  xIn: left - 2,
                  xOut: left + 180 + 2,
                  y: top + h / 2
              };
          }).filter(p => p);
          
          if(points.length < 2) return;
          
          // Dessiner un segment par paire : sortie droite carte N â†’ entrÃ©e gauche carte N+1
          for(let i = 0; i < points.length - 1; i++) {
              const prev = points[i];
              const curr = points[i + 1];
              const mx = (prev.xOut + curr.xIn) / 2;
              const my = (prev.y + curr.y) / 2;
              const segPath = `M ${prev.xOut} ${prev.y} Q ${mx} ${prev.y}, ${mx} ${my} Q ${mx} ${curr.y}, ${curr.xIn} ${curr.y}`;
              
              // Ligne de fond (ombre)
              const bgLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
              bgLine.setAttribute('d', segPath);
              bgLine.setAttribute('class', 'beatboard-line-bg');
              svg.appendChild(bgLine);
              
              // Ligne principale
              const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
              line.setAttribute('d', segPath);
              line.setAttribute('class', 'beatboard-line');
              svg.appendChild(line);
          }
      },
      
      toggleLine: () => {
          BeatBoard.showLine = document.getElementById('beatboard-show-line').checked;
          BeatBoard.drawLine();
      },
      
      toggleTagLines: () => {
          BeatBoard.showTagLines = document.getElementById('beatboard-show-tag-lines').checked;
          if(BeatBoard.showTagLines) {
              // Activer toutes les lignes de tags par dÃ©faut Ã  la premiÃ¨re activation
              const hasAny = Object.keys(BeatBoard.activeTagLines).length > 0;
              if(!hasAny) {
                  state.data.tags.forEach(t => { BeatBoard.activeTagLines[t.id] = true; });
              }
          }
          BeatBoard.drawTagLines();
          BeatBoard.renderTagLinesList();
      },
      
      toggleSingleTagLine: (tagId) => {
          BeatBoard.activeTagLines[tagId] = !BeatBoard.activeTagLines[tagId];
          BeatBoard.drawTagLines();
          BeatBoard.renderTagLinesList();
      },
      
      drawTagLines: () => {
          const svg = document.getElementById('beatboardSvg');
          if(!svg) return;
          
          // Supprimer uniquement les lignes de tags (pas le fil rouge)
          svg.querySelectorAll('.beatboard-tag-line, .beatboard-tag-line-bg, .beatboard-tag-line-dot').forEach(el => el.remove());
          
          if(!BeatBoard.showTagLines) return;
          
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          
          // Pour chaque tag actif, tracer une ligne reliant ses scÃ¨nes dans l'ordre chronologique
          state.data.tags.forEach(tag => {
              if(!BeatBoard.activeTagLines[tag.id]) return;
              if(tag.color === 'transparent') return;
              
              // ScÃ¨nes de ce tag dans l'ordre du sÃ©quencier (= chronologique)
              const tagScenes = inTimelineScenes.filter(s => s.tag_id === tag.id);
              if(tagScenes.length < 2) {
                  // Dessiner quand mÃªme un point si une seule scÃ¨ne
                  if(tagScenes.length === 1) {
                      const card = document.querySelector(`.beatboard-card[data-id="${tagScenes[0].id}"]`);
                      if(card) {
                          const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                          dot.setAttribute('cx', parseFloat(card.style.left) + 180 + 2);
                          dot.setAttribute('cy', parseFloat(card.style.top) + (card.offsetHeight || 100) / 2);
                          dot.setAttribute('r', 5);
                          dot.setAttribute('fill', tag.color);
                          dot.setAttribute('class', 'beatboard-tag-line-dot');
                          svg.appendChild(dot);
                      }
                  }
                  return;
              }
              
              const points = tagScenes.map(scene => {
                  const card = document.querySelector(`.beatboard-card[data-id="${scene.id}"]`);
                  if(!card) return null;
                  const left = parseFloat(card.style.left);
                  const top = parseFloat(card.style.top);
                  const h = card.offsetHeight || 100;
                  return {
                      xIn: left - 2,
                      xOut: left + 180 + 2,
                      y: top + h / 2
                  };
              }).filter(p => p);
              
              if(points.length < 2) return;
              
              // Dessiner un segment par paire : sortie droite â†’ entrÃ©e gauche
              for(let i = 0; i < points.length - 1; i++) {
                  const prev = points[i];
                  const curr = points[i + 1];
                  const mx = (prev.xOut + curr.xIn) / 2;
                  const my = (prev.y + curr.y) / 2;
                  const segPath = `M ${prev.xOut} ${prev.y} Q ${mx} ${prev.y}, ${mx} ${my} Q ${mx} ${curr.y}, ${curr.xIn} ${curr.y}`;
                  
                  // Ligne de fond (ombre colorÃ©e)
                  const bgLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                  bgLine.setAttribute('d', segPath);
                  bgLine.setAttribute('class', 'beatboard-tag-line-bg');
                  bgLine.setAttribute('stroke', tag.color);
                  svg.appendChild(bgLine);
                  
                  // Ligne principale
                  const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                  line.setAttribute('d', segPath);
                  line.setAttribute('class', 'beatboard-tag-line');
                  line.setAttribute('stroke', tag.color);
                  svg.appendChild(line);
              }
              
              // Points aux connecteurs
              points.forEach((p, idx) => {
                  const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                  dot.setAttribute('cx', idx === 0 ? p.xOut : p.xIn);
                  dot.setAttribute('cy', p.y);
                  dot.setAttribute('r', 4);
                  dot.setAttribute('fill', tag.color);
                  dot.setAttribute('class', 'beatboard-tag-line-dot');
                  svg.appendChild(dot);
              });
          });
      },
      
      renderTagLinesList: () => {
          const container = document.getElementById('beatboard-tag-lines-list');
          if(!container) return;
          
          if(!BeatBoard.showTagLines) {
              container.innerHTML = '';
              return;
          }
          
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          
          container.innerHTML = state.data.tags
              .filter(t => t.color !== 'transparent')
              .map(t => {
                  const count = inTimelineScenes.filter(s => s.tag_id === t.id).length;
                  const isActive = BeatBoard.activeTagLines[t.id] !== false;
                  return `
                      <div class="beatboard-tag-line-item" onclick="app.BeatBoard.toggleSingleTagLine('${t.id}')" style="opacity: ${isActive ? '1' : '0.4'}">
                          <input type="checkbox" ${isActive ? 'checked' : ''} onclick="event.stopPropagation(); app.BeatBoard.toggleSingleTagLine('${t.id}')" style="cursor:pointer;">
                          <span class="beatboard-tag-line-swatch" style="background: ${t.color}"></span>
                          <span>${Utils.escape(t.name)}</span>
                          <span class="beatboard-tag-line-count">${count} scÃ¨ne${count > 1 ? 's' : ''}</span>
                      </div>
                  `;
              }).join('');
      },
      
      autoLayout: (type) => {
          const scenes = state.data.scenes;
          const cardW = 200, cardH = 140, gap = 30;
          
          if(type === 'horizontal') {
              scenes.forEach((s, i) => {
                  s.beatboardX = 50 + i * (cardW + gap);
                  s.beatboardY = 100;
              });
          } else if(type === 'grid') {
              const cols = Math.ceil(Math.sqrt(scenes.length));
              scenes.forEach((s, i) => {
                  s.beatboardX = 50 + (i % cols) * (cardW + gap);
                  s.beatboardY = 50 + Math.floor(i / cols) * (cardH + gap);
              });
          } else if(type === 'byTag') {
              const tagGroups = {};
              scenes.forEach(s => {
                  const tid = s.tag_id || 't1';
                  if(!tagGroups[tid]) tagGroups[tid] = [];
                  tagGroups[tid].push(s);
              });
              let row = 0;
              Object.keys(tagGroups).forEach(tid => {
                  tagGroups[tid].forEach((s, i) => {
                      s.beatboardX = 50 + i * (cardW + gap);
                      s.beatboardY = 50 + row * (cardH + gap + 50);
                  });
                  row++;
              });
          }
          
          Store.save();
          BeatBoard.render();
          Utils.toast('Disposition appliquÃ©e', 'success');
      },
      
      renderTagList: () => {
          const container = document.getElementById('beatboard-tag-list');
          if(!container) return;
          
          const usedTags = [...new Set(state.data.scenes.map(s => s.tag_id || 't1'))];
          container.innerHTML = state.data.tags
              .filter(t => usedTags.includes(t.id))
              .map(t => `
                  <div class="beatboard-group-label">
                      <span class="beatboard-group-dot" style="background: ${t.color !== 'transparent' ? t.color : 'var(--text-sec)'}"></span>
                      ${Utils.escape(t.name)} (${state.data.scenes.filter(s => (s.tag_id || 't1') === t.id).length})
                  </div>
              `).join('');
      },
      
      initPan: () => {
          const container = document.getElementById('beatboardContainer');
          const canvas = document.getElementById('beatboardCanvas');
          if(!container || !canvas) return;
          
          container.onmousedown = (e) => {
              if(e.target.closest('.beatboard-card')) return;
              BeatBoard.isPanning = true;
              BeatBoard.panStartX = e.clientX - BeatBoard.panX;
              BeatBoard.panStartY = e.clientY - BeatBoard.panY;
              canvas.classList.add('dragging');
          };
          
          container.onmousemove = (e) => {
              if(!BeatBoard.isPanning) return;
              BeatBoard.panX = e.clientX - BeatBoard.panStartX;
              BeatBoard.panY = e.clientY - BeatBoard.panStartY;
              BeatBoard.applyTransform();
          };
          
          container.onmouseup = () => {
              BeatBoard.isPanning = false;
              canvas.classList.remove('dragging');
          };
          
          container.onmouseleave = () => {
              BeatBoard.isPanning = false;
              canvas.classList.remove('dragging');
          };
          
          container.onwheel = (e) => {
              e.preventDefault();
              const delta = e.deltaY > 0 ? -0.1 : 0.1;
              BeatBoard.zoom = Math.max(0.3, Math.min(2, BeatBoard.zoom + delta));
              BeatBoard.applyTransform();
              document.getElementById('beatboardZoomLevel').textContent = Math.round(BeatBoard.zoom * 100) + '%';
          };
      },
      
      applyTransform: () => {
          const canvas = document.getElementById('beatboardCanvas');
          if(canvas) {
              canvas.style.transform = `translate(${BeatBoard.panX}px, ${BeatBoard.panY}px) scale(${BeatBoard.zoom})`;
          }
          BeatBoard.updateMinimap();
      },
      
      zoomIn: () => {
          BeatBoard.zoom = Math.min(2, BeatBoard.zoom + 0.1);
          BeatBoard.applyTransform();
          document.getElementById('beatboardZoomLevel').textContent = Math.round(BeatBoard.zoom * 100) + '%';
      },
      
      zoomOut: () => {
          BeatBoard.zoom = Math.max(0.3, BeatBoard.zoom - 0.1);
          BeatBoard.applyTransform();
          document.getElementById('beatboardZoomLevel').textContent = Math.round(BeatBoard.zoom * 100) + '%';
      },
      
      zoomReset: () => {
          BeatBoard.zoom = 1;
          BeatBoard.panX = 0;
          BeatBoard.panY = 0;
          BeatBoard.applyTransform();
          document.getElementById('beatboardZoomLevel').textContent = '100%';
      },
      
      fitToView: () => {
          const container = document.getElementById('beatboardContainer');
          if(!container || state.data.scenes.length === 0) return;
          
          const bounds = state.data.scenes.reduce((acc, s) => ({
              minX: Math.min(acc.minX, s.beatboardX || 0),
              maxX: Math.max(acc.maxX, (s.beatboardX || 0) + 180),
              minY: Math.min(acc.minY, s.beatboardY || 0),
              maxY: Math.max(acc.maxY, (s.beatboardY || 0) + 100)
          }), { minX: Infinity, maxX: 0, minY: Infinity, maxY: 0 });
          
          const contentW = bounds.maxX - bounds.minX + 100;
          const contentH = bounds.maxY - bounds.minY + 100;
          const containerW = container.clientWidth;
          const containerH = container.clientHeight;
          
          BeatBoard.zoom = Math.min(containerW / contentW, containerH / contentH, 1);
          BeatBoard.panX = -bounds.minX * BeatBoard.zoom + 20;
          BeatBoard.panY = -bounds.minY * BeatBoard.zoom + 20;
          BeatBoard.applyTransform();
          document.getElementById('beatboardZoomLevel').textContent = Math.round(BeatBoard.zoom * 100) + '%';
      },
      
      updateMinimap: () => {
          const minimap = document.getElementById('beatboardMinimap');
          const viewport = document.getElementById('beatboardMinimapViewport');
          const container = document.getElementById('beatboardContainer');
          if(!minimap || !viewport || !container) return;
          
          const scale = 0.05;
          const containerW = container.clientWidth;
          const containerH = container.clientHeight;
          
          viewport.style.width = (containerW * scale / BeatBoard.zoom) + 'px';
          viewport.style.height = (containerH * scale / BeatBoard.zoom) + 'px';
          viewport.style.left = (-BeatBoard.panX * scale / BeatBoard.zoom) + 'px';
          viewport.style.top = (-BeatBoard.panY * scale / BeatBoard.zoom) + 'px';
      }
  };

  // ==================== MODULE LANDING ====================
  const Landing = {
      show: () => {
          document.getElementById('landing-view').style.display = 'flex';
          document.getElementById('auth-view').style.display = 'none';
      },
      
      hide: () => {
          document.getElementById('landing-view').style.display = 'none';
      },
      
      showAuth: (mode) => {
          Landing.hide();
          document.getElementById('auth-view').style.display = 'flex';
          if(mode === 'signup') {
              Auth.toggleMode('signup');
          } else {
              Auth.toggleMode('login');
          }
      }
  };

  // ==================== MODULE TERMS ====================
  const Terms = {
      show: () => {
          document.getElementById('terms-modal').style.display = 'flex';
          document.getElementById('terms-checkbox').checked = false;
          document.getElementById('terms-accept-btn').classList.remove('enabled');
      },
      
      hide: () => {
          document.getElementById('terms-modal').style.display = 'none';
      },
      
      toggleCheckbox: () => {
          const checkbox = document.getElementById('terms-checkbox');
          checkbox.checked = !checkbox.checked;
          const btn = document.getElementById('terms-accept-btn');
          if(checkbox.checked) {
              btn.classList.add('enabled');
          } else {
              btn.classList.remove('enabled');
          }
      },
      
      accept: async () => {
          const checkbox = document.getElementById('terms-checkbox');
          if(!checkbox.checked) return;
          
          try {
              // Enregistrer l'acceptation en base
              const { error } = await supabase
                  .from('user_profiles')
                  .update({ terms_accepted: true, terms_accepted_at: new Date().toISOString() })
                  .eq('email', state.currentUser?.email?.toLowerCase());
              
              if(error) throw error;
              
              // Mettre Ã  jour le state local
              if(state.userProfile) state.userProfile.terms_accepted = true;
              
              Terms.hide();
              // Continuer vers le dashboard
              UI.showDashboard();
          } catch(e) {
              console.error('Erreur acceptation conditions:', e);
              alert('Une erreur est survenue. Veuillez rÃ©essayer.');
          }
      },
      
      refuse: async () => {
          // DÃ©connecter l'utilisateur
          await supabase.auth.signOut();
          Terms.hide();
          alert('Vous devez accepter les conditions pour utiliser Moteur.');
      },
      
      check: async () => {
          // VÃ©rifier si l'utilisateur a dÃ©jÃ  acceptÃ©
          if(state.userProfile && state.userProfile.terms_accepted) {
              return true;
          }
          return false;
      }
  };

  return { Store, UI, Actions, Breakdown, ScriptEditor, ScriptImport, ScriptExport, Auth, Stats, Exporter, Importer, MoodBoard, Storyboard, DrawingEditor, Crew, Planning, Contacts, ActorSearch, PublicProfile, GlobalSearch, Permissions, Chat, Messages, Invitations, Universe, Expenses, Utils, Presentation, PresentMode, History, Notifications, Contracts, StoryboardPreview, Comments, Courses, CardModal, Synopsis, TitlePage, SceneVersions, MatchingEngine, SessionManager, Pricing, Resources, ScriptReport, Weather, ColorWheel, BeatBoard, FocusMode, Forum, Feed, Editor, Icons, Admin, Tutorial, Hub, Landing, Terms, PreferencesSync };
})();
</script>

<!-- Panneau Storyboard Preview -->
<div id="storyboard-preview-panel" class="storyboard-preview-panel">
    <div class="storyboard-preview-header">
        <h3>ðŸ“· <span id="storyboard-preview-title">Storyboard</span></h3>
        <button class="storyboard-preview-close" onclick="app.StoryboardPreview.close()">âœ•</button>
    </div>
    <div class="storyboard-preview-body" id="storyboard-preview-list">
        <div class="storyboard-preview-empty">Aucun plan pour cette scÃ¨ne</div>
    </div>
</div>

<!-- Panneau Commentaires -->
<div id="comments-panel" class="comments-panel">
    <div class="comments-header">
        <h3>ðŸ’¬ <span id="comments-scene-title">Commentaires</span></h3>
        <button class="comments-close" onclick="app.Comments.close()">âœ•</button>
    </div>
    <div class="comments-body" id="comments-list">
        <div class="no-comments">Aucun commentaire pour cette scÃ¨ne</div>
    </div>
    <div class="comments-footer">
        <textarea id="comment-input" class="comment-input" rows="3" placeholder="Ajouter un commentaire..."></textarea>
        <button class="comment-submit" onclick="app.Comments.add()">ðŸ’¬ Envoyer</button>
    </div>
</div>

<!-- Modal Page de Titre ScÃ©nario -->
<div id="title-page-modal" class="modal-overlay d-none">
  <div class="modal-content" style="max-width:600px; background: var(--panel-bg);">
    <div class="modal-header">
      <h2>ðŸ“ Page de titre du scÃ©nario</h2>
      <button onclick="app.ScriptExport.closeTitlePageModal()" class="modal-close">âœ–</button>
    </div>
    <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
      <p class="text-sec-mb20">Ces informations apparaÃ®tront sur la page de titre lors de l'export Fountain ou Final Draft.</p>
      
      <div style="display: grid; gap: 15px;">
        <div>
          <label class="label-bold">Titre du scÃ©nario</label>
          <input type="text" id="script-meta-title" class="form-input" placeholder="Titre du film">
        </div>
        
        <div class="grid-2col">
          <div>
            <label class="label-bold">Auteur</label>
            <input type="text" id="script-meta-author" class="form-input" placeholder="PrÃ©nom Nom">
          </div>
          <div>
            <label class="label-bold">Co-auteur (optionnel)</label>
            <input type="text" id="script-meta-coauthor" class="form-input" placeholder="PrÃ©nom Nom">
          </div>
        </div>
        
        <div>
          <label class="label-bold">Contact (email ou tÃ©lÃ©phone)</label>
          <input type="text" id="script-meta-contact" class="form-input" placeholder="email@exemple.com">
        </div>
        
        <div class="grid-2col">
          <div>
            <label class="label-bold">Version / Draft</label>
            <select id="script-meta-draft" class="form-input">
              <option value="Premier jet">Premier jet</option>
              <option value="DeuxiÃ¨me jet">DeuxiÃ¨me jet</option>
              <option value="TroisiÃ¨me jet">TroisiÃ¨me jet</option>
              <option value="Version de tournage">Version de tournage</option>
              <option value="Version finale">Version finale</option>
            </select>
          </div>
          <div>
            <label class="label-bold">Date</label>
            <input type="date" id="script-meta-date" class="form-input">
          </div>
        </div>
        
        <div>
          <label class="label-bold">BasÃ© sur (optionnel)</label>
          <input type="text" id="script-meta-source" class="form-input" placeholder="Ex: le roman de Victor Hugo">
        </div>
        
        <div>
          <label class="label-bold">Copyright (optionnel)</label>
          <input type="text" id="script-meta-copyright" class="form-input" placeholder="Â© 2026 Nom ou SociÃ©tÃ©">
        </div>
        
        <div>
          <label class="label-bold">Notes (optionnel)</label>
          <textarea id="script-meta-notes" rows="3" class="n8-input-6" placeholder="Notes supplÃ©mentaires..."></textarea>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border);">
        <button onclick="app.ScriptExport.closeTitlePageModal()" class="btn-outline-r6">Annuler</button>
        <button onclick="app.ScriptExport.saveTitlePage()" style="padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">ðŸ’¾ Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ã©dition fiche compacte -->
<div id="card-edit-modal" class="card-edit-modal">
    <div class="card-edit-modal-content">
        <div class="card-edit-modal-header">
            <h3 id="card-edit-modal-title">ðŸ“ Ã‰diter</h3>
            <button class="card-edit-modal-close" onclick="app.CardModal.close()">âœ•</button>
        </div>
        <div class="card-edit-modal-body" id="card-edit-modal-body">
            <!-- Contenu dynamique -->
        </div>
        <div class="card-edit-modal-footer">
            <button onclick="app.CardModal.close()" class="btn-outline-r6">Fermer</button>
        </div>
    </div>
</div>

<!-- Modal Conditions d'utilisation -->
<div id="terms-modal" class="terms-modal-overlay d-none">
  <div class="terms-modal">
    <div class="terms-modal-header">
      <h2>ðŸ“œ Conditions d'utilisation</h2>
    </div>
    <div class="terms-modal-body">
      <p><strong>Bienvenue sur Moteur !</strong> Avant de continuer, merci de prendre connaissance des conditions suivantes :</p>
      
      <h3>ðŸ”’ ConfidentialitÃ© des donnÃ©es</h3>
      <p>Moteur est actuellement en phase <strong>prÃ©-alpha</strong>. En utilisant cette plateforme, vous acceptez que :</p>
      <ul>
        <li>Vos donnÃ©es personnelles (email, nom, profils) sont stockÃ©es de maniÃ¨re sÃ©curisÃ©e sur nos serveurs europÃ©ens (conformitÃ© RGPD).</li>
        <li>Vos projets et contenus crÃ©atifs restent votre propriÃ©tÃ© exclusive.</li>
        <li>Nous pouvons collecter des donnÃ©es d'usage anonymisÃ©es pour amÃ©liorer le service.</li>
        <li>En phase prÃ©-alpha, des bugs peuvent survenir et des donnÃ©es pourraient Ãªtre perdues. Nous vous conseillons de conserver des sauvegardes externes de vos travaux importants.</li>
        <li>Vous pouvez demander la suppression de votre compte et de vos donnÃ©es Ã  tout moment.</li>
      </ul>
      
      <h3>âš–ï¸ PropriÃ©tÃ© intellectuelle & Non-concurrence</h3>
      <p>En accÃ©dant Ã  Moteur, vous vous engagez Ã  :</p>
      <ul>
        <li>Ne pas copier, reproduire ou imiter les fonctionnalitÃ©s, le design ou le concept de Moteur sur un autre site ou application.</li>
        <li>Ne pas utiliser les informations techniques ou fonctionnelles dÃ©couvertes sur Moteur pour dÃ©velopper un service concurrent.</li>
        <li>Respecter la propriÃ©tÃ© intellectuelle de Moteur et de ses crÃ©ateurs.</li>
        <li>Ne pas partager vos identifiants de connexion avec des tiers.</li>
      </ul>
      
      <h3>âœ… Utilisation acceptable</h3>
      <ul>
        <li>Vous vous engagez Ã  utiliser Moteur de maniÃ¨re lÃ©gale et Ã©thique.</li>
        <li>Tout contenu illÃ©gal, diffamatoire ou portant atteinte aux droits d'autrui est interdit.</li>
        <li>Nous nous rÃ©servons le droit de suspendre tout compte en cas de non-respect de ces conditions.</li>
      </ul>
    </div>
    <div class="terms-modal-footer">
      <div class="terms-checkbox-row" onclick="app.Terms.toggleCheckbox()">
        <input type="checkbox" id="terms-checkbox">
        <label for="terms-checkbox">J'ai lu et j'accepte les conditions d'utilisation, la politique de confidentialitÃ© et la clause de non-concurrence.</label>
      </div>
      <div class="terms-buttons">
        <button class="terms-btn terms-btn-refuse" onclick="app.Terms.refuse()">Refuser</button>
        <button class="terms-btn terms-btn-accept" id="terms-accept-btn" onclick="app.Terms.accept()">Accepter et continuer</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>