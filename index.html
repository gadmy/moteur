<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
</head>
<!--
================================================================================
                          MOTEUR - CHANGELOG
         "Mais o√π est-ce qu'il est ce con de perchman ?"
================================================================================

M√âTHODE DE TRAVAIL
==================

Ce projet est d√©velopp√© en collaboration avec Claude (Anthropic).
√Ä chaque nouvelle conversation :

1. Uploader le fichier HTML actuel
2. Demander √† Claude √† quelle version on en est
3. Expliquer la fonctionnalit√© ou correction souhait√©e
4. Claude indique "CHERCHE/REMPLACE" pour chaque modification
5. Appliquer les modifications √©tape par √©tape (copier-coller)
6. Tester dans le navigateur apr√®s chaque changement
7. Le changement de version est d√©cid√© par le d√©veloppeur uniquement
8. Mettre √† jour l'historique r√©guli√®rement

================================================================================
                         HISTORIQUE DES VERSIONS
================================================================================

V1.9.9.4 - Beat Board & Mode Focus (Jan. 2025)
  ‚Ä¢ Nouveau mode Beat Board dans le S√©quencier
    - Basculer entre vue S√©quencier classique et vue Beat Board
    - Fiches de sc√®nes d√©pla√ßables librement sur le canvas
    - Fil rouge connectant les sc√®nes dans l'ordre du s√©quencier
  ‚Ä¢ Outils Beat Board
    - Zoom (molette ou boutons +/-), pan (clic droit + glisser)
    - Bouton "Recentrer" pour revenir √† la vue d'ensemble
    - L√©gende des groupes de couleur visible
  ‚Ä¢ Interactions avanc√©es
    - Drag & drop normal : d√©place visuellement la fiche
    - Shift + drag : mode snap, ins√®re dans le fil rouge
    - Ctrl + clic : s√©lection multiple (outline bleu)
    - Drag multi-s√©lection : d√©place toutes les fiches s√©lectionn√©es ensemble
    - Zone "Retirer du fil rouge" pour sortir une sc√®ne du fil
  ‚Ä¢ Sc√®nes hors timeline
    - Cr√©ation de sc√®nes non ordonn√©es (bouton "Nouvelle sc√®ne")
    - Style en pointill√©s + opacit√© r√©duite + ic√¥ne üìå
    - Shift + drag vers une zone d'insertion pour rejoindre le fil
  ‚Ä¢ Synchronisation bidirectionnelle
    - L'ordre du fil rouge = l'ordre du s√©quencier
    - Modifications r√©percut√©es dans les deux vues
  ‚Ä¢ Mode Focus (plein √©cran onglet)
    - Masque la navigation pour se concentrer sur le contenu
    - Barre d'outils minimaliste avec navigation ‚óÄ ‚ñ∂
    - Raccourcis : F11 (activer), √âchap (quitter), ‚Üê ‚Üí (naviguer)
    - Accessible via menu üìê ou touche F11
  ‚Ä¢ Guide d'aide enrichi
    - Nouvelles sections : Synopsis, Page de Titre, MoodBoard, Chat, Rapport de Script
    - Matching intelligent document√© dans Univers
    - Mode Focus document√©

V1.9.9.3 - Navigation Sc√©nario Optimis√©e (Jan. 2025)
  ‚Ä¢ Raccourcis clavier directs pour types de paragraphes
    - Ctrl/Alt+1 = Action, Ctrl/Alt+2 = Personnage, Ctrl/Alt+3 = Dialogue
    - Ctrl/Alt+4 = Didascalie, Ctrl/Alt+5 = Transition, Ctrl/Alt+6 = Centr√©, Ctrl/Alt+7 = Note
    - Fonctionne dans l'√©diteur sc√®ne par sc√®ne ET continu
  ‚Ä¢ Tab contextuel intelligent (toggle)
    - Action ‚Üî Personnage
    - Dialogue ‚Üî Didascalie
    - Transition/Centr√©/Note ‚Üí Action
  ‚Ä¢ Shift+Tab pour cycle inverse
  ‚Ä¢ Correction perte de focus en Vue Script (re-render Firebase optimis√©)
  ‚Ä¢ Didascalie/Note : fermeture propre des parenth√®ses/accolades sur Entr√©e
  ‚Ä¢ Documentation mise √† jour dans l'aide

V1.9.9.2 - Contrats Conformes & Acc√®s Direct (Jan. 2025)
  ‚Ä¢ Nouvelle section "Informations L√©gales" dans Pr√©sentation
    - SIRET, Code APE/NAF, N¬∞ Licence entrepreneur spectacle
    - URSSAF de rattachement, N¬∞ Cong√©s Spectacles employeur
    - Adresse compl√®te, Email RGPD, Qualit√© du repr√©sentant
    - Pr√©-remplissage automatique dans tous les contrats
  ‚Ä¢ Bouton "üìù Contrat" sur les fiches
    - Acc√®s direct depuis chaque fiche Com√©dien (onglet Casting)
    - Acc√®s direct depuis chaque fiche Technicien (onglet √âquipe)
    - Pr√©-s√©lection automatique de la personne
  ‚Ä¢ Nouveau type : Accord B√©n√©vole ‚ù§Ô∏è
    - Engagement moral pour collaborations non r√©mun√©r√©es
    - D√©fraiements (repas, transport, h√©bergement)
    - Engagements mutuels (respect, bienveillance, s√©curit√©)
    - Cr√©dits au g√©n√©rique (choix d'appara√Ætre ou non)
    - Cession gracieuse des droits pour le projet
    - Esprit de l'accord (confiance, aventure humaine)
  ‚Ä¢ CDDU (Intermittent¬∑e¬∑s) - Mentions l√©gales compl√®tes
    - Pr√©ambule avec motif de recours obligatoire (art. D.1242-1)
    - Mention DPAE (D√©claration Pr√©alable √† l'Embauche)
    - Code APE, N¬∞ Licence entrepreneur spectacle
    - Date/lieu naissance, nationalit√© du salari√©
    - N¬∞ d'objet P√¥le emploi spectacle
    - Article abattement frais professionnels (avec choix)
    - Article fin de contrat (documents √† remettre)
    - Article juridiction comp√©tente
    - N¬∞ affiliation Cong√©s Spectacles employeur
  ‚Ä¢ Droit √† l'image - Refonte compl√®te conforme RGPD
    - Articles 9 Code civil et 226-1 Code p√©nal cit√©s
    - Gestion des mineurs (case repr√©sentant l√©gal)
    - Date/lieu naissance, nationalit√©, email, t√©l√©phone
    - Supports d'exploitation d√©taill√©s (cases √† cocher)
    - √âtendue territoriale explicite
    - Engagements du b√©n√©ficiaire (dignit√©, honneur)
    - Clause RGPD compl√®te (droits d'acc√®s, rectification...)
    - D√©clarations du signataire (consentement √©clair√©)
    - Mention manuscrite ¬´ Lu et approuv√© ¬ª
  ‚Ä¢ Contrat de Prestation (Auto-entrepreneur) enrichi
    - Cla

V1.9.9.1 - Rapport de Script (Jan. 2025)
  ‚Ä¢ Nouvel onglet "Rapport" dans Production
    - Fiche de script par plan (navigation sc√®ne/plan √† gauche)
    - Auto-remplissage : film, d√©cor, date, effet (jour/nuit, int/ext)
    - Auto-remplissage : cam√©ra, objectif depuis l'√©quipe et storyboard
    - Extraction automatique des dialogues depuis le sc√©nario
  ‚Ä¢ Gestion des prises
    - Num√©ro de prise, N¬∞ Son, N¬∞ Image
    - Qualit√© Son/Image/Acting avec notation 1-5 √©toiles
    - Notes libres par prise
    - √âtoiles Or ‚òÖ et Argent ‚òÜ pour marquer les meilleures prises
  ‚Ä¢ Champs de la fiche
    - SON (Sonore/Muet), Supports de sauvegarde
    - NOTE libre, Description du plan, Dialogues
  ‚Ä¢ Export PDF professionnel
    - Mise en page soign√©e avec en-t√™te noir
    - √âtoiles graphiques color√©es (or/argent) dans le PDF
    - Export individuel ou export de toutes les fiches
  ‚Ä¢ Planning : Feuilles de service
    - Acteurs group√©s par type (Casting Principal, R√¥les Secondaires, Figurants)
    - M√™me logique de groupement que l'√©quipe technique

V1.9.9 - Corrections Exports (Jan. 2025)
  ‚Ä¢ MoodBoard : Export PNG/PDF corrig√©
    - Toutes les formes SVG (30+) s'exportent correctement
    - √âtoiles, fl√®ches, bulles, symboles export√©s fid√®lement
    - Conversion SVG ‚Üí image pour rendu pr√©cis
  ‚Ä¢ Noms de fichiers explicites
    - MoodBoard : "NomProjet_MoodBoard_NomPlanche.pdf/png"
    - Storyboard : "NomProjet_Storyboard.pdf"
  ‚Ä¢ Storyboard PDF complet
    - Nom du plan affich√© (entre guillemets)
    - Mode cam√©ra (Objectif, Subjectif, Semi-subjectif, PDV)
    - Direction acteurs (üé≠) et technique (‚öôÔ∏è) incluses
  ‚Ä¢ Export ZIP enrichi
    - Dossier PDF/ avec tous les documents pr√™ts √† imprimer
    - Dossier CSV/ avec fichiers tableur
    - Sc√©nario, S√©quencier, Casting, √âquipe, D√©cors, Budget, Planning
    - README structur√© avec instructions de r√©import
  ‚Ä¢ 11 th√®mes visuels disponibles
    - üé¨ Classique (d√©faut, sobre et professionnel)
    - ‚ú® Glassmorphism (transparent, flou, d√©grad√© violet)
    - ü´ß Neumorphism (effet soft extrud√©, ombres douces)
    - üé• Dark Cinema (noir + or, style Hollywood)
    - üíú Cyberpunk (n√©on cyan/magenta, monospace)
    - üåø Nature (verts apaisants, organique)
    - üåÖ Sunset (d√©grad√© orange/rose chaleureux)
    - üåä Oc√©an (bleus profonds, apaisant)
    - üíê Lavande (violets doux, arrondi √©l√©gant)
    - ‚¨ú Minimal (√©pur√© noir/blanc, sobre)
    - üíª Terminal (hacker r√©tro, vert sur noir)
  ‚Ä¢ S√©lecteur de design dans le header (bouton üé® Design)
  ‚Ä¢ Sauvegarde automatique du choix utilisateur
  ‚Ä¢ Compatible avec le mode clair/sombre (üåì)
  ‚Ä¢ Corrections de bugs critiques
    - Fermeture manquante des objets Exporter/Expenses
    - Suppression de code markdown accidentel

V1.9.8 - Exports Professionnels (Jan. 2025)
  ‚Ä¢ Nouveaux exports PDF d√©di√©s
    - üìã Rapport de production complet (stats, √©quipe, budget, planning)
    - üìã D√©pouillement PDF avec r√©capitulatif global par cat√©gorie
    - üé® Storyboard PDF (grille 2x2, paysage A4)
    - üë• √âquipe PDF par d√©partement avec coordonn√©es
  ‚Ä¢ Export ZIP complet du projet restructur√©
    - üìÅ PDF/ : Sc√©nario, S√©quencier, Casting, √âquipe, D√©cors, Budget, Planning
    - üìÅ CSV/ : Tous les fichiers tableur
    - projet_data.json : Pour r√©import dans Moteur
    - scenario.fountain : Format universel
    - README.md : Documentation structur√©e avec instructions
  ‚Ä¢ MoodBoard exports corrig√©s
    - Toutes les formes SVG (30+) s'exportent correctement en PNG/PDF
    - √âtoiles, fl√®ches, bulles, symboles rendus fid√®lement
    - Conversion SVG ‚Üí Canvas ‚Üí Image pour rendu pr√©cis
  ‚Ä¢ Storyboard PDF enrichi
    - Nom du plan affich√© entre guillemets
    - Mode cam√©ra (OBJ, SUBJ, SEMI, PDV)
    - Direction acteurs üé≠ et technique ‚öôÔ∏è incluses
    - Zone image r√©duite (55%) pour plus d'espace texte
  ‚Ä¢ Noms de fichiers explicites
    - MoodBoard : "Projet_MoodBoard_Planche.pdf/png"
    - Storyboard : "Projet_Storyboard.pdf"
  ‚Ä¢ Menu Export enrichi
    - Nouvelle section "Projet complet"
    - Organisation par cat√©gories (Sc√©nario, Budget, Projet)

V1.9.7 - MoodBoard Pro : Roue Chromatique & Formes (Jan. 2025)
  ‚Ä¢ G√©n√©rateur de palettes avec roue chromatique interactive
    - Style Adobe Color avec 8 types d'harmonies
    - Semblable, Nuances, Compl√©mentaire, Triade, Carr√©, etc.
    - Contr√¥le de la saturation (centre/ext√©rieur) et luminosit√©
    - 5 couleurs g√©n√©r√©es avec codes hex copiables
  ‚Ä¢ Biblioth√®que de 30+ formes g√©om√©triques
    - Formes de base : rectangle, cercle, ellipse, triangle, losange
    - Polygones : pentagone, hexagone, octogone, √©toiles
    - Fl√®ches : droite, gauche, haut, bas, double, chevrons
    - Bulles : parole, ronde, pens√©e
    - Symboles : c≈ìur, croix, check, X, plus, moins
    - Cadres vides : rectangle, arrondi, cercle
  ‚Ä¢ Rotation des √©l√©ments
    - Handle de rotation au survol (cercle bleu ‚Üª)
    - Drag pour tourner librement
    - Maintenir Shift pour snap √† 15¬∞
  ‚Ä¢ Personnalisation des formes
    - Couleur noire par d√©faut
    - Clic droit ‚Üí üé® Couleur pour modifier
    - Palette de 12 couleurs rapides + s√©lecteur complet
  ‚Ä¢ Palettes am√©lior√©es
    - Affichage clair avec codes hex lisibles
    - Taille par d√©faut 500x200px
    - Clic droit ‚Üí ‚úèÔ∏è Renommer la palette
  ‚Ä¢ Formats de canvas fonctionnels
    - A4, A3, A2, A0 en portrait et paysage
    - Toast de confirmation au changement
  ‚Ä¢ UX am√©lior√©e
    - Menu des formes repositionn√© automatiquement
    - Reste toujours visible dans la fen√™tre
    - Scrollable si beaucoup de formes

V1.9.6 - M√©t√©o, Cartes & Feuilles de Service Pro (Jan. 2025)
  ‚Ä¢ M√©t√©o automatique dans les feuilles de service
    - Int√©gration Open-Meteo API (100% gratuit, sans cl√© API)
    - Temp√©rature, ressenti, conditions m√©t√©o
    - Probabilit√© de pluie, vent, lever/coucher soleil
    - Champ "M√©t√©o personnalis√©e / Consignes" pour instructions sp√©ciales
  ‚Ä¢ Carte interactive Leaflet/OSM du lieu de tournage
  ‚Ä¢ Lien Google Maps pour la navigation GPS
    - Bouton cliquable dans la feuille de service
    - URL en texte visible lors de l'impression PDF
  ‚Ä¢ Feuille de Service compl√®te et professionnelle
    - Programme du jour avec sc√®nes ET plans s√©lectionn√©s
    - D√©pouillement avec responsable par d√©partement (ex: "COSTUMES (Sarah)")
    - Contact sur place + t√©l√©phone + notes d'acc√®s
    - Transport avec d√©tail "avec qui" pour covoiturage
    - Notes g√©n√©rales et champs vides affich√©s avec mention "Vide"
    - Ordre des sections harmonis√© avec la modal de cr√©ation
  ‚Ä¢ Export PDF am√©lior√©
    - Nom du fichier = "Projet - FDS NomTournage - Date"
    - Mise en page optimis√©e pour impression
  ‚Ä¢ Synchronisation bidirectionnelle du transport
    - Si Lila "Am√®ne" Sarah ‚Üí Sarah passe auto en "Part avec" Lila
    - Mise √† jour instantan√©e des deux c√¥t√©s
  ‚Ä¢ Recalcul automatique √† la suppression de sc√®ne
    - Com√©diens non n√©cessaires d√©coch√©s automatiquement
    - Techniciens du d√©pouillement mis √† jour
    - Transports "avec qui" nettoy√©s si personne retir√©e
    - Aper√ßu d√©pouillement rafra√Æchi en temps r√©el
  ‚Ä¢ Corrections
    - Fix bug sauvegarde (null check sur √©l√©ments supprim√©s)
    - Fix parsing des IDs avec underscore (actor_act_xxx)
    - Fix generateFDS (startDate au lieu de date)

V1.9.5 - Ressources & Liaisons Visuelles (Jan. 2025)
  ‚Ä¢ R√©organisation des onglets
    - Vue Cat√©gories : Personnages, Com√©diens, D√©cors, Ressources
    - Vue Classique : 7. Com√©diens, 8. D√©cors, 9. Ressources
  ‚Ä¢ Liaison visuelle dans le D√©pouillement
    - Survol mot surlign√© ‚Üî tag : les deux s'allument en jaune
    - Fl√®che SVG courbe reliant texte et d√©pouillement
    - Fonctionne aussi pour DECORS-LIEUX dans le titre
  ‚Ä¢ Nouvel onglet Ressources (Accessoires, Costumes, V√©hicules)
    - Filtres par cat√©gorie (Tous, Accessoires, Costumes, V√©hicules)
    - Fiches avec photo, description, propri√©taire, note, sc√®nes li√©es
    - Propri√©taire : com√©dien/technicien du projet OU saisie manuelle (location)
    - Cr√©ation automatique depuis le d√©pouillement
    - Suppression li√©e (demande confirmation d√©pouillement ‚Üî ressource)
    - Fusion de fiches similaires (garde la plus compl√®te)
  ‚Ä¢ Drag & drop des sous-onglets en vue Cat√©gories
    - R√©ordonner les sous-onglets par glisser-d√©poser
    - D√©placer un sous-onglet vers une autre cat√©gorie
    - Ordre sauvegard√© par projet
    - Bouton R√©initialiser remet ordre ET couleurs par d√©faut
  ‚Ä¢ Syst√®me Brouillon / Finale pour les sc√®nes
    - Sc√®ne en brouillon (üìù) : texte modifiable, d√©pouillement bloqu√©
    - Sc√®ne finale (‚úÖ) : texte fig√©, d√©pouillement accessible
    - Bouton "Finaliser" dans S√©quencier, Sc√©nario (Vue Sc√®nes + Vue Script)
    - Bouton "Repasser en brouillon" avec alerte suppression d√©pouillement
    - Badge visuel sur chaque sc√®ne (S√©quencier, Sc√©nario, D√©pouillement)
    - Clic-droit bloqu√© dans D√©pouillement si sc√®ne non finalis√©e

V1.9.3 - D√©penses & Contrats Simplifi√©s (Jan. 2025)
  ‚Ä¢ Pricing et Abonnements
    - Base : 1‚Ç¨/mois pour le propri√©taire
    - 6-15 collaborateurs = 2‚Ç¨/mois
    - +1‚Ç¨ par tranche de 10 au-del√†
    - 1 collaborateur = 1 fiche com√©dien ou technicien
    - Modale d'offre d'essai avec avantages
    - Modale d'abonnement
    - Banni√®re d'essai avec countdown dans le dashboard
    - Widget de facturation avec d√©tail par projet
    - Calcul automatique du prix selon projets et membres
  ‚Ä¢ D√©penses : Mode Simple / Avanc√©
    - Toggle Simple/Avanc√© en haut de l'onglet Budget
    - Mode Simple : budget + liste d√©penses, statuts √Ä payer/Pay√©
    - Mode Avanc√© : cat√©gories, enveloppes, responsables, salaires auto
    - Cat√©gories simplifi√©es (6 au lieu de 16)
    - Pr√©f√©rence sauvegard√©e par utilisateur
  ‚Ä¢ Contrats : r√©organisation et alertes
    - Droit √† l'image en premier (onglet par d√©faut)
    - V√©rification des infos manquantes avant g√©n√©ration
    - Alerte avec liste des champs manquants
    - Bouton "Envoyer rappel" par email
    - Option "G√©n√©rer quand m√™me"
  ‚Ä¢ Alertes infos manquantes (salaires/contrats)
    - Bouton "V√©rifier infos" dans section Salaires
    - Modale listant les personnes incompl√®tes
    - Email de rappel personnalis√©
    - Envoi group√© possible

V1.8.5 - Plan de Travail & D√©pouillement Intelligent
  ‚Ä¢ Voir versions ant√©rieures dans le fichier complet

V1.8 √† V1.8.4 - Budget Hi√©rarchique & Am√©liorations
  ‚Ä¢ Voir versions ant√©rieures dans le fichier complet

V1.7 √† V1.7.9 - Storyboard, Univers & Planning
  ‚Ä¢ Voir versions ant√©rieures dans le fichier complet

V1.6 √† V1.6.6 - Refonte Univers
  ‚Ä¢ Voir versions ant√©rieures dans le fichier complet

V1.5 √† V1.5.1 - Mise en Page
  ‚Ä¢ Voir versions ant√©rieures dans le fichier complet

V1.4 √† V1.4.7 - Mode Pr√©sentation & Fonctionnalit√©s
  ‚Ä¢ Voir versions ant√©rieures dans le fichier complet

V1.3 √† V1.3.1 - Export PDF & Favoris
  ‚Ä¢ Voir versions ant√©rieures dans le fichier complet

V1.2 √† V1.2.1 - Responsive Mobile
  ‚Ä¢ Voir versions ant√©rieures dans le fichier complet

V1.1 - Notifications Toast
  ‚Ä¢ Remplacement des alert() par notifications √©l√©gantes
  ‚Ä¢ 4 types : success, error, warning, info

V1.0 - Base solide (D√©c. 2024)
  ‚Ä¢ Authentification Firebase (connexion, inscription, reset)
  ‚Ä¢ Profils publics multi-types (Com√©dien, Technicien)
  ‚Ä¢ Gestion de projets avec r√¥les et permissions
  ‚Ä¢ Sc√©nario & Breakdown (import PDF/FDX, √©diteur, d√©composition)
  ‚Ä¢ Storyboard avec √©diteur de dessin int√©gr√©
  ‚Ä¢ √âquipe (Crew) avec d√©partements et fiches
  ‚Ä¢ Planning et calendrier de tournage
  ‚Ä¢ Budget & D√©penses par cat√©gorie
  ‚Ä¢ Chat par projet et messagerie interne
  ‚Ä¢ Univers (annuaire public des professionnels)
  ‚Ä¢ Mode clair / sombre

================================================================================
                              √Ä FAIRE - ROADMAP
================================================================================

üí≥ PRICING - √Ä FINALISER
  ‚Ä¢ Int√©gration Stripe Checkout (paiement r√©el) ‚ùå
  ‚Ä¢ Webhooks Stripe ‚Üí Firebase (confirmation paiement) ‚ùå
  ‚Ä¢ Cloud Functions (cron jobs essais/suppressions) ‚ùå
  ‚Ä¢ Emails automatiques (rappels, expirations) ‚ùå
  ‚Ä¢ S√©curit√© Firebase Rules (bloquer si impay√©) ‚ùå
  ‚Ä¢ Portail client Stripe (gestion abonnement) ‚ùå

üìã DOCUMENTS NON IMPL√âMENT√âS
  C) Liste des V√©hicules n√©cessaires
     - R√©capitulatif par jour de tournage ‚ùå
  D) Feuille de Continuit√© / Rapport Scripte
     - Raccords, chronom√©trage, notes ‚úÖ (V1.9.9.1)
  E) Listing des Figurants par jour
     - Nombre, costumes, horaires ‚ùå
  F) R√©capitulatif Costumes/Maquillage par personnage ‚ùå

üîó LIAISONS MANQUANTES
  1) D√©penses ‚Üî Cat√©gorie d√©pouillement
  2) Sc√®ne ‚Üí Version/R√©vision (pages color√©es)

üìä STATISTIQUES MANQUANTES
  ‚Ä¢ Co√ªt moyen par jour ‚ùå

üì§ EXPORTS
  ‚Ä¢ Rapport prod PDF ‚úÖ (V1.9.8)
  ‚Ä¢ ZIP complet avec PDFs ‚úÖ (V1.9.9)

‚úÖ FAIT
  ‚Ä¢ Export ZIP avec dossiers PDF/ et CSV/ (V1.9.9)
  ‚Ä¢ MoodBoard : export PNG/PDF de toutes les formes SVG (V1.9.9)
  ‚Ä¢ Storyboard PDF : nom du plan, mode cam√©ra, directions acteurs/technique (V1.9.9)
  ‚Ä¢ Noms de fichiers explicites pour tous les exports (V1.9.9)
  ‚Ä¢ Syst√®me Brouillon/Finale sc√®nes ‚Üí D√©pouillement bloqu√© si brouillon (V1.9.5)
  ‚Ä¢ Drag & drop sous-onglets entre cat√©gories (V1.9.5)
  ‚Ä¢ Accessoire/Costume/V√©hicule ‚Üí Fiche d√©di√©e Ressources (V1.9.5)
  ‚Ä¢ Liaison visuelle D√©pouillement ‚Üî Texte avec fl√®che (V1.9.5)
  ‚Ä¢ D√©penses Mode Simple/Avanc√© (V1.9.3)
  ‚Ä¢ Alertes infos manquantes contrats/salaires (V1.9.3)
  ‚Ä¢ Contrats : Droit √† l'image par d√©faut (V1.9.3)
  ‚Ä¢ Pricing √† l'usage avec essai 48h (V1.9.3) - en attente Stripe
  ‚Ä¢ Types de journ√©es planning (V1.9.3)
  ‚Ä¢ Session unique multi-onglets (V1.9.3)
  ‚Ä¢ Langues/Sports avec niveaux (V1.9.3)
  ‚Ä¢ Jours de travail par com√©dien (V1.9)
  ‚Ä¢ Nb sc√®nes par lieu (V1.4.3)
  ‚Ä¢ Taux d'avancement (V1.4.3)
  ‚Ä¢ Nb dialogues par personnage (V1.4.3)
  ‚Ä¢ Sc√©nario PDF | √âquipe PDF | D√©pouillement PDF (via impression)
  ‚Ä¢ Budget PDF | Budget Excel (V1.8.6)
  ‚Ä¢ Storyboard PDF | Feuille service | Plan travail
  ‚Ä¢ Liaison Lieu ‚Üî Sc√®ne enrichie (V1.8.6)
  ‚Ä¢ Fiche Lieu avec adresse, contact, photos (V1.8.6)
  ‚Ä¢ Auto-liaison d√©pouillement ‚Üí feuille de service (V1.8.6)
  ‚Ä¢ Workflow validation d√©penses (V1.8)
  ‚Ä¢ Gestion v√©hicules √©quipe (V1.7.6)
  ‚Ä¢ Outils dessin 6 pinceaux (V1.7)
  ‚Ä¢ Logs/Historique (V1.4.1)

================================================================================
-->
<head>
<title>Moteur - Gestion de production audiovisuelle - 1.9.9.5</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- EmailJS SDK pour les invitations -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    // iOS Safari 100vh fix
    function setVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      document.documentElement.style.setProperty('--real-vh', `${vh}px`);
    }
    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', function() { setTimeout(setVH, 100); });
    
    // Smooth scroll polyfill check for Safari
    if (!('scrollBehavior' in document.documentElement.style)) {
      window.smoothScrollTo = function(element, options) {
        const start = window.pageYOffset;
        const target = element.getBoundingClientRect().top + start;
        const duration = 300;
        let startTime = null;
        function animation(currentTime) {
          if (startTime === null) startTime = currentTime;
          const timeElapsed = currentTime - startTime;
          const progress = Math.min(timeElapsed / duration, 1);
          const ease = progress < 0.5 ? 2 * progress * progress : 1 - Math.pow(-2 * progress + 2, 2) / 2;
          window.scrollTo(0, start + (target - start) * ease);
          if (timeElapsed < duration) requestAnimationFrame(animation);
        }
        requestAnimationFrame(animation);
      };
    }
</script>

<style>
  /* --- CROSS-BROWSER COMPATIBILITY RESET --- */
  *, *::before, *::after {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
  }
  html {
    -webkit-text-size-adjust: 100%;
    -moz-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  /* iOS Safari 100vh fix */
  :root {
    --vh: 1vh;
  }
  @supports (-webkit-touch-callout: none) {
    :root {
      --vh: calc(var(--real-vh, 1vh));
    }
  }
  /* Smooth scroll with fallback */
  @media (prefers-reduced-motion: no-preference) {
    html {
      scroll-behavior: smooth;
    }
  }
  /* Flexbox gap fallback for older browsers */
  @supports not (gap: 1px) {
    .gap-fallback > * {
      margin: 5px;
    }
  }
  /* Safari sticky fix */
  .sticky-element {
    position: -webkit-sticky;
    position: sticky;
  }
  
  /* --- CSS VARIABLES --- */
  :root { --primary: #2b6ef6; --bg: #f4f6f8; --panel-bg: #ffffff; --text-main: #333333; --text-sec: #666666; --border: #dddddd; --input-bg: #ffffff; --highlight: #fff3cd; --danger: #ff4444; --success: #28a745; --locked: #ff9800; --shadow: rgba(0,0,0,0.05); --radius: 8px; --blur: 0px; --glass-bg: rgba(255,255,255,1); --glass-border: var(--border); }
  body.dark-mode { --primary: #4a90e2; --bg: #121212; --panel-bg: #1e1e1e; --text-main: #e0e0e0; --text-sec: #aaaaaa; --border: #333333; --input-bg: #2d2d2d; --highlight: #4a4a20; --shadow: rgba(0,0,0,0.3); --glass-bg: rgba(30,30,30,1); --glass-border: var(--border); }
  
  /* ===== DESIGN SYSTEM: GLASSMORPHISM ===== */
  body.design-glass { --bg: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); --panel-bg: rgba(255,255,255,0.15); --glass-bg: rgba(255,255,255,0.1); --glass-border: rgba(255,255,255,0.2); --border: rgba(255,255,255,0.15); --input-bg: rgba(255,255,255,0.1); --text-main: #ffffff; --text-sec: rgba(255,255,255,0.7); --shadow: rgba(0,0,0,0.1); --blur: 20px; --radius: 16px; }
  body.design-glass.dark-mode { --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); --panel-bg: rgba(255,255,255,0.05); --glass-bg: rgba(255,255,255,0.05); --glass-border: rgba(255,255,255,0.1); --border: rgba(255,255,255,0.08); --input-bg: rgba(255,255,255,0.05); --text-main: #ffffff; --text-sec: rgba(255,255,255,0.6); }
  body.design-glass { background: var(--bg) !important; background-attachment: fixed !important; min-height: 100vh; }
  body.design-glass .auth-box,
  body.design-glass header,
  body.design-glass .tabs-nav,
  body.design-glass main,
  body.design-glass .modal-content,
  body.design-glass .profile-modal-box,
  body.design-glass .toast,
  body.design-glass .dash-card,
  body.design-glass .contact-card,
  body.design-glass .board-sidebar,
  body.design-glass .sc-panel,
  body.design-glass .sb-sidebar,
  body.design-glass .sb-card,
  body.design-glass .planning-sidebar,
  body.design-glass .planning-day-card,
  body.design-glass .expenses-sidebar,
  body.design-glass .expense-card,
  body.design-glass .chat-panel,
  body.design-glass .universe-search,
  body.design-glass .moodboard-sidebar,
  body.design-glass .moodboard-canvas-container,
  body.design-glass .drawing-toolbar,
  body.design-glass #quick-nav,
  body.design-glass .global-search-container,
  body.design-glass .context-menu { 
    background: var(--glass-bg) !important; 
    backdrop-filter: blur(var(--blur)) !important; 
    -webkit-backdrop-filter: blur(var(--blur)) !important;
    border: 1px solid var(--glass-border) !important;
    border-radius: var(--radius) !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1) !important;
  }
  body.design-glass input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="color"]),
  body.design-glass select,
  body.design-glass textarea { background: var(--input-bg) !important; backdrop-filter: blur(10px) !important; border: 1px solid var(--glass-border) !important; border-radius: var(--radius) !important; color: var(--text-main) !important; }
  body.design-glass input::placeholder,
  body.design-glass textarea::placeholder { color: var(--text-sec) !important; }
  body.design-glass button:not(.tab-btn):not(.contacts-tab) { border-radius: var(--radius) !important; }
  body.design-glass .tab-btn,
  body.design-glass .contacts-tab { background: transparent !important; border: 1px solid transparent !important; }
  body.design-glass .tab-btn.active,
  body.design-glass .contacts-tab.active { background: var(--glass-bg) !important; backdrop-filter: blur(var(--blur)) !important; border: 1px solid var(--glass-border) !important; }
  body.design-glass .toast.success { background: rgba(40, 167, 69, 0.8) !important; backdrop-filter: blur(10px) !important; }
  body.design-glass .toast.error { background: rgba(220, 53, 69, 0.8) !important; backdrop-filter: blur(10px) !important; }
  body.design-glass .toast.warning { background: rgba(255, 193, 7, 0.8) !important; backdrop-filter: blur(10px) !important; }
  body.design-glass .toast.info { background: rgba(23, 162, 184, 0.8) !important; backdrop-filter: blur(10px) !important; }
  
  /* Design dropdown */
  #design-dropdown.show { display:block !important; }
  #design-dropdown div:hover { background:var(--primary); color:white; }

  /* ===== DESIGN SYSTEM: NEUMORPHISM ===== */
  body.design-neumorphism { --bg: #e0e5ec; --panel-bg: #e0e5ec; --text-main: #333; --text-sec: #666; --border: transparent; --input-bg: #e0e5ec; --shadow: rgba(0,0,0,0.1); --radius: 16px; --neu-shadow: 8px 8px 16px #b8bec7, -8px -8px 16px #ffffff; --neu-shadow-inset: inset 4px 4px 8px #b8bec7, inset -4px -4px 8px #ffffff; }
  body.design-neumorphism.dark-mode { --bg: #2d3436; --panel-bg: #2d3436; --text-main: #dfe6e9; --text-sec: #b2bec3; --input-bg: #2d3436; --neu-shadow: 8px 8px 16px #232728, -8px -8px 16px #383f41; --neu-shadow-inset: inset 4px 4px 8px #232728, inset -4px -4px 8px #383f41; }
  body.design-neumorphism .auth-box, body.design-neumorphism header, body.design-neumorphism .dash-card, body.design-neumorphism .contact-card, body.design-neumorphism .modal-content, body.design-neumorphism .profile-modal-box, body.design-neumorphism .board-sidebar, body.design-neumorphism .sc-panel, body.design-neumorphism .sb-sidebar, body.design-neumorphism .sb-card, body.design-neumorphism .planning-sidebar, body.design-neumorphism .planning-day-card, body.design-neumorphism .expenses-sidebar, body.design-neumorphism .expense-card, body.design-neumorphism .universe-search, body.design-neumorphism .moodboard-sidebar, body.design-neumorphism #quick-nav { background: var(--panel-bg) !important; box-shadow: var(--neu-shadow) !important; border: none !important; border-radius: var(--radius) !important; }
  body.design-neumorphism input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="color"]), body.design-neumorphism select, body.design-neumorphism textarea { background: var(--input-bg) !important; box-shadow: var(--neu-shadow-inset) !important; border: none !important; border-radius: 12px !important; }
  body.design-neumorphism button:not(.tab-btn) { box-shadow: var(--neu-shadow) !important; border: none !important; border-radius: 12px !important; }
  body.design-neumorphism button:not(.tab-btn):active { box-shadow: var(--neu-shadow-inset) !important; }

  /* ===== DESIGN SYSTEM: DARK CINEMA ===== */
  body.design-cinema { --bg: #0a0a0a; --panel-bg: #141414; --text-main: #f5f5f5; --text-sec: #888; --border: #2a2a2a; --input-bg: #1a1a1a; --primary: #d4af37; --shadow: rgba(0,0,0,0.5); --radius: 4px; }
  body.design-cinema .auth-box, body.design-cinema header, body.design-cinema .dash-card, body.design-cinema .contact-card, body.design-cinema .modal-content, body.design-cinema .profile-modal-box, body.design-cinema .board-sidebar, body.design-cinema .sc-panel, body.design-cinema .sb-sidebar, body.design-cinema .sb-card, body.design-cinema .planning-sidebar, body.design-cinema .planning-day-card, body.design-cinema .expenses-sidebar, body.design-cinema .expense-card, body.design-cinema .universe-search, body.design-cinema .moodboard-sidebar, body.design-cinema #quick-nav { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; }
  body.design-cinema button { border-radius: var(--radius) !important; }
  body.design-cinema .tab-btn.active, body.design-cinema .contacts-tab.active { background: var(--primary) !important; color: #000 !important; }
  body.design-cinema h1, body.design-cinema h2, body.design-cinema h3 { color: var(--primary) !important; }
  body.design-cinema::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.3) 100%); pointer-events: none; z-index: 0; }

  /* ===== DESIGN SYSTEM: CYBERPUNK/NEON ===== */
  body.design-neon { --bg: #0d0d0d; --panel-bg: rgba(20,20,30,0.9); --text-main: #0ff; --text-sec: #f0f; --border: #0ff; --input-bg: rgba(0,255,255,0.05); --primary: #f0f; --shadow: 0 0 20px rgba(0,255,255,0.3); --radius: 0px; }
  body.design-neon * { font-family: 'Courier New', monospace !important; }
  body.design-neon .auth-box, body.design-neon header, body.design-neon .dash-card, body.design-neon .contact-card, body.design-neon .modal-content, body.design-neon .profile-modal-box, body.design-neon .board-sidebar, body.design-neon .sc-panel, body.design-neon .sb-sidebar, body.design-neon .sb-card, body.design-neon .planning-sidebar, body.design-neon .planning-day-card, body.design-neon .expenses-sidebar, body.design-neon .expense-card, body.design-neon .universe-search, body.design-neon .moodboard-sidebar, body.design-neon #quick-nav { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; box-shadow: var(--shadow), inset 0 0 30px rgba(0,255,255,0.05) !important; border-radius: 0 !important; }
  body.design-neon input, body.design-neon select, body.design-neon textarea { background: var(--input-bg) !important; border: 1px solid var(--border) !important; color: var(--text-main) !important; border-radius: 0 !important; }
  body.design-neon button { background: transparent !important; border: 1px solid var(--primary) !important; color: var(--primary) !important; text-transform: uppercase !important; letter-spacing: 2px !important; border-radius: 0 !important; }
  body.design-neon button:hover { background: var(--primary) !important; color: #000 !important; box-shadow: 0 0 20px var(--primary) !important; }
  body.design-neon h1, body.design-neon h2, body.design-neon h3 { text-shadow: 0 0 10px var(--text-main) !important; }

  /* ===== DESIGN SYSTEM: NATURE ===== */
  body.design-nature { --bg: #f5f0e6; --panel-bg: #fffef9; --text-main: #2d3a2d; --text-sec: #5a6b5a; --border: #c8d6c8; --input-bg: #f9f7f2; --primary: #4a7c4a; --success: #5d8a5d; --shadow: rgba(45,58,45,0.08); --radius: 12px; }
  body.design-nature.dark-mode { --bg: #1a2418; --panel-bg: #232d21; --text-main: #d4e4d4; --text-sec: #8fa88f; --border: #3d4d3a; --input-bg: #2a362a; }
  body.design-nature .auth-box, body.design-nature header, body.design-nature .dash-card, body.design-nature .contact-card, body.design-nature .modal-content, body.design-nature .profile-modal-box { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; }
  body.design-nature button { border-radius: 20px !important; }

  /* ===== DESIGN SYSTEM: SUNSET ===== */
  body.design-sunset { --bg: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ee9ca7 100%); --panel-bg: rgba(255,255,255,0.85); --text-main: #4a3728; --text-sec: #7a5d4a; --border: rgba(255,255,255,0.5); --input-bg: rgba(255,255,255,0.7); --primary: #e07b54; --shadow: rgba(74,55,40,0.1); --radius: 16px; }
  body.design-sunset.dark-mode { --bg: linear-gradient(135deg, #2d1f1a 0%, #4a2c2a 50%, #5c3a3a 100%); --panel-bg: rgba(30,20,15,0.9); --text-main: #ffecd2; --text-sec: #d4a88a; --border: rgba(255,236,210,0.2); --input-bg: rgba(255,255,255,0.1); }
  body.design-sunset { background: var(--bg) !important; background-attachment: fixed !important; }
  body.design-sunset .auth-box, body.design-sunset header, body.design-sunset .dash-card, body.design-sunset .contact-card, body.design-sunset .modal-content, body.design-sunset .profile-modal-box, body.design-sunset .board-sidebar, body.design-sunset .universe-search { background: var(--panel-bg) !important; backdrop-filter: blur(10px) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; }

  /* ===== DESIGN SYSTEM: OCEAN ===== */
  body.design-ocean { --bg: linear-gradient(180deg, #0077b6 0%, #023e8a 50%, #03045e 100%); --panel-bg: rgba(255,255,255,0.12); --text-main: #caf0f8; --text-sec: #90e0ef; --border: rgba(202,240,248,0.2); --input-bg: rgba(255,255,255,0.08); --primary: #00b4d8; --shadow: rgba(3,4,94,0.3); --radius: 12px; }
  body.design-ocean { background: var(--bg) !important; background-attachment: fixed !important; }
  body.design-ocean .auth-box, body.design-ocean header, body.design-ocean .dash-card, body.design-ocean .contact-card, body.design-ocean .modal-content, body.design-ocean .profile-modal-box, body.design-ocean .board-sidebar, body.design-ocean .universe-search, body.design-ocean .sc-panel, body.design-ocean .sb-sidebar { background: var(--panel-bg) !important; backdrop-filter: blur(15px) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; }
  body.design-ocean input, body.design-ocean select, body.design-ocean textarea { background: var(--input-bg) !important; border: 1px solid var(--border) !important; color: var(--text-main) !important; }

  /* ===== DESIGN SYSTEM: LAVENDER ===== */
  body.design-lavender { --bg: #f3e8ff; --panel-bg: #ffffff; --text-main: #4a2c6a; --text-sec: #7c5a9a; --border: #e2d0f0; --input-bg: #faf5ff; --primary: #8b5cf6; --shadow: rgba(139,92,246,0.1); --radius: 20px; }
  body.design-lavender.dark-mode { --bg: #1e1528; --panel-bg: #2a1f38; --text-main: #e8d5ff; --text-sec: #b794d4; --border: #3d2a54; --input-bg: #251a32; }
  body.design-lavender .auth-box, body.design-lavender header, body.design-lavender .dash-card, body.design-lavender .contact-card, body.design-lavender .modal-content, body.design-lavender .profile-modal-box { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; box-shadow: 0 4px 20px var(--shadow) !important; }
  body.design-lavender button { border-radius: 25px !important; }

  /* ===== DESIGN SYSTEM: MINIMAL ===== */
  body.design-minimal { --bg: #ffffff; --panel-bg: #ffffff; --text-main: #111111; --text-sec: #666666; --border: #e5e5e5; --input-bg: #fafafa; --primary: #111111; --shadow: none; --radius: 2px; }
  body.design-minimal.dark-mode { --bg: #111111; --panel-bg: #111111; --text-main: #ffffff; --text-sec: #888888; --border: #333333; --input-bg: #1a1a1a; --primary: #ffffff; }
  body.design-minimal .auth-box, body.design-minimal header, body.design-minimal .dash-card, body.design-minimal .contact-card, body.design-minimal .modal-content, body.design-minimal .profile-modal-box, body.design-minimal .board-sidebar, body.design-minimal .universe-search { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; border-radius: var(--radius) !important; box-shadow: none !important; }
  body.design-minimal button { border-radius: var(--radius) !important; text-transform: uppercase !important; letter-spacing: 1px !important; font-weight: 400 !important; }
  body.design-minimal h1, body.design-minimal h2, body.design-minimal h3 { font-weight: 300 !important; letter-spacing: -0.5px !important; }

  /* ===== DESIGN SYSTEM: TERMINAL ===== */
  body.design-terminal { --bg: #0a0a0a; --panel-bg: #0d0d0d; --text-main: #00ff00; --text-sec: #008800; --border: #00ff00; --input-bg: #000000; --primary: #00ff00; --shadow: 0 0 10px rgba(0,255,0,0.2); --radius: 0px; }
  body.design-terminal * { font-family: 'Courier New', 'Consolas', monospace !important; }
  body.design-terminal .auth-box, body.design-terminal header, body.design-terminal .dash-card, body.design-terminal .contact-card, body.design-terminal .modal-content, body.design-terminal .profile-modal-box, body.design-terminal .board-sidebar, body.design-terminal .universe-search { background: var(--panel-bg) !important; border: 1px solid var(--border) !important; border-radius: 0 !important; box-shadow: var(--shadow) !important; }
  body.design-terminal input, body.design-terminal select, body.design-terminal textarea { background: #000 !important; border: 1px solid var(--border) !important; color: var(--text-main) !important; border-radius: 0 !important; }
  body.design-terminal button { background: transparent !important; border: 1px solid var(--primary) !important; color: var(--primary) !important; border-radius: 0 !important; }
  body.design-terminal button:hover { background: var(--primary) !important; color: #000 !important; }
  body.design-terminal::after { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px); pointer-events: none; z-index: 99999; }
  body.design-terminal h1::before, body.design-terminal h2::before { content: '> '; color: var(--primary); }

  /* Brutalist supprim√© */
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text-main); display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; height: 100vh; height: calc(var(--vh, 1vh) * 100); min-height: -webkit-fill-available; overflow: hidden; -webkit-overflow-scrolling: touch; }

  /* --- AUTH & DASHBOARD --- */
  #auth-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  body.dark-mode #auth-view { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); }
  
  /* Spinner de chargement */
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
  .spinner.dark { border-color: rgba(0,0,0,0.2); border-top-color: var(--primary); }
  @keyframes spin { to { transform: rotate(360deg); } }
  .btn-loading { opacity: 0.8; pointer-events: none; }
  
  /* Notifications Toast */
  .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 99999; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; gap: 10px; pointer-events: none; }
  .toast-container > *:not(:last-child) { margin-bottom: 10px; } /* gap fallback */
  .toast { padding: 15px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: -webkit-box; display: -webkit-flex; display: flex; -webkit-align-items: center; align-items: center; gap: 10px; -webkit-animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; pointer-events: auto; max-width: 350px; }
  .toast > *:not(:last-child) { margin-right: 10px; } /* gap fallback */
  .toast.success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
  .toast.error { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
  .toast.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #333; }
  .toast.info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
  .toast-icon { font-size: 1.2rem; }
  .toast-message { flex: 1; }
  .toast-close { background: none; border: none; color: inherit; font-size: 1.2rem; cursor: pointer; opacity: 0.8; }
  .toast-close:hover { opacity: 1; }
  @-webkit-keyframes toastIn { from { -webkit-transform: translateX(100%); transform: translateX(100%); opacity: 0; } to { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; } }
  @keyframes toastIn { from { -webkit-transform: translateX(100%); transform: translateX(100%); opacity: 0; } to { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; } }
  @-webkit-keyframes toastOut { from { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; } to { -webkit-transform: translateX(100%); transform: translateX(100%); opacity: 0; } }
  @keyframes toastOut { from { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; } to { -webkit-transform: translateX(100%); transform: translateX(100%); opacity: 0; } }
  
  /* ===== RESPONSIVE MOBILE ===== */
  @media (max-width: 768px) {
    /* Dashboard */
    #dashboard-view { padding: 15px; }
    .dash-header { flex-direction: column; gap: 15px; align-items: flex-start; }
    .dash-header > div:last-child { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; }
    .dash-header button { flex: 1; min-width: 100px; font-size: 0.85rem; padding: 8px 12px; }
    
    /* Profil public */
    .public-profile-header { padding: 15px; flex-direction: column; gap: 10px; align-items: flex-start; }
    .public-profile-body { padding: 15px; }
    .profile-photo-section { flex-direction: column; align-items: center; text-align: center; }
    .profile-row > * { min-width: 100%; }
    
    /* Contacts */
    .contacts-header { padding: 15px; flex-direction: column; gap: 10px; align-items: flex-start; }
    .contacts-body { padding: 15px; }
    .contacts-tabs { flex-wrap: wrap; }
    .contacts-grid { grid-template-columns: 1fr; }
    
    /* Modales */
    .profile-modal-overlay { padding: 10px; }
    .profile-modal-box { max-width: 100%; }
    .global-search-container { width: 100%; max-width: 100%; }
    .permissions-container { width: 100%; max-width: 100%; }
    
    /* Chat */
    .chat-panel { width: 100%; right: 0; left: 0; border-radius: 12px 12px 0 0; }
    
    /* Toasts */
    .toast-container { left: 10px; right: 10px; bottom: 10px; }
    .toast { max-width: 100%; }
    
    /* D√©penses */
    .expenses-container { flex-direction: column; padding: 15px; }
    .expenses-sidebar { width: 100%; }
    .expenses-summary { grid-template-columns: 1fr; }
    
    /* Header projet */
    header { padding: 10px 15px; flex-wrap: wrap; gap: 10px; }
    header input { font-size: 1rem; width: 100%; }
    .project-info { width: 100%; }
    .global-actions { width: 100%; display: flex; flex-wrap: wrap; gap: 5px; }
    .global-actions button { flex: 1; min-width: 80px; font-size: 0.75rem; padding: 6px 8px; }
    .presence-bar { display: none; }
    
    /* Tabs navigation */
    .tabs-nav { padding: 0 10px; gap: 5px; }
    .tab-btn { padding: 10px 8px; font-size: 0.8rem; }
    
    /* Main content */
    main { padding: 15px; padding-right: 15px; }
    #quick-nav { display: none !important; }
    
    /* Sidebar projet (breakdown, etc.) */
    .board-sidebar { position: fixed !important; left: -280px; top: 0; height: 100vh; z-index: 1000; transition: left 0.3s ease; }
    .board-sidebar.mobile-open { left: 0; }
    
    /* Planning */
    .planning-container { flex-direction: column; }
    .planning-sidebar { width: 100%; max-height: 200px; }
    
    /* Tableaux */
    .permissions-table { font-size: 0.75rem; display: block; overflow-x: auto; }
    .permissions-table th, .permissions-table td { padding: 6px 4px; }
    
    /* Bouton menu hamburger */
    .mobile-menu-btn { display: flex !important; }
    
    /* Overlay pour fermer sidebar */
    .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
    .mobile-overlay.active { display: block; }
  }
  
  /* Bouton menu hamburger (cach√© par d√©faut sur desktop) */
  .mobile-menu-btn { display: none; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; cursor: pointer; font-size: 1.2rem; }
  .mobile-menu-btn:hover { background: var(--primary); color: white; }

  /* Responsive petits √©crans (phones) */
  @media (max-width: 480px) {
    /* Auth */
    .auth-box { padding: 25px 20px; margin: 10px; }
    
    /* Boutons plus grands pour touch */
    button, .auth-btn, .tab-btn { min-height: 44px; }
    
    /* Inputs plus grands */
    input, select, textarea, .profile-input, .auth-input { font-size: 16px !important; padding: 12px; }
    
    /* Dashboard */
    .dash-header h1 { font-size: 1.3rem; }
    .project-grid { grid-template-columns: 1fr; }
    
    /* Cards */
    .floating-card { width: 140px; padding: 10px; }
    .floating-card .card-photo { width: 50px; height: 50px; }
    .floating-card .card-name { font-size: 0.8rem; }
    
    /* Profile tabs */
    #profile-tabs-container { gap: 5px; }
    #profile-tabs-container button { padding: 8px 12px; font-size: 0.8rem; }
    .profile-tab-card { padding: 8px 12px; font-size: 0.8rem; }
    .profile-project-badges { flex-direction: column; gap: 3px; }
    .profile-project-badge { font-size: 0.7rem; padding: 2px 6px; }
    
    /* Modales plein √©cran */
    .profile-modal-box, .message-detail-box { border-radius: 0; max-height: 100vh; height: 100vh; }
    .profile-modal-overlay, .message-detail-modal { padding: 0; }
    
    /* Zone danger */
    .profile-section div[style*="display: flex"][style*="gap: 20px"] { flex-direction: column; }
  }<!-- Overlay mobile pour fermer sidebar -->
    <div id="mobile-overlay" class="mobile-overlay" onclick="app.UI.closeMobileSidebar()"></div>
    
    <header>
      <div class="project-info">
        <button class="mobile-menu-btn" onclick="app.UI.toggleMobileSidebar()">‚ò∞</button>
        <button onclick="app.UI.showDashboard()" style="background:var(--border); color:var(--text-main); border:none; padding:5px 10px; border-radius:4px; margin-right:10px; font-weight:bold; cursor:pointer">‚¨Ö Dashboard</button>
  .auth-box { background: var(--panel-bg); padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px var(--shadow); width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border); }
  .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; background: var(--input-bg); color: var(--text-main); }
  .auth-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; }
  .auth-link { display: block; margin-top: 15px; color: var(--text-sec); font-size: 0.85rem; cursor: pointer; text-decoration: underline; }
  .auth-error { color: var(--danger); font-size: 0.85rem; margin-bottom: 15px; display: none; padding: 10px; background: rgba(255, 68, 68, 0.1); border-radius: 4px; }
  .auth-success { color: var(--success); font-size: 0.85rem; margin-bottom: 15px; display: none; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 4px; }

  #dashboard-view { display: none; flex-direction: column; height: 100%; width: 100%; background: var(--bg); padding: 40px; overflow-y: auto; }
  .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; max-width: 1200px; margin-left: auto; margin-right: auto; width: 100%; }
  .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
  
  /* Contacts */
  .contacts-view { display: none; flex-direction: column; width: 100%; height: 100vh; background: var(--bg); }
  .contacts-view.active { display: flex; }
  .contacts-header { background: var(--panel-bg); padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .contacts-header h1 { margin: 0; font-size: 1.5rem; }
  .contacts-body { flex: 1; overflow-y: auto; padding: 20px 40px; }
  .contacts-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
  .contacts-tab { padding: 10px 20px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600; }
  .contacts-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
  .contacts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }

  /* Vue Cours Cin√©ma */
  .courses-view { display: none; flex-direction: column; width: 100%; height: 100vh; background: var(--bg); }
  .courses-view.active { display: flex; }
  .courses-header { background: var(--panel-bg); padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .courses-header h1 { margin: 0; font-size: 1.5rem; }
  .courses-body { flex: 1; overflow-y: auto; padding: 20px 40px; }
  .courses-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
  .courses-tab { padding: 10px 20px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
  .courses-tab:hover { border-color: var(--primary); }
  .courses-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
  .courses-content { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 30px; }
  .courses-section { margin-bottom: 30px; }
  .courses-section:last-child { margin-bottom: 0; }
  .courses-section h2 { color: var(--primary); margin: 0 0 15px 0; font-size: 1.3rem; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
  .courses-section h3 { color: var(--text-main); margin: 20px 0 10px 0; font-size: 1.1rem; }
  .courses-section p { color: var(--text-main); line-height: 1.7; margin: 10px 0; }
  .courses-section ul { margin: 10px 0; padding-left: 25px; }
  .courses-section li { color: var(--text-main); line-height: 1.8; margin: 5px 0; }
  .courses-tip { background: rgba(99, 102, 241, 0.1); border-left: 4px solid var(--primary); padding: 15px; border-radius: 0 8px 8px 0; margin: 15px 0; }
  .courses-tip strong { color: var(--primary); }
  .courses-warning { background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; padding: 15px; border-radius: 0 8px 8px 0; margin: 15px 0; }
  .courses-warning strong { color: #f59e0b; }
  .courses-term { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin: 10px 0; }
  .courses-term dt { font-weight: bold; color: var(--primary); font-size: 1rem; margin-bottom: 5px; }
  .courses-term dd { margin: 0; color: var(--text-main); line-height: 1.6; }

  /* Infobulles des notions */
  .notion { cursor: help; border-bottom: 1px dotted var(--primary); position: relative; }
  .notion:hover { color: var(--primary); }
  .notion-tooltip { position: fixed; z-index: 100000; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); padding: 20px; max-width: 400px; min-width: 300px; display: none; }
  .notion-tooltip.visible { display: block; }
  .notion-tooltip-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; border-bottom: 2px solid var(--primary); padding-bottom: 8px; }
  .notion-tooltip-content { color: var(--text-main); line-height: 1.7; font-size: 0.95rem; }
  .notion-tooltip-content p { margin: 10px 0; }
  .notion-tooltip-image { margin: 15px 0; text-align: center; }
  .notion-tooltip-image img, .notion-tooltip-image svg { max-width: 100%; height: auto; border-radius: 8px; }
  .notion-tooltip-example { background: var(--bg); border-left: 3px solid var(--primary); padding: 10px 15px; margin: 10px 0; font-style: italic; font-size: 0.9rem; }
  .notion-tooltip-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-sec); }
  .notion-tooltip-close:hover { color: var(--danger); }
  .contact-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; }
  .contact-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .contact-card-photo { width: 50px; height: 50px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden; }
  .contact-card-photo img { width: 100%; height: 100%; object-fit: cover; }
  .contact-card-name { font-weight: bold; font-size: 1rem; }
  .contact-card-role { font-size: 0.85rem; color: var(--text-sec); }
  .contact-card-info { font-size: 0.85rem; color: var(--text-sec); margin-top: 8px; }
  .contact-card-actions { display: flex; gap: 8px; margin-top: 10px; }
  .contact-card-actions button { padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); background: var(--bg); }
  .contact-card-actions button:hover { background: var(--primary); color: white; border-color: var(--primary); }
  .save-contact-btn { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 2px 5px; border-radius: 4px; }
  .save-contact-btn:hover { background: var(--bg); }
  .save-contact-btn.saved { color: var(--success); }

/* Universe - Floating Cards */
.universe-container { position: relative; width: 100%; height: calc(100vh - 180px); height: calc(var(--vh, 1vh) * 100 - 180px); min-height: 500px; overflow: visible; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: row; flex-direction: row; -webkit-align-items: stretch; align-items: stretch; }
@media (max-width: 768px) { .universe-container { flex-direction: column; height: auto; min-height: calc(100vh - 120px); } .universe-container .universe-sidebar { width: 100% !important; min-width: 100% !important; max-height: 300px; border-right: none !important; border-bottom: 1px solid var(--border); } .universe-container .universe-scene { min-height: 400px; } }
.universe-search { display: flex; gap: 10px; padding: 20px; background: var(--panel-bg); border-radius: 12px; box-shadow: 0 4px 20px var(--shadow); z-index: 10; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
.universe-search select, .universe-search input { padding: 10px 15px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); font-size: 0.95rem; min-width: 150px; }
.universe-search button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
.universe-search button:hover { opacity: 0.9; }
.universe-scene { position: relative; flex: 1; width: 100%; }
#universe-map { width: 100%; height: 100%; min-height: 500px; background: #1a1a2e; z-index: 1; }
body:not(.dark-mode) #universe-map { background: #f4f6f8; }
.leaflet-container { background: #1a1a2e; }
body:not(.dark-mode) .leaflet-container { background: #f4f6f8; }
.map-profile-marker { width: 40px; height: 50px; position: relative; cursor: pointer; transition: transform 0.3s ease-out, z-index 0.2s, opacity 0.3s ease-out; animation: markerAppear 0.5s ease-out; }
.map-profile-marker:hover { transform: scale(2.5); z-index: 10000 !important; }
@keyframes markerAppear { 0% { opacity: 0; transform: scale(0.3) translateY(-20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
.leaflet-marker-icon { transition: transform 0.4s ease-out !important; }
.map-profile-marker img { width: 100%; height: 40px; object-fit: cover; border-radius: 6px; border: 2px solid var(--primary); background: var(--panel-bg); }
.map-profile-marker .marker-label { position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); font-size: 7px; white-space: nowrap; background: rgba(0,0,0,0.8); color: white; padding: 1px 4px; border-radius: 3px; max-width: 80px; overflow: hidden; text-overflow: ellipsis; }
.map-profile-marker.project-marker img { border-color: #e94560; }
.map-profile-marker.actor-marker img { border-color: #4CAF50; }
.map-profile-marker.crew-marker img { border-color: #2196F3; }
.map-profile-marker.association-marker img { border-color: #FF9800; }
.map-profile-marker.enterprise-marker img { border-color: #9C27B0; }
.marker-cluster { background: rgba(110, 204, 57, 0.6); border-radius: 50%; }
.marker-cluster div { background: rgba(110, 204, 57, 0.9); border-radius: 50%; margin: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
.marker-cluster-small { background: rgba(181, 226, 140, 0.6); }
.marker-cluster-small div { background: rgba(110, 204, 57, 0.9); }
.marker-cluster-medium { background: rgba(241, 211, 87, 0.6); }
.marker-cluster-medium div { background: rgba(240, 194, 12, 0.9); }
.marker-cluster-large { background: rgba(253, 156, 115, 0.6); }
.marker-cluster-large div { background: rgba(241, 128, 23, 0.9); }
.map-hover-card { position: fixed; z-index: 20000; pointer-events: none; animation: fadeInCard 0.2s ease; }
@keyframes fadeInCard { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.map-hover-card .fan-card { pointer-events: auto; margin: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
.universe-view-toggle { position: absolute; top: 10px; right: 20px; z-index: 10001; background: var(--panel-bg); border-radius: 8px; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); pointer-events: auto; }
.universe-scene { position: relative; }
.floating-card { position: absolute; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; width: 160px; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--shadow); }
.floating-card:hover { transform: scale(1.05); box-shadow: 0 8px 30px rgba(43, 110, 246, 0.3); border-color: var(--primary); z-index: 100 !important; }
.floating-card.blurred { filter: blur(3px); opacity: 0.6; }
.floating-card.project-card { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #e94560; }
.floating-card.project-card .card-photo.project-photo { background: linear-gradient(135deg, #e94560 0%, #0f3460 100%); }
.floating-card.project-card .card-name { color: #ffffff; }
.floating-card.project-card .project-type { color: #e94560; font-weight: bold; }
.floating-card.project-card .card-needs { font-size: 0.7rem; color: #ffc107; margin-top: 3px; }
.floating-card.project-card.blurred { filter: blur(2px); opacity: 0.6; }
.floating-card.project-card:hover { border-color: #ff6b6b; box-shadow: 0 8px 25px rgba(233, 69, 96, 0.4); }
.floating-card.main-card { filter: none; opacity: 1; z-index: 50; width: 200px; box-shadow: 0 8px 40px rgba(43, 110, 246, 0.4); border: 2px solid var(--primary); }
.floating-card.search-result { filter: none; opacity: 1; z-index: 40; animation: popIn 0.3s ease; }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.floating-card.blurred { z-index: 1 !important; }
.floating-card.search-result, .floating-card.main-card { z-index: 40 !important; }
.floating-card .card-photo { width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 10px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; border: 2px solid var(--border); }
.floating-card .card-photo img { width: 100%; height: 100%; object-fit: cover; }
.floating-card.main-card .card-photo { width: 90px; height: 90px; border-color: var(--primary); }
.floating-card .card-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.floating-card .card-role { font-size: 0.75rem; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.floating-card .card-city { font-size: 0.7rem; color: var(--primary); margin-top: 3px; }
.universe-empty { text-align: center; color: var(--text-sec); padding: 60px 20px; }
.universe-empty h2 { margin-bottom: 10px; }

/* Universe - Vue √âventail (Fan View) - Style jeu de cartes */
.universe-fan-container { display: flex; flex-direction: column; align-items: center; width: 100%; height: 100%; padding: 30px; gap: 40px; overflow-y: auto; }
.fan-category { width: 100%; max-width: 800px; }
.fan-category-header { text-align: center; margin-bottom: 20px; }
.fan-category-label { font-weight: bold; font-size: 1.1rem; color: var(--primary); background: var(--panel-bg); padding: 8px 20px; border-radius: 20px; border: 1px solid var(--border); display: inline-block; }
.fan-category-count { font-size: 0.85rem; color: var(--text-sec); margin-left: 10px; }
.fan-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
.fan-card { background: var(--panel-bg); border: 2px solid var(--border); border-radius: 12px; padding: 15px; width: 140px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px var(--shadow); transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; }
.fan-card:hover { transform: translateY(-8px); border-color: var(--primary); box-shadow: 0 12px 30px rgba(43, 110, 246, 0.3); }
.fan-card .card-photo { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; border: 2px solid var(--border); }
.fan-card .card-photo img { width: 100%; height: 100%; object-fit: cover; }
.fan-card .card-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
.fan-card .card-role { font-size: 0.75rem; color: var(--text-sec); }
.fan-card .card-city { font-size: 0.7rem; color: var(--primary); margin-top: 5px; }
.fan-card.project-card { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #e94560; }
.fan-card.project-card:hover { border-color: #ff6b6b; box-shadow: 0 12px 30px rgba(233, 69, 96, 0.4); }
.universe-view-toggle { display: flex; gap: 5px; background: var(--bg); padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
.universe-view-toggle button { padding: 8px 15px; border: none; background: transparent; color: var(--text-sec); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
.universe-view-toggle button.active { background: var(--primary); color: white; }
.universe-view-toggle button:hover:not(.active) { background: var(--border); }
.profile-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 20px; }
.profile-modal-box { background: var(--panel-bg); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
.profile-modal-header { position: relative; padding: 30px; text-align: center; border-bottom: 1px solid var(--border); }
.profile-modal-photo { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; overflow: hidden; border: 3px solid var(--primary); }
.profile-modal-photo img { width: 100%; height: 100%; object-fit: cover; }
.profile-modal-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
.profile-modal-role { color: var(--primary); font-size: 1rem; margin-bottom: 5px; }
.profile-modal-city { color: var(--text-sec); font-size: 0.9rem; }
.profile-modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); }
.profile-modal-header .favorite-btn { position: absolute; top: 15px; left: 15px; font-size: 1.5rem; }
.profile-modal-body { padding: 20px; }
.profile-modal-section { margin-bottom: 20px; }
.profile-modal-section h4 { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase; }
.profile-modal-section p { line-height: 1.5; }
.profile-modal-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.profile-modal-info-item { background: var(--bg); padding: 10px; border-radius: 6px; }
.profile-modal-info-item label { font-size: 0.75rem; color: var(--text-sec); display: block; margin-bottom: 3px; }
.profile-modal-info-item span { font-weight: 500; }
.profile-modal-actions { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
.profile-modal-actions button { flex: 1; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }

/* Module D√©penses/Budget */
.expenses-container { display: flex; height: 100%; gap: 20px; padding: 20px; }
.expenses-sidebar { width: 280px; background: var(--panel-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border); overflow-y: auto; }
.expenses-main { flex: 1; background: var(--panel-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border); overflow-y: auto; }
.expenses-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
.expenses-summary-card { background: var(--bg); padding: 15px; border-radius: 8px; text-align: center; }
.expenses-summary-card .amount { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
.expenses-summary-card .label { font-size: 0.85rem; color: var(--text-sec); margin-top: 5px; }
.expenses-summary-card.danger .amount { color: var(--danger); }
.expenses-summary-card.success .amount { color: var(--success); }
.expenses-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.expenses-filters select, .expenses-filters input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); }
.expense-card { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: all 0.2s; }
.expense-card:hover { border-color: var(--primary); box-shadow: 0 4px 15px var(--shadow); }
.expense-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.expense-card-title { font-weight: 600; font-size: 1rem; }
.expense-card-amount { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
.expense-card-meta { font-size: 0.8rem; color: var(--text-sec); margin-bottom: 10px; }
.expense-card-dept { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; background: rgba(43, 110, 246, 0.1); color: var(--primary); }
.expense-card-status { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; }
.expense-card-status.pending { background: rgba(255, 193, 7, 0.15); color: #f39c12; }
.expense-card-status.approved { background: rgba(40, 167, 69, 0.15); color: var(--success); }
.expense-card-status.rejected { background: rgba(255, 68, 68, 0.15); color: var(--danger); }
.expense-card-status.done { background: rgba(43, 110, 246, 0.15); color: var(--primary); }
.expense-card-photo { width: 80px; height: 80px; border-radius: 6px; overflow: hidden; margin-top: 10px; }
.expense-card-photo img { width: 100%; height: 100%; object-fit: cover; }
.expense-card-actions { display: flex; gap: 8px; margin-top: 12px; }
.expense-card-actions button { padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; font-weight: 500; }
.expense-btn-approve { background: var(--success); color: white; }
.expense-btn-reject { background: var(--danger); color: white; }
.expense-btn-edit { background: var(--border); color: var(--text-main); }
.expense-section-title { font-size: 1.1rem; font-weight: 600; margin: 20px 0 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
.expense-dept-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg); border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
  .salary-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); }
  .salary-item:last-child { border-bottom: none; }
  .salary-item.missing { background: rgba(245, 158, 11, 0.1); border-radius: 6px; margin-bottom: 5px; border: 1px dashed #f59e0b; }
  .salary-info { display: flex; flex-direction: column; gap: 2px; }
  .salary-name { font-weight: 500; }
  .salary-detail { font-size: 0.8rem; color: var(--text-sec); }
  .salary-amount { font-weight: 600; color: var(--success); }
  .salary-fix-btn { padding: 5px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
  .salary-fix-btn:hover { background: #d97706; }
  .salary-section-warning { margin-top: 15px; padding: 10px; background: rgba(245, 158, 11, 0.05); border-radius: 8px; }
.expense-dept-item:hover { background: rgba(43, 110, 246, 0.1); }
.expense-dept-item.active { background: rgba(43, 110, 246, 0.15); border-left: 3px solid var(--primary); }

/* Dropdown multi-select avec checkboxes */
.withwho-dropdown { position: relative; display: inline-block; width: 100%; }
.withwho-btn { width: 100%; padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.85rem; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.withwho-btn:after { content: '‚ñº'; font-size: 0.7rem; margin-left: 5px; }
.withwho-btn.open:after { content: '‚ñ≤'; }
.withwho-list { display: none; position: absolute; top: 100%; left: 0; min-width: 180px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.withwho-list.open { display: block; }
.withwho-item { display: flex; flex-direction: row; align-items: center; padding: 4px 8px; cursor: pointer; font-size: 0.85rem; white-space: nowrap; gap: 6px; }
.withwho-item:hover { background: rgba(43, 110, 246, 0.1); }
.withwho-item input[type="checkbox"] { margin: 0; flex-shrink: 0; width: 14px; height: 14px; }
.withwho-item.selected { background: rgba(43, 110, 246, 0.15); }
.withwho-item label { cursor: pointer; margin: 0; display: inline; overflow: hidden; text-overflow: ellipsis; }

/* Badge de r√¥le sur avatar */
.presence-bar { position: relative; display: flex; gap: -5px; }
.presence-avatar-wrapper { position: relative; display: inline-block; cursor: pointer; transition: transform 0.2s ease, z-index 0s; }
.presence-avatar-wrapper:hover { transform: scale(1.8); z-index: 100; }
.presence-avatar-wrapper .role-icon { position: absolute; bottom: -2px; right: -2px; font-size: 0.6rem; background: white; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid white; }
.presence-avatar-wrapper.owner .role-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
.presence-avatar-wrapper.budget-manager .role-icon { background: linear-gradient(135deg, #10b981, #059669); }
.presence-avatar-wrapper.dept-manager .role-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.presence-avatar-wrapper .role-icon.extra-role { bottom: -2px; background: var(--panel-bg); border: 1px solid var(--border); font-size: 0.5rem; width: 12px; height: 12px; }
/* Infobulle avatar */
.presence-avatar-wrapper .avatar-tooltip { position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(5px); background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; text-align: center; pointer-events: none; }
.presence-avatar-wrapper:hover .avatar-tooltip { opacity: 1; visibility: visible; }
.avatar-tooltip-name { font-weight: 600; font-size: 0.85rem; color: var(--text-main); }
.avatar-tooltip-role { font-size: 0.75rem; color: var(--text-sec); margin-top: 2px; }

/* Nouveaux statuts et boutons d√©penses */
.expense-card.returned { border-left: 3px solid #f59e0b; }
.expense-card.missing-rate { border-left: 3px solid var(--danger); background: rgba(255, 68, 68, 0.03); }
.dept-badge.orange { background: #f59e0b; color: white; }
.expense-card-status.escalated { background: #8b5cf6; color: white; }
.expense-card-status.returned { background: #f59e0b; color: white; }
.expense-btn-escalate { background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
.expense-btn-escalate:hover { background: #7c3aed; }
.expense-btn-return { background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
.expense-btn-return:hover { background: #d97706; }

/* Responsables par d√©partement */
.dept-manager-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--bg); border-radius: 6px; margin-bottom: 6px; }
.dept-manager-info { display: flex; flex-direction: column; gap: 2px; }
.dept-manager-dept { font-size: 0.8rem; color: var(--text-sec); }
.dept-manager-name { font-size: 0.9rem; font-weight: 500; color: var(--text-main); }
.dept-manager-actions { display: flex; align-items: center; gap: 8px; }
.dept-manager-actions input[type="checkbox"] { width: 14px; height: 14px; }

/* Param√®tres financiers */
.finance-params { margin-top: 10px; }
.finance-param-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
.finance-param-row:last-child { border-bottom: none; }
.finance-param-row label { font-size: 0.8rem; color: var(--text-sec); flex: 1; }
.finance-param-input { display: flex; align-items: center; gap: 5px; }
.finance-param-input input { width: 70px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); text-align: right; font-size: 0.85rem; }
.finance-param-input .param-unit { font-size: 0.75rem; color: var(--text-sec); min-width: 40px; }
.finance-param-rates { display: flex; align-items: center; gap: 3px; }
.finance-param-rates input { width: 40px; padding: 6px 4px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); text-align: center; font-size: 0.8rem; }
.finance-param-rates span { font-size: 0.7rem; color: var(--text-sec); }
.expense-dept-item .dept-name { font-weight: 500; }
.expense-dept-item .dept-amount { font-weight: 600; color: var(--primary); }
  .dept-badges { display: flex; gap: 3px; }
  .dept-badge { font-size: 0.65rem; font-weight: 600; padding: 2px 6px; border-radius: 10px; color: white; min-width: 18px; text-align: center; }
  .dept-badge.red { background: var(--danger); }
  .dept-badge.yellow { background: #f59e0b; }
  .dept-badge.green { background: var(--success); }
.expense-auto-section { background: linear-gradient(135deg, rgba(43, 110, 246, 0.05), rgba(139, 92, 246, 0.05)); border: 1px dashed var(--primary); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
.expense-auto-section h4 { margin: 0 0 10px; color: var(--primary); }

/* Galerie photos com√©diens */
.actor-gallery { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
.actor-gallery-item { width: 120px; height: 120px; border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; background: var(--bg); transition: all 0.2s; position: relative; }
.actor-gallery-item:hover { border-color: var(--primary); }
.actor-gallery-item img { width: 100%; height: 100%; object-fit: cover; }
.actor-gallery-item .gallery-placeholder { color: var(--text-sec); font-size: 2rem; }
.actor-gallery-item .gallery-remove { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; cursor: pointer; display: none; align-items: center; justify-content: center; }
.actor-gallery-item:hover .gallery-remove { display: flex; }
.actor-gallery-input { width: 100%; margin-top: 10px; }

/* Messages Inbox */
.messages-section { margin-top: 20px; }
.messages-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
.messages-tab { padding: 8px 16px; background: none; border: none; cursor: pointer; font-size: 0.9rem; color: var(--text-sec); border-radius: 6px 6px 0 0; }
.messages-tab.active { background: var(--primary); color: white; }
.messages-tab .badge { background: var(--danger); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
.message-list { display: flex; flex-direction: column; gap: 10px; }
.message-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; }
.message-card:hover { border-color: var(--primary); transform: translateX(3px); }
.message-card.unread { border-left: 4px solid var(--primary); background: rgba(43, 110, 246, 0.05); }
.message-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.message-card-title { font-weight: 600; font-size: 1rem; color: var(--text-main); }
.message-card-date { font-size: 0.75rem; color: var(--text-sec); }
.message-card-from { font-size: 0.85rem; color: var(--primary); margin-bottom: 5px; }
.message-card-preview { font-size: 0.85rem; color: var(--text-sec); line-height: 1.4; }
.message-card-type { display: inline-block; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-bottom: 8px; }
.message-card-type.invitation { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
.message-card-type.convocation { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
.message-card-type.info { background: rgba(43, 110, 246, 0.15); color: var(--primary); }
.message-empty { text-align: center; padding: 40px; color: var(--text-sec); }
.message-detail-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10001; }
.message-detail-box { background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
.message-detail-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.message-detail-body { padding: 20px; }
.message-detail-meta { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px; }
.message-detail-content { line-height: 1.6; white-space: pre-wrap; }
.message-detail-actions { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

  /* Profil Public */
  .public-profile-view { display: none; flex-direction: column; width: 100%; height: 100vh; background: var(--bg); }
  .public-profile-view.active { display: flex; }
  .public-profile-header { background: var(--panel-bg); padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .public-profile-header h1 { margin: 0; font-size: 1.5rem; }
  .public-profile-body { flex: 1; overflow-y: auto; padding: 20px 40px; max-width: 900px; margin: 0 auto; width: 100%; }
  .profile-section { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
  .profile-section h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
  .profile-section h3 span.section-title { flex: 1; }
  .visibility-toggles { display: flex; gap: 5px; }
  .visibility-btn { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 3px; transition: all 0.2s; }
  .visibility-btn:hover { background: var(--primary-light, #e3f2fd); }
  .visibility-btn.hidden-section { opacity: 0.7; background: var(--danger-light, #ffebee); border-color: var(--danger, #f44336); }
  .visibility-btn .vis-icon { font-size: 0.85rem; position: relative; display: inline-block; }
  .visibility-btn.hidden-section .vis-icon::after { content: ''; position: absolute; width: 120%; height: 2px; background: var(--danger, #f44336); top: 50%; left: -10%; transform: rotate(-45deg); }
  
  /* Statuts de validation sc√®nes */
  .scene-status-container { position: relative; display: inline-block; }
  .scene-status-badge { padding: 2px 6px; border-radius: 8px; font-size: 0.65rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 3px; opacity: 0.8; }
  .scene-status-badge:hover { opacity: 1; }
  .scene-status-badge.not-verified { background: #ffebee; color: #c62828; }
  .scene-status-badge.to-work { background: #fff3e0; color: #e65100; }
  .scene-status-badge.verified { background: #e8f5e9; color: #2e7d32; }
  .scene-status-dropdown { position: fixed; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; min-width: 140px; overflow: visible; display: none; }
  .scene-status-dropdown.visible { display: block; }
  .scene-status-option { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
  .scene-status-option:hover { background: var(--bg); }
  .scene-status-option .status-dot { width: 8px; height: 8px; border-radius: 50%; }
  .scene-status-option .status-dot.not-verified { background: #ef5350; }
  .scene-status-option .status-dot.to-work { background: #ff9800; }
  .scene-status-option .status-dot.verified { background: #4caf50; }

  /* Autocompl√©tion adresse */
  .address-autocomplete-container { position: relative; }
  .address-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .address-suggestions.visible { display: block; }
  .address-suggestion { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
  .address-suggestion:last-child { border-bottom: none; }
  .address-suggestion:hover { background: var(--primary-light, #e3f2fd); }
  .address-suggestion-main { font-weight: 500; }
  .address-suggestion-secondary { font-size: 0.8rem; color: var(--text-sec); margin-top: 2px; }
  .address-minimap { width: 100%; height: 150px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border); }
  
  /* M√©t√©o et Carte dans Feuille de Service */
  .fds-weather-card { display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: center; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px; margin-bottom: 15px; }
  body.dark-mode .fds-weather-card { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); }
  .fds-weather-icon { font-size: 3rem; }
  .fds-weather-main { display: flex; flex-direction: column; gap: 4px; }
  .fds-weather-temp { font-size: 2rem; font-weight: bold; }
  .fds-weather-desc { font-size: 1rem; color: var(--text-sec); text-transform: capitalize; }
  .fds-weather-details { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; text-align: right; }
  .fds-weather-row { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
  .fds-weather-item { display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: rgba(255,255,255,0.5); border-radius: 20px; font-size: 0.85rem; }
  body.dark-mode .fds-weather-item { background: rgba(0,0,0,0.3); }
  .fds-map-container { height: 200px; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 1px solid var(--border); }
  .fds-location-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
  .fds-gmaps-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: #4285f4; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; transition: all 0.2s; }
  .fds-gmaps-btn:hover { background: #3367d6; transform: translateY(-1px); }
  .fds-weather-loading { padding: 20px; text-align: center; color: var(--text-sec); }
  .fds-sun-times { display: flex; gap: 20px; margin-top: 8px; font-size: 0.9rem; }
  .fds-sun-item { display: flex; align-items: center; gap: 5px; }

  .profile-type-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 20px 15px; background: var(--bg); border: 2px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
  .profile-type-card:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); transform: translateY(-2px); }
  .profile-type-card:has(input:checked) { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
  .profile-type-icon { font-size: 2.5rem; }
  .profile-type-name { font-weight: 600; font-size: 0.95rem; text-align: center; }
  .profile-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
  .profile-row.two-cols { grid-template-columns: repeat(2, 1fr); }
  .profile-row.three-cols { grid-template-columns: repeat(3, 1fr); }
  .profile-row > * { width: 100%; }
  .profile-input { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.95rem; background: var(--input-bg); color: var(--text-main); width: 100%; }
  .profile-input:focus { outline: none; border-color: var(--primary); }
  .profile-textarea { min-height: 100px; resize: vertical; }
  .profile-photo-section { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
  .profile-photo-preview { width: 120px; height: 120px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; overflow: hidden; border: 3px solid var(--border); }
  .profile-photo-preview img { width: 100%; height: 100%; object-fit: cover; }
  .profile-status { padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; }
  .profile-status.incomplete { background: rgba(255,150,0,0.1); border: 1px solid orange; color: orange; }
  .profile-status.complete { background: rgba(40,167,69,0.1); border: 1px solid var(--success); color: var(--success); }
  .equipment-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
  .equipment-tag { background: var(--bg); border: 1px solid var(--border); padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
  .equipment-tag .remove { cursor: pointer; color: var(--danger); }

/* Cartes profils avec badges projets */
.profile-tab-card { display: flex; flex-direction: column; gap: 8px; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; min-width: 150px; }
.profile-tab-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); }
.profile-tab-card.active { background: var(--primary); color: white; border-color: var(--primary); }
.profile-tab-card.active .profile-project-badge { background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3); }
.profile-tab-card.add-profile { border: 2px dashed var(--primary); background: transparent; color: var(--primary); justify-content: center; align-items: center; }
.profile-tab-card.add-profile:hover { background: rgba(43, 110, 246, 0.1); }
.profile-tab-header { font-weight: 600; font-size: 0.95rem; }
.profile-project-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 4px; }
.profile-project-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; font-size: 0.75rem; color: var(--text-sec); cursor: pointer; transition: all 0.2s; white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
.profile-project-badge:hover { background: var(--primary); color: white; border-color: var(--primary); }

/* Responsive profils */
  @media (max-width: 600px) { .profile-row { grid-template-columns: 1fr; } .profile-row.two-cols, .profile-row.three-cols { grid-template-columns: 1fr; } }

  /* Recherche Globale */
  .global-search-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: flex-start; padding-top: 50px; z-index: 10000; overflow-y: auto; }
  .global-search-container { background: var(--panel-bg); border-radius: 12px; width: 95%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; margin-bottom: 50px; }
  .global-search-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .global-search-header h2 { margin: 0; }
  .global-search-filters { padding: 15px 20px; border-bottom: 1px solid var(--border); background: var(--bg); }
  .global-search-filters-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  .global-search-filters-row:last-child { margin-bottom: 0; }
  .global-search-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); }
  .global-search-results { flex: 1; overflow-y: auto; padding: 20px; }
  .global-search-results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
  .global-search-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; transition: border-color 0.2s; }
  .global-search-card:hover { border-color: var(--primary); }
  .global-search-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
  .global-search-card-photo { width: 60px; height: 60px; border-radius: 50%; background: var(--panel-bg); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; overflow: hidden; }
  .global-search-card-photo img { width: 100%; height: 100%; object-fit: cover; }
  .global-search-card-name { font-weight: bold; font-size: 1rem; }
  .global-search-card-meta { font-size: 0.85rem; color: var(--text-sec); }
  .global-search-card-details { font-size: 0.85rem; color: var(--text-sec); margin-top: 8px; }
  .global-search-card-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
  .global-search-card-tag { background: var(--panel-bg); padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; }
  .global-search-card-actions { margin-top: 12px; display: flex; gap: 8px; }
  .global-search-card-actions button { flex: 1; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 500; }
  .global-search-empty { text-align: center; padding: 40px; color: var(--text-sec); }
  .global-search-loading { text-align: center; padding: 40px; color: var(--text-sec); }

  /* Permissions */
  .permissions-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: flex-start; padding-top: 30px; z-index: 10000; overflow-y: auto; }
  .permissions-container { background: var(--panel-bg); border-radius: 12px; width: 95%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; margin-bottom: 30px; }
  .permissions-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .permissions-header h2 { margin: 0; }
  .permissions-body { flex: 1; overflow-y: auto; padding: 20px; }
  .permissions-section { margin-bottom: 25px; }
  .permissions-section h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); font-size: 1rem; }
  .permissions-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .permissions-table th, .permissions-table td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border); }
  .permissions-table th:first-child, .permissions-table td:first-child { text-align: left; }
  .permissions-table th { background: var(--bg); font-weight: 600; position: sticky; top: 0; }
  .permissions-table tr:hover { background: var(--bg); }
  .permissions-user-info { display: flex; align-items: center; gap: 10px; }
  .permissions-user-photo { width: 32px; height: 32px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; overflow: hidden; }
  .permissions-user-photo img { width: 100%; height: 100%; object-fit: cover; }
  .permissions-user-name { font-weight: 500; }
  .permissions-user-role { font-size: 0.75rem; color: var(--text-sec); }
  .perm-select { padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.8rem; cursor: pointer; }
  .perm-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
  .perm-badge.owner { background: #8b5cf6; color: white; }
  .perm-badge.write { background: var(--success); color: white; }
  .perm-badge.read { background: var(--primary); color: white; }
  .perm-badge.none { background: var(--border); color: var(--text-sec); }
  .permissions-presets { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
  .permissions-preset-btn { padding: 8px 15px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); cursor: pointer; font-size: 0.85rem; }
  .permissions-preset-btn:hover { border-color: var(--primary); background: var(--panel-bg); }
  .permissions-preset-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

  /* Chat */
  .chat-panel { position: fixed; bottom: 0; right: 20px; width: 380px; height: 500px; background: var(--panel-bg); border: 1px solid var(--border); border-bottom: none; border-radius: 12px 12px 0 0; display: flex; flex-direction: column; z-index: 9000; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); transition: transform 0.3s ease; }
  .chat-panel.minimized { transform: translateY(calc(100% - 45px)); }
  .chat-header { background: var(--primary); color: white; padding: 12px 15px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  .chat-header h3 { margin: 0; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
  .chat-header-actions { display: flex; gap: 8px; }
  .chat-header-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; }
  .chat-header-btn:hover { background: rgba(255,255,255,0.3); }
  .chat-tabs { display: flex; background: var(--bg); border-bottom: 1px solid var(--border); overflow-x: auto; flex-shrink: 0; }
  .chat-tab { padding: 10px 12px; font-size: 0.8rem; cursor: pointer; white-space: nowrap; border-bottom: 2px solid transparent; color: var(--text-sec); position: relative; }
  .chat-tab:hover { background: var(--panel-bg); }
  .chat-tab.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--panel-bg); }
  .chat-tab .unread-badge { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 10px; min-width: 16px; text-align: center; }
  .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
  .chat-message { max-width: 85%; padding: 10px 12px; border-radius: 12px; font-size: 0.85rem; line-height: 1.4; }
  .chat-message.own { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
  .chat-message.other { align-self: flex-start; background: var(--bg); color: var(--text-main); border-bottom-left-radius: 4px; }
  .chat-message-sender { font-weight: 600; font-size: 0.75rem; margin-bottom: 4px; opacity: 0.8; }
  .chat-message-time { font-size: 0.7rem; opacity: 0.6; margin-top: 4px; text-align: right; }
  .chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
  .chat-input { flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-main); resize: none; }
  .chat-input:focus { outline: none; border-color: var(--primary); }
  .chat-send-btn { background: var(--primary); color: white; border: none; width: 38px; height: 38px; border-radius: 50%; cursor: pointer; font-size: 1rem; }
  .chat-send-btn:hover { opacity: 0.9; }
  .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .chat-empty { text-align: center; color: var(--text-sec); padding: 40px 20px; font-size: 0.9rem; }
  .chat-date-separator { text-align: center; font-size: 0.75rem; color: var(--text-sec); margin: 10px 0; padding: 5px; background: var(--bg); border-radius: 10px; }
  .chat-typing { font-size: 0.8rem; color: var(--text-sec); font-style: italic; padding: 5px 15px; }
  .chat-members-modal { position: absolute; bottom: 100%; right: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; width: 280px; max-height: 300px; overflow-y: auto; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
  .chat-member-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; }
  .chat-member-item:hover { background: var(--bg); }
  .chat-member-item.selected { background: rgba(43, 110, 246, 0.1); }
  .chat-member-photo { width: 32px; height: 32px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; overflow: hidden; }
  .chat-member-photo img { width: 100%; height: 100%; object-fit: cover; }
  .chat-floating-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(43, 110, 246, 0.4); z-index: 8999; display: none; }
  .chat-floating-btn:hover { transform: scale(1.05); }
  .chat-floating-btn .unread-total { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 0.75rem; padding: 3px 8px; border-radius: 12px; min-width: 20px; }
  
  .new-project-card { border: 2px dashed var(--border); border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; min-height: 200px; background: rgba(128,128,128,0.05); color: var(--text-sec); transition: all 0.2s; }
  .new-project-card:hover { border-color: var(--primary); color: var(--primary); background: var(--panel-bg); }
  .p-btn-priority { background: none; border: none; cursor: pointer; font-size: 1rem; padding: 5px; border-radius: 4px; transition: background 0.2s; }
  .p-btn-priority:hover { background: var(--bg); }
  
  .import-card { border: 2px dashed var(--success); background: rgba(40, 167, 69, 0.05); color: var(--success); }
  .import-card:hover { background: var(--panel-bg); border-color: var(--success); color: var(--success); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

  .project-card { background: var(--panel-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: space-between; min-height: 200px; cursor: pointer; position: relative; transition: transform 0.3s ease, border-color 0.2s, opacity 0.2s, margin 0.3s ease; }
  .project-card:hover { transform: translateY(-3px); border-color: var(--primary); }
  .project-card.dragging { opacity: 0.4; transform: scale(0.9) rotate(2deg); box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100; }
  .project-card.drag-over { border: 2px dashed var(--primary); transform: translateX(15px); margin-left: 15px; }
  .project-card.drag-over-left { transform: translateX(-15px); margin-right: 15px; }
  .priority-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; margin-left: 10px; vertical-align: middle; }
  .priority-badge.principal { background: #4CAF50; color: white; }
  .priority-badge.secondaire { background: #2196F3; color: white; }
  .priority-badge.en-attente { background: #9E9E9E; color: white; }
  .priority-badge.urgent { background: #f44336; color: white; animation: pulse-urgent 1s infinite; }
  .priority-badge.archive { background: #795548; color: white; }
  .priority-badge.une-id√©e { background: #FFEB3B; color: #333; }
  .priority-badge.je-sais-pas-trop { background: #9C27B0; color: white; }
  @keyframes pulse-urgent { 0%, 100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); } 50% { box-shadow: 0 0 0 6px rgba(244, 67, 54, 0); } }
  .priority-menu { position: absolute; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 15px var(--shadow); z-index: 1000; min-width: 150px; overflow: hidden; }
  .priority-menu-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }
  .priority-menu-item:hover { background: var(--bg); }
  .priority-menu-item .dot { width: 10px; height: 10px; border-radius: 50%; }
  .p-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; color: var(--text-main); }
  .p-meta { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px; }
  .p-role-badge { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--bg); border: 1px solid var(--border); text-transform: uppercase; }
  .p-actions { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
  .p-btn-del { background: none; border: none; color: var(--text-sec); cursor: pointer; font-size: 1.2rem; }
  .p-btn-del:hover { color: var(--danger); }

  /* --- APP HEADER & QUICK NAV --- */
  #app-view { display: none; flex-direction: column; height: 100%; width: 100%; }
  header { background: var(--panel-bg); border-bottom: 1px solid var(--border); padding: 10px 20px; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-justify-content: space-between; justify-content: space-between; -webkit-align-items: center; align-items: center; -webkit-flex-shrink: 0; flex-shrink: 0; }
  
  #quick-nav {
      position: fixed;
      top: 130px;
      right: 0;
      bottom: 0;
      width: 40px;
      background: var(--panel-bg);
      border-left: 1px solid var(--border);
      z-index: 900;
      display: none;
      flex-direction: column;
      align-items: center;
      padding-top: 10px;
      overflow-y: auto;
      scrollbar-width: none; 
  }
  #quick-nav::-webkit-scrollbar { display: none; }
  /* D√©placer quick-nav √† gauche quand les onglets sont √† droite */
  body.tabs-right #quick-nav {
      right: auto;
      left: 0;
      border-left: none;
      border-right: 1px solid var(--border);
  }
  /* Ajuster quick-nav quand les onglets sont √† gauche (d√©caler apr√®s la barre d'onglets) */
  body.tabs-left #quick-nav {
      right: 0;
      left: auto;
  }
  .qn-link {
      font-size: 0.7rem;
      color: var(--text-sec);
      text-decoration: none;
      margin-bottom: 8px;
      cursor: pointer;
      font-weight: bold;
      padding: 2px;
  }
  .qn-link:hover { color: var(--primary); transform: scale(1.2); }

  .project-info { display: flex; align-items: center; gap: 10px; }
  header input { font-size: 1.1rem; font-weight: bold; border: 1px solid transparent; padding: 4px; border-radius: 4px; background: transparent; color: var(--text-main); }
  header input:hover { border-color: var(--border); }
  .global-actions button, .theme-btn { font-size: 0.85rem; padding: 6px 10px; margin-left: 5px; cursor: pointer; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); display: inline-flex; align-items: center; gap: 5px; }
  .menu-dropdown-container { position: relative; display: inline-block; }
  .menu-dropdown-btn { font-size: 0.85rem; padding: 8px 12px; cursor: pointer; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); display: inline-flex; align-items: center; gap: 5px; }
  .menu-dropdown-btn:hover { background: var(--bg); }
  .menu-dropdown-separator { height: 1px; background: var(--border); margin: 5px 0; }
  .menu-dropdown-label { font-size: 0.75rem; font-weight: 600; color: var(--text-sec); padding: 8px 15px 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .menu-dropdown { display: none; position: absolute; top: 100%; left: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); min-width: 180px; z-index: 10000; overflow: hidden; margin-top: 5px; }
  .menu-dropdown.visible { display: block; }
  .menu-dropdown.align-right { left: auto; right: 0; }
  .menu-dropdown-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; transition: background 0.2s; }
  .menu-dropdown-item:hover { background: var(--bg); }
  .menu-dropdown-item.danger { color: var(--danger); }
  .menu-dropdown-item.danger:hover { background: #ffebee; }
  .global-actions button:hover { background: var(--bg); border-color: #bbb; }
  .presence-bar { display:flex; gap: -5px; margin-left:15px; }
  .presence-avatar { width:30px; height:30px; border-radius:50%; background:var(--primary); color:white; display:flex; justify-content:center; align-items:center; font-size:0.75rem; font-weight:bold; border:2px solid var(--panel-bg); cursor:help; text-transform:uppercase; }

  /* --- VERSION MANAGER STYLES (NEW V62) --- */
  .ver-list { max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 15px; }
  .ver-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); background: var(--panel-bg); }
  .ver-row:last-child { border-bottom: none; }
  .ver-info { display: flex; flex-direction: column; }
  .ver-name { font-weight: bold; font-size: 0.95rem; color: var(--text-main); }
  .ver-date { font-size: 0.75rem; color: var(--text-sec); }
  .ver-actions button { font-size: 0.8rem; padding: 4px 8px; margin-left: 5px; cursor: pointer; }
  
  /* --- TABS --- */
  .tabs-mode-selector { display: flex; justify-content: flex-end; align-items: center; gap: 10px; padding: 5px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--border); font-size: 0.8rem; color: var(--text-sec); }
  .tabs-mode-selector label { display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 4px 10px; border-radius: 4px; transition: background 0.2s; }
  .tabs-mode-selector label:hover { background: var(--bg); }
  .tabs-mode-selector input[type="radio"] { cursor: pointer; }
  .tabs-reset-order-btn { padding: 4px 10px; font-size: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text-sec); transition: all 0.2s; }
  .tabs-reset-order-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
  .tabs-mode-selector .mode-separator { width: 1px; height: 20px; background: var(--border); margin: 0 5px; }
  
  /* Navigation √† 2 niveaux - Cat√©gories */
  .tabs-categories { display: none; background: var(--bg); border-bottom: 1px solid var(--border); padding: 0 20px; gap: 0; flex-shrink: 0; justify-content: center; }
  .tabs-categories.active { display: flex; }
  .tab-category { padding: 12px 24px; cursor: pointer; font-weight: 600; color: var(--text-sec); border: none; background: none; border-bottom: 3px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
  .tab-category:hover { color: var(--text-main); background: var(--panel-bg); }
  .tab-category.active { color: var(--primary); border-bottom-color: var(--primary); background: var(--panel-bg); }
  .tab-category-icon { font-size: 1.1rem; }
  
  /* Sous-navigation des cat√©gories */
  .tabs-subnav { display: none; background: var(--panel-bg); border-bottom: 1px solid var(--border); padding: 0 20px; gap: 5px; flex-shrink: 0; overflow-x: auto; justify-content: center; }
  .tabs-subnav.active { display: flex; }
  .tab-subbtn { padding: 10px 22px 10px 16px; cursor: pointer; font-weight: 500; color: var(--text-sec); border-bottom: 2px solid transparent; user-select: none; white-space: nowrap; transition: all 0.2s; font-size: 0.85rem; background: none; border-top: none; border-left: none; border-right: none; position: relative; }
  .tab-subbtn:hover { color: var(--text-main); background: var(--bg); }
  .tab-subbtn.active { color: var(--primary); border-bottom-color: var(--primary); }
  
  .tabs-nav { display: -webkit-box; display: -webkit-flex; display: flex; background: var(--panel-bg); border-bottom: 1px solid var(--border); padding: 0 20px; gap: 20px; -webkit-flex-shrink: 0; flex-shrink: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .tabs-nav.hidden-by-categories { display: none; }
  .tab-btn { padding: 12px 15px; cursor: pointer; font-weight: 600; color: var(--text-sec); border-bottom: 3px solid transparent; user-select: none; white-space: nowrap; transition: all 0.3s ease; }
  .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(43, 110, 246, 0.05); }
  .tab-btn.dragging { opacity: 0.5; transform: scale(0.95); }
  .tab-btn.drag-over { border-left: 3px solid var(--primary); }
  
  /* Mode B : Adaptatif */
  .tabs-nav.adaptive { overflow-x: hidden; gap: 2px; }
  .tabs-nav.adaptive .tab-btn { flex: 1; min-width: 0; padding: 12px 5px; font-size: 0.7rem; text-align: center; overflow: hidden; text-overflow: ellipsis; transition: all 0.2s ease; }
  .tabs-nav.adaptive .tab-btn:hover { flex: 3; font-size: 0.85rem; background: rgba(43, 110, 246, 0.08); z-index: 10; }
  .tabs-nav.adaptive .tab-btn.active { flex: 2; font-size: 0.85rem; }
  .tabs-nav.adaptive .tab-btn.active:hover { flex: 3; }
  
  /* Positions des onglets (haut par d√©faut) */
  .tabs-nav.position-top { flex-direction: row; border-bottom: 1px solid var(--border); border-right: none; position: relative; height: auto; width: 100%; }
  .tabs-nav.position-bottom { flex-direction: row; border-top: 1px solid var(--border); border-bottom: none; position: fixed; bottom: 0; left: 0; right: 0; height: auto; width: 100%; z-index: 1000; background: var(--panel-bg); }
  .tabs-nav.position-left, .tabs-nav.position-right { 
    flex-direction: column; 
    width: 180px; 
    min-width: 180px;
    max-width: 180px;
    height: calc(100vh - 60px);
    overflow-y: auto; 
    overflow-x: hidden;
    border-bottom: none;
    position: fixed;
    top: 60px;
    z-index: 1000;
    padding: 10px 0;
    gap: 2px;
    background: var(--panel-bg);
  }
  .tabs-nav.position-left { left: 0; border-right: 1px solid var(--border); }
  .tabs-nav.position-right { right: 0; border-left: 1px solid var(--border); }
  .tabs-nav.position-left .tab-btn, .tabs-nav.position-right .tab-btn {
    flex: none;
    width: 100%;
    padding: 12px 15px;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    border-bottom: none;
    border-left: 3px solid transparent;
    font-size: 0.8rem;
  }
  .tabs-nav.position-left .tab-btn.active, .tabs-nav.position-right .tab-btn.active {
    border-bottom: none;
    border-left-color: var(--primary);
    background: rgba(43, 110, 246, 0.1);
    border-radius: 0;
  }
  .tabs-nav.position-left .tab-btn, .tabs-nav.position-right .tab-btn {
    border-radius: 0;
  }
  .tabs-nav.position-left .tab-btn.drag-over, .tabs-nav.position-right .tab-btn.drag-over {
    border-left: 3px solid var(--primary);
    border-top: none;
  }
  /* Adaptatif sur positions verticales */
  .tabs-nav.adaptive.position-left .tab-btn, .tabs-nav.adaptive.position-right .tab-btn {
    font-size: 0.75rem;
    padding: 10px 12px;
  }
  .tabs-nav.adaptive.position-left .tab-btn.active, .tabs-nav.adaptive.position-right .tab-btn.active {
    font-size: 0.85rem;
    background: rgba(43, 110, 246, 0.15);
  }
  /* Ajustement du main pour les positions lat√©rales et bas */
  body.tabs-left main { margin-left: 180px; }
  body.tabs-right main { margin-right: 180px; }
  body.tabs-bottom main { margin-bottom: 50px; }
  body.tabs-left .tabs-mode-selector, body.tabs-right .tabs-mode-selector { padding-right: 200px; }
  /* Cacher les options de position quand en mode cat√©gories */
  body.nav-categories .tabs-mode-selector #classic-mode-options { display: none !important; }
  /* Masquer le toggle Masqu√©s en position verticale */
  .tabs-nav.position-left .tab-btn-hidden-toggle, .tabs-nav.position-right .tab-btn-hidden-toggle {
    width: 100%;
    text-align: left;
    padding: 10px 15px;
    border-left: 3px solid transparent;
  }
  /* Fix: Retirer le position fixed pour haut */
  .tabs-nav.position-top.adaptive, .tabs-nav.position-top:not(.adaptive) { position: relative; top: auto; left: auto; right: auto; }
  
  /* Menu contextuel couleur onglets */
  .tab-color-menu { position: fixed; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; display: none; }
  .tab-color-menu.visible { display: block; }
  .tab-color-menu-title { font-size: 0.8rem; font-weight: 600; margin-bottom: 10px; color: var(--text-sec); }
  .tab-color-options { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
  .tab-color-option { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
  .tab-color-option:hover { transform: scale(1.15); border-color: var(--text-main); }
  .tab-color-reset { margin-top: 10px; width: 100%; padding: 6px; font-size: 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; }
  .tab-color-reset:hover { background: var(--border); }

/* Onglets masquables */
.tab-btn { position: relative; padding-right: 25px; }
.tab-btn .tab-close { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; border-radius: 50%; background: transparent; border: none; color: var(--text-sec); font-size: 12px; cursor: pointer; opacity: 0; transition: all 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1; }
.tab-btn:hover .tab-close { opacity: 0.6; }
.tab-btn .tab-close:hover { opacity: 1; background: var(--danger); color: white; }
.tab-subbtn { position: relative; padding-right: 22px; }
.tab-subbtn .tab-close { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; border-radius: 50%; background: transparent; border: none; color: var(--text-sec); font-size: 10px; cursor: pointer; opacity: 0; transition: all 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1; }
.tab-subbtn:hover .tab-close { opacity: 0.6; }
.tab-subbtn .tab-close:hover { opacity: 1; background: var(--danger); color: white; }
.tab-subbtn[draggable="true"] { cursor: grab; }
.tab-subbtn[draggable="true"]:active { cursor: grabbing; }
.tab-subbtn.dragging { opacity: 0.5; transform: scale(0.95); }
.tab-subbtn.drag-over { border-left: 3px solid var(--primary); }
.tabs-subnav.drag-over-category { background: rgba(43, 110, 246, 0.1); border: 2px dashed var(--primary); }
.hidden-tabs-toggle-cat { padding: 6px 12px; background: var(--bg); border: 1px dashed var(--border); border-radius: 6px; cursor: pointer; font-size: 0.8rem; color: var(--text-sec); transition: all 0.2s; display: none; align-items: center; gap: 5px; }
.hidden-tabs-toggle-cat:hover { background: var(--panel-bg); border-color: var(--primary); }
.hidden-tabs-toggle-cat .hidden-count { background: var(--danger); color: white; border-radius: 10px; padding: 1px 6px; font-size: 0.7rem; margin-left: 3px; }
.tab-category { position: relative; padding-right: 28px; }
.tab-category .cat-close { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; border-radius: 50%; background: transparent; border: none; color: var(--text-sec); font-size: 11px; cursor: pointer; opacity: 0; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.tab-category:hover .cat-close { opacity: 0.6; }
.tab-category .cat-close:hover { opacity: 1; background: var(--danger); color: white; }
.tab-category[draggable="true"] { cursor: grab; }
.tab-category[draggable="true"]:active { cursor: grabbing; }
.tab-category.dragging { opacity: 0.5; transform: scale(0.95); }
.tab-category.drag-over { border-left: 3px solid var(--primary); }
.hidden-categories-toggle { padding: 12px 18px; cursor: pointer; font-weight: 600; color: var(--text-sec); border: none; background: none; border-bottom: 3px solid transparent; transition: all 0.2s; display: none; align-items: center; gap: 8px; font-size: 0.85rem; }
.hidden-categories-toggle:hover { color: var(--text-main); background: var(--panel-bg); }
.hidden-categories-toggle .hidden-count { background: var(--danger); color: white; border-radius: 10px; padding: 2px 8px; font-size: 0.7rem; }

/* Tooltips modernes - style uniforme - positionn√©s dynamiquement via JS */
[data-tooltip] { position: relative; }
[data-tooltip]:hover::after { 
    content: attr(data-tooltip); 
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: #1a1a1a; 
    color: #fff; 
    padding: 8px 12px; 
    border-radius: 6px; 
    font-size: 0.75rem; 
    font-weight: 400; 
    z-index: 100002; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.4); 
    max-width: 200px; 
    text-align: center; 
    line-height: 1.4; 
    white-space: normal; 
    pointer-events: none; 
    animation: tooltipFadeIn 0.15s ease;
}
[data-tooltip]:hover::before { content: ''; position: absolute; bottom: calc(100% + 2px); left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #1a1a1a; z-index: 100002; }
[data-tooltip-pos="bottom"]:hover::after { bottom: auto; top: calc(100% + 8px); }
[data-tooltip-pos="bottom"]:hover::before { bottom: auto; top: calc(100% + 2px); border-top-color: transparent; border-bottom-color: #1a1a1a; }
/* Tooltips sur les bords - s'adaptent automatiquement */
[data-tooltip-pos="left"]:hover::after { bottom: auto; top: 50%; left: auto; right: calc(100% + 10px); transform: translateY(-50%); }
[data-tooltip-pos="left"]:hover::before { bottom: auto; top: 50%; left: auto; right: calc(100% + 4px); transform: translateY(-50%); border-top-color: transparent; border-left-color: #1a1a1a; }
@keyframes tooltipFadeIn { from { opacity: 0; transform: translateX(-50%) translateY(4px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

/* Menu position dropdown */
.position-dropdown-menu { animation: fadeIn 0.15s ease; }
.position-menu-item:hover { background: var(--primary); color: white; }
.position-menu-item.active { background: rgba(43, 110, 246, 0.1); font-weight: 600; }
.position-menu-item.active::before { content: '‚úì '; }

  /* Modale de confirmation moderne */
  .confirm-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100001; animation: fadeIn 0.2s ease; }
  .confirm-modal-box { background: var(--panel-bg); border-radius: 16px; padding: 25px; max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: scaleIn 0.2s ease; }
  .confirm-modal-icon { font-size: 3rem; text-align: center; margin-bottom: 15px; }
  .confirm-modal-title { font-size: 1.2rem; font-weight: 700; text-align: center; margin-bottom: 10px; color: var(--text-main); }
  .confirm-modal-message { font-size: 0.95rem; text-align: center; color: var(--text-sec); margin-bottom: 20px; line-height: 1.5; white-space: pre-line; }
  .confirm-modal-input { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; background: var(--input-bg); color: var(--text-main); margin-bottom: 20px; transition: border-color 0.2s; }
  .confirm-modal-input:focus { outline: none; border-color: var(--primary); }
  .confirm-modal-buttons { display: flex; gap: 12px; justify-content: center; }
  .confirm-modal-btn { padding: 12px 24px; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; min-width: 100px; }
  .confirm-modal-btn.cancel { background: var(--bg); color: var(--text-main); border: 1px solid var(--border); }
  .confirm-modal-btn.cancel:hover { background: var(--border); }
  .confirm-modal-btn.confirm { background: var(--primary); color: white; }
  .confirm-modal-btn.confirm:hover { background: #1a5cd4; transform: translateY(-1px); }
  .confirm-modal-btn.danger { background: var(--danger); color: white; }
  .confirm-modal-btn.danger:hover { background: #cc3333; transform: translateY(-1px); }
  .confirm-modal-btn.success { background: var(--success); color: white; }
  .confirm-modal-btn.success:hover { background: #1e8e3e; transform: translateY(-1px); }
  @-webkit-keyframes scaleIn { from { -webkit-transform: scale(0.9); transform: scale(0.9); opacity: 0; } to { -webkit-transform: scale(1); transform: scale(1); opacity: 1; } }
  @keyframes scaleIn { from { -webkit-transform: scale(0.9); transform: scale(0.9); opacity: 0; } to { -webkit-transform: scale(1); transform: scale(1); opacity: 1; } }

/* √âditeur Synopsis simple */
.synopsis-editor-wrapper { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.synopsis-toolbar { display: flex; gap: 5px; padding: 8px 12px; background: var(--bg); border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center; }
.synopsis-toolbar-btn { padding: 5px 10px; border: 1px solid var(--border); background: var(--panel-bg); color: var(--text-main); border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: all 0.15s; }
.synopsis-toolbar-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
.synopsis-toolbar-sep { width: 1px; height: 20px; background: var(--border); margin: 0 5px; }
.synopsis-editor-box { min-height: 300px; padding: 15px; font-size: 0.95rem; line-height: 1.7; background: var(--panel-bg); }
.synopsis-editor-box:focus { outline: none; }
.synopsis-editor-box [data-type="t1"] { font-size: 1.3rem; font-weight: 700; color: var(--primary); margin: 15px 0 10px; }
.synopsis-editor-box [data-type="t2"] { font-size: 1.15rem; font-weight: 600; color: var(--text-main); margin: 12px 0 8px; }
.synopsis-editor-box [data-type="t3"] { font-size: 1.05rem; font-weight: 600; color: var(--text-main); margin: 10px 0 6px; }
.synopsis-editor-box [data-type="text"] { margin: 5px 0; }
.synopsis-editor-box div:empty::before { content: '√âcrivez ici...'; color: var(--text-sec); opacity: 0.5; }

/* √âtats vides engageants */
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; }
.empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.6; }
.empty-state-title { font-size: 1.3rem; font-weight: 600; color: var(--text-main); margin-bottom: 10px; }
.empty-state-desc { font-size: 0.95rem; color: var(--text-sec); margin-bottom: 25px; max-width: 400px; line-height: 1.5; }
.empty-state-btn { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
.empty-state-btn:hover { background: var(--primary-dark, #1a5cd4); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(43,110,246,0.3); }
.empty-state-tips { margin-top: 30px; padding: 15px 20px; background: var(--bg); border-radius: 8px; font-size: 0.85rem; color: var(--text-sec); }
.empty-state-tips strong { color: var(--text-main); }

/* Ressources */
.resources-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.resource-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; }
.resource-card:hover { box-shadow: 0 4px 15px var(--shadow); transform: translateY(-2px); }
.resource-card-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.resource-card-title { font-weight: 600; font-size: 1.1rem; color: var(--text-main); }
.resource-card-category { font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
.resource-card-category.accessoire { background: #e3f2fd; color: #1565c0; }
.resource-card-category.costume { background: #f3e5f5; color: #7b1fa2; }
.resource-card-category.vehicule { background: #fff3e0; color: #ef6c00; }
body.dark-mode .resource-card-category.accessoire { background: #1565c0; color: #e3f2fd; }
body.dark-mode .resource-card-category.costume { background: #7b1fa2; color: #f3e5f5; }
body.dark-mode .resource-card-category.vehicule { background: #ef6c00; color: #fff3e0; }
.resource-card-body { padding: 15px; }
.resource-card-photo { width: 100%; height: 150px; object-fit: cover; background: var(--bg); display: flex; align-items: center; justify-content: center; color: var(--text-sec); font-size: 3rem; }
.resource-card-photo img { width: 100%; height: 100%; object-fit: cover; }
.resource-card-desc { font-size: 0.9rem; color: var(--text-sec); margin: 10px 0; line-height: 1.4; }
.resource-card-info { font-size: 0.85rem; color: var(--text-sec); margin: 5px 0; }
.resource-card-info strong { color: var(--text-main); }
.resource-card-scenes { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
.resource-card-scene { font-size: 0.75rem; padding: 3px 8px; background: var(--bg); border-radius: 4px; color: var(--text-sec); }
.resource-card-actions { padding: 10px 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
.resource-card-actions button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
.res-filter-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--panel-bg); color: var(--text-main); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
.res-filter-btn:hover { background: var(--bg); }
.res-filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

.tabs-nav.adaptive .tab-btn { padding-right: 20px; }
.tabs-nav.adaptive .tab-btn .tab-close { right: 2px; width: 14px; height: 14px; font-size: 10px; }

/* Bouton onglets masqu√©s */
.tab-btn-hidden-toggle { padding: 12px 15px; cursor: pointer; font-weight: 600; color: var(--primary); border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.2s; background: none; border-left: 1px dashed var(--border); margin-left: auto; }
.tab-btn-hidden-toggle:hover { background: rgba(43, 110, 246, 0.1); }
.tab-btn-hidden-toggle .hidden-count { background: var(--danger); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }

/* Menu onglets masqu√©s */
.hidden-tabs-menu { position: fixed; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); z-index: 10001; min-width: 220px; display: none; }
.hidden-tabs-menu.visible { display: block; }
.hidden-tabs-menu-header { padding: 12px 15px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.85rem; color: var(--text-sec); display: flex; justify-content: space-between; align-items: center; }
.hidden-tabs-menu-header button { font-size: 0.75rem; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
.hidden-tabs-menu-header button:hover { background: var(--primary-dark, #1d4ed8); }
.hidden-tabs-menu-list { max-height: 300px; overflow-y: auto; }
.hidden-tabs-menu-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
.hidden-tabs-menu-item:hover { background: var(--bg); }
.hidden-tabs-menu-item span { flex: 1; }

/* Vue compacte des fiches (grille de cartes) */
.compact-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 10px 0; }
.compact-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
.compact-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
.compact-card-photo { width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 10px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 2rem; overflow: hidden; border: 3px solid var(--border); }
.compact-card-photo img { width: 100%; height: 100%; object-fit: cover; }
.compact-card-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.compact-card-role { font-size: 0.8rem; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.compact-card-badge { position: absolute; top: 8px; right: 8px; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: var(--primary); color: white; }
.compact-card-actions { position: absolute; top: 8px; left: 8px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; }
.compact-card:hover .compact-card-actions { opacity: 1; }
.compact-card-actions button { width: 26px; height: 26px; border-radius: 50%; border: none; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
.compact-card-actions .edit-btn { background: var(--primary); color: white; }
.compact-card-actions .delete-btn { background: var(--danger); color: white; }

/* Modal d'√©dition de fiche */
.card-edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10001; justify-content: center; align-items: center; padding: 20px; }
.card-edit-modal.visible { display: flex; }
.card-edit-modal-content { background: var(--panel-bg); border-radius: 12px; width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.card-edit-modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
.card-edit-modal-header h3 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
.card-edit-modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); padding: 5px; }
.card-edit-modal-close:hover { color: var(--danger); }
.card-edit-modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.card-edit-modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: var(--bg); }

/* Toggle vue compacte / d√©taill√©e */
.view-toggle-bar { display: flex; justify-content: flex-end; gap: 10px; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
.view-toggle-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--bg); border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-sec); transition: all 0.2s; }
.view-toggle-btn:hover { background: var(--panel-bg); }
.view-toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

/* Favoris */
.favorite-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 5px; transition: transform 0.2s; }
.favorite-btn:hover { transform: scale(1.2); }
.favorite-btn.active { color: #f59e0b; }
.favorites-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
.favorites-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
.favorite-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
.favorite-card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 4px 15px var(--shadow); }
.favorite-card-photo { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden; }
.favorite-card-photo img { width: 100%; height: 100%; object-fit: cover; }
.favorite-card-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 3px; }
.favorite-card-role { font-size: 0.75rem; color: var(--text-sec); }
.favorite-card-remove { position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 0.8rem; cursor: pointer; display: none; }
.favorite-card:hover .favorite-card-remove { display: block; }

/* ===== ANIMATIONS DE TRANSITION ===== */
/* Fade in g√©n√©ral */
@-webkit-keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  @keyframes progressShimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  /* ========== LOADING SCREEN - √âQUIPE DE TOURNAGE ========== */
  .loading-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    height: calc(var(--vh, 1vh) * 100);
    background: rgba(0, 0, 0, 0.9);
    display: none;
    -webkit-justify-content: center; justify-content: center;
    -webkit-align-items: center; align-items: center;
    z-index: 999999;
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
  }
  .loading-overlay.visible { display: -webkit-flex; display: flex; }
  
  .loading-box {
    background: var(--panel-bg);
    border-radius: 20px;
    padding: 30px 35px;
    text-align: center;
    box-shadow: 0 25px 80px rgba(0,0,0,0.6);
    max-width: 520px;
    width: 94%;
  }
  
  .loading-scene {
    height: 140px;
    position: relative;
    margin-bottom: 20px;
    overflow: hidden;
    border-radius: 14px;
    background: linear-gradient(180deg, 
      #6BB3E0 0%, 
      #87CEEB 30%,
      #B0D4E8 60%,
      #E8D4A8 75%,
      #C9A86C 85%,
      #8B7355 100%);
  }
  
  /* === SOL D√âFILANT === */
  .loading-ground {
    position: absolute;
    bottom: 0; left: 0;
    width: 400%;
    height: 22px;
    background: 
      repeating-linear-gradient(90deg,
        #5D4E37 0px, #5D4E37 6px,
        #6B5B45 6px, #6B5B45 12px,
        #4A3F2F 12px, #4A3F2F 18px,
        #7D6B52 18px, #7D6B52 24px,
        #5D4E37 24px, #5D4E37 30px,
        #8B7B62 30px, #8B7B62 36px
      );
    -webkit-animation: groundScroll 0.6s linear infinite;
    animation: groundScroll 0.6s linear infinite;
  }
  @-webkit-keyframes groundScroll {
    0% { -webkit-transform: translateX(0); }
    100% { -webkit-transform: translateX(-36px); }
  }
  @keyframes groundScroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-36px); }
  }

  /* === √âQUIPE DE TOURNAGE === */
  .loading-crew {
    position: absolute;
    bottom: 22px;
    left: 50%;
    -webkit-transform: translateX(-50%);
    transform: translateX(-50%);
    display: -webkit-flex; display: flex;
    -webkit-align-items: flex-end; align-items: flex-end;
    gap: 2px;
  }

  .pixel-person {
    position: relative;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    -webkit-animation: personBounce 0.25s steps(1) infinite;
    animation: personBounce 0.25s steps(1) infinite;
  }
  @-webkit-keyframes personBounce {
    0%, 100% { -webkit-transform: translateY(0); }
    50% { -webkit-transform: translateY(-4px); }
  }
  @keyframes personBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }

  /* ============================================
     üé§ PERCHMAN - Position 1 (tout √† gauche, en retard)
     Gilet fluo, perche folle, c√¢ble qui tra√Æne
     ============================================ */
  .pixel-perch {
    width: 40px;
    height: 70px;
    order: 1;
    margin-right: 20px;
    -webkit-animation: personBounceSlow 0.3s steps(1) infinite;
    animation: personBounceSlow 0.3s steps(1) infinite;
  }
  @-webkit-keyframes personBounceSlow {
    0%, 100% { -webkit-transform: translateY(0); }
    50% { -webkit-transform: translateY(-3px); }
  }
  @keyframes personBounceSlow {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }
  .pixel-perch-body {
    position: absolute;
    bottom: 0;
    left: 8px;
    width: 24px;
    height: 48px;
  }
  .pixel-perch-body::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #5D4037;
    left: 6px; top: 0;
    box-shadow:
      /* Cheveux √©bouriff√©s */
      4px 0 0 #5D4037, -2px 2px 0 #5D4037, 10px 2px 0 #5D4037,
      /* T√™te */
      2px 4px 0 #FFDAB9, 6px 4px 0 #FFDAB9, 10px 4px 0 #FFDAB9,
      2px 8px 0 #FFDAB9, 6px 8px 0 #FFDAB9, 10px 8px 0 #FFDAB9,
      6px 12px 0 #FFDAB9,
      /* Yeux fatigu√©s */
      4px 6px 0 #333, 10px 6px 0 #333,
      /* Gilet fluo s√©curit√© */
      -2px 16px 0 #AEEA00, 2px 16px 0 #AEEA00, 6px 16px 0 #AEEA00, 10px 16px 0 #AEEA00, 14px 16px 0 #AEEA00,
      0px 20px 0 #C6FF00, 4px 20px 0 #1a1a1a, 8px 20px 0 #1a1a1a, 12px 20px 0 #C6FF00,
      0px 24px 0 #AEEA00, 4px 24px 0 #AEEA00, 8px 24px 0 #AEEA00, 12px 24px 0 #AEEA00,
      2px 28px 0 #C6FF00, 6px 28px 0 #C6FF00, 10px 28px 0 #C6FF00,
      /* Pantalon cargo */
      2px 32px 0 #5D4037, 6px 32px 0 #5D4037, 10px 32px 0 #5D4037,
      0px 36px 0 #4E342E, 4px 36px 0 #4E342E, 8px 36px 0 #4E342E, 12px 36px 0 #4E342E,
      0px 40px 0 #3E2723, 12px 40px 0 #3E2723,
      /* Grosses boots */
      -2px 44px 0 #1a1a1a, 2px 44px 0 #1a1a1a, 6px 44px 0 #1a1a1a,
      10px 44px 0 #1a1a1a, 14px 44px 0 #1a1a1a;
  }
  /* Bras qui tient la perche en l'air */
  .pixel-perch-body::after {
    content: '';
    position: absolute;
    left: 16px; top: 14px;
    width: 4px; height: 12px;
    background: #FFDAB9;
    -webkit-transform: rotate(-30deg);
    transform: rotate(-30deg);
  }
  /* Perche */
  .pixel-perch-pole {
    position: absolute;
    left: 22px; top: -30px;
    width: 5px; height: 65px;
    background: linear-gradient(180deg, #888 0%, #666 50%, #444 100%);
    border-radius: 2px;
    -webkit-transform-origin: bottom center;
    transform-origin: bottom center;
    -webkit-animation: percheCrazy 0.35s ease-in-out infinite;
    animation: percheCrazy 0.35s ease-in-out infinite;
  }
  @-webkit-keyframes percheCrazy {
    0% { -webkit-transform: rotate(-20deg); }
    20% { -webkit-transform: rotate(25deg); }
    40% { -webkit-transform: rotate(-15deg); }
    60% { -webkit-transform: rotate(30deg); }
    80% { -webkit-transform: rotate(-25deg); }
    100% { -webkit-transform: rotate(-20deg); }
  }
  @keyframes percheCrazy {
    0% { transform: rotate(-20deg); }
    20% { transform: rotate(25deg); }
    40% { transform: rotate(-15deg); }
    60% { transform: rotate(30deg); }
    80% { transform: rotate(-25deg); }
    100% { transform: rotate(-20deg); }
  }
  /* Micro bonette */
  .pixel-perch-mic {
    position: absolute;
    left: 18px; top: -38px;
    width: 20px; height: 14px;
    background: linear-gradient(90deg, #333 0%, #555 50%, #333 100%);
    border-radius: 7px;
    -webkit-transform-origin: 8px 45px;
    transform-origin: 8px 45px;
    -webkit-animation: percheCrazy 0.35s ease-in-out infinite;
    animation: percheCrazy 0.35s ease-in-out infinite;
  }
  .pixel-perch-mic::before {
    content: '';
    position: absolute;
    width: 100%; height: 100%;
    background: repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px);
    border-radius: 7px;
  }

  

  /* ============================================
     üé≠ COM√âDIEN HOMME - Position 2
     Costume √©l√©gant
     ============================================ */
  .pixel-actor1 {
    width: 28px;
    height: 52px;
    order: 2;
  }
  .pixel-actor1::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #3E2723;
    left: 8px; top: 0;
    box-shadow:
      /* Cheveux coiff√©s */
      4px 0 0 #3E2723, 8px 0 0 #3E2723, 4px -2px 0 #3E2723,
      /* T√™te */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Yeux */
      6px 6px 0 #333, 12px 6px 0 #333,
      /* Sourire */
      8px 10px 0 #c97878,
      /* Veste costume gris */
      2px 16px 0 #455A64, 6px 16px 0 #455A64, 10px 16px 0 #455A64, 14px 16px 0 #455A64,
      0px 20px 0 #546E7A, 4px 20px 0 #37474F, 8px 20px 0 #ECEFF1, 12px 20px 0 #37474F, 16px 20px 0 #546E7A,
      2px 24px 0 #455A64, 6px 24px 0 #455A64, 10px 24px 0 #455A64, 14px 24px 0 #455A64,
      4px 28px 0 #37474F, 8px 28px 0 #37474F, 12px 28px 0 #37474F,
      /* Pantalon */
      4px 32px 0 #263238, 8px 32px 0 #263238, 12px 32px 0 #263238,
      2px 36px 0 #1C313A, 6px 36px 0 #1C313A, 10px 36px 0 #1C313A, 14px 36px 0 #1C313A,
      2px 40px 0 #263238, 14px 40px 0 #263238,
      /* Chaussures cir√©es */
      0px 44px 0 #1a1a1a, 4px 44px 0 #1a1a1a,
      12px 44px 0 #1a1a1a, 16px 44px 0 #1a1a1a;
  }

  /* ============================================
     üé≠ COM√âDIENNE FEMME - Position 3
     Robe √©l√©gante, talons
     ============================================ */
  .pixel-actor2 {
    width: 26px;
    height: 52px;
    order: 3;
  }
  .pixel-actor2::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #D4A574;
    left: 4px; top: -2px;
    box-shadow:
      /* Cheveux longs blonds */
      4px -2px 0 #D4A574, 8px 0px 0 #D4A574, 12px 0px 0 #D4A574,
      0px 2px 0 #D4A574, 14px 2px 0 #D4A574,
      0px 6px 0 #C49A6C, 14px 6px 0 #C49A6C,
      0px 10px 0 #D4A574, 16px 10px 0 #D4A574,
      /* T√™te */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Yeux maquill√©s */
      6px 6px 0 #1a1a1a, 12px 6px 0 #1a1a1a,
      /* L√®vres */
      8px 10px 0 #E91E63,
      /* Robe rouge √©l√©gante */
      4px 16px 0 #C62828, 8px 16px 0 #C62828, 12px 16px 0 #C62828,
      2px 20px 0 #D32F2F, 6px 20px 0 #B71C1C, 10px 20px 0 #B71C1C, 14px 20px 0 #D32F2F,
      0px 24px 0 #C62828, 4px 24px 0 #C62828, 8px 24px 0 #C62828, 12px 24px 0 #C62828, 16px 24px 0 #C62828,
      0px 28px 0 #B71C1C, 4px 28px 0 #B71C1C, 8px 28px 0 #B71C1C, 12px 28px 0 #B71C1C, 16px 28px 0 #B71C1C,
      2px 32px 0 #C62828, 6px 32px 0 #C62828, 10px 32px 0 #C62828, 14px 32px 0 #C62828,
      4px 36px 0 #D32F2F, 8px 36px 0 #D32F2F, 12px 36px 0 #D32F2F,
      /* Jambes */
      4px 40px 0 #FFDAB9, 12px 40px 0 #FFDAB9,
      /* Talons hauts */
      2px 44px 0 #1a1a1a, 6px 44px 0 #1a1a1a, 6px 46px 0 #1a1a1a,
      10px 44px 0 #1a1a1a, 14px 44px 0 #1a1a1a, 14px 46px 0 #1a1a1a;
  }

  /* ============================================
     üé• CAM√âRAMAN - Position 4
     Cam√©ra √©paule, casquette retourn√©e
     ============================================ */
  .pixel-camera {
    width: 44px;
    height: 52px;
    order: 4;
  }
  .pixel-camera::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #1a1a1a;
    left: 10px; top: 2px;
    box-shadow:
      /* Casquette retourn√©e */
      4px 0 0 #1a1a1a, 8px 0 0 #1a1a1a, -2px 2px 0 #333,
      /* T√™te */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Yeux concentr√©s */
      6px 6px 0 #333, 12px 6px 0 #333,
      /* Barbe 3 jours */
      4px 10px 0 #8D6E63, 8px 10px 0 #8D6E63, 12px 10px 0 #8D6E63,
      /* T-shirt noir technique */
      2px 16px 0 #212121, 6px 16px 0 #212121, 10px 16px 0 #212121, 14px 16px 0 #212121,
      0px 20px 0 #1a1a1a, 4px 20px 0 #1a1a1a, 8px 20px 0 #1a1a1a, 12px 20px 0 #1a1a1a, 16px 20px 0 #1a1a1a,
      2px 24px 0 #212121, 6px 24px 0 #212121, 10px 24px 0 #212121, 14px 24px 0 #212121,
      /* Bras vers cam√©ra */
      16px 16px 0 #FFDAB9, 20px 14px 0 #FFDAB9, 24px 12px 0 #FFDAB9,
      /* Pantalon cargo */
      4px 28px 0 #4E342E, 8px 28px 0 #4E342E, 12px 28px 0 #4E342E,
      2px 32px 0 #5D4037, 6px 32px 0 #5D4037, 10px 32px 0 #5D4037, 14px 32px 0 #5D4037,
      2px 36px 0 #4E342E, 14px 36px 0 #4E342E,
      /* Baskets */
      0px 40px 0 #F5F5F5, 4px 40px 0 #E0E0E0, 8px 40px 0 #2196F3,
      12px 40px 0 #F5F5F5, 16px 40px 0 #E0E0E0, 20px 40px 0 #2196F3;
  }
  /* Cam√©ra sur √©paule droite */
  .pixel-camera::after {
    content: '';
    position: absolute;
    right: 0px; top: 6px;
    width: 22px; height: 14px;
    background: linear-gradient(180deg, #1a1a1a 0%, #333 50%, #1a1a1a 100%);
    border-radius: 3px;
    box-shadow:
      /* Objectif */
      22px 3px 0 4px #263238,
      26px 5px 0 2px #1a1a1a,
      /* Viseur */
      -4px -4px 0 0 #333,
      /* Lumi√®re rouge REC */
      2px 2px 0 0 #f44336;
  }
  /* Lumi√®re REC clignotante */
  .pixel-camera-rec {
    position: absolute;
    right: 18px; top: 8px;
    width: 4px; height: 4px;
    background: #f44336;
    border-radius: 50%;
    -webkit-animation: recBlink 0.8s ease-in-out infinite;
    animation: recBlink 0.8s ease-in-out infinite;
  }
  @-webkit-keyframes recBlink {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px #f44336; }
    50% { opacity: 0.3; box-shadow: none; }
  }
  @keyframes recBlink {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px #f44336; }
    50% { opacity: 0.3; box-shadow: none; }
  }

  /* ============================================
     üìù SCRIPTE - Position 5
     Femme avec classeur, feuilles qui s'envolent
     ============================================ */
  .pixel-script {
    width: 32px;
    height: 52px;
    order: 5;
    position: relative;
  }
  .pixel-script::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #4E342E;
    left: 8px; top: -2px;
    box-shadow:
      /* Cheveux attach√©s chignon */
      4px -2px 0 #4E342E, 8px -2px 0 #4E342E,
      0px 2px 0 #5D4037, 12px 2px 0 #5D4037,
      14px 0px 0 #4E342E, 16px 2px 0 #4E342E,
      /* T√™te */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Lunettes */
      4px 6px 0 #1a1a1a, 6px 6px 0 #64B5F6, 10px 6px 0 #64B5F6, 12px 6px 0 #1a1a1a,
      /* Chemisier blanc */
      4px 16px 0 #FAFAFA, 8px 16px 0 #FAFAFA, 12px 16px 0 #FAFAFA,
      2px 20px 0 #F5F5F5, 6px 20px 0 #E0E0E0, 10px 20px 0 #E0E0E0, 14px 20px 0 #F5F5F5,
      4px 24px 0 #FAFAFA, 8px 24px 0 #FAFAFA, 12px 24px 0 #FAFAFA,
      /* Gilet gris */
      0px 18px 0 #757575, 16px 18px 0 #757575,
      0px 22px 0 #616161, 16px 22px 0 #616161,
      /* Jupe crayon */
      4px 28px 0 #1a1a1a, 8px 28px 0 #1a1a1a, 12px 28px 0 #1a1a1a,
      4px 32px 0 #212121, 8px 32px 0 #212121, 12px 32px 0 #212121,
      6px 36px 0 #1a1a1a, 10px 36px 0 #1a1a1a,
      /* Jambes */
      6px 40px 0 #FFDAB9, 10px 40px 0 #FFDAB9,
      /* Chaussures plates */
      4px 44px 0 #1a1a1a, 8px 44px 0 #1a1a1a,
      10px 44px 0 #1a1a1a, 14px 44px 0 #1a1a1a;
  }
  /* Classeur tenu devant */
  .pixel-script::after {
    content: '';
    position: absolute;
    left: -4px; top: 18px;
    width: 12px; height: 18px;
    background: linear-gradient(180deg, #ECEFF1 0%, #CFD8DC 100%);
    border: 2px solid #90A4AE;
    border-radius: 2px;
    box-shadow: inset 2px 0 0 #B0BEC5;
  }

  /* ============================================
     üé¨ R√âALISATEUR - Position 6 (tout √† droite, en t√™te)
     Casquette, lunettes, m√©gaphone
     ============================================ */
  .pixel-director {
    width: 40px;
    height: 52px;
    order: 6;
    margin-left: 4px;
  }
  .pixel-director::before {
    content: '';
    position: absolute;
    width: 4px; height: 4px;
    background: #1a1a1a;
    left: 6px; top: -2px;
    box-shadow:
      /* Casquette */
      4px -2px 0 #1a1a1a, 8px -2px 0 #1a1a1a, 12px -2px 0 #1a1a1a,
      0px 0px 0 #1a1a1a, 4px 0px 0 #212121, 8px 0px 0 #212121, 12px 0px 0 #212121, 16px 0px 0 #1a1a1a,
      /* Visi√®re */
      16px 2px 0 #1a1a1a, 20px 2px 0 #1a1a1a, 24px 4px 0 #1a1a1a,
      /* T√™te */
      4px 4px 0 #FFDAB9, 8px 4px 0 #FFDAB9, 12px 4px 0 #FFDAB9,
      4px 8px 0 #FFDAB9, 8px 8px 0 #FFDAB9, 12px 8px 0 #FFDAB9,
      8px 12px 0 #FFDAB9,
      /* Lunettes de soleil */
      4px 6px 0 #1a1a1a, 6px 6px 0 #1a1a1a, 10px 6px 0 #1a1a1a, 12px 6px 0 #1a1a1a,
      /* Barbe */
      6px 10px 0 #5D4037, 10px 10px 0 #5D4037,
      /* Veste cuir noir */
      2px 16px 0 #212121, 6px 16px 0 #212121, 10px 16px 0 #212121, 14px 16px 0 #212121,
      0px 20px 0 #1a1a1a, 4px 20px 0 #333, 8px 20px 0 #333, 12px 20px 0 #333, 16px 20px 0 #1a1a1a,
      2px 24px 0 #212121, 6px 24px 0 #212121, 10px 24px 0 #212121, 14px 24px 0 #212121,
      4px 28px 0 #1a1a1a, 8px 28px 0 #1a1a1a, 12px 28px 0 #1a1a1a,
      /* Jean */
      4px 32px 0 #1565C0, 8px 32px 0 #1565C0, 12px 32px 0 #1565C0,
      2px 36px 0 #0D47A1, 6px 36px 0 #0D47A1, 10px 36px 0 #0D47A1, 14px 36px 0 #0D47A1,
      2px 40px 0 #1565C0, 14px 40px 0 #1565C0,
      /* Boots */
      0px 44px 0 #3E2723, 4px 44px 0 #4E342E, 8px 44px 0 #3E2723,
      10px 44px 0 #3E2723, 14px 44px 0 #4E342E, 18px 44px 0 #3E2723;
  }
  /* Bras avec m√©gaphone */
  .pixel-director-arm {
    position: absolute;
    right: -8px; top: 14px;
    width: 8px; height: 4px;
    background: #FFDAB9;
  }
  /* M√©gaphone */
  .pixel-director-mega {
    position: absolute;
    right: -24px; top: 8px;
    width: 24px; height: 16px;
    background: linear-gradient(135deg, #FFC107 0%, #FF9800 50%, #F57C00 100%);
    clip-path: polygon(0% 25%, 0% 75%, 100% 100%, 100% 0%);
    -webkit-animation: megaShake 0.3s ease-in-out infinite;
    animation: megaShake 0.3s ease-in-out infinite;
  }
  @-webkit-keyframes megaShake {
    0%, 100% { -webkit-transform: rotate(-5deg); }
    50% { -webkit-transform: rotate(8deg); }
  }
  @keyframes megaShake {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(8deg); }
  }
  .pixel-director-mega::before {
    content: '';
    position: absolute;
    left: -4px; top: 4px;
    width: 6px; height: 8px;
    background: #E65100;
    border-radius: 2px;
  }
  /* Ondes sonores du m√©gaphone */
  .pixel-director-waves {
    position: absolute;
    right: -32px; top: 6px;
    width: 12px; height: 20px;
    opacity: 0.6;
    -webkit-animation: wavePulse 0.4s ease-out infinite;
    animation: wavePulse 0.4s ease-out infinite;
  }
  .pixel-director-waves::before,
  .pixel-director-waves::after {
    content: '';
    position: absolute;
    border: 2px solid #FF9800;
    border-left: none;
    border-radius: 0 50% 50% 0;
  }
  .pixel-director-waves::before {
    width: 6px; height: 12px;
    top: 4px; left: 0;
  }
  .pixel-director-waves::after {
    width: 10px; height: 18px;
    top: 1px; left: 2px;
  }
  @-webkit-keyframes wavePulse {
    0% { opacity: 0.8; -webkit-transform: scaleX(0.8); }
    100% { opacity: 0; -webkit-transform: scaleX(1.2); }
  }
  @keyframes wavePulse {
    0% { opacity: 0.8; transform: scaleX(0.8); }
    100% { opacity: 0; transform: scaleX(1.2); }
  }

  /* ============================================
     üìÑ FEUILLES QUI S'ENVOLENT (depuis la scripte vers la gauche)
     ============================================ */
  .loading-papers {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    overflow: hidden;
  }
  .flying-paper {
    position: absolute;
    width: 14px; height: 18px;
    background: linear-gradient(180deg, #FFFFFF 0%, #F5F5F5 100%);
    border: 1px solid #E0E0E0;
    border-radius: 1px;
    box-shadow: 1px 1px 3px rgba(0,0,0,0.15);
    /* D√©part depuis la scripte (position 5, vers la droite) */
    right: 28%; bottom: 55px;
    -webkit-animation: paperFlyLeft 2s ease-out infinite;
    animation: paperFlyLeft 2s ease-out infinite;
  }
  .flying-paper::before {
    content: '';
    position: absolute;
    top: 3px; left: 2px; right: 2px;
    height: 1px;
    background: #BDBDBD;
    box-shadow: 0 3px 0 #BDBDBD, 0 6px 0 #BDBDBD, 0 9px 0 #BDBDBD, 0 12px 0 #BDBDBD;
  }
  
  @-webkit-keyframes paperFlyLeft {
    0% { -webkit-transform: translate(0, 0) rotate(0deg) scale(1); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-120px, -80px) rotate(-400deg) scale(0.5); opacity: 0; }
  }
  @keyframes paperFlyLeft {
    0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-120px, -80px) rotate(-400deg) scale(0.5); opacity: 0; }
  }
  
  .flying-paper:nth-child(1) { -webkit-animation-delay: 0s; animation-delay: 0s; }
  .flying-paper:nth-child(2) { -webkit-animation-delay: 0.35s; animation-delay: 0.35s; -webkit-animation-name: paperFlyLeft2; animation-name: paperFlyLeft2; }
  .flying-paper:nth-child(3) { -webkit-animation-delay: 0.7s; animation-delay: 0.7s; -webkit-animation-name: paperFlyLeft3; animation-name: paperFlyLeft3; }
  .flying-paper:nth-child(4) { -webkit-animation-delay: 1.05s; animation-delay: 1.05s; -webkit-animation-name: paperFlyLeft4; animation-name: paperFlyLeft4; }
  .flying-paper:nth-child(5) { -webkit-animation-delay: 1.4s; animation-delay: 1.4s; -webkit-animation-name: paperFlyLeft5; animation-name: paperFlyLeft5; }
  .flying-paper:nth-child(6) { -webkit-animation-delay: 1.75s; animation-delay: 1.75s; }

  @-webkit-keyframes paperFlyLeft2 {
    0% { -webkit-transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-100px, -95px) rotate(350deg); opacity: 0; }
  }
  @keyframes paperFlyLeft2 {
    0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-100px, -95px) rotate(350deg); opacity: 0; }
  }
  @-webkit-keyframes paperFlyLeft3 {
    0% { -webkit-transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-140px, -60px) rotate(-300deg); opacity: 0; }
  }
  @keyframes paperFlyLeft3 {
    0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-140px, -60px) rotate(-300deg); opacity: 0; }
  }
  @-webkit-keyframes paperFlyLeft4 {
    0% { -webkit-transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-90px, -110px) rotate(420deg); opacity: 0; }
  }
  @keyframes paperFlyLeft4 {
    0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-90px, -110px) rotate(420deg); opacity: 0; }
  }
  @-webkit-keyframes paperFlyLeft5 {
    0% { -webkit-transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { -webkit-transform: translate(-130px, -75px) rotate(-480deg); opacity: 0; }
  }
  @keyframes paperFlyLeft5 {
    0% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
    8% { opacity: 1; }
    100% { transform: translate(-130px, -75px) rotate(-480deg); opacity: 0; }
  }

  /* ============================================
     TEXTE ET BARRE DE PROGRESSION
     ============================================ */
  .loading-clap {
    font-size: 2.2rem;
    margin-bottom: 10px;
    -webkit-animation: clapAnim 0.8s ease-in-out infinite;
    animation: clapAnim 0.8s ease-in-out infinite;
  }
  @-webkit-keyframes clapAnim {
    0%, 100% { -webkit-transform: scale(1) rotate(0deg); }
    25% { -webkit-transform: scale(1.15) rotate(-8deg); }
    75% { -webkit-transform: scale(1.05) rotate(4deg); }
  }
  @keyframes clapAnim {
    0%, 100% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.15) rotate(-8deg); }
    75% { transform: scale(1.05) rotate(4deg); }
  }
  .loading-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--text-main);
    margin-bottom: 6px;
  }
  .loading-message {
    font-size: 0.88rem;
    color: var(--text-sec);
    min-height: 20px;
    font-style: italic;
    -webkit-animation: messageFade 0.5s ease;
    animation: messageFade 0.5s ease;
  }
  @-webkit-keyframes messageFade {
    from { opacity: 0; -webkit-transform: translateY(8px); }
    to { opacity: 1; -webkit-transform: translateY(0); }
  }
  @keyframes messageFade {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .loading-progress {
    margin-top: 16px;
    height: 5px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }
  .loading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), #8b5cf6, #ec4899, var(--primary));
    background-size: 300% 100%;
    border-radius: 3px;
    -webkit-animation: progressShimmer 2s ease-in-out infinite;
    animation: progressShimmer 2s ease-in-out infinite;
    width: 30%;
    transition: width 0.3s ease;
  }
  @-webkit-keyframes progressShimmer {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
  }
  @keyframes progressShimmer {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
  }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
/* scaleIn d√©j√† d√©fini avec pr√©fixes webkit plus haut */
@keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }

/* Modales */
.profile-modal-overlay, .message-detail-modal, .global-search-modal, .permissions-modal { animation: fadeIn 0.2s ease; }
.profile-modal-box, .message-detail-box, .global-search-container, .permissions-container { animation: scaleIn 0.25s ease; }

/* Onglets contenu */
.tab-content.active { animation: fadeIn 0.3s ease; }

/* === MODE FOCUS (Plein √©cran onglet) === */
body.focus-mode header,
body.focus-mode .tabs-categories,
body.focus-mode .tabs-subnav,
body.focus-mode .tabs-nav,
body.focus-mode #quick-nav { display: none !important; }
body.focus-mode .tab-content { max-width: 100%; padding: 20px 40px 100px; }
body.focus-mode .tab-content.active { padding-top: 60px; }

.focus-toolbar { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: var(--panel-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.focus-toolbar-left { display: flex; align-items: center; gap: 10px; }
.focus-toolbar-center { display: flex; align-items: center; gap: 15px; }
.focus-toolbar-right { display: flex; align-items: center; gap: 10px; }
.focus-toolbar .focus-btn { padding: 8px 14px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
.focus-toolbar .focus-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
.focus-toolbar .focus-btn.nav-btn { padding: 8px 12px; font-size: 1.1rem; }
.focus-toolbar .focus-tab-title { font-weight: 600; font-size: 1rem; color: var(--text-main); }
.focus-toolbar .focus-project-title { font-size: 0.85rem; color: var(--text-sec); margin-left: 10px; }

/* Cards projet dashboard */
.project-card, .new-project-card { animation: slideUp 0.3s ease; }
.project-grid .project-card:nth-child(1) { animation-delay: 0.05s; }
.project-grid .project-card:nth-child(2) { animation-delay: 0.1s; }
.project-grid .project-card:nth-child(3) { animation-delay: 0.15s; }
.project-grid .project-card:nth-child(4) { animation-delay: 0.2s; }
.project-grid .project-card:nth-child(5) { animation-delay: 0.25s; }

/* Floating cards univers */
.floating-card { animation: scaleIn 0.3s ease; }

/* Contact cards */
.contact-card { animation: slideUp 0.3s ease; }

/* Messages */
.message-card { animation: slideInRight 0.3s ease; }

/* Favoris */
.favorite-card { animation: scaleIn 0.25s ease; }

/* Sidebar transitions */
.board-sidebar, .expenses-sidebar, .planning-sidebar { transition: transform 0.3s ease, opacity 0.3s ease; }

/* Boutons hover */
button, .tab-btn, .auth-btn { transition: all 0.2s ease; }

/* Inputs focus */
input, select, textarea { transition: border-color 0.2s ease, box-shadow 0.2s ease; }
input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(43, 110, 246, 0.15); }

/* Modal raccourcis clavier */
.shortcuts-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10002; animation: fadeIn 0.2s ease; }
.shortcuts-box { background: var(--panel-bg); border-radius: 12px; padding: 25px; max-width: 400px; width: 90%; animation: scaleIn 0.25s ease; }
.shortcuts-title { margin: 0 0 20px 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
.shortcuts-list { display: flex; flex-direction: column; gap: 12px; }
.shortcut-item { display: flex; justify-content: space-between; align-items: center; }
.shortcut-keys { display: flex; gap: 5px; }
.shortcut-key { background: var(--bg); border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; }
.shortcut-desc { color: var(--text-sec); font-size: 0.9rem; }
.shortcuts-close { margin-top: 20px; width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

  /* Mini calendrier disponibilit√©s */
  .availability-calendar { margin-top: 10px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
  .availability-calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .availability-calendar-header button { background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 5px 10px; cursor: pointer; }
  .availability-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
  .availability-calendar-day-header { text-align: center; font-size: 0.7rem; font-weight: bold; color: var(--text-sec); padding: 5px; }
  .availability-calendar-day { text-align: center; padding: 8px 4px; font-size: 0.75rem; border-radius: 4px; cursor: pointer; user-select: none; background: var(--bg); border: 1px solid transparent; }
  .availability-calendar-day:hover { background: var(--primary); color: white; }
  .availability-calendar-day.selected { background: var(--success); color: white; border-color: var(--success); }
  .availability-calendar-day.available { background: #4CAF50; color: white; border-color: #4CAF50; }
  .availability-calendar-day.unavailable { background: #f44336; color: white; border-color: #f44336; }
  .availability-calendar-day.shooting { background: #FF9800; color: white; border-color: #E65100; position: relative; }
  .availability-calendar-day.shooting::before { content: 'üé¨'; font-size: 0.5rem; position: absolute; top: 0; right: 1px; }
  .availability-calendar-day.empty { visibility: hidden; }
  .availability-calendar-day.today { border: 2px solid var(--primary); }

  main { -webkit-box-flex: 1; -webkit-flex-grow: 1; flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px; position: relative; padding-right: 50px; min-height: 0; }
 .tab-content { display: none; max-width: 1400px; margin: 0 auto; padding-bottom: 100px; }
  .tab-content.active { display: block; }

  input, textarea, select { padding: 8px; border: 1px solid var(--border); border-radius: 4px; width: 100%; font-family: inherit; background: var(--input-bg); color: var(--text-main); }
  input:focus, textarea:focus, select:focus { outline: 1px solid var(--primary); border-color: var(--primary); }

  /* --- SCRIPT EDITOR STYLES --- */
  .script-view { min-height: 100%; max-width: 1200px; margin: auto; padding-top: 15px; }
  .script-row { display: flex; border-bottom: 1px solid var(--border); padding: 20px 0; gap: 20px; transition: background 0.2s; position:relative; }
  .script-row.dragging { opacity: 0.5; background: var(--bg); }
  .script-info-col { width: 280px; flex-shrink: 0; background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.85rem; color: var(--text-sec); height: fit-content; cursor: context-menu; user-select: none; position: relative; border-left: 5px solid transparent; }
  .script-info-col:active { background: var(--highlight); }
  .script-info-col h3 { display:flex; align-items:center; gap:8px; }
  .script-sidebar-btns { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
  .script-sidebar-btns button { padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 0.8rem; text-align: left; transition: all 0.2s; color: var(--text-main); }
  .script-sidebar-btns button:hover { border-color: var(--primary); background: var(--panel-bg); }
  .scene-nav-indicator { margin: 0 10px; color: var(--text-sec); font-size: 0.85rem; font-weight: 600; }
  .script-write-col { flex-grow: 1; display: flex; flex-direction: column; position: relative; min-width: 0; overflow: hidden; }
  .format-bar { margin-bottom: 10px; display: -webkit-box; display: -webkit-flex; display: flex; gap: 5px; background: var(--bg); padding: 5px; border-radius: 4px; position: -webkit-sticky; position: sticky; top: 0; z-index: 10; -webkit-flex-wrap: nowrap; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid var(--border); }
  .format-bar > *:not(:last-child) { margin-right: 5px; } /* gap fallback */
  .fmt-btn { font-family: sans-serif; font-size: 0.75rem; padding: 6px 12px; cursor: pointer; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 3px; transition: all 0.2s; color: var(--text-main); }
  .fmt-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; }
  .script-editor-box { width: 100%; max-width: 650px; min-height: 300px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; padding: 40px 60px; font-family: 'Courier Prime', 'Courier New', Courier, monospace; font-size: 12pt; line-height: 1.0; outline: none; white-space: pre-wrap; overflow-wrap: break-word; word-wrap: break-word; cursor: text; color: var(--text-main); overflow-x: hidden; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  
  /* Format sc√©nario professionnel US */
  .sc-action { display: block; text-align: left; width: 100%; margin-top: 12pt; margin-bottom: 12pt; }
  .sc-perso { display: block; margin-top: 12pt; margin-bottom: 0; margin-left: 40%; text-transform: uppercase; font-weight: normal; }
  .sc-dial { display: block; margin-top: 0; margin-bottom: 0; margin-left: 15%; margin-right: 15%; }
  .sc-paren { display: block; margin-top: 0; margin-bottom: 0; margin-left: 25%; margin-right: 25%; }
  .sc-trans { display: block; text-align: right; text-transform: uppercase; margin-top: 12pt; margin-bottom: 12pt; margin-left: 55%; font-weight: normal; }
  .sc-note { display: block; margin-top: 12pt; margin-bottom: 12pt; margin-left: 15%; margin-right: 15%; color: var(--text-sec); font-style: italic; background: var(--bg); padding: 5px; border-radius: 4px; }
  .sc-general { display: block; text-align: left; width: 100%; margin-top: 12pt; margin-bottom: 12pt; font-style: italic; color: var(--text-sec); }
  .sc-centered { display: block; text-align: center; width: 100%; margin-top: 12pt; margin-bottom: 12pt; text-transform: uppercase; }

  /* --- VUE SCRIPT CONTINU --- */
  .script-unified-bar { position: sticky; top: 0; z-index: 150; }
  .script-unified-inner { display: flex; align-items: center; max-width: 1200px; margin: 0 auto; }
  .script-unified-left { display: inline-flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: 8px; }
  .script-unified-left .view-btn { padding: 8px 16px; border: none; background: transparent; color: var(--text-sec); cursor: pointer; border-radius: 6px; font-weight: 500; transition: all 0.2s; font-size: 0.85rem; }
  .script-unified-left .view-btn.active { background: var(--primary); color: white; }
  .script-unified-right { display: inline-flex; gap: 5px; margin-left: 175px; }
  .script-unified-right .fmt-btn { padding: 6px 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text-main); cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
  .script-unified-right .fmt-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
  .script-unified-right .fmt-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
  .scene-heading-print { display: none; }
  .script-write-col .scene-heading-print { display: block; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; padding-left: 130px; font-family: 'Courier Prime', 'Courier New', Courier, monospace; font-size: 12pt; color: var(--text-sec); }
  .script-continuous-wrapper { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; }
  .script-continuous-sidebar { width: 300px; -webkit-flex-shrink: 0; flex-shrink: 0; position: -webkit-sticky; position: sticky; top: 60px; height: -webkit-fit-content; height: fit-content; max-height: calc(100vh - 80px); max-height: calc(var(--vh, 1vh) * 100 - 80px); overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .script-continuous-sidebar .script-info-col { margin-bottom: 0; cursor: move; }
  .script-continuous-sidebar .script-info-col.dragging { opacity: 0.5; }
  .script-continuous-main { flex: 1; min-width: 0; overflow: visible; position: relative; }
  .script-continuous-editor { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 0 0 4px 4px; padding: 40px 60px; font-family: 'Courier Prime', 'Courier New', Courier, monospace; font-size: 12pt; line-height: 1.0; max-width: 650px; margin: 0 auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 80vh; overflow-x: hidden; overflow-wrap: break-word; word-wrap: break-word; }
  .script-continuous-scene { margin-bottom: 0; outline: none; position: relative; padding: 10px 0; border-left: 3px solid transparent; transition: border-color 0.2s, background 0.2s; }
  .script-continuous-scene.active { border-left-color: var(--primary); background: rgba(59, 130, 246, 0.03); }
  .script-continuous-scene.drag-over { border-left-color: var(--success); background: rgba(34, 197, 94, 0.1); }
  .script-continuous-scene .script-continuous-content { outline: none; overflow-wrap: break-word; word-wrap: break-word; }
  .script-continuous-heading { font-weight: bold; text-transform: uppercase; margin-bottom: 12pt; padding-bottom: 6pt; border-bottom: 1px solid var(--border); color: var(--text-main); cursor: grab; display: flex; align-items: center; }
  .script-continuous-heading:hover { color: var(--primary); }
  .script-continuous-heading:active { cursor: grabbing; }
  .script-continuous-heading .scene-title-text { flex: 1; }
  .script-continuous-heading .scene-title-text:hover { text-decoration: underline; cursor: text; }
  .script-continuous-scene-number { color: var(--text-sec); font-size: 0.9em; margin-right: 10px; cursor: grab; }

  /* --- VISUAL WIZARD STYLES --- */
  .wizard-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
  .wizard-header { width: 100%; max-width: 800px; background: var(--panel-bg); padding: 20px; border-radius: 8px 8px 0 0; text-align: center; border-bottom: 2px solid var(--primary); }
  .wizard-instruction { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
  .wizard-sub-text { font-size: 0.9rem; color: var(--text-sec); }
  
  .wizard-page-container { 
      width: 100%; max-width: 800px; height: 70vh; 
      background: white; color: black;
      overflow-y: auto; padding: 40px; 
      font-family: 'Courier Prime', 'Courier New', monospace; font-size: 14px; line-height: 1.2;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      cursor: text;
      user-select: text;
      position: relative;
  }
  
  .wiz-line { 
      white-space: pre-wrap; min-height: 16px; cursor: pointer; padding: 2px 0; border: 1px solid transparent; 
      transition: background 0.1s; position: relative;
  }
  .wiz-line:hover { background: rgba(43, 110, 246, 0.1); border-color: #ddd; }
  .wiz-line.selected-ref { background: rgba(40, 167, 69, 0.3) !important; border: 1px solid var(--success); }
  
  .wizard-footer {
      width: 100%; max-width: 800px; background: var(--panel-bg); padding: 15px;
      border-radius: 0 0 8px 8px; display: flex; justify-content: space-between; align-items: center;
  }
  
  .wiz-detail-box { 
      background: #f9f9f9; padding: 15px; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; display:none; 
      color: #333; text-align: left;
  }
  .wiz-detail-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;}
  .wiz-detail-val { font-weight:bold; font-family: monospace; color: var(--primary); }

  #cleanup-toast {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    padding: 10px 20px;
    border-radius: 30px;
    display: none;
    z-index: 10001;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    font-size: 0.9rem;
    font-weight: bold;
    white-space: nowrap;
    animation: fadeIn 0.2s;
  }
  #cleanup-toast:hover { background: var(--danger); }
  @keyframes fadeIn { from { opacity:0; transform:translateX(-50%) translateY(10px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }

  /* --- OTHER STYLES --- */
  .synopsis-section { margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
  .synopsis-container { display: flex; flex-direction: row; gap: 20px; height: 400px; overflow: hidden; }
  .synopsis-editor { flex: 3; display: flex; flex-direction: column; gap: 10px; height: 100%; }
  .synopsis-history { flex: 1; min-width: 250px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px; overflow-y: auto; height: 100%; }
  .synopsis-editor textarea { flex-grow: 1; padding: 15px; border-radius: 8px; border: 1px solid var(--border); font-family: inherit; line-height: 1.6; resize: none; font-size: 1rem; }
  
  .board-layout { display: flex; gap: 20px; }
  .board-sidebar { width: 30%; min-width: 250px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; overflow-y: auto; height: fit-content; max-height: 100%; }
  .sidebar-toggles { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
  .sidebar-content-block { margin-bottom: 20px; display: none; }
  .sidebar-content-block.visible { display: block; }
  .board-main { flex-grow: 1; overflow-y: auto; }
  
  .seq-header-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
  .seq-input-group { display: flex; gap: 5px; flex-grow: 1; align-items: center; }
  #inpPre { width: 100px; text-transform: uppercase; font-weight: bold; text-align: center; }
  #inpLoc { flex-grow: 1; text-transform: uppercase; font-weight: bold; }
  #inpSuff { width: 80px; text-transform: uppercase; font-weight: bold; text-align: center; }
  #inpTime { width: 80px; text-align: center; }
  .card { background: var(--panel-bg); border: 1px solid var(--border); border-left: 5px solid transparent; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 2px var(--shadow); position: relative; cursor: grab; transition: border-left-color 0.3s; }
  .card:active { cursor: grabbing; }
  .card h3 { margin: 0 0 5px; font-size: 1rem; color: var(--text-main); display:flex; align-items:center; gap:8px; }
  .card .meta { font-size: 0.8rem; color: var(--text-sec); font-style: italic; margin-bottom: 8px; }
  .card .resume-text { color: var(--text-main); white-space: pre-wrap; }
  .card-actions { position: absolute; top: 10px; right: 10px; }
  .card-actions button { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; padding: 4px 8px; cursor: pointer; color: var(--text-main); font-size: 0.9rem; }
  .card-actions button:hover { background: var(--bg); }

  .group-section { margin-bottom: 30px; }
  .group-header { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid var(--border); color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
  .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
  .data-card { background: var(--panel-bg); padding: 15px; border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; gap: 8px; }
  .data-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
  .data-desc { height: 80px; font-size: 0.9rem; resize: none; }
  .group-select { font-size: 0.8rem; padding: 4px; margin-top: 5px; border-radius: 4px; }
  .actor-link-select { font-size: 0.8rem; padding: 4px; border: 1px solid var(--border); border-radius: 4px; margin-top: 5px; width: 100%; background: var(--input-bg); color: var(--text-main); }
  .actor-input-row { display: flex; gap: 5px; }
  .actor-input { font-size: 0.85rem; padding: 5px; flex-grow: 1; }
  .actor-photo-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid var(--border); margin-right: 10px; }
  .actor-card-header { display: flex; align-items: center; }
  /* --- CREW STYLES --- */
.crew-card { background: var(--panel-bg); padding: 20px; border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; gap: 10px; }
.crew-card-header { display: flex; align-items: center; gap: 15px; }
.crew-photo-preview { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid var(--border); }
.crew-info-main { flex: 1; }
.crew-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 3px; }
.crew-role { color: var(--primary); font-size: 0.9rem; }
.crew-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.crew-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.crew-input { font-size: 0.85rem; padding: 8px; }
.crew-vehicle-section { background: var(--bg); padding: 15px; border-radius: 6px; margin-top: 10px; border: 1px solid var(--border); }
.crew-vehicle-toggle { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; }
.crew-vehicle-toggle input { width: 18px; height: 18px; }
.crew-vehicle-details { display: none; margin-top: 15px; }
.crew-vehicle-details.visible { display: block; }
.crew-rate-row { display: flex; gap: 10px; align-items: center; }
.crew-rate-amount { flex: 1; }
.crew-rate-currency { width: 70px; }
.crew-rate-type { width: 120px; }
.crew-availability-section { margin-top: 10px; }
.crew-calendar { margin-top: 10px; }
.crew-calendar input[type="date"] { padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); }

/* --- PLANNING STYLES --- */
.planning-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
  .planning-header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
  .planning-actions { display: flex; gap: 10px; flex-wrap: wrap; padding: 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; }
  .planning-action-btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: opacity 0.2s; }
  .planning-action-btn:hover { opacity: 0.85; }
  .planning-action-btn.primary { background: var(--primary); color: white; }
  .planning-action-btn.success { background: var(--success); color: white; }
  .planning-action-btn.secondary { background: var(--bg); color: var(--text-main); border: 1px solid var(--border); }
.planning-nav { display: flex; gap: 10px; align-items: center; }
.planning-nav-btn { padding: 8px 15px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: bold; }
.planning-nav-btn:hover { background: var(--bg); }
.planning-title { font-size: 1.5rem; font-weight: bold; min-width: 200px; text-align: center; }
.planning-view-toggle { display: flex; gap: 5px; }

/* Plan de travail */
/* Plan de travail - Style DOOD Pro */
.workplan-wrapper { background: white; color: #333; padding: 20px; border-radius: 8px; overflow-x: auto; }
.workplan-header-box { border: 2px solid #333; padding: 15px; margin-bottom: 20px; display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: center; }
.workplan-header-title { font-size: 1.4rem; font-weight: bold; text-transform: uppercase; }
.workplan-header-subtitle { font-size: 0.9rem; color: #666; }
.workplan-header-info { font-size: 0.85rem; line-height: 1.6; }
.workplan-header-version { text-align: right; font-size: 0.85rem; }
.workplan-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; background: white; }
.workplan-table th, .workplan-table td { border: 1px solid #999; padding: 4px 6px; text-align: center; vertical-align: middle; height: 28px; }
.workplan-table thead th { background: #f0f0f0; font-weight: 600; position: sticky; top: 0; z-index: 10; }
.workplan-table th.workplan-col-num { width: 30px; background: #e0e0e0; }
.workplan-table th.workplan-col-role { width: 120px; text-align: left; background: #e0e0e0; }
.workplan-table th.workplan-col-actor { width: 130px; text-align: left; background: #e0e0e0; }
.workplan-table th.workplan-col-day { min-width: 35px; max-width: 45px; font-size: 0.7rem; }
.workplan-table th.workplan-col-total { width: 40px; background: #e0e0e0; }
.workplan-table td.workplan-cell-num { background: #f5f5f5; font-weight: 600; }
.workplan-table td.workplan-cell-role { text-align: left; font-weight: 500; background: #fafafa; }
.workplan-table td.workplan-cell-actor { text-align: left; font-size: 0.7rem; color: #555; background: #fafafa; }
.workplan-table td.workplan-cell-total { background: #f5f5f5; font-weight: 600; }
.workplan-bar-T { background: #c0392b !important; color: white; font-weight: bold; }
.workplan-bar-SW { background: #c0392b !important; color: white; font-weight: bold; }
.workplan-bar-W { background: #c0392b !important; color: white; font-weight: bold; }
.workplan-bar-WF { background: #c0392b !important; color: white; font-weight: bold; }
.workplan-bar-H { background: #f39c12 !important; color: white; font-weight: bold; }
.workplan-bar-R { background: #3498db !important; color: white; font-weight: bold; }
.workplan-bar-V { background: #9b59b6 !important; color: white; font-weight: bold; }
.workplan-bar-empty { background: white; }
.workplan-section-row td { background: #d5d5d5 !important; font-weight: 600; text-align: left; font-size: 0.8rem; text-transform: uppercase; }
.workplan-footer { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 6px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px; }
.workplan-legend { display: flex; gap: 15px; flex-wrap: wrap; }
.workplan-legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #333; }
.workplan-legend-box { width: 24px; height: 18px; border: 1px solid #999; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
.workplan-actions { display: flex; gap: 10px; }
.workplan-actions button { padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
.workplan-actions button:hover { background: #2980b9; }
.workplan-empty { text-align: center; padding: 60px 20px; }
.workplan-empty-icon { font-size: 4rem; margin-bottom: 20px; }
.workplan-cell-menu { background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 120px; overflow: hidden; }
.workplan-menu-item { padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: #333; }
.workplan-menu-item:hover { background: #f0f0f0; }
.workplan-menu-divider { height: 1px; background: #e0e0e0; margin: 5px 0; }
@media print { .workplan-wrapper { padding: 0; } .workplan-actions { display: none; } .workplan-table { font-size: 0.65rem; } .workplan-table th, .workplan-table td { padding: 2px 4px; } }
.workplan-legend { display: flex; gap: 20px; margin-top: 15px; padding: 10px; background: var(--panel-bg); border-radius: 6px; flex-wrap: wrap; }
.workplan-legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; }
.workplan-legend-color { width: 20px; height: 20px; border-radius: 4px; border: 1px solid var(--border); }
.planning-view-btn { padding: 8px 15px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
.planning-view-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

.planning-calendar { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow: visible; margin-bottom: 50px; }
.planning-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--bg); border-bottom: 1px solid var(--border); }
.planning-weekday { padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; color: var(--text-sec); }
.planning-days { display: grid; grid-template-columns: repeat(7, 1fr); }
.planning-day { min-height: 120px; border: 1px solid var(--border); padding: 8px; cursor: pointer; transition: background 0.2s; }
.planning-day:hover { background: var(--bg); }
.planning-day.other-month { background: var(--bg); opacity: 0.5; }
.planning-day.today { background: rgba(43, 110, 246, 0.1); border-color: var(--primary); }
.planning-day.has-shoot { background: rgba(40, 167, 69, 0.1); }
.planning-day-number { font-weight: bold; margin-bottom: 5px; }
.planning-day-shoot { background: var(--success); color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 3px; cursor: pointer; position: relative; }
.planning-day-shoot:hover { opacity: 0.8; }
.planning-day-shoot .month-resize-handle { position: absolute; top: 0; bottom: 0; width: 8px; cursor: ew-resize; background: rgba(255,255,255,0.3); opacity: 0; }
.planning-day-shoot .month-resize-handle.right { right: 0; border-radius: 0 4px 4px 0; }
.planning-day-shoot .month-resize-handle.left { left: 0; border-radius: 4px 0 0 4px; }
.planning-day-shoot:hover .month-resize-handle { opacity: 1; }
  .planning-day-shoot[draggable="true"] { cursor: grab; }
  .planning-day-shoot[draggable="true"]:active { cursor: grabbing; }
  .planning-week-event[draggable="true"] { cursor: grab; }
  .planning-week-event[draggable="true"]:active { cursor: grabbing; }
  .planning-day.drag-over, .planning-week-cell.drag-over { background: rgba(43, 110, 246, 0.2) !important; }
  .context-menu-item:hover { background: var(--bg); }
.planning-day-availability { display: flex; flex-direction: column; gap: 2px; margin-top: 2px; }
.availability-bar { height: 14px; border-radius: 2px; font-size: 9px; color: #000; padding: 0 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 14px; font-weight: 500; display: flex; align-items: center; }

.planning-week-view { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; }
.planning-week-header { display: grid; grid-template-columns: 80px repeat(7, 1fr); background: var(--bg); border-bottom: 1px solid var(--border); }
.planning-week-header-cell { padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; border-right: 1px solid var(--border); }
.planning-week-body { max-height: 600px; overflow-y: auto; }
.planning-week-row { display: grid; grid-template-columns: 80px repeat(7, 1fr); border-bottom: 1px solid var(--border); }
.planning-week-time { padding: 10px; text-align: center; font-size: 0.8rem; color: var(--text-sec); border-right: 1px solid var(--border); background: var(--bg); }
.planning-week-cell { height: 30px; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 0; position: relative; box-sizing: border-box; }
  .planning-week-cell:hover { background: rgba(43, 110, 246, 0.1); }
  .planning-week-body { position: relative; overflow: visible; }
  .planning-week-view { position: relative; overflow: visible; }
  .planning-week-events-overlay { position: absolute; top: 0; left: 60px; right: 0; bottom: 0; pointer-events: none; z-index: 5; }
  .planning-week-header { display: flex; border-bottom: 2px solid var(--border); }
  .planning-week-header-cell { flex: 1; padding: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; box-sizing: border-box; }
  .planning-week-header-cell:first-child { width: 60px; min-width: 60px; max-width: 60px; flex: none; }
  .planning-week-row { display: flex; }
  .planning-week-time { width: 60px; min-width: 60px; max-width: 60px; flex: none; padding: 5px; text-align: center; font-size: 0.8rem; color: var(--text-sec); border-right: 1px solid var(--border); background: var(--bg); box-sizing: border-box; height: 30px; display: flex; align-items: center; justify-content: center; }
  .planning-week-cell { flex: 1; }
  .planning-week-time { width: 60px; min-width: 60px; max-width: 60px; }
  .planning-week-header-cell:first-child { width: 60px; min-width: 60px; max-width: 60px; }
  .planning-week-event-block { position: absolute; background: linear-gradient(135deg, var(--primary), #1e40af); color: white; border-radius: 6px; padding: 5px 8px; cursor: pointer; pointer-events: auto; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: box-shadow 0.2s; z-index: 10; }
  .planning-week-event-block:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
  .planning-week-event-block[draggable="true"] { cursor: grab; }
  .planning-week-event-block[draggable="true"]:active { cursor: grabbing; }
  .event-block-content { display: flex; flex-direction: column; gap: 2px; font-size: 0.75rem; }
  .event-block-content strong { font-size: 0.9rem; }
  .event-resize-handle-top, .event-resize-handle-bottom { position: absolute; left: 0; right: 0; height: 8px; cursor: ns-resize; pointer-events: auto; }
  .event-resize-handle-top { top: 0; }
  .event-resize-handle-bottom { bottom: 0; }
  .event-resize-handle-top:hover, .event-resize-handle-bottom:hover { background: rgba(255,255,255,0.3); }
  .event-resize-handle-right { position: absolute; top: 0; bottom: 0; right: 0; width: 10px; cursor: ew-resize; pointer-events: auto; }
  .event-resize-handle-right:hover { background: rgba(255,255,255,0.3); border-radius: 0 6px 6px 0; }
  .event-resize-handle-left { position: absolute; top: 0; bottom: 0; left: 0; width: 10px; cursor: ew-resize; pointer-events: auto; }
  .event-resize-handle-left:hover { background: rgba(255,255,255,0.3); border-radius: 6px 0 0 6px; }
  .planning-week-event-block.multi-day { background: linear-gradient(135deg, var(--primary), #3b82f6, #1e40af); min-height: 60px; }
.planning-week-event { background: var(--primary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 2px; cursor: pointer; }

.planning-day-view { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; max-height: 70vh; overflow-y: auto; }
.planning-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border); }
.planning-day-title { font-size: 1.3rem; font-weight: bold; }
.planning-day-meta { color: var(--text-sec); font-size: 0.9rem; }

.shoot-day-card { background: var(--bg); border: 2px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.shoot-day-card h3 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.shoot-section { margin-bottom: 20px; }
.shoot-section-title { font-weight: bold; margin-bottom: 10px; color: var(--primary); font-size: 0.9rem; text-transform: uppercase; }
.shoot-time-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
.shoot-time-item { display: flex; flex-direction: column; gap: 5px; }
.shoot-time-item label { font-size: 0.85rem; color: var(--text-sec); }
.shoot-time-item input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); }

.shoot-scene-list { display: flex; flex-direction: column; gap: 10px; }
.shoot-scene-item { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; padding: 15px; display: flex; gap: 15px; align-items: center; }
.shoot-scene-time { width: 80px; }
.shoot-scene-info { flex: 1; }
.shoot-scene-title { font-weight: bold; margin-bottom: 5px; }
.shoot-scene-meta { font-size: 0.85rem; color: var(--text-sec); }

.callsheet-table { width: 100%; border-collapse: collapse; }
.callsheet-table th, .callsheet-table td { padding: 10px; text-align: left; border: 1px solid var(--border); }
.callsheet-table th { background: var(--bg); font-weight: bold; font-size: 0.85rem; }
.callsheet-table tr:hover { background: var(--bg); }

.weather-widget { background: linear-gradient(135deg, #4a90e2, #357abd); color: white; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; }
.weather-icon { font-size: 2.5rem; }
.weather-info { flex: 1; }
.weather-temp { font-size: 1.5rem; font-weight: bold; }
.weather-desc { font-size: 0.9rem; opacity: 0.9; }
.weather-details { font-size: 0.8rem; opacity: 0.8; }

.planning-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 40px 20px; }
.planning-modal.active { display: flex; }
.planning-modal-content { background: var(--panel-bg); border-radius: 12px; width: 100%; max-width: 900px; }
.planning-modal-header { padding: 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.planning-modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
.planning-modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

.fds-preview { background: white; color: black; padding: 30px; font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; }
.fds-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 15px; }
.fds-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
.fds-subtitle { font-size: 14px; }
.fds-section { margin-bottom: 15px; }
.fds-section-title { font-weight: bold; background: #eee; padding: 5px; margin-bottom: 10px; }
.fds-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
.fds-table th, .fds-table td { border: 1px solid #333; padding: 5px; text-align: left; }
.fds-table th { background: #ddd; }
  
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
  .stat-card { background: var(--panel-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; box-shadow: 0 2px 5px var(--shadow); }
  .stat-number { font-size: 2.5rem; font-weight: bold; color: var(--primary); margin: 10px 0; }
  .stat-label { color: var(--text-sec); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
  .charts-row { display: flex; gap: 20px; flex-wrap: wrap; }
  .chart-box { flex: 1; min-width: 300px; background: var(--panel-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); max-height: 400px; overflow-y: auto; }
  .chart-title { font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .bar-row { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.9rem; transition: background 0.2s; padding: 4px; border-radius: 4px; }
.bar-row:hover { background: var(--bg); }
  .bar-label { width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: right; padding-right: 10px; }
  .bar-track { flex-grow: 1; background: var(--bg); height: 12px; border-radius: 6px; overflow: hidden; position: relative; }
  .bar-fill { height: 100%; background: var(--primary); border-radius: 6px; transition: width 1s ease-out; }
  .bar-val { width: 40px; padding-left: 10px; font-weight: bold; font-size: 0.8rem; }
  
  /* --- MOOD BOARD STYLES --- */
  .moodboard-container { display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; height: calc(100vh - 200px); height: calc(var(--vh, 1vh) * 100 - 200px); }
  .moodboard-toolbar { display: flex; gap: 10px; padding: 15px; background: var(--card-bg); border-bottom: 1px solid var(--border); flex-wrap: wrap; align-items: center; }
  .moodboard-toolbar select, .moodboard-toolbar input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); }
  .moodboard-toolbar button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
  .moodboard-toolbar button.primary { background: var(--primary); color: white; }
  .moodboard-toolbar button.primary:hover { opacity: 0.9; }
  .moodboard-toolbar button.secondary { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); }
  .moodboard-toolbar button.secondary:hover { background: var(--border); }
  .moodboard-boards-list { display: flex; gap: 8px; flex-wrap: wrap; padding: 10px 15px; background: var(--bg); border-bottom: 1px solid var(--border); }
  .moodboard-board-tab { padding: 8px 16px; border-radius: 20px; cursor: pointer; background: var(--card-bg); border: 1px solid var(--border); font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
  .moodboard-board-tab:hover { background: var(--border); }
  .moodboard-board-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
  .moodboard-board-tab .tab-close { opacity: 0.5; font-size: 0.8rem; margin-left: 4px; }
  .moodboard-board-tab .tab-close:hover { opacity: 1; }
  .moodboard-canvas-wrapper { flex: 1; overflow: hidden; position: relative; background: #2a2a2a; }
  .moodboard-canvas { position: absolute; top: 0; left: 0; transform-origin: 0 0; cursor: grab; }
  .moodboard-canvas.dragging { cursor: grabbing; }
  .moodboard-canvas.format-free { width: 5000px; height: 5000px; background: #ffffff; box-shadow: 0 0 0 1px #ccc, 0 4px 20px rgba(0,0,0,0.15); }
  .moodboard-canvas.format-a4-landscape { width: 1190px; height: 842px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a4-portrait { width: 842px; height: 1190px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a3-landscape { width: 1684px; height: 1190px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a3-portrait { width: 1190px; height: 1684px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a2-landscape { width: 2384px; height: 1684px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a2-portrait { width: 1684px; height: 2384px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a0-landscape { width: 4768px; height: 3370px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-canvas.format-a0-portrait { width: 3370px; height: 4768px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .moodboard-element { position: absolute; cursor: move; border: 2px solid transparent; border-radius: 8px; transition: border-color 0.2s, box-shadow 0.2s; min-width: 80px; min-height: 80px; }
  .moodboard-element:hover { border-color: var(--primary); }
  .moodboard-element.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
  .moodboard-element .resize-handle { position: absolute; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; opacity: 0; transition: opacity 0.2s; }
  .moodboard-element:hover .resize-handle, .moodboard-element.selected .resize-handle { opacity: 1; }
  .moodboard-element .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
  .moodboard-element .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
  .moodboard-element .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
  .moodboard-element .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
  .moodboard-element .element-actions { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); display: none; gap: 5px; background: var(--card-bg); padding: 5px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10; }
  .moodboard-element.selected .element-actions { display: flex; }
  .moodboard-element .element-actions button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; background: var(--bg); }
  .moodboard-element .element-actions button:hover { background: var(--border); }
  .moodboard-element .element-actions button.danger:hover { background: #ef4444; color: white; }
  .moodboard-element-image { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; pointer-events: none; }
  .moodboard-element-text { width: 100%; height: 100%; padding: 15px; font-size: 1rem; line-height: 1.5; overflow: auto; background: var(--card-bg); border-radius: 6px; }
  .moodboard-element-palette { display: flex; flex-direction: column; padding: 15px; background: white; border-radius: 10px; width: 100%; height: 100%; box-shadow: 0 2px 15px rgba(0,0,0,0.12); }
  .moodboard-element-palette .palette-title { font-size: 0.9rem; font-weight: 600; text-align: center; padding-bottom: 12px; color: #333; border-bottom: 1px solid #eee; margin-bottom: 12px; }
  .moodboard-element-palette .palette-colors { display: flex; flex: 1; gap: 12px; padding: 0 5px; }
  .moodboard-element-palette .color-swatch { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; min-width: 60px; }
  .moodboard-element-palette .color-swatch-box { width: 100%; flex: 1; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.18); min-height: 60px; }
  .moodboard-element-palette .color-swatch span { font-size: 0.6rem; font-weight: 600; color: #555; font-family: 'Courier New', monospace; white-space: nowrap; }
  .moodboard-element-shape { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
  .moodboard-element-shape svg { width: 100%; height: 100%; }
  .moodboard-shape-submenu { position: fixed; background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); z-index: 2001; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 70vh; overflow-y: auto; }
  .moodboard-shape-option { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 1.5rem; }
  .moodboard-shape-option:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); transform: scale(1.1); }
  .moodboard-element .rotate-handle { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); width: 20px; height: 20px; background: var(--primary); border-radius: 50%; cursor: grab; opacity: 0; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; }
  .moodboard-element:hover .rotate-handle, .moodboard-element.selected .rotate-handle { opacity: 1; }
  .moodboard-element .rotate-handle::before { content: '‚Üª'; }
  .moodboard-element-link { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; background: var(--card-bg); border-radius: 6px; text-align: center; width: 100%; height: 100%; }
  .moodboard-element-link .link-icon { font-size: 2rem; margin-bottom: 10px; }
  .moodboard-element-link .link-title { font-weight: 500; margin-bottom: 5px; word-break: break-word; }
  .moodboard-element-link .link-url { font-size: 0.75rem; color: var(--text-sec); word-break: break-all; }
  .moodboard-element-file { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; background: var(--card-bg); border-radius: 6px; text-align: center; width: 100%; height: 100%; cursor: pointer; }
  .moodboard-element-file:hover { background: var(--bg); }
  .moodboard-element-file .file-icon { font-size: 2.5rem; margin-bottom: 10px; }
  .moodboard-element-file .file-name { font-weight: 500; margin-bottom: 5px; word-break: break-word; font-size: 0.85rem; }
  .moodboard-element-file .file-size { font-size: 0.7rem; color: var(--text-sec); }
  .element-linked-badge { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .moodboard-element-palette .palette-title { grid-column: 1 / -1; font-size: 0.7rem; font-weight: 500; text-align: center; padding-bottom: 5px; color: var(--text-sec); }
  .moodboard-element-text { width: 100%; height: 100%; padding: 15px; overflow: auto; background: var(--card-bg); border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; }
  .moodboard-zoom-controls { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 5px; background: var(--card-bg); padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100; }
  .moodboard-zoom-controls button { width: 36px; height: 36px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; background: var(--bg); }
  .moodboard-zoom-controls button:hover { background: var(--border); }
  .moodboard-zoom-controls span { padding: 0 10px; line-height: 36px; font-size: 0.9rem; }
  .moodboard-minimap { position: absolute; bottom: 20px; left: 20px; width: 150px; height: 100px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); overflow: hidden; z-index: 100; }
  .moodboard-minimap-content { width: 100%; height: 100%; position: relative; }
  .moodboard-minimap-viewport { position: absolute; border: 2px solid var(--primary); background: rgba(59, 130, 246, 0.1); cursor: move; }
  .moodboard-info-panel { position: absolute; top: 20px; right: 20px; width: 280px; background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 15px; display: none; z-index: 100; max-height: calc(100% - 40px); overflow-y: auto; }
  .moodboard-info-panel.active { display: block; }
  .moodboard-info-panel h4 { margin: 0 0 15px 0; display: flex; justify-content: space-between; align-items: center; }
  .moodboard-info-panel .info-row { margin-bottom: 10px; }
  .moodboard-info-panel .info-row label { display: block; font-size: 0.8rem; color: var(--text-sec); margin-bottom: 4px; }
  .moodboard-info-panel .info-row input, .moodboard-info-panel .info-row select, .moodboard-info-panel .info-row textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); font-size: 0.9rem; }
  .moodboard-info-panel .info-row textarea { min-height: 60px; resize: vertical; }
  .moodboard-main-container { display: flex; flex: 1; overflow: hidden; }
  .moodboard-elements-sidebar { width: 220px; background: var(--card-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
  .moodboard-sidebar-header { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.9rem; }
  .moodboard-elements-count { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; }
  .moodboard-elements-list { flex: 1; overflow-y: auto; padding: 10px; }
  .moodboard-element-item { padding: 10px 12px; border-radius: 8px; margin-bottom: 6px; cursor: pointer; background: var(--bg); border: 1px solid var(--border); transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
  .moodboard-element-item:hover { border-color: var(--primary); background: var(--panel-bg); }
  .moodboard-element-item.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
  .moodboard-element-item .el-icon { font-size: 1.2rem; flex-shrink: 0; }
  .moodboard-element-item .el-info { flex: 1; overflow: hidden; }
  .moodboard-element-item .el-type { font-size: 0.75rem; color: var(--text-sec); text-transform: uppercase; }
  .moodboard-element-item .el-name { font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .moodboard-element-item .el-linked { font-size: 0.7rem; color: var(--primary); margin-top: 2px; }
  .moodboard-element-item .el-actions { display: none; gap: 4px; flex-shrink: 0; }
  .moodboard-element-item:hover .el-actions { display: flex; }
  .moodboard-element-item .el-actions button { width: 26px; height: 26px; border: none; border-radius: 4px; cursor: pointer; background: var(--bg); font-size: 0.75rem; transition: background 0.2s; }
  .moodboard-element-item .el-actions button:hover { background: var(--border); }
  .moodboard-empty { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sec); text-align: center; padding: 40px; background: #2a2a2a; z-index: 50; }

  /* Menu radial MoodBoard */
  .moodboard-radial-menu { position: fixed; z-index: 1000; pointer-events: none; }
  .moodboard-radial-menu.active { pointer-events: auto; }
  .moodboard-radial-center { position: absolute; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transform: translate(-50%, -50%); box-shadow: 0 4px 20px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s, background 0.2s; }
  .moodboard-radial-center:hover { transform: translate(-50%, -50%) scale(1.1); background: #2563eb; }
  .moodboard-radial-item { position: absolute; width: 50px; height: 50px; border-radius: 50%; background: var(--card-bg); color: var(--text); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; transform: translate(-50%, -50%) scale(0); box-shadow: 0 2px 15px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); border: 2px solid var(--border); }
  .moodboard-radial-menu.active .moodboard-radial-item { transform: translate(-50%, -50%) scale(1); }
  .moodboard-radial-item:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translate(-50%, -50%) scale(1.15) !important; }
  .moodboard-radial-item .radial-tooltip { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
  .moodboard-radial-item:hover .radial-tooltip { opacity: 1; }
  .moodboard-radial-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999; }

  /* Sous-menu palette couleurs */
  .moodboard-palette-submenu { position: absolute; background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); min-width: 280px; z-index: 1001; }
  .color-wheel-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; }
  .color-wheel-container { background: #ffffff; border-radius: 16px; padding: 25px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid #ddd; color: #333; }
  [data-theme="dark"] .color-wheel-container { background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1); color: #fff; }
  .color-wheel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .color-wheel-header h3 { margin: 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
  .color-wheel-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); padding: 5px; }
  .color-wheel-close:hover { color: var(--text); }
  .color-wheel-body { display: flex; gap: 25px; flex-wrap: wrap; }
  .color-wheel-left { flex: 1; min-width: 280px; display: flex; flex-direction: column; align-items: center; }
  .color-wheel-right { flex: 1; min-width: 200px; }
  .color-wheel-canvas-wrap { position: relative; width: 280px; height: 280px; }
  #colorWheelCanvas { border-radius: 50%; cursor: crosshair; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
  .color-wheel-marker { position: absolute; width: 20px; height: 20px; border: 3px solid white; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; box-shadow: 0 2px 8px rgba(0,0,0,0.4), inset 0 0 0 2px rgba(0,0,0,0.2); }
  .color-wheel-marker.main { width: 26px; height: 26px; border-width: 4px; z-index: 10; }
  .color-wheel-marker.draggable { pointer-events: auto; cursor: grab; }
  .color-wheel-marker.draggable:active { cursor: grabbing; }
  .harmony-selector { margin-top: 20px; width: 100%; }
  .harmony-selector label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-sec); font-size: 0.9rem; }
  .harmony-selector select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 0.95rem; cursor: pointer; }
  .harmony-selector select:focus { outline: none; border-color: var(--primary); }
  .generated-colors { display: flex; flex-direction: column; gap: 8px; }
  .generated-color-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
  .generated-color-item:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .generated-color-swatch { width: 50px; height: 50px; border-radius: 8px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
  .generated-color-info { flex: 1; }
  .generated-color-hex { font-family: 'Courier New', monospace; font-weight: 600; font-size: 1rem; }
  .generated-color-rgb { font-size: 0.8rem; color: var(--text-sec); margin-top: 2px; }
  .color-wheel-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid var(--border); }
  .color-wheel-actions button { padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
  .color-wheel-actions .cancel { background: var(--bg); border: 1px solid var(--border); color: var(--text); }
  .color-wheel-actions .cancel:hover { background: var(--border); }
  .color-wheel-actions .confirm { background: var(--primary); border: none; color: white; }
  .color-wheel-actions .confirm:hover { opacity: 0.9; }
  .brightness-slider { margin-top: 15px; width: 100%; }
  .brightness-slider label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--text-sec); }
  .brightness-slider input[type="range"] { width: 100%; cursor: pointer; }
  .moodboard-palette-submenu h4 { margin: 0 0 12px 0; font-size: 0.9rem; color: var(--text-sec); }
  .moodboard-palette-option { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; margin-bottom: 8px; }
  .moodboard-palette-option:hover { background: var(--bg); }
  .moodboard-palette-option:last-child { margin-bottom: 0; }
  .moodboard-palette-preview { display: flex; gap: 3px; }
  .moodboard-palette-preview span { width: 24px; height: 24px; border-radius: 4px; }
  .moodboard-palette-option .palette-name { font-weight: 500; font-size: 0.85rem; }
  .moodboard-palette-option .palette-desc { font-size: 0.75rem; color: var(--text-sec); }

  /* Panneau texte MoodBoard */
  .moodboard-text-panel { position: absolute; background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 4px 25px rgba(0,0,0,0.3); min-width: 300px; z-index: 1001; }
  .moodboard-text-panel h4 { margin: 0 0 12px 0; font-size: 0.9rem; }
  .moodboard-text-panel textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); resize: none; margin-bottom: 12px; font-family: inherit; }
  .moodboard-text-panel .text-options { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
  .moodboard-text-panel .text-options select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); flex: 1; min-width: 100px; }
  .moodboard-text-panel .text-actions { display: flex; gap: 8px; justify-content: flex-end; }
  .moodboard-text-panel .text-actions button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
  .moodboard-text-panel .text-actions .btn-cancel { background: var(--bg); color: var(--text); }
  .moodboard-text-panel .text-actions .btn-add { background: var(--primary); color: white; }
  .moodboard-empty-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
  .moodboard-empty h3 { margin: 0 0 10px 0; color: var(--text); }
  .moodboard-empty p { margin: 0 0 20px 0; max-width: 400px; }

  /* --- STORYBOARD STYLES --- */
.storyboard-layout { display: flex; gap: 20px; min-height: 100%; }
.storyboard-scenes { width: 30%; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow-y: auto; }
.storyboard-shots { flex: 1; overflow-y: auto; padding: 20px; }
.sb-scene-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
.sb-scene-item:hover { background: var(--bg); }
.sb-scene-item.active { background: var(--primary); color: white; font-weight: bold; }
.sb-scene-title { font-weight: bold; margin-bottom: 5px; }
.sb-scene-meta { font-size: 0.8rem; opacity: 0.7; }

.shot-card { background: var(--panel-bg); border: 2px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px var(--shadow); }
.shot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.shot-preview { width: 100%; height: 300px; background: #f0f0f0; border: 2px dashed var(--border); border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; position: relative; }
.shot-preview img, .shot-preview canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
.shot-upload-zone { text-align: center; color: var(--text-sec); }
.shot-meta-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
.shot-input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); }
.shot-textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); resize: vertical; min-height: 60px; margin-top: 10px; }

/* --- SHOT COMPACT MODE --- */
.shots-compact-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
.shot-compact-card { background: var(--panel-bg); border: 2px solid var(--border); border-radius: 8px; overflow: hidden; cursor: grab; transition: all 0.2s; position: relative; }
.shot-compact-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px var(--shadow); border-color: var(--primary); }
.shot-compact-card.dragging { opacity: 0.5; cursor: grabbing; }
.shot-compact-image { width: 100%; height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; }
.shot-compact-image img, .shot-compact-image canvas { width: 100%; height: 100%; object-fit: contain; }
.shot-compact-footer { padding: 10px; background: var(--bg); text-align: center; font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
.shot-compact-delete { background: none; border: none; color: var(--text-sec); cursor: pointer; font-size: 1.1rem; padding: 0; }
.shot-compact-delete:hover { color: var(--danger); }
.shot-compact-name { padding: 5px 10px; font-size: 0.85rem; color: var(--text-main); text-align: center; font-weight: 600; border-top: 1px solid var(--border); }
.shot-compact-tech { padding: 5px 10px; font-size: 0.75rem; color: var(--text-sec); text-align: center; background: var(--bg); }

/* Commentaires */
.comments-panel { position: fixed; top: 0; right: -400px; width: 400px; height: 100%; background: var(--panel-bg); border-left: 1px solid var(--border); z-index: 10000; transition: right 0.3s ease; display: flex; flex-direction: column; box-shadow: -4px 0 20px rgba(0,0,0,0.2); }
.storyboard-preview-panel { position: fixed; top: 0; right: -600px; width: 600px; height: 100%; background: var(--panel-bg); border-left: 1px solid var(--border); z-index: 10000; transition: right 0.3s ease; display: flex; flex-direction: column; box-shadow: -4px 0 20px rgba(0,0,0,0.2); }
.storyboard-preview-panel.open { right: 0; }
.storyboard-preview-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
.storyboard-preview-header h3 { margin: 0; font-size: 1.1rem; }
.storyboard-preview-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main); }
.storyboard-preview-body { flex: 1; overflow-y: auto; padding: 15px; }
.storyboard-preview-body .sb-print-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
.storyboard-preview-body .sb-print-shot { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
.storyboard-preview-body .sb-print-shot:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.storyboard-preview-empty { text-align: center; padding: 40px; color: var(--text-muted); }
.comments-panel.open { right: 0; }
.comments-header { padding: 15px 20px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.comments-header h3 { margin: 0; font-size: 1.1rem; }
.comments-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec); }
.comments-body { flex: 1; overflow-y: auto; padding: 15px; }
.comments-footer { padding: 15px; border-top: 1px solid var(--border); background: var(--bg); }
.comment-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; resize: none; font-family: inherit; background: var(--input-bg); color: var(--text-main); }
.comment-submit { width: 100%; margin-top: 10px; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
.comment-item { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); }
.comment-item.resolved { opacity: 0.6; border-left: 3px solid var(--success); }
.comment-author { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.comment-author-name { font-weight: 600; color: var(--primary); }
.comment-date { font-size: 0.75rem; color: var(--text-sec); }
.comment-text { font-size: 0.9rem; line-height: 1.4; color: var(--text-main); white-space: pre-wrap; }
.comment-actions { margin-top: 10px; display: flex; gap: 10px; }
.comment-action-btn { background: none; border: none; font-size: 0.8rem; color: var(--text-sec); cursor: pointer; padding: 2px 5px; }
.comment-action-btn:hover { color: var(--primary); }
.comment-replies { margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--border); }
.comment-reply-input { display: none; margin-top: 10px; }
.comment-reply-input.active { display: block; }
.comment-badge { display: inline-flex; align-items: center; justify-content: center; background: var(--primary); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; cursor: pointer; }
.comment-badge.resolved { background: var(--success); }
.comment-badge:hover { transform: scale(1.1); }
.no-comments { text-align: center; color: var(--text-sec); padding: 30px; font-style: italic; }
.shot-dirty-indicator { position: absolute; top: 5px; right: 5px; background: var(--locked); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }

/* --- SHOT EDIT MODAL --- */
.shot-edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10003; justify-content: center; align-items: center; overflow-y: auto; }
.shot-edit-modal.active { display: flex; }
.shot-edit-container { background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; margin: 20px; }
.shot-edit-header { padding: 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--panel-bg); z-index: 10; }
.shot-edit-content { padding: 30px; }
.shot-edit-save-btn { padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; display: none; }
.shot-edit-save-btn.visible { display: inline-block; }
.shot-edit-close-btn { padding: 10px 20px; background: var(--border); color: var(--text-main); border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

/* --- STORYBOARD PRINT VIEW --- */
.sb-view-toggle { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
.sb-toggle-btn { padding: 10px 20px; background: var(--panel-bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
.sb-toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
.sb-toggle-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow); }

.sb-print-config { position: relative; }
.sb-config-btn { padding: 10px 20px; background: var(--bg); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: bold; }
.sb-config-panel { display: none; position: absolute; top: 100%; right: 0; margin-top: 10px; background: var(--panel-bg); border: 2px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: 0 4px 15px var(--shadow); z-index: 100; min-width: 250px; }
.sb-config-panel.open { display: block; }
.sb-config-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.sb-config-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.sb-config-item label { cursor: pointer; user-select: none; }

.sb-print-preview { display: none; }
.sb-print-preview.active { display: block; }
.sb-print-page { background: white; width: 100%; max-width: 210mm; margin: 0 auto 30px; padding: 20mm; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #ddd; page-break-after: always; }
.sb-print-page h2 { margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 3px solid #333; font-size: 1.5rem; color: #333; }
.sb-print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.sb-print-shot { background: white; border: 2px solid #333; border-radius: 8px; overflow: hidden; page-break-inside: avoid; }
.sb-print-shot-image { width: 100%; height: 200px; background: #f5f5f5; border-bottom: 2px solid #333; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.sb-print-shot-image img, .sb-print-shot-image canvas { width: 100%; height: 100%; object-fit: contain; }
.sb-print-shot-info { padding: 10px; font-size: 0.85rem; line-height: 1.4; color: #333; }
.sb-print-shot-header { font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
.sb-print-shot-meta { margin-bottom: 3px; color: #555; }
.sb-print-shot-desc { margin-top: 5px; border-top: 1px solid #ddd; padding-top: 5px; }

.sb-fullscreen-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10002; overflow-y: auto; }
.sb-fullscreen-modal.active { display: block; }
.sb-fullscreen-header { position: sticky; top: 0; background: var(--panel-bg); padding: 15px 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
.sb-fullscreen-content { padding: 40px 20px; }

@media print {
  .sb-print-page { box-shadow: none; border: none; margin: 0; padding: 20mm; page-break-after: always; }
  .sb-fullscreen-header, .sb-view-toggle, .sb-toggle-btn, .sb-config-btn, .storyboard-scenes { display: none !important; }
  body { background: white; }
}
/* --- DRAWING EDITOR --- */
.drawing-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99998; justify-content: center; align-items: center; }
.drawing-container { background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column; }
.drawing-header { padding: 15px 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.drawing-toolbar { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 15px; flex-wrap: wrap; background: var(--bg); }
.drawing-workspace { flex: 1; display: flex; overflow: hidden; }
.drawing-sidebar { width: 200px; background: var(--bg); border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; }
.drawing-canvas-area { flex: 1; display: flex; justify-content: center; align-items: center; background: #2a2a2a; position: relative; overflow: auto; }
.drawing-canvas { background: white; cursor: crosshair; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

.tool-group { margin-bottom: 20px; }
.tool-label { font-size: 0.75rem; font-weight: bold; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase; }
.color-palette { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
.color-swatch { width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
.color-swatch.active { border-color: var(--primary); transform: scale(1.1); box-shadow: 0 0 0 2px white; }
.brush-btn { padding: 8px 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; margin-bottom: 5px; text-align: center; font-size: 0.85rem; transition: all 0.2s; }
.brush-btn:hover { background: var(--bg); }
.brush-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
.opacity-slider { width: 100%; margin: 10px 0; }
.layer-item { padding: 8px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.layer-item.active { background: var(--primary); color: white; }
.layer-visibility { cursor: pointer; font-size: 1.2rem; }
  
  .breakdown-layout { display: flex; gap: 20px; min-height: 100%; }
  .breakdown-col { width: 50%; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; max-height: 80vh; overflow-y: auto; }
  .bd-header { padding: 10px; background: var(--bg); border-bottom: 1px solid var(--border); font-weight: bold; text-align: center; flex-shrink: 0; color: var(--text-main); }
  .bd-content { overflow-y: auto; padding: 0; flex-grow: 1; position: relative; }
  .bd-scene-card { border-bottom: 1px solid var(--border); }
  .bd-scene-header { padding: 12px; cursor: pointer; background: var(--panel-bg); display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; color: var(--text-main); }
  .bd-scene-header:hover { background: var(--bg); }
  .bd-scene-header.active { background: var(--bg); border-left: 4px solid var(--primary); }
  .bd-scene-details { display: none; padding: 15px; background: var(--bg); border-top: 1px solid var(--border); }
  .bd-scene-details.open { display: block; }
  .bd-cat-group { margin-bottom: 12px; }
  .bd-cat-name { font-size: 0.75rem; text-transform: uppercase; color: var(--text-sec); font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid var(--border); }
  .bd-tags-container { display: flex; flex-wrap: wrap; gap: 5px; }
  .bd-tag { display: inline-flex; align-items: center; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; padding: 2px 8px; font-size: 0.85rem; color: var(--text-main); }
  .bd-script-text { font-family: 'Courier Prime', 'Courier New', Courier, monospace; font-size: 12pt; line-height: 1.0; padding: 40px 60px; color: var(--text-main); max-width: 650px; margin: 0 auto; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; white-space: pre-wrap; overflow-wrap: break-word; }
  .bd-marked { color: var(--text-sec) !important; text-decoration: line-through !important; background-color: var(--bg) !important; border-radius: 2px; cursor: pointer; transition: all 0.2s ease; }
  .bd-marked.bd-highlight { background-color: #ffd700 !important; color: #333 !important; text-decoration: none !important; box-shadow: 0 0 8px rgba(255, 215, 0, 0.6); }
  .bd-tag { transition: all 0.2s ease; cursor: pointer; }
  .bd-tag.bd-highlight { background-color: #ffd700 !important; color: #333 !important; box-shadow: 0 0 8px rgba(255, 215, 0, 0.6); transform: scale(1.05); }
  #bd-link-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
  #bd-link-svg path { fill: none; stroke: #ffd700; stroke-width: 2; stroke-dasharray: 5,3; }
  .breakdown-layout { position: relative; }

  .lock-overlay { display: none; position: absolute; top: -10px; right: 10px; background: var(--locked); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .script-row.is-locked .lock-overlay { display: block; }
  .script-row.is-locked .script-write-col { opacity: 0.7; pointer-events: none; }
  .script-row.is-locked .script-editor-box { border: 2px solid var(--locked); background: rgba(255, 152, 0, 0.05); }

  #script-ac-list, #breakdown-ctx-menu, #tag-ctx-menu { position: fixed; background: var(--panel-bg); border: 1px solid var(--border); box-shadow: 0 4px 15px var(--shadow); z-index: 9999; max-height: 300px; overflow-y: auto; width: 220px; display: none; border-radius: 4px; }
  #script-ac-list div, #breakdown-ctx-menu div, #tag-ctx-menu div { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
  #script-ac-list div:hover, #breakdown-ctx-menu div:hover, #tag-ctx-menu div:hover { background: var(--bg); color: var(--primary); }
  .tag-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }
  .tag-badge { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; border: 1px solid rgba(0,0,0,0.2); cursor: help; }
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; height: calc(var(--vh, 1vh) * 100); background: rgba(0,0,0,0.5); z-index: 10000; -webkit-justify-content: center; justify-content: center; -webkit-align-items: center; align-items: center; }
  .modal-content { background: var(--panel-bg); border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--border); overflow: hidden; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg); border-bottom: 1px solid var(--border); }
  .modal-header h2 { margin: 0; font-size: 1.2rem; color: var(--text-main); }
  .modal-close { background: var(--border); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-main); transition: background 0.2s; }
  .modal-close:hover { background: var(--danger); color: white; }
  .modal-box { background: var(--panel-bg); padding: 20px; border-radius: 8px; width: 350px; max-width: 90%; box-shadow: 0 4px 15px var(--shadow); border: 1px solid var(--border); color: var(--text-main); }
  .checklist { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .checklist label { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: background 0.2s; }
  .checklist label:hover { background: var(--bg); }
  .checklist input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: var(--primary); flex-shrink: 0; }
  .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
  .autocomplete-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
  .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; border: 1px solid var(--border); z-index: 99; background: var(--panel-bg); max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px var(--shadow); }
  .autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border); color: var(--text-main); }
  .autocomplete-item:hover, .autocomplete-active { background: var(--bg); }
  .autocomplete-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .autocomplete-dropdown-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); }
  .autocomplete-dropdown-item:last-child { border-bottom: none; }
  .autocomplete-dropdown-item:hover { background: var(--bg); }
  .autocomplete-dropdown-item img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
  .autocomplete-dropdown-item .ac-icon { width: 32px; height: 32px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 1rem; }
  .autocomplete-dropdown-item .ac-info { flex: 1; }
  .autocomplete-dropdown-item .ac-name { font-weight: 600; color: var(--text-main); }
  .autocomplete-dropdown-item .ac-detail { font-size: 0.75rem; color: var(--text-sec); }
  .autocomplete-dropdown-item .ac-source { font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; background: var(--primary); color: white; }
  
  /* Guide / Aide */
  .help-category { padding: 10px 15px; cursor: pointer; border-radius: 6px; margin-bottom: 5px; transition: all 0.2s; color: var(--text-main); }
  .help-category:hover { background: var(--panel-bg); }
  .help-category.active { background: var(--primary); color: white; font-weight: 600; }
  .help-section { display: none; }
  .help-section.active { display: block; }
  .help-section h3 { color: var(--primary); margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary); }
  .help-section h3:first-child { margin-top: 0; }
  .help-section p { line-height: 1.7; margin-bottom: 12px; color: var(--text-main); }
  .help-section ul { margin: 10px 0 15px 20px; line-height: 1.8; }
  .help-section li { margin-bottom: 5px; }
  .help-tip { background: var(--bg); border-left: 4px solid var(--primary); padding: 12px 15px; margin: 15px 0; border-radius: 0 6px 6px 0; }
  .help-tip strong { color: var(--primary); }
  .help-shortcut { display: inline-block; background: var(--border); padding: 3px 8px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; margin: 0 3px; }
  .help-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
  .help-table th, .help-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
  .help-table th { background: var(--bg); font-weight: 600; color: var(--primary); }
  .help-table tr:hover td { background: var(--bg); }

  /* Kanban */
  .kanban-card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
  .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-color: var(--primary); }
  .kanban-card-title { font-weight: 600; margin-bottom: 6px; color: var(--text-main); }
  .kanban-card-info { font-size: 0.8rem; color: var(--text-sec); display: flex; gap: 8px; flex-wrap: wrap; }
  .kanban-card-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: var(--bg); }
  .kanban-card-tag.int { background: #fef3c7; color: #92400e; }
  .kanban-card-tag.ext { background: #dbeafe; color: #1e40af; }
  .kanban-card-tag.jour { background: #fef9c3; color: #854d0e; }
  .kanban-card-tag.nuit { background: #1e1b4b; color: #c7d2fe; }
  .kanban-card-date { font-size: 0.75rem; color: var(--primary); margin-top: 6px; }
  
  /* Mode Compact S√©quencier */
  #boardList.compact-mode { display: flex; flex-direction: column; gap: 2px; }
  
  /* ========== BEAT BOARD ========== */
  .beatboard-container { position: relative; width: 100%; height: calc(100vh - 200px); height: calc(var(--vh, 1vh) * 100 - 200px); min-height: 500px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .beatboard-canvas { position: absolute; top: 0; left: 0; width: 3000px; height: 2000px; background-image: radial-gradient(circle, var(--border) 1px, transparent 1px); background-size: 30px 30px; cursor: grab; transform-origin: 0 0; }
  .beatboard-canvas.dragging { cursor: grabbing; }
  .beatboard-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
  .beatboard-line { stroke: #e74c3c; stroke-width: 3; fill: none; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
  .beatboard-line-bg { stroke: rgba(231, 76, 60, 0.2); stroke-width: 12; fill: none; stroke-linecap: round; }
  .beatboard-card { position: absolute; width: 180px; min-height: 100px; background: var(--panel-bg); border: 2px solid var(--border); border-radius: 10px; padding: 12px; cursor: move; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: box-shadow 0.2s, transform 0.1s; user-select: none; }
  .beatboard-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.2); transform: scale(1.02); z-index: 100; }
  .beatboard-card.dragging { opacity: 0.8; transform: scale(1.05) rotate(2deg); z-index: 1000; box-shadow: 0 12px 32px rgba(0,0,0,0.3); }
  .beatboard-card-number { position: absolute; top: -10px; left: -10px; width: 28px; height: 28px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; border: 2px solid var(--panel-bg); }
  .beatboard-card-tag { position: absolute; top: 0; left: 0; right: 0; height: 6px; border-radius: 8px 8px 0 0; }
  .beatboard-card-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; margin-top: 4px; line-height: 1.3; color: var(--text-main); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .beatboard-card-meta { font-size: 0.7rem; color: var(--text-sec); margin-bottom: 6px; }
  .beatboard-card-resume { font-size: 0.75rem; color: var(--text-main); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  .beatboard-card-status { position: absolute; bottom: 8px; right: 8px; font-size: 0.7rem; }
  .beatboard-card-connector { position: absolute; width: 14px; height: 14px; background: #e74c3c; border: 2px solid var(--panel-bg); border-radius: 50%; z-index: 20; }
  .beatboard-card-connector.in { top: 50%; left: -9px; transform: translateY(-50%); }
  .beatboard-card-connector.out { top: 50%; right: -9px; transform: translateY(-50%); }
  .beatboard-toolbar { position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; z-index: 1000; flex-wrap: wrap; }
  .beatboard-toolbar button { padding: 8px 14px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
  .beatboard-toolbar button:hover { background: var(--primary); color: white; border-color: var(--primary); }
  .beatboard-toolbar button.active { background: var(--primary); color: white; border-color: var(--primary); }
  .beatboard-zoom { position: absolute; bottom: 10px; right: 10px; display: flex; gap: 5px; z-index: 1000; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 5px; }
  .beatboard-zoom button { width: 32px; height: 32px; border: none; background: transparent; cursor: pointer; border-radius: 4px; font-size: 1.1rem; }
  .beatboard-zoom button:hover { background: var(--bg); }
  .beatboard-zoom span { padding: 0 10px; display: flex; align-items: center; font-size: 0.85rem; color: var(--text-sec); }
  .beatboard-minimap { position: absolute; bottom: 10px; left: 10px; width: 150px; height: 100px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; z-index: 1000; }
  .beatboard-minimap-viewport { position: absolute; border: 2px solid var(--primary); background: rgba(43, 110, 246, 0.1); pointer-events: none; }
  .beatboard-groups { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px; z-index: 1000; }
  .beatboard-group-label { padding: 6px 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; }
  .beatboard-group-dot { width: 10px; height: 10px; border-radius: 50%; }
  .beatboard-card.selected { outline: 3px solid var(--primary); outline-offset: 2px; }
  .beatboard-card.out-of-timeline { opacity: 0.7; border-style: dashed; }
  .beatboard-card.out-of-timeline .beatboard-card-number { display: none; }
  .beatboard-card.out-of-timeline .beatboard-card-connector { background: #999; }
  .beatboard-out-timeline-zone { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); min-width: 300px; min-height: 120px; background: rgba(150, 150, 150, 0.1); border: 2px dashed var(--text-sec); border-radius: 12px; padding: 15px; z-index: 5; }
  .beatboard-out-timeline-label { position: absolute; top: -12px; left: 20px; background: var(--panel-bg); padding: 2px 10px; font-size: 0.75rem; color: var(--text-sec); border-radius: 4px; }
  #boardList.compact-mode .card { padding: 8px 12px; margin: 0; border-radius: 4px; display: flex; align-items: center; gap: 15px; }
  #boardList.compact-mode .card h3 { margin: 0; font-size: 0.9rem; white-space: nowrap; order: 1; }
  #boardList.compact-mode .card h3 small { font-weight: normal; color: var(--text-sec); }
  #boardList.compact-mode .card .meta { margin: 0; font-size: 0.8rem; white-space: nowrap; order: 2; }
  #boardList.compact-mode .card .resume-text { display: none; }
  #boardList.compact-mode .card .card-actions { position: static; opacity: 1; display: flex; gap: 5px; margin-left: auto; order: 3; }
  #boardList.compact-mode .card .card-actions button { padding: 4px 8px; font-size: 0.75rem; }
  #boardList.compact-mode .card .tag-badge { width: 8px; height: 8px; }

  #print-cover, .print-only-title { display: none; }
  @media print {
    @page { size: A4; margin: 25mm 25mm 25mm 35mm; counter-increment: page; @top-right { content: counter(page) "."; font-family: 'Courier Prime', 'Courier', monospace; font-size: 12pt; margin-top: 15mm; } }
    
    body { background: #fff !important; color: #000 !important; height: auto; overflow: visible; font-family: 'Courier Prime', 'Courier', monospace; -webkit-print-color-adjust: exact; }
    main { overflow: visible; padding: 0; margin: 0; }
    
    /* Cacher l'interface */
    #auth-view, #dashboard-view, header, .tabs-nav, .format-bar, .global-actions, .board-sidebar, .bd-header button, .card-actions, .autocomplete-wrapper, .modal-overlay, .lock-overlay, .group-select, .new-project-card, button, .synopsis-history, .controls-row, .sidebar-toggles, .script-info-col, #quick-nav { display: none !important; }

    /* Page de garde */
    #print-cover { display: flex !important; flex-direction: column; justify-content: center; align-items: center; height: 90vh; text-align: center; page-break-after: always; }
    #print-cover h1 { font-size: 36pt; margin-bottom: 10px; text-transform:uppercase; text-decoration:underline; }
    #print-cover p { font-size: 14pt; margin: 10px 0; }
    #print-cover .print-contact { position: absolute; bottom: 0; left: 0; text-align: left; font-size: 12pt; }

    /* Affichage Sc√©nario */
    body.print-script #tab-script { display: block !important; }
    .script-view { max-width: 100%; width: 100%; font-size: 12pt; line-height: 1; }
    .script-row { display: block; border-bottom: none; padding: 0; margin: 0; page-break-inside: auto; }
    .script-write-col { display: block; width: 100%; margin: 0; }
    .script-editor-box { border: none; padding: 0; background: white; color: black; box-shadow: none; min-height: auto; width: 100%; overflow: visible; }
    
    /* Elements Sc√©nario Impression */
    .scene-heading-print { display: block !important; font-weight: bold; text-transform: uppercase; margin-top: 24pt; margin-bottom: 12pt; text-decoration: underline; page-break-after: avoid; }
    
    .sc-action { margin: 12pt 0; text-align: left; width: 100%; }
    .sc-perso { margin-top: 12pt; margin-bottom: 0; margin-left: 40%; margin-right: 10%; text-transform: uppercase; page-break-after: avoid; }
    .sc-dial { margin-top: 0; margin-bottom: 0; margin-left: 20%; margin-right: 20%; page-break-inside: auto; widows: 2; orphans: 2; }
    .sc-paren { margin-left: 30%; margin-right: 30%; font-style: italic; margin-bottom: 0; page-break-after: avoid; }
    .sc-trans { text-align: right; margin-left: 60%; margin-top: 12pt; margin-bottom: 12pt; text-transform: uppercase; }
    .sc-note { display: none; }
    .sc-general { font-style: italic; color: #444; margin: 12pt 0; }
    .sc-centered { text-align: center; margin: 24pt 0; text-transform: uppercase; } 
    
    /* Autres onglets impression */
    body.print-synopsis #tab-synopsis { display: block !important; }
    .synopsis-editor h3, .section-label { display: none !important; }
    body.print-board #tab-board { display: block !important; }
    .board-main { width: 100%; }
    .card { border: 1px solid #000; break-inside: avoid; }
    .synopsis-container { display: block; }
    .synopsis-editor { width: 100%; }
    .synopsis-editor textarea { border: none; padding: 0; resize: none; font-family: 'Courier Prime', monospace; font-size: 12pt; line-height: 1.5; }
    
    body.print-chars #tab-chars { display: block !important; }
    body.print-actors #tab-actors { display: block !important; }
    body.print-locs #tab-locs { display: block !important; }
    body.print-breakdown #tab-breakdown { display: block !important; }
    body.print-stats #tab-stats { display: block !important; }
	body.print-storyboard #tab-storyboard { display: block !important; }
	body.print-storyboard .storyboard-scenes { display: none !important; }
	body.print-storyboard .sb-view-toggle { display: none !important; }
	body.print-storyboard .sb-print-preview { display: block !important; }
	body.print-crew #tab-crew { display: block !important; }
.crew-card { break-inside: avoid; border: 1px solid #ccc; margin-bottom: 15px; }
    .group-section { break-inside: avoid; margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
    .data-grid { display: block; }
    .data-card { border-bottom: 1px solid #eee; margin-bottom: 10px; page-break-inside: avoid; }
    .breakdown-col { width: 100%; border: none; }
    #breakdownScriptCol { display: none; }
    .bd-scene-card { break-inside: avoid; border: 1px solid #ccc; margin-bottom: 10px; }
    .bd-scene-details { display: block !important; }
  }

  .script-editor-box, .bd-script-text, .print-only-title, .scene-heading-print { font-family: 'Courier Prime', 'Courier New', Courier, monospace !important; }
  body.dark-mode button, body.dark-mode .theme-btn, body.dark-mode .fmt-btn { background-color: #2d2d2d !important; border-color: #555 !important; color: #e0e0e0 !important; }
  body.dark-mode button:hover, body.dark-mode .theme-btn:hover { background-color: #404040 !important; border-color: #777 !important; }
  body.dark-mode .fmt-btn.active { background-color: var(--primary) !important; color: #fff !important; border-color: var(--primary) !important; }

/* ========== VERSIONS DE SC√àNES ========== */
.scene-versions-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10001;
}
.scene-versions-box {
    background: var(--panel-bg);
    border-radius: 12px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.scene-versions-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.scene-versions-header h3 {
    margin: 0;
    font-size: 1.2rem;
}
.scene-versions-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}
.scene-version-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.2s;
}
.scene-version-item:hover {
    border-color: var(--primary);
}
.scene-version-item.current {
    border-color: var(--success);
    background: rgba(40, 167, 69, 0.1);
}
.scene-version-info {
    flex: 1;
}
.scene-version-date {
    font-weight: 600;
    margin-bottom: 4px;
}
.scene-version-preview {
    font-size: 0.85rem;
    color: var(--text-sec);
    max-height: 40px;
    overflow: hidden;
    text-overflow: ellipsis;
}
.scene-version-actions {
    display: flex;
    gap: 8px;
}
.scene-version-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}
.scene-version-btn.restore {
    background: var(--primary);
    color: white;
}
.scene-version-btn.restore:hover {
    opacity: 0.9;
}
.scene-version-btn.preview {
    background: var(--bg);
    border: 1px solid var(--border);
}
.scene-version-btn.preview:hover {
    border-color: var(--primary);
}
.scene-version-btn.delete {
    background: transparent;
    color: var(--danger);
    border: 1px solid var(--danger);
}
.scene-version-btn.delete:hover {
    background: var(--danger);
    color: white;
}
.version-badge {
    background: var(--primary);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    margin-left: 5px;
}

/* Badges statut sc√®ne (Brouillon/Finale) */
.scene-status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; margin-left: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.scene-status-badge.draft { background: #fff3e0; color: #ef6c00; border: 1px solid #ffcc80; }
.scene-status-badge.final { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
body.dark-mode .scene-status-badge.draft { background: #4a3000; color: #ffb74d; border-color: #6d4c00; }
body.dark-mode .scene-status-badge.final { background: #1b3d1f; color: #81c784; border-color: #2e5a32; }

.scene-draft-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,152,0,0.03) 10px, rgba(255,152,0,0.03) 20px); pointer-events: none; z-index: 1; border-radius: inherit; }

.card.is-final { border-left: 4px solid var(--success); }
.card.is-draft { border-left: 4px solid #ff9800; }

.script-row.is-final { border-left: 4px solid var(--success); }
.script-row.is-draft { border-left: 4px solid #ff9800; }

.finalize-btn { padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
.finalize-btn:hover { background: #1b5e20; transform: scale(1.02); }

.unfinalize-btn { padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
.unfinalize-btn:hover { background: #e65100; }

.breakdown-blocked { opacity: 0.5; pointer-events: none; position: relative; }
.breakdown-blocked-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel-bg); border: 2px dashed #ff9800; padding: 20px 30px; border-radius: 12px; text-align: center; z-index: 10; box-shadow: 0 4px 20px var(--shadow); }
.breakdown-blocked-msg h4 { margin: 0 0 10px 0; color: #ff9800; }
.breakdown-blocked-msg p { margin: 0; color: var(--text-sec); font-size: 0.9rem; }

/* ========== CALENDRIER VISUEL ========== */
.calendar-container {
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}
.calendar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}
.calendar-header h3 {
    margin: 0;
    font-size: 1.2rem;
}
.calendar-nav {
    display: flex;
    align-items: center;
    gap: 15px;
}
.calendar-nav-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 15px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
}
.calendar-nav-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
.calendar-month-year {
    font-size: 1.1rem;
    font-weight: bold;
    min-width: 180px;
    text-align: center;
}
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}
.calendar-weekday {
    text-align: center;
    font-weight: bold;
    font-size: 0.85rem;
    color: var(--text-sec);
    padding: 10px 5px;
}
.calendar-day {
    aspect-ratio: 1;
    min-height: 80px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 5px;
    background: var(--bg);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.calendar-day:hover {
    border-color: var(--primary);
}
.calendar-day.other-month {
    opacity: 0.4;
}
.calendar-day.today {
    border: 2px solid var(--primary);
    background: rgba(79, 70, 229, 0.1);
}
.calendar-day.has-shooting {
    background: rgba(76, 175, 80, 0.15);
    border-color: #4CAF50;
}
.calendar-day-number {
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 3px;
}
.calendar-day-events {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.calendar-event {
    font-size: 0.7rem;
    padding: 2px 5px;
    border-radius: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.calendar-event.shooting {
    background: #4CAF50;
    color: white;
}
.calendar-event.availability {
    background: #2196F3;
    color: white;
}
.calendar-event.unavailable {
    background: #f44336;
    color: white;
}
.calendar-legend {
    display: flex;
    gap: 20px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
}
.calendar-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
}
.calendar-legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}
.calendar-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.calendar-export-btn {
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}
.calendar-export-btn:hover {
    opacity: 0.9;
}
.calendar-view-toggle {
    display: flex;
    gap: 5px;
    background: var(--bg);
    padding: 5px;
    border-radius: 8px;
}
.calendar-view-btn {
    padding: 8px 15px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}
.calendar-view-btn.active {
    background: var(--primary);
    color: white;
}

/* ========== B√âN√âVOLAT / TYPE DE COLLABORATION ========== */
.collab-type-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
}
.collab-type-btn {
    padding: 8px 15px;
    border: 2px solid var(--border);
    border-radius: 20px;
    background: var(--bg);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
}
.collab-type-btn:hover {
    border-color: var(--primary);
}
.collab-type-btn.selected {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
}
.collab-type-btn.pro { border-color: #4CAF50; }
.collab-type-btn.pro.selected { background: #4CAF50; border-color: #4CAF50; }
.collab-type-btn.semi-pro { border-color: #FF9800; }
.collab-type-btn.semi-pro.selected { background: #FF9800; border-color: #FF9800; }
.collab-type-btn.benevole { border-color: #E91E63; }
.collab-type-btn.benevole.selected { background: #E91E63; border-color: #E91E63; }

.collab-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}
.collab-badge.pro {
    background: #E8F5E9;
    color: #2E7D32;
}
.collab-badge.semi-pro {
    background: #FFF3E0;
    color: #E65100;
}
.collab-badge.benevole {
    background: #FCE4EC;
    color: #C2185B;
}
.collab-badge.amateur {
    background: #E3F2FD;
    color: #1565C0;
}

.project-type-selector {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}
.project-type-card {
    flex: 1;
    padding: 15px;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: var(--bg);
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
}
.project-type-card:hover {
    border-color: var(--primary);
}
.project-type-card.selected {
    border-width: 3px;
}
.project-type-card.pro.selected {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}
.project-type-card.semi-pro.selected {
    border-color: #FF9800;
    background: rgba(255, 152, 0, 0.1);
}
.project-type-card.benevole.selected {
    border-color: #E91E63;
    background: rgba(233, 30, 99, 0.1);
}
.project-type-card .icon {
    font-size: 2rem;
    margin-bottom: 8px;
}
.project-type-card .label {
    font-weight: bold;
    margin-bottom: 5px;
}
.project-type-card .desc {
    font-size: 0.8rem;
    color: var(--text-sec);
}

/* ========== GESTION DES CONTRATS ========== */
.contracts-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease;
}
.contracts-box {
    background: var(--panel-bg);
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: scaleIn 0.2s ease;
}
.contracts-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.contracts-header h3 {
    margin: 0;
    font-size: 1.3rem;
}
.contracts-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
.contracts-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 15px;
}
.contracts-tab {
    padding: 10px 20px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}
.contracts-tab:hover {
    border-color: var(--primary);
}
.contracts-tab.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
.contract-form {
    display: grid;
    gap: 15px;
}
.contract-form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}
.contract-form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.contract-form-group label {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-sec);
}
.contract-form-group input,
.contract-form-group select,
.contract-form-group textarea {
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--input-bg);
    color: var(--text-main);
    font-size: 0.95rem;
}
.contract-preview {
    background: white;
    color: #333;
    padding: 30px;
    border-radius: 8px;
    border: 1px solid var(--border);
    font-family: 'Times New Roman', serif;
    font-size: 12pt;
    line-height: 1.6;
    max-height: 500px;
    overflow-y: auto;
}
.contract-preview h1 {
    text-align: center;
    font-size: 16pt;
    margin-bottom: 20px;
}
.contract-preview h2 {
    font-size: 12pt;
    margin-top: 20px;
    margin-bottom: 10px;
    border-bottom: 1px solid #333;
}
.contract-preview .signature-zone {
    display: flex;
    justify-content: space-between;
    margin-top: 40px;
}
.contract-preview .signature-box {
    width: 45%;
    text-align: center;
}
.contract-preview .signature-line {
    border-top: 1px solid #333;
    margin-top: 60px;
    padding-top: 5px;
}
.contract-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}
.contract-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.95rem;
    transition: all 0.2s;
}
.contract-btn-primary {
    background: var(--primary);
    color: white;
}
.contract-btn-primary:hover {
    opacity: 0.9;
}
.contract-btn-secondary {
    background: var(--border);
    color: var(--text-main);
}
.contract-btn-secondary:hover {
    background: var(--text-sec);
    color: var(--panel-bg);
}
.person-select-list {
    display: grid;
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
}
.person-select-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.person-select-item:hover {
    border-color: var(--primary);
}
.person-select-item.selected {
    border-color: var(--primary);
    background: rgba(79, 70, 229, 0.1);
}
.person-select-item .status-badge {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 4px;
    background: var(--border);
}
.person-select-item .status-badge.intermittent {
    background: #E3F2FD;
    color: #1565C0;
}
.person-select-item .status-badge.micro-entrepreneur {
    background: #FFF3E0;
    color: #E65100;
}

/* ========== STATISTIQUES AVANC√âES ========== */
.stats-section-title {
    font-size: 1.2rem;
    font-weight: bold;
    margin: 30px 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--primary);
    color: var(--text-main);
}
.stats-section-title:first-of-type {
    margin-top: 10px;
}
.charts-row-advanced {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}
.chart-box-advanced {
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
}
.chart-box-advanced .chart-title {
    font-weight: bold;
    margin-bottom: 15px;
    text-align: center;
    color: var(--text-main);
}
.chart-canvas-container {
    position: relative;
    height: 250px;
    width: 100%;
}
.progress-bar-container {
    background: var(--bg);
    border-radius: 10px;
    height: 30px;
    overflow: hidden;
    margin: 10px 0;
}
.progress-bar-fill {
    height: 100%;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    transition: width 0.5s ease;
}
.stats-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    margin-top: 15px;
}
.stats-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
}
.stats-legend-color {
    width: 14px;
    height: 14px;
    border-radius: 3px;
}
.budget-comparison {
    display: flex;
    gap: 20px;
    margin-top: 15px;
}
.budget-item {
    flex: 1;
    text-align: center;
    padding: 15px;
    background: var(--bg);
    border-radius: 8px;
}
.budget-item-label {
    font-size: 0.85rem;
    color: var(--text-sec);
    margin-bottom: 5px;
}
.budget-item-value {
    font-size: 1.5rem;
    font-weight: bold;
}
.budget-item-value.positive { color: var(--success); }
.budget-item-value.negative { color: var(--danger); }

/* ========== NOTIFICATIONS ========== */
.notif-wrapper {
    position: relative;
    display: inline-block;
}
.notif-btn {
    background: none;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    padding: 5px 10px;
    position: relative;
}
.notif-badge {
    position: absolute;
    top: 0;
    right: 2px;
    background: var(--danger);
    color: white;
    font-size: 0.7rem;
    font-weight: bold;
    min-width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--panel-bg);
}
.notif-badge.hidden {
    display: none;
}
.notif-panel {
    position: absolute;
    top: 100%;
    right: 0;
    width: 350px;
    max-height: 450px;
    background: var(--panel-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    z-index: 9999;
    display: none;
    flex-direction: column;
    animation: fadeIn 0.2s ease;
}
.notif-panel.visible {
    display: flex;
}
.notif-header {
    padding: 15px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.notif-header h4 {
    margin: 0;
    font-size: 1rem;
}
.notif-mark-all {
    font-size: 0.8rem;
    color: var(--primary);
    cursor: pointer;
    background: none;
    border: none;
}
.notif-mark-all:hover {
    text-decoration: underline;
}
.notif-list {
    flex: 1;
    overflow-y: auto;
    max-height: 350px;
}
.notif-item {
    padding: 12px 15px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    gap: 12px;
    align-items: flex-start;
}
.notif-item:hover {
    background: var(--bg);
}
.notif-item.unread {
    background: rgba(79, 70, 229, 0.08);
}
.notif-item.unread::before {
    content: '';
    position: absolute;
    left: 5px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    background: var(--primary);
    border-radius: 50%;
}
.notif-icon {
    font-size: 1.3rem;
    flex-shrink: 0;
}
.notif-content {
    flex: 1;
    min-width: 0;
}
.notif-text {
    font-size: 0.9rem;
    color: var(--text-main);
    margin-bottom: 4px;
    line-height: 1.4;
}
.notif-time {
    font-size: 0.75rem;
    color: var(--text-sec);
}
.notif-empty {
    padding: 40px 20px;
    text-align: center;
    color: var(--text-sec);
}

/* ========== HISTORIQUE DES MODIFICATIONS ========== */
.history-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease;
}
.history-box {
    background: var(--panel-bg);
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    animation: scaleIn 0.2s ease;
}
.history-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.history-header h3 {
    margin: 0;
    font-size: 1.3rem;
}
.history-filters {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}
.history-filters select {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text-main);
    font-size: 0.9rem;
}
.history-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px 20px;
}
.history-item {
    display: flex;
    gap: 15px;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    transition: all 0.2s;
}
.history-item:hover {
    border-color: var(--primary);
}
.history-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}
.history-icon.add { background: rgba(76, 175, 80, 0.2); }
.history-icon.edit { background: rgba(33, 150, 243, 0.2); }
.history-icon.delete { background: rgba(244, 67, 54, 0.2); }
.history-icon.share { background: rgba(156, 39, 176, 0.2); }
.history-content {
    flex: 1;
}
.history-action {
    font-weight: 500;
    margin-bottom: 4px;
    color: var(--text-main);
}
.history-meta {
    font-size: 0.85rem;
    color: var(--text-sec);
    display: flex;
    gap: 15px;
}
.history-empty {
    text-align: center;
    padding: 40px;
    color: var(--text-sec);
}
.history-close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-sec);
    padding: 5px 10px;
    border-radius: 5px;
}
.history-close-btn:hover {
    background: var(--bg);
    color: var(--text-main);
}

/* ========== MODE PR√âSENTATION ========== */
body.presentation-mode {
    overflow: hidden;
}
body.presentation-mode .app-header,
body.presentation-mode #dashboard,
body.presentation-mode #universe-page,
body.presentation-mode #messages-page,
body.presentation-mode .project-header,
body.presentation-mode .project-tabs {
    display: none !important;
}
body.presentation-mode .project-sidebar {
    display: none !important;
}
body.presentation-mode .project-main {
    margin-left: 0 !important;
    height: 100vh !important;
    padding: 0 !important;
}
body.presentation-mode .tab-content {
    height: calc(100vh - 60px) !important;
    overflow-y: auto;
    padding: 30px;
}
body.presentation-mode .tab-content.active {
    display: block !important;
}

/* Barre de contr√¥le flottante */
.presentation-bar {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: rgba(0,0,0,0.9);
    color: #fff;
    align-items: center;
    justify-content: center;
    gap: 20px;
    z-index: 10000;
    padding: 0 20px;
}
body.presentation-mode .presentation-bar {
    display: flex;
}
.presentation-bar button {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
}
.presentation-bar button:hover {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
}
.presentation-bar .pres-title {
    font-weight: bold;
    font-size: 1.1rem;
    margin-right: auto;
}
.presentation-bar .pres-nav {
    display: flex;
    align-items: center;
    gap: 10px;
}
.presentation-bar .pres-tab-name {
    min-width: 150px;
    text-align: center;
    font-size: 0.95rem;
    color: rgba(255,255,255,0.8);
}
</style>
</head>
<body>
<!-- Conteneur des notifications Toast -->
<div id="toast-container" class="toast-container"></div>

<!-- Loading Screen Cin√©ma -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-box">
        <div class="loading-scene">
            <div class="loading-ground"></div>
            
            <!-- L'√©quipe de tournage qui court (gauche ‚Üí droite) -->
            <div class="loading-crew">
                <!-- 1. Perchman en retard √† gauche -->
                <div class="pixel-person pixel-perch">
                    <div class="pixel-perch-body"></div>
                    <div class="pixel-perch-pole"></div>
                    <div class="pixel-perch-mic"></div>
                </div>
                <!-- 2. Com√©dien -->
                <div class="pixel-person pixel-actor1"></div>
                <!-- 3. Com√©dienne -->
                <div class="pixel-person pixel-actor2"></div>
                <!-- 4. Cam√©raman -->
                <div class="pixel-person pixel-camera">
                    <div class="pixel-camera-rec"></div>
                </div>
                <!-- 5. Scripte avec classeur -->
                <div class="pixel-person pixel-script"></div>
                <!-- 6. R√©alisateur en t√™te √† droite -->
                <div class="pixel-person pixel-director">
                    <div class="pixel-director-arm"></div>
                    <div class="pixel-director-mega"></div>
                    <div class="pixel-director-waves"></div>
                </div>
            </div>
            <!-- Feuilles qui volent depuis la scripte -->
            <div class="loading-papers">
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
                <div class="flying-paper"></div>
            </div>
        </div>
        <div class="loading-clap">üé¨</div>
        <div class="loading-title">Chargement du projet...</div>
        <div id="loading-message" class="loading-message">Pr√©paration du plateau...</div>
        <div class="loading-progress">
            <div id="loading-progress-bar" class="loading-progress-bar"></div>
        </div>
    </div>
</div>

<!-- Barre de contr√¥le Mode Pr√©sentation -->
<div class="presentation-bar" id="presentationBar">
    <span class="pres-title">üé¨ Mode Pr√©sentation</span>
    <div class="pres-nav">
        <button onclick="app.PresentMode.prevTab()" data-tooltip="Onglet pr√©c√©dent">‚¨ÖÔ∏è Pr√©c√©dent</button>
        <span class="pres-tab-name" id="presTabName">Synopsis</span>
        <button onclick="app.PresentMode.nextTab()" data-tooltip="Onglet suivant">Suivant ‚û°Ô∏è</button>
    </div>
    <button onclick="app.PresentMode.exit()" data-tooltip="Quitter (√âchap)">‚úñÔ∏è Quitter</button>
</div>

<div id="auth-view">
    <div style="position:absolute; top:20px; right:20px;">
        <button class="theme-btn" onclick="app.UI.toggleTheme()">üåì Mode</button>
    </div>
    <div class="auth-box">
      <h1>üé¨ Moteur</h1>
      <p style="font-size: 0.9rem; color: var(--text-sec); margin-top: -10px; font-style: italic;">"Mais o√π est-ce qu'il est ce con de perchman ?"</p>
      <p>v1.9.9.5</p>
      
      <form id="login-form" onsubmit="event.preventDefault(); app.Auth.login()">
        <input type="email" id="login-email" name="email" class="auth-input" placeholder="Email" autocomplete="username">
        <input type="password" id="login-pass" name="password" class="auth-input" placeholder="Mot de passe" autocomplete="current-password">
        <div id="login-error" class="auth-error">Identifiants incorrects.</div>
        <div id="login-success" class="auth-success"></div>
        <button type="submit" class="auth-btn">Se connecter</button>
        <div style="margin-top:15px; display:flex; justify-content:space-between; font-size:0.85rem">
            <span class="auth-link" style="margin:0" onclick="app.Auth.toggleForgot()">Mot de passe oubli√© ?</span>
            <span class="auth-link" style="margin:0" onclick="app.Auth.toggleMode('signup')">Cr√©er un compte</span>
        </div>
      </form>

      <form id="signup-form" style="display:none" onsubmit="event.preventDefault(); app.Auth.signup()">
        <input type="email" id="signup-email" name="email" class="auth-input" placeholder="Email" autocomplete="username">
        <input type="password" id="signup-pass" name="new-password" class="auth-input" placeholder="Mot de passe" autocomplete="new-password">
        <input type="password" id="signup-confirm" name="confirm-password" class="auth-input" placeholder="Confirmer mot de passe" autocomplete="new-password">
       
	   <div style="margin: 15px 0; padding: 12px; background: var(--bg); border-radius: 8px; text-align: center;">
            <span style="font-size: 1.2rem;">üé¨</span>
            <p style="font-size: 0.85rem; color: var(--text-sec); margin: 5px 0 0;">Vous pourrez cr√©er vos profils (com√©dien, technicien...) apr√®s inscription.</p>
        </div>


        <div id="signup-error" class="auth-error">Erreur de cr√©ation.</div>
        <button type="submit" class="auth-btn">Cr√©er mon compte</button>
        <div class="auth-link" onclick="app.Auth.toggleMode('login')">Se connecter</div>
      </form>

      <div id="forgot-form" style="display:none">
        <h3>R√©initialisation</h3>
        <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:15px">Entrez votre email pour recevoir un lien.</p>
        <input type="email" id="forgot-email" class="auth-input" placeholder="Email du compte">
        <div id="forgot-error" class="auth-error">Email introuvable.</div>
        <div id="forgot-success" class="auth-success">Email envoy√© ! V√©rifiez vos spams.</div>
        <button class="auth-btn" onclick="app.Auth.resetPassword()">Envoyer le lien</button>
        <div class="auth-link" onclick="app.Auth.toggleMode('login')">Retour connexion</div>
      </div>
    </div>
  </div>
  
  <div id="dashboard-view">
    <div class="dash-header">
      <div class="dash-title">
        <h1>üé¨ Moteur</h1>
        <p id="user-welcome">Bienvenue</p>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
      <button id="btn-my-profile" onclick="app.PublicProfile.open()" style="background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer">üë§ Mon Profil</button>
<button onclick="app.Universe.showProjects()" style="background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer">üìÅ Mes Projets</button>
<button onclick="app.Contacts.open()" style="background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer">üìá Contacts</button>
<button onclick="app.Courses.open()" style="background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer">üéì Cours</button>
<div style="position:relative;">
  <button onclick="document.getElementById('design-dropdown').classList.toggle('show')" style="background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer; display:flex; flex-direction:column; align-items:center; min-width:65px;">
    <span style="font-size:1.1rem;">üé®</span>
    <span style="font-size:0.75rem;" id="design-label">Design</span>
  </button>
  <div id="design-dropdown" style="display:none; position:absolute; top:100%; left:0; background:var(--panel-bg); border:1px solid var(--border); border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:1000; min-width:150px; margin-top:5px;">
    <div onclick="app.UI.setDesign('classic')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">üé¨ Classique</div>
    <div onclick="app.UI.setDesign('glass')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">‚ú® Glass</div>
    <div onclick="app.UI.setDesign('neumorphism')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">ü´ß Neumorphism</div>
    <div onclick="app.UI.setDesign('cinema')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">üé• Cinema</div>
    <div onclick="app.UI.setDesign('neon')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">üíú Cyberpunk</div>
    <div onclick="app.UI.setDesign('nature')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">üåø Nature</div>
    <div onclick="app.UI.setDesign('sunset')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">üåÖ Sunset</div>
    <div onclick="app.UI.setDesign('ocean')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">üåä Oc√©an</div>
    <div onclick="app.UI.setDesign('lavender')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">üíê Lavande</div>
    <div onclick="app.UI.setDesign('minimal')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">‚¨ú Minimal</div>
    <div onclick="app.UI.setDesign('terminal')" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px;">üíª Terminal</div>
    
  </div>
</div>
<button onclick="app.UI.toggleTheme()" style="background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer">üåì Mode</button>
<button onclick="app.Help.open()" style="background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer">‚ùì Guide</button>
        <div class="notif-wrapper">
            <button class="notif-btn" onclick="app.Notifications.togglePanel()" data-tooltip="Notifications" data-tooltip-pos="bottom">üîî<span id="notif-badge" class="notif-badge hidden">0</span></button>
            <div class="notif-panel" id="notif-panel">
                <div class="notif-header">
                    <h4>üîî Notifications</h4>
                    <button class="notif-mark-all" onclick="app.Notifications.markAllRead()">Tout marquer lu</button>
                </div>
                <div class="notif-list" id="notif-list">
                    <div class="notif-empty">Aucune notification</div>
                </div>
            </div>
        </div>
        <button onclick="app.Auth.logout()" style="background:var(--border); color:var(--text-main); border:none; padding:10px 15px; border-radius:6px; font-weight:bold; cursor:pointer">D√©connexion</button>
      </div>
    </div>
    
    <input type="file" id="importInput" accept=".fdx,.xml,.pdf" style="display:none" onchange="app.Importer.handleFileSelect(event)">

    <!-- Univers flottant -->
    <div id="universe-view" class="universe-container">
        <!-- Sidebar Filtres -->
        <div class="universe-sidebar" style="width: 280px; min-width: 280px; background: var(--panel-bg); border-right: 1px solid var(--border); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
            
            <!-- Matching intelligent - EN PREMIER -->
            <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(236,72,153,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; padding: 12px;">
                <h4 style="margin: 0 0 8px 0; font-size: 0.95rem; color: #8b5cf6;">üéØ Projets pour moi</h4>
                <select id="universe-my-profile" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); margin-bottom: 8px; font-size: 0.85rem;">
                    <option value="">-- Mon profil --</option>
                </select>
                <button onclick="app.MatchingEngine.findProjectsForMe()" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #8b5cf6, #ec4899); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.85rem;">üéØ Matcher</button>
                <div id="matching-results-count" style="display: none; margin-top: 6px; text-align: center; font-size: 0.8rem; color: var(--text-sec);"></div>
            </div>
            
            <h3 style="margin: 0; font-size: 1.1rem; color: var(--primary);">üîç Recherche</h3>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <select id="universe-type" onchange="app.Universe.onTypeChange()" data-tooltip="S√©lectionnez une cat√©gorie pour filtrer instantan√©ment la carte" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Tous --</option>
                    <option value="actor">üé≠ Com√©diens</option>
                    <option value="crew">üé• Techniciens</option>
                    <option value="association">üèõÔ∏è Associations</option>
                    <option value="enterprise">üè¢ Entreprises</option>
                    <option value="project">üé¨ Projets</option>
                </select>
                
                <input type="text" id="universe-city" placeholder="üìç Ville..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 0.85rem; color: var(--text-sec);">Distance:</span>
                    <input type="range" id="universe-distance" min="0" max="500" value="50" style="flex: 1;" onchange="document.getElementById('universe-distance-label').textContent = this.value == 500 ? '‚àû' : this.value + ' km'">
                    <span id="universe-distance-label" style="min-width: 45px; font-size: 0.85rem;">50 km</span>
                </div>
            </div>
            
            <!-- Filtres Techniciens -->
            <div id="universe-filters-crew" style="display: none; flex-direction: column; gap: 10px;">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-sec);">Filtres Techniciens</div>
                <select id="universe-department" onchange="app.Universe.onDepartmentChange()" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- D√©partement --</option>
                </select>
                <select id="universe-crew-role" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Fonction --</option>
                </select>
            </div>
            
            <!-- Filtres Com√©diens -->
            <div id="universe-filters-actor" style="display: none; flex-direction: column; gap: 10px;">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-sec);">Filtres Com√©diens</div>
                <select id="universe-actor-gender" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Sexe --</option>
                    <option value="homme">Homme</option>
                    <option value="femme">Femme</option>
                    <option value="non-binaire">Non-binaire</option>
                </select>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="universe-actor-age-min" placeholder="√Çge min" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <input type="number" id="universe-actor-age-max" placeholder="√Çge max" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="universe-actor-height-min" placeholder="Taille min (cm)" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <input type="number" id="universe-actor-height-max" placeholder="Taille max (cm)" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="universe-actor-weight-min" placeholder="Poids min (kg)" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <input type="number" id="universe-actor-weight-max" placeholder="Poids max (kg)" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                </div>
                <select id="universe-actor-eyes" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Couleur des yeux --</option>
                    <option value="marron">Marron</option>
                    <option value="bleu">Bleu</option>
                    <option value="vert">Vert</option>
                    <option value="gris">Gris</option>
                    <option value="noisette">Noisette</option>
                    <option value="noir">Noir</option>
                </select>
                <select id="universe-actor-hair" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Couleur cheveux --</option>
                    <option value="noir">Noir</option>
                    <option value="brun">Brun</option>
                    <option value="chatain">Ch√¢tain</option>
                    <option value="blond">Blond</option>
                    <option value="roux">Roux</option>
                    <option value="gris">Gris</option>
                    <option value="blanc">Blanc</option>
                    <option value="chauve">Chauve</option>
                </select>
                <select id="universe-actor-hair-length" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Longueur cheveux --</option>
                    <option value="chauve">Chauve</option>
                    <option value="rase">Ras√©</option>
                    <option value="court">Court</option>
                    <option value="mi-long">Mi-long</option>
                    <option value="long">Long</option>
                </select>
                <select id="universe-actor-ethnicity" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Origine ethnique --</option>
                    <option value="caucasien">Caucasien</option>
                    <option value="africain">Africain / Afro-descendant</option>
                    <option value="asiatique">Asiatique</option>
                    <option value="latino">Latino / Hispanique</option>
                    <option value="maghrebin">Maghr√©bin</option>
                    <option value="moyenorient">Moyen-Orient</option>
                    <option value="indien">Indien / Sud-asiatique</option>
                    <option value="metis">M√©tis</option>
                    <option value="autre">Autre</option>
                </select>
                <select id="universe-actor-corpulence" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Corpulence --</option>
                    <option value="mince">Mince</option>
                    <option value="normal">Normal</option>
                    <option value="athletique">Athl√©tique</option>
                    <option value="muscle">Muscl√©</option>
                    <option value="rond">Rond</option>
                    <option value="fort">Fort / Costaud</option>
                </select>
                <input type="text" id="universe-actor-sports" placeholder="üèÉ Sports (√©quitation...)" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                <input type="text" id="universe-actor-languages" placeholder="üó£Ô∏è Langues (anglais...)" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
            </div>
            
            <!-- Filtres Associations -->
            <div id="universe-filters-association" style="display: none; flex-direction: column; gap: 10px;">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-sec);">Filtres Associations</div>
                <select id="universe-association-type" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Type d'association --</option>
                </select>
            </div>
            
            <!-- Filtres Entreprises -->
            <div id="universe-filters-enterprise" style="display: none; flex-direction: column; gap: 10px;">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-sec);">Filtres Entreprises</div>
                <select id="universe-enterprise-type" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Type d'entreprise --</option>
                </select>
            </div>
            
            <!-- Filtre Type de collaboration (commun acteurs/techniciens) -->
            <div id="universe-filters-collab" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px;">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-sec);">Type de collaboration</div>
                <select id="universe-collab-type" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Tous --</option>
                    <option value="pro">üé¨ Pro uniquement</option>
                    <option value="semi-pro">‚ö° Semi-pro</option>
                    <option value="benevole">‚ù§Ô∏è B√©n√©vole</option>
                </select>
                <select id="universe-status-type" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Tous statuts --</option>
                    <option value="intermittent">Intermittent¬∑e</option>
                    <option value="micro-entrepreneur">Micro-entrepreneur¬∑e</option>
                    <option value="amateur">Amateur¬∑rice</option>
                </select>
            </div>
            
            <!-- Filtre v√©hicule (commun) -->
            <div id="universe-filters-vehicle" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="universe-has-vehicle">
                    üöó Avec v√©hicule
                </label>
            </div>
            
            <!-- Filtre Type de production (pour projets) -->
            <div id="universe-filters-production-type" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px;">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-sec);">Type de production</div>
                <select id="universe-production-type" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Tous --</option>
                    <option value="pro">üé¨ Production Pro</option>
                    <option value="semi-pro">‚ö° Production Semi-pro</option>
                    <option value="benevole">‚ù§Ô∏è Production B√©n√©vole</option>
                </select>
            </div>
            
            <!-- Filtres Projets -->
            <div id="universe-filters-project" style="display: none; flex-direction: column; gap: 10px;">
                <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-sec);">Filtres Projets</div>
                <select id="universe-project-type" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Type de projet --</option>
                    <option value="court-metrage">Court-m√©trage</option>
                    <option value="long-metrage">Long-m√©trage</option>
                    <option value="serie">S√©rie / Web-s√©rie</option>
                    <option value="documentaire">Documentaire</option>
                    <option value="clip">Clip musical</option>
                    <option value="pub">Publicit√©</option>
                    <option value="corporate">Film corporate</option>
                </select>
                <select id="universe-project-genre" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- Genre --</option>
                    <option value="drame">Drame</option>
                    <option value="comedie">Com√©die</option>
                    <option value="thriller">Thriller</option>
                    <option value="horreur">Horreur</option>
                    <option value="sf">Science-Fiction</option>
                    <option value="fantastique">Fantastique</option>
                    <option value="action">Action</option>
                    <option value="romance">Romance</option>
                </select>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="universe-project-has-actor-needs">
                    Cherche com√©diens
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="universe-project-has-crew-needs">
                    Cherche techniciens
                </label>
            </div>
            
            <!-- Boutons -->
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button onclick="app.Universe.search()" data-tooltip="Applique tous les filtres d√©taill√©s (√¢ge, physique, comp√©tences...)" style="width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">üîç Rechercher</button>
                <button onclick="app.Universe.reset()" data-tooltip="Efface tous les filtres et affiche tous les profils" style="width: 100%; padding: 10px; background: var(--bg); color: var(--text-main); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">‚Ü∫ R√©initialiser</button>
            </div>
            
            </div>
        
        <!-- Zone des cartes flottantes -->
        <div class="universe-view-toggle" id="universe-view-toggle">
            <button onclick="app.Universe.setViewMode('map')" id="view-mode-map" class="active" style="padding:8px 12px; border:none; background:var(--primary); color:white; border-radius:6px 0 0 6px; cursor:pointer;">üó∫Ô∏è Carte</button>
            <button onclick="app.Universe.setViewMode('fan')" id="view-mode-fan" style="padding:8px 12px; border:none; background:var(--bg); color:var(--text-main); border-radius:0 6px 6px 0; cursor:pointer; border:1px solid var(--border);">üìá Liste</button>
        </div>
        <div class="universe-scene" id="universe-scene" style="flex: 1; position: relative;">
            <div id="universe-map"></div>
            <div id="map-hover-card" class="map-hover-card" style="display:none;"></div>
            <!-- Les cartes flottantes appara√Ætront ici -->
        </div>
    </div>

    <!-- Vue Projets (cach√©e par d√©faut) -->
    <div id="projects-view" style="display:none;">
      <div style="margin-bottom: 20px; max-width: 1200px; margin-left: auto; margin-right: auto; width: 100%;">
        <button onclick="app.Universe.showUniverse()" style="background: var(--border); color: var(--text-main); border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">‚¨Ö Retour √† l'univers</button>
      </div>
      <div id="project-list" class="project-grid"></div>
    </div>
  </div>
  
  <div id="public-profile-view" class="public-profile-view">
    <div class="public-profile-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button onclick="app.PublicProfile.close()" style="background:var(--border); color:var(--text-main); border:none; padding:8px 15px; border-radius:6px; font-weight:bold; cursor:pointer">‚¨Ö Retour</button>
            <div class="messages-tabs" style="margin:0; border:none; padding:0;">
                <button class="messages-tab active" onclick="app.PublicProfile.showTab('profile')" id="profile-tab-btn">üë§ Mes Profils</button>
                <button class="messages-tab" onclick="app.PublicProfile.showTab('messages')" id="messages-tab-btn">üì¨ Messages <span class="badge" id="messages-badge" style="display:none;">0</span></button>
            </div>
            <h1 id="profile-title">üé≠ Mes Profils Publics</h1>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
            <button onclick="app.PublicProfile.saveCurrentProfile()" style="background:var(--success); color:white; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer">üíæ Sauvegarder</button>
            <button class="theme-btn" onclick="app.UI.toggleTheme()">üåì Mode</button>
        </div>
    </div>
    <div class="public-profile-body">
        <!-- Conteneur Profil -->
        <div id="profile-content">
        
        <!-- Onglets de profils -->
        <div style="margin-bottom: 20px;">
            <div id="profile-tabs-container" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px;">
                <!-- Les onglets seront g√©n√©r√©s dynamiquement -->
            </div>
            <p style="font-size: 0.85rem; color: var(--text-sec);">üí° Vous pouvez cr√©er plusieurs profils (com√©dien, technicien...). Chaque profil appara√Ætra comme une carte distincte dans l'Univers. Nous recommandons 2 profils maximum.</p>
        </div>
        
        <!-- Contenu du profil s√©lectionn√© (cach√© jusqu'au chargement) -->
        <div id="current-profile-content" style="display: none;">
            <!-- Section profils √† revendiquer -->
            <div id="pending-claims-section" style="display: none; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white;">
                    <h3 style="margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">üéÅ</span> Profils cr√©√©s pour vous
                    </h3>
                    <p style="margin: 0 0 15px 0; opacity: 0.9; font-size: 0.9rem;">Des porteurs de projets ont cr√©√© ces profils √† votre nom. Revendiquez-les pour les compl√©ter et appara√Ætre dans l'Univers !</p>
                    <div id="pending-claims-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>
            </div>
            
            <!-- Message si aucun profil -->
            <div id="no-profile-message" style="display: none; text-align: center; padding: 60px 20px; background: var(--panel-bg); border: 2px dashed var(--border); border-radius: 12px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">üë§</div>
                <h2 style="margin-bottom: 10px;">Bienvenue !</h2>
                <p style="color: var(--text-sec); margin-bottom: 20px;">Cr√©ez votre premier profil pour appara√Ætre dans l'Univers et √™tre trouv√© par les productions.</p>
                <button onclick="app.PublicProfile.createNewProfile()" style="padding: 15px 30px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">‚ûï Cr√©er mon premier profil</button>
            </div>
            
            <!-- Formulaire de profil (cach√© par d√©faut) -->
            <div id="profile-form-container" style="display: none;">
                <div id="profile-status" class="profile-status incomplete">
                    ‚ö†Ô∏è Ce profil est incomplet. Remplissez les champs obligatoires pour appara√Ætre dans les recherches.
                </div>
                
                <!-- Choix du type de profil -->
                <div class="profile-section">
                    <h3>üéØ Type de profil</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <label class="profile-type-card" id="profile-type-actor-label">
                            <input type="radio" name="profile-type" value="actor" id="profile-type-actor" onchange="app.PublicProfile.onProfileTypeChange()" style="display: none;">
                            <span class="profile-type-icon">üé≠</span>
                            <span class="profile-type-name">Com√©dien.ne</span>
                        </label>
                        <label class="profile-type-card" id="profile-type-crew-label">
                            <input type="radio" name="profile-type" value="crew" id="profile-type-crew" onchange="app.PublicProfile.onProfileTypeChange()" style="display: none;">
                            <span class="profile-type-icon">üé•</span>
                            <span class="profile-type-name">Technicien.ne</span>
                        </label>
                        <label class="profile-type-card" id="profile-type-association-label">
                            <input type="radio" name="profile-type" value="association" id="profile-type-association" onchange="app.PublicProfile.onProfileTypeChange()" style="display: none;">
                            <span class="profile-type-icon">üèõÔ∏è</span>
                            <span class="profile-type-name">Association</span>
                        </label>
                        <label class="profile-type-card" id="profile-type-enterprise-label">
                            <input type="radio" name="profile-type" value="enterprise" id="profile-type-enterprise" onchange="app.PublicProfile.onProfileTypeChange()" style="display: none;">
                            <span class="profile-type-icon">üè¢</span>
                            <span class="profile-type-name">Entreprise</span>
                        </label>
                    </div>
                </div>
                
                <!-- Section Identit√© -->
                <div class="profile-section" data-section="identity">
                    <h3>
                        <span class="section-title">üë§ Identit√©</span>
                        <div class="visibility-toggles">
                            <button type="button" class="visibility-btn" data-section="identity" data-scope="public" onclick="app.PublicProfile.toggleVisibility('identity', 'public')" data-tooltip="Visible dans l'Univers">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
                            <button type="button" class="visibility-btn" data-section="identity" data-scope="project" onclick="app.PublicProfile.toggleVisibility('identity', 'project')" data-tooltip="Visible par l'√©quipe">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
                        </div>
                    </h3>
                    <div class="profile-photo-section">
                        <div class="profile-photo-preview" id="profile-photo-preview">üë§</div>
                        <div>
                            <input type="text" class="profile-input" id="profile-photo" placeholder="URL de votre photo" oninput="app.PublicProfile.updatePhotoPreview()">
                            <p style="font-size:0.8rem; color:var(--text-sec); margin-top:5px;">Utilisez un lien vers votre photo (Imgur, Google Drive...)</p>
                        </div>
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-name" placeholder="Nom complet *">
                        <select class="profile-input" id="profile-gender">
                            <option value="">-- Sexe * --</option>
                            <option value="homme">Homme</option>
                            <option value="femme">Femme</option>
                            <option value="non-binaire">Non-binaire</option>
                            <option value="non-precise">Ne souhaite pas pr√©ciser</option>
                        </select>
                    </div>
                    <div class="profile-row">
                        <input type="email" class="profile-input" id="profile-email" placeholder="Email *" readonly>
                        <input type="tel" class="profile-input" id="profile-phone" placeholder="T√©l√©phone *">
                    </div>
                    <div class="profile-row">
                        <input type="text" class="profile-input" id="profile-city" placeholder="Ville / R√©gion *">
                        <input type="text" class="profile-input" id="profile-website" placeholder="Site web / Portfolio">
                    </div>
                    <div class="profile-row">
                        <div class="address-autocomplete-container" style="flex: 1; position: relative;">
                            <input type="text" class="profile-input" id="profile-address" placeholder="Adresse compl√®te * (pour la g√©olocalisation)" autocomplete="off" oninput="app.PublicProfile.searchAddress(this.value)">
                            <div id="profile-address-suggestions" class="address-suggestions"></div>
                        </div>
                    </div>
                    <div id="profile-address-privacy" class="profile-row" style="display: none; flex-direction: column; gap: 8px; background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 5px;">
                        <div style="font-size: 0.85rem; color: var(--text-sec);">üîí Confidentialit√© de l'adresse</div>
                        <label id="profile-hide-address-label" style="display: none; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="profile-hide-address">
                            <span>Masquer mon adresse r√©elle sur la carte (afficher une position approximative)</span>
                        </label>
                        <label id="profile-hide-address-projects-label" style="display: none; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="profile-hide-address-projects">
                            <span>Masquer aussi mon adresse dans les projets (visible uniquement par moi)</span>
                        </label>
                        <div id="profile-address-info" style="display: none; font-size: 0.8rem; color: var(--text-sec); font-style: italic; margin-top: 5px;">
                            ‚ÑπÔ∏è Pour les com√©dien¬∑nes et technicien¬∑nes, l'adresse exacte n'est jamais affich√©e publiquement dans l'Univers (seulement la ville).
                        </div>
                    </div>
                    <textarea class="profile-input profile-textarea" id="profile-bio" placeholder="Bio / Pr√©sentation"></textarea>
                </div>
        
<!-- Section Com√©dien - Description Physique (visible si actor) -->
<div class="profile-section" id="profile-actor-physical-section" data-section="physical" style="display:none;">
    <h3>
        <span class="section-title">üìè Description Physique</span>
        <div class="visibility-toggles">
            <button type="button" class="visibility-btn" data-section="physical" data-scope="public" onclick="app.PublicProfile.toggleVisibility('physical', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
            <button type="button" class="visibility-btn" data-section="physical" data-scope="project" onclick="app.PublicProfile.toggleVisibility('physical', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
        </div>
    </h3>
    <div class="profile-row">
        <input type="number" class="profile-input" id="profile-height" placeholder="Taille (cm)">
        <input type="number" class="profile-input" id="profile-weight" placeholder="Poids (kg)">
        <input type="number" class="profile-input" id="profile-age" placeholder="√Çge">
    </div>
    <div class="profile-row">
        <select class="profile-input" id="profile-eyes">
            <option value="">-- Couleur des yeux --</option>
            <option value="marron">Marron</option>
            <option value="bleu">Bleu</option>
            <option value="vert">Vert</option>
            <option value="gris">Gris</option>
            <option value="noisette">Noisette</option>
            <option value="noir">Noir</option>
        </select>
        <select class="profile-input" id="profile-hair-color">
            <option value="">-- Couleur cheveux --</option>
            <option value="noir">Noir</option>
            <option value="brun">Brun</option>
            <option value="chatain">Ch√¢tain</option>
            <option value="blond">Blond</option>
            <option value="roux">Roux</option>
            <option value="gris">Gris</option>
            <option value="blanc">Blanc</option>
            <option value="chauve">Chauve</option>
        </select>
        <select class="profile-input" id="profile-hair-length">
            <option value="">-- Longueur cheveux --</option>
            <option value="chauve">Chauve</option>
            <option value="rase">Ras√©</option>
            <option value="court">Court</option>
            <option value="mi-long">Mi-long</option>
            <option value="long">Long</option>
        </select>
    </div>
    <div class="profile-row">
        <select class="profile-input" id="profile-ethnicity">
            <option value="">-- Origine ethnique --</option>
            <option value="caucasien">Caucasien</option>
            <option value="africain">Africain / Afro-descendant</option>
            <option value="asiatique">Asiatique</option>
            <option value="latino">Latino / Hispanique</option>
            <option value="maghrebin">Maghr√©bin</option>
            <option value="moyenorient">Moyen-Orient</option>
            <option value="indien">Indien / Sud-asiatique</option>
            <option value="metis">M√©tis</option>
            <option value="autre">Autre</option>
        </select>
        <select class="profile-input" id="profile-corpulence">
            <option value="">-- Corpulence --</option>
            <option value="mince">Mince</option>
            <option value="normal">Normal</option>
            <option value="athletique">Athl√©tique</option>
            <option value="muscle">Muscl√©</option>
            <option value="rond">Rond</option>
            <option value="fort">Fort / Costaud</option>
        </select>
    </div>
    <!-- Langues avec niveaux -->
    <div style="margin-top: 15px;">
        <label style="font-weight: bold; display: block; margin-bottom: 10px;">üó£Ô∏è Langues parl√©es</label>
        <div id="profile-languages-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
        <div style="display: flex; gap: 8px;">
            <select class="profile-input" id="profile-language-select" style="flex: 1;">
                <option value="">-- Ajouter une langue --</option>
                <option value="Fran√ßais">Fran√ßais</option>
                <option value="Anglais">Anglais</option>
                <option value="Espagnol">Espagnol</option>
                <option value="Allemand">Allemand</option>
                <option value="Italien">Italien</option>
                <option value="Portugais">Portugais</option>
                <option value="Arabe">Arabe</option>
                <option value="Chinois">Chinois</option>
                <option value="Japonais">Japonais</option>
                <option value="Russe">Russe</option>
                <option value="N√©erlandais">N√©erlandais</option>
                <option value="Polonais">Polonais</option>
                <option value="Turc">Turc</option>
                <option value="Cor√©en">Cor√©en</option>
                <option value="Hindi">Hindi</option>
                <option value="__custom__">Autre...</option>
            </select>
            <select class="profile-input" id="profile-language-level" style="width: auto;">
                <option value="notions">Notions</option>
                <option value="intermediaire">Interm√©diaire</option>
                <option value="courant" selected>Courant</option>
                <option value="bilingue">Bilingue</option>
                <option value="maternelle">Maternelle</option>
            </select>
            <button type="button" onclick="app.PublicProfile.addLanguage()" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">+</button>
        </div>
    </div>
    
    <!-- Sports avec niveaux -->
    <div style="margin-top: 15px;">
        <label style="font-weight: bold; display: block; margin-bottom: 10px;">üèÉ Sports & Comp√©tences</label>
        <div id="profile-sports-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
        <div style="display: flex; gap: 8px;">
            <select class="profile-input" id="profile-sport-select" style="flex: 1;">
                <option value="">-- Ajouter un sport --</option>
                <option value="√âquitation">√âquitation</option>
                <option value="Natation">Natation</option>
                <option value="Arts martiaux">Arts martiaux</option>
                <option value="Danse">Danse</option>
                <option value="Yoga">Yoga</option>
                <option value="Tennis">Tennis</option>
                <option value="Football">Football</option>
                <option value="Basketball">Basketball</option>
                <option value="Boxe">Boxe</option>
                <option value="Escalade">Escalade</option>
                <option value="Ski">Ski</option>
                <option value="Surf">Surf</option>
                <option value="Cyclisme">Cyclisme</option>
                <option value="Course √† pied">Course √† pied</option>
                <option value="Gymnastique">Gymnastique</option>
                <option value="Escrime">Escrime</option>
                <option value="Tir">Tir</option>
                <option value="Conduite sportive">Conduite sportive</option>
                <option value="Moto">Moto</option>
                <option value="Plong√©e">Plong√©e</option>
                <option value="__custom__">Autre...</option>
            </select>
            <select class="profile-input" id="profile-sport-level" style="width: auto;">
                <option value="debutant">D√©butant</option>
                <option value="amateur">Amateur</option>
                <option value="confirme" selected>Confirm√©</option>
                <option value="competition">Comp√©tition</option>
                <option value="professionnel">Professionnel</option>
            </select>
            <button type="button" onclick="app.PublicProfile.addSport()" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">+</button>
        </div>
    </div>
    <!-- Champs cach√©s pour compatibilit√© -->
    <input type="hidden" id="profile-sports">
    <input type="hidden" id="profile-languages">
</div>

<!-- Section Com√©dien - Galerie Photos (visible si actor) -->
<div class="profile-section" id="profile-actor-section" data-section="gallery" style="display:none;">
    <h3>
        <span class="section-title">üì∏ Galerie Photos</span>
        <div class="visibility-toggles">
            <button type="button" class="visibility-btn" data-section="gallery" data-scope="public" onclick="app.PublicProfile.toggleVisibility('gallery', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
            <button type="button" class="visibility-btn" data-section="gallery" data-scope="project" onclick="app.PublicProfile.toggleVisibility('gallery', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
        </div>
    </h3>
    <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px;">Ajoutez jusqu'√† 3 photos pour votre book (format carr√© recommand√©)</p>
    <div class="actor-gallery" id="actor-gallery">
        <div class="actor-gallery-item" id="gallery-item-0" onclick="document.getElementById('gallery-input-0').focus()">
            <span class="gallery-placeholder">+</span>
        </div>
        <div class="actor-gallery-item" id="gallery-item-1" onclick="document.getElementById('gallery-input-1').focus()">
            <span class="gallery-placeholder">+</span>
        </div>
        <div class="actor-gallery-item" id="gallery-item-2" onclick="document.getElementById('gallery-input-2').focus()">
            <span class="gallery-placeholder">+</span>
        </div>
    </div>
    <input type="text" class="profile-input actor-gallery-input" id="gallery-input-0" placeholder="URL Photo 1" oninput="app.PublicProfile.updateGallery(0, this.value)">
    <input type="text" class="profile-input actor-gallery-input" id="gallery-input-1" placeholder="URL Photo 2" oninput="app.PublicProfile.updateGallery(1, this.value)">
    <input type="text" class="profile-input actor-gallery-input" id="gallery-input-2" placeholder="URL Photo 3" oninput="app.PublicProfile.updateGallery(2, this.value)">
</div>

<!-- Section Com√©dien - Bande D√©mo (visible si actor) -->
<div class="profile-section" id="profile-actor-demoreel-section" data-section="demoreel" style="display:none;">
    <h3>
        <span class="section-title">üé¨ Bande D√©mo</span>
        <div class="visibility-toggles">
            <button type="button" class="visibility-btn" data-section="demoreel" data-scope="public" onclick="app.PublicProfile.toggleVisibility('demoreel', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
            <button type="button" class="visibility-btn" data-section="demoreel" data-scope="project" onclick="app.PublicProfile.toggleVisibility('demoreel', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
        </div>
    </h3>
    <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px;">Ajoutez le lien vers votre bande d√©mo (YouTube, Vimeo, etc.)</p>
    <input type="url" class="profile-input" id="profile-demoreel" placeholder="https://www.youtube.com/watch?v=...">
    <div id="demoreel-preview" style="margin-top: 15px; display: none;">
        <iframe id="demoreel-iframe" width="100%" height="315" frameborder="0" allowfullscreen style="border-radius: 8px;"></iframe>
    </div>
</div>
        
        <!-- Section Technicien (visible si crew) -->
        <div class="profile-section" id="profile-crew-section" data-section="skills" style="display:none;">
            <h3>
                <span class="section-title">üé¨ M√©tier & Comp√©tences</span>
                <div class="visibility-toggles">
                    <button type="button" class="visibility-btn" data-section="skills" data-scope="public" onclick="app.PublicProfile.toggleVisibility('skills', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
                    <button type="button" class="visibility-btn" data-section="skills" data-scope="project" onclick="app.PublicProfile.toggleVisibility('skills', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
                </div>
            </h3>
            <div class="profile-row">
             <select class="profile-input" id="profile-department" onchange="app.PublicProfile.updateRoleOptions()">
    <option value="">-- D√©partement * --</option>
    <option value="gc1">üìπ Image</option>
    <option value="gc2">üí° Lumi√®re</option>
    <option value="gc3">üé¨ R√©alisation</option>
    <option value="gc4">üé§ Son</option>
    <option value="gc5">üé® D√©coration</option>
    <option value="gc6">üëó Costumes</option>
    <option value="gc7">üíÑ Maquillage/Coiffure</option>
    <option value="gc8">üìù Script/Continuit√©</option>
    <option value="gc9">üé≠ R√©gie</option>
    <option value="gc10">üíº Production</option>
    <option value="gc11">üç¥ Catering</option>
    <option value="gc12">üöó Transport/Logistique</option>
    <option value="gc13">üéûÔ∏è Post-production</option>
    <option value="gc14">‚úçÔ∏è Sc√©nario/√âcriture</option>
    <option value="gc15">üéµ Musique</option>
    <option value="gc16">ü¶∫ Cascades/Stunts</option>
    <option value="gc17">‚ûï Autre</option>
</select>
<select class="profile-input" id="profile-role" onchange="app.PublicProfile.onRoleChange()">
    <option value="">-- Fonction * --</option>
</select>
<input type="text" class="profile-input" id="profile-role-custom" placeholder="Pr√©cisez votre fonction..." style="display:none;">
            </div>
            
<h3 style="margin-top:20px;">üîß Mon Mat√©riel</h3>
            <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px;">Le mat√©riel affich√© correspond √† votre d√©partement. Cochez ci-dessous pour voir d'autres cat√©gories.</p>
            
            <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="show-equip-camera" onchange="app.PublicProfile.toggleEquipmentSection('camera')"> üì∑ Cam√©ras
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="show-equip-lens" onchange="app.PublicProfile.toggleEquipmentSection('lens')"> üî≠ Objectifs
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="show-equip-light" onchange="app.PublicProfile.toggleEquipmentSection('light')"> üí° Lumi√®re
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="show-equip-sound" onchange="app.PublicProfile.toggleEquipmentSection('sound')"> üé§ Son
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="show-equip-grip" onchange="app.PublicProfile.toggleEquipmentSection('grip')"> üé¨ Machinerie
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="show-equip-makeup" onchange="app.PublicProfile.toggleEquipmentSection('makeup')"> üíÑ Maquillage
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="show-equip-other" onchange="app.PublicProfile.toggleEquipmentSection('other')"> ‚ûï Autre
                </label>
            </div>
            
            <!-- Cam√©ras -->
            <div id="equip-section-camera" style="display: none; margin-bottom: 15px;">
                <div class="profile-row">
                    <select class="profile-input" id="profile-camera-select">
                        <option value="">-- Ajouter une cam√©ra --</option>
                        <optgroup label="Cin√©ma">
                            <option value="ARRI Alexa Mini">ARRI Alexa Mini</option>
                            <option value="ARRI Alexa Mini LF">ARRI Alexa Mini LF</option>
                            <option value="ARRI Alexa 35">ARRI Alexa 35</option>
                            <option value="RED V-Raptor">RED V-Raptor</option>
                            <option value="RED Komodo">RED Komodo</option>
                            <option value="Sony Venice">Sony Venice</option>
                            <option value="Sony Venice 2">Sony Venice 2</option>
                            <option value="Blackmagic URSA Mini Pro 12K">Blackmagic URSA Mini Pro 12K</option>
                            <option value="Canon C500 Mark II">Canon C500 Mark II</option>
                            <option value="Canon C300 Mark III">Canon C300 Mark III</option>
                        </optgroup>
                        <optgroup label="Semi-Pro / Hybride">
                            <option value="Sony FX9">Sony FX9</option>
                            <option value="Sony FX6">Sony FX6</option>
                            <option value="Sony FX3">Sony FX3</option>
                            <option value="Sony A7S III">Sony A7S III</option>
                            <option value="Panasonic S1H">Panasonic S1H</option>
                            <option value="Blackmagic Pocket 6K Pro">Blackmagic Pocket 6K Pro</option>
                            <option value="Canon R5 C">Canon R5 C</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('camera')" style="padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="camera-list"></div>
            </div>
            
            <!-- Objectifs -->
            <div id="equip-section-lens" style="display: none; margin-bottom: 15px;">
                <div class="profile-row">
                    <select class="profile-input" id="profile-lens-select">
                        <option value="">-- Ajouter un objectif --</option>
                        <optgroup label="Cin√©ma - Primes">
                            <option value="Zeiss Master Prime">Zeiss Master Prime</option>
                            <option value="Zeiss Supreme Prime">Zeiss Supreme Prime</option>
                            <option value="Zeiss CP.3">Zeiss CP.3</option>
                            <option value="Cooke S4/i">Cooke S4/i</option>
                            <option value="ARRI Signature Prime">ARRI Signature Prime</option>
                        </optgroup>
                        <optgroup label="Cin√©ma - Zooms">
                            <option value="Ang√©nieux EZ-1 30-90">Ang√©nieux EZ-1 30-90</option>
                            <option value="Ang√©nieux Optimo 24-290">Ang√©nieux Optimo 24-290</option>
                            <option value="Fujinon Premista 28-100">Fujinon Premista 28-100</option>
                        </optgroup>
                        <optgroup label="Photo / Hybride">
                            <option value="Canon RF 24-70 f/2.8">Canon RF 24-70 f/2.8</option>
                            <option value="Sony GM 24-70 f/2.8">Sony GM 24-70 f/2.8</option>
                            <option value="Sigma Art 24-70 f/2.8">Sigma Art 24-70 f/2.8</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('lens')" style="padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="lens-list"></div>
            </div>
            
            <!-- Lumi√®re -->
            <div id="equip-section-light" style="display: none; margin-bottom: 15px;">
                <div class="profile-row">
                    <select class="profile-input" id="profile-light-select">
                        <option value="">-- Ajouter un projecteur --</option>
                        <optgroup label="LED">
                            <option value="ARRI SkyPanel S60">ARRI SkyPanel S60</option>
                            <option value="ARRI SkyPanel S120">ARRI SkyPanel S120</option>
                            <option value="ARRI Orbiter">ARRI Orbiter</option>
                            <option value="Aputure 600d Pro">Aputure 600d Pro</option>
                            <option value="Aputure 300d II">Aputure 300d II</option>
                            <option value="Aputure Nova P300c">Aputure Nova P300c</option>
                            <option value="Nanlite Forza 500">Nanlite Forza 500</option>
                            <option value="Litepanels Astra 6X">Litepanels Astra 6X</option>
                            <option value="Litepanels Gemini 2x1">Litepanels Gemini 2x1</option>
                        </optgroup>
                        <optgroup label="HMI / Tungst√®ne">
                            <option value="ARRI M18">ARRI M18</option>
                            <option value="ARRI M40">ARRI M40</option>
                            <option value="ARRI True Blue T1">ARRI True Blue T1</option>
                            <option value="ARRI True Blue T5">ARRI True Blue T5</option>
                        </optgroup>
                        <optgroup label="Tubes / Flex">
                            <option value="Astera Titan Tube">Astera Titan Tube</option>
                            <option value="Quasar Science Rainbow 2">Quasar Science Rainbow 2</option>
                            <option value="Nanlite PavoTube II">Nanlite PavoTube II</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('light')" style="padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="light-list"></div>
            </div>
            
            <!-- Son -->
            <div id="equip-section-sound" style="display: none; margin-bottom: 15px;">
                <div class="profile-row">
                    <select class="profile-input" id="profile-sound-select">
                        <option value="">-- Ajouter du mat√©riel son --</option>
                        <optgroup label="Enregistreurs">
                            <option value="Sound Devices MixPre-10 II">Sound Devices MixPre-10 II</option>
                            <option value="Sound Devices 833">Sound Devices 833</option>
                            <option value="Sound Devices 888">Sound Devices 888</option>
                            <option value="Zoom F8n Pro">Zoom F8n Pro</option>
                            <option value="Zoom F6">Zoom F6</option>
                        </optgroup>
                        <optgroup label="Micros">
                            <option value="Sennheiser MKH 416">Sennheiser MKH 416</option>
                            <option value="Sennheiser MKH 8060">Sennheiser MKH 8060</option>
                            <option value="Schoeps CMIT 5U">Schoeps CMIT 5U</option>
                            <option value="Rode NTG5">Rode NTG5</option>
                            <option value="DPA 4017B">DPA 4017B</option>
                        </optgroup>
                        <optgroup label="HF / Lavaliers">
                            <option value="Sennheiser EW 500 G4">Sennheiser EW 500 G4</option>
                            <option value="Lectrosonics SMWB">Lectrosonics SMWB</option>
                            <option value="Sony UWP-D21">Sony UWP-D21</option>
                            <option value="Rode Wireless GO II">Rode Wireless GO II</option>
                            <option value="DPA 4060">DPA 4060</option>
                            <option value="Sanken COS-11D">Sanken COS-11D</option>
                        </optgroup>
                        <optgroup label="Perches">
                            <option value="K-Tek KE-110">K-Tek KE-110</option>
                            <option value="Ambient QP 5100">Ambient QP 5100</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('sound')" style="padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="sound-list"></div>
            </div>
            
            <!-- Machinerie -->
            <div id="equip-section-grip" style="display: none; margin-bottom: 15px;">
                <div class="profile-row">
                    <select class="profile-input" id="profile-grip-select">
                        <option value="">-- Ajouter du mat√©riel machinerie --</option>
                        <optgroup label="Stabilisateurs">
                            <option value="DJI Ronin 2">DJI Ronin 2</option>
                            <option value="DJI RS 3 Pro">DJI RS 3 Pro</option>
                            <option value="Freefly M≈çVI Pro">Freefly M≈çVI Pro</option>
                        </optgroup>
                        <optgroup label="Slider / Dolly">
                            <option value="Slider motoris√© 120cm">Slider motoris√© 120cm</option>
                            <option value="Dana Dolly">Dana Dolly</option>
                            <option value="Doorway Dolly">Doorway Dolly</option>
                        </optgroup>
                        <optgroup label="T√™tes / Pieds">
                            <option value="O'Connor 2575">O'Connor 2575</option>
                            <option value="Sachtler Video 18">Sachtler Video 18</option>
                            <option value="Ronford-Baker">Ronford-Baker</option>
                        </optgroup>
                        <optgroup label="Drones">
                            <option value="DJI Inspire 3">DJI Inspire 3</option>
                            <option value="DJI Mavic 3 Pro Cine">DJI Mavic 3 Pro Cine</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('grip')" style="padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="grip-list"></div>
            </div>
            
            <!-- Maquillage -->
            <div id="equip-section-makeup" style="display: none; margin-bottom: 15px;">
                <div class="profile-row">
                    <select class="profile-input" id="profile-makeup-select">
                        <option value="">-- Ajouter du mat√©riel maquillage --</option>
                        <optgroup label="A√©rographe">
                            <option value="Kit A√©rographe Iwata">Kit A√©rographe Iwata</option>
                            <option value="Kit A√©rographe Temptu">Kit A√©rographe Temptu</option>
                            <option value="Compresseur silencieux">Compresseur silencieux</option>
                        </optgroup>
                        <optgroup label="√âclairage">
                            <option value="Ring Light Pro">Ring Light Pro</option>
                            <option value="Miroir LED Hollywood">Miroir LED Hollywood</option>
                        </optgroup>
                        <optgroup label="Mallettes">
                            <option value="Mallette Zuca Pro">Mallette Zuca Pro</option>
                            <option value="Trolley maquillage XXL">Trolley maquillage XXL</option>
                        </optgroup>
                        <optgroup label="FX / Proth√®ses">
                            <option value="Kit proth√®ses silicone">Kit proth√®ses silicone</option>
                            <option value="Kit cicatrices/blessures">Kit cicatrices/blessures</option>
                            <option value="Kit vieillissement">Kit vieillissement</option>
                        </optgroup>
                    </select>
                    <button onclick="app.PublicProfile.addEquipment('makeup')" style="padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="makeup-list"></div>
            </div>
            
            <!-- Autre -->
            <div id="equip-section-other" style="display: none; margin-bottom: 15px;">
                <div class="profile-row">
                    <input type="text" class="profile-input" id="profile-other-equipment" placeholder="Autre mat√©riel (moniteur, transmission vid√©o...)">
                    <button onclick="app.PublicProfile.addEquipment('other')" style="padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                </div>
                <div class="equipment-list" id="other-equipment-list"></div>
            </div>
        </div>
            </div>
        </div>
        
        <!-- Section Technicien - Galerie Photos (visible si crew) -->
        <div class="profile-section" id="profile-crew-gallery-section" data-section="crew-gallery" style="display:none;">
            <h3>
                <span class="section-title">üì∏ Galerie Photos</span>
                <div class="visibility-toggles">
                    <button type="button" class="visibility-btn" data-section="crew-gallery" data-scope="public" onclick="app.PublicProfile.toggleVisibility('crew-gallery', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
                    <button type="button" class="visibility-btn" data-section="crew-gallery" data-scope="project" onclick="app.PublicProfile.toggleVisibility('crew-gallery', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
                </div>
            </h3>
            <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px;">Ajoutez jusqu'√† 3 photos de vos r√©alisations ou de vous en situation de travail</p>
            <div class="actor-gallery" id="crew-gallery">
                <div class="actor-gallery-item" id="crew-gallery-item-0" onclick="document.getElementById('crew-gallery-input-0').focus()">
                    <span class="gallery-placeholder">+</span>
                </div>
                <div class="actor-gallery-item" id="crew-gallery-item-1" onclick="document.getElementById('crew-gallery-input-1').focus()">
                    <span class="gallery-placeholder">+</span>
                </div>
                <div class="actor-gallery-item" id="crew-gallery-item-2" onclick="document.getElementById('crew-gallery-input-2').focus()">
                    <span class="gallery-placeholder">+</span>
                </div>
            </div>
            <input type="text" class="profile-input actor-gallery-input" id="crew-gallery-input-0" placeholder="URL Photo 1" oninput="app.PublicProfile.updateCrewGallery(0, this.value)">
            <input type="text" class="profile-input actor-gallery-input" id="crew-gallery-input-1" placeholder="URL Photo 2" oninput="app.PublicProfile.updateCrewGallery(1, this.value)">
            <input type="text" class="profile-input actor-gallery-input" id="crew-gallery-input-2" placeholder="URL Photo 3" oninput="app.PublicProfile.updateCrewGallery(2, this.value)">
        </div>
        
        <!-- Section Technicien - Bande D√©mo (visible si crew avec m√©tier visuel) -->
        <div class="profile-section" id="profile-crew-demoreel-section" data-section="crew-demoreel" style="display:none;">
            <h3>
                <span class="section-title">üé¨ Bande D√©mo / Showreel</span>
                <div class="visibility-toggles">
                    <button type="button" class="visibility-btn" data-section="crew-demoreel" data-scope="public" onclick="app.PublicProfile.toggleVisibility('crew-demoreel', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
                    <button type="button" class="visibility-btn" data-section="crew-demoreel" data-scope="project" onclick="app.PublicProfile.toggleVisibility('crew-demoreel', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
                </div>
            </h3>
            <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px;">Montrez votre travail (r√©alisation, image, montage, VFX, musique...)</p>
            <input type="url" class="profile-input" id="profile-crew-demoreel" placeholder="https://www.youtube.com/watch?v=... ou https://vimeo.com/...">
            <div id="crew-demoreel-preview" style="margin-top: 15px; display: none;">
                <iframe id="crew-demoreel-iframe" width="100%" height="315" frameborder="0" allowfullscreen style="border-radius: 8px;"></iframe>
            </div>
        </div>
        
        <!-- Section Association (visible si association) -->
        <div class="profile-section" id="profile-association-section" style="display:none;">
            <h3>üèõÔ∏è Informations Association</h3>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-asso-name" placeholder="Nom de l'association *">
                <select class="profile-input" id="profile-asso-type">
                    <option value="">-- Type d'association * --</option>
                </select>
            </div>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-asso-siret" placeholder="N¬∞ SIRET / RNA (optionnel)">
                <input type="number" class="profile-input" id="profile-asso-members" placeholder="Nombre de membres">
            </div>
            <div class="profile-row">
                <input type="number" class="profile-input" id="profile-asso-year" placeholder="Ann√©e de cr√©ation">
                <input type="text" class="profile-input" id="profile-asso-president" placeholder="Pr√©sident(e)">
            </div>
            <textarea class="profile-input profile-textarea" id="profile-asso-mission" placeholder="Mission / Objectifs de l'association *"></textarea>
            <textarea class="profile-input profile-textarea" id="profile-asso-activities" placeholder="Activit√©s principales (ateliers, formations, √©v√©nements...)"></textarea>
            
            <h4 style="margin-top: 20px;">üéØ Services propos√©s</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="asso-service-formation"> üìö Formations
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="asso-service-ateliers"> üé¨ Ateliers pratiques
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="asso-service-networking"> ü§ù Networking
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="asso-service-casting"> üé≠ Casting
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="asso-service-materiel"> üì¶ Pr√™t de mat√©riel
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="asso-service-production"> üé• Aide √† la production
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="asso-service-diffusion"> üìΩÔ∏è Diffusion / Festivals
                </label>
            </div>
            
            <h4 style="margin-top: 20px;">üíª Pr√©sence en ligne</h4>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-asso-facebook" placeholder="Page Facebook">
                <input type="text" class="profile-input" id="profile-asso-instagram" placeholder="Instagram">
            </div>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-asso-youtube" placeholder="Cha√Æne YouTube">
                <input type="text" class="profile-input" id="profile-asso-linkedin" placeholder="Page LinkedIn">
            </div>
            
            <h4 style="margin-top: 20px;">üé¨ Showreel / Vid√©o de pr√©sentation</h4>
            <input type="url" class="profile-input" id="profile-asso-demoreel" placeholder="https://www.youtube.com/watch?v=... ou https://vimeo.com/...">
            <div id="asso-demoreel-preview" style="margin-top: 15px; display: none;">
                <iframe id="asso-demoreel-iframe" width="100%" height="315" frameborder="0" allowfullscreen style="border-radius: 8px;"></iframe>
            </div>
        </div>
        
        <!-- Section Entreprise (visible si enterprise) -->
        <div class="profile-section" id="profile-enterprise-section" style="display:none;">
            <h3>üè¢ Informations Entreprise</h3>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-ent-name" placeholder="Nom de l'entreprise *">
                <select class="profile-input" id="profile-ent-type">
                    <option value="">-- Type d'entreprise * --</option>
                </select>
            </div>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-ent-siret" placeholder="N¬∞ SIRET *">
                <select class="profile-input" id="profile-ent-legal">
                    <option value="">-- Forme juridique --</option>
                    <option value="sarl">SARL</option>
                    <option value="sas">SAS</option>
                    <option value="eurl">EURL</option>
                    <option value="sasu">SASU</option>
                    <option value="sa">SA</option>
                    <option value="micro">Micro-entreprise</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            <div class="profile-row">
                <input type="number" class="profile-input" id="profile-ent-year" placeholder="Ann√©e de cr√©ation">
                <input type="number" class="profile-input" id="profile-ent-employees" placeholder="Nombre d'employ√©s">
            </div>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-ent-director" placeholder="G√©rant / Directeur">
                <input type="text" class="profile-input" id="profile-ent-contact" placeholder="Contact commercial">
            </div>
            <textarea class="profile-input profile-textarea" id="profile-ent-description" placeholder="Description de l'entreprise *"></textarea>
            <textarea class="profile-input profile-textarea" id="profile-ent-services" placeholder="Services propos√©s (d√©taillez vos prestations)"></textarea>
            
            <h4 style="margin-top: 20px;">üéØ Sp√©cialit√©s</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="ent-spec-fiction"> üé¨ Fiction
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="ent-spec-doc"> üìπ Documentaire
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="ent-spec-pub"> üì∫ Publicit√©
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="ent-spec-corporate"> üíº Corporate
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="ent-spec-clip"> üéµ Clip musical
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="ent-spec-event"> üé™ √âv√©nementiel
                </label>
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 12px; border:1px solid var(--border); border-radius:20px; background:var(--bg);">
                    <input type="checkbox" id="ent-spec-web"> üåê Web / R√©seaux sociaux
                </label>
            </div>
            
            <h4 style="margin-top: 20px;">üíª Pr√©sence en ligne</h4>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-ent-facebook" placeholder="Page Facebook">
                <input type="text" class="profile-input" id="profile-ent-instagram" placeholder="Instagram">
            </div>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-ent-youtube" placeholder="Cha√Æne YouTube">
                <input type="text" class="profile-input" id="profile-ent-linkedin" placeholder="Page LinkedIn">
            </div>
            <div class="profile-row">
                <input type="text" class="profile-input" id="profile-ent-vimeo" placeholder="Vimeo / Portfolio">
                <input type="text" class="profile-input" id="profile-ent-imdb" placeholder="Page IMDb">
            </div>
            
            <h4 style="margin-top: 20px;">üé¨ Showreel / Vid√©o de pr√©sentation</h4>
            <input type="url" class="profile-input" id="profile-ent-demoreel" placeholder="https://www.youtube.com/watch?v=... ou https://vimeo.com/...">
            <div id="ent-demoreel-preview" style="margin-top: 15px; display: none;">
                <iframe id="ent-demoreel-iframe" width="100%" height="315" frameborder="0" allowfullscreen style="border-radius: 8px;"></iframe>
            </div>
        </div>
        
        <!-- Section Tarif & Collaboration (pour tous) -->
        <div class="profile-section" data-section="tarif">
            <h3>
                <span class="section-title">üí∞ Tarif & Collaboration</span>
                <div class="visibility-toggles">
                    <button type="button" class="visibility-btn" data-section="tarif" data-scope="public" onclick="app.PublicProfile.toggleVisibility('tarif', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
                    <button type="button" class="visibility-btn" data-section="tarif" data-scope="project" onclick="app.PublicProfile.toggleVisibility('tarif', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
                </div>
            </h3>
            <div class="profile-row">
                <input type="number" class="profile-input" id="profile-rate" placeholder="Tarif journalier">
                <select class="profile-input" id="profile-currency">
                    <option value="‚Ç¨">‚Ç¨ Euro</option>
                    <option value="$">$ Dollar</option>
                    <option value="¬£">¬£ Livre</option>
                    <option value="CHF">CHF Franc suisse</option>
                </select>
            </div>
            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin: 10px 0;">
                <input type="checkbox" id="profile-rate-negotiable" style="width:18px; height:18px;">
                <span>ü§ù Tarif n√©gociable selon le projet</span>
            </label>
            <textarea class="profile-input profile-textarea" id="profile-availability" placeholder="Vos disponibilit√©s g√©n√©rales (ex: Disponible les weekends, Libre √† partir de mars 2025...)"></textarea>
            
            <div style="margin-top: 15px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">ü§ù Type de collaboration accept√©e</label>
                <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px;">Cochez les types de projets qui vous int√©ressent (plusieurs choix possibles)</p>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 15px; border:2px solid #4CAF50; border-radius:20px; background:var(--bg);" id="label-collab-pro">
                        <input type="checkbox" id="profile-collab-pro" onchange="app.PublicProfile.updateCollabLabel('pro')">
                        <span>üé¨ Pro</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 15px; border:2px solid #FF9800; border-radius:20px; background:var(--bg);" id="label-collab-semi">
                        <input type="checkbox" id="profile-collab-semi" onchange="app.PublicProfile.updateCollabLabel('semi')">
                        <span>‚ö° Semi-pro</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 15px; border:2px solid #E91E63; border-radius:20px; background:var(--bg);" id="label-collab-benevole">
                        <input type="checkbox" id="profile-collab-benevole" onchange="app.PublicProfile.updateCollabLabel('benevole')">
                        <span>‚ù§Ô∏è B√©n√©vole</span>
                    </label>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-sec); margin-top: 8px;">
                    üé¨ Pro = Contrats et tarifs standards | ‚ö° Semi-pro = Flexible mais pay√© | ‚ù§Ô∏è B√©n√©vole = D√©fraiement uniquement
                </p>
            </div>
        </div>
        
        <!-- Section Calendrier (pour tous) -->
        <div class="profile-section" data-section="calendar">
            <h3>
                <span class="section-title">üìÖ Calendrier des disponibilit√©s</span>
                <div class="visibility-toggles">
                    <button type="button" class="visibility-btn" data-section="calendar" data-scope="public" onclick="app.PublicProfile.toggleVisibility('calendar', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
                    <button type="button" class="visibility-btn" data-section="calendar" data-scope="project" onclick="app.PublicProfile.toggleVisibility('calendar', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
                </div>
            </h3>
            <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px;">Clic gauche = disponible üü¢ | Clic droit = indisponible üî¥</p>
            <div id="profile-availability-calendar"></div>
            <!-- Les listes de p√©riodes sont masqu√©es car d√©j√† visibles dans le calendrier -->
            <div id="profile-avail-dates-list" style="display:none;"></div>
            <div id="profile-unavail-dates-list" style="display:none;"></div>
        </div>
        
	
        <!-- Section V√©hicule -->
        <div class="profile-section" data-section="vehicle">
            <h3>
                <span class="section-title">üöó V√©hicule</span>
                <div class="visibility-toggles">
                    <button type="button" class="visibility-btn" data-section="vehicle" data-scope="public" onclick="app.PublicProfile.toggleVisibility('vehicle', 'public')" title="Visibilit√© publique (Univers)">üåç <span class="vis-icon">üëÅÔ∏è</span></button>
                    <button type="button" class="visibility-btn" data-section="vehicle" data-scope="project" onclick="app.PublicProfile.toggleVisibility('vehicle', 'project')" title="Visibilit√© projet (√©quipe)">üé¨ <span class="vis-icon">üëÅÔ∏è</span></button>
                </div>
            </h3>
            <div class="profile-row">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="profile-has-vehicle" onchange="document.getElementById('profile-vehicle-details').style.display = this.checked ? 'block' : 'none';">
                    <span>Je poss√®de un v√©hicule</span>
                </label>
            </div>
            <div id="profile-vehicle-details" style="display:none; margin-top:15px; padding:20px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                <div class="profile-row">
                    <div>
                        <label style="display:block; font-size:0.85rem; color:var(--text-sec); margin-bottom:5px;">Type de v√©hicule</label>
                        <input type="text" class="profile-input" id="profile-vehicle-type" placeholder="Ex: Citro√´n C3, Renault Kangoo...">
                    </div>
                    <div>
                        <label style="display:block; font-size:0.85rem; color:var(--text-sec); margin-bottom:5px;">Immatriculation</label>
                        <input type="text" class="profile-input" id="profile-vehicle-plate" placeholder="AA-123-BB">
                    </div>
                </div>
                <div class="profile-row">
                    <div>
                        <label style="display:block; font-size:0.85rem; color:var(--text-sec); margin-bottom:5px;">Places disponibles</label>
                        <input type="number" class="profile-input" id="profile-vehicle-seats" placeholder="Nombre de places" min="1" max="9">
                    </div>
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:12px; background:var(--panel-bg); border-radius:6px; height:fit-content; margin-top:auto;">
                        <input type="checkbox" id="profile-vehicle-trunk" style="width:18px; height:18px;">
                        <span>üì¶ Coffre disponible pour mat√©riel</span>
                    </label>
                </div>
                <div class="profile-row" style="margin-top:10px;">
                    <textarea class="profile-input" id="profile-vehicle-notes" placeholder="Notes v√©hicule (climatisation, GPS, attelage...)" style="min-height:60px; resize:vertical;"></textarea>
                </div>
            </div>
        </div>
        
        <!-- Zone Danger - Suppression profil et compte -->
        <div class="profile-section" style="border-color: var(--danger); margin-top: 30px;">
            <h3 style="color: var(--danger);">‚ö†Ô∏è Zone Danger</h3>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px;">
                    <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px;">
                        Supprimer ce profil de l'Univers. Vos autres profils ne seront pas affect√©s.
                    </p>
                    <button onclick="app.PublicProfile.deleteCurrentProfile()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        üóëÔ∏è Supprimer ce profil
                    </button>
                </div>
                <div style="flex: 1; min-width: 250px;">
                    <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px;">
                        Supprimer votre compte et tous vos projets. Action irr√©versible.
                    </p>
                    <button onclick="app.PublicProfile.deleteAccount()" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        üóëÔ∏è Supprimer mon compte
                    </button>
                </div>
            </div>
        </div>
        </div>
        
        <!-- Conteneur Messages -->
        <div id="messages-content" style="display:none;">
            <div class="messages-section">
                <div style="margin-bottom: 15px; padding: 15px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="messages-filter-profile" onchange="app.Messages.applyFilters()" style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                            <option value="">üì¨ Tous les profils</option>
                        </select>
                        <select id="messages-filter-type" onchange="app.Messages.applyFilters()" style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                            <option value="">üìã Tous les types</option>
                            <option value="invitation">üé¨ Invitations</option>
                            <option value="convocation">üìÖ Convocations</option>
                            <option value="info">‚ÑπÔ∏è Informations</option>
                        </select>
                        <select id="messages-filter-status" onchange="app.Messages.applyFilters()" style="flex: 1; min-width: 120px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                            <option value="">üì® Tous</option>
                            <option value="unread">üî¥ Non lus</option>
                            <option value="read">‚úÖ Lus</option>
                        </select>
                    </div>
                </div>
                <div class="message-list" id="messages-list">
                    <div class="message-empty">üì≠ Aucun message pour le moment.</div>
                </div>
            </div>
        </div>
    </div>
  </div>
  
  <!-- Modal profil complet -->
<div id="profile-modal-overlay" class="profile-modal-overlay" style="display:none;">
  <div class="profile-modal-box">
    <div class="profile-modal-header">
      <button class="profile-modal-close" onclick="app.Universe.closeProfileModal()">‚úñ</button>
      <button class="favorite-btn" id="pm-favorite-btn" onclick="app.Universe.toggleFavorite()" data-tooltip="Ajouter aux favoris">‚òÜ</button>
      <div class="profile-modal-photo" id="pm-photo">üë§</div>
      <div class="profile-modal-name" id="pm-name">Nom</div>
      <div class="profile-modal-role" id="pm-role">M√©tier</div>
      <div class="profile-modal-city" id="pm-city">üìç Ville</div>
    </div>
    <div class="profile-modal-body">
      <div class="profile-modal-section" id="pm-bio-section">
        <h4>Bio</h4>
        <p id="pm-bio"></p>
      </div>
      <div class="profile-modal-section">
        <h4>Informations</h4>
        <div class="profile-modal-info" id="pm-info"></div>
      </div>
      <div class="profile-modal-section" id="pm-contact-section">
        <h4>Contact</h4>
        <div class="profile-modal-info" id="pm-contact"></div>
      </div>
      <div class="profile-modal-section" id="pm-shooting-section" style="display:none;">
        <h4>üé¨ Prochains tournages</h4>
        <div id="pm-shooting-dates"></div>
      </div>
      <div class="profile-modal-section" id="pm-demoreel-section" style="display:none;">
        <h4>üé¨ Bande D√©mo</h4>
        <div id="pm-demoreel"></div>
      </div>
    </div>
    <div class="profile-modal-actions">
      <button onclick="app.Universe.closeProfileModal()" style="background: var(--border); color: var(--text-main); border: none;">Fermer</button>
      <button onclick="app.Universe.contactProfile()" style="background: #e94560; color: white; border: none;">üìß Contacter</button>
      <button onclick="app.Universe.exportProfilePDF()" style="background: var(--success); color: white; border: none;">üìÑ Export PDF</button>
      <button onclick="app.Universe.addToProject()" style="background: var(--primary); color: white; border: none;">üìÅ Ajouter √† un projet</button>
    </div>
  </div>
</div>

<!-- Modal s√©lection projet -->
<div id="select-project-modal" class="profile-modal-overlay" style="display:none;">
  <div class="profile-modal-box" style="max-width: 400px;">
    <div class="profile-modal-header" style="padding: 20px;">
      <button class="profile-modal-close" onclick="document.getElementById('select-project-modal').style.display='none'">‚úñ</button>
      <h3 style="margin: 0;">üìÅ Ajouter √† un projet</h3>
    </div>
    <div class="profile-modal-body">
      <p style="color: var(--text-sec); margin-bottom: 15px;">S√©lectionnez le projet auquel vous souhaitez ajouter cette personne :</p>
      <div id="select-project-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
    </div>
  </div>
</div>
  
  <!-- Modal ajout/√©dition d√©pense -->
<div id="expense-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box" style="max-width: 550px;">
        <h3 id="expense-modal-title">‚ûï Nouvelle D√©pense</h3>
        <input type="hidden" id="expense-edit-id">
        
        <input type="text" id="expense-title" class="profile-input" placeholder="Titre de la d√©pense *" style="margin-bottom: 10px;">
        
        <!-- Cat√©gorie CNC + Sous-cat√©gorie -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select id="expense-category" class="profile-input" style="flex: 1;" onchange="app.Expenses.onCategoryChange()">
                <option value="">-- Cat√©gorie CNC * --</option>
            </select>
            <select id="expense-subcategory" class="profile-input" style="flex: 1;">
                <option value="">-- Sous-cat√©gorie --</option>
            </select>
        </div>
        
        <!-- Montants HT / TVA / TTC -->
        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 2;">
                    <label style="font-size: 0.75rem; color: var(--text-sec); display: block; margin-bottom: 4px;">üí∞ Montant HT *</label>
                    <input type="number" id="expense-amount-ht" class="profile-input" placeholder="0.00" step="0.01" oninput="app.Expenses.calculateTTCFromHT()">
                </div>
                <div style="flex: 1;">
                    <label style="font-size: 0.75rem; color: var(--text-sec); display: block; margin-bottom: 4px;">TVA</label>
                    <select id="expense-vat-rate" class="profile-input" onchange="app.Expenses.calculateTTCFromHT()">
                        <option value="0">0%</option>
                        <option value="5.5">5.5%</option>
                        <option value="10">10%</option>
                        <option value="20" selected>20%</option>
                    </select>
                </div>
                <div style="flex: 2;">
                    <label style="font-size: 0.75rem; color: var(--text-sec); display: block; margin-bottom: 4px;">üí∂ Montant TTC</label>
                    <input type="number" id="expense-amount-ttc" class="profile-input" placeholder="0.00" step="0.01" oninput="app.Expenses.calculateHTFromTTC()">
                </div>
            </div>
        </div>
        
        <textarea id="expense-description" class="profile-input" placeholder="Description / Justification..." style="height: 60px; margin-bottom: 10px; resize: vertical;"></textarea>
        
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <div style="flex: 1;">
                <label style="font-size: 0.75rem; color: var(--text-sec); display: block; margin-bottom: 4px;">üí≥ Pay√© par</label>
                <select id="expense-paid-by" class="profile-input" style="width: 100%;">
                    <option value="">-- Production --</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label style="font-size: 0.75rem; color: var(--text-sec); display: block; margin-bottom: 4px;">üìÖ Date</label>
                <input type="date" id="expense-date" class="profile-input" style="width: 100%;">
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select id="expense-status" class="profile-input" style="flex: 1;">
                <option value="pending">‚è≥ En attente de validation</option>
                <option value="approved">‚úÖ Valid√©</option>
                <option value="done">üí∞ D√©j√† pay√©</option>
            </select>
        </div>
        
        <!-- Justificatifs -->
        <div style="margin-bottom: 15px;">
            <label style="font-size: 0.85rem; color: var(--text-sec); display: block; margin-bottom: 5px;">üìé Justificatifs (facture, ticket...)</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="expense-attachment-url" class="profile-input" placeholder="URL du fichier ou glisser une image" style="flex: 1;">
                <label style="padding: 8px 15px; background: var(--primary); color: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                    üì∑ Photo
                    <input type="file" id="expense-attachment-file" accept="image/*" style="display: none;" onchange="app.Expenses.handleFileUpload(this)">
                </label>
            </div>
            <div id="expense-attachments-list" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
        </div>
        
        <!-- Champ cach√© pour r√©trocompatibilit√© -->
        <input type="hidden" id="expense-photo">
        <input type="hidden" id="expense-dept">
        <input type="hidden" id="expense-amount">
        
        <div class="modal-btns">
            <button onclick="document.getElementById('expense-modal').style.display='none'" style="background:var(--bg); color:var(--text-main); border:1px solid var(--border); padding:10px 20px; border-radius:6px; cursor:pointer">Annuler</button>
            <button onclick="app.Expenses.saveExpense()" style="background:var(--success); color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight: bold;">üíæ Enregistrer</button>
        </div>
    </div>
</div>

<!-- Modal validation d√©pense -->
<div id="expense-validate-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box" style="max-width: 450px;">
        <h3>‚úÖ Valider la d√©pense</h3>
        <div id="expense-validate-content"></div>
        <textarea id="expense-validate-comment" class="profile-input" placeholder="Commentaire (optionnel)..." style="height: 60px; margin: 15px 0; resize: vertical;"></textarea>
        <div class="modal-btns">
            <button onclick="app.Expenses.rejectExpense()" style="background:var(--danger); color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">‚ùå Refuser</button>
            <button onclick="document.getElementById('expense-validate-modal').style.display='none'" style="background:var(--bg); color:var(--text-main); border:1px solid var(--border); padding:10px 20px; border-radius:6px; cursor:pointer">Annuler</button>
            <button onclick="app.Expenses.approveExpense()" style="background:var(--success); color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight: bold;">‚úÖ Valider</button>
        </div>
    </div>
</div>
  
  <!-- Modal d√©tail message -->
  <div id="message-detail-modal" class="message-detail-modal" style="display:none;">
    <div class="message-detail-box">
        <div class="message-detail-header">
            <h3 id="message-detail-title">Titre du message</h3>
            <button onclick="app.Messages.closeDetail()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úñ</button>
        </div>
        <div class="message-detail-body">
            <div class="message-detail-meta" id="message-detail-meta"></div>
            <div class="message-detail-content" id="message-detail-content"></div>
        </div>
        <div id="message-detail-quick-actions" style="display:none; padding: 15px 20px; background: var(--bg); border-top: 1px solid var(--border);"></div>
        <div class="message-detail-actions">
            <button onclick="app.Messages.deleteMessage()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">üóëÔ∏è Supprimer</button>
            <button onclick="app.Messages.closeDetail()" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Fermer</button>
        </div>
    </div>
  </div>
  
  <div id="contacts-view" class="contacts-view">
    <div class="contacts-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button onclick="app.Contacts.close()" style="background:var(--border); color:var(--text-main); border:none; padding:8px 15px; border-radius:6px; font-weight:bold; cursor:pointer">‚¨Ö Retour</button>
            <h1 id="contacts-title">üìá Mes Contacts</h1>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
            <button class="theme-btn" onclick="app.UI.toggleTheme()">üåì Mode</button>
        </div>
    </div>
    <div class="contacts-body">
        <div class="contacts-tabs" style="margin-bottom:10px;">
            <div class="contacts-tab active" onclick="app.Contacts.switchMode('favorites')">‚≠ê Mes Favoris</div>
            <div class="contacts-tab" onclick="app.Contacts.switchMode('directory')">üåê Annuaire</div>
        </div>
        <div id="contacts-sub-tabs" class="contacts-tabs" style="margin-bottom:15px; flex-wrap: wrap;">
            <div class="contacts-tab active" onclick="app.Contacts.switchTab('actors')" style="padding:8px 15px; font-size:0.9rem;">üé≠ Com√©dien.nes</div>
            <div class="contacts-tab" onclick="app.Contacts.switchTab('crew')" style="padding:8px 15px; font-size:0.9rem;">üé• Technicien.nes</div>
            <div class="contacts-tab" onclick="app.Contacts.switchTab('projects')" style="padding:8px 15px; font-size:0.9rem;">üé¨ Projets</div>
            <div class="contacts-tab" onclick="app.Contacts.switchTab('associations')" style="padding:8px 15px; font-size:0.9rem;">üèõÔ∏è Associations</div>
            <div class="contacts-tab" onclick="app.Contacts.switchTab('enterprises')" style="padding:8px 15px; font-size:0.9rem;">üè¢ Entreprises</div>
        </div>
        <div id="contacts-filters" style="display:none; margin-bottom:15px; padding:15px; background:var(--panel-bg); border:1px solid var(--border); border-radius:8px;"></div>
        <div id="contacts-list" class="contacts-grid"></div>
    </div>
  </div>

  <!-- VUE COURS CIN√âMA -->
  <div id="courses-view" class="courses-view">
    <div class="courses-header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button onclick="app.Courses.close()" style="background:var(--border); color:var(--text-main); border:none; padding:8px 15px; border-radius:6px; font-weight:bold; cursor:pointer">‚¨Ö Retour</button>
            <h1>üéì Cours Cin√©ma</h1>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
            <button class="theme-btn" onclick="app.UI.toggleTheme()">üåì Mode</button>
        </div>
    </div>
    <div class="courses-body">
        <div class="courses-tabs" id="courses-tabs">
            <div class="courses-tab active" onclick="app.Courses.switchTab('scenario')">üìù Sc√©nario</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('realisation')">üé¨ R√©alisation</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('image')">üì∑ Image</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('son')">üé§ Son</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('montage')">‚úÇÔ∏è Montage</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('production')">üíº Production</div>
            <div class="courses-tab" onclick="app.Courses.switchTab('glossaire')">üìñ Glossaire</div>
        </div>
        <div id="courses-content" class="courses-content"></div>
    </div>
  </div>
  
  <div id="app-view">
    <header>
      <div class="project-info">
        <button onclick="app.UI.showDashboard()" style="background:var(--border); color:var(--text-main); border:none; padding:5px 10px; border-radius:4px; margin-right:10px; font-weight:bold; cursor:pointer">‚¨Ö Dashboard</button>
        <input id="projectTitle" type="text" value="Mon Film">
        <span id="sync-indicator" data-tooltip="Synchronisation" data-tooltip-pos="bottom" style="margin-left:8px; font-size:1rem; opacity:0.4; transition: all 0.3s;">‚òÅÔ∏è</span>
        <span id="role-badge" style="margin-left:10px; font-size:0.8rem; padding:4px 8px; background:var(--highlight); border-radius:4px; color:var(--text-main); border:1px solid var(--border)">PROPRI√âTAIRE</span>
        <div id="presence-list" class="presence-bar"></div>
      </div>
      <div class="global-actions">
        <div class="menu-dropdown-container">
          <button onclick="app.UI.toggleDropdown('fichier')" class="menu-dropdown-btn" data-tooltip="Ouvrir, sauvegarder, r√©initialiser" data-tooltip-pos="bottom">üìÅ Fichier ‚ñæ</button>
          <div id="dropdown-fichier" class="menu-dropdown">
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); document.getElementById('btnLoad').click()">üìÇ Ouvrir un projet</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Actions.openVersionModal()">üíæ Sauvegardes</div>
            <div class="menu-dropdown-separator"></div>
            <div class="menu-dropdown-item danger" onclick="app.UI.closeAllDropdowns(); document.getElementById('btnClear').click()">üóëÔ∏è Reset projet</div>
          </div>
        </div>
        <div class="menu-dropdown-container">
          <button onclick="app.UI.toggleDropdown('projet')" class="menu-dropdown-btn" data-tooltip="Partager, acc√®s, pr√©sentation" data-tooltip-pos="bottom">üé¨ Projet ‚ñæ</button>
          <div id="dropdown-projet" class="menu-dropdown">
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Actions.openShareModal()">üë• Partager</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Permissions.openModal()">üîê G√©rer les acc√®s</div>
            <div class="menu-dropdown-separator"></div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.PresentMode.start()">üé• Mode pr√©sentation</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.History.openModal()">üìã Journal des modifications</div>
          </div>
        </div>
        <div class="menu-dropdown-container">
          <button onclick="app.UI.toggleDropdown('export')" class="menu-dropdown-btn" data-tooltip="Exporter sc√©nario, budget, PDF" data-tooltip-pos="bottom">üì§ Export ‚ñæ</button>
          <div id="dropdown-export" class="menu-dropdown align-right">
            <div class="menu-dropdown-label">Sc√©nario</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.ScriptExport.toFountain()">üìú Fountain (.fountain)</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.ScriptExport.toFDX()">üé¨ Final Draft (.fdx)</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Actions.openExportModal()">üñ®Ô∏è PDF / Imprimer</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Breakdown.exportPDF()">üìã D√©pouillement PDF</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Storyboard.exportPDF()">üé® Storyboard PDF</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Crew.exportPDF()">üë• √âquipe PDF</div>
            <div class="menu-dropdown-separator"></div>
            <div class="menu-dropdown-label">Budget</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Expenses.exportPDF()">üí∞ Budget PDF</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Expenses.exportExcel()">üìä Budget Excel (CSV)</div>
            <div class="menu-dropdown-divider"></div>
            <div class="menu-dropdown-label">üìÅ Projet complet</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Exporter.productionReport()">üìã Rapport de production</div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Exporter.exportZIP()">üì¶ Export ZIP complet</div>
            <div class="menu-dropdown-separator"></div>
            <div class="menu-dropdown-item" onclick="app.UI.closeAllDropdowns(); app.Contracts.openModal()">üìù Contrats</div>
          </div>
        </div>
        <div class="tabs-position-dropdown" style="position:relative; display:inline-block;">
            <button class="theme-btn" onclick="app.UI.togglePositionMenu()" data-tooltip="Options d'affichage" data-tooltip-pos="bottom">üìê</button>
            <div id="tabs-position-menu" class="position-dropdown-menu" style="display:none; position:absolute; top:100%; right:0; margin-top:5px; background:var(--panel-bg); border:1px solid var(--border); border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.2); z-index:10000; min-width:180px;">
                <div class="position-menu-item" onclick="app.FocusMode.toggle()" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem; border-bottom:1px solid var(--border); background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; font-weight: 600;">üñ•Ô∏è Mode Focus (F11)</div>
                <div style="padding:8px 15px; font-size:0.75rem; color:var(--text-sec); font-weight:600; border-bottom:1px solid var(--border);">NAVIGATION</div>
                <div class="position-menu-item" onclick="app.UI.setNavModeFromMenu('classic')" data-nav="classic" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem;">üìã Classique</div>
                <div class="position-menu-item" onclick="app.UI.setNavModeFromMenu('categories')" data-nav="categories" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem;">üìÅ Cat√©gories</div>
                <div id="position-section-label" style="padding:8px 15px; font-size:0.75rem; color:var(--text-sec); font-weight:600; border-bottom:1px solid var(--border); border-top:1px solid var(--border); margin-top:5px;">POSITION <span id="position-disabled-hint" style="display:none; font-weight:400; font-style:italic;">(Classique uniquement)</span></div>
                <div class="position-menu-item" onclick="app.UI.setTabsPosition('top')" data-pos="top" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem;">‚¨ÜÔ∏è Haut</div>
                <div class="position-menu-item" onclick="app.UI.setTabsPosition('bottom')" data-pos="bottom" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem;">‚¨áÔ∏è Bas</div>
                <div class="position-menu-item" onclick="app.UI.setTabsPosition('left')" data-pos="left" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem;">‚¨ÖÔ∏è Gauche</div>
                <div class="position-menu-item" onclick="app.UI.setTabsPosition('right')" data-pos="right" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem;">‚û°Ô∏è Droite</div>
                <div id="tabs-mode-section" style="border-top:1px solid var(--border); margin-top:5px;">
                    <div style="padding:8px 15px; font-size:0.75rem; color:var(--text-sec); font-weight:600; border-bottom:1px solid var(--border);">MODE</div>
                    <div class="position-menu-item" onclick="app.UI.setTabsModeFromMenu('scroll')" data-mode="scroll" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem;">‚ÜîÔ∏è D√©filant</div>
                    <div class="position-menu-item" onclick="app.UI.setTabsModeFromMenu('adaptive')" data-mode="adaptive" style="padding:10px 15px; cursor:pointer; display:flex; align-items:center; gap:8px; font-size:0.85rem;">‚öñÔ∏è Adaptatif</div>
                </div>
                <div style="border-top:1px solid var(--border); margin-top:5px; padding:10px 15px;">
                    <button onclick="app.UI.resetTabsOrder(); app.UI.togglePositionMenu();" style="width:100%; padding:8px; background:var(--bg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:0.8rem;">‚Ü©Ô∏è R√©initialiser</button>
                </div>
            </div>
        </div>
        <button class="theme-btn" onclick="app.UI.cycleDesign()" data-tooltip="Changer le design" data-tooltip-pos="bottom">üé®</button>
        <button class="theme-btn" onclick="app.UI.toggleTheme()" data-tooltip="Changer le th√®me clair/sombre" data-tooltip-pos="bottom">üåì</button>
        <button id="btnSave" style="display:none;">‚òÅÔ∏è Sync</button>
        <button id="btnLoad" style="display:none;">üìÇ Ouvrir</button>
        <button id="btnClear" style="display:none;">üóëÔ∏è Reset</button>
      </div>
      <input type="file" id="fileInput" accept=".json" style="display:none">
    </header>

    <!-- Toolbar Mode Focus -->
    <div id="focus-toolbar" class="focus-toolbar" style="display: none;">
        <div class="focus-toolbar-left">
            <button class="focus-btn" onclick="app.FocusMode.exit()" data-tooltip="Quitter le mode focus (√âchap)">‚úï Quitter</button>
        </div>
        <div class="focus-toolbar-center">
            <button class="focus-btn nav-btn" onclick="app.FocusMode.prevTab()" data-tooltip="Onglet pr√©c√©dent (‚Üê)">‚óÄ</button>
            <span class="focus-tab-title" id="focus-tab-title">Onglet</span>
            <button class="focus-btn nav-btn" onclick="app.FocusMode.nextTab()" data-tooltip="Onglet suivant (‚Üí)">‚ñ∂</button>
        </div>
        <div class="focus-toolbar-right">
            <span class="focus-project-title" id="focus-project-title"></span>
        </div>
    </div>

    <div id="quick-nav"></div>

    <!-- S√©lecteur de mode supprim√© - d√©plac√© dans le menu üìê du header -->
    
    <!-- Navigation par cat√©gories (niveau 1) -->
    <nav class="tabs-categories" id="tabsCategories">
        <button class="tab-category active" draggable="true" data-category="ecriture" onclick="app.UI.switchCategory('ecriture')" data-tooltip="Synopsis, S√©quencier, Sc√©nario, Storyboard" data-tooltip-pos="bottom">
            <span class="tab-category-icon">üìù</span> √âcriture
            <span class="cat-close" onclick="event.stopPropagation(); app.UI.hideCategory('ecriture')">√ó</span>
        </button>
        <button class="tab-category" draggable="true" data-category="casting" onclick="app.UI.switchCategory('casting')" data-tooltip="Personnages, D√©cors, Com√©diens" data-tooltip-pos="bottom">
            <span class="tab-category-icon">üé≠</span> Casting & D√©cors
            <span class="cat-close" onclick="event.stopPropagation(); app.UI.hideCategory('casting')">√ó</span>
        </button>
        <button class="tab-category" draggable="true" data-category="production" onclick="app.UI.switchCategory('production')" data-tooltip="Pr√©sentation, √âquipes, D√©pouillement, Planning" data-tooltip-pos="bottom">
            <span class="tab-category-icon">üé¨</span> Production
            <span class="cat-close" onclick="event.stopPropagation(); app.UI.hideCategory('production')">√ó</span>
        </button>
        <button class="tab-category" draggable="true" data-category="admin" onclick="app.UI.switchCategory('admin')" data-tooltip="Statistiques, D√©penses, Chat" data-tooltip-pos="bottom">
            <span class="tab-category-icon">üìä</span> Admin
            <span class="cat-close" onclick="event.stopPropagation(); app.UI.hideCategory('admin')">√ó</span>
        </button>
        <button class="hidden-categories-toggle" id="hiddenCategoriesToggle" onclick="app.UI.toggleHiddenCategoriesMenu(event)" data-tooltip="Restaurer les √©l√©ments masqu√©s" data-tooltip-pos="bottom">
            ‚äï Masqu√©s <span class="hidden-count" id="hiddenCategoriesCount">0</span>
        </button>
    </nav>
    
    <!-- Sous-navigation par cat√©gorie (niveau 2) -->
    <nav class="tabs-subnav active" id="tabsSubnav" data-category="ecriture">
        <button class="tab-subbtn active" data-tab="synopsis" onclick="app.UI.switchTab('synopsis')">Synopsis</button>
         <button class="tab-subbtn" data-tab="board" onclick="app.UI.switchTab('board')">S√©quencier / BB</button>
        <button class="tab-subbtn" data-tab="titlepage" onclick="app.UI.switchTab('titlepage')">Titre</button>
        <button class="tab-subbtn" data-tab="script" onclick="app.UI.switchTab('script')">Sc√©nario</button>
        <button class="tab-subbtn" data-tab="moodboard" onclick="app.UI.switchTab('moodboard')">Mood Board</button>
        <button class="tab-subbtn" data-tab="storyboard" onclick="app.UI.switchTab('storyboard')">Storyboard</button>
    </nav>
    
    <!-- Menu contextuel couleur onglet -->
    <div id="tab-color-menu" class="tab-color-menu">
        <div class="tab-color-menu-title">üé® Couleur de l'onglet</div>
        <div class="tab-color-options">
            <div class="tab-color-option" style="background: #ef4444;" onclick="app.UI.setTabColor('#ef4444')"></div>
            <div class="tab-color-option" style="background: #f97316;" onclick="app.UI.setTabColor('#f97316')"></div>
            <div class="tab-color-option" style="background: #eab308;" onclick="app.UI.setTabColor('#eab308')"></div>
            <div class="tab-color-option" style="background: #22c55e;" onclick="app.UI.setTabColor('#22c55e')"></div>
            <div class="tab-color-option" style="background: #14b8a6;" onclick="app.UI.setTabColor('#14b8a6')"></div>
            <div class="tab-color-option" style="background: #3b82f6;" onclick="app.UI.setTabColor('#3b82f6')"></div>
            <div class="tab-color-option" style="background: #8b5cf6;" onclick="app.UI.setTabColor('#8b5cf6')"></div>
            <div class="tab-color-option" style="background: #ec4899;" onclick="app.UI.setTabColor('#ec4899')"></div>
            <div class="tab-color-option" style="background: #6b7280;" onclick="app.UI.setTabColor('#6b7280')"></div>
            <div class="tab-color-option" style="background: #1f2937;" onclick="app.UI.setTabColor('#1f2937')"></div>
        </div>
        <button class="tab-color-reset" onclick="app.UI.setTabColor(null)">‚Ü© R√©initialiser</button>
        <hr style="margin: 10px 0; border: none; border-top: 1px solid var(--border);">
        <button class="tab-color-reset" onclick="app.UI.openTabHelp()" style="background: var(--primary);">‚ùì Aide sur cet onglet</button>
    </div>
    
    <nav class="tabs-nav adaptive" id="tabsNav">
    <div class="tab-btn active" draggable="true" data-tab="presentation" onclick="app.UI.switchTab('presentation')"><span>1. PR√âSENTATION</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('presentation')" data-tooltip="Masquer">√ó</button></div>
        <div class="tab-btn" draggable="true" data-tab="synopsis" onclick="app.UI.switchTab('synopsis')"><span>2. SYNOPSIS</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('synopsis')" data-tooltip="Masquer cet onglet" data-tooltip-pos="bottom">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="board" onclick="app.UI.switchTab('board')"><span>3. S√âQUENCIER / BB</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('board')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="titlepage" onclick="app.UI.switchTab('titlepage')"><span>4. TITRE</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('titlepage')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="script" onclick="app.UI.switchTab('script')"><span>4. SC√âNARIO</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('script')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="moodboard" onclick="app.UI.switchTab('moodboard')"><span>5. MOOD BOARD</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('moodboard')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="storyboard" onclick="app.UI.switchTab('storyboard')"><span>6. STORYBOARD</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('storyboard')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="chars" onclick="app.UI.switchTab('chars')"><span>7. PERSONNAGES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('chars')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="actors" onclick="app.UI.switchTab('actors')"><span>8. COM√âDIEN.NES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('actors')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="locs" onclick="app.UI.switchTab('locs')"><span>9. D√âCORS</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('locs')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="resources" onclick="app.UI.switchTab('resources')"><span>10. RESSOURCES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('resources')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="crew" onclick="app.UI.switchTab('crew')"><span>11. √âQUIPES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('crew')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="breakdown" onclick="app.UI.switchTab('breakdown')"><span>12. D√âPOUILLEMENT</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('breakdown')" title="Masquer cet onglet">√ó</button></div>
      <div class="tab-btn" draggable="true" data-tab="stats" onclick="app.UI.switchTab('stats')"><span>13. STATISTIQUES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('stats')" title="Masquer cet onglet">√ó</button></div>
     <div class="tab-btn" draggable="true" data-tab="planning" onclick="app.UI.switchTab('planning')"><span>14. PLANNING</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('planning')" title="Masquer cet onglet">√ó</button></div>
<div class="tab-btn" draggable="true" data-tab="scriptreport" onclick="app.UI.switchTab('scriptreport')"><span>15. RAPPORT</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('scriptreport')" title="Masquer cet onglet">√ó</button></div>
<div class="tab-btn" draggable="true" data-tab="expenses" onclick="app.UI.switchTab('expenses')"><span>16. D√âPENSES</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('expenses')" title="Masquer cet onglet">√ó</button></div>
<div class="tab-btn" draggable="true" data-tab="chat" onclick="app.UI.switchTab('chat')"><span>17. CHAT</span><button class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('chat')" title="Masquer cet onglet">√ó</button></div>
<div class="tab-btn-hidden-toggle" id="hiddenTabsToggle" onclick="app.UI.toggleHiddenTabsMenu(event)" style="display:none;">‚äï Masqu√©s<span class="hidden-count" id="hiddenTabsCount">0</span></div>
<div class="hidden-tabs-menu" id="hiddenTabsMenu"></div>
    </nav>

    <main>
      <div id="print-cover">
          <h1 id="pc-title">TITRE</h1>
          <p id="pc-author">Auteur</p>
          <div class="print-contact" id="pc-contact"></div>
      </div>

<div id="tab-presentation" class="tab-content active">
          <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
            <h2 style="margin-bottom: 20px; color: var(--primary);">üìã Pr√©sentation du Projet</h2>
            
            <!-- Image et infos de base -->
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 30px; margin-bottom: 30px;">
              <div style="text-align: center;">
                <div id="project-image-placeholder" onclick="document.getElementById('project-image-input').focus()" style="width: 200px; height: 280px; background: var(--bg); border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 3rem; color: var(--text-sec);">üé¨</div>
                <img id="project-image-preview" src="" style="width: 200px; height: 280px; object-fit: cover; border-radius: 8px; display: none;">
                <input type="text" id="project-image-input" placeholder="URL de l'affiche..." style="width: 200px; margin-top: 10px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateImage(this.value)">
              </div>
              <div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-sec);">Titre du projet</label>
                  <div id="project-title-display" style="font-size: 1.5rem; font-weight: bold; color: var(--text-main);"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-sec);">Type de projet</label>
                    <select id="project-type" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                      <option value="">-- S√©lectionner --</option>
                      <option value="court-metrage">Court-m√©trage</option>
                      <option value="long-metrage">Long-m√©trage</option>
                      <option value="serie">S√©rie / Web-s√©rie</option>
                      <option value="documentaire">Documentaire</option>
                      <option value="clip">Clip musical</option>
                      <option value="pub">Publicit√©</option>
                      <option value="corporate">Film corporate</option>
                      <option value="autre">Autre</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-sec);">Genre</label>
                    <select id="project-genre" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                      <option value="">-- S√©lectionner --</option>
                      <option value="drame">Drame</option>
                      <option value="comedie">Com√©die</option>
                      <option value="thriller">Thriller</option>
                      <option value="horreur">Horreur</option>
                      <option value="sf">Science-Fiction</option>
                      <option value="fantastique">Fantastique</option>
                      <option value="action">Action</option>
                      <option value="romance">Romance</option>
                      <option value="animation">Animation</option>
                      <option value="experimental">Exp√©rimental</option>
                      <option value="autre">Autre</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Dates -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">üìÖ Dates du Projet</h3>
              
              <!-- Pr√©-production -->
              <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px; font-size: 0.9rem; color: var(--text-sec);">üìù Pr√©-production</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">D√©but</label>
                    <input type="date" id="project-date-preprod-start" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Fin</label>
                    <input type="date" id="project-date-preprod-end" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                  </div>
                </div>
              </div>
              
              <!-- Tournage -->
              <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px; font-size: 0.9rem; color: var(--text-sec);">üé¨ Tournage</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">D√©but</label>
                    <input type="date" id="project-date-shooting-start" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Fin</label>
                    <input type="date" id="project-date-shooting-end" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                  </div>
                </div>
              </div>
              
              <!-- Post-production -->
              <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px; font-size: 0.9rem; color: var(--text-sec);">üéûÔ∏è Post-production</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">D√©but</label>
                    <input type="date" id="project-date-postprod-start" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Fin</label>
                    <input type="date" id="project-date-postprod-end" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                  </div>
                </div>
              </div>
              
              <!-- Distribution -->
              <div>
                <h4 style="margin: 0 0 10px; font-size: 0.9rem; color: var(--text-sec);">üé≠ Distribution</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Sortie Pr√©vue</label>
                    <input type="date" id="project-date-release" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                  </div>
                  <div>
                    <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Fin Distribution</label>
                    <input type="date" id="project-date-distribution-end" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Localisation -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">üìç Localisation</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Ville</label>
                  <input type="text" id="project-city" placeholder="Paris, Lyon, Marseille..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">R√©gion</label>
                  <input type="text" id="project-region" placeholder="√éle-de-France, PACA..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Pays</label>
                  <input type="text" id="project-country" value="France" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
              </div>
            </div>
            
            <!-- √âquipe actuelle -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">üë• √âquipe Actuelle</h3>
              <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px;">Ajoutez les membres cl√©s de votre √©quipe.</p>
              
              <!-- Budget -->
              <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">üí∞ Budget pr√©vu (‚Ç¨)</label>
                <input type="number" id="project-budget" placeholder="Ex: 50000" style="width: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
              </div>
              
              <!-- Liste des membres -->
              <div id="project-team-list" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;"></div>
              
              <!-- Bouton ajouter -->
              <button onclick="app.Presentation.openTeamMemberModal()" style="padding: 10px 20px; background: var(--bg); border: 1px dashed var(--primary); border-radius: 6px; cursor: pointer; color: var(--primary); font-size: 0.9rem; width: 100%;">
                ‚ûï Ajouter un membre √† l'√©quipe
              </button>
            </div>
            
            <!-- Modal ajout membre √©quipe -->
            <div id="team-member-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
              <div style="background: var(--panel-bg); border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <h3 style="margin: 0; color: var(--primary);">üë§ Ajouter un membre</h3>
                  <button onclick="app.Presentation.closeTeamMemberModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main);">‚úï</button>
                </div>
                
                <!-- R√¥le -->
                <div style="margin-bottom: 15px;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">R√¥le dans le projet *</label>
                  <select id="team-member-role" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="">-- S√©lectionner un r√¥le --</option>
                    <optgroup label="Production">
                      <option value="Producteur¬∑rice">Producteur¬∑rice</option>
                      <option value="Producteur¬∑rice ex√©cutif¬∑ve">Producteur¬∑rice ex√©cutif¬∑ve</option>
                      <option value="Directeur¬∑rice de production">Directeur¬∑rice de production</option>
                      <option value="Charg√©¬∑e de production">Charg√©¬∑e de production</option>
                    </optgroup>
                    <optgroup label="R√©alisation">
                      <option value="R√©alisateur¬∑rice">R√©alisateur¬∑rice</option>
                      <option value="1er¬∑√®re assistant¬∑e r√©alisateur¬∑rice">1er¬∑√®re assistant¬∑e r√©alisateur¬∑rice</option>
                      <option value="Sc√©nariste">Sc√©nariste</option>
                    </optgroup>
                    <optgroup label="Image">
                      <option value="Directeur¬∑rice photo">Directeur¬∑rice photo</option>
                      <option value="Cadreur¬∑se">Cadreur¬∑se</option>
                    </optgroup>
                    <optgroup label="Son">
                      <option value="Ing√©nieur¬∑e son">Ing√©nieur¬∑e son</option>
                      <option value="Perchiste">Perchiste</option>
                    </optgroup>
                    <optgroup label="Autres">
                      <option value="Autre">Autre (pr√©ciser)</option>
                    </optgroup>
                  </select>
                </div>
                
                <!-- R√¥le personnalis√© -->
                <div id="team-member-custom-role-div" style="display: none; margin-bottom: 15px;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Pr√©ciser le r√¥le</label>
                  <input type="text" id="team-member-custom-role" placeholder="Ex: Coordinateur cascades" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                </div>
                
                <!-- Recherche personne existante -->
                <div style="margin-bottom: 15px;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Rechercher une personne existante</label>
                  <input type="text" id="team-member-search" placeholder="üîç Nom, email..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" oninput="app.Presentation.searchTeamMember(this.value)">
                  <div id="team-member-search-results" style="margin-top: 10px; max-height: 150px; overflow-y: auto;"></div>
                </div>
                
                <!-- Ou cr√©er nouveau -->
                <div style="text-align: center; margin: 15px 0; color: var(--text-sec);">‚Äî ou ‚Äî</div>
                
                <div style="margin-bottom: 15px;">
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Cr√©er une nouvelle personne</label>
                  <input type="text" id="team-member-new-name" placeholder="Nom complet" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); margin-bottom: 10px;">
                  <input type="email" id="team-member-new-email" placeholder="Email (optionnel)" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                </div>
                
                <!-- Boutons -->
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                  <button onclick="app.Presentation.closeTeamMemberModal()" style="padding: 10px 20px; background: var(--border); color: var(--text-main); border: none; border-radius: 6px; cursor: pointer;">Annuler</button>
                  <button onclick="app.Presentation.addTeamMember()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚úì Ajouter</button>
                </div>
              </div>
            </div>
            
            <!-- Informations l√©gales employeur (pour contrats) -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">‚öñÔ∏è Informations L√©gales (Contrats)</h3>
              <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px;">Ces informations seront pr√©-remplies dans les contrats g√©n√©r√©s (CDDU, Prestation, Droit √† l'image).</p>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Nom / Raison sociale *</label>
                  <input type="text" id="project-producer" placeholder="Nom de la soci√©t√© ou producteur" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Repr√©sentant l√©gal *</label>
                  <input type="text" id="project-director" placeholder="Nom du repr√©sentant" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">N¬∞ SIRET</label>
                  <input type="text" id="project-siret" placeholder="123 456 789 00012" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Code APE/NAF</label>
                  <input type="text" id="project-ape" placeholder="5911A" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">N¬∞ Licence entrepreneur spectacle</label>
                  <input type="text" id="project-licence" placeholder="PLATESV-..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">URSSAF de rattachement</label>
                  <input type="text" id="project-urssaf" placeholder="Ex: URSSAF √éle-de-France" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">N¬∞ Cong√©s Spectacles employeur</label>
                  <input type="text" id="project-conges-spectacles" placeholder="N¬∞ affiliation" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Email contact (RGPD)</label>
                  <input type="email" id="project-email-legal" placeholder="contact@production.fr" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Adresse compl√®te</label>
                  <input type="text" id="project-address-legal" placeholder="Adresse du si√®ge social" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
                <div>
                  <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Qualit√© du repr√©sentant</label>
                  <input type="text" id="project-director-title" placeholder="Ex: G√©rant, Pr√©sident, Producteur d√©l√©gu√©" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.save()">
                </div>
              </div>
              
              <p style="font-size: 0.8rem; color: var(--text-sec); margin-top: 15px; font-style: italic;">üí° Ces informations sont optionnelles mais recommand√©es pour g√©n√©rer des contrats complets et conformes.</p>
            </div>
            
            <!-- Type de Production -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">ü§ù Type de production</h3>
              <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px;">Indiquez le type de collaboration recherch√©e pour ce projet.</p>
              <div class="project-type-selector" id="project-type-selector">
                <div class="project-type-card pro" data-type="pro" onclick="app.Presentation.setProductionType('pro')">
                  <div class="icon">üé¨</div>
                  <div class="label">Production Pro</div>
                  <div class="desc">Contrats, horaires et tarifs standards</div>
                </div>
                <div class="project-type-card semi-pro" data-type="semi-pro" onclick="app.Presentation.setProductionType('semi-pro')">
                  <div class="icon">‚ö°</div>
                  <div class="label">Production Semi-pro</div>
                  <div class="desc">√âquipe pay√©e, conditions flexibles</div>
                </div>
                <div class="project-type-card benevole" data-type="benevole" onclick="app.Presentation.setProductionType('benevole')">
                  <div class="icon">‚ù§Ô∏è</div>
                  <div class="label">Production B√©n√©vole</div>
                  <div class="desc">D√©fraiement uniquement (repas + transport)</div>
                </div>
              </div>
            </div>
            
            <!-- Partenaires (Associations & Entreprises) -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">ü§ù Partenaires du Projet</h3>
              <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px;">Ajoutez les associations et entreprises partenaires de votre projet.</p>
              
              <!-- Associations -->
              <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px; color: var(--text-main); font-size: 0.95rem;">üèõÔ∏è Associations</h4>
                <div id="project-associations-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>
                <button onclick="app.Presentation.openPartnerSearch('association')" style="padding: 8px 15px; background: var(--bg); border: 1px dashed var(--primary); border-radius: 6px; cursor: pointer; color: var(--primary); font-size: 0.9rem;">
                  ‚ûï Ajouter une association
                </button>
              </div>
              
              <!-- Entreprises -->
              <div>
                <h4 style="margin: 0 0 10px; color: var(--text-main); font-size: 0.95rem;">üè¢ Entreprises</h4>
                <div id="project-enterprises-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>
                <button onclick="app.Presentation.openPartnerSearch('enterprise')" style="padding: 8px 15px; background: var(--bg); border: 1px dashed var(--primary); border-radius: 6px; cursor: pointer; color: var(--primary); font-size: 0.9rem;">
                  ‚ûï Ajouter une entreprise
                </button>
              </div>
            </div>
            
            <!-- Description -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">üìù Note d'intention / Description</h3>
              <textarea id="project-description" placeholder="D√©crivez votre projet, son univers, son intention artistique..." style="width: 100%; min-height: 150px; padding: 15px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); resize: vertical; font-family: inherit;" onchange="app.Presentation.save()"></textarea>
            </div>
            
            <!-- Besoins Techniciens -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">üé¨ Besoins Techniciens</h3>
              <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px;">Cochez les postes dont vous avez besoin et indiquez le nombre de personnes recherch√©es.</p>
              <div id="needs-crew-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;"></div>
              <button onclick="app.Presentation.addCustomCrewNeed()" style="margin-top: 15px; padding: 8px 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">‚ûï Ajouter un autre poste</button>
            </div>
            
            <!-- Besoins Com√©diens -->
            <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">üé≠ Besoins Com√©diens / Casting</h3>
              <p style="font-size: 0.85rem; color: var(--text-sec); margin-bottom: 15px;">D√©finissez les r√¥les que vous recherchez pour le casting.</p>
              <div id="needs-actors-list"></div>
              <button onclick="app.Presentation.addActorNeed()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚ûï Ajouter un r√¥le √† caster</button>
            </div>
            
            <!-- Visibilit√© -->
            <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
              <h3 style="margin: 0 0 15px; color: var(--primary);">üåê Visibilit√© dans l'Univers</h3>
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="project-public" style="width: 20px; height: 20px;" onchange="app.Presentation.save()">
                <span>Rendre ce projet visible dans l'Univers (les com√©diens et techniciens pourront le voir et vous contacter)</span>
              </label>
            </div>
          </div>
        </div>

      <div id="tab-synopsis" class="tab-content">
        <h1 class="print-only-title">SYNOPSIS & R√âSUM√âS</h1>
        <div class="synopsis-section">
            <span class="section-label">Synopsis</span>
            <div class="synopsis-container">
              <div class="synopsis-editor">
                <textarea id="synopsisEditor" placeholder="Synopsis principal..." style="width:100%; min-height:150px; padding:15px; border:1px solid var(--border); border-radius:8px; background:var(--input-bg); color:var(--text-main); resize:vertical; font-family:inherit;"></textarea>
              </div>
            </div>
        </div>
        <div class="synopsis-section">
            <span class="section-label">R√©sum√© Court</span>
            <div class="synopsis-container">
              <div class="synopsis-editor">
                <textarea id="shortEditor" placeholder="Pitch / R√©sum√© court..." style="width:100%; min-height:100px; padding:15px; border:1px solid var(--border); border-radius:8px; background:var(--input-bg); color:var(--text-main); resize:vertical; font-family:inherit;"></textarea>
              </div>
            </div>
        </div>
        <div class="synopsis-section" style="border-bottom:none;">
            <span class="section-label">R√©sum√© Long</span>
            <div class="synopsis-container">
              <div class="synopsis-editor">
                <textarea id="longEditor" placeholder="Traitement / R√©sum√© long..." style="width:100%; min-height:200px; padding:15px; border:1px solid var(--border); border-radius:8px; background:var(--input-bg); color:var(--text-main); resize:vertical; font-family:inherit;"></textarea>
              </div>
            </div>
        </div>
      </div>

      <div id="tab-board" class="tab-content">
        <h1 class="print-only-title">S√âQUENCIER</h1>
        <div class="board-layout">
            <div class="board-sidebar">
                <h4 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Vue</h4>
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Type de vue</label>
                    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                        <button id="view-mode-sequencer" onclick="app.BeatBoard.setViewMode('sequencer')" class="board-mode-btn active" style="flex: 1; padding: 10px 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--primary); color: white; font-size: 0.85rem;">üìã S√©quencier</button>
                        <button id="view-mode-beatboard" onclick="app.BeatBoard.setViewMode('beatboard')" class="board-mode-btn" style="flex: 1; padding: 10px 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main); font-size: 0.85rem;">üéØ Beat Board</button>
                    </div>
                </div>
                <div id="sequencer-options">
                <h4 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Affichage</h4>
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">Mode d'affichage</label>
                    <div style="display: flex; gap: 5px;">
                        <button id="board-mode-normal" onclick="app.UI.setBoardMode('normal')" class="board-mode-btn active" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--primary); color: white;">üìã Normal</button>
                        <button id="board-mode-compact" onclick="app.UI.setBoardMode('compact')" class="board-mode-btn" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main);">üìë Compact</button>
                    </div>
                </div>
                <div class="sidebar-toggles">
                    <label><input type="checkbox" id="toggleSynop" checked onchange="app.UI.toggleSidebarContent()"> Synopsis</label>
                    <label><input type="checkbox" id="toggleShort" onchange="app.UI.toggleSidebarContent()"> R√©sum√© Court</label>
                    <label><input type="checkbox" id="toggleLong" onchange="app.UI.toggleSidebarContent()"> R√©sum√© Long</label>
                </div>
                <div id="boardSynopBlock" class="sidebar-content-block visible">
                    <strong>SYNOPSIS</strong>
                    <p id="boardSynopsisDisplay" style="white-space: pre-wrap; font-size: 0.85rem; color: var(--text-main); margin-top:5px;"></p>
                </div>
                <div id="boardShortBlock" class="sidebar-content-block">
                    <strong>R√âSUM√â COURT</strong>
                    <p id="boardShortDisplay" style="white-space: pre-wrap; font-size: 0.85rem; color: var(--text-main); margin-top:5px;"></p>
                </div>
                <div id="boardLongBlock" class="sidebar-content-block">
                    <strong>R√âSUM√â LONG</strong>
                    <p id="boardLongDisplay" style="white-space: pre-wrap; font-size: 0.85rem; color: var(--text-main); margin-top:5px;"></p>
                </div>
                <hr>
                <div style="font-size:0.8rem; color:var(--text-sec); margin-top:20px">Astuce: Clic-droit sur une carte pour g√©rer les Tags/Couleurs.</div>
                </div><!-- fin sequencer-options -->
                <div id="beatboard-options" style="display:none;">
                    <h4 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Beat Board</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Disposition</label>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button onclick="app.BeatBoard.autoLayout('horizontal')" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main); font-size: 0.8rem;">‚ÜîÔ∏è Ligne horizontale</button>
                            <button onclick="app.BeatBoard.autoLayout('grid')" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main); font-size: 0.8rem;">‚äû Grille</button>
                            <button onclick="app.BeatBoard.autoLayout('byTag')" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--bg); color: var(--text-main); font-size: 0.8rem;">üè∑Ô∏è Par groupe/tag</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Fil rouge</label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
                            <input type="checkbox" id="beatboard-show-line" checked onchange="app.BeatBoard.toggleLine()">
                            Afficher le fil rouge
                        </label>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">Groupes (Tags)</label>
                        <div id="beatboard-tag-list" style="display: flex; flex-direction: column; gap: 5px;"></div>
                    </div>
                    <hr style="border:none; border-top:1px solid var(--border); margin: 15px 0;">
                    <button onclick="app.BeatBoard.createScene()" style="width:100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem;">‚ûï Nouvelle sc√®ne</button>
                    <div style="font-size:0.8rem; color:var(--text-sec); margin-top:15px">
                        üí° <strong>Drag</strong> = d√©placer visuellement<br>
                        üí° <strong>Shift+Drag</strong> = r√©ordonner dans le fil rouge<br>
                        üí° <strong>Ctrl+Clic</strong> = s√©lection multiple
                    </div>
                </div>
            </div>
            <div class="board-main" id="sequencer-view">
                <div id="edit-scene-form" class="controls-row" style="background:var(--panel-bg); padding:15px; border-radius:8px; border:1px solid var(--border); margin-bottom:15px; display:block">
                  <div class="seq-header-row">
                      <div class="seq-input-group">
                          <input id="inpPre" placeholder="INT"><span>.</span><input id="inpLoc" placeholder="LIEU"><span>-</span><input id="inpSuff" placeholder="JOUR">
                      </div>
                      <input id="inpTime" placeholder="Dur√©e (min)">
                  </div>
                  <div class="autocomplete-wrapper"><input id="inpPerso" placeholder="Personnages..."><div id="autocomplete-list" class="autocomplete-list"></div></div>
                  <textarea id="inpResume" rows="2" placeholder="R√©sum√©..."></textarea>
                  <div style="margin-top:10px"><button onclick="app.Actions.addScene()" style="width:100%; padding:10px; background:var(--primary); color:#fff; border:none; border-radius:4px; font-weight:bold; cursor:pointer">‚ûï Ajouter Sc√®ne</button></div>
                </div>
                <div id="boardList"></div>
            </div>
            <div id="beatboard-view" class="board-main" style="display:none; padding: 0;">
                <div class="beatboard-container" id="beatboardContainer">
                    <div class="beatboard-canvas" id="beatboardCanvas">
                        <svg class="beatboard-svg" id="beatboardSvg"></svg>
                    </div>
                    <div class="beatboard-zoom">
                        <button onclick="app.BeatBoard.zoomOut()" title="Zoom -">‚ûñ</button>
                        <span id="beatboardZoomLevel">100%</span>
                        <button onclick="app.BeatBoard.zoomIn()" title="Zoom +">‚ûï</button>
                        <button onclick="app.BeatBoard.zoomReset()" title="R√©initialiser">üîÑ</button>
                        <button onclick="app.BeatBoard.fitToView()" title="Ajuster √† la vue">‚õ∂</button>
                    </div>
                    <div class="beatboard-minimap" id="beatboardMinimap">
                        <div class="beatboard-minimap-viewport" id="beatboardMinimapViewport"></div>
                    </div>
                </div>
            </div>
        </div>
      </div>
	  
      <div id="tab-titlepage" class="tab-content">
        <div style="max-width: 700px; margin: 0 auto; padding: 40px 20px;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="font-size: 1.5rem; margin-bottom: 10px;">üìù Page de titre</h2>
            <p style="color: var(--text-sec);">Ces informations appara√Ætront sur la page de titre lors de l'export PDF, Fountain ou Final Draft.</p>
          </div>
          
          <div style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 30px;">
            <div style="display: grid; gap: 20px;">
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Titre du sc√©nario</label>
                <input type="text" id="tp-title" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); font-size: 1.1rem;" placeholder="Titre du film" oninput="app.TitlePage.save()">
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Auteur</label>
                  <input type="text" id="tp-author" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main);" placeholder="Pr√©nom Nom" oninput="app.TitlePage.save()">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Co-auteur (optionnel)</label>
                  <input type="text" id="tp-coauthor" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main);" placeholder="Pr√©nom Nom" oninput="app.TitlePage.save()">
                </div>
              </div>
              
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Contact</label>
                <input type="text" id="tp-contact" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main);" placeholder="email@exemple.com ou t√©l√©phone" oninput="app.TitlePage.save()">
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Version / Draft</label>
                  <select id="tp-draft" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main);" onchange="app.TitlePage.save()">
                    <option value="">-- S√©lectionner --</option>
                    <option value="Premier jet">Premier jet</option>
                    <option value="Deuxi√®me jet">Deuxi√®me jet</option>
                    <option value="Troisi√®me jet">Troisi√®me jet</option>
                    <option value="Version de tournage">Version de tournage</option>
                    <option value="Version finale">Version finale</option>
                  </select>
                </div>
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Date</label>
                  <input type="date" id="tp-date" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main);" oninput="app.TitlePage.save()">
                </div>
              </div>
              
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Bas√© sur (optionnel)</label>
                <input type="text" id="tp-source" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main);" placeholder="Ex: le roman de Victor Hugo" oninput="app.TitlePage.save()">
              </div>
              
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Copyright (optionnel)</label>
                <input type="text" id="tp-copyright" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main);" placeholder="¬© 2026 Nom ou Soci√©t√©" oninput="app.TitlePage.save()">
              </div>
              
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Notes (optionnel)</label>
                <textarea id="tp-notes" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); resize: vertical;" placeholder="Notes suppl√©mentaires..." oninput="app.TitlePage.save()"></textarea>
              </div>
            </div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border); text-align: center; color: var(--text-sec); font-size: 0.85rem;">
              üíæ Sauvegarde automatique
            </div>
          </div>
        </div>
      </div>

      <div id="tab-script" class="tab-content">
          <h1 class="print-only-title">SC√âNARIO</h1>
          
          <!-- BARRE UNIFI√âE -->
          <div class="script-unified-bar">
              <div class="script-unified-inner">
                  <div class="script-unified-left">
                      <button id="script-view-scenes" class="view-btn active" onclick="app.ScriptEditor.setViewMode('scenes')">üìë Vue Sc√®nes</button>
                      <button id="script-view-continuous" class="view-btn" onclick="app.ScriptEditor.setViewMode('continuous')">üìú Vue Script</button>
                  </div>
                  <div class="script-unified-right" id="continuous-toolbar">
                      <button class="fmt-btn active" data-type="sc-action" onclick="app.ScriptEditor.formatContinuous('sc-action', event)" onmousedown="event.preventDefault()">Action</button>
                      <button class="fmt-btn" data-type="sc-perso" onclick="app.ScriptEditor.formatContinuous('sc-perso', event)" onmousedown="event.preventDefault()">Perso</button>
                      <button class="fmt-btn" data-type="sc-dial" onclick="app.ScriptEditor.formatContinuous('sc-dial', event)" onmousedown="event.preventDefault()">Dial</button>
                      <button class="fmt-btn" data-type="sc-paren" onclick="app.ScriptEditor.formatContinuous('sc-paren', event)" onmousedown="event.preventDefault()">Didas</button>
                      <button class="fmt-btn" data-type="sc-trans" onclick="app.ScriptEditor.formatContinuous('sc-trans', event)" onmousedown="event.preventDefault()">Trans</button>
                      <button class="fmt-btn" data-type="sc-centered" onclick="app.ScriptEditor.formatContinuous('sc-centered', event)" onmousedown="event.preventDefault()">Centr√©</button>
                      <button class="fmt-btn" data-type="sc-note" onclick="app.ScriptEditor.formatContinuous('sc-note', event)" onmousedown="event.preventDefault()">Note</button>
                  </div>
              </div>
          </div>
          
          <!-- Vue Sc√®nes -->
          <div class="script-view" id="scriptContainer"></div>
          
          <!-- Vue Script Continu -->
          <div class="script-continuous-wrapper" id="scriptContinuousContainer" style="display: none;">
              <div class="script-continuous-sidebar" id="scriptContinuousSidebar"></div>
              <div class="script-continuous-main">
                  <div class="script-continuous-editor" id="scriptContinuousEditor"></div>
              </div>
          </div>
      </div>
      
      <!-- TAB MOOD BOARD -->
      <div id="tab-moodboard" class="tab-content">
        <div class="moodboard-container">
          <!-- Toolbar -->
       <div class="moodboard-toolbar">
            <button class="primary" onclick="app.MoodBoard.createBoard()">+ Nouvelle planche</button>
            <div style="border-left: 1px solid var(--border); height: 30px; margin: 0 10px;"></div>
            <span style="color: var(--text-sec); font-size: 0.85rem;">üí° Clic droit sur le canvas pour ajouter des √©l√©ments</span>
            <div style="border-left: 1px solid var(--border); height: 30px; margin: 0 10px;"></div>
            <select id="moodboardFormat" onchange="app.MoodBoard.changeFormat(this.value)">
              <option value="free">üìê Libre (infini)</option>
              <option value="a4-landscape">A4 Paysage</option>
              <option value="a4-portrait">A4 Portrait</option>
              <option value="a3-landscape">A3 Paysage</option>
              <option value="a3-portrait">A3 Portrait</option>
              <option value="a2-landscape">A2 Paysage</option>
              <option value="a2-portrait">A2 Portrait</option>
              <option value="a0-landscape">A0 Paysage</option>
              <option value="a0-portrait">A0 Portrait</option>
            </select>
            <div style="margin-left: auto; display: flex; gap: 10px;">
              <button class="secondary" onclick="app.MoodBoard.exportPNG()">üì∑ Export PNG</button>
              <button class="secondary" onclick="app.MoodBoard.exportPDF()">üìÑ Export PDF</button>
              <button class="secondary" onclick="app.MoodBoard.toggleInfoPanel()">‚ÑπÔ∏è Infos</button>
            </div>
          </div>
          
          <!-- Liste des planches -->
          <div class="moodboard-boards-list" id="moodboardBoardsList">
            <!-- Planches g√©n√©r√©es dynamiquement -->
          </div>
          
          <!-- Conteneur principal avec sidebar + canvas -->
          <div class="moodboard-main-container">
            <!-- Colonne gauche : liste des √©l√©ments -->
            <div class="moodboard-elements-sidebar" id="moodboardElementsSidebar">
              <div class="moodboard-sidebar-header">
                <span>üìã √âl√©ments</span>
                <span class="moodboard-elements-count" id="moodboardElementsCount">0</span>
              </div>
              <div class="moodboard-elements-list" id="moodboardElementsList">
                <p style="color: var(--text-sec); text-align: center; padding: 20px; font-size: 0.85rem;">Aucun √©l√©ment</p>
              </div>
            </div>
            
            <!-- Zone de travail -->
            <div class="moodboard-canvas-wrapper" id="moodboardCanvasWrapper">
            <div class="moodboard-canvas format-free" id="moodboardCanvas">
              <!-- √âl√©ments du mood board -->
            </div>
            
            <!-- Contr√¥les de zoom -->
            <div class="moodboard-zoom-controls">
              <button onclick="app.MoodBoard.zoomOut()">‚àí</button>
              <span id="moodboardZoomLevel">100%</span>
              <button onclick="app.MoodBoard.zoomIn()">+</button>
              <button onclick="app.MoodBoard.zoomReset()">‚ü≤</button>
            </div>
            
            <!-- Minimap -->
            <div class="moodboard-minimap" id="moodboardMinimap">
              <div class="moodboard-minimap-content" id="moodboardMinimapContent">
                <div class="moodboard-minimap-viewport" id="moodboardMinimapViewport"></div>
              </div>
            </div>
            
            <!-- Panneau d'info √©l√©ment/planche -->
            <div class="moodboard-info-panel" id="moodboardInfoPanel">
              <h4>
                <span id="moodboardInfoTitle">Propri√©t√©s</span>
                <button onclick="app.MoodBoard.toggleInfoPanel()" style="background: none; border: none; cursor: pointer; font-size: 1.2rem;">√ó</button>
              </h4>
              <div id="moodboardInfoContent">
                <!-- Contenu dynamique -->
              </div>
            </div>
            
            <!-- √âtat vide -->
            <div class="moodboard-empty" id="moodboardEmpty">
              <div class="moodboard-empty-icon">üé®</div>
              <h3>Mood Board</h3>
              <p>Cr√©ez des planches d'inspiration pour d√©finir l'univers visuel de votre film. Images, palettes de couleurs, r√©f√©rences...</p>
              <button class="primary" onclick="app.MoodBoard.createBoard()" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">+ Cr√©er ma premi√®re planche</button>
            </div>
          </div>
          </div><!-- Fin moodboard-main-container -->
        </div>
      </div>

	  <div id="tab-storyboard" class="tab-content">
    <h1 class="print-only-title">STORYBOARD</h1>
    
    <div class="sb-view-toggle">
        <button class="sb-toggle-btn active" onclick="app.Storyboard.switchView('edit')">üìù √âdition</button>
        <button class="sb-toggle-btn" onclick="app.Storyboard.switchView('preview')">üëÅÔ∏è Mini Aper√ßu</button>
        <button class="sb-toggle-btn" onclick="app.Storyboard.openFullscreen()">üñ®Ô∏è Aper√ßu Plein √âcran</button>
        
        <div class="sb-print-config" style="margin-left: auto;">
            <button class="sb-config-btn" onclick="app.Storyboard.toggleConfig()">‚öôÔ∏è Configuration Print</button>
            <div class="sb-config-panel" id="sbConfigPanel">
                <h4 style="margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 10px;">√âl√©ments √† imprimer</h4>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-shot-number" checked>
                    <label for="cfg-shot-number">Num√©ro de plan</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-shot-type" checked>
                    <label for="cfg-shot-type">Type de plan</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-camera-move" checked>
                    <label for="cfg-camera-move">Mouvement cam√©ra</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-camera-mode" checked>
                    <label for="cfg-camera-mode">Mode cam√©ra</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-description" checked>
                    <label for="cfg-description">Description</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-actor-direction" checked>
                    <label for="cfg-actor-direction">Direction acteurs</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-tech-direction" checked>
                    <label for="cfg-tech-direction">Direction technique</label>
                </div>
                <div class="sb-config-item">
                    <input type="checkbox" id="cfg-scene-title" checked>
                    <label for="cfg-scene-title">Titre de sc√®ne</label>
                </div>
                <button onclick="app.Storyboard.applyConfig()" style="width: 100%; margin-top: 15px; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Appliquer</button>
            </div>
        </div>
    </div>
    
    <div class="storyboard-layout" id="sbEditView">
        <div class="storyboard-scenes" id="sbScenesList"></div>
        <div class="storyboard-shots">
            <div id="sbNoScene" style="text-align: center; color: var(--text-sec); margin-top: 50px;">
                S√©lectionnez une sc√®ne √† gauche
            </div>
            <div id="sbShotsContainer" style="display: none;">
                <button onclick="app.Storyboard.addShot()" style="width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px;">
                    ‚ûï Ajouter un Plan
                </button>
                <div id="sbShotsList"></div>
            </div>
        </div>
    </div>
    
    <div class="sb-print-preview" id="sbPrintPreview"></div>
</div>

<div class="sb-fullscreen-modal" id="sbFullscreenModal">
    <div class="sb-fullscreen-header">
        <h2 style="margin: 0;">Aper√ßu Impression Storyboard</h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="window.print()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üñ®Ô∏è Imprimer</button>
            <button onclick="app.Storyboard.closeFullscreen()" style="padding: 10px 20px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚úñ Fermer</button>
        </div>
    </div>
    <div class="sb-fullscreen-content" id="sbFullscreenContent"></div>
</div>
	  
      <div id="tab-chars" class="tab-content">
          <h1 class="print-only-title">PERSONNAGES</h1>
          <button onclick="app.Actions.addGroup('perso')" style="margin-bottom:20px;padding:8px 15px;cursor:pointer;background:var(--panel-bg);color:var(--text-main);border:1px solid var(--border);border-radius:4px">‚ûï Nouveau Groupe</button>
          <div id="charContainer"></div>
      </div>
      
      <div id="tab-actors" class="tab-content">
          <h1 class="print-only-title">COM√âDIEN.NES</h1>
          <div style="display:flex; gap:10px; margin-bottom:20px;">
              <button onclick="app.Actions.addGroup('actor')" style="padding:8px 15px;cursor:pointer;background:var(--panel-bg);color:var(--text-main);border:1px solid var(--border);border-radius:4px">‚ûï Nouveau Groupe</button>
              <button onclick="app.Actions.addActor()" style="padding:8px 15px;cursor:pointer;background:var(--primary);color:#fff;border:none;border-radius:4px;font-weight:bold;">‚ûï Ajouter Com√©dien.ne</button>
              <button onclick="app.Contacts.importToProject('actors')" style="padding:8px 15px;cursor:pointer;background:var(--panel-bg);color:var(--text-main);border:1px solid var(--border);border-radius:4px;font-weight:bold;">üìá Mes contacts</button>
              <button onclick="app.GlobalSearch.openActors()" style="padding:8px 15px;cursor:pointer;background:var(--success);color:#fff;border:none;border-radius:4px;font-weight:bold;">üîç Rechercher un.e com√©dien.ne</button>
              <button onclick="app.ActorSearch.toggleFilters()" style="padding:8px 15px;cursor:pointer;background:var(--panel-bg);color:var(--text-main);border:1px solid var(--border);border-radius:4px;font-weight:bold;">‚öôÔ∏è Filtrer projet</button>
          </div>
          <div id="actor-filters" style="display:none; margin-top:15px; padding:15px; background:var(--panel-bg); border:1px solid var(--border); border-radius:8px;">
              <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                  <input type="text" id="filter-name" placeholder="üîç Rechercher par nom..." style="padding:8px; border:1px solid var(--border); border-radius:4px; min-width:200px;" oninput="app.ActorSearch.applyFilters()">
                  <select id="filter-gender" style="padding:8px; border:1px solid var(--border); border-radius:4px;" onchange="app.ActorSearch.applyFilters()">
                      <option value="">Tous les sexes</option>
                      <option value="homme">Homme</option>
                      <option value="femme">Femme</option>
                      <option value="non-binaire">Non-binaire</option>
                  </select>
                  <select id="filter-ethnicity" style="padding:8px; border:1px solid var(--border); border-radius:4px;" onchange="app.ActorSearch.applyFilters()">
                      <option value="">Toutes origines</option>
                      <option value="caucasien">Caucasien</option>
                      <option value="africain">Africain</option>
                      <option value="asiatique">Asiatique</option>
                      <option value="latino">Latino</option>
                      <option value="maghrebin">Maghr√©bin</option>
                      <option value="moyenorient">Moyen-Orient</option>
                      <option value="indien">Indien</option>
                      <option value="metis">M√©tis</option>
                  </select>
                  <select id="filter-hair" style="padding:8px; border:1px solid var(--border); border-radius:4px;" onchange="app.ActorSearch.applyFilters()">
                      <option value="">Tous cheveux</option>
                      <option value="noir">Noir</option>
                      <option value="brun">Brun</option>
                      <option value="chatain">Ch√¢tain</option>
                      <option value="blond">Blond</option>
                      <option value="roux">Roux</option>
                      <option value="gris">Gris</option>
                      <option value="chauve">Chauve</option>
                  </select>
                  <select id="filter-eyes" style="padding:8px; border:1px solid var(--border); border-radius:4px;" onchange="app.ActorSearch.applyFilters()">
                      <option value="">Tous yeux</option>
                      <option value="marron">Marron</option>
                      <option value="bleu">Bleu</option>
                      <option value="vert">Vert</option>
                      <option value="gris">Gris</option>
                      <option value="noisette">Noisette</option>
                      <option value="noir">Noir</option>
                  </select>
              </div>
              <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px;">
                  <div style="display:flex; align-items:center; gap:5px;">
                      <label style="font-size:0.85rem;">√Çge:</label>
                      <input type="number" id="filter-age-min" placeholder="Min" style="padding:6px; border:1px solid var(--border); border-radius:4px; width:60px;" oninput="app.ActorSearch.applyFilters()">
                      <span>-</span>
                      <input type="number" id="filter-age-max" placeholder="Max" style="padding:6px; border:1px solid var(--border); border-radius:4px; width:60px;" oninput="app.ActorSearch.applyFilters()">
                  </div>
                  <div style="display:flex; align-items:center; gap:5px;">
                      <label style="font-size:0.85rem;">Taille (cm):</label>
                      <input type="number" id="filter-height-min" placeholder="Min" style="padding:6px; border:1px solid var(--border); border-radius:4px; width:60px;" oninput="app.ActorSearch.applyFilters()">
                      <span>-</span>
                      <input type="number" id="filter-height-max" placeholder="Max" style="padding:6px; border:1px solid var(--border); border-radius:4px; width:60px;" oninput="app.ActorSearch.applyFilters()">
                  </div>
                  <input type="text" id="filter-sports" placeholder="Sport (ex: √©quitation)" style="padding:8px; border:1px solid var(--border); border-radius:4px; width:150px;" oninput="app.ActorSearch.applyFilters()">
                  <input type="text" id="filter-languages" placeholder="Langue (ex: anglais)" style="padding:8px; border:1px solid var(--border); border-radius:4px; width:150px;" oninput="app.ActorSearch.applyFilters()">
                  <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; cursor:pointer;">
                      <input type="checkbox" id="filter-vehicle" onchange="app.ActorSearch.applyFilters()"> üöó V√©hicule
                  </label>
                  <button onclick="app.ActorSearch.resetFilters()" style="padding:6px 12px; background:var(--danger); color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.85rem;">‚úñ R√©initialiser</button>
              </div>
              <div id="filter-results-count" style="margin-top:10px; font-size:0.85rem; color:var(--text-sec);"></div>
          </div>
          <div id="actorContainer"></div>
      </div>

      <div id="tab-locs" class="tab-content">
          <h1 class="print-only-title">D√âCORS</h1>
          <button onclick="app.Actions.addGroup('lieu')" style="margin-bottom:20px;padding:8px 15px;cursor:pointer;background:var(--panel-bg);color:var(--text-main);border:1px solid var(--border);border-radius:4px">‚ûï Nouveau Groupe</button>
          <div id="locContainer"></div>
      </div>
      
      <div id="tab-resources" class="tab-content">
          <h1 class="print-only-title">RESSOURCES</h1>
          <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center;">
              <button onclick="app.Resources.add()" style="padding:8px 15px;cursor:pointer;background:var(--primary);color:#fff;border:none;border-radius:4px;font-weight:bold">‚ûï Nouvelle Ressource</button>
              <div style="display:flex; gap:5px; margin-left:auto;">
                  <button class="res-filter-btn active" data-filter="all" onclick="app.Resources.filter('all')">Tous</button>
                  <button class="res-filter-btn" data-filter="accessoire" onclick="app.Resources.filter('accessoire')">üé≠ Accessoires</button>
                  <button class="res-filter-btn" data-filter="costume" onclick="app.Resources.filter('costume')">üëî Costumes</button>
                  <button class="res-filter-btn" data-filter="vehicule" onclick="app.Resources.filter('vehicule')">üöó V√©hicules</button>
              </div>
          </div>
          <div id="resourcesContainer" class="resources-grid"></div>
          <div id="resourcesEmpty" class="empty-state" style="display:none;">
              <div class="empty-icon">üì¶</div>
              <h3>Aucune ressource</h3>
              <p>Ajoutez vos accessoires, costumes et v√©hicules pour les lier aux sc√®nes via le d√©pouillement.</p>
              <button onclick="app.Resources.add()" class="empty-action">‚ûï Ajouter une ressource</button>
          </div>
      </div>

	<div id="tab-crew" class="tab-content">
		<h1 class="print-only-title">√âQUIPES</h1>
		<div style="display:flex; gap:10px; margin-bottom:20px;">
			<button onclick="app.Actions.addGroup('crew')" style="padding:8px 15px;cursor:pointer;background:var(--panel-bg);color:var(--text-main);border:1px solid var(--border);border-radius:4px">‚ûï Nouveau D√©partement</button>
			<button onclick="app.Crew.addMember()" style="padding:8px 15px;cursor:pointer;background:var(--primary);color:#fff;border:none;border-radius:4px;font-weight:bold">‚ûï Ajouter Technicien</button>
            <button onclick="app.Contacts.importToProject('crew')" style="padding:8px 15px;cursor:pointer;background:var(--panel-bg);color:var(--text-main);border:1px solid var(--border);border-radius:4px;font-weight:bold;">üìá Mes contacts</button>
            <button onclick="app.GlobalSearch.openCrew()" style="padding:8px 15px;cursor:pointer;background:var(--success);color:#fff;border:none;border-radius:4px;font-weight:bold;">üîç Rechercher un.e technicien.ne</button>
		</div>
		<div id="crewContainer"></div>
	</div>
	  
<div id="tab-stats" class="tab-content">
    <h1 class="print-only-title">STATISTIQUES</h1>
    
    <!-- Cartes r√©sum√© -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Sc√®nes</div>
            <div class="stat-number" id="stat-total-scenes">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Dialogues</div>
            <div class="stat-number" id="stat-total-dials">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Dur√©e Estim√©e</div>
            <div class="stat-number" id="stat-total-time">0 min</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Plans</div>
            <div class="stat-number" id="stat-total-shots">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">√âquipe Technique</div>
            <div class="stat-number" id="stat-total-crew">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Budget √âquipe</div>
            <div class="stat-number" id="stat-total-budget" style="font-size: 1.8rem;">0 ‚Ç¨</div>
        </div>
    </div>

    <!-- Section Avancement -->
    <div class="stats-section-title">üìà Avancement du projet</div>
    <div class="charts-row-advanced">
        <div class="chart-box-advanced">
            <div class="chart-title">Sc√®nes planifi√©es</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progress-scenes-planned" style="width: 0%; background: linear-gradient(90deg, #4CAF50, #8BC34A);">0%</div>
            </div>
            <div class="stats-legend" id="legend-scenes-planned"></div>
        </div>
        <div class="chart-box-advanced">
            <div class="chart-title">R√©partition INT / EXT</div>
            <div class="chart-canvas-container">
                <canvas id="chart-int-ext"></canvas>
            </div>
        </div>
        <div class="chart-box-advanced">
            <div class="chart-title">R√©partition JOUR / NUIT</div>
            <div class="chart-canvas-container">
                <canvas id="chart-jour-nuit"></canvas>
            </div>
        </div>
    </div>

    <!-- Section Budget -->
    <div class="stats-section-title">üí∞ Budget</div>
    <div class="charts-row-advanced">
        <div class="chart-box-advanced">
            <div class="chart-title">D√©penses par cat√©gorie</div>
            <div class="chart-canvas-container">
                <canvas id="chart-budget-cat"></canvas>
            </div>
        </div>
        <div class="chart-box-advanced">
            <div class="chart-title">Budget vs D√©penses</div>
            <div class="budget-comparison">
                <div class="budget-item">
                    <div class="budget-item-label">Budget pr√©vu</div>
                    <div class="budget-item-value" id="budget-prevu">0 ‚Ç¨</div>
                </div>
                <div class="budget-item">
                    <div class="budget-item-label">D√©pens√©</div>
                    <div class="budget-item-value" id="budget-depense">0 ‚Ç¨</div>
                </div>
                <div class="budget-item">
                    <div class="budget-item-label">Reste</div>
                    <div class="budget-item-value" id="budget-reste">0 ‚Ç¨</div>
                </div>
            </div>
            <div class="progress-bar-container" style="margin-top:15px;">
                <div class="progress-bar-fill" id="progress-budget" style="width: 0%; background: linear-gradient(90deg, #2196F3, #03A9F4);">0%</div>
            </div>
        </div>
    </div>

    <!-- Section Temps -->
    <div class="stats-section-title">‚è±Ô∏è Temps par Tag/Acte</div>
    <div class="charts-row-advanced">
        <div class="chart-box-advanced" style="grid-column: span 2;">
            <div class="chart-title">Dur√©e estim√©e par Tag</div>
            <div class="chart-canvas-container" style="height: 300px;">
                <canvas id="chart-time-tags"></canvas>
            </div>
        </div>
    </div>

    <!-- Graphiques existants -->
    <div class="stats-section-title">üë• Personnages & Lieux</div>
    <div class="charts-row">
        <div class="chart-box">
            <div class="chart-title">Personnages (Nombre de mots)</div>
            <div id="chart-chars"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">R√©partition par Axe (Tags)</div>
            <div id="chart-tags"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">Lieux (Nombre de sc√®nes)</div>
            <div id="chart-lieux"></div>
        </div>
    </div>

    <div class="stats-section-title">üé¨ √âquipe & Storyboard</div>
    <div class="charts-row">
        <div class="chart-box">
            <div class="chart-title">√âquipe par D√©partement</div>
            <div id="chart-crew"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">Plans par Type</div>
            <div id="chart-shots"></div>
        </div>
    </div>

    <div class="stats-section-title">üé≠ Jours de Tournage par Com√©dien</div>
    <div class="charts-row">
        <div class="chart-box" style="grid-column: span 2;">
            <div class="chart-title">Jours planifi√©s par com√©dien</div>
            <div id="chart-actor-days"></div>
        </div>
    </div>
</div>

<div id="tab-breakdown" class="tab-content">
          <h1 class="print-only-title">D√âPOUILLEMENT</h1>
          <div class="breakdown-layout">
              <svg id="bd-link-svg"></svg>
              <div class="breakdown-col" id="breakdownScriptCol">
                  <div class="bd-header">SC√âNARIO</div>
                  <div class="bd-content" id="bdScriptContent" oncontextmenu="app.Breakdown.handleRightClick(event)">
                      <div style="color:var(--text-sec);text-align:center;margin-top:20px">S√©lectionnez une sc√®ne √† droite.</div>
                  </div>
              </div>
              <div class="breakdown-col">
                  <div class="bd-header">D√âPOUILLEMENT PAR SC√àNE</div>
                  <div class="bd-content" id="bdRightContent" style="padding:0"></div>
              </div>
          </div>
      </div>

<div id="tab-chat" class="tab-content">
    <div style="display: flex; height: calc(100vh - 200px); gap: 20px; padding: 20px;">
        <!-- Liste des canaux -->
        <div style="width: 280px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                <h3 style="margin: 0; font-size: 1rem;">üí¨ Canaux</h3>
            </div>
            <div id="chat-channels-list" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
            <div style="padding: 10px; border-top: 1px solid var(--border);">
                <button onclick="app.Chat.createCustomChannel()" style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">‚ûï Nouveau groupe</button>
            </div>
        </div>
        
        <!-- Zone de chat principale -->
        <div style="flex: 1; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column;">
            <div id="chat-main-header" style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1rem;" id="chat-channel-title">üì¢ S√©lectionnez un canal</h3>
                <div>
                    <button id="chat-members-btn" onclick="app.Chat.toggleMembersPanel()" style="padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; display: none;">üë• Membres</button>
                </div>
            </div>
            <div id="chat-messages-container" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;">
                <div class="chat-empty">
                    <p style="font-size: 2rem; margin-bottom: 10px;">üí¨</p>
                    <p>S√©lectionnez un canal pour commencer √† discuter</p>
                </div>
            </div>
            <div id="chat-input-container" style="padding: 15px; border-top: 1px solid var(--border); display: none;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-message-input" class="chat-input" placeholder="√âcrivez votre message..." onkeypress="if(event.key === 'Enter') app.Chat.sendMessage()">
                    <button onclick="app.Chat.sendMessage()" class="chat-send-btn">‚û§</button>
                </div>
            </div>
        </div>
        
        <!-- Panel des membres (cach√© par d√©faut) -->
        <div id="chat-members-panel" style="width: 250px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; display: none; flex-direction: column;">
            <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1rem;">üë• Membres</h3>
                <button onclick="app.Chat.toggleMembersPanel()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">‚úñ</button>
            </div>
            <div id="chat-members-list" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
            <div id="chat-add-member-section" style="padding: 10px; border-top: 1px solid var(--border); display: none;">
                <button onclick="app.Chat.showAddMemberModal()" style="width: 100%; padding: 8px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer;">‚ûï Ajouter un membre</button>
            </div>
        </div>
    </div>
</div>

<div id="tab-planning" class="tab-content">
    <h1 class="print-only-title">PLANNING DE TOURNAGE</h1>
    
    <div class="planning-availability-panel" style="background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-start;">
            <!-- Com√©diens -->
            <div style="flex: 1; min-width: 280px;">
                <strong style="display: block; margin-bottom: 8px;">üé≠ Com√©dien.nes</strong>
                <div style="position: relative;">
                    <input type="text" id="planning-actors-search" placeholder="üîç Rechercher un com√©dien..." 
                           oninput="app.Planning.filterAvailabilityList('actors')"
                           style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text-main); margin-bottom: 8px;">
                    <div id="planning-actors-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                </div>
                <div id="planning-actors-tags" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 32px;"></div>
            </div>
            <!-- Techniciens -->
            <div style="flex: 1; min-width: 280px;">
                <strong style="display: block; margin-bottom: 8px;">üé• Technicien.nes</strong>
                <div style="position: relative;">
                    <input type="text" id="planning-crew-search" placeholder="üîç Rechercher un technicien..." 
                           oninput="app.Planning.filterAvailabilityList('crew')"
                           style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text-main); margin-bottom: 8px;">
                    <div id="planning-crew-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                </div>
                <div id="planning-crew-tags" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 32px;"></div>
            </div>
        </div>
    </div>
    
    <div class="planning-header">
        <div class="planning-header-row">
            <div class="planning-nav">
                <button class="planning-nav-btn" onclick="app.Planning.prev()">‚óÄ Pr√©c√©dent</button>
                <div class="planning-title" id="planningTitle">Juin 2025</div>
                <button class="planning-nav-btn" onclick="app.Planning.next()">Suivant ‚ñ∂</button>
                <div class="planning-view-toggle" id="calendar-view-toggle">
                    <button class="planning-view-btn active" onclick="app.Planning.setView('month')">Mois</button>
                    <button class="planning-view-btn" onclick="app.Planning.setView('week')">Semaine</button>
                    <button class="planning-view-btn" onclick="app.Planning.setView('day')">Jour</button>
                </div>
                <button class="planning-nav-btn" onclick="app.Planning.goToday()">Aujourd'hui</button>
            </div>
            
            <div class="planning-view-toggle">
                <button class="planning-view-btn active" id="planning-mode-calendar" onclick="app.Planning.setMode('calendar')">üìÖ Calendrier</button>
                <button class="planning-view-btn" id="planning-mode-kanban" onclick="app.Planning.setMode('kanban')">üìä Kanban</button>
                <button class="planning-view-btn" id="planning-mode-workplan" onclick="app.Planning.setMode('workplan')">üìã Plan de travail</button>
            </div>
        </div>
        
        <div class="planning-actions" style="justify-content: center;">
            <button class="planning-action-btn primary" onclick="app.Planning.addShootDay()">‚ûï Ajouter Jour</button>
            <button class="planning-action-btn success" onclick="app.Planning.openCallSheets()">üìÑ Feuilles de Service</button>
            <button class="planning-action-btn secondary" onclick="app.Planning.exportICS()">üìÖ Export .ICS</button>
            <button class="planning-action-btn secondary" onclick="app.Planning.showAvailabilityView()">üë• Disponibilit√©s</button>
        </div>
    </div>
    
    <div id="planningContainer"></div>
    
    <!-- Vue Plan de Travail (DOOD) -->
    <div id="workplanContainer" style="display: none;">
        <div id="workplanContent"></div>
    </div>
    
    <!-- Vue Kanban -->
    <div id="kanbanContainer" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="color: var(--text-sec); font-size: 0.9rem;">üìä Filtrer par type :</span>
                <select id="kanban-type-filter" onchange="app.Planning.renderKanban()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <option value="all">Tous les types</option>
                    <option value="tournage">üé¨ Tournage</option>
                    <option value="repetition">üé≠ R√©p√©tition</option>
                    <option value="reperage">üîç Rep√©rage</option>
                    <option value="essai-costume">üëó Essai costume</option>
                    <option value="essai-maquillage">üíÑ Essai maquillage</option>
                    <option value="formation">üìö Formation</option>
                    <option value="reunion">üìã R√©union</option>
                    <option value="autre">üìå Autre</option>
                </select>
            </div>
            <button onclick="app.Planning.renderKanban()" style="padding: 8px 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-main);">üîÑ Rafra√Æchir</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px 0;">
            <div class="kanban-column" id="kanban-todo">
                <div class="kanban-column-header" style="background: var(--bg); padding: 12px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #6b7280;">
                    <span style="font-size: 1.1rem;">üìù √Ä faire</span>
                    <span class="kanban-count" id="kanban-count-todo" style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
                </div>
                <div class="kanban-column-body" id="kanban-body-todo" style="background: var(--bg); min-height: 300px; padding: 10px; border-radius: 0 0 8px 8px;"></div>
            </div>
            <div class="kanban-column" id="kanban-planned">
                <div class="kanban-column-header" style="background: var(--bg); padding: 12px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #3b82f6;">
                    <span style="font-size: 1.1rem;">üìÖ Planifi√©</span>
                    <span class="kanban-count" id="kanban-count-planned" style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
                </div>
                <div class="kanban-column-body" id="kanban-body-planned" style="background: var(--bg); min-height: 300px; padding: 10px; border-radius: 0 0 8px 8px;"></div>
            </div>
            <div class="kanban-column" id="kanban-shooting">
                <div class="kanban-column-header" style="background: var(--bg); padding: 12px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #f59e0b;">
                    <span style="font-size: 1.1rem;">üé¨ En tournage</span>
                    <span class="kanban-count" id="kanban-count-shooting" style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
                </div>
                <div class="kanban-column-body" id="kanban-body-shooting" style="background: var(--bg); min-height: 300px; padding: 10px; border-radius: 0 0 8px 8px;"></div>
            </div>
            <div class="kanban-column" id="kanban-done">
                <div class="kanban-column-header" style="background: var(--bg); padding: 12px; border-radius: 8px 8px 0 0; border-bottom: 3px solid #10b981;">
                    <span style="font-size: 1.1rem;">‚úÖ Termin√©</span>
                    <span class="kanban-count" id="kanban-count-done" style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">0</span>
                </div>
                <div class="kanban-column-body" id="kanban-body-done" style="background: var(--bg); min-height: 300px; padding: 10px; border-radius: 0 0 8px 8px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Disponibilit√©s crois√©es -->
    <div id="availability-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
        <div style="background:var(--panel-bg); border-radius:12px; width:95%; max-width:1200px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
            <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">üë• Disponibilit√©s de l'√©quipe</h2>
                <button onclick="document.getElementById('availability-modal').style.display='none'" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
            </div>
            <div style="padding:20px; overflow-y:auto; flex:1;">
                <div class="calendar-nav" style="margin-bottom:20px;">
                    <button class="calendar-nav-btn" onclick="app.Planning.prevAvailMonth()">‚óÄ</button>
                    <span class="calendar-month-year" id="avail-month-year">D√©cembre 2024</span>
                    <button class="calendar-nav-btn" onclick="app.Planning.nextAvailMonth()">‚ñ∂</button>
                </div>
                <div id="availability-calendar-container"></div>
                <div class="calendar-legend" style="margin-top:20px;">
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background:#4CAF50;"></div>
                        <span>Jour de tournage pr√©vu</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background:#2196F3;"></div>
                        <span>Disponible</span>
                    </div>
                    <div class="calendar-legend-item">
                        <div class="calendar-legend-color" style="background:#f44336;"></div>
                        <span>Indisponible</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Feuilles de Service -->
<div id="callsheets-modal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
    <div style="background:var(--panel-bg); border-radius:12px; width:90%; max-width:900px; max-height:90vh; overflow-y:auto;">
        <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0;">üìÑ Feuilles de Service</h2>
            <button onclick="app.Planning.closeCallSheets()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">‚úñ</button>
        </div>
        <div id="callsheets-list" style="padding:20px;"></div>
    </div>
</div>

<!-- ONGLET RAPPORT DE SCRIPT / CONTINUIT√â -->
<div id="tab-scriptreport" class="tab-content">
    <h1 class="print-only-title">RAPPORT DE SCRIPT</h1>
    
    <style>
        .sr-container { display: flex; gap: 20px; height: calc(100vh - 180px); }
        .sr-sidebar { width: 280px; min-width: 280px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow-y: auto; }
        .sr-main { flex: 1; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; overflow-y: auto; padding: 20px; }
        .sr-scene-item { padding: 10px 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .sr-scene-item:hover { background: var(--bg); }
        .sr-scene-item.active { background: var(--primary); color: white; }
        .sr-scene-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; }
        .sr-shot-list { padding-left: 15px; }
        .sr-shot-item { padding: 6px 10px; margin: 3px 0; border-radius: 4px; font-size: 0.85rem; cursor: pointer; background: var(--bg); border: 1px solid transparent; }
        .sr-shot-item:hover { border-color: var(--primary); }
        .sr-shot-item.active { background: var(--primary); color: white; }
        .sr-shot-item.has-report { border-left: 3px solid var(--success); }
        .sr-sheet { border: 2px solid #333; background: white; color: #333; font-family: 'Courier Prime', monospace; }
        .sr-sheet-header { display: grid; grid-template-columns: 1fr auto; border-bottom: 2px solid #333; }
        .sr-sheet-row { display: grid; border-bottom: 1px solid #333; }
        .sr-sheet-cell { padding: 8px 10px; border-right: 1px solid #333; }
        .sr-sheet-cell:last-child { border-right: none; }
        .sr-sheet-cell input, .sr-sheet-cell select, .sr-sheet-cell textarea { 
            width: 100%; border: none; background: transparent; font-family: inherit; font-size: inherit; padding: 0; color: inherit;
        }
        .sr-sheet-cell input:focus, .sr-sheet-cell select:focus, .sr-sheet-cell textarea:focus { outline: 2px solid var(--primary); }
        .sr-takes-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .sr-takes-table th, .sr-takes-table td { border: 1px solid #333; padding: 6px 8px; text-align: left; font-size: 0.85rem; }
        .sr-takes-table th { background: #f0f0f0; font-weight: 600; }
        .sr-nav-reports { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .sr-nav-btn { padding: 6px 12px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); cursor: pointer; font-size: 0.8rem; }
        .sr-nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .sr-quality-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .sr-quality-label { width: 60px; font-weight: 600; font-size: 0.8rem; }
        .sr-quality-select { flex: 0 0 120px; padding: 4px; border: 1px solid #333; font-size: 0.8rem; }
        .sr-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-sec); text-align: center; padding: 40px; }
        .sr-empty-icon { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }
        @media (max-width: 900px) { .sr-container { flex-direction: column; height: auto; } .sr-sidebar { width: 100%; max-height: 300px; } }
    </style>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <h2 style="margin: 0;">üìã Rapport de Script</h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="app.ScriptReport.exportCurrentPDF()" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üìÑ Export PDF</button>
            <button onclick="app.ScriptReport.exportAllPDF()" style="padding: 8px 16px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üì¶ Export Tous</button>
        </div>
    </div>
    
    <div class="sr-container">
        <!-- Sidebar : Liste des sc√®nes et plans -->
        <div class="sr-sidebar">
            <div style="padding: 15px; border-bottom: 1px solid var(--border); background: var(--bg);">
                <strong>üé¨ Sc√®nes & Plans</strong>
            </div>
            <div id="sr-scenes-list"></div>
        </div>
        
        <!-- Zone principale : Fiche de script -->
        <div class="sr-main">
            <div id="sr-sheet-container">
                <div class="sr-empty">
                    <div class="sr-empty-icon">üìã</div>
                    <h3>Fiche de Script</h3>
                    <p>S√©lectionnez un plan dans la liste de gauche pour remplir sa fiche de script.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="tab-expenses" class="tab-content">
    <h1 class="print-only-title">BUDGET & D√âPENSES</h1>
    
    <!-- Toggle Mode Simple / Avanc√© -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; gap: 5px;">
        <button id="expenses-mode-simple" onclick="app.Expenses.setMode('simple')" style="padding: 8px 16px; border: 1px solid var(--primary); border-radius: 6px 0 0 6px; cursor: pointer; font-weight: 500; background: var(--primary); color: white;">üìã Simple</button>
        <button id="expenses-mode-advanced" onclick="app.Expenses.setMode('advanced')" style="padding: 8px 16px; border: 1px solid var(--border); border-radius: 0 6px 6px 0; cursor: pointer; font-weight: 500; background: var(--bg); color: var(--text-main);">‚öôÔ∏è Avanc√©</button>
    </div>
    
    <div class="expenses-container">
        <!-- Sidebar gauche (Mode Avanc√© uniquement) -->
        <div class="expenses-sidebar" id="expenses-sidebar-advanced">
            <h3 style="margin-top: 0; margin-bottom: 15px;">üí∞ Budget Pr√©visionnel</h3>
            
            <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="font-size: 0.85rem; color: var(--text-sec);">Budget Total</label>
                    <div style="display: flex; gap: 5px;">
                        <button id="vat-mode-ht" onclick="app.Expenses.setVatMode('HT')" style="padding: 4px 10px; border: 1px solid var(--primary); border-radius: 4px 0 0 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; background: var(--primary); color: white;">HT</button>
                        <button id="vat-mode-ttc" onclick="app.Expenses.setVatMode('TTC')" style="padding: 4px 10px; border: 1px solid var(--border); border-radius: 0 4px 4px 0; cursor: pointer; font-size: 0.75rem; font-weight: 600; background: var(--bg); color: var(--text-main);">TTC</button>
                    </div>
                </div>
                <input type="number" id="expenses-budget-total" class="profile-input" placeholder="0" style="font-size: 1.2rem; font-weight: bold;" onchange="app.Expenses.saveBudget()" readonly title="Calcul√© automatiquement depuis les cat√©gories">
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <select id="expenses-currency" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Expenses.saveBudget()">
                        <option value="‚Ç¨">‚Ç¨ Euro</option>
                        <option value="$">$ Dollar</option>
                        <option value="¬£">¬£ Livre</option>
                        <option value="CHF">CHF Franc Suisse</option>
                    </select>
                    <select id="expenses-default-vat" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" onchange="app.Expenses.saveDefaultVat()" title="TVA par d√©faut">
                        <option value="0">TVA 0%</option>
                        <option value="5.5">TVA 5.5%</option>
                        <option value="10">TVA 10%</option>
                        <option value="20" selected>TVA 20%</option>
                    </select>
                </div>
            </div>
            
            <!-- Alertes budget -->
            <div style="background: var(--bg); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-sec);">
                    <span>‚ö†Ô∏è Alertes √†</span>
                    <input type="number" id="alert-threshold-warning" value="80" style="width: 50px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); text-align: center;" onchange="app.Expenses.saveAlertThresholds()">
                    <span>% et</span>
                    <input type="number" id="alert-threshold-danger" value="100" style="width: 50px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); text-align: center;" onchange="app.Expenses.saveAlertThresholds()">
                    <span>%</span>
                </div>
            </div>
            
            <div class="expense-section-title">üë§ Responsable Budget Global</div>
            <select id="expenses-manager" class="profile-input" style="width: 100%;" onchange="app.Expenses.saveManager()">
                <option value="">-- Choisir --</option>
            </select>
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; margin-bottom: 15px; font-size: 0.85rem; color: var(--text-sec); cursor: pointer;">
                <input type="checkbox" id="manager-email-notif" onchange="app.Expenses.saveManagerEmailPref()" checked>
                üìß Recevoir les emails
            </label>
            
            <div class="expense-section-title">üìä Cat√©gories CNC</div>
            <div style="font-size: 0.75rem; color: var(--text-sec); margin-bottom: 10px;">Cliquez sur ‚öôÔ∏è pour d√©finir le budget pr√©visionnel</div>
            <div id="expenses-dept-list" style="max-height: 300px; overflow-y: auto;"></div>
            
            <div class="expense-section-title" style="margin-top: 20px;">‚öôÔ∏è Param√®tres financiers</div>
            <div class="finance-params">
                <div class="finance-param-row">
                    <label>üöó Indemnit√© km</label>
                    <div class="finance-param-input">
                        <input type="number" id="param-km-rate" step="0.01" placeholder="0.55" onchange="app.Expenses.saveFinanceParams()">
                        <span class="param-unit">‚Ç¨/km</span>
                    </div>
                </div>
                <div class="finance-param-row">
                    <label>üçΩÔ∏è Per diem repas</label>
                    <div class="finance-param-input">
                        <input type="number" id="param-perdiem-meal" placeholder="19" onchange="app.Expenses.saveFinanceParams()">
                        <span class="param-unit">‚Ç¨/jour</span>
                    </div>
                </div>
                <div class="finance-param-row">
                    <label>üè® Per diem h√©berg.</label>
                    <div class="finance-param-input">
                        <input type="number" id="param-perdiem-hotel" placeholder="80" onchange="app.Expenses.saveFinanceParams()">
                        <span class="param-unit">‚Ç¨/nuit</span>
                    </div>
                </div>
                <div class="finance-param-row">
                    <label>‚è∞ Seuil heures sup</label>
                    <div class="finance-param-input">
                        <input type="number" id="param-overtime-threshold" placeholder="8" onchange="app.Expenses.saveFinanceParams()">
                        <span class="param-unit">heures</span>
                    </div>
                </div>
                <div class="finance-param-row">
                    <label>üìà Majorations HS</label>
                    <div class="finance-param-rates">
                        <input type="number" id="param-overtime-1" placeholder="25" title="Premi√®re tranche" onchange="app.Expenses.saveFinanceParams()"><span>%</span>
                        <input type="number" id="param-overtime-2" placeholder="50" title="Deuxi√®me tranche" onchange="app.Expenses.saveFinanceParams()"><span>%</span>
                        <input type="number" id="param-overtime-3" placeholder="100" title="Troisi√®me tranche" onchange="app.Expenses.saveFinanceParams()"><span>%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Zone principale -->
        <div class="expenses-main">
            <!-- R√©sum√© simplifi√© (Mode Simple) -->
            <div id="expenses-simple-header" style="display: none; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-size: 0.85rem; color: var(--text-sec); display: block; margin-bottom: 5px;">üí∞ Budget Total</label>
                        <input type="number" id="expenses-budget-simple" class="profile-input" placeholder="0" style="font-size: 1.1rem; font-weight: bold;" onchange="app.Expenses.saveBudgetSimple()">
                    </div>
                    <div style="text-align: center; padding: 15px 25px; background: var(--bg); border-radius: 8px;">
                        <div style="font-size: 1.3rem; font-weight: bold;" id="expenses-spent-simple">0 ‚Ç¨</div>
                        <div style="font-size: 0.8rem; color: var(--text-sec);">D√©pens√©</div>
                    </div>
                    <div style="text-align: center; padding: 15px 25px; background: var(--success); color: white; border-radius: 8px;" id="expenses-remaining-simple-card">
                        <div style="font-size: 1.3rem; font-weight: bold;" id="expenses-remaining-simple">0 ‚Ç¨</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Restant</div>
                    </div>
                </div>
            </div>
            
            <!-- R√©sum√© complet (Mode Avanc√©) -->
            <div class="expenses-summary" id="expenses-summary-advanced">
                <div class="expenses-summary-card">
                    <div class="amount" id="expenses-total-budget">0 ‚Ç¨</div>
                    <div class="label">Budget Total</div>
                </div>
                <div class="expenses-summary-card">
                    <div class="amount" id="expenses-total-spent">0 ‚Ç¨</div>
                    <div class="label">D√©pens√© / Engag√©</div>
                </div>
                <div class="expenses-summary-card success">
                    <div class="amount" id="expenses-total-remaining">0 ‚Ç¨</div>
                    <div class="label">Restant</div>
                </div>
            </div>
            
            <!-- Filtres (Mode Avanc√©) -->
            <div class="expenses-filters" id="expenses-filters-advanced">
                <select id="expenses-filter-dept" onchange="app.Expenses.applyFilters()">
                    <option value="">Toutes les cat√©gories</option>
                </select>
                <select id="expenses-filter-status" onchange="app.Expenses.applyFilters()">
                    <option value="">Tous les statuts</option>
                    <option value="pending">‚è≥ En attente</option>
                    <option value="approved">‚úÖ Valid√©</option>
                    <option value="rejected">‚ùå Refus√©</option>
                    <option value="done">üí∞ Pay√©</option>
                </select>
                <input type="text" id="expenses-filter-search" placeholder="Rechercher..." onkeyup="app.Expenses.applyFilters()">
                <button onclick="app.Expenses.openAddModal()" style="padding: 8px 15px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚ûï Ajouter</button>
            </div>
            
            <!-- Filtres simplifi√©s (Mode Simple) -->
            <div id="expenses-filters-simple" style="display: none; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <select id="expenses-filter-status-simple" onchange="app.Expenses.applyFilters()" style="padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                        <option value="">Tous</option>
                        <option value="unpaid">‚è≥ √Ä payer</option>
                        <option value="paid">‚úÖ Pay√©</option>
                    </select>
                    <input type="text" id="expenses-filter-search-simple" placeholder="üîç Rechercher..." onkeyup="app.Expenses.applyFilters()" style="flex: 1; min-width: 150px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                    <button onclick="app.Expenses.openAddModal()" style="padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚ûï Nouvelle d√©pense</button>
                </div>
            </div>
            
<!-- Section salaires auto (Mode Avanc√© uniquement) -->
            <div class="expense-auto-section" id="expenses-salaries-section">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div>
                        <h4 style="margin: 0;">üíº Salaires (calcul√©s automatiquement)</h4>
                        <p style="font-size: 0.85rem; color: var(--text-sec); margin: 5px 0 0 0;">Bas√© sur le planning et les tarifs journaliers/horaires</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="app.Expenses.checkMissingInfo()" style="padding: 8px 15px; background: var(--warning, #FF9800); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">üîç V√©rifier infos</button>
                        <button onclick="app.Expenses.deleteSalaryExpenses()" style="padding: 8px 15px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">üóëÔ∏è Supprimer</button>
                        <button onclick="app.Expenses.generateSalaryExpenses()" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">üìù G√©n√©rer</button>
                    </div>
                </div>
                <div id="expenses-salaries-list"></div>
                <div style="text-align: right; margin-top: 10px; font-weight: bold;">
                    Total Salaires : <span id="expenses-salaries-total">0 ‚Ç¨</span>
                </div>
            </div>
            
            <!-- Liste des d√©penses -->
            <div class="expense-section-title">üìù D√©penses</div>
            <div id="expenses-list"></div>
        </div>
    </div>
</div>

    </main>
  </div> 
  
  <div id="script-ac-list"></div>
  
  <!-- Modal Rechercher/Remplacer -->
  <div id="search-replace-modal" style="display: none; position: fixed; top: 20px; right: 20px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 12px; padding: 0; width: 350px; z-index: 10001; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
      <div id="search-replace-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg); border-radius: 12px 12px 0 0; cursor: move; user-select: none; border-bottom: 1px solid var(--border);">
          <h3 style="margin: 0; color: var(--primary);">üîç Rechercher / Remplacer</h3>
          <button onclick="app.ScriptEditor.closeSearchReplace()" style="background: none; border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-sec);">‚úï</button>
      </div>
      <div style="padding: 20px;">
      <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Rechercher :</label>
          <input type="text" id="search-input" placeholder="Texte √† rechercher..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" oninput="app.ScriptEditor.searchInScript()">
      </div>
      <div style="margin-bottom: 12px;">
          <label style="display: block; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px;">Remplacer par :</label>
          <input type="text" id="replace-input" placeholder="Nouveau texte..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
      </div>
      <div style="margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-main); cursor: pointer;">
              <input type="checkbox" id="search-case-sensitive"> Respecter la casse
          </label>
          <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-main); cursor: pointer; margin-top: 5px;">
              <input type="checkbox" id="search-whole-word"> Mot entier uniquement
          </label>
      </div>
      <div id="search-results-info" style="margin-bottom: 12px; padding: 8px; background: var(--bg); border-radius: 6px; font-size: 0.85rem; color: var(--text-sec); text-align: center;">
          Tapez pour rechercher...
      </div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="app.ScriptEditor.searchPrev()" style="flex: 1; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-main);">‚óÄ Pr√©c.</button>
          <button onclick="app.ScriptEditor.searchNext()" style="flex: 1; padding: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-main);">Suiv. ‚ñ∂</button>
          <button onclick="app.ScriptEditor.replaceOne()" style="flex: 1; padding: 8px; background: var(--primary); border: none; border-radius: 6px; cursor: pointer; color: white;">Remplacer</button>
      </div>
      <button onclick="app.ScriptEditor.replaceAll()" style="width: 100%; margin-top: 8px; padding: 10px; background: var(--success); border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600;">üîÑ Tout remplacer</button>
      <button id="undo-replace-btn" onclick="app.ScriptEditor.undoReplace()" style="width: 100%; margin-top: 8px; padding: 10px; background: var(--danger); border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; display: none;">‚Ü©Ô∏è Annuler le remplacement</button>
      </div>
  </div>
  <div id="breakdown-ctx-menu"></div>
  <div id="tag-ctx-menu"></div>

  <div id="tag-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>Cr√©er un Tag</h3>
        <input type="text" id="tag-new-name" placeholder="Nom du tag (ex: Ennemis)" style="margin-bottom:10px">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
            <label>Couleur :</label>
            <input type="color" id="tag-new-color" value="#ff0000" style="width:50px; height:40px; padding:0; border:none; cursor:pointer;">
        </div>
        <div class="modal-btns">
            <button onclick="document.getElementById('tag-modal').style.display='none'" style="background:var(--bg); color:var(--text-main); border:1px solid var(--border); padding:8px 15px; border-radius:4px; cursor:pointer">Annuler</button>
            <button onclick="app.Actions.saveNewTag()" style="background:var(--primary); color:#fff; border:none; padding:8px 15px; border-radius:4px; cursor:pointer">Cr√©er</button>
        </div>
    </div>
  </div>

<div id="drawing-modal" class="drawing-modal">
    <div class="drawing-container">
        <div class="drawing-header">
            <h3 style="margin: 0;">√âditeur de Dessin</h3>
            <div style="display: flex; gap: 10px;">
                <button onclick="app.DrawingEditor.saveVersion()" style="padding: 8px 15px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">üíæ Sauvegarder Version</button>
                <button onclick="app.DrawingEditor.close()" style="padding: 8px 15px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">‚úñ Fermer</button>
            </div>
        </div>
        <div class="drawing-toolbar">
            <button onclick="app.DrawingEditor.undo()" style="padding: 8px 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">‚Ü∂ Annuler</button>
            <button onclick="app.DrawingEditor.redo()" style="padding: 8px 12px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">‚Ü∑ Refaire</button>
            <button onclick="app.DrawingEditor.clear()" style="padding: 8px 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è Effacer Tout</button>
            <select id="drawBrushSize" onchange="app.DrawingEditor.setBrushSize(this.value)" style="padding: 8px; border: 1px solid var(--border); border-radius: 4px;">
                <option value="2">Tr√®s fin</option>
                <option value="5">Fin</option>
                <option value="10" selected>Moyen</option>
                <option value="20">√âpais</option>
                <option value="40">Tr√®s √©pais</option>
            </select>
        </div>
        <div class="drawing-workspace">
            <div class="drawing-sidebar">
                <div class="tool-group">
                    <div class="tool-label">Couleurs</div>
                    <div class="color-palette" id="colorPalette"></div>
                </div>
                <div class="tool-group">
                    <div class="tool-label">Outils</div>
                    <div class="brush-btn active" onclick="app.DrawingEditor.setTool('pencil')">‚úèÔ∏è Crayon</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('pen')">üñäÔ∏è Stylo</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('marker')">üñåÔ∏è Feutre</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('highlighter')">üü® Stabilo</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('brush')">üé® Pinceau</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('airbrush')">üí® A√©rographe</div>
                    <div class="brush-btn" onclick="app.DrawingEditor.setTool('eraser')">üßπ Gomme</div>
                </div>
                <div class="tool-group">
                    <div class="tool-label">Opacit√©</div>
                    <input type="range" min="0" max="100" value="100" class="opacity-slider" id="opacitySlider" oninput="app.DrawingEditor.setOpacity(this.value)">
                    <div style="text-align: center; font-size: 0.9rem; color: var(--text-sec);" id="opacityValue">100%</div>
                </div>
                <div class="tool-group">
                    <div class="tool-label">Calques</div>
                    <button onclick="app.DrawingEditor.addLayer()" style="width: 100%; padding: 6px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; font-size: 0.85rem;">+ Nouveau</button>
                    <div id="layersList"></div>
                </div>
            </div>
            <div class="drawing-canvas-area">
                <canvas id="drawingCanvas" class="drawing-canvas" width="800" height="600"></canvas>
            </div>
        </div>
    </div>
</div>




<div id="planning-modal" class="planning-modal">
    <div class="planning-modal-content">
        <div class="planning-modal-header">
            <h2 style="margin: 0;" id="planningModalTitle">Jour de Tournage</h2>
            <button onclick="app.Planning.closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main);">‚úñ</button>
        </div>
        <div class="planning-modal-body" id="planningModalBody"></div>
        <div class="planning-modal-footer">
            <button onclick="app.Planning.closeModal()" style="padding: 10px 20px; background: var(--border); color: var(--text-main); border: none; border-radius: 6px; cursor: pointer;">Annuler</button>
            <button onclick="app.Planning.saveShootDay()" style="padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üíæ Sauvegarder</button>
            <button onclick="app.Planning.generateFDS()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üìÑ Feuille de Service</button>
        </div>
    </div>
</div>

<div id="fds-modal" class="planning-modal">
    <div class="planning-modal-content" style="max-width: 800px;">
        <div class="planning-modal-header">
            <h2 style="margin: 0;">Feuille de Service</h2>
            <button onclick="document.getElementById('fds-modal').classList.remove('active')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-main);">‚úñ</button>
        </div>
        <div class="planning-modal-body" id="fdsContent"></div>
        <div class="planning-modal-footer">
            <button onclick="document.getElementById('fds-modal').classList.remove('active')" style="padding: 10px 20px; background: var(--border); color: var(--text-main); border: none; border-radius: 6px; cursor: pointer;">Fermer</button>
            <button onclick="app.Planning.sendFDS()" style="padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üìß Envoyer</button>
            <button onclick="app.Planning.printFDS()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üñ®Ô∏è Imprimer</button>
        </div>
    </div>
</div>

<!-- Modal Feuille de Service Publique -->
<div id="public-callsheet-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:99999; overflow-y:auto;">
    <div style="max-width:800px; margin:0 auto; padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1 style="margin:0; color:var(--primary);">üé¨ Feuille de Service</h1>
            <div style="display:flex; gap:10px;">
                <button onclick="window.print()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">üñ®Ô∏è Imprimer / PDF</button>
                <button onclick="document.getElementById('public-callsheet-modal').style.display='none'; window.history.pushState({}, '', window.location.pathname);" style="padding:10px 20px; background:var(--border); color:var(--text-main); border:none; border-radius:6px; cursor:pointer;">‚úï Fermer</button>
            </div>
        </div>
        <div id="public-callsheet-content" style="background:white; color:#333; padding:30px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1);">
            <p>Chargement...</p>
        </div>
        <div style="text-align:center; margin-top:30px; padding:20px; color:var(--text-sec);">
            <p>Propuls√© par <strong>Moteur</strong> - Gestion de production audiovisuelle</p>
            <a href="https://moteur.film" style="color:var(--primary);">moteur.film</a>
        </div>
    </div>
</div>

<div id="shot-edit-modal" class="shot-edit-modal">
    <div class="shot-edit-container">
        <div class="shot-edit-header">
            <h2 style="margin: 0;" id="shotEditTitle">√âdition du Plan</h2>
            <div style="display: flex; gap: 10px;">
                <button class="shot-edit-save-btn" id="shotEditSaveBtn" onclick="app.Storyboard.saveCurrentShot()">üíæ Sauvegarder</button>
                <button class="shot-edit-close-btn" onclick="app.Storyboard.closeEditModal()">‚úñ Fermer</button>
            </div>
        </div>
        <div class="shot-edit-content" id="shotEditContent"></div>
    </div>
</div>

  <div id="export-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>Exporter / Imprimer</h3>
        <input type="text" id="exp-author" placeholder="Auteur (ex: Jean Dupont)" style="margin-bottom:10px">
        <input type="text" id="exp-phone" placeholder="T√©l√©phone" style="margin-bottom:10px">
        <input type="text" id="exp-web" placeholder="Site Internet" style="margin-bottom:10px">
        <input type="text" id="exp-reg" placeholder="Num√©ro de D√©p√¥t" style="margin-bottom:15px">
        
        <div class="checklist">
            <label><input type="checkbox" id="exp-synop" checked><span>Synopsis</span></label>
            <label><input type="checkbox" id="exp-board" checked><span>S√©quencier</span></label>
            <label><input type="checkbox" id="exp-script" checked><span>Sc√©nario</span></label>
            <label><input type="checkbox" id="exp-chars" checked><span>Personnages</span></label>
            <label><input type="checkbox" id="exp-actors" checked><span>Com√©diens</span></label>
            <label><input type="checkbox" id="exp-locs" checked><span>Lieux</span></label>
            <label><input type="checkbox" id="exp-storyboard"><span>Storyboard</span></label>
            <label><input type="checkbox" id="exp-crew"><span>√âquipes</span></label>
            <label><input type="checkbox" id="exp-breakdown"><span>D√©pouillement</span></label>
            <label><input type="checkbox" id="exp-stats"><span>Statistiques</span></label>
        </div>
        <div class="modal-btns">
            <button onclick="document.getElementById('export-modal').style.display='none'" style="background:var(--bg); color:var(--text-main); border:1px solid var(--border); padding:8px 15px; border-radius:4px; cursor:pointer">Annuler</button>
            <button onclick="app.Actions.confirmExport()" style="background:var(--primary); color:#fff; border:none; padding:8px 15px; border-radius:4px; cursor:pointer">Confirmer</button>
        </div>
    </div>
  </div>

  <div id="share-modal" class="modal-overlay">
    <div class="modal-box" style="max-width:450px">
        <h3>üì§ Partager ce projet</h3>
        <input type="email" id="share-email" placeholder="Email (ex: ami@gmail.com)" style="margin-bottom:10px" oninput="app.Invitations.checkEmail(this.value)">
        <div id="share-email-status" style="font-size:0.85rem; margin-bottom:10px; padding:8px; border-radius:4px; display:none;"></div>
        <select id="share-role" style="width:100%; padding:8px; margin-bottom:15px; border-radius:4px; border:1px solid var(--border); background:var(--input-bg); color:var(--text-main)">
            <option value="viewer">üëÅÔ∏è Lecture Seule</option>
            <option value="editor">‚úèÔ∏è √âditeur (peut modifier)</option>
        </select>
        <div id="share-message-section" style="display:none; margin-bottom:15px;">
            <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:5px;">Message personnalis√© (optionnel) :</label>
            <textarea id="share-message" placeholder="Ex: Salut ! Je t'invite √† collaborer sur mon projet..." style="width:100%; height:60px; padding:8px; border:1px solid var(--border); border-radius:4px; background:var(--input-bg); color:var(--text-main); resize:none;"></textarea>
        </div>
        <div class="modal-btns">
            <button onclick="document.getElementById('share-modal').style.display='none'" style="background:var(--bg); color:var(--text-main); border:1px solid var(--border); padding:8px 15px; border-radius:4px; cursor:pointer">Annuler</button>
            <button id="share-confirm-btn" onclick="app.Invitations.sendInvitation()" style="background:var(--primary); color:#fff; border:none; padding:8px 15px; border-radius:4px; cursor:pointer">üìß Inviter</button>
        </div>
    </div>
  </div>

  <div id="visual-wizard" class="wizard-overlay">
    <div class="wizard-header">
        <div id="wiz-step-title" class="wizard-instruction">Assistant d'Importation</div>
        <div id="wiz-step-desc" class="wizard-sub-text">Suivez les instructions pour calibrer l'import.</div>
        
        <div id="wiz-scene-breakdown" class="wiz-detail-box">
             <p style="margin:0 0 10px 0; font-size:0.85rem;">Surlignez les √©l√©ments demand√©s dans le texte ci-dessous :</p>
             <div id="wiz-bd-sample" style="font-size:1.1rem; padding:10px; background:white; border:1px solid #ccc; margin-bottom:10px; cursor:text;"></div>
             <div class="wiz-detail-row"><span>Pr√©fixe (INT/EXT) :</span> <span id="wiz-val-pre" class="wiz-detail-val">-</span></div>
             <div class="wiz-detail-row"><span>D√©cor :</span> <span id="wiz-val-loc" class="wiz-detail-val">-</span></div>
             <div class="wiz-detail-row"><span>Suffixe (JOUR/NUIT) :</span> <span id="wiz-val-suff" class="wiz-detail-val">-</span></div>
             <button id="btn-valid-breakdown" style="width:100%; margin-top:5px; padding:5px; background:var(--success); color:white; border:none; cursor:pointer; display:none;">Valider ce d√©coupage</button>
        </div>
    </div>

    <div id="wizard-page-view" class="wizard-page-container">
        </div>
    
    <div id="cleanup-toast">üóëÔ∏è Supprimer les occurrences s√©lectionn√©es ?</div>

    <div class="wizard-footer">
        <button onclick="app.Importer.cancel()" style="background:transparent; border:none; color:var(--danger); cursor:pointer">Annuler</button>
        <button id="wiz-skip-btn" onclick="app.Importer.nextStep(true)" style="background:var(--border); border:none; padding:8px 15px; border-radius:4px; cursor:pointer">Sauter cette √©tape</button>
    </div>
  </div>

  <div id="version-modal" class="modal-overlay">
    <div class="modal-box" style="width:500px">
        <h3>üìú Historique des sauvegardes</h3>
        <p style="color:var(--text-sec); font-size:0.85rem; margin-bottom:15px;">Les sauvegardes sont cr√©√©es automatiquement. Vous pouvez restaurer une version pr√©c√©dente si n√©cessaire.</p>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <label style="font-size:0.8rem; font-weight:bold; color:var(--text-sec)">SAUVEGARDES R√âCENTES</label>
            <button onclick="app.Actions.createManualSnapshot()" style="background:var(--primary); color:#fff; border:none; padding:6px 12px; border-radius:4px; font-size:0.8rem; cursor:pointer;">üíæ Sauvegarder maintenant</button>
        </div>
        <div id="version-list" class="ver-list" style="max-height:400px; overflow-y:auto;">
            <div style="padding:20px; text-align:center; color:var(--text-sec)">Aucune sauvegarde.</div>
        </div>

        <div class="modal-btns">
            <button onclick="document.getElementById('version-modal').style.display='none'" style="background:var(--bg); color:var(--text-main); border:1px solid var(--border); padding:8px 15px; border-radius:4px; cursor:pointer">Fermer</button>
        </div>
    </div>
  </div>
  
  <script>
const app = (function(){

  // --- CONFIGURATION FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyCwa_kBWWv5DMcNgVjYFsoRHeAUb1MdpY4",
    authDomain: "moteur-3c6fa.firebaseapp.com",
    databaseURL: "https://moteur-3c6fa-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "moteur-3c6fa",
    storageBucket: "moteur-3c6fa.firebasestorage.app",
    messagingSenderId: "703232951545",
    appId: "1:703232951545:web:8f9c4e5579d63d2d460e28"
  };
  
  function initFirebase() {
      if (typeof firebase !== 'undefined') {
          firebase.initializeApp(firebaseConfig);
          console.log("Firebase initialis√© avec succ√®s");
      } else {
          console.log("Attente de Firebase...");
          setTimeout(initFirebase, 100);
      }
  }
  initFirebase();
  
const CONFIG = { 
    themeKey: 'fmp_theme_pref',
    // EmailJS Configuration - √Ä CONFIGURER avec ton compte emailjs.com
    emailJS: {
        publicKey: 'EyiCAN9DrTUYEiEfu',      // Remplacer apr√®s cr√©ation compte
        serviceId: 'service_4cnbskn',       // Remplacer apr√®s cr√©ation compte  
        templateId: 'template_jmkggb7'      // Remplacer apr√®s cr√©ation compte
    },
    // Types de journ√©es de travail
    dayTypes: {
        'tournage': { label: 'üé¨ Tournage', color: '#4CAF50', bgColor: '#E8F5E9' },
        'repetition': { label: 'üé≠ R√©p√©tition', color: '#2196F3', bgColor: '#E3F2FD' },
        'reperage': { label: 'üìç Rep√©rage', color: '#FF9800', bgColor: '#FFF3E0' },
        'essai_costume': { label: 'üëó Essai costume', color: '#9C27B0', bgColor: '#F3E5F5' },
        'formation': { label: 'üìö Formation', color: '#607D8B', bgColor: '#ECEFF1' },
        'reunion': { label: 'üíº R√©union', color: '#795548', bgColor: '#EFEBE9' }
    },
    	 bdCategories: ["TECHNICIENS", "COMEDIENS", "PERSONNAGES", "DECORS-LIEUX", "FIGURATION", "ACCESSOIRES", "COSTUMES", "MAQUILLAGE-COIFFURE", "VEHICULES", "ANIMAUX", "SON-MUSIQUE", "EFFETS SPECIAUX (SFX)", "EFFETS VISUELS (VFX)", "LUMIERE", "MACHINERIE", "LOGISTIQUE"],
     shotTypes: ["Gros plan (GP)", "Plan moyen (PM)", "Plan am√©ricain (PA)", "Plan large (PL)", "Plan d'ensemble (PE)", "Tr√®s gros plan (TGP)", "Plan rapproch√© (PR)", "Plan italien (PI)"],
    cameraMoves: ["Fixe (FX)", "Travelling avant (TAV)", "Travelling arri√®re (TAR)", "Travelling lat√©ral (TL)", "Panoramique horizontal (PH)", "Panoramique vertical (PV)", "Zoom avant (ZA)", "Zoom arri√®re (ZR)", "Plan-s√©quence (PS)"],
    cameraModes: ["Pied (PD)", "√âpaule (EP)", "Steadicam (STD)", "Drone (DR)", "Dolly (DY)", "Grue (GR)", "Gimbal (GM)", "Cam√©ra port√©e (CP)", "Voiture (VT)", "Rail (RL)"],
    // Mapping groupe technicien ‚Üí cat√©gories d√©pouillement
    crewToBreakdownMap: {
    'gc5': ['ACCESSOIRES', 'DECORS-LIEUX'],      // D√©coration
    'gc6': ['COSTUMES'],                          // Costumes
    'gc7': ['MAQUILLAGE-COIFFURE'],              // Maquillage/Coiffure
    'gc12': ['VEHICULES', 'LOGISTIQUE'],         // Transport/Logistique
    'gc4': ['SON-MUSIQUE'],                       // Son
    'gc2': ['LUMIERE'],                           // Lumi√®re
    'gc9': ['FIGURATION', 'ANIMAUX'],            // R√©gie
    'gc16': ['EFFETS SPECIAUX (SFX)'],           // Cascades/Stunts
    'gc13': ['EFFETS VISUELS (VFX)'],            // Post-production (VFX)
},
crewGroups: [
    {id: 'gc1', name: 'üìπ Image', type: 'crew'},
    {id: 'gc2', name: 'üí° Lumi√®re', type: 'crew'},
    {id: 'gc3', name: 'üé¨ R√©alisation', type: 'crew'},
    {id: 'gc4', name: 'üé§ Son', type: 'crew'},
    {id: 'gc5', name: 'üé® D√©coration', type: 'crew'},
    {id: 'gc6', name: 'üëó Costumes', type: 'crew'},
    {id: 'gc7', name: 'üíÑ Maquillage/Coiffure', type: 'crew'},
    {id: 'gc8', name: 'üìù Script/Continuit√©', type: 'crew'},
    {id: 'gc9', name: 'üé≠ R√©gie', type: 'crew'},
    {id: 'gc10', name: 'üíº Production', type: 'crew'},
    {id: 'gc11', name: 'üç¥ Catering', type: 'crew'},
    {id: 'gc12', name: 'üöó Transport/Logistique', type: 'crew'},
    {id: 'gc13', name: 'üéûÔ∏è Post-production', type: 'crew'},
    {id: 'gc14', name: '‚úçÔ∏è Sc√©nario/√âcriture', type: 'crew'},
    {id: 'gc15', name: 'üéµ Musique', type: 'crew'},
    {id: 'gc16', name: 'ü¶∫ Cascades/Stunts', type: 'crew'},
    {id: 'gc17', name: '‚ûï Autre', type: 'crew'}
],
// Types d'associations
associationTypes: [
    {id: 'asso_video', name: 'üé¨ Vid√©o / Cin√©ma'},
    {id: 'asso_comediens', name: 'üé≠ Com√©diens / Acteurs'},
    {id: 'asso_realisateurs', name: 'üé• R√©alisateurs'},
    {id: 'asso_techniciens', name: 'üîß Techniciens'},
    {id: 'asso_scenaristes', name: '‚úçÔ∏è Sc√©naristes / Auteurs'},
    {id: 'asso_producteurs', name: 'üíº Producteurs'},
    {id: 'asso_figurants', name: 'üë• Figurants'},
    {id: 'asso_court_metrage', name: 'üéûÔ∏è Court-m√©trage'},
    {id: 'asso_documentaire', name: 'üìπ Documentaire'},
    {id: 'asso_animation', name: 'üé® Animation'},
    {id: 'asso_musique', name: 'üéµ Musique / Clip'},
    {id: 'asso_theatre', name: 'üé™ Th√©√¢tre'},
    {id: 'asso_formation', name: 'üìö Formation'},
    {id: 'asso_autre', name: '‚ûï Autre'}
],
// Types d'entreprises
enterpriseTypes: [
    {id: 'ent_production', name: 'üé¨ Production'},
    {id: 'ent_postprod', name: 'üéûÔ∏è Post-production'},
    {id: 'ent_montage', name: '‚úÇÔ∏è Montage'},
    {id: 'ent_vfx', name: '‚ú® Effets sp√©ciaux / VFX'},
    {id: 'ent_doublage', name: 'üéôÔ∏è Doublage / Voix-off'},
    {id: 'ent_son', name: 'üîä Son / Mixage'},
    {id: 'ent_musique', name: 'üéµ Musique / Composition'},
    {id: 'ent_location', name: 'üì¶ Location de mat√©riel'},
    {id: 'ent_vente', name: 'üõí Vente de mat√©riel'},
    {id: 'ent_studio', name: 'üè¢ Studio / Plateau'},
    {id: 'ent_casting', name: 'üé≠ Casting'},
    {id: 'ent_distribution', name: 'üìΩÔ∏è Distribution'},
    {id: 'ent_technique', name: 'üîß Services techniques'},
    {id: 'ent_formation', name: 'üìö Formation'},
    {id: 'ent_autre', name: '‚ûï Autre'}
],
crewRoles: {
    'gc1': ['Directeur¬∑rice de la photographie', 'Cadreur¬∑euse', 'Assistant¬∑e cam√©ra', '1er¬∑√®re assistant¬∑e op√©rateur¬∑rice', '2√®me assistant¬∑e op√©rateur¬∑rice', 'Chef¬∑fe √©lectro', 'Steadicamer', 'Pilote drone', 'DIT', 'Photographe plateau', 'Autre'],
    'gc2': ['Chef¬∑fe √©lectricien¬∑ne', '√âlectricien¬∑ne', 'Groupiste', 'Best Boy/Girl', 'Pupitreur¬∑euse', 'Autre'],
    'gc3': ['R√©alisateur¬∑rice', 'R√©alisateur¬∑rice 2√®me √©quipe', '1er¬∑√®re assistant¬∑e r√©alisateur¬∑rice', '2√®me assistant¬∑e r√©alisateur¬∑rice', '3√®me assistant¬∑e r√©alisateur¬∑rice', 'Directeur¬∑rice de casting', 'Coach acting', 'Autre'],
    'gc4': ['Chef¬∑fe op√©rateur¬∑rice son', 'Perchiste', 'Assistant¬∑e son', 'Sound designer', 'Ing√©nieur¬∑e du son', 'Autre'],
    'gc5': ['Chef¬∑fe d√©corateur¬∑rice', 'Ensemblier¬∑√®re', 'Accessoiriste', 'Constructeur¬∑rice', 'Peintre', 'Tapissier¬∑√®re', 'Staffeur¬∑euse', 'R√©gisseur¬∑euse d\'ext√©rieurs', 'Autre'],
    'gc6': ['Chef¬∑fe costumier¬∑√®re', 'Costumier¬∑√®re', 'Habilleur¬∑euse', 'Couturier¬∑√®re', 'Autre'],
    'gc7': ['Chef¬∑fe maquilleur¬∑euse', 'Maquilleur¬∑euse', 'Chef¬∑fe coiffeur¬∑euse', 'Coiffeur¬∑euse', 'Proth√©siste', 'SFX Makeup', 'Autre'],
    'gc8': ['Scripte', 'Assistant¬∑e scripte', 'Autre'],
    'gc9': ['R√©gisseur¬∑euse g√©n√©ral¬∑e', 'R√©gisseur¬∑euse adjoint¬∑e', 'Assistant¬∑e r√©gisseur¬∑euse', 'R√©gisseur¬∑euse d\'ext√©rieurs', 'Runner', 'Stagiaire r√©gie', 'Autre'],
    'gc10': ['Producteur¬∑rice', 'Producteur¬∑rice ex√©cutif¬∑ve', 'Directeur¬∑rice de production', 'Administrateur¬∑rice de production', 'Comptable', 'Assistant¬∑e de production', 'Coordinateur¬∑rice', 'Charg√©¬∑e de figuration', 'Autre'],
    'gc11': ['Chef¬∑fe cuisinier¬∑√®re', 'Cuisinier¬∑√®re', 'Serveur¬∑euse', 'Responsable craft', 'Autre'],
    'gc12': ['Chef¬∑fe transport', 'Chauffeur¬∑euse', 'Chauffeur¬∑euse camion', 'Responsable logistique', 'Autre'],
    'gc13': ['Monteur¬∑euse', 'Assistant¬∑e monteur¬∑euse', '√âtalonneur¬∑euse', 'Mixeur¬∑euse', 'Sound designer', 'Compositeur¬∑rice', 'Superviseur¬∑euse VFX', 'Graphiste VFX', 'Conformateur¬∑rice', 'Infographiste', 'Autre'],
    'gc14': ['Sc√©nariste', 'Co-sc√©nariste', 'Dialoguiste', 'Script doctor', 'Adaptateur¬∑rice', 'Consultant¬∑e sc√©nario', 'Story-boarder', 'Autre'],
    'gc15': ['Compositeur¬∑rice', 'Directeur¬∑rice musical¬∑e', 'Superviseur¬∑euse musical¬∑e', 'Arrangeur¬∑euse', 'Musicien¬∑ne', 'Autre'],
    'gc16': ['Coordinateur¬∑rice cascades', 'Cascadeur¬∑euse', 'Doublure cascade', 'Ma√Ætre¬∑sse d\'armes', 'Pyrotechnicien¬∑ne', 'Autre'],
    'gc17': ['Autre']
},
    
    // Permissions par d√©faut selon le r√¥le
    // Niveaux: 'none' = pas d'acc√®s, 'read' = lecture seule, 'write' = modification
    defaultPermissions: {
        // Propri√©taire du projet - acc√®s total
        'owner': {
            synopsis: 'write', scenario: 'write', sequencier: 'write', storyboard: 'write',
            personnages: 'write', lieux: 'write', comediens: 'write', equipe: 'write',
            depouillement: 'write', planning: 'write', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'write'
        },
        // R√©alisateur
        'R√©alisateur¬∑rice': {
            synopsis: 'write', scenario: 'write', sequencier: 'write', storyboard: 'write',
            personnages: 'write', lieux: 'read', comediens: 'read', equipe: 'read',
            depouillement: 'write', planning: 'read', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'write'
        },
        // 1er Assistant R√©alisateur
        '1er¬∑√®re assistant¬∑e r√©alisateur¬∑rice': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'read', lieux: 'read', comediens: 'read', equipe: 'read',
            depouillement: 'write', planning: 'write', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'write'
        },
        // 2√®me Assistant R√©alisateur
        '2√®me assistant¬∑e r√©alisateur¬∑rice': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'read', lieux: 'read', comediens: 'read', equipe: 'read',
            depouillement: 'read', planning: 'write', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'read'
        },
        // Directeur de casting
        'Directeur¬∑rice de casting': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'none',
            personnages: 'write', lieux: 'none', comediens: 'write', equipe: 'none',
            depouillement: 'read', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'none', chat_comediens: 'write'
        },
        // Directeur de la photographie
        'Directeur¬∑rice de la photographie': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'write',
            personnages: 'none', lieux: 'read', comediens: 'none', equipe: 'read',
            depouillement: 'write', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'none'
        },
        // Chefs de poste (par d√©faut)
        'chef_de_poste': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'none', lieux: 'read', comediens: 'none', equipe: 'read',
            depouillement: 'read', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'none'
        },
        // Scripte
        'Scripte': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'read', lieux: 'read', comediens: 'read', equipe: 'none',
            depouillement: 'write', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'read'
        },
        // Producteur
        'Producteur¬∑rice': {
            synopsis: 'read', scenario: 'read', sequencier: 'read', storyboard: 'read',
            personnages: 'read', lieux: 'read', comediens: 'read', equipe: 'write',
            depouillement: 'read', planning: 'write', stats: 'read',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'read', chat_comediens: 'read'
        },
        // R√©gisseur g√©n√©ral
        'R√©gisseur¬∑euse g√©n√©ral¬∑e': {
            synopsis: 'none', scenario: 'none', sequencier: 'read', storyboard: 'none',
            personnages: 'none', lieux: 'write', comediens: 'read', equipe: 'read',
            depouillement: 'read', planning: 'write', stats: 'none',
            chat_general: 'write', chat_chefs: 'write', chat_technique: 'write', chat_comediens: 'read'
        },
        // Technicien standard
        'technicien': {
            synopsis: 'none', scenario: 'none', sequencier: 'none', storyboard: 'none',
            personnages: 'none', lieux: 'none', comediens: 'none', equipe: 'none',
            depouillement: 'none', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'none', chat_technique: 'write', chat_comediens: 'none'
        },
        // Com√©dien
        'comedien': {
            synopsis: 'none', scenario: 'read', sequencier: 'none', storyboard: 'none',
            personnages: 'none', lieux: 'none', comediens: 'none', equipe: 'none',
            depouillement: 'none', planning: 'read', stats: 'none',
            chat_general: 'write', chat_chefs: 'none', chat_technique: 'none', chat_comediens: 'write'
        }
    },
    
    // Liste des sections avec leurs labels
    permissionSections: [
        { id: 'synopsis', label: 'üìù Synopsis' },
        { id: 'scenario', label: 'üìú Sc√©nario' },
        { id: 'sequencier', label: 'üé¨ S√©quencier' },
        { id: 'storyboard', label: 'üé® Storyboard' },
        { id: 'personnages', label: 'üë• Personnages' },
        { id: 'lieux', label: 'üìç Lieux' },
        { id: 'comediens', label: 'üé≠ Com√©diens' },
        { id: 'equipe', label: 'üé• Technicien.nes' },
        { id: 'depouillement', label: 'üìã D√©pouillement' },
        { id: 'planning', label: 'üìÖ Planning' },
        { id: 'stats', label: 'üìä Statistiques' }
    ],
    currencies: ['‚Ç¨', '$', '¬£', 'CHF'],
    
    // Ic√¥nes pour groupes et chats
    icons: [
        // Cin√©ma & Tournage
        'üé¨', 'üé•', 'üìΩÔ∏è', 'üéûÔ∏è', 'üìπ', 'üé¶', 'üé≠', 'üé™', 'üé®', 'üñºÔ∏è',
        'üì∑', 'üì∏', 'üî¶', 'üí°', 'üé§', 'üéß', 'üéµ', 'üé∂', 'üéº', 'üéπ',
        'üé∏', 'ü•Å', 'üé∫', 'üéª', 'ü™ó', 'üì∫', 'üìª', 'üîä', 'üîâ', 'üîà',
        // Personnes & R√¥les
        'üë§', 'üë•', 'üßë', 'üë®', 'üë©', 'üßî', 'üë¥', 'üëµ', 'üë∂', 'üßí',
        'ü¶∏', 'ü¶π', 'üßô', 'üßõ', 'üßü', 'ü§¥', 'üë∏', 'ü§µ', 'üë∞', 'ü•∑',
        'üëÆ', 'üïµÔ∏è', 'üíÇ', 'üë∑', 'üßë‚Äçüé®', 'üßë‚Äçüé§', 'üßë‚Äçüíº', 'üßë‚Äçüîß', 'üßë‚Äçüç≥', 'üßë‚Äç‚öïÔ∏è',
        // Lieux & D√©cors
        'üè†', 'üè°', 'üè¢', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè©', 'üè™',
        'üè´', 'üè¨', 'üè≠', 'üèØ', 'üè∞', '‚õ™', 'üïå', 'üïç', '‚õ©Ô∏è', 'üïã',
        'üåÉ', 'üåÜ', 'üåá', 'üåâ', 'üåå', 'üèôÔ∏è', 'üåÑ', 'üåÖ', 'üèñÔ∏è', 'üèïÔ∏è',
        'üèúÔ∏è', 'üèùÔ∏è', 'üèûÔ∏è', 'üåã', '‚õ∞Ô∏è', 'üèîÔ∏è', 'üóª', 'üå≤', 'üå≥', 'üå¥',
        // Transport & V√©hicules
        'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê',
        'üõª', 'üöö', 'üöõ', 'üöú', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥', '‚úàÔ∏è', 'üöÅ',
        'üõ∏', 'üöÄ', 'üõ∂', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üö¢', 'üöÇ', 'üöÉ', 'üöÑ',
        // Objets & Accessoires
        'üíº', 'üëú', 'üéí', 'üëì', 'üï∂Ô∏è', 'ü•Ω', 'üëí', 'üé©', 'üß¢', '‚õëÔ∏è',
        'üíÑ', 'üíç', 'üíé', 'üëë', '‚åö', 'üì±', 'üíª', 'üñ•Ô∏è', 'üñ®Ô∏è', '‚å®Ô∏è',
        'üñ±Ô∏è', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üîå',
        // Nature & M√©t√©o
        '‚òÄÔ∏è', 'üåô', '‚≠ê', 'üåü', '‚ú®', '‚ö°', 'üî•', 'üíß', 'üåä', '‚ùÑÔ∏è',
        'üåà', '‚òÅÔ∏è', '‚õÖ', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è', 'üí®', 'üå™Ô∏è', 'üå´Ô∏è',
        // Actions & Symboles
        '‚ù§Ô∏è', 'üíî', 'üíï', 'üíñ', 'üíó', 'üíò', 'üíù', 'üíû', 'üíü', '‚ù£Ô∏è',
        '‚öîÔ∏è', 'üõ°Ô∏è', 'üî´', 'üí£', 'üî™', 'üó°Ô∏è', '‚ö∞Ô∏è', 'üèÜ', 'ü•á', 'ü•à',
        'üéØ', 'üé≤', 'üéÆ', 'üïπÔ∏è', 'üé∞', 'üß©', '‚ôüÔ∏è', 'üé≥', 'üé±', 'üîÆ',
        // Nourriture (pour catering)
        'üçΩÔ∏è', 'üç¥', 'ü•Ñ', 'üçï', 'üçî', 'üçü', 'üå≠', 'üçø', 'ü•§', '‚òï'
    ],
    rateTypes: ['Jour', 'Semaine', 'Forfait', 'Heure'],
    availabilityColors: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b', '#8e44ad', '#27ae60'],
	 defaultTags: [ {id: 't1', name: 'Standard', color: 'transparent'} ],
      defaultGroups: [
          {id: 'gp1', name: 'Protagonistes', type: 'perso'},
          {id: 'gp2', name: 'Antagonistes', type: 'perso'},
          {id: 'gp3', name: 'Secondaires', type: 'perso'},
          {id: 'ga1', name: 'Casting Principal', type: 'actor'},
          {id: 'ga2', name: 'R√¥les Secondaires', type: 'actor'},
          {id: 'gl1', name: 'Int√©rieurs', type: 'lieu'},
          {id: 'gl2', name: 'Ext√©rieurs', type: 'lieu'}
      ]
  };

  let state = { 
      data: null, 
      currentUser: null, 
      currentProjectId: null, 
      currentRole: 'viewer', 
      currentEditingId: null, 
      activeBdSceneId: null, 
      scriptAC: { active: false, index: -1, items: [] }, 
      dbListener: null, 
      presenceRef: null, 
      locksListener: null, 
      activeLocks: {}, 
      contextSceneId: null,
      contacts: { actors: [], crew: [] },
      userProfile: null
  };
  
  const els = {
    authView: document.getElementById('auth-view'), dashboardView: document.getElementById('dashboard-view'), appView: document.getElementById('app-view'), projectList: document.getElementById('project-list'), contactsView: document.getElementById('contacts-view'), contactsList: document.getElementById('contacts-list'), publicProfileView: document.getElementById('public-profile-view'),
    loginForm: document.getElementById('login-form'), signupForm: document.getElementById('signup-form'), forgotForm: document.getElementById('forgot-form'),
    loginEmail: document.getElementById('login-email'), loginPass: document.getElementById('login-pass'), signupEmail: document.getElementById('signup-email'), signupPass: document.getElementById('signup-pass'), signupConfirm: document.getElementById('signup-confirm'), forgotEmail: document.getElementById('forgot-email'),
    loginError: document.getElementById('login-error'), loginSuccess: document.getElementById('login-success'), signupError: document.getElementById('signup-error'), forgotError: document.getElementById('forgot-error'), forgotSuccess: document.getElementById('forgot-success'),
    
    title: document.getElementById('projectTitle'), roleBadge: document.getElementById('role-badge'), presenceList: document.getElementById('presence-list'),
    synopsisEditor: document.getElementById('synopsisEditor'),
    shortEditor: document.getElementById('shortEditor'),
    longEditor: document.getElementById('longEditor'),
    
    boardList: document.getElementById('boardList'), boardSynopsis: document.getElementById('boardSynopsisDisplay'), boardShort: document.getElementById('boardShortDisplay'), boardLong: document.getElementById('boardLongDisplay'),
    toggleSynop: document.getElementById('toggleSynop'), toggleShort: document.getElementById('toggleShort'), toggleLong: document.getElementById('toggleLong'), blockSynop: document.getElementById('boardSynopBlock'), blockShort: document.getElementById('boardShortBlock'), blockLong: document.getElementById('boardLongBlock'),
    
    scriptContainer: document.getElementById('scriptContainer'), charContainer: document.getElementById('charContainer'), actorContainer: document.getElementById('actorContainer'), locContainer: document.getElementById('locContainer'),
    bdScriptContent: document.getElementById('bdScriptContent'), bdRightContent: document.getElementById('bdRightContent'), bdCtxMenu: document.getElementById('breakdown-ctx-menu'), tagCtxMenu: document.getElementById('tag-ctx-menu'),
    btnSave: document.getElementById('btnSave'), fileInput: document.getElementById('fileInput'), importInput: document.getElementById('importInput'), 
    inpPre: document.getElementById('inpPre'), inpLoc: document.getElementById('inpLoc'), inpSuff: document.getElementById('inpSuff'), inpPerso: document.getElementById('inpPerso'), inpTime: document.getElementById('inpTime'), inpResume: document.getElementById('inpResume'),
    acList: document.getElementById('autocomplete-list'), scriptACList: document.getElementById('script-ac-list'),
    exportModal: document.getElementById('export-modal'), shareModal: document.getElementById('share-modal'), tagModal: document.getElementById('tag-modal'),
    
    visualWizard: document.getElementById('visual-wizard'),
    wizPageView: document.getElementById('wizard-page-view'),
    wizTitle: document.getElementById('wiz-step-title'),
    wizDesc: document.getElementById('wiz-step-desc'),
    wizSkip: document.getElementById('wiz-skip-btn'),
    wizSceneBox: document.getElementById('wiz-scene-breakdown'),
    cleanupToast: document.getElementById('cleanup-toast'),
    quickNav: document.getElementById('quick-nav'),
    editSceneForm: document.getElementById('edit-scene-form'),
    
    // NOUVEAUX ELEMENTS V62
    versionModal: document.getElementById('version-modal'),
    versionList: document.getElementById('version-list')
  };

  // Module de confirmation/prompt moderne
  const ConfirmModal = {
      // Affiche une modale de confirmation
      show: (options) => {
          return new Promise((resolve) => {
              const { title = 'Confirmation', message = '√ätes-vous s√ªr ?', icon = '‚ùì', confirmText = 'Confirmer', cancelText = 'Annuler', type = 'confirm', inputPlaceholder = '', inputValue = '', dangerous = false } = options;
              
              const overlay = document.createElement('div');
              overlay.className = 'confirm-modal-overlay';
              overlay.onclick = (e) => { if(e.target === overlay) { overlay.remove(); resolve(type === 'prompt' ? null : false); } };
              
              const btnClass = dangerous ? 'danger' : 'confirm';
              const inputHtml = type === 'prompt' ? `<input type="text" class="confirm-modal-input" id="confirm-modal-input" placeholder="${inputPlaceholder}" value="${inputValue}">` : '';
              
              overlay.innerHTML = `
                  <div class="confirm-modal-box">
                      <div class="confirm-modal-icon">${icon}</div>
                      <div class="confirm-modal-title">${title}</div>
                      <div class="confirm-modal-message">${message}</div>
                      ${inputHtml}
                      <div class="confirm-modal-buttons">
                          <button class="confirm-modal-btn cancel" id="confirm-modal-cancel">${cancelText}</button>
                          <button class="confirm-modal-btn ${btnClass}" id="confirm-modal-ok">${confirmText}</button>
                      </div>
                  </div>
              `;
              
              document.body.appendChild(overlay);
              
              const input = overlay.querySelector('#confirm-modal-input');
              const okBtn = overlay.querySelector('#confirm-modal-ok');
              const cancelBtn = overlay.querySelector('#confirm-modal-cancel');
              
              if(input) { input.focus(); input.select(); input.onkeydown = (e) => { if(e.key === 'Enter') okBtn.click(); if(e.key === 'Escape') cancelBtn.click(); }; }
              
              okBtn.onclick = () => { overlay.remove(); resolve(type === 'prompt' ? (input ? input.value : true) : true); };
              cancelBtn.onclick = () => { overlay.remove(); resolve(type === 'prompt' ? null : false); };
              
              // Focus sur le bouton OK si pas d'input
              if(!input) okBtn.focus();
          });
      },
      
      // Raccourci pour confirmation simple
      confirm: (message, title = 'Confirmation', dangerous = false) => {
          return ConfirmModal.show({ title, message, icon: dangerous ? '‚ö†Ô∏è' : '‚ùì', dangerous, confirmText: dangerous ? 'Supprimer' : 'Confirmer' });
      },
      
      // Raccourci pour confirmation de suppression
      confirmDelete: (message, title = 'Supprimer ?') => {
          return ConfirmModal.show({ title, message, icon: 'üóëÔ∏è', dangerous: true, confirmText: 'Supprimer' });
      },
      
      // Raccourci pour prompt
      prompt: (message, title = 'Saisie', placeholder = '', defaultValue = '') => {
          return ConfirmModal.show({ title, message, icon: '‚úèÔ∏è', type: 'prompt', inputPlaceholder: placeholder, inputValue: defaultValue, confirmText: 'OK' });
      },
      
      // Raccourci pour alerte (juste OK)
      alert: (message, title = 'Information', icon = '‚ÑπÔ∏è') => {
          return new Promise((resolve) => {
              const overlay = document.createElement('div');
              overlay.className = 'confirm-modal-overlay';
              overlay.onclick = (e) => { if(e.target === overlay) { overlay.remove(); resolve(); } };
              
              overlay.innerHTML = `
                  <div class="confirm-modal-box">
                      <div class="confirm-modal-icon">${icon}</div>
                      <div class="confirm-modal-title">${title}</div>
                      <div class="confirm-modal-message">${message}</div>
                      <div class="confirm-modal-buttons">
                          <button class="confirm-modal-btn confirm" id="confirm-modal-ok">OK</button>
                      </div>
                  </div>
              `;
              
              document.body.appendChild(overlay);
              const okBtn = overlay.querySelector('#confirm-modal-ok');
              okBtn.onclick = () => { overlay.remove(); resolve(); };
              okBtn.focus();
          });
      }
  };

  // ========== LOADING SCREEN ==========
  // üé¨ SECRET: Triple-clic sur le titre "Moteur" dans le header pour tester le loader !
  const LoadingScreen = {
      messages: [
          "Pr√©paration du plateau...",
          "Le perchman s'est encore perdu...",
          "Chargement des v√©hicules de r√©gie...",
          "Les com√©diens se maquillent...",
          "Le r√©alisateur cherche sa vision...",
          "Caf√© pour l'√©quipe technique ‚òï",
          "On attend le soleil... ‚òÄÔ∏è",
          "Silence, on tourne ! ü§´",
          "V√©rification des raccords costume...",
          "Le chef op' r√®gle les lumi√®res...",
          "Moteur demand√©... üé¨",
          "Le script court apr√®s les feuilles...",
          "C√¢blage en cours... üîå",
          "Le HMC fait des miracles üíÑ",
          "Briefing de l'√©quipe...",
          "Installation du combo vid√©o...",
          "Les figurants arrivent en retard...",
          "On cherche le clap... üé¨",
          "Le directeur photo m√©dite...",
          "Pause syndicale obligatoire ‚è∞",
          "Le stagiaire fait le caf√©...",
          "Rep√©rage des axes cam√©ra...",
          "D√©chargement du camion lumi√®re...",
          "La scripte note tout... üìù",
          "On refait une prise pour la route !",
          "Le steadicamer s'√©chauffe üèÉ",
          "Derniers r√©glages son...",
          "Le producteur compte les heures sup...",
          "Installation de la dolly...",
          "C'est bon pour moi ! üëç",
          "V√©rification de la gate...",
          "On encha√Æne ! ‚è≠Ô∏è",
          "Le 1er assistant g√®re le planning...",
          "Distribution des feuilles de service...",
          "Le machino installe les rails...",
          "Raccord maquillage entre deux prises...",
          "Le r√©gisseur g√®re les repas üçΩÔ∏è",
          "Check de la cam√©ra...",
          "On attend que l'avion passe... ‚úàÔ∏è",
          "Le DA ajuste le d√©cor...",
		      "R√©bellion sur le plateau ! üî•",
    "Le r√©alisateur se cache pour pleurer üò¢",
    "Les techniciens et les acteurs font un poker üÉè",
    "L'acteur principal a encore une id√©e de r√©alisation... üôÑ",
      ],
      interval: null,
      currentIndex: 0,
      
      show: (title = "Chargement du projet...") => {
          const overlay = document.getElementById('loading-overlay');
          const titleEl = overlay.querySelector('.loading-title');
          const progressBar = document.getElementById('loading-progress-bar');
          
          titleEl.textContent = title;
          progressBar.style.width = '10%';
          overlay.classList.add('visible');
          
          // Message initial al√©atoire
          LoadingScreen.currentIndex = Math.floor(Math.random() * LoadingScreen.messages.length);
          LoadingScreen.updateMessage();
          
          // Changer le message toutes les 1.5 secondes
          LoadingScreen.interval = setInterval(() => {
              LoadingScreen.currentIndex = (LoadingScreen.currentIndex + 1) % LoadingScreen.messages.length;
              LoadingScreen.updateMessage();
              // Progression simul√©e
              const current = parseFloat(progressBar.style.width) || 10;
              if(current < 90) {
                  progressBar.style.width = Math.min(current + Math.random() * 15, 90) + '%';
              }
          }, 1500);
      },
      
      updateMessage: () => {
          const msgEl = document.getElementById('loading-message');
          if(msgEl) {
              msgEl.style.animation = 'none';
              msgEl.offsetHeight; // Trigger reflow
              msgEl.style.animation = 'messageFade 0.5s ease';
              msgEl.textContent = LoadingScreen.messages[LoadingScreen.currentIndex];
          }
      },
      
      setProgress: (percent) => {
          const progressBar = document.getElementById('loading-progress-bar');
          if(progressBar) {
              progressBar.style.width = Math.min(percent, 100) + '%';
          }
      },
      
      hide: () => {
          const overlay = document.getElementById('loading-overlay');
          const progressBar = document.getElementById('loading-progress-bar');
          
          // Compl√©ter la barre
          if(progressBar) progressBar.style.width = '100%';
          
          // Arr√™ter les messages
          if(LoadingScreen.interval) {
              clearInterval(LoadingScreen.interval);
              LoadingScreen.interval = null;
          }
          
          // Cacher apr√®s un court d√©lai pour voir la barre √† 100%
          setTimeout(() => {
              overlay.classList.remove('visible');
          }, 300);
      }
  };

  const Utils = {
      sanitizeEmail: (email) => email.replace(/\./g, ','),
      escape: (s) => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'),
      generateUniqueId: () => Date.now() + '_' + Math.random().toString(36).slice(2, 11),
      
      // Notifications Toast
      notifyImpact: (sourceTab, targetTabs, action = 'modifi√©') => {
          const tabNames = { synopsis: 'Synopsis', board: 'S√©quencier', titlepage: 'Page de titre', script: 'Sc√©nario', breakdown: 'D√©pouillement', storyboard: 'Storyboard', chars: 'Personnages', actors: 'Com√©diens', locs: 'D√©cors', planning: 'Planning' };
          const targets = Array.isArray(targetTabs) ? targetTabs : [targetTabs];
          const targetLabels = targets.map(t => tabNames[t] || t).join(', ');
          Utils.toast(`üîó ${targetLabels} mis √† jour`, 'info', 3000);
      },
      toast: (message, type = 'info', duration = 3000) => {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = 'toast ' + type;
          const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
          toast.innerHTML = `
              <span class="toast-icon">${icons[type] || icons.info}</span>
              <span class="toast-message">${message}</span>
              <button class="toast-close" onclick="this.parentElement.remove()">‚úñ</button>
          `;
          container.appendChild(toast);
          setTimeout(() => { if(toast.parentElement) toast.remove(); }, duration);
      },
      
      showIconPicker: (callback) => {
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10002;';
          modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
          
          let iconsHtml = '';
          CONFIG.icons.forEach(icon => {
              iconsHtml += `<div class="icon-picker-item" onclick="event.stopPropagation();" data-icon="${icon}" style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;border-radius:8px;transition:background 0.2s;">${icon}</div>`;
          });
          
          modal.innerHTML = `
              <div style="background:var(--panel-bg);border-radius:12px;padding:20px;max-width:450px;width:90%;max-height:80vh;display:flex;flex-direction:column;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                      <h3 style="margin:0;">üé® Choisir une ic√¥ne</h3>
                      <button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;">‚úñ</button>
                  </div>
                  <div style="flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(8,1fr);gap:8px;padding:10px;">
                      ${iconsHtml}
                  </div>
              </div>
          `;
          
          document.body.appendChild(modal);
          
          // Ajouter les listeners apr√®s insertion
          modal.querySelectorAll('.icon-picker-item').forEach(item => {
              item.onmouseover = () => item.style.background = 'var(--bg)';
              item.onmouseout = () => item.style.background = 'transparent';
              item.onclick = (e) => {
                  e.stopPropagation();
                  const icon = item.dataset.icon;
                  modal.remove();
                  if(callback) callback(icon);
              };
          });
      },
	  getDragAfterElement: (container, y, selector) => { const els = [...container.querySelectorAll(selector + ':not(.dragging)')]; return els.reduce((closest, child)=>{ const box = child.getBoundingClientRect(); const offset=y-box.top-box.height/2; return (offset<0 && offset>closest.offset)?{offset:offset,element:child}:closest; }, {offset:Number.NEGATIVE_INFINITY}).element; },
      debounce: (func, wait) => { let timeout; return function(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; },
      getInitials: (email) => email.substring(0,2).toUpperCase(),
      getColor: (str) => { const colors = ['#f44336', '#E91E63', '#9C27B0', '#3F51B5', '#2196F3', '#009688', '#FF9800', '#795548']; let hash = 0; for(let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash); return colors[Math.abs(hash) % colors.length]; },
      
      setupAutocomplete: (inp) => { 
          let currentFocus = -1; 
          inp.addEventListener("input", function(e) { 
              const val = this.value; Utils.closeAllLists(); 
              if (!val) return false; 
              const terms = val.split(';'); 
              const currentTerm = terms[terms.length - 1].trim().toLowerCase(); 
              if(currentTerm.length < 1) return; 
              currentFocus = -1; els.acList.innerHTML = ''; 
              const matches = state.data.characters.filter(c => c.name.toLowerCase().startsWith(currentTerm)); 
              if(matches.length === 0) return; 
              matches.forEach(match => { 
                  const div = document.createElement("div"); div.className = "autocomplete-item"; 
                  div.innerHTML = "<strong>" + match.name.substring(0, currentTerm.length) + "</strong>" + match.name.substring(currentTerm.length); 
                  div.innerHTML += "<input type='hidden' value='" + match.name + "'>"; 
                  div.addEventListener("click", function(e) { 
                      terms[terms.length - 1] = " " + this.getElementsByTagName("input")[0].value; 
                      inp.value = terms.join(';').trim() + '; '; 
                      Utils.closeAllLists(); inp.focus(); 
                  }); 
                  els.acList.appendChild(div); 
              }); 
          }); 
          inp.addEventListener("keydown", function(e) { 
              let x = els.acList.getElementsByTagName("div"); 
              if (e.key === "ArrowDown") { currentFocus++; addActive(x); } 
              else if (e.key === "ArrowUp") { currentFocus--; addActive(x); } 
              else if (e.key === "Enter") { 
                  if (currentFocus > -1) { e.preventDefault(); if (x) x[currentFocus].click(); } 
                  else { Utils.closeAllLists(); } 
              } 
          }); 
          function addActive(x) { 
              if (!x) return false; removeActive(x); 
              if (currentFocus >= x.length) currentFocus = 0; 
              if (currentFocus < 0) currentFocus = (x.length - 1); 
              x[currentFocus].classList.add("autocomplete-active"); 
          } 
          function removeActive(x) { for (let i = 0; i < x.length; i++) x[i].classList.remove("autocomplete-active"); } 
      },
      closeAllLists: () => { while (els.acList.firstChild) els.acList.removeChild(els.acList.firstChild); },
      setupEnterNav: () => { 
          els.inpPre.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); els.inpLoc.focus(); } }); 
          els.inpLoc.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); els.inpSuff.focus(); } }); 
          els.inpSuff.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); els.inpTime.focus(); } }); 
          els.inpTime.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); els.inpPerso.focus(); } }); 
          els.inpPerso.addEventListener('keydown', e => { if(e.key==='Enter' && els.acList.children.length === 0){ e.preventDefault(); els.inpResume.focus(); } }); 
          els.inpResume.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); Actions.addScene(); } }); 
      },
      estimateTime: (htmlContent) => {
          if(!htmlContent) return "0";
          const tmp = document.createElement("DIV");
          tmp.innerHTML = htmlContent;
          const text = tmp.textContent || tmp.innerText || "";
          const wordCount = text.trim().split(/\s+/).length;
          if(wordCount === 0) return "0";
          const minutes = (wordCount / 250); 
          return minutes < 0.2 ? "0.2" : minutes.toFixed(1);
      }
  };

  // ========== PROFILE RENDERER - Fonction commune pour le rendu des profils ==========
  const ProfileRenderer = {
      // Options pour les selects
      selectOptions: {
          gender: [
              {value: '', label: '-- Sexe --'},
              {value: 'homme', label: 'Homme'},
              {value: 'femme', label: 'Femme'},
              {value: 'non-binaire', label: 'Non-binaire'},
              {value: 'non-precise', label: 'Ne souhaite pas pr√©ciser'}
          ],
          eyeColor: [
              {value: '', label: '-- Yeux --'},
              {value: 'marron', label: 'Marron'},
              {value: 'bleu', label: 'Bleu'},
              {value: 'vert', label: 'Vert'},
              {value: 'gris', label: 'Gris'},
              {value: 'noisette', label: 'Noisette'},
              {value: 'noir', label: 'Noir'}
          ],
          hairColor: [
              {value: '', label: '-- Cheveux (couleur) --'},
              {value: 'noir', label: 'Noir'},
              {value: 'brun', label: 'Brun'},
              {value: 'chatain', label: 'Ch√¢tain'},
              {value: 'blond', label: 'Blond'},
              {value: 'roux', label: 'Roux'},
              {value: 'gris', label: 'Gris'},
              {value: 'blanc', label: 'Blanc'},
              {value: 'chauve', label: 'Chauve'}
          ],
          hairLength: [
              {value: '', label: '-- Cheveux (longueur) --'},
              {value: 'chauve', label: 'Chauve'},
              {value: 'rase', label: 'Ras√©'},
              {value: 'court', label: 'Court'},
              {value: 'mi-long', label: 'Mi-long'},
              {value: 'long', label: 'Long'}
          ],
          corpulence: [
              {value: '', label: '-- Corpulence --'},
              {value: 'mince', label: 'Mince'},
              {value: 'normal', label: 'Normal'},
              {value: 'athletique', label: 'Athl√©tique'},
              {value: 'muscle', label: 'Muscl√©'},
              {value: 'rond', label: 'Rond'},
              {value: 'fort', label: 'Fort / Costaud'}
          ],
          ethnicity: [
              {value: '', label: '-- Origine ethnique --'},
              {value: 'caucasien', label: 'Caucasien'},
              {value: 'africain', label: 'Africain / Afro-descendant'},
              {value: 'asiatique', label: 'Asiatique'},
              {value: 'latino', label: 'Latino / Hispanique'},
              {value: 'maghrebin', label: 'Maghr√©bin'},
              {value: 'moyenorient', label: 'Moyen-Orient'},
              {value: 'indien', label: 'Indien / Sud-asiatique'},
              {value: 'metis', label: 'M√©tis'},
              {value: 'autre', label: 'Autre'}
          ],
          professionalStatus: [
              {value: '', label: '-- Statut --'},
              {value: 'intermittent', label: 'Intermittent¬∑e du spectacle'},
              {value: 'micro-entrepreneur', label: 'Micro-entrepreneur¬∑e'},
              {value: 'amateur', label: 'Amateur¬∑rice (pas de statut)'}
          ]
      },

      // G√©n√®re un select HTML
      renderSelect: (fieldName, currentValue, options, onChange, disabled = false) => {
          const opts = (ProfileRenderer.selectOptions[fieldName] || options || [])
              .map(o => `<option value="${o.value}" ${currentValue === o.value ? 'selected' : ''}>${o.label}</option>`)
              .join('');
          return `<select class="profile-input" onchange="${onChange}" ${disabled ? 'disabled' : ''}>${opts}</select>`;
      },

      // G√©n√®re un input HTML
      renderInput: (type, placeholder, value, onChange, disabled = false, extra = '') => {
          return `<input type="${type}" class="profile-input" placeholder="${placeholder}" value="${value || ''}" onchange="${onChange}" ${disabled ? 'disabled' : ''} ${extra}>`;
      },

      // G√©n√®re un textarea HTML
      renderTextarea: (placeholder, value, onChange, disabled = false, style = '') => {
          return `<textarea class="profile-input" placeholder="${placeholder}" onchange="${onChange}" ${disabled ? 'disabled' : ''} style="${style}">${value || ''}</textarea>`;
      },

      // Section Description Physique (pour com√©diens)
      renderPhysicalSection: (profile, onChange, disabled = false) => {
          const change = (field) => onChange.replace('{field}', field);
          return `
          <div class="profile-section-block" style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
              <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üìè Description physique</strong>
              <div class="profile-row" style="margin-bottom:8px;">
                  ${ProfileRenderer.renderInput('number', 'Taille (cm)', profile.height, change('height'), disabled)}
                  ${ProfileRenderer.renderInput('number', 'Poids (kg)', profile.weight, change('weight'), disabled)}
                  ${ProfileRenderer.renderInput('number', '√Çge', profile.age, change('age'), disabled)}
              </div>
              <div class="profile-row" style="margin-bottom:8px;">
                  ${ProfileRenderer.renderSelect('eyeColor', profile.eyeColor, null, change('eyeColor'), disabled)}
                  ${ProfileRenderer.renderSelect('hairColor', profile.hairColor, null, change('hairColor'), disabled)}
                  ${ProfileRenderer.renderSelect('hairLength', profile.hairLength, null, change('hairLength'), disabled)}
              </div>
              <div class="profile-row" style="margin-bottom:8px;">
                  ${ProfileRenderer.renderSelect('corpulence', profile.corpulence, null, change('corpulence'), disabled)}
                  ${ProfileRenderer.renderSelect('ethnicity', profile.ethnicity, null, change('ethnicity'), disabled)}
              </div>
              <div class="profile-row">
                  ${ProfileRenderer.renderInput('text', 'Sports pratiqu√©s (√©quitation, natation...)', profile.sports, change('sports'), disabled)}
                  ${ProfileRenderer.renderInput('text', 'Langues parl√©es (fran√ßais, anglais...)', profile.languages, change('languages'), disabled)}
              </div>
          </div>`;
      },

      // Section V√©hicule
      renderVehicleSection: (profile, onChange, toggleFn, disabled = false, idPrefix = 'vehicle') => {
          const change = (field) => onChange.replace('{field}', field);
          return `
          <div class="profile-section-block" style="margin-top:15px;">
              <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                  <input type="checkbox" ${profile.hasVehicle ? 'checked' : ''} onchange="${toggleFn}" ${disabled ? 'disabled' : ''}>
                  <strong>üöó Poss√®de un v√©hicule</strong>
              </label>
              <div id="${idPrefix}-details" style="display:${profile.hasVehicle ? 'block' : 'none'}; margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                  <div class="profile-row" style="margin-bottom:10px;">
                      ${ProfileRenderer.renderInput('text', 'Type de v√©hicule', profile.vehicleType, change('vehicleType'), disabled)}
                      ${ProfileRenderer.renderInput('text', 'Immatriculation', profile.vehiclePlate, change('vehiclePlate'), disabled)}
                  </div>
                  <div class="profile-row" style="margin-bottom:10px;">
                      ${ProfileRenderer.renderInput('number', 'Nb places dispo', profile.vehicleSeats, change('vehicleSeats'), disabled, 'min="1" max="9"')}
                      <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px; background:var(--panel-bg); border-radius:6px;">
                          <input type="checkbox" ${profile.vehicleTrunk ? 'checked' : ''} onchange="${change('vehicleTrunk')}" ${disabled ? 'disabled' : ''}>
                          <span>üì¶ Coffre disponible</span>
                      </label>
                  </div>
                  ${ProfileRenderer.renderTextarea('Notes v√©hicule (climatisation, GPS, attelage...)', profile.vehicleNotes, change('vehicleNotes'), disabled, 'min-height:60px;')}
              </div>
          </div>`;
      },

      // Section Tarif & Collaboration
      renderRateSection: (profile, onChange, disabled = false) => {
          const change = (field) => onChange.replace('{field}', field);
          const currencies = (CONFIG.currencies || ['‚Ç¨', '$', '¬£', 'CHF']).map(c => ({value: c, label: c}));
          const rateTypes = (CONFIG.rateTypes || ['Jour', 'Semaine', 'Forfait', 'Heure']).map(t => ({value: t, label: t}));
          
          return `
          <div class="profile-section-block" style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
              <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üí∞ Tarif</strong>
              <div class="profile-row">
                  ${ProfileRenderer.renderInput('number', 'Tarif', profile.dailyRate, change('dailyRate'), disabled)}
                  ${ProfileRenderer.renderSelect('currency', profile.rateCurrency || '‚Ç¨', currencies, change('rateCurrency'), disabled)}
                  ${ProfileRenderer.renderSelect('rateType', profile.rateType || 'Jour', rateTypes, change('rateType'), disabled)}
              </div>
          </div>`;
      },

      // Section Statut Professionnel
      renderProfessionalStatus: (profile, onChange, onStatusChange, disabled = false) => {
          const change = (field) => onChange.replace('{field}', field);
          return `
          <div class="profile-section-block" style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
              <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üìã Statut professionnel</strong>
              <div class="profile-row" style="margin-bottom:10px;">
                  ${ProfileRenderer.renderSelect('professionalStatus', profile.professionalStatus, null, onStatusChange, disabled)}
              </div>
              ${profile.professionalStatus === 'intermittent' ? `
              <div class="profile-row">
                  ${ProfileRenderer.renderInput('text', 'N¬∞ S√©curit√© Sociale', profile.numSecu, change('numSecu'), disabled)}
                  ${ProfileRenderer.renderInput('text', 'N¬∞ Cong√©s Spectacles', profile.numCongesSpectacles, change('numCongesSpectacles'), disabled)}
              </div>` : ''}
              ${profile.professionalStatus === 'micro-entrepreneur' ? `
              <div class="profile-row">
                  ${ProfileRenderer.renderInput('text', 'N¬∞ SIRET', profile.siret, change('siret'), disabled)}
              </div>` : ''}
          </div>`;
      },

      // Section Type de Collaboration (Pro/Semi-pro/B√©n√©vole)
      renderCollabType: (profile, onSelect, disabled = false) => {
          const collabDesc = {
              'pro': 'üíº Contrat classique, horaires et tarifs standards',
              'semi-pro': 'ü§ù Flexible sur les conditions mais r√©mun√©r√©¬∑e',
              'benevole': 'üéÅ Pas de r√©mun√©ration, d√©fraiement repas + transport'
          };
          return `
          <div class="profile-section-block" style="margin-top:15px;">
              <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">ü§ù Type de collaboration</strong>
              <div class="collab-type-selector">
                  <div class="collab-type-btn pro ${profile.collabType === 'pro' ? 'selected' : ''}" onclick="${onSelect.replace('{type}', 'pro')}" ${disabled ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                      üé¨ Pro
                  </div>
                  <div class="collab-type-btn semi-pro ${profile.collabType === 'semi-pro' ? 'selected' : ''}" onclick="${onSelect.replace('{type}', 'semi-pro')}" ${disabled ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                      ‚ö° Semi-pro
                  </div>
                  <div class="collab-type-btn benevole ${profile.collabType === 'benevole' ? 'selected' : ''}" onclick="${onSelect.replace('{type}', 'benevole')}" ${disabled ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                      ‚ù§Ô∏è B√©n√©vole
                  </div>
              </div>
              <p style="font-size:0.75rem; color:var(--text-sec); margin-top:8px; margin-bottom:0;">
                  ${collabDesc[profile.collabType] || 'S√©lectionnez votre type de collaboration pr√©f√©r√©'}
              </p>
          </div>`;
      },

      // Section Bande D√©mo
      renderDemoReel: (profile, onChange, disabled = false, idPrefix = 'demoreel') => {
          return `
          <div class="profile-section-block" style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
              <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üé¨ Bande D√©mo</strong>
              <input type="url" class="profile-input" placeholder="https://www.youtube.com/watch?v=... ou https://vimeo.com/..." value="${profile.demoreel || ''}" onchange="${onChange}" ${disabled ? 'disabled' : ''}>
              ${profile.demoreel ? `<div style="margin-top:10px;"><iframe src="${ProfileRenderer.getEmbedUrl(profile.demoreel)}" width="100%" height="200" frameborder="0" allowfullscreen style="border-radius:8px;"></iframe></div>` : ''}
          </div>`;
      },

      // Convertit URL YouTube/Vimeo en URL embed
      getEmbedUrl: (url) => {
          if(!url) return '';
          // YouTube
          const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
          if(ytMatch) return `https://www.youtube.com/embed/${ytMatch[1]}`;
          // Vimeo
          const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
          if(vimeoMatch) return `https://player.vimeo.com/video/${vimeoMatch[1]}`;
          return url;
      }
  };

  // ========== SESSION MANAGER ==========
  // G√®re la session unique par compte (multi-onglets OK, multi-ordinateurs bloqu√©)
  const SessionManager = {
      sessionToken: null,
      tabId: null,
      channel: null,
      heartbeatInterval: null,
      isLeaderTab: false,
      
      init: () => {
          // G√©n√©rer un ID unique pour cet onglet
          SessionManager.tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
          
          // Initialiser BroadcastChannel pour la communication entre onglets
          if(typeof BroadcastChannel !== 'undefined') {
              SessionManager.channel = new BroadcastChannel('moteur_session');
              SessionManager.channel.onmessage = SessionManager.handleChannelMessage;
          }
          
          // √âlection du leader (premier onglet ouvert)
          SessionManager.electLeader();
      },
      
      // Communication entre onglets du m√™me navigateur
      handleChannelMessage: (event) => {
          const { type, tabId, data } = event.data;
          
          switch(type) {
              case 'NEW_TAB':
                  // Un nouvel onglet s'annonce, lui envoyer l'√©tat actuel
                  if(SessionManager.isLeaderTab) {
                      SessionManager.broadcast('SYNC_STATE', { 
                          projectId: state.currentProjectId,
                          projectData: state.data 
                      });
                  }
                  break;
                  
              case 'SYNC_STATE':
                  // Recevoir l'√©tat synchronis√©
                  if(data.projectId === state.currentProjectId && data.projectData) {
                      state.data = data.projectData;
                      if(typeof UI !== 'undefined' && UI.renderAll) {
                          UI.renderAll();
                      }
                  }
                  break;
                  
              case 'DATA_UPDATED':
                  // Un autre onglet a modifi√© les donn√©es
                  if(data.projectId === state.currentProjectId) {
                      Store.loadFromFirebase(state.currentProjectId);
                  }
                  break;
                  
              case 'LEADER_CHECK':
                  // R√©pondre pour confirmer qu'on est actif
                  if(SessionManager.isLeaderTab) {
                      SessionManager.broadcast('LEADER_ALIVE', {});
                  }
                  break;
                  
              case 'LOGOUT':
                  // D√©connexion depuis un autre onglet
                  firebase.auth().signOut().then(() => location.reload());
                  break;
          }
      },
      
      broadcast: (type, data) => {
          if(SessionManager.channel) {
              SessionManager.channel.postMessage({
                  type: type,
                  tabId: SessionManager.tabId,
                  data: data
              });
          }
      },
      
      electLeader: () => {
          // Le premier onglet devient leader
          const leaderKey = 'moteur_leader_tab';
          const existingLeader = localStorage.getItem(leaderKey);
          
          if(!existingLeader) {
              localStorage.setItem(leaderKey, SessionManager.tabId);
              SessionManager.isLeaderTab = true;
          }
          
          // V√©rifier p√©riodiquement si le leader est toujours actif
          setInterval(() => {
              const currentLeader = localStorage.getItem(leaderKey);
              if(currentLeader === SessionManager.tabId) {
                  // Mettre √† jour le timestamp
                  localStorage.setItem('moteur_leader_timestamp', Date.now().toString());
              } else {
                  // V√©rifier si le leader est mort (pas de mise √† jour depuis 5s)
                  const lastTimestamp = parseInt(localStorage.getItem('moteur_leader_timestamp') || '0');
                  if(Date.now() - lastTimestamp > 5000) {
                      // Prendre le leadership
                      localStorage.setItem(leaderKey, SessionManager.tabId);
                      SessionManager.isLeaderTab = true;
                  }
              }
          }, 2000);
          
          // Nettoyer √† la fermeture
          window.addEventListener('beforeunload', () => {
              if(SessionManager.isLeaderTab) {
                  localStorage.removeItem(leaderKey);
                  localStorage.removeItem('moteur_leader_timestamp');
              }
          });
      },
      
      // V√©rifier la session sur Firebase (multi-ordinateurs)
      startSessionCheck: async (userId) => {
          const sessionRef = firebase.database().ref(`user_sessions/${userId}`);
          
          // G√©n√©rer un token de session unique pour cet ordinateur/navigateur
          let browserToken = localStorage.getItem('moteur_browser_token');
          if(!browserToken) {
              browserToken = 'browser_' + Date.now() + '_' + Math.random().toString(36).slice(2, 15);
              localStorage.setItem('moteur_browser_token', browserToken);
          }
          SessionManager.sessionToken = browserToken;
          
          // V√©rifier s'il y a d√©j√† une session active
          const snapshot = await sessionRef.once('value');
          const existingSession = snapshot.val();
          
          if(existingSession && existingSession.token !== browserToken) {
              // Une autre session existe, v√©rifier si elle est encore active
              const lastHeartbeat = existingSession.lastHeartbeat || 0;
              const isStale = Date.now() - lastHeartbeat > 60000; // 1 minute sans heartbeat = session morte
              
              if(!isStale) {
                  // Session active sur un autre appareil
                  const takeOver = await ConfirmModal.show({
                      title: '‚ö†Ô∏è Session active ailleurs',
                      message: `Votre compte est d√©j√† connect√© sur un autre appareil.\n\nDerni√®re activit√© : ${new Date(lastHeartbeat).toLocaleString()}\n\nVoulez-vous prendre le contr√¥le ici et d√©connecter l'autre session ?`,
                      icon: 'üîê',
                      confirmText: 'Prendre le contr√¥le',
                      cancelText: 'Annuler',
                      dangerous: true
                  });
                  
                  if(!takeOver) {
                      // L'utilisateur refuse, le d√©connecter
                      firebase.auth().signOut();
                      return false;
                  }
              }
          }
          
          // Enregistrer cette session
          await sessionRef.set({
              token: browserToken,
              startedAt: Date.now(),
              lastHeartbeat: Date.now(),
              userAgent: navigator.userAgent.substring(0, 100)
          });
          
          // Heartbeat pour maintenir la session active
          SessionManager.heartbeatInterval = setInterval(async () => {
              try {
                  await sessionRef.update({ lastHeartbeat: Date.now() });
              } catch(e) {
                  console.warn('Session heartbeat failed:', e);
              }
          }, 30000); // Toutes les 30 secondes
          
          // √âcouter les changements de session (si quelqu'un prend le contr√¥le)
          sessionRef.on('value', (snap) => {
              const session = snap.val();
              if(session && session.token !== browserToken) {
                  // Quelqu'un d'autre a pris le contr√¥le
                  clearInterval(SessionManager.heartbeatInterval);
                  SessionManager.showKickedModal();
              }
          });
          
          // Nettoyer √† la fermeture
          window.addEventListener('beforeunload', () => {
              if(SessionManager.isLeaderTab) {
                  // Seulement le leader nettoie la session Firebase
                  sessionRef.remove();
              }
              clearInterval(SessionManager.heartbeatInterval);
          });
          
          return true;
      },
      
      showKickedModal: () => {
          // Cr√©er une modale bloquante
          const overlay = document.createElement('div');
          overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:99999;display:flex;align-items:center;justify-content:center;';
          overlay.innerHTML = `
              <div style="background:var(--panel-bg, #fff);padding:40px;border-radius:12px;text-align:center;max-width:400px;">
                  <div style="font-size:4rem;margin-bottom:20px;">üîê</div>
                  <h2 style="margin-bottom:15px;color:var(--text-main, #333);">Session termin√©e</h2>
                  <p style="color:var(--text-sec, #666);margin-bottom:25px;">Votre compte s'est connect√© depuis un autre appareil. Cette session a √©t√© d√©connect√©e.</p>
                  <button onclick="location.reload()" style="padding:12px 30px;background:var(--primary, #007bff);color:white;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:bold;">üîÑ Reconnecter</button>
              </div>
          `;
          document.body.appendChild(overlay);
      },
      
      // Notifier les autres onglets d'une modification
      notifyDataUpdate: () => {
          SessionManager.broadcast('DATA_UPDATED', { 
              projectId: state.currentProjectId 
          });
      },
      
      // D√©connexion globale (tous les onglets)
      logoutAll: () => {
          SessionManager.broadcast('LOGOUT', {});
          Auth.logout();
      },
      
      cleanup: () => {
          if(SessionManager.channel) {
              SessionManager.channel.close();
          }
          if(SessionManager.heartbeatInterval) {
              clearInterval(SessionManager.heartbeatInterval);
          }
      }
  };

  const Auth = {
      init: () => { 
          try {
              const theme = localStorage.getItem(CONFIG.themeKey); 
              if(theme === 'dark') document.body.classList.add('dark-mode');
              // Initialiser le design
              const savedDesign = localStorage.getItem('fmp_design');
              if(savedDesign && savedDesign !== 'classic') document.body.classList.add('design-' + savedDesign);
              setTimeout(() => { const sel = document.getElementById('design-selector'); if(sel && savedDesign) sel.value = savedDesign; }, 100);
          } catch(e) { /* Navigation priv√©e - localStorage indisponible */ } 
          // Initialiser le gestionnaire de session
          SessionManager.init();
          
          // üé¨ SECRET: Triple-clic sur l'indicateur sync (‚òÅÔ∏è) pour tester le loader !
          let moteurClicks = 0;
          let moteurClickTimer = null;
          document.addEventListener('click', (e) => {
              const syncIndicator = e.target.closest('#sync-indicator');
              const roleBadge = e.target.closest('#role-badge');
              if(syncIndicator || roleBadge) {
                  moteurClicks++;
                  if(moteurClicks === 3) {
                      moteurClicks = 0;
                      clearTimeout(moteurClickTimer);
                      // Afficher le loader pendant 8 secondes en d√©mo
                      LoadingScreen.show("üé¨ Mode d√©mo loader !");
                      setTimeout(() => LoadingScreen.hide(), 8000);
                      console.log('üé¨ Easter egg: Loader de test activ√© !');
                  } else {
                      clearTimeout(moteurClickTimer);
                      moteurClickTimer = setTimeout(() => { moteurClicks = 0; }, 500);
                  }
              }
          });
          
          firebase.auth().onAuthStateChanged(async (user) => { 
              if (user && user.emailVerified) { 
                  state.currentUser = user; 
                  // V√©rifier la session unique
                  const sessionOk = await SessionManager.startSessionCheck(user.uid);
                  if(sessionOk) {
                      Auth.showDashboard(); 
                  }
              } 
              else { 
                  state.currentUser = null; 
                  SessionManager.cleanup();
                  Auth.showAuth(); 
              } 
          }); 
      },
      showAuth: () => { els.authView.style.display = 'flex'; els.dashboardView.style.display = 'none'; els.appView.style.display = 'none'; },
showDashboard: async () => { 
    els.authView.style.display = 'none'; 
    // Charger le profil utilisateur
    const emailKey = Utils.sanitizeEmail(state.currentUser.email);
    try {
        const profileSnap = await firebase.database().ref('user_profiles/' + emailKey).once('value');
        state.userProfile = profileSnap.val() || { accountType: 'producer' };
    } catch(e) {
        state.userProfile = { accountType: 'producer' };
    }
    // Raccourcis clavier globaux pour le mode Focus
    document.addEventListener('keydown', (e) => {
        // F11 = Toggle Focus Mode
        if(e.key === 'F11') {
            e.preventDefault();
            FocusMode.toggle();
            return;
        }
        
        // En mode Focus uniquement
        if(FocusMode.isActive) {
            if(e.key === 'Escape') {
                FocusMode.exit();
            } else if(e.key === 'ArrowLeft' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                // Ne pas interf√©rer si on est dans un input/textarea
                if(!['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) && !document.activeElement.isContentEditable) {
                    e.preventDefault();
                    FocusMode.prevTab();
                }
            } else if(e.key === 'ArrowRight' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                if(!['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) && !document.activeElement.isContentEditable) {
                    e.preventDefault();
                    FocusMode.nextTab();
                }
            }
        }
    });

    // V84: V√©rifier les invitations en attente
    Invitations.checkPendingInvitations();
    // V1.4.2: Initialiser les notifications
    Notifications.init();
    UI.showDashboard(); 
},
      toggleMode: (mode) => { 
          document.querySelectorAll('.auth-error, .auth-success').forEach(e => e.style.display='none');
          if(mode === 'signup') { els.loginForm.style.display = 'none'; els.signupForm.style.display = 'block'; els.forgotForm.style.display = 'none'; } 
          else if(mode === 'login') { els.loginForm.style.display = 'block'; els.signupForm.style.display = 'none'; els.forgotForm.style.display = 'none'; }
      },
      toggleForgot: () => {
          document.querySelectorAll('.auth-error, .auth-success').forEach(e => e.style.display='none');
          els.loginForm.style.display = 'none'; els.signupForm.style.display = 'none'; els.forgotForm.style.display = 'block';
      },
      login: () => { 
          const email = els.loginEmail.value.trim(); const pass = els.loginPass.value.trim(); 
          if(!email || !pass) return;
          const btn = els.loginForm.querySelector('button[type="submit"]');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner"></span>Connexion...';
          btn.classList.add('btn-loading');
          els.loginError.style.display = 'none';
          firebase.auth().signInWithEmailAndPassword(email, pass).then((userCredential) => {
              const user = userCredential.user;
              if (!user.emailVerified) { firebase.auth().signOut(); els.loginError.innerText = "Veuillez valider votre email avant de vous connecter."; els.loginError.style.display = 'block'; btn.innerHTML = originalText; btn.classList.remove('btn-loading'); }
          }).catch(e => { els.loginError.innerText = e.message; els.loginError.style.display = 'block'; btn.innerHTML = originalText; btn.classList.remove('btn-loading'); }); 
      },
      signup: () => { 
          const email = els.signupEmail.value.trim(); const pass = els.signupPass.value.trim(); const confirm = els.signupConfirm.value.trim(); 
          const accountType = 'new'; // Pas de type par d√©faut, l'utilisateur cr√©era ses profils ensuite
          if(!email || !pass) return; 
          if(pass !== confirm) { els.signupError.innerText = "Mots de passe non identiques"; els.signupError.style.display = 'block'; return; }
          const btn = els.signupForm.querySelector('button[type="submit"]');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="spinner"></span>Cr√©ation...';
          btn.classList.add('btn-loading');
          els.signupError.style.display = 'none';
          firebase.auth().createUserWithEmailAndPassword(email, pass).then((userCredential) => { 
              const emailKey = Utils.sanitizeEmail(email);
              // Sauvegarder le profil utilisateur avec le type de compte
              firebase.database().ref('user_profiles/' + emailKey).set({
                  email: email,
                  accountType: accountType,
                  createdAt: new Date().toISOString(),
                  displayName: '',
                  profileComplete: false
              }).then(() => {
                  userCredential.user.sendEmailVerification().then(() => {
                      btn.innerHTML = originalText; btn.classList.remove('btn-loading');
                      Auth.toggleMode('login'); els.loginSuccess.innerText = "Compte cr√©√© ! Un lien de validation a √©t√© envoy√© √† " + email; els.loginSuccess.style.display = 'block'; firebase.auth().signOut();
                  });
              });
          }).catch(e => { els.signupError.innerText = e.message; els.signupError.style.display = 'block'; btn.innerHTML = originalText; btn.classList.remove('btn-loading'); }); 
      },
      resetPassword: () => {
          const email = els.forgotEmail.value.trim();
          if(!email) { els.forgotError.innerText = "Veuillez entrer votre email."; els.forgotError.style.display = 'block'; return; }
          firebase.auth().sendPasswordResetEmail(email).then(() => { els.forgotSuccess.style.display = 'block'; els.forgotError.style.display = 'none'; }).catch((error) => { els.forgotError.innerText = error.message; els.forgotError.style.display = 'block'; els.forgotSuccess.style.display = 'none'; });
      },
      logout: () => { if(state.presenceRef) state.presenceRef.remove(); firebase.auth().signOut().then(() => location.reload()); }
  };
  
  // ========== PRICING ==========
  // Gestion des plans et limites d'utilisation
  // ========== PRICING - Mod√®le √† l'usage ==========
  const Pricing = {
      // Configuration
      config: {
          trialDurationHours: 48,
          trialGraceDays: 7,
          readOnlyGraceDays: 30
      },
      
      // V√©rifier si l'utilisateur a un abonnement actif
      hasActiveSubscription: () => {
          const sub = state.userProfile?.subscription;
          if(!sub || !sub.active) return false;
          if(sub.expiresAt && new Date(sub.expiresAt) < new Date()) return false;
          return true;
      },
      
      // V√©rifier si l'utilisateur est en p√©riode d'essai
      isInTrial: () => {
          const trial = state.userProfile?.trial;
          if(!trial || !trial.startedAt) return false;
          const trialEnd = new Date(trial.startedAt);
          trialEnd.setHours(trialEnd.getHours() + Pricing.config.trialDurationHours);
          return new Date() < trialEnd;
      },
      
      // V√©rifier si l'essai a √©t√© utilis√©
      hasUsedTrial: () => {
          return state.userProfile?.trial?.used === true;
      },
      
      // Temps restant de l'essai (en ms)
      getTrialTimeRemaining: () => {
          const trial = state.userProfile?.trial;
          if(!trial || !trial.startedAt) return 0;
          const trialEnd = new Date(trial.startedAt);
          trialEnd.setHours(trialEnd.getHours() + Pricing.config.trialDurationHours);
          return Math.max(0, trialEnd - new Date());
      },
      
      // Formater le temps restant
      formatTimeRemaining: (ms) => {
          if(ms <= 0) return 'Expir√©';
          const hours = Math.floor(ms / (1000 * 60 * 60));
          const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
          if(hours > 0) return `${hours}h ${minutes}min`;
          return `${minutes} minutes`;
      },
      
      // Compter les collaborateurs d'un projet
      // Un collaborateur = une fiche acteur OU technicien (pas par email unique)
      countCollaborators: (projectData) => {
          if(!projectData) return 0;
          
          // Compter les fiches acteurs avec un nom
          const actorCount = (projectData.actors || []).filter(a => a.name).length;
          
          // Compter les fiches techniciens avec un nom
          const crewCount = (projectData.crew || []).filter(c => c.name).length;
          
          return actorCount + crewCount;
      },
      
      // Calculer le prix mensuel d'un projet
      // 1-5 collaborateurs = 1‚Ç¨, 6-15 = 2‚Ç¨, puis +1‚Ç¨ par tranche de 10
      calculateProjectPrice: (projectData) => {
          const collaborators = Pricing.countCollaborators(projectData);
          
          let price = 0;
          let detail = '';
          
          if(collaborators === 0) {
              price = 0;
              detail = 'Aucun collaborateur';
          } else if(collaborators <= 5) {
              price = 1;
              detail = '1-5 collaborateurs';
          } else if(collaborators <= 15) {
              price = 2;
              detail = '6-15 collaborateurs';
          } else {
              // 16+ : 2‚Ç¨ de base + 1‚Ç¨ par tranche de 10 au-del√† de 15
              const extra = Math.ceil((collaborators - 15) / 10);
              price = 2 + extra;
              detail = `16+ collaborateurs (+${extra}‚Ç¨)`;
          }
          
          return {
              collaborators: collaborators,
              price: price,
              detail: detail,
              total: price
          };
      },
      
      // Calculer le prix total mensuel (tous les projets)
      calculateTotalMonthlyPrice: async () => {
          const projects = await Store.getProjectsList();
          const ownedProjects = projects.filter(p => p.role === 'owner');
          
          let totalMonthly = 0;
          const details = [];
          
          for(const project of ownedProjects) {
              const dataSnap = await firebase.database().ref('all_projects/' + project.id + '/data').once('value');
              const projectData = dataSnap.val();
              const price = Pricing.calculateProjectPrice(projectData);
              
              totalMonthly += price.total;
              details.push({
                  id: project.id,
                  title: project.title,
                  ...price
              });
          }
          
          return {
              projectCount: ownedProjects.length,
              totalMonthly,
              details
          };
      },
      
      // V√©rifier si l'utilisateur peut cr√©er un projet
      canCreateProject: async () => {
          // Si abonnement actif, OK
          if(Pricing.hasActiveSubscription()) {
              return { allowed: true };
          }
          
          // Si en p√©riode d'essai, v√©rifier qu'il n'a pas d√©j√† un projet
          if(Pricing.isInTrial()) {
              const projects = await Store.getProjectsList();
              const ownedProjects = projects.filter(p => p.role === 'owner');
              if(ownedProjects.length >= 1) {
                  return { 
                      allowed: false, 
                      reason: 'Votre essai est limit√© √† 1 projet. Souscrivez un abonnement pour cr√©er plus de projets.',
                      showSubscribe: true
                  };
              }
              return { allowed: true, isTrial: true };
          }
          
          // Si essai non utilis√©, proposer l'essai
          if(!Pricing.hasUsedTrial()) {
              return { 
                  allowed: false, 
                  reason: 'trial_available',
                  showTrialOffer: true
              };
          }
          
          // Essai expir√©, pas d'abonnement
          return { 
              allowed: false, 
              reason: 'Votre p√©riode d\'essai est termin√©e. Souscrivez un abonnement pour continuer.',
              showSubscribe: true
          };
      },
      
      // D√©marrer l'essai gratuit
      startTrial: async () => {
          if(Pricing.hasUsedTrial()) {
              Utils.toast('Vous avez d√©j√† utilis√© votre essai gratuit', 'error');
              return false;
          }
          
          const emailKey = Utils.sanitizeEmail(state.currentUser.email);
          await firebase.database().ref('user_profiles/' + emailKey + '/trial').set({
              used: true,
              startedAt: new Date().toISOString(),
              projectId: null // Sera rempli √† la cr√©ation du projet
          });
          
          // Recharger le profil
          const profileSnap = await firebase.database().ref('user_profiles/' + emailKey).once('value');
          state.userProfile = profileSnap.val();
          
          Utils.toast('üé¨ Essai gratuit activ√© ! Vous avez 48h pour tester.', 'success');
          return true;
      },
      
      // Afficher la modale d'offre d'essai
      showTrialOfferModal: () => {
          const modal = document.createElement('div');
          modal.id = 'trial-offer-modal';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:16px; padding:30px; max-width:500px; width:100%; text-align:center;">
                  <div style="font-size:4rem; margin-bottom:15px;">üé¨</div>
                  <h2 style="margin:0 0 15px;">Cr√©ez votre premier projet !</h2>
                  <p style="color:var(--text-sec); margin-bottom:25px;">
                      Testez Moteur gratuitement pendant <strong>48 heures</strong> avec toutes les fonctionnalit√©s.
                  </p>
                  <div style="background:var(--bg); border-radius:12px; padding:20px; margin-bottom:25px; text-align:left;">
                      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                          <span style="font-size:1.5rem;">‚úÖ</span>
                          <span>1 projet complet</span>
                      </div>
                      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                          <span style="font-size:1.5rem;">‚úÖ</span>
                          <span>Toutes les fonctionnalit√©s</span>
                      </div>
                      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                          <span style="font-size:1.5rem;">‚úÖ</span>
                          <span>Aucune carte bancaire requise</span>
                      </div>
                      <div style="display:flex; align-items:center; gap:10px;">
                          <span style="font-size:1.5rem;">‚è±Ô∏è</span>
                          <span>48h puis 30 jours en lecture seule</span>
                      </div>
                  </div>
                  <div style="display:flex; gap:10px; justify-content:center;">
                      <button onclick="document.getElementById('trial-offer-modal').remove()" style="padding:12px 25px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:8px; cursor:pointer;">
                          Plus tard
                      </button>
                      <button onclick="app.Pricing.acceptTrialOffer()" style="padding:12px 25px; background:var(--success); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                          üöÄ Commencer l'essai
                      </button>
                  </div>
                  <p style="margin-top:20px; font-size:0.85rem; color:var(--text-sec);">
                      Ensuite : √† partir de <strong>1‚Ç¨/mois</strong> par projet
                  </p>
                  <div style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; text-align:left; font-size:0.8rem; color:var(--text-sec);">
                      <strong>üìã Modalit√©s :</strong><br>
                      ‚Ä¢ 1 essai de 48h par adresse email<br>
                      ‚Ä¢ Apr√®s l'essai : 30 jours en lecture seule<br>
                      ‚Ä¢ Sans abonnement : projet supprim√© apr√®s 30 jours<br>
                      ‚Ä¢ Vos profils publics restent toujours accessibles
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
      },
      
      // Accepter l'offre d'essai et cr√©er le projet
      acceptTrialOffer: async () => {
          document.getElementById('trial-offer-modal')?.remove();
          const started = await Pricing.startTrial();
          if(started) {
              Store.showOwnerRoleModal();
          }
      },
      
      // Afficher la modale d'abonnement
      showSubscribeModal: (reason) => {
          const modal = document.createElement('div');
          modal.id = 'subscribe-modal';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:16px; padding:30px; max-width:600px; width:100%;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                      <h2 style="margin:0;">üí≥ Abonnement Moteur</h2>
                      <button onclick="document.getElementById('subscribe-modal').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">‚úï</button>
                  </div>
                  
                  ${reason ? `<div style="background:#FFF3E0; border:1px solid #FF9800; border-radius:8px; padding:15px; margin-bottom:20px; color:#E65100;">
                      <strong>‚ö†Ô∏è ${reason}</strong>
                  </div>` : ''}
                  
                  <p style="color:var(--text-sec); margin-bottom:25px;">
                      Un tarif simple et transparent, adapt√© √† vos besoins.
                  </p>
                  
                  <div style="background:var(--bg); border-radius:12px; padding:20px; margin-bottom:25px;">
                      <h4 style="margin:0 0 15px;">üí∞ Tarification par projet</h4>
                      <div style="color:var(--text-sec); font-size:0.9rem;">
                          <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);">
                              <span>1-5 collaborateurs</span>
                              <strong>1‚Ç¨/mois</strong>
                          </div>
                          <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border);">
                              <span>6-15 collaborateurs</span>
                              <strong>2‚Ç¨/mois</strong>
                          </div>
                          <div style="display:flex; justify-content:space-between; padding:8px 0;">
                              <span>+10 collaborateurs</span>
                              <strong>+1‚Ç¨/mois</strong>
                          </div>
                      </div>
                      <p style="margin:15px 0 0; font-size:0.8rem; color:var(--text-sec);">
                          üí° 1 collaborateur = 1 fiche com√©dien ou technicien
                      </p>
                  </div>
                  
                  <div style="display:flex; gap:10px; justify-content:center;">
                      <button onclick="app.Pricing.subscribe('monthly')" style="flex:1; padding:15px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1rem;">
                          üí≥ S'abonner
                      </button>
                  </div>
                  
                  <p style="text-align:center; margin-top:15px; font-size:0.8rem; color:var(--text-sec);">
                      üí≥ Paiement s√©curis√© par Stripe ‚Ä¢ Annulation √† tout moment
                  </p>
                  
                  <div style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; font-size:0.8rem; color:var(--text-sec);">
                      <strong>üìã Modalit√©s :</strong><br>
                      ‚Ä¢ R√©siliation possible √† tout moment<br>
                      ‚Ä¢ Sans renouvellement : 30 jours en lecture seule pour t√©l√©charger<br>
                      ‚Ä¢ Projet supprim√© apr√®s 30 jours sans abonnement<br>
                      ‚Ä¢ Vos profils publics restent toujours accessibles
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
      },
      
      // Souscrire (pr√©paration Stripe)
      subscribe: async () => {
          // TODO: Int√©grer Stripe Checkout
          Utils.toast('üöß Paiement Stripe bient√¥t disponible', 'info');
          document.getElementById('subscribe-modal')?.remove();
      },
      
      // Afficher la banni√®re d'essai dans le dashboard
      getTrialBanner: () => {
          if(!Pricing.isInTrial()) return '';
          
          const remaining = Pricing.getTrialTimeRemaining();
          const formattedTime = Pricing.formatTimeRemaining(remaining);
          const isUrgent = remaining < 6 * 60 * 60 * 1000; // < 6h
          
          return `
              <div style="background:${isUrgent ? 'linear-gradient(135deg, #ff6b6b, #ee5a24)' : 'linear-gradient(135deg, #667eea, #764ba2)'}; border-radius:12px; padding:15px 20px; margin-bottom:20px; color:white; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                  <div>
                      <strong>‚è±Ô∏è P√©riode d'essai</strong> - Il vous reste <strong>${formattedTime}</strong>
                  </div>
                  <button onclick="app.Pricing.showSubscribeModal()" style="padding:8px 20px; background:white; color:${isUrgent ? '#ee5a24' : '#667eea'}; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">
                      üí≥ S'abonner maintenant
                  </button>
              </div>
          `;
      },
      
      // Afficher le r√©sum√© de facturation dans le dashboard
      getBillingWidget: async () => {
          if(!Pricing.hasActiveSubscription() && !Pricing.isInTrial()) {
              return `
                  <div style="background:var(--bg); border:2px dashed var(--border); border-radius:12px; padding:20px; text-align:center;">
                      <div style="font-size:2rem; margin-bottom:10px;">üé¨</div>
                      <p style="margin:0 0 15px; color:var(--text-sec);">Cr√©ez des projets √† partir de <strong>1‚Ç¨/mois</strong></p>
                      <button onclick="app.Pricing.showSubscribeModal()" style="padding:10px 25px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">
                          Voir les tarifs
                      </button>
                  </div>
              `;
          }
          
          const billing = await Pricing.calculateTotalMonthlyPrice();
          
          if(billing.projectCount === 0) {
              return '';
          }
          
          return `
              <div style="background:var(--bg); border-radius:12px; padding:20px; margin-bottom:20px;">
                  <h4 style="margin:0 0 15px; display:flex; align-items:center; gap:10px;">
                      üí∞ Votre abonnement
                      <span style="font-size:0.8rem; color:var(--text-sec); font-weight:normal;">(estimation)</span>
                  </h4>
                  <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border);">
                      <span>${billing.projectCount} projet${billing.projectCount > 1 ? 's' : ''}</span>
                      <span>${billing.totalMonthly}‚Ç¨/mois</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; font-weight:bold; font-size:1.1rem;">
                      <span>Total</span>
                      <span style="color:var(--primary);">${billing.totalMonthly}‚Ç¨/mois</span>
                  </div>
                  <button onclick="app.Pricing.showBillingDetails()" style="width:100%; padding:10px; background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border); border-radius:6px; cursor:pointer; font-size:0.9rem;">
                      üìä Voir le d√©tail
                  </button>
              </div>
          `;
      },
      
      // Afficher le d√©tail de facturation
      showBillingDetails: async () => {
          const billing = await Pricing.calculateTotalMonthlyPrice();
          
          let detailsHtml = billing.details.map(p => `
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--bg); border-radius:8px; margin-bottom:8px;">
                  <div>
                      <strong>${Utils.escape(p.title)}</strong>
                      <div style="font-size:0.85rem; color:var(--text-sec);">${p.collaborators} collaborateur${p.collaborators > 1 ? 's' : ''} ‚Ä¢ ${p.detail}</div>
                  </div>
                  <div style="text-align:right; font-weight:bold;">
                      ${p.price}‚Ç¨/mois
                  </div>
              </div>
          `).join('');
          
          const modal = document.createElement('div');
          modal.id = 'billing-details-modal';
          modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:16px; padding:30px; max-width:500px; width:100%; max-height:80vh; overflow-y:auto;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                      <h2 style="margin:0;">üìä D√©tail de facturation</h2>
                      <button onclick="document.getElementById('billing-details-modal').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">‚úï</button>
                  </div>
                  
                  <div style="background:var(--bg); border-radius:8px; padding:15px; margin-bottom:20px; font-size:0.85rem; color:var(--text-sec);">
                      <strong>Tarification :</strong><br>
                      ‚Ä¢ 1-5 collaborateurs = 1‚Ç¨/mois<br>
                      ‚Ä¢ 6-15 collaborateurs = 2‚Ç¨/mois<br>
                      ‚Ä¢ +1‚Ç¨ par tranche de 10 au-del√†
                  </div>
                  
                  <div style="margin-bottom:20px;">
                      ${detailsHtml}
                  </div>
                  
                  <div style="background:var(--primary); color:white; border-radius:12px; padding:20px; text-align:center;">
                      <div style="font-size:0.9rem; opacity:0.9;">Total mensuel</div>
                      <div style="font-size:2.5rem; font-weight:bold;">${billing.totalMonthly}‚Ç¨</div>
                  </div>
                  
                  <p style="text-align:center; margin-top:15px; font-size:0.8rem; color:var(--text-sec);">
                      üí° Un collaborateur = une fiche com√©dien ou technicien dans le projet.
                  </p>
              </div>
          `;
          document.body.appendChild(modal);
      }
  };
  
  const Store = {
      // V62: Initialisation du tableau snapshots
      getEmpty: () => ({ title: "Nouveau Film", filmId: 'film_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11), synopsis: "", synopsisShort: "", synopsisLong: "", scriptMeta: { author: "", coAuthor: "", contact: "", copyright: "", draft: "Premier jet", draftDate: "", source: "", notes: "" }, titlePage: { title: "", author: "", coAuthor: "", contact: "", draft: "Premier jet", draftDate: "", source: "", copyright: "", notes: "" }, snapshots: [], scenes: [], characters: [], actors: [], locations: [], resources: [], crew: [], shootingDays: [], tags: CONFIG.defaultTags, groups: [...CONFIG.defaultGroups, ...CONFIG.crewGroups], shots: [], counter: 1, uiConfig: { tabColors: {}, categoryColors: {}, subColors: {}, tabsOrder: [], categoriesOrder: [], hiddenTabs: [] }, budget: { total: 0, currency: '‚Ç¨', manager: '', managerEmailNotif: true, envelopes: {}, deptManagers: {} }, expenses: [], presentation: { title: '', genre: '', format: '', duration: '', productionType: '', description: '', team: [], associations: [], enterprises: [], needsCrew: {}, needsActors: [], image: '' }, memberPermissions: {}, chatChannels: [], chatExtraMembers: [], workplanOverrides: {}, scriptReports: {} }),
      getProjectsList: async () => { if(!state.currentUser) return []; const myEmailKey = Utils.sanitizeEmail(state.currentUser.email); const indexSnap = await firebase.database().ref('user_projects/' + myEmailKey).once('value'); const indexVal = indexSnap.val(); if(!indexVal) return []; const promises = Object.keys(indexVal).map(async (pid) => { const metaSnap = await firebase.database().ref('all_projects/' + pid + '/meta').once('value'); const meta = metaSnap.val(); return meta ? { id: pid, ...meta, role: indexVal[pid] } : null; }); const results = await Promise.all(promises); return results.filter(r => r !== null); },
      createNewProject: async () => { 
          if(!state.currentUser) return; 
          
          // V√©rifier si l'utilisateur peut cr√©er un projet
          const check = await Pricing.canCreateProject();
          
          if(!check.allowed) {
              if(check.showTrialOffer) {
                  Pricing.showTrialOfferModal();
              } else if(check.showSubscribe) {
                  Pricing.showSubscribeModal(check.reason);
              }
              return;
          }
          
          Store.showOwnerRoleModal(); 
      },
      doCreateProject: (selectedProfiles) => {
          const myEmail = state.currentUser.email;
          const myEmailKey = Utils.sanitizeEmail(myEmail);
          const newRef = firebase.database().ref('all_projects').push();
          const id = newRef.key;
          const empty = Store.getEmpty();
          
          const ownerName = state.userProfile?.displayName || myEmail.split('@')[0];
          const ownerRoles = []; // Pour les badges sur l'avatar
          
          // Ajouter chaque profil s√©lectionn√© dans la bonne section
          selectedProfiles.forEach((profile, idx) => {
              if(profile.type === 'actor') {
                  // Ajouter dans les com√©diens - PROFIL REVENDIQU√â
                  const actorEntry = {
                      id: 'actor_owner_' + Date.now() + '_' + idx,
                      name: profile.data.name || ownerName,
                      email: myEmail,
                      photo: profile.data.photo || '',
                      phone: profile.data.phone || '',
                      gender: profile.data.gender || '',
                      age: profile.data.age || '',
                      height: profile.data.height || '',
                      city: profile.data.city || '',
                      languages: profile.data.languages || '',
                      skills: profile.data.skills || '',
                      experience: profile.data.experience || '',
                      notes: profile.data.notes || '',
                      isOwner: true,
                      // Marquer comme profil revendiqu√© (non modifiable)
                      publicProfileId: profile.data.id || myEmailKey,
                      claimedAt: new Date().toISOString(),
                      claimedBy: myEmail,
                      createdAt: new Date().toISOString()
                  };
                  empty.actors.push(actorEntry);
                  ownerRoles.push({ icon: profile.icon, name: profile.name });
              } else if(profile.type === 'crew') {
                  // Ajouter dans l'√©quipe technique - PROFIL REVENDIQU√â
                  const crewEntry = {
                      id: 'crew_owner_' + Date.now() + '_' + idx,
                      name: profile.data.name || ownerName,
                      email: myEmail,
                      role: profile.data.role || profile.name,
                      photo: profile.data.photo || '',
                      phone: profile.data.phone || '',
                      department: profile.data.department || '',
                      rate: profile.data.rate || '',
                      notes: profile.data.notes || '',
                      isOwner: true,
                      // Marquer comme profil revendiqu√© (non modifiable)
                      publicProfileId: profile.data.id || myEmailKey,
                      claimedAt: new Date().toISOString(),
                      claimedBy: myEmail,
                      createdAt: new Date().toISOString()
                  };
                  empty.crew.push(crewEntry);
                  ownerRoles.push({ icon: profile.icon, name: profile.name });
              }
          });
          
          // Si aucun profil s√©lectionn√©, ajouter quand m√™me le propri√©taire dans crew (NON revendiqu√©, modifiable)
          if(selectedProfiles.length === 0) {
              empty.crew.push({
                  id: 'crew_owner_' + Date.now(),
                  name: ownerName,
                  email: myEmail,
                  role: 'Porteur de projet',
                  phone: state.userProfile?.phone || '',
                  photo: state.userProfile?.photoURL || '',
                  isOwner: true,
                  ownerRoles: [],
                  createdAt: new Date().toISOString()
              });
          } else {
              // Stocker les r√¥les du propri√©taire sur la premi√®re fiche crew (pour les badges avatar)
              const firstCrew = empty.crew.find(c => c.isOwner);
              if(firstCrew) {
                  firstCrew.ownerRoles = ownerRoles;
              }
          }
          
          const payload = { data: empty, meta: { title: empty.title, date: new Date().toLocaleDateString(), owner: myEmail }, acl: { [myEmailKey]: 'owner' }, history: {} };
          const updates = {};
          updates['all_projects/' + id] = payload;
          updates['user_projects/' + myEmailKey + '/' + id] = 'owner';
          firebase.database().ref().update(updates).then(() => { Store.loadProject(id); History.log('ADD', 'Cr√©ation du projet'); });
      },
      showOwnerRoleModal: async () => {
          // R√©cup√©rer les vrais profils du porteur depuis Firebase
          const myEmail = state.currentUser.email;
          const emailKey = Utils.sanitizeEmail(myEmail);
          
          let userProfiles = [];
          try {
              // Charger les profils depuis user_profiles/{emailKey}/profiles
              const profilesSnap = await firebase.database().ref('user_profiles/' + emailKey + '/profiles').once('value');
              const profiles = profilesSnap.val();
              
              // Charger aussi les infos g√©n√©rales du profil
              const userSnap = await firebase.database().ref('user_profiles/' + emailKey).once('value');
              const userData = userSnap.val() || {};
              state.userProfile = userData;
              
              if(profiles && Array.isArray(profiles)) {
                  profiles.forEach(p => {
                      if(p.type === 'actor') {
                          userProfiles.push({
                              type: 'actor',
                              icon: 'üé≠',
                              name: p.name || 'Com√©dien¬∑ne',
                              data: { ...p, email: myEmail }
                          });
                      } else if(p.type === 'crew') {
                          userProfiles.push({
                              type: 'crew',
                              icon: p.icon || 'üé¨',
                              name: p.role || p.name || 'Technicien',
                              data: { ...p, email: myEmail }
                          });
                      }
                  });
              }
          } catch(e) {
              console.log('Erreur chargement profils:', e);
          }
          
          const modal = document.createElement('div');
          modal.id = 'owner-role-modal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
          
          let contentHtml = '';
          if(userProfiles.length === 0) {
              // Pas de profil cr√©√©
              contentHtml = `
                  <p style="color:var(--text-sec); margin-bottom:20px;">Vous n'avez pas encore cr√©√© de profil m√©tier.</p>
                  <p style="color:var(--text-sec); margin-bottom:20px; font-size:0.9rem;">Le projet sera cr√©√© et vous pourrez ajouter vos r√¥les plus tard via "Mon Profil".</p>
              `;
          } else {
              contentHtml = `
                  <p style="color:var(--text-sec); margin-bottom:15px; font-size:0.9rem;">S√©lectionnez le(s) profil(s) que vous utiliserez sur ce projet :</p>
                  <div style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto; padding:5px;">
              `;
              userProfiles.forEach((p, idx) => {
                  contentHtml += `
                      <label style="display:flex; align-items:center; gap:12px; cursor:pointer; padding:12px; border-radius:8px; border:1px solid var(--border); background:var(--bg); transition: all 0.2s;">
                          <input type="checkbox" class="owner-profile-checkbox" data-index="${idx}" style="width:18px; height:18px;">
                          <span style="font-size:1.5rem;">${p.icon}</span>
                          <div>
                              <div style="font-weight:600;">${Utils.escape(p.name)}</div>
                              <div style="font-size:0.8rem; color:var(--text-sec);">${p.type === 'actor' ? 'Fiche com√©dien' : 'Fiche √©quipe technique'}</div>
                          </div>
                      </label>
                  `;
              });
              contentHtml += '</div>';
          }
          
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:450px; max-width:90%;">
                  <h3 style="margin:0 0 15px; color:var(--text-main);">üé¨ Nouveau Projet</h3>
                  <p style="margin-bottom:10px;">Vous serez <strong style="color:var(--primary);">üëë Propri√©taire</strong> de ce projet.</p>
                  
                  ${contentHtml}
                  
                  <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                      <button onclick="document.getElementById('owner-role-modal').remove()" style="padding:10px 20px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Annuler</button>
                      <button onclick="app.Store.confirmOwnerRole()" style="padding:10px 20px; background:var(--success); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">‚úì Cr√©er le projet</button>
                  </div>
              </div>
          `;
          
          document.body.appendChild(modal);
          
          // Stocker les profils pour confirmOwnerRole
          modal.userProfiles = userProfiles;
          
          // Style visuel pour les s√©lectionn√©s
          modal.querySelectorAll('.owner-profile-checkbox').forEach(cb => {
              cb.addEventListener('change', () => {
                  cb.closest('label').style.background = cb.checked ? 'rgba(43, 110, 246, 0.1)' : 'var(--bg)';
                  cb.closest('label').style.borderColor = cb.checked ? 'var(--primary)' : 'var(--border)';
              });
          });
      },
      confirmOwnerRole: () => {
          const modal = document.getElementById('owner-role-modal');
          const userProfiles = modal.userProfiles || [];
          const checked = modal.querySelectorAll('.owner-profile-checkbox:checked');
          
          const selectedProfiles = [];
          checked.forEach(cb => {
              const idx = parseInt(cb.dataset.index);
              if(userProfiles[idx]) {
                  selectedProfiles.push(userProfiles[idx]);
              }
          });
          
          modal.remove();
          Store.doCreateProject(selectedProfiles);
      },
      createNewProjectFromImport: (importedData) => {
          if(!state.currentUser) return;
          const myEmail = state.currentUser.email; const myEmailKey = Utils.sanitizeEmail(myEmail);
          const newRef = firebase.database().ref('all_projects').push(); const id = newRef.key;
          if(!importedData.groups || importedData.groups.length === 0) importedData.groups = CONFIG.defaultGroups;
          if(!importedData.tags || importedData.tags.length === 0) importedData.tags = CONFIG.defaultTags;
          if(!importedData.actors) importedData.actors = [];
          if(!importedData.snapshots) importedData.snapshots = []; // V62 Security
          const payload = { data: importedData, meta: { title: importedData.title, date: new Date().toLocaleDateString(), owner: myEmail }, acl: { [myEmailKey]: 'owner' } };
          const updates = {}; updates['all_projects/' + id] = payload; updates['user_projects/' + myEmailKey + '/' + id] = 'owner'; 
          firebase.database().ref().update(updates).then(() => { Utils.toast("Importation Wizard r√©ussie !", "success"); Store.loadProject(id); }); 
      },
      loadProject: async (id) => {
          if(!state.currentUser) return;
          LoadingScreen.show("Ouverture du projet...");
          try {
              const myEmailKey = Utils.sanitizeEmail(state.currentUser.email);
              const aclSnap = await firebase.database().ref('all_projects/' + id + '/acl/' + myEmailKey).once('value');
              const role = aclSnap.val(); if(!role) throw new Error("Acc√®s refus√©."); state.currentRole = role;
              const dataSnap = await firebase.database().ref('all_projects/' + id + '/data').once('value');
              const parsed = dataSnap.val(); if(!parsed) throw new Error("Projet vide ou introuvable");
              const safeData = { ...Store.getEmpty(), ...parsed };
              
              if(!safeData.actors) safeData.actors = [];
              if(!safeData.snapshots) safeData.snapshots = []; // V62 Security
			  if(!safeData.shots) safeData.shots = [];
			  if(!safeData.crew) safeData.crew = [];
			  if(!safeData.shootingDays) safeData.shootingDays = [];
// Ajouter les groupes crew manquants
CONFIG.crewGroups.forEach(defaultGrp => {
    if(!safeData.groups.some(g => g.id === defaultGrp.id)) {
        safeData.groups.push(defaultGrp);
    }
});
              if(!safeData.groups.some(g => g.type === 'actor')) { safeData.groups.push({id: 'ga1', name: 'Casting Principal', type: 'actor'}); safeData.groups.push({id: 'ga2', name: 'R√¥les Secondaires', type: 'actor'}); }
              if(!safeData.tags || safeData.tags.length === 0) safeData.tags = CONFIG.defaultTags;
              ['scenes', 'characters', 'locations'].forEach(k => { if(!Array.isArray(safeData[k])) safeData[k] = []; });
              
              // G√©n√©rer un filmId si absent (anciens projets)
              if(!safeData.filmId) {
                  safeData.filmId = 'film_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);
                  console.log('FilmId g√©n√©r√© pour ancien projet:', safeData.filmId);
              }
              
              state.data = safeData; state.currentProjectId = id;
              LoadingScreen.setProgress(95);
              UI.launchEditor(); Store.startRealtimeListener(id); Store.initPresence(id); Store.initLocks(id);
              LoadingScreen.hide();
          } catch(e) { LoadingScreen.hide(); Utils.toast("Erreur: " + e.message, "error"); console.error(e); UI.showDashboard(); }
      },
      startRealtimeListener: (id) => {
          if(state.dbListener) state.dbListener.off();
          state.dbListener = firebase.database().ref('all_projects/' + id + '/data');
          state.dbListener.on('value', (snap) => {
             const val = snap.val(); if(!val) return;
             state.data = { ...state.data, ...val };
             if(document.activeElement !== els.title) els.title.value = state.data.title;
             // Synopsis g√©r√© par le module Synopsis avec chapitres
             Synopsis.renderTree('synopsis');
             Synopsis.renderTree('short');
             Synopsis.renderTree('long');
             if(els.boardSynopsis) els.boardSynopsis.innerText = state.data.synopsis || "(Vide)";
             if(els.boardShort) els.boardShort.innerText = state.data.synopsisShort || "(Vide)";
             if(els.boardLong) els.boardLong.innerText = state.data.synopsisLong || "(Vide)";
             const activeId = document.activeElement && document.activeElement.closest('.script-row') ? parseInt(document.activeElement.closest('.script-row').dataset.id) : null;
             const activeContinuous = document.activeElement && document.activeElement.closest('.script-continuous-content');
             if(state.currentRole !== 'viewer') { 
                 const activeTab = document.querySelector('.tab-content.active').id; 
                 if(activeTab === 'tab-board') UI.renderBoard(); 
                 if(activeTab === 'tab-script' && !activeId && !activeContinuous) UI.renderScript();
                 if(activeTab === 'tab-stats') Stats.render();
                 // V62 : On rafraichit la liste des versions si la modale est ouverte
                 if(els.versionModal.style.display === 'flex') UI.renderVersionList();
                 if(activeTab === 'tab-actors') UI.renderDataTab('actors', els.actorContainer);
             } else { UI.renderAll(); }
          });
      },
      initPresence: (id) => { if(state.presenceRef) state.presenceRef.remove(); const email = state.currentUser.email; const connectionsRef = firebase.database().ref('all_projects/' + id + '/presence'); state.presenceRef = connectionsRef.push(); state.presenceRef.onDisconnect().remove(); state.presenceRef.set({ email: email, time: Date.now() }); connectionsRef.on('value', (snap) => { const users = snap.val() || {}; els.presenceList.innerHTML = ''; Object.values(users).forEach(u => { const initials = Utils.getInitials(u.email); const bg = Utils.getColor(u.email); const wrapper = document.createElement('div'); wrapper.className = 'presence-avatar-wrapper'; const roleInfo = Store.getUserRoleInfo(u.email); const personInfo = Store.getPersonInfo(u.email); if(roleInfo.class) wrapper.classList.add(roleInfo.class); const div = document.createElement('div'); div.className = 'presence-avatar'; div.style.backgroundColor = bg; div.innerText = initials; wrapper.appendChild(div); if(roleInfo.icon) { const badge = document.createElement('span'); badge.className = 'role-icon'; badge.innerText = roleInfo.icon; wrapper.appendChild(badge); } if(roleInfo.extraRoles && roleInfo.extraRoles.length > 0) { roleInfo.extraRoles.forEach((r, idx) => { const extraBadge = document.createElement('span'); extraBadge.className = 'role-icon extra-role'; extraBadge.style.right = (-2 + (idx + 1) * 12) + 'px'; extraBadge.innerText = r.icon; wrapper.appendChild(extraBadge); }); } const tooltip = document.createElement('div'); tooltip.className = 'avatar-tooltip'; let tooltipHtml = '<div class="avatar-tooltip-name">' + Utils.escape(personInfo.name || u.email.split('@')[0]) + '</div>'; if(roleInfo.text) tooltipHtml += '<div class="avatar-tooltip-role">' + Utils.escape(roleInfo.text) + '</div>'; if(roleInfo.extraRoles && roleInfo.extraRoles.length > 0) { roleInfo.extraRoles.forEach(r => { tooltipHtml += '<div class="avatar-tooltip-role">' + r.icon + ' ' + Utils.escape(r.name) + '</div>'; }); } tooltip.innerHTML = tooltipHtml; wrapper.appendChild(tooltip); els.presenceList.appendChild(wrapper); }); }); },
      getPersonInfo: (email) => {
          let ownerRoles = [];
          // Chercher dans l'√©quipe technique
          if(state.data?.crew) {
              const member = state.data.crew.find(c => c.email === email);
              if(member) {
                  if(member.ownerRoles) ownerRoles = member.ownerRoles;
                  return { name: member.name, role: member.role, ownerRoles: ownerRoles, type: 'crew', isOwner: member.isOwner };
              }
          }
          // Chercher dans les com√©diens
          if(state.data?.actors) {
              const actor = state.data.actors.find(a => a.email === email);
              if(actor) return { name: actor.name, role: 'Com√©dien(ne)', ownerRoles: [], type: 'actor', isOwner: actor.isOwner };
          }
          // Retourner l'email par d√©faut
          return { name: email.split('@')[0], role: '', ownerRoles: [], type: '' };
      },
      getUserRoleInfo: (email) => {
          let text = '', icon = '', roleClass = '', extraRoles = [];
          
          // Chercher les infos de la personne
          const personInfo = Store.getPersonInfo(email);
          
          // Propri√©taire
          const isOwner = personInfo.isOwner || (state.currentRole === 'owner' && email === state.currentUser?.email);
          if(isOwner) {
              text = 'Propri√©taire';
              icon = 'üëë';
              roleClass = 'owner';
              // Ajouter les r√¥les suppl√©mentaires depuis ownerRoles
              if(personInfo.ownerRoles && personInfo.ownerRoles.length > 0) {
                  extraRoles = personInfo.ownerRoles.map(r => ({ icon: r.icon, name: r.name }));
              }
              return { text, icon, class: roleClass, extraRoles };
          }
          // Responsable budget global
          if(state.data?.budget?.manager === email) {
              return { text: 'Resp. Budget', icon: 'üí∞', class: 'budget-manager', extraRoles: [] };
          }
          // Responsable d√©partement
          const deptManagers = state.data?.budget?.deptManagers || {};
          const depts = [{id:'image',name:'Image',icon:'üìπ'},{id:'lumiere',name:'Lumi√®re',icon:'üí°'},{id:'son',name:'Son',icon:'üé§'},{id:'realisation',name:'R√©alisation',icon:'üé¨'},{id:'decoration',name:'D√©coration',icon:'üé®'},{id:'costumes',name:'Costumes',icon:'üëó'},{id:'maquillage',name:'Maquillage',icon:'üíÑ'},{id:'regie',name:'R√©gie',icon:'üé≠'},{id:'production',name:'Production',icon:'üíº'},{id:'transport',name:'Transport',icon:'üöó'},{id:'catering',name:'Catering',icon:'üç¥'},{id:'postprod',name:'Post-prod',icon:'üéûÔ∏è'},{id:'location',name:'Locations',icon:'üè†'},{id:'assurance',name:'Assurance',icon:'üìã'}];
          for(const [deptId, manager] of Object.entries(deptManagers)) {
              if(manager.email === email) {
                  const dept = depts.find(d => d.id === deptId);
                  return { text: 'Resp. ' + (dept?.name || deptId), icon: dept?.icon || 'üìã', class: 'dept-manager', extraRoles: [] };
              }
          }
          // R√¥le √©quipe (avec r√¥les multiples)
          if(state.data?.crew) {
              const member = state.data.crew.find(c => c.email === email);
              if(member) {
                  const extraRoles = member.roles ? member.roles.map(r => ({ icon: r.icon, name: r.name })) : [];
                  return { text: member.role || '', icon: 'üé¨', class: '', extraRoles };
              }
          }
          return { text: '', icon: '', class: '', extraRoles: [] };
      },
      initLocks: (id) => { if(state.locksListener) state.locksListener.off(); state.locksListener = firebase.database().ref('all_projects/' + id + '/locks'); state.locksListener.on('value', (snap) => { state.activeLocks = snap.val() || {}; UI.applyLocks(); }); },
      acquireLock: (sceneId) => { 
          if(state.currentRole === 'viewer') return; 
          const lockRef = firebase.database().ref('all_projects/' + state.currentProjectId + '/locks/' + sceneId);
          lockRef.once('value', (snap) => {
              const existingLock = snap.val();
              if (existingLock && existingLock.uid !== state.currentUser.uid) {
                  Utils.toast(`Sc√®ne d√©j√† √©dit√©e par ${existingLock.user.split('@')[0]}`, 'warning');
                  return;
              }
              lockRef.set({ user: state.currentUser.email, uid: state.currentUser.uid, timestamp: Date.now() });
              lockRef.onDisconnect().remove();
          });
      },
      releaseLock: (sceneId) => { if(state.currentRole === 'viewer') return; const lock = state.activeLocks[sceneId]; if(lock && lock.uid === state.currentUser.uid) { firebase.database().ref('all_projects/' + state.currentProjectId + '/locks/' + sceneId).remove(); } },
	  
      updateScene: Utils.debounce((sceneId, content) => { 
          if(!state.currentProjectId || state.currentRole === 'viewer') return; 
          const idx = state.data.scenes.findIndex(s => s.id === sceneId); 
          if(idx > -1) { 
              const newTime = Utils.estimateTime(content);
              firebase.database().ref('all_projects/' + state.currentProjectId + '/data/scenes/' + idx + '/scriptContent').set(content); 
              firebase.database().ref('all_projects/' + state.currentProjectId + '/data/scenes/' + idx + '/time').set(newTime);
              state.data.scenes[idx].scriptContent = content;
              state.data.scenes[idx].time = newTime;
          } 
      }, 500),
      updateTitle: Utils.debounce((val) => { if(!state.currentProjectId || state.currentRole === 'viewer') return; firebase.database().ref('all_projects/' + state.currentProjectId + '/data/title').set(val); firebase.database().ref('all_projects/' + state.currentProjectId + '/meta/title').set(val); }, 1000),
      updateTextField: Utils.debounce((field, val) => { if(!state.currentProjectId || state.currentRole === 'viewer') return; firebase.database().ref('all_projects/' + state.currentProjectId + '/data/' + field).set(val); }, 1000),
      migrateShootingDays: () => {
        // Migrer les jours de tournage vers le nouveau format (startDate/endDate)
        if(!state.data.shootingDays) return;
        
        state.data.shootingDays.forEach(day => {
            // Si ancien format (date), convertir vers nouveau format
            if(day.date && !day.startDate) {
                day.startDate = day.date;
                day.endDate = day.date;
                delete day.date;
            }
            
            // G√©n√©rer un nom bas√© sur les sc√®nes si pas de nom
            if(!day.name) {
                if(day.scenes && day.scenes.length > 0 && state.data.scenes) {
                    const sceneInfos = day.scenes.map(sc => {
                        const sceneId = typeof sc === 'string' ? sc : sc.sceneId;
                        const sceneIndex = state.data.scenes.findIndex(s => s.id === sceneId);
                        const selectedShots = sc.selectedShots || [];
                        const shotCount = selectedShots.length;
                        return sceneIndex >= 0 ? { num: sceneIndex + 1, shots: shotCount } : null;
                    }).filter(Boolean);
                    
                    if(sceneInfos.length === 1) {
                        // Une seule sc√®ne : Sc.3 (5 pl.)
                        const info = sceneInfos[0];
                        day.name = `Sc.${info.num}` + (info.shots > 0 ? ` (${info.shots} pl.)` : '');
                    } else if(sceneInfos.length > 1) {
                        // Plusieurs sc√®nes : Sc.3(3pl);5(5pl)
                        day.name = 'Sc.' + sceneInfos.map(info => 
                            info.shots > 0 ? `${info.num}(${info.shots}pl)` : `${info.num}`
                        ).join(';');
                    } else {
                        day.name = `Tournage ${day.startDate || ''}`;
                    }
                } else {
                    day.name = `Tournage ${day.startDate || ''}`;
                }
            }
        });
    },
    
    migrateBreakdownKeys: () => {
          // Migrer les anciennes cl√©s D√âCORS/LIEUX vers DECORS-LIEUX
          if(state.data.scenes) {
              state.data.scenes.forEach(scene => {
                  if(scene.breakdown && scene.breakdown["D√âCORS/LIEUX"]) {
                      scene.breakdown["DECORS-LIEUX"] = scene.breakdown["DECORS-LIEUX"] || [];
                      scene.breakdown["DECORS-LIEUX"] = [...new Set([...scene.breakdown["DECORS-LIEUX"], ...scene.breakdown["D√âCORS/LIEUX"]])];
                      delete scene.breakdown["D√âCORS/LIEUX"];
                  }
              });
          }
      },
      save: async () => { 
          if(!state.currentProjectId || !state.currentUser || state.currentRole === 'viewer') return;
          
          // Marquer qu'une sauvegarde est en cours
          state.savingInProgress = true; 
          
          // Cr√©er un snapshot auto si plus de 5 min depuis le dernier
          if(Actions.shouldAutoSnapshot()) {
              Actions.createAutoSnapshot('Auto');
          }
          
          // Indicateur de sync : en cours
          const syncIndicator = document.getElementById('sync-indicator');
          if(syncIndicator) {
              syncIndicator.textContent = 'üîÑ';
              syncIndicator.style.opacity = '1';
          }
          
          Store.migrateBreakdownKeys();
          Store.migrateShootingDays(); 
          
          // Nettoyer les valeurs undefined (Firebase ne les accepte pas)
          const cleanData = JSON.parse(JSON.stringify(state.data, (key, value) => value === undefined ? null : value));
          
          const id = state.currentProjectId; 
          await firebase.database().ref('all_projects/' + id + '/data').update(cleanData); 
          const meta = { title: state.data.title, date: new Date().toLocaleDateString() }; 
          await firebase.database().ref('all_projects/' + id + '/meta').update(meta); 
          
          // Indicateur de sync : termin√©
          if(syncIndicator) {
              syncIndicator.textContent = '‚úÖ';
              setTimeout(() => {
                  syncIndicator.textContent = '‚òÅÔ∏è';
                  syncIndicator.style.opacity = '0.4';
              }, 2000);
          }
          
          // Marquer que la sauvegarde est termin√©e
          state.savingInProgress = false;
          
          // Notifier les autres onglets de la modification
          if(typeof SessionManager !== 'undefined') {
              SessionManager.notifyDataUpdate();
          }
      },
      deleteProject: async (id, role, e) => { if(e) e.stopPropagation(); if(role === 'viewer') return; if(await ConfirmModal.confirmDelete("Cette action est irr√©versible.", "Supprimer ce projet ?")) { await firebase.database().ref('all_projects/' + id).remove(); const myEmailKey = Utils.sanitizeEmail(state.currentUser.email); await firebase.database().ref('user_projects/' + myEmailKey + '/' + id).remove(); await UI.renderDashboard(); } },
      shareProject: async (email, role) => { if(!state.currentProjectId) return; const pid = state.currentProjectId; const emailKey = Utils.sanitizeEmail(email); const updates = {}; updates['all_projects/' + pid + '/acl/' + emailKey] = role; updates['user_projects/' + emailKey + '/' + pid] = role; await firebase.database().ref().update(updates); History.log('SHARE', `Partage projet avec ${email} (${role})`); Notifications.send(email, 'invite', `${state.currentUser.email} vous a invit√© au projet "${state.data.title}"`, pid); Utils.toast('Invit√© !', 'success'); els.shareModal.style.display = 'none'; },
      clearCurrent: async () => { if(state.currentRole === 'viewer') return; if(await ConfirmModal.confirmDelete("Toutes les donn√©es du projet seront effac√©es.", "Vider tout ?")){ state.data = Store.getEmpty(); Store.save(); UI.renderAll(); } },
      importJSON: (e) => { if(state.currentRole === 'viewer') return; const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ try{ state.data = JSON.parse(ev.target.result); Store.save(); UI.renderAll(); UI.switchTab('synopsis'); Utils.toast('Import r√©ussi !', 'success'); } catch(x){ Utils.toast('Erreur fichier.', 'error'); } }; r.readAsText(f); e.target.value=''; }
  };
  
  const UI = {
      toggleTheme: () => { document.body.classList.toggle('dark-mode'); try { localStorage.setItem(CONFIG.themeKey, document.body.classList.contains('dark-mode') ? 'dark' : 'light'); } catch(e) {} if(Universe.map) Universe.updateMapTheme(); },
      
      // Syst√®me de Design
      designs: [
          { id: 'classic', name: 'Classique', icon: 'üé¨' },
          { id: 'glass', name: 'Glassmorphism', icon: '‚ú®' },
          { id: 'neumorphism', name: 'Neumorphism', icon: 'ü´ß' },
          { id: 'cinema', name: 'Dark Cinema', icon: 'üé•' },
          { id: 'neon', name: 'Cyberpunk', icon: 'üíú' },
          { id: 'nature', name: 'Nature', icon: 'üåø' },
          { id: 'sunset', name: 'Sunset', icon: 'üåÖ' },
          { id: 'ocean', name: 'Oc√©an', icon: 'üåä' },
          { id: 'lavender', name: 'Lavande', icon: 'üíú' },
          { id: 'minimal', name: 'Minimal', icon: '‚¨ú' },
          { id: 'terminal', name: 'Terminal', icon: 'üíª' },
          
      ],
      currentDesign: 'classic',
      
      setDesign: (designId) => {
          // Retirer tous les designs
          UI.designs.forEach(d => document.body.classList.remove('design-' + d.id));
          // Appliquer le nouveau (sauf classic qui est le d√©faut)
          if(designId !== 'classic') {
              document.body.classList.add('design-' + designId);
          }
          UI.currentDesign = designId;
          try { localStorage.setItem('fmp_design', designId); } catch(e) {}
          // Fermer le dropdown et mettre √† jour le label
          const dropdown = document.getElementById('design-dropdown');
          if(dropdown) dropdown.classList.remove('show');
          const label = document.getElementById('design-label');
          if(label) label.textContent = UI.designs.find(d => d.id === designId)?.name || 'Design';
          Utils.toast('Design ' + UI.designs.find(d => d.id === designId)?.name + ' appliqu√© !', 'success');
      },
      
      cycleDesign: () => {
          const currentIndex = UI.designs.findIndex(d => d.id === UI.currentDesign);
          const nextIndex = (currentIndex + 1) % UI.designs.length;
          UI.setDesign(UI.designs[nextIndex].id);
      },
      
      initDesign: () => {
          try {
              const saved = localStorage.getItem('fmp_design');
              if(saved && UI.designs.find(d => d.id === saved)) {
                  UI.currentDesign = saved;
                  if(saved !== 'classic') document.body.classList.add('design-' + saved);
              }
          } catch(e) {}
      },
      
      toggleDropdown: (name) => {
          // Fermer tous les autres dropdowns
          document.querySelectorAll('.menu-dropdown.visible').forEach(d => {
              if(d.id !== 'dropdown-' + name) d.classList.remove('visible');
          });
          
          const dropdown = document.getElementById('dropdown-' + name);
          dropdown.classList.toggle('visible');
          
          if(dropdown.classList.contains('visible')) {
              setTimeout(() => {
                  const closeHandler = (e) => {
                      if(!e.target.closest('.menu-dropdown-container')) {
                          document.querySelectorAll('.menu-dropdown.visible').forEach(d => d.classList.remove('visible'));
                          document.removeEventListener('click', closeHandler);
                      }
                  };
                  document.addEventListener('click', closeHandler);
              }, 10);
          }
      },
      
      closeAllDropdowns: () => {
          document.querySelectorAll('.menu-dropdown.visible').forEach(d => d.classList.remove('visible'));
      },
      
      // Menu mobile
      toggleMobileSidebar: () => {
          const sidebar = document.querySelector('.board-sidebar');
          const overlay = document.getElementById('mobile-overlay');
          if(sidebar) {
              sidebar.classList.toggle('mobile-open');
              overlay.classList.toggle('active');
          }
      },
      closeMobileSidebar: () => {
          const sidebar = document.querySelector('.board-sidebar');
          const overlay = document.getElementById('mobile-overlay');
          if(sidebar) {
              sidebar.classList.remove('mobile-open');
              overlay.classList.remove('active');
          }
      },
      
      showShortcuts: () => {
          const modal = document.createElement('div');
          modal.className = 'shortcuts-modal';
          modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
          modal.innerHTML = `
              <div class="shortcuts-box">
                  <h3 class="shortcuts-title">‚å®Ô∏è Raccourcis clavier</h3>
                  <div class="shortcuts-list">
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Sauvegarder</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">S</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Fermer modal</span>
                          <div class="shortcut-keys"><span class="shortcut-key">√âchap</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Onglet suivant</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">‚Üí</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Onglet pr√©c√©dent</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">‚Üê</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Types de bloc (sc√©nario)</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">1-6</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Tab intelligent / inverse</span>
                          <div class="shortcut-keys"><span class="shortcut-key">Tab</span><span class="shortcut-key">‚áßTab</span></div>
                      </div>
                      <div class="shortcut-item">
                          <span class="shortcut-desc">Quitter pr√©sentation</span>
                          <div class="shortcut-keys"><span class="shortcut-key">√âchap</span></div>
                      </div>
                  </div>
                  <button class="shortcuts-close" onclick="this.closest('.shortcuts-modal').remove()">Fermer</button>
              </div>
          `;
          document.body.appendChild(modal);
      },
      
      // Mode d'affichage des onglets
      setTabsMode: (mode) => {
          const tabsNav = document.getElementById('tabsNav');
          if(mode === 'adaptive') {
              tabsNav.classList.add('adaptive');
          } else {
              tabsNav.classList.remove('adaptive');
          }
          try { localStorage.setItem('fmp_tabs_mode', mode); } catch(e) {}
      },
      
      // Position des onglets (haut, bas, gauche, droite)
      setTabsPosition: (position) => {
          const tabsNav = document.getElementById('tabsNav');
          const body = document.body;
          const main = document.querySelector('main');
          
          // Retirer toutes les classes de position
          tabsNav.classList.remove('position-top', 'position-bottom', 'position-left', 'position-right');
          body.classList.remove('tabs-left', 'tabs-right', 'tabs-bottom');
          
          // Reset des marges du main
          if(main) {
              main.style.marginLeft = '';
              main.style.marginRight = '';
              main.style.marginBottom = '';
          }
          
          // Appliquer la nouvelle position
          tabsNav.classList.add('position-' + position);
          if(position === 'left') body.classList.add('tabs-left');
          if(position === 'right') body.classList.add('tabs-right');
          if(position === 'bottom') body.classList.add('tabs-bottom');
          
          // En position lat√©rale, forcer le mode D√©filant (pas d'Adaptatif)
          if(position === 'left' || position === 'right') {
              tabsNav.classList.remove('adaptive');
              try { localStorage.setItem('fmp_tabs_mode', 'scroll'); } catch(e) {}
          }
          
          // Mettre √† jour l'√©tat du menu
          UI.updatePositionMenuState();
          
          try { localStorage.setItem('fmp_tabs_position', position); } catch(e) {}
      },
      
      togglePositionMenu: () => {
          const menu = document.getElementById('tabs-position-menu');
          if(menu) {
              const isVisible = menu.style.display !== 'none';
              menu.style.display = isVisible ? 'none' : 'block';
              
              // Mettre √† jour les √©tats actifs
              if(!isVisible) {
                  UI.updatePositionMenuState();
                  setTimeout(() => {
                      const closeHandler = (e) => {
                          if(!e.target.closest('.tabs-position-dropdown')) {
                              menu.style.display = 'none';
                              document.removeEventListener('click', closeHandler);
                          }
                      };
                      document.addEventListener('click', closeHandler);
                  }, 10);
              }
          }
      },
      
      updatePositionMenuState: () => {
          // Mettre √† jour Navigation
          const currentNav = (() => { try { return localStorage.getItem('fmp_nav_mode') || 'categories'; } catch(e) { return 'categories'; } })();
          document.querySelectorAll('.position-menu-item[data-nav]').forEach(item => {
              item.classList.toggle('active', item.getAttribute('data-nav') === currentNav);
          });
          
          // V√©rifier si on est en mode Cat√©gories
          const isCategories = currentNav === 'categories';
          
          // Mettre √† jour Position (griser si Cat√©gories)
          const currentPos = (() => { try { return localStorage.getItem('fmp_tabs_position') || 'top'; } catch(e) { return 'top'; } })();
          document.querySelectorAll('.position-menu-item[data-pos]').forEach(item => {
              item.classList.toggle('active', item.getAttribute('data-pos') === currentPos && !isCategories);
              item.classList.toggle('disabled', isCategories);
              item.style.opacity = isCategories ? '0.4' : '1';
              item.style.pointerEvents = isCategories ? 'none' : 'auto';
          });
          
          // Mettre √† jour Mode (griser si Cat√©gories)
          const currentMode = (() => { try { return localStorage.getItem('fmp_tabs_mode') || 'adaptive'; } catch(e) { return 'adaptive'; } })();
          document.querySelectorAll('.position-menu-item[data-mode]').forEach(item => {
              item.classList.toggle('active', item.getAttribute('data-mode') === currentMode && !isCategories);
              item.classList.toggle('disabled', isCategories);
              item.style.opacity = isCategories ? '0.4' : '1';
              item.style.pointerEvents = isCategories ? 'none' : 'auto';
          });
          
          // Afficher/masquer section Mode selon la position (seulement pour haut/bas en mode Classique)
          const modeSection = document.getElementById('tabs-mode-section');
          if(modeSection) {
              const showMode = !isCategories && (currentPos === 'top' || currentPos === 'bottom');
              modeSection.style.display = showMode ? 'block' : 'none';
          }
          
          // Griser aussi le titre de section Position si Cat√©gories
          const positionLabel = document.getElementById('position-section-label');
          if(positionLabel) {
              positionLabel.style.opacity = isCategories ? '0.4' : '1';
          }
          const positionHint = document.getElementById('position-disabled-hint');
          if(positionHint) {
              positionHint.style.display = isCategories ? 'inline' : 'none';
          }
      },
      
      setNavModeFromMenu: (mode) => {
          UI.setNavMode(mode);
          UI.updatePositionMenuState();
      },
      
      setTabsModeFromMenu: (mode) => {
          UI.setTabsMode(mode);
          UI.updatePositionMenuState();
      },
      
      initTabsMode: () => {
          // Init position des onglets (doit √™tre fait en premier)
          const savedPosition = (() => { try { return localStorage.getItem('fmp_tabs_position') || 'top'; } catch(e) { return 'top'; } })();
          UI.setTabsPosition(savedPosition);
          
          // Init mode (seulement si position haut/bas, sinon forcer d√©filant)
          const savedMode = (() => { try { return localStorage.getItem('fmp_tabs_mode') || 'adaptive'; } catch(e) { return 'adaptive'; } })();
          if(savedPosition === 'top' || savedPosition === 'bottom') {
              UI.setTabsMode(savedMode);
          } else {
              UI.setTabsMode('scroll');
          }
          
          // Positionnement dynamique des tooltips pour √©viter qu'ils sortent de l'√©cran
          document.addEventListener('mouseover', (e) => {
              const el = e.target.closest('[data-tooltip]');
              if(el) {
                  const rect = el.getBoundingClientRect();
                  const tooltip = el.querySelector('::after');
                  // Utiliser CSS custom properties pour positionner
                  const tooltipX = Math.min(Math.max(rect.left + rect.width/2, 100), window.innerWidth - 100);
                  const tooltipY = rect.bottom + 10;
                  el.style.setProperty('--tooltip-x', tooltipX + 'px');
                  el.style.setProperty('--tooltip-y', tooltipY + 'px');
              }
          });
          
          // Init mode navigation (classique ou cat√©gories) - Cat√©gories par d√©faut
          const savedNavMode = (() => { try { return localStorage.getItem('fmp_nav_mode') || 'categories'; } catch(e) { return 'categories'; } })();
          UI.setNavMode(savedNavMode, true);
          
          // Charger et appliquer les cat√©gories masqu√©es
          UI.loadHiddenCategories();
          UI.applyHiddenCategories();
          
          // Init CardModal
          CardModal.init();
      },
      
      // Mode de navigation (classique ou cat√©gories)
      currentCategory: 'ecriture',
      categoryTabs: {
          ecriture: ['synopsis', 'board', 'titlepage', 'script', 'moodboard', 'storyboard'],
          casting: ['chars', 'actors', 'locs', 'resources'],
          production: ['presentation', 'crew', 'breakdown', 'planning', 'scriptreport'],
          admin: ['stats', 'expenses', 'chat']
      },
      categoryLabels: {
          ecriture: { synopsis: 'Synopsis', board: 'S√©quencier', titlepage: 'Titre', script: 'Sc√©nario', moodboard: 'Mood Board', storyboard: 'Storyboard' },
          casting: { chars: 'Personnages', actors: 'Com√©dien.nes', locs: 'D√©cors', resources: 'Ressources' },
          production: { presentation: 'Pr√©sentation', crew: '√âquipes', breakdown: 'D√©pouillement', planning: 'Planning', scriptreport: 'Rapport' },
          admin: { stats: 'Statistiques', expenses: 'D√©penses', chat: 'Chat' }
      },
      
      setNavMode: (mode, init = false) => {
          const tabsNav = document.getElementById('tabsNav');
          const tabsCategories = document.getElementById('tabsCategories');
          const tabsSubnav = document.getElementById('tabsSubnav');
          const classicOptions = document.getElementById('classic-mode-options');
          
          if(mode === 'categories') {
              tabsNav.classList.add('hidden-by-categories');
              tabsCategories.classList.add('active');
              tabsSubnav.classList.add('active');
              if(classicOptions) classicOptions.style.display = 'none';
              if(!init) UI.switchCategory(UI.currentCategory);
          } else {
              tabsNav.classList.remove('hidden-by-categories');
              tabsCategories.classList.remove('active');
              tabsSubnav.classList.remove('active');
              if(classicOptions) classicOptions.style.display = '';
          }
          try { localStorage.setItem('fmp_nav_mode', mode); } catch(e) {}
          
          // Rafra√Æchir le bouton "Masqu√©s" pour synchroniser entre les vues
          UI.applyHiddenTabs();
      },
      
      switchCategory: (category) => {
          UI.currentCategory = category;
          
          // Mettre √† jour les boutons cat√©gorie
          document.querySelectorAll('.tab-category').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.category === category);
          });
          
          // Mettre √† jour la sous-navigation
          const subnav = document.getElementById('tabsSubnav');
          const tabs = UI.categoryTabs[category] || [];
          const labels = UI.categoryLabels[category] || {};
          
          // Filtrer les onglets masqu√©s
          const visibleTabs = tabs.filter(t => !UI.hiddenTabs.includes(t));
          const hiddenInCategory = tabs.filter(t => UI.hiddenTabs.includes(t));
          
          let subnavHtml = visibleTabs.map(tab => {
              const isActive = document.getElementById('tab-' + tab)?.classList.contains('active');
              return `<button class="tab-subbtn${isActive ? ' active' : ''}" draggable="true" data-tab="${tab}" onclick="app.UI.switchTab('${tab}')">${labels[tab] || tab}<span class="tab-close" onclick="event.stopPropagation(); app.UI.hideTab('${tab}')" title="Masquer cet onglet">√ó</span></button>`;
          }).join('');
          
          subnav.innerHTML = subnavHtml;
          subnav.dataset.category = category;
          
          // R√©appliquer les couleurs sauvegard√©es sur les sous-onglets (depuis le projet)
          const subColors = state.data?.uiConfig?.subColors || {};
          Object.keys(subColors).forEach(tabName => {
              const tab = subnav.querySelector(`.tab-subbtn[data-tab="${tabName}"]`);
              if(tab) {
                  tab.style.background = subColors[tabName];
                  tab.style.color = '#ffffff';
                  tab.style.borderRadius = '6px 6px 0 0';
              }
          });
          
          // R√©attacher les √©v√©nements contextmenu
          UI.initSubnavContextMenu();
          
          // Si aucun onglet visible de cette cat√©gorie n'est actif, activer le premier visible
          const activeInCategory = visibleTabs.some(tab => document.getElementById('tab-' + tab)?.classList.contains('active'));
          if(!activeInCategory && visibleTabs.length > 0) {
              UI.switchTab(visibleTabs[0]);
          }
          
          try { localStorage.setItem('fmp_current_category', category); } catch(e) {}
      },
      
      // Trouver la cat√©gorie d'un onglet
      getCategoryForTab: (tabName) => {
          for(const [cat, tabs] of Object.entries(UI.categoryTabs)) {
              if(tabs.includes(tabName)) return cat;
          }
          return 'ecriture';
      },
      
      // Couleur des onglets (clic droit)
      currentTabTarget: null,
      
      openTabColorMenu: (e, tab) => {
          e.preventDefault();
          UI.currentTabTarget = tab;
          UI.currentTabType = tab.classList.contains('tab-category') ? 'category' : 
                              tab.classList.contains('tab-subbtn') ? 'subbtn' : 'classic';
          const menu = document.getElementById('tab-color-menu');
          menu.classList.add('visible');
          
          // Calculer la position pour ne pas sortir de l'√©cran
          const menuRect = menu.getBoundingClientRect();
          const viewportW = window.innerWidth;
          const viewportH = window.innerHeight;
          
          let left = e.clientX;
          let top = e.clientY;
          
          // Ajuster si le menu sort √† droite
          if(left + menuRect.width > viewportW - 10) {
              left = viewportW - menuRect.width - 10;
          }
          // Ajuster si le menu sort en bas
          if(top + menuRect.height > viewportH - 10) {
              top = viewportH - menuRect.height - 10;
          }
          // Ne pas sortir √† gauche ou en haut
          if(left < 10) left = 10;
          if(top < 10) top = 10;
          
          menu.style.left = left + 'px';
          menu.style.top = top + 'px';
      },
      
      closeTabColorMenu: () => {
          const menu = document.getElementById('tab-color-menu');
          menu.classList.remove('visible');
          UI.currentTabTarget = null;
      },
      
      setTabColor: (color) => {
          if(UI.currentTabTarget) {
              const tabName = UI.currentTabTarget.getAttribute('data-tab') || UI.currentTabTarget.getAttribute('data-category');
              const isCategory = UI.currentTabType === 'category';
              
              // Initialiser uiConfig si n√©cessaire
              if(!state.data.uiConfig) state.data.uiConfig = { tabColors: {}, categoryColors: {}, subColors: {}, tabsOrder: [], categoriesOrder: [], hiddenTabs: [] };
              if(!state.data.uiConfig.tabColors) state.data.uiConfig.tabColors = {};
              if(!state.data.uiConfig.subColors) state.data.uiConfig.subColors = {};
              if(!state.data.uiConfig.categoryColors) state.data.uiConfig.categoryColors = {};
              
              // Appliquer le style visuellement
              const applyStyle = (el, col) => {
                  if(col) {
                      el.style.background = col;
                      el.style.color = '#ffffff';
                      el.style.borderRadius = '6px 6px 0 0';
                  } else {
                      el.style.background = '';
                      el.style.color = '';
                      el.style.borderRadius = '';
                  }
              };
              
              applyStyle(UI.currentTabTarget, color);
              
              if(isCategory) {
                  // C'est une cat√©gorie - sauvegarder dans categoryColors
                  if(color) {
                      state.data.uiConfig.categoryColors[tabName] = color;
                  } else {
                      delete state.data.uiConfig.categoryColors[tabName];
                  }
              } else {
                  // C'est un onglet - synchroniser tabColors ET subColors
                  if(color) {
                      state.data.uiConfig.tabColors[tabName] = color;
                      state.data.uiConfig.subColors[tabName] = color;
                  } else {
                      delete state.data.uiConfig.tabColors[tabName];
                      delete state.data.uiConfig.subColors[tabName];
                  }
                  // Appliquer aussi √† l'√©quivalent dans l'autre vue
                  const classicTab = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
                  const subTab = document.querySelector(`.tab-subbtn[data-tab="${tabName}"]`);
                  if(classicTab) applyStyle(classicTab, color);
                  if(subTab) applyStyle(subTab, color);
              }
              Store.save();
          }
          UI.closeTabColorMenu();
      },
      
      openTabHelp: () => {
          const tabToHelp = {
              'presentation': 'dashboard',
              'synopsis': 'scenario',
              'board': 'sequencier',
              'script': 'scenario',
              'storyboard': 'storyboard',
              'chars': 'equipe',
              'locs': 'breakdown',
              'actors': 'equipe',
              'crew': 'equipe',
              'breakdown': 'breakdown',
              'planning': 'planning',
              'expenses': 'depenses',
              'budget': 'depenses',
              'chat': 'collaboration'
          };
          if(UI.currentTabTarget) {
              const tabName = UI.currentTabTarget.getAttribute('data-tab');
              const helpSection = tabToHelp[tabName] || 'intro';
              UI.closeTabColorMenu();
              Help.open();
              Help.showSection(helpSection);
          }
      },
      
      loadTabColors: () => {
          // R√©initialiser tous les styles d'abord
          document.querySelectorAll('.tab-btn, .tab-category, .tab-subbtn').forEach(tab => {
              tab.style.background = '';
              tab.style.color = '';
              tab.style.borderRadius = '';
          });
          
          // Charger depuis le projet (ou vide si pas de config)
          const uiConfig = state.data?.uiConfig || {};
          
          // Onglets classiques
          const tabColors = uiConfig.tabColors || {};
          Object.keys(tabColors).forEach(tabName => {
              const tab = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
              if(tab) {
                  tab.style.background = tabColors[tabName];
                  tab.style.color = '#ffffff';
                  tab.style.borderRadius = '6px 6px 0 0';
              }
          });
          // Cat√©gories
          const categoryColors = uiConfig.categoryColors || {};
          Object.keys(categoryColors).forEach(catName => {
              const tab = document.querySelector(`.tab-category[data-category="${catName}"]`);
              if(tab) {
                  tab.style.background = categoryColors[catName];
                  tab.style.color = '#ffffff';
                  tab.style.borderRadius = '6px 6px 0 0';
              }
          });
          // Sous-onglets
          const subColors = uiConfig.subColors || {};
          Object.keys(subColors).forEach(tabName => {
              const tab = document.querySelector(`.tab-subbtn[data-tab="${tabName}"]`);
              if(tab) {
                  tab.style.background = subColors[tabName];
                  tab.style.color = '#ffffff';
                  tab.style.borderRadius = '6px 6px 0 0';
              }
          });
      },
      
      initTabsContextMenu: () => {
          // Onglets classiques
          document.querySelectorAll('.tab-btn').forEach(tab => {
              tab.addEventListener('contextmenu', (e) => UI.openTabColorMenu(e, tab));
          });
          // Cat√©gories (mode cat√©gories)
          document.querySelectorAll('.tab-category').forEach(tab => {
              tab.addEventListener('contextmenu', (e) => UI.openTabColorMenu(e, tab));
          });
          // Sous-onglets (mode cat√©gories)
          document.querySelectorAll('.tab-subbtn').forEach(tab => {
              tab.addEventListener('contextmenu', (e) => UI.openTabColorMenu(e, tab));
          });
          // Fermer le menu au clic ailleurs
          document.addEventListener('click', (e) => {
              if(!e.target.closest('.tab-color-menu')) {
                  UI.closeTabColorMenu();
              }
              // Fermer le panneau notifications si clic en dehors
              if(!e.target.closest('.notif-wrapper')) {
                  Notifications.closePanel();
              }
          });
      },
      
      // R√©attacher les √©v√©nements apr√®s rebuild de la sous-nav
      initSubnavContextMenu: () => {
          document.querySelectorAll('.tab-subbtn').forEach(tab => {
              tab.addEventListener('contextmenu', (e) => UI.openTabColorMenu(e, tab));
          });
          // Initialiser le drag & drop des sous-onglets
          UI.initSubnavDragDrop();
      },
      
      // Drag & drop des sous-onglets entre cat√©gories
      subnavDraggedTab: null,
      subnavDraggedCategory: null,
      
      initSubnavDragDrop: () => {
          const subnav = document.getElementById('tabsSubnav');
          if(!subnav) return;
          
          subnav.querySelectorAll('.tab-subbtn').forEach(tab => {
              tab.addEventListener('dragstart', (e) => {
                  UI.subnavDraggedTab = tab;
                  UI.subnavDraggedCategory = UI.currentCategory;
                  tab.classList.add('dragging');
                  e.dataTransfer.effectAllowed = 'move';
                  e.dataTransfer.setData('text/plain', tab.dataset.tab);
              });
              
              tab.addEventListener('dragend', () => {
                  tab.classList.remove('dragging');
                  subnav.querySelectorAll('.tab-subbtn').forEach(t => t.classList.remove('drag-over'));
                  document.querySelectorAll('.tab-category').forEach(c => c.classList.remove('drag-over'));
                  UI.subnavDraggedTab = null;
                  UI.subnavDraggedCategory = null;
              });
              
              tab.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  if(UI.subnavDraggedTab && UI.subnavDraggedTab !== tab) {
                      tab.classList.add('drag-over');
                  }
              });
              
              tab.addEventListener('dragleave', () => {
                  tab.classList.remove('drag-over');
              });
              
              tab.addEventListener('drop', (e) => {
                  e.preventDefault();
                  tab.classList.remove('drag-over');
                  if(UI.subnavDraggedTab && UI.subnavDraggedTab !== tab) {
                      const allTabs = [...subnav.querySelectorAll('.tab-subbtn')];
                      const draggedIdx = allTabs.indexOf(UI.subnavDraggedTab);
                      const targetIdx = allTabs.indexOf(tab);
                      
                      if(draggedIdx < targetIdx) {
                          tab.after(UI.subnavDraggedTab);
                      } else {
                          tab.before(UI.subnavDraggedTab);
                      }
                      
                      // Sauvegarder le nouvel ordre
                      UI.saveSubnavOrder();
                  }
              });
          });
          
          // Permettre le drop sur les cat√©gories pour changer de cat√©gorie
          document.querySelectorAll('.tab-category').forEach(catBtn => {
              catBtn.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  if(UI.subnavDraggedTab && catBtn.dataset.category !== UI.subnavDraggedCategory) {
                      catBtn.classList.add('drag-over');
                  }
              });
              
              catBtn.addEventListener('dragleave', () => {
                  catBtn.classList.remove('drag-over');
              });
              
              catBtn.addEventListener('drop', (e) => {
                  e.preventDefault();
                  catBtn.classList.remove('drag-over');
                  
                  if(UI.subnavDraggedTab && catBtn.dataset.category !== UI.subnavDraggedCategory) {
                      const tabName = UI.subnavDraggedTab.dataset.tab;
                      const fromCategory = UI.subnavDraggedCategory;
                      const toCategory = catBtn.dataset.category;
                      
                      // D√©placer l'onglet vers la nouvelle cat√©gorie
                      UI.moveTabToCategory(tabName, fromCategory, toCategory);
                  }
              });
          });
      },
      
      saveSubnavOrder: () => {
          const subnav = document.getElementById('tabsSubnav');
          const category = UI.currentCategory;
          const newOrder = [...subnav.querySelectorAll('.tab-subbtn')].map(t => t.dataset.tab);
          
          // Mettre √† jour categoryTabs
          UI.categoryTabs[category] = newOrder;
          
          // Sauvegarder dans le projet
          if(state.data && state.data.uiConfig) {
              if(!state.data.uiConfig.categoryTabsOrder) state.data.uiConfig.categoryTabsOrder = {};
              state.data.uiConfig.categoryTabsOrder[category] = newOrder;
              Store.save();
          }
          
          Utils.toast('Ordre des onglets sauvegard√©', 'success');
      },
      
      moveTabToCategory: (tabName, fromCategory, toCategory) => {
          // Retirer de l'ancienne cat√©gorie
          UI.categoryTabs[fromCategory] = UI.categoryTabs[fromCategory].filter(t => t !== tabName);
          
          // Ajouter √† la nouvelle cat√©gorie
          if(!UI.categoryTabs[toCategory].includes(tabName)) {
              UI.categoryTabs[toCategory].push(tabName);
          }
          
          // Ajouter le label si pas d√©j√† pr√©sent
          if(!UI.categoryLabels[toCategory][tabName]) {
              UI.categoryLabels[toCategory][tabName] = UI.categoryLabels[fromCategory][tabName];
          }
          
          // Sauvegarder dans le projet
          if(state.data && state.data.uiConfig) {
              if(!state.data.uiConfig.categoryTabsOrder) state.data.uiConfig.categoryTabsOrder = {};
              state.data.uiConfig.categoryTabsOrder[fromCategory] = UI.categoryTabs[fromCategory];
              state.data.uiConfig.categoryTabsOrder[toCategory] = UI.categoryTabs[toCategory];
              
              if(!state.data.uiConfig.categoryLabelsCustom) state.data.uiConfig.categoryLabelsCustom = {};
              if(!state.data.uiConfig.categoryLabelsCustom[toCategory]) state.data.uiConfig.categoryLabelsCustom[toCategory] = {};
              state.data.uiConfig.categoryLabelsCustom[toCategory][tabName] = UI.categoryLabels[fromCategory][tabName];
              
              Store.save();
          }
          
          // Rafra√Æchir la vue - aller √† la nouvelle cat√©gorie
          UI.switchCategory(toCategory);
          Utils.toast(`"${UI.categoryLabels[toCategory][tabName]}" d√©plac√© vers ${toCategory}`, 'success');
      },
      
      // R√©initialiser l'ordre des onglets
      resetTabsOrder: () => {
          // R√©initialiser les onglets classiques
          const tabsNav = document.getElementById('tabsNav');
          const defaultOrder = [
              'presentation', 'synopsis', 'board', 'titlepage', 'script', 'storyboard', 
              'chars', 'actors', 'locs', 'resources', 'crew', 'breakdown', 
              'stats', 'planning', 'expenses', 'chat'
          ];
          const tabs = Array.from(tabsNav.querySelectorAll('.tab-btn'));
          
          defaultOrder.forEach(tabName => {
              const tab = tabs.find(t => t.getAttribute('data-tab') === tabName);
              if(tab) tabsNav.appendChild(tab);
          });
          
          // R√©initialiser les cat√©gories
          const catsNav = document.getElementById('tabsCategories');
          const defaultCatsOrder = ['ecriture', 'casting', 'production', 'admin'];
          const toggle = document.getElementById('hiddenCategoriesToggle');
          
          defaultCatsOrder.forEach(catName => {
              const cat = catsNav.querySelector(`.tab-category[data-category="${catName}"]`);
              if(cat) catsNav.insertBefore(cat, toggle);
          });
          
          // R√©initialiser les sous-onglets par cat√©gorie (ordre par d√©faut)
          const defaultCategoryTabs = {
              ecriture: ['synopsis', 'board', 'titlepage', 'script', 'storyboard'],
              casting: ['chars', 'actors', 'locs', 'resources'],
              production: ['presentation', 'crew', 'breakdown', 'planning', 'scriptreport'],
              admin: ['stats', 'expenses', 'chat']
          };
          const defaultCategoryLabels = {
              ecriture: { synopsis: 'Synopsis', board: 'S√©quencier', titlepage: 'Titre', script: 'Sc√©nario', storyboard: 'Storyboard' },
              casting: { chars: 'Personnages', actors: 'Com√©dien.nes', locs: 'D√©cors', resources: 'Ressources' },
              production: { presentation: 'Pr√©sentation', crew: '√âquipes', breakdown: 'D√©pouillement', planning: 'Planning', scriptreport: 'Rapport' },
              admin: { stats: 'Statistiques', expenses: 'D√©penses', chat: 'Chat' }
          };
          
          // Restaurer les valeurs par d√©faut
          UI.categoryTabs = JSON.parse(JSON.stringify(defaultCategoryTabs));
          UI.categoryLabels = JSON.parse(JSON.stringify(defaultCategoryLabels));
          
          // R√©initialiser dans le projet
          if(state.data.uiConfig) {
              state.data.uiConfig.tabsOrder = [];
              state.data.uiConfig.categoriesOrder = [];
              state.data.uiConfig.categoryTabsOrder = {};
              state.data.uiConfig.categoryLabelsCustom = {};
              state.data.uiConfig.tabColors = {};
              state.data.uiConfig.categoryColors = {};
              state.data.uiConfig.subColors = {};
              Store.save();
          }
          
          // R√©initialiser les couleurs visuellement
          document.querySelectorAll('.tab-btn').forEach(tab => {
              tab.style.background = '';
              tab.style.color = '';
              tab.style.borderRadius = '';
          });
          document.querySelectorAll('.tab-category').forEach(cat => {
              cat.style.background = '';
              cat.style.color = '';
              cat.style.borderRadius = '';
          });
          document.querySelectorAll('.tab-subbtn').forEach(sub => {
              sub.style.background = '';
              sub.style.color = '';
              sub.style.borderRadius = '';
          });
          
          // Rafra√Æchir la vue cat√©gories si active
          const tabsCategories = document.getElementById('tabsCategories');
          if(tabsCategories && tabsCategories.classList.contains('active')) {
              UI.switchCategory(UI.currentCategory);
          }
          
          Utils.toast('Ordre et couleurs r√©initialis√©s', 'success');
      },
      showDashboard: async () => { 
          els.authView.style.display = 'none'; 
          els.appView.style.display = 'none'; 
          els.dashboardView.style.display = 'flex';
          
          // Nettoyer le chat
          if(typeof Chat !== 'undefined') Chat.cleanup(); 
          const accountType = state.userProfile?.accountType || 'producer';
          const typeLabel = accountType === 'actor' ? 'üé≠ Com√©dien.ne' : (accountType === 'crew' ? 'üé• Technicien.ne' : 'üé¨ R√©alisateur');
          document.getElementById('user-welcome').innerText = typeLabel + " ‚Ä¢ " + (state.currentUser ? state.currentUser.email : ""); 
          
          // Mettre √† jour le bouton profil
          const profileBtn = document.getElementById('btn-my-profile');
          if(profileBtn) {
              const profileComplete = state.userProfile?.profileComplete;
              profileBtn.innerHTML = profileComplete ? 'üë§ Mon Profil' : '‚ö†Ô∏è Compl√©ter mon profil';
              profileBtn.style.background = 'var(--panel-bg)';
          }
          
          await UI.renderDashboard(); 
          
          // Timer pour mettre √† jour le countdown de l'essai
          if(UI.trialTimer) clearInterval(UI.trialTimer);
          if(Pricing.isInTrial()) {
              UI.trialTimer = setInterval(() => {
                  if(Pricing.isInTrial()) {
                      UI.renderProjectList();
                  } else {
                      clearInterval(UI.trialTimer);
                      UI.renderProjectList(); // Afficher que l'essai est termin√©
                  }
              }, 60000); // Mise √† jour toutes les minutes
          }
      },
      toggleSidebarContent: () => { if(els.toggleSynop.checked) els.blockSynop.classList.add('visible'); else els.blockSynop.classList.remove('visible'); if(els.toggleShort.checked) els.blockShort.classList.add('visible'); else els.blockShort.classList.remove('visible'); if(els.toggleLong.checked) els.blockLong.classList.add('visible'); else els.blockLong.classList.remove('visible'); },
      
      boardMode: 'normal',
      
      setBoardMode: (mode) => {
          UI.boardMode = mode;
          
          // Mettre √† jour les boutons
          document.getElementById('board-mode-normal').classList.toggle('active', mode === 'normal');
          document.getElementById('board-mode-normal').style.background = mode === 'normal' ? 'var(--primary)' : 'var(--bg)';
          document.getElementById('board-mode-normal').style.color = mode === 'normal' ? 'white' : 'var(--text-main)';
          
          document.getElementById('board-mode-compact').classList.toggle('active', mode === 'compact');
          document.getElementById('board-mode-compact').style.background = mode === 'compact' ? 'var(--primary)' : 'var(--bg)';
          document.getElementById('board-mode-compact').style.color = mode === 'compact' ? 'white' : 'var(--text-main)';
          
          // Appliquer le mode
          const boardList = document.getElementById('boardList');
          if(mode === 'compact') {
              boardList.classList.add('compact-mode');
          } else {
              boardList.classList.remove('compact-mode');
          }
          
          // Sauvegarder la pr√©f√©rence
          try { localStorage.setItem('fmp_board_mode', mode); } catch(e) {}
      },
      
      loadBoardMode: () => {
          try {
              const saved = localStorage.getItem('fmp_board_mode');
              if(saved) UI.setBoardMode(saved);
          } catch(e) {}
      },

      renderDashboard: async () => { 
          // Initialiser l'univers
          await Universe.init();
          // Afficher la liste des projets
          await UI.renderProjectList();
      },
      
      showPriorityMenu: (e, projectId) => {
          e.stopPropagation();
          // Fermer menu existant
          const existing = document.querySelector('.priority-menu');
          if(existing) existing.remove();
          
          const priorities = [
              { label: 'Principal', class: 'principal', color: '#4CAF50' },
              { label: 'Secondaire', class: 'secondaire', color: '#2196F3' },
              { label: 'Urgent', class: 'urgent', color: '#f44336' },
              { label: 'En attente', class: 'en-attente', color: '#9E9E9E' },
              { label: 'Une id√©e', class: 'une-idee', color: '#FF9800' },
              { label: 'Je sais pas trop', class: 'je-sais-pas-trop', color: '#9C27B0' },
              { label: 'Archiv√©', class: 'archive', color: '#795548' },
              { label: 'Aucune', class: '', color: 'transparent' }
          ];
          
          const menu = document.createElement('div');
          menu.className = 'priority-menu';
          menu.innerHTML = priorities.map(p => `
              <div class="priority-menu-item" onclick="app.UI.setPriority('${projectId}', '${p.label === 'Aucune' ? '' : p.label}')">
                  <span class="dot" style="background:${p.color}"></span>
                  ${p.label}
              </div>
          `).join('');
          
          const rect = e.target.getBoundingClientRect();
          menu.style.position = 'fixed';
          menu.style.top = (rect.bottom + 5) + 'px';
          menu.style.left = rect.left + 'px';
          
          document.body.appendChild(menu);
          
          // Fermer au clic ailleurs
          setTimeout(() => {
              document.addEventListener('click', function closeMenu(ev) {
                  if(!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('click', closeMenu); }
              });
          }, 10);
      },
      
      setPriority: async (projectId, priority) => {
          const menu = document.querySelector('.priority-menu');
          if(menu) menu.remove();
          
          try {
              await firebase.database().ref(`all_projects/${projectId}/meta/priority`).set(priority || null);
              Utils.toast(priority ? `Priorit√© "${priority}" d√©finie` : 'Priorit√© supprim√©e', 'success');
              UI.renderProjectList();
          } catch(e) {
              Utils.toast('Erreur lors de la mise √† jour', 'error');
          }
      },
      
      reorderProjects: async (draggedId, targetId) => {
          const myEmailKey = Utils.sanitizeEmail(state.currentUser.email);
          const list = await Store.getProjectsList();
          
          // Trouver les index
          const draggedIdx = list.findIndex(p => p.id === draggedId);
          const targetIdx = list.findIndex(p => p.id === targetId);
          
          if(draggedIdx === -1 || targetIdx === -1) return;
          
          // Capturer les positions actuelles des cartes
          const cards = Array.from(document.querySelectorAll('.project-card'));
          const oldPositions = new Map();
          cards.forEach(card => {
              const rect = card.getBoundingClientRect();
              oldPositions.set(card.dataset.projectId, { left: rect.left, top: rect.top });
          });
          
          // R√©organiser
          const [dragged] = list.splice(draggedIdx, 1);
          list.splice(targetIdx, 0, dragged);
          
          // Sauvegarder l'ordre pour chaque projet
          const updates = {};
          list.forEach((p, idx) => {
              updates[`all_projects/${p.id}/meta/order`] = idx;
          });
          
          try {
              await firebase.database().ref().update(updates);
              
              // Reconstruire la liste
              await UI.renderProjectList();
              
              // Animer vers les nouvelles positions (FLIP animation)
              const newCards = Array.from(document.querySelectorAll('.project-card'));
              newCards.forEach(card => {
                  const projectId = card.dataset.projectId;
                  const oldPos = oldPositions.get(projectId);
                  if(oldPos) {
                      const newRect = card.getBoundingClientRect();
                      const deltaX = oldPos.left - newRect.left;
                      const deltaY = oldPos.top - newRect.top;
                      
                      if(deltaX !== 0 || deltaY !== 0) {
                          card.style.transition = 'none';
                          card.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                          
                          requestAnimationFrame(() => {
                              requestAnimationFrame(() => {
                                  card.style.transition = 'transform 0.7s cubic-bezier(0.25, 0.1, 0.25, 1)';
                                  card.style.transform = 'translate(0, 0)';
                              });
                          });
                          
                          // Nettoyer apr√®s l'animation
                          setTimeout(() => {
                              card.style.transition = '';
                              card.style.transform = '';
                          }, 750);
                      }
                  }
              });
              
          } catch(e) {
              Utils.toast('Erreur lors du r√©ordonnancement', 'error');
          }
      },

      renderProjectList: async () => {
          els.projectList.innerHTML = '<div style="padding:20px; color:#999">Chargement...</div>'; 
          const list = await Store.getProjectsList(); 
          els.projectList.innerHTML = ''; 
          
          const accountType = state.userProfile?.accountType || 'crew';
          
          // Banni√®re d'essai (si en p√©riode d'essai)
          const trialBanner = Pricing.getTrialBanner();
          if(trialBanner) {
              const bannerDiv = document.createElement('div');
              bannerDiv.style.cssText = 'grid-column: 1 / -1;';
              bannerDiv.innerHTML = trialBanner;
              els.projectList.appendChild(bannerDiv);
          }
          
          // Widget de facturation (si abonn√© avec des projets)
          const billingWidget = await Pricing.getBillingWidget();
          if(billingWidget) {
              const billingDiv = document.createElement('div');
              billingDiv.style.cssText = 'grid-column: 1 / -1;';
              billingDiv.innerHTML = billingWidget;
              els.projectList.appendChild(billingDiv);
          }
          
          // Carte nouveau projet (tout le monde peut cr√©er un projet)
          const newCard = document.createElement('div'); 
          newCard.className = 'new-project-card'; 
          newCard.innerHTML = `<span>+</span><div>Nouveau Projet</div>`; 
          newCard.onclick = Store.createNewProject; 
          els.projectList.appendChild(newCard); 
          
          const importCard = document.createElement('div');
          importCard.className = 'new-project-card import-card';
          importCard.innerHTML = `<span>üìÇ</span><div>Importer (PDF / FDX)</div>`;
          importCard.onclick = () => els.importInput.click();
          els.projectList.appendChild(importCard);
          
         

          // Liste des projets
          if(list.length > 0) {
              // Trier par ordre personnalis√© puis par date
              list.sort((a, b) => {
                  const orderA = a.order !== undefined ? a.order : 9999;
                  const orderB = b.order !== undefined ? b.order : 9999;
                  if(orderA !== orderB) return orderA - orderB;
                  return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
              });
              
              list.forEach((p, idx) => { 
                  const card = document.createElement('div'); 
                  card.className = 'project-card'; 
                  card.draggable = true;
                  card.dataset.projectId = p.id;
                  card.dataset.index = idx;
                  let badgeColor = p.role==='owner'?'var(--primary)':(p.role==='editor'?'orange':'gray'); 
                  let badgeText = p.role==='owner'?'PROPRI√âTAIRE':(p.role==='editor'?'√âDITEUR':'LECTEUR');
                  const priorityClass = p.priority ? p.priority.replace(/\s+/g, '-').toLowerCase() : '';
                  const priorityBadge = p.priority ? `<span class="priority-badge ${priorityClass}">${p.priority}</span>` : '';
                  card.innerHTML = `<span class="p-role-badge" style="color:${badgeColor}; border-color:${badgeColor}">${badgeText}</span><div><div class="p-title">${Utils.escape(p.title)}</div><div class="p-meta">Modifi√© : ${p.date} ${priorityBadge}</div></div><div class="p-actions"><button class="p-btn-priority" onclick="app.UI.showPriorityMenu(event, '${p.id}')" title="Priorit√©">üè∑Ô∏è</button><button class="p-btn-del" onclick="app.Store.deleteProject('${p.id}', '${p.role}', event)">üóëÔ∏è</button></div>`; 
                  card.onclick = (e) => { if(!e.target.closest('.p-actions')) Store.loadProject(p.id); };
                  
                  // Drag & drop events
                  card.addEventListener('dragstart', (e) => { 
                      card.classList.add('dragging'); 
                      e.dataTransfer.setData('text/plain', p.id);
                      e.dataTransfer.effectAllowed = 'move';
                      setTimeout(() => card.style.visibility = 'hidden', 0);
                  });
                  card.addEventListener('dragend', () => { 
                      card.classList.remove('dragging'); 
                      card.style.visibility = 'visible';
                      document.querySelectorAll('.project-card').forEach(c => { c.classList.remove('drag-over'); c.classList.remove('drag-over-left'); }); 
                  });
                  card.addEventListener('dragover', (e) => { 
                      e.preventDefault(); 
                      if(!card.classList.contains('dragging')) {
                          document.querySelectorAll('.project-card').forEach(c => { if(c !== card) { c.classList.remove('drag-over'); c.classList.remove('drag-over-left'); }});
                          card.classList.add('drag-over');
                      }
                  });
                  card.addEventListener('dragleave', (e) => { 
                      if(!card.contains(e.relatedTarget)) {
                          card.classList.remove('drag-over'); 
                          card.classList.remove('drag-over-left'); 
                      }
                  });
                  card.addEventListener('drop', (e) => { e.preventDefault(); card.classList.remove('drag-over'); card.classList.remove('drag-over-left'); const draggedId = e.dataTransfer.getData('text/plain'); if(draggedId !== p.id) UI.reorderProjects(draggedId, p.id); });
                  
                  els.projectList.appendChild(card); 
              });
          }
      },
      
      launchEditor: () => { 
          els.dashboardView.style.display = 'none'; els.appView.style.display = 'flex';
          
          // Appliquer les permissions sur les onglets visibles
          UI.applyTabPermissions(); 
          let roleTxt = state.currentRole === 'owner' ? 'PROPRI√âTAIRE' : (state.currentRole === 'editor' ? '√âDITEUR' : 'LECTEUR');
          
          // Afficher le r√¥le m√©tier si disponible
          const userEmail = state.currentUser?.email;
          if(userEmail && state.currentRole !== 'owner') {
              const crew = state.data?.crew?.find(c => c.email === userEmail);
              const actor = state.data?.actors?.find(a => a.email === userEmail);
              if(crew && crew.role) {
                  roleTxt = crew.role;
              } else if(actor) {
                  roleTxt = 'Com√©dien.ne';
              }
          }
          
          els.roleBadge.innerText = roleTxt; 
          if(state.currentRole === 'viewer') { document.body.classList.add('read-only'); els.title.disabled = true; } else { document.body.classList.remove('read-only'); els.title.disabled = false; }
          
          // Appliquer les permissions sur les champs synopsis
          const canEditSynopsis = state.currentRole === 'owner' || Permissions.canEdit('synopsis');
          // Synopsis en mode chapitres - permissions g√©r√©es diff√©remment
          state.canEditSynopsis = canEditSynopsis;
          
          if(!canEditSynopsis) {
              // Synopsis en mode chapitres
          } else {
              // Synopsis en mode chapitres
          } 
          
          if(!window.appListenersAttached) { 
              els.title.addEventListener('input', () => { state.data.title = els.title.value; Store.updateTitle(els.title.value); }); 
              // Synopsis en mode chapitres - √©v√©nements g√©r√©s par le module Synopsis 
              document.getElementById('btnSave').addEventListener('click', Store.save);
          
          // Protection contre la fermeture pendant une sauvegarde
          window.addEventListener('beforeunload', (e) => {
              if(state.savingInProgress) {
                  e.preventDefault();
                  e.returnValue = 'Une sauvegarde est en cours. Voulez-vous vraiment quitter ?';
                  return e.returnValue;
              }
          }); 
              document.getElementById('btnLoad').addEventListener('click', () => els.fileInput.click()); 
              els.fileInput.addEventListener('change', Store.importJSON); 
              document.getElementById('btnClear').addEventListener('click', Store.clearCurrent); 
              Utils.setupEnterNav(); Utils.setupAutocomplete(els.inpPerso); 
              els.boardList.addEventListener('dragover', e => UI.handleDragOver(e, els.boardList, '.card')); 
              els.scriptContainer.addEventListener('dragover', e => UI.handleDragOver(e, els.scriptContainer, '.script-row')); 
              document.addEventListener('click', (e) => { 
                  if(state.scriptAC.active && !els.scriptACList.contains(e.target)) ScriptEditor.hideAC(); 
                  if(els.bdCtxMenu.style.display === 'block' && !els.bdCtxMenu.contains(e.target)) els.bdCtxMenu.style.display = 'none'; 
                  if(els.tagCtxMenu.style.display === 'block' && !els.tagCtxMenu.contains(e.target)) els.tagCtxMenu.style.display = 'none'; 
              }); 
              window.appListenersAttached = true; 
          } 
          UI.renderAll(); UI.initHiddenTabs(); UI.switchTab('synopsis'); UI.initTabsDragDrop(); UI.initCategoriesDragDrop(); UI.loadCategoriesOrder(); UI.loadCategoryTabsOrder(); UI.initTabsMode(); UI.loadTabColors(); UI.initTabsContextMenu(); Synopsis.init();
          // Mettre √† jour les notifications et le badge de r√¥le
          Notifications.updateBadge();
          Notifications.updateRoleBadge();
      },
      
      renderAll: () => { 
          els.title.value = state.data.title || ""; 
          // Synopsis avec √©diteur riche
          Synopsis.load('synopsis');
          Synopsis.load('short');
          Synopsis.load('long');
          if(els.boardSynopsis) els.boardSynopsis.innerText = state.data.synopsis || "(Vide)";
          if(els.boardShort) els.boardShort.innerText = state.data.synopsisShort || "(Vide)";
          if(els.boardLong) els.boardLong.innerText = state.data.synopsisLong || "(Vide)";
          UI.renderBoard(); UI.renderScript(); ScriptEditor.initViewMode(); UI.renderDataTab('characters', els.charContainer); UI.renderDataTab('actors', els.actorContainer); UI.renderDataTab('locations', els.locContainer); 
      },
      
      // V62: Affichage de la liste des snapshots dans la modale
      renderVersionList: () => {
          els.versionList.innerHTML = '';
          const snaps = state.data.snapshots || [];
          if(snaps.length === 0) {
              els.versionList.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sec)">Aucune sauvegarde disponible.<br><small>Les sauvegardes sont cr√©√©es automatiquement.</small></div>';
              return;
          }
          
          snaps.forEach((snap, idx) => {
              const row = document.createElement('div');
              row.className = 'ver-row';
              const triggerIcon = snap.trigger === 'Manuel' ? 'üíæ' : 'üîÑ';
              const userShort = snap.user ? snap.user.split('@')[0] : 'Inconnu';
              row.innerHTML = `
                  <div class="ver-info">
                      <span class="ver-name">${triggerIcon} ${snap.dateDisplay || snap.date}</span>
                      <span class="ver-date">par ${Utils.escape(userShort)} ${snap.trigger === 'Manuel' ? '(manuel)' : '(auto)'}</span>
                  </div>
                  <div class="ver-actions">
                      <button onclick="app.Actions.restoreSnapshot(${idx})" style="color:var(--primary); border-color:var(--primary)">Restaurer</button>
                      <button onclick="app.Actions.deleteSnapshot(${idx})" style="color:var(--danger); border-color:var(--danger)">üóëÔ∏è</button>
                  </div>
              `;
              els.versionList.appendChild(row);
          });
      },

      // Onglets masqu√©s (par utilisateur en localStorage, pas partag√© entre membres)
      hiddenTabs: [],
      hiddenCategories: [],
      
      getUIStorageKey: (suffix) => {
          // Cl√© unique par projet et par utilisateur
          const projectId = state.currentProjectId || 'default';
          return `fmp_ui_${projectId}_${suffix}`;
      },
      
      initHiddenTabs: () => {
          // Charger depuis localStorage (pr√©f√©rence utilisateur, pas projet)
          try {
              const saved = localStorage.getItem(UI.getUIStorageKey('hiddenTabs'));
              UI.hiddenTabs = saved ? JSON.parse(saved) : [];
          } catch(e) {
              UI.hiddenTabs = [];
          }
          UI.applyHiddenTabs();
      },
      
      saveHiddenTabs: () => {
          // Sauvegarder en localStorage (par utilisateur)
          try {
              localStorage.setItem(UI.getUIStorageKey('hiddenTabs'), JSON.stringify(UI.hiddenTabs));
          } catch(e) {}
      },
      
      saveHiddenCategories: () => {
          // Sauvegarder en localStorage (par utilisateur)
          try {
              localStorage.setItem(UI.getUIStorageKey('hiddenCategories'), JSON.stringify(UI.hiddenCategories));
          } catch(e) {}
      },
      
      loadHiddenCategories: () => {
          // Charger depuis localStorage (pr√©f√©rence utilisateur)
          try {
              const saved = localStorage.getItem(UI.getUIStorageKey('hiddenCategories'));
              UI.hiddenCategories = saved ? JSON.parse(saved) : [];
          } catch(e) {
              UI.hiddenCategories = [];
          }
      },
      
      hideTab: (tabName) => {
          if(UI.hiddenTabs.includes(tabName)) return;
          
          // Emp√™cher de masquer le dernier onglet visible
          const allTabs = ['presentation', 'synopsis', 'board', 'titlepage', 'script', 'storyboard', 'chars', 'actors', 'locs', 'resources', 'crew', 'breakdown', 'stats', 'planning', 'expenses', 'chat'];
          const visibleTabs = allTabs.filter(t => !UI.hiddenTabs.includes(t) && t !== tabName);
          if(visibleTabs.length === 0) {
              Utils.toast('Impossible de masquer tous les onglets !', 'warning');
              return;
          }
          
          UI.hiddenTabs.push(tabName);
          
          // V√©rifier si tous les onglets d'une cat√©gorie sont maintenant cach√©s
          for(const [cat, tabs] of Object.entries(UI.categoryTabs)) {
              const allTabsHidden = tabs.every(t => UI.hiddenTabs.includes(t));
              if(allTabsHidden && !UI.hiddenCategories.includes(cat)) {
                  UI.hiddenCategories.push(cat);
              }
          }
          
          UI.saveHiddenTabs();
          UI.saveHiddenCategories();
          UI.applyHiddenTabs();
          UI.applyHiddenCategories();
          
          // Rafra√Æchir la sous-navigation en mode cat√©gories
          const navMode = (() => { try { return localStorage.getItem('fmp_nav_mode') || 'classic'; } catch(e) { return 'classic'; } })();
          if(navMode === 'categories') {
              if(UI.currentCategory) UI.switchCategory(UI.currentCategory);
          }
          
          // Si l'onglet masqu√© √©tait actif, basculer vers le premier visible
          const activeTab = document.querySelector('.tab-btn.active');
          if(activeTab && activeTab.getAttribute('data-tab') === tabName) {
              UI.switchTab(visibleTabs[0]);
          }
          
          Utils.toast('Onglet masqu√©', 'info');
      },
      
      toggleHiddenTabsCatMenu: (event, category) => {
          event.stopPropagation();
          const tabs = UI.categoryTabs[category] || [];
          const labels = UI.categoryLabels[category] || {};
          const hiddenInCategory = tabs.filter(t => UI.hiddenTabs.includes(t));
          
          if(hiddenInCategory.length === 0) return;
          
          // Cr√©er ou r√©cup√©rer le menu
          let menu = document.getElementById('hiddenTabsCatMenu');
          if(!menu) {
              menu = document.createElement('div');
              menu.id = 'hiddenTabsCatMenu';
              menu.className = 'hidden-tabs-menu';
              document.body.appendChild(menu);
          }
          
          // Positionner le menu
          const rect = event.target.getBoundingClientRect();
          menu.style.left = rect.left + 'px';
          menu.style.top = (rect.bottom + 5) + 'px';
          
          // G√©n√©rer le contenu
          let menuHtml = `
              <div class="hidden-tabs-menu-header">
                  <span>Onglets masqu√©s</span>
                  <button onclick="app.UI.showAllTabsInCategory('${category}')">Tout afficher</button>
              </div>
              <div class="hidden-tabs-menu-list">
          `;
          hiddenInCategory.forEach(tabName => {
              menuHtml += `<div class="hidden-tabs-menu-item" onclick="app.UI.showTab('${tabName}')">
                  <span>${labels[tabName] || tabName}</span>
                  <span style="color:var(--primary)">+ Afficher</span>
              </div>`;
          });
          menuHtml += '</div>';
          menu.innerHTML = menuHtml;
          menu.classList.add('visible');
          
          // Fermer au clic ailleurs
          setTimeout(() => {
              document.addEventListener('click', UI.closeHiddenTabsCatMenu, { once: true });
          }, 10);
      },
      
      closeHiddenTabsCatMenu: () => {
          const menu = document.getElementById('hiddenTabsCatMenu');
          if(menu) menu.classList.remove('visible');
      },
      
      showAllTabsInCategory: (category) => {
          const tabs = UI.categoryTabs[category] || [];
          tabs.forEach(tabName => {
              UI.hiddenTabs = UI.hiddenTabs.filter(t => t !== tabName);
          });
          UI.saveHiddenTabs();
          UI.applyHiddenTabs();
          UI.switchCategory(category);
          UI.closeHiddenTabsCatMenu();
          Utils.toast('Onglets restaur√©s', 'success');
      },
      
      // === GESTION DES CAT√âGORIES MASQU√âES ===
      hideCategory: (category) => {
          if(UI.hiddenCategories.includes(category)) return;
          
          // Emp√™cher de masquer la derni√®re cat√©gorie
          const allCategories = ['ecriture', 'casting', 'production', 'admin'];
          const visibleCategories = allCategories.filter(c => !UI.hiddenCategories.includes(c) && c !== category);
          if(visibleCategories.length === 0) {
              Utils.toast('Impossible de masquer toutes les cat√©gories !', 'warning');
              return;
          }
          
          UI.hiddenCategories.push(category);
          
          // Cacher aussi tous les onglets de cette cat√©gorie (pour synchroniser avec vue classique)
          const tabsInCategory = UI.categoryTabs[category] || [];
          tabsInCategory.forEach(tab => {
              if(!UI.hiddenTabs.includes(tab)) {
                  UI.hiddenTabs.push(tab);
              }
          });
          
          UI.saveHiddenCategories();
          UI.saveHiddenTabs();
          UI.applyHiddenCategories();
          UI.applyHiddenTabs();
          
          // Si la cat√©gorie masqu√©e √©tait active, basculer vers la premi√®re visible
          if(UI.currentCategory === category) {
              UI.switchCategory(visibleCategories[0]);
          }
          
          Utils.toast('Cat√©gorie masqu√©e', 'info');
      },
      
      showCategory: (category) => {
          UI.hiddenCategories = UI.hiddenCategories.filter(c => c !== category);
          
          // Restaurer aussi tous les onglets de cette cat√©gorie
          const tabsInCategory = UI.categoryTabs[category] || [];
          UI.hiddenTabs = UI.hiddenTabs.filter(t => !tabsInCategory.includes(t));
          
          UI.saveHiddenCategories();
          UI.saveHiddenTabs();
          UI.applyHiddenCategories();
          UI.applyHiddenTabs();
          UI.switchCategory(category);
          UI.closeHiddenCategoriesMenu();
          Utils.toast('Cat√©gorie restaur√©e', 'success');
      },
      
      showAllCategories: () => {
          // Restaurer toutes les cat√©gories et leurs onglets
          const allCategoryTabs = Object.values(UI.categoryTabs).flat();
          UI.hiddenTabs = UI.hiddenTabs.filter(t => !allCategoryTabs.includes(t));
          UI.hiddenCategories = [];
          UI.saveHiddenCategories();
          UI.saveHiddenTabs();
          UI.applyHiddenCategories();
          UI.applyHiddenTabs();
          Utils.toast('Toutes les cat√©gories sont visibles', 'success');
      },
      
      showAllHidden: () => {
          UI.hiddenCategories = [];
          UI.hiddenTabs = [];
          UI.saveHiddenCategories();
          UI.saveHiddenTabs();
          UI.applyHiddenCategories();
          UI.applyHiddenTabs();
          if(UI.currentCategory) UI.switchCategory(UI.currentCategory);
          UI.closeHiddenCategoriesMenu();
          Utils.toast('Tous les √©l√©ments sont visibles', 'success');
      },
      
      applyHiddenCategories: () => {
          // Masquer/afficher les cat√©gories
          document.querySelectorAll('.tab-category[data-category]').forEach(cat => {
              const catName = cat.getAttribute('data-category');
              cat.style.display = UI.hiddenCategories.includes(catName) ? 'none' : '';
          });
          
          // Mettre √† jour le bouton des √©l√©ments masqu√©s (cat√©gories + onglets)
          const toggle = document.getElementById('hiddenCategoriesToggle');
          const countBadge = document.getElementById('hiddenCategoriesCount');
          
          if(toggle && countBadge) {
              const totalHidden = UI.hiddenCategories.length + UI.hiddenTabs.length;
              if(totalHidden > 0) {
                  toggle.style.display = 'flex';
                  countBadge.textContent = totalHidden;
              } else {
                  toggle.style.display = 'none';
              }
          }
      },
      
      toggleHiddenCategoriesMenu: (event) => {
          event.stopPropagation();
          
          const categoryLabels = {
              'ecriture': 'üìù √âcriture',
              'casting': 'üé≠ Casting & D√©cors',
              'production': 'üé¨ Production',
              'admin': 'üìä Admin'
          };
          
          const tabLabels = {
              'presentation': 'Pr√©sentation', 'synopsis': 'Synopsis', 'board': 'S√©quencier',
              'titlepage': 'Titre', 'script': 'Sc√©nario', 'storyboard': 'Storyboard', 'chars': 'Personnages',
              'actors': 'Com√©dien.nes', 'locs': 'D√©cors', 'resources': 'Ressources', 'crew': '√âquipes',
              'breakdown': 'D√©pouillement', 'stats': 'Statistiques', 'planning': 'Planning',
              'scriptreport': 'Rapport', 'expenses': 'D√©penses', 'chat': 'Chat'
          };
          
          const hasHiddenCategories = UI.hiddenCategories.length > 0;
          const hasHiddenTabs = UI.hiddenTabs.length > 0;
          
          if(!hasHiddenCategories && !hasHiddenTabs) return;
          
          // Cr√©er ou r√©cup√©rer le menu
          let menu = document.getElementById('hiddenCategoriesMenu');
          if(!menu) {
              menu = document.createElement('div');
              menu.id = 'hiddenCategoriesMenu';
              menu.className = 'hidden-tabs-menu';
              document.body.appendChild(menu);
          }
          
          // Positionner le menu
          const rect = event.target.getBoundingClientRect();
          menu.style.left = Math.min(rect.left, window.innerWidth - 250) + 'px';
          menu.style.top = (rect.bottom + 5) + 'px';
          
          // G√©n√©rer le contenu
          let menuHtml = `
              <div class="hidden-tabs-menu-header">
                  <span>√âl√©ments masqu√©s</span>
                  <button onclick="app.UI.showAllHidden()">Tout afficher</button>
              </div>
              <div class="hidden-tabs-menu-list">
          `;
          
          // Cat√©gories masqu√©es
          if(hasHiddenCategories) {
              menuHtml += `<div style="font-size:0.75rem; color:var(--text-sec); padding:8px 12px; border-bottom:1px solid var(--border);">üìÅ Cat√©gories</div>`;
              UI.hiddenCategories.forEach(catName => {
                  menuHtml += `<div class="hidden-tabs-menu-item" onclick="app.UI.showCategory('${catName}')">
                      <span>${categoryLabels[catName] || catName}</span>
                      <span style="color:var(--primary)">+ Afficher</span>
                  </div>`;
              });
          }
          
          // Onglets masqu√©s
          if(hasHiddenTabs) {
              menuHtml += `<div style="font-size:0.75rem; color:var(--text-sec); padding:8px 12px; border-bottom:1px solid var(--border); ${hasHiddenCategories ? 'margin-top:5px;' : ''}">üìë Onglets</div>`;
              UI.hiddenTabs.forEach(tabName => {
                  menuHtml += `<div class="hidden-tabs-menu-item" onclick="app.UI.showTab('${tabName}')">
                      <span>${tabLabels[tabName] || tabName}</span>
                      <span style="color:var(--primary)">+ Afficher</span>
                  </div>`;
              });
          }
          
          menuHtml += '</div>';
          menu.innerHTML = menuHtml;
          menu.classList.add('visible');
          
          // Fermer au clic ailleurs
          setTimeout(() => {
              document.addEventListener('click', UI.closeHiddenCategoriesMenu, { once: true });
          }, 10);
      },
      
      closeHiddenCategoriesMenu: () => {
          const menu = document.getElementById('hiddenCategoriesMenu');
          if(menu) menu.classList.remove('visible');
      },
      
      showTab: (tabName) => {
          UI.hiddenTabs = UI.hiddenTabs.filter(t => t !== tabName);
          
          // Restaurer la cat√©gorie correspondante si elle √©tait cach√©e
          for(const [cat, tabs] of Object.entries(UI.categoryTabs)) {
              if(tabs.includes(tabName) && UI.hiddenCategories.includes(cat)) {
                  UI.hiddenCategories = UI.hiddenCategories.filter(c => c !== cat);
              }
          }
          
          UI.saveHiddenTabs();
          UI.saveHiddenCategories();
          UI.applyHiddenTabs();
          UI.applyHiddenCategories();
          UI.switchTab(tabName);
          Utils.toast('Onglet restaur√©', 'success');
      },
      
      showAllTabs: () => {
          UI.hiddenTabs = [];
          UI.hiddenCategories = [];
          UI.saveHiddenTabs();
          UI.saveHiddenCategories();
          UI.applyHiddenTabs();
          UI.applyHiddenCategories();
          Utils.toast('Tous les onglets sont visibles', 'success');
      },
      
      applyHiddenTabs: () => {
          const tabLabels = {
              'presentation': '1. PR√âSENTATION', 'synopsis': '2. SYNOPSIS', 'board': '3. S√âQUENCIER',
              'titlepage': '4. TITRE', 'script': '5. SC√âNARIO', 'moodboard': '6. MOOD BOARD', 'storyboard': '7. STORYBOARD', 'chars': '8. PERSONNAGES',
              'actors': '9. COM√âDIEN.NES', 'locs': '10. D√âCORS', 'resources': '11. RESSOURCES', 'crew': '12. √âQUIPES',
              'breakdown': '13. D√âPOUILLEMENT', 'stats': '14. STATISTIQUES', 'planning': '15. PLANNING',
              'expenses': '16. D√âPENSES', 'chat': '17. CHAT'
          };
          
          // Masquer/afficher les onglets
          document.querySelectorAll('.tab-btn[data-tab]').forEach(tab => {
              const tabName = tab.getAttribute('data-tab');
              tab.style.display = UI.hiddenTabs.includes(tabName) ? 'none' : '';
          });
          
          // Mettre √† jour le bouton et le menu des onglets masqu√©s
          const toggle = document.getElementById('hiddenTabsToggle');
          const countBadge = document.getElementById('hiddenTabsCount');
          const menu = document.getElementById('hiddenTabsMenu');
          
          if(UI.hiddenTabs.length > 0) {
              toggle.style.display = '';
              countBadge.textContent = UI.hiddenTabs.length;
              
              // G√©n√©rer le menu
              let menuHtml = `
                  <div class="hidden-tabs-menu-header">
                      <span>Onglets masqu√©s</span>
                      <button onclick="app.UI.showAllTabs()">Tout afficher</button>
                  </div>
                  <div class="hidden-tabs-menu-list">
              `;
              UI.hiddenTabs.forEach(tabName => {
                  menuHtml += `<div class="hidden-tabs-menu-item" onclick="app.UI.showTab('${tabName}')">
                      <span>${tabLabels[tabName] || tabName}</span>
                      <span style="color:var(--success);">‚Ü©</span>
                  </div>`;
              });
              menuHtml += '</div>';
              menu.innerHTML = menuHtml;
          } else {
              toggle.style.display = 'none';
              menu.classList.remove('visible');
          }
          
          // Synchroniser avec la vue cat√©gories
          const navMode = (() => { try { return localStorage.getItem('fmp_nav_mode') || 'classic'; } catch(e) { return 'classic'; } })();
          if(navMode === 'categories' && UI.currentCategory) {
              UI.switchCategory(UI.currentCategory);
          }
      },
      
      toggleHiddenTabsMenu: (event) => {
          const menu = document.getElementById('hiddenTabsMenu');
          
          // Si d√©j√† visible, fermer
          if(menu.classList.contains('visible')) {
              menu.classList.remove('visible');
              return;
          }
          
          // Positionner pr√®s du bouton cliqu√©
          const rect = event.target.closest('.tab-btn-hidden-toggle').getBoundingClientRect();
          menu.style.top = (rect.bottom + 5) + 'px';
          menu.style.left = Math.min(rect.left, window.innerWidth - 240) + 'px';
          
          menu.classList.add('visible');
          
          // Fermer au clic ext√©rieur
          setTimeout(() => {
              document.addEventListener('click', UI.closeHiddenTabsMenu);
          }, 10);
      },
      
      closeHiddenTabsMenu: (e) => {
          const menu = document.getElementById('hiddenTabsMenu');
          const toggle = document.getElementById('hiddenTabsToggle');
          if(!menu.contains(e?.target) && !toggle.contains(e?.target)) {
              menu.classList.remove('visible');
              document.removeEventListener('click', UI.closeHiddenTabsMenu);
          }
      },

      switchTab: (tabName) => { 
    // Mapping des onglets vers les sections de permissions
    const tabToSection = {
        'presentation': 'presentation', 'synopsis': 'synopsis', 'board': 'sequencier', 'titlepage': 'scenario',
        'script': 'scenario', 'storyboard': 'storyboard', 'chars': 'personnages', 'locs': 'lieux',
        'actors': 'comediens', 'resources': 'ressources', 'crew': 'equipe', 'breakdown': 'depouillement',
        'stats': 'stats', 'planning': 'planning'
    };
    
    const section = tabToSection[tabName];
    
    // V√©rifier les permissions (sauf pour le propri√©taire)
    if(state.currentRole !== 'owner' && section && !Permissions.canAccess(section)) {
        Utils.toast('Vous n\'avez pas acc√®s √† cette section.', 'error');
        return;
    }
    
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); 
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); 
    document.getElementById('tab-' + tabName).classList.add('active'); 
    const idx = ['presentation', 'synopsis','board', 'titlepage', 'script', 'storyboard', 'chars', 'actors', 'locs', 'resources', 'crew', 'breakdown', 'stats', 'planning', 'expenses', 'chat'].indexOf(tabName); 
    if(idx > -1) document.querySelectorAll('.tab-btn')[idx].classList.add('active');
    
    // Synchroniser avec le mode cat√©gories si actif
    const tabsCategories = document.getElementById('tabsCategories');
    if(tabsCategories && tabsCategories.classList.contains('active')) {
        const category = UI.getCategoryForTab(tabName);
        if(category !== UI.currentCategory) {
            UI.currentCategory = category;
            document.querySelectorAll('.tab-category').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });
            // Reconstruire la sous-nav
            const subnav = document.getElementById('tabsSubnav');
            const tabs = UI.categoryTabs[category] || [];
            const labels = UI.categoryLabels[category] || {};
            subnav.innerHTML = tabs.map(tab => {
                return `<button class="tab-subbtn${tab === tabName ? ' active' : ''}" data-tab="${tab}" onclick="app.UI.switchTab('${tab}')">${labels[tab] || tab}</button>`;
            }).join('');
        }
        // Mettre √† jour le bouton actif dans la sous-nav
        document.querySelectorAll('.tab-subbtn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
    }
          
          if(tabName === 'board' || tabName === 'script') {
              els.quickNav.style.display = 'flex';
              UI.updateQuickNav();
          } else {
              els.quickNav.style.display = 'none';
          }
          if(tabName === 'script') UI.renderScript(); 
          if(tabName === 'board') UI.renderBoard(); 
          if(tabName === 'chars') { Actions.syncCharacters(); Store.save(); UI.renderDataTab('characters', els.charContainer); } 
          if(tabName === 'actors') { Actions.syncActorsFromPublicProfiles().then(() => UI.renderDataTab('actors', els.actorContainer)); } 
          if(tabName === 'locs') { Actions.syncLocations(); Store.save(); UI.renderDataTab('locations', els.locContainer); } 
          if(tabName === 'resources') { Resources.init(); }
          if(tabName === 'breakdown') { Crew.syncEssentialCrewToScenes(); Store.save(); Breakdown.init(); } 
          if(tabName === 'planning') { Planning.init(); Planning.applyPermissions(); }
          if(tabName === 'scriptreport') { ScriptReport.init(); }
          if(tabName === 'stats') Stats.render();
          if(tabName === 'titlepage') TitlePage.load(); 
          if(tabName === 'storyboard') Storyboard.init();
          if(tabName === 'moodboard') MoodBoard.init();
          if(tabName === 'crew') { Actions.syncCrewFromPublicProfiles().then(() => UI.renderCrewTab()); }
          if(tabName === 'chat') Chat.init();
          if(tabName === 'expenses') Expenses.init();
          if(tabName === 'presentation') Presentation.init();
      },
      
      // Ouvre le menu d√©roulant pour changer le statut d'une sc√®ne
      toggleSceneStatus: (sceneId, event) => {
          if(state.currentRole === 'viewer') return;
          event.stopPropagation();
          
          // Fermer tout menu ouvert et le supprimer
          document.querySelectorAll('.scene-status-dropdown').forEach(d => d.remove());
          
          // Cr√©er le dropdown dans le body pour √©viter les probl√®mes d'overflow
          const rect = event.target.getBoundingClientRect();
          
          const dropdown = document.createElement('div');
          dropdown.className = 'scene-status-dropdown visible';
          dropdown.style.top = (rect.bottom + 5) + 'px';
          dropdown.style.left = rect.left + 'px';
          dropdown.innerHTML = `
              <div class="scene-status-option" onclick="event.stopPropagation(); app.UI.setSceneStatus('${sceneId}', 'not-verified')">
                  <span class="status-dot not-verified"></span> Non v√©rifi√©
              </div>
              <div class="scene-status-option" onclick="event.stopPropagation(); app.UI.setSceneStatus('${sceneId}', 'to-work')">
                  <span class="status-dot to-work"></span> √Ä travailler
              </div>
              <div class="scene-status-option" onclick="event.stopPropagation(); app.UI.setSceneStatus('${sceneId}', 'verified')">
                  <span class="status-dot verified"></span> V√©rifi√©
              </div>
          `;
          document.body.appendChild(dropdown);
          
          // Fermer au clic ailleurs
          setTimeout(() => {
              const closeHandler = (e) => {
                  if(!dropdown.contains(e.target)) {
                      dropdown.remove();
                      document.removeEventListener('click', closeHandler);
                  }
              };
              document.addEventListener('click', closeHandler);
          }, 10);
      },
      
      // Changer le statut d'une sc√®ne via menu
      setSceneStatus: (sceneId, status) => {
          if(state.currentRole === 'viewer') return;
          
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          
          scene.status = status;
          Store.save();
          
          // Supprimer le dropdown
          document.querySelectorAll('.scene-status-dropdown').forEach(d => d.remove());
          
          UI.renderScript();
          UI.renderBoard();
          Breakdown.init();
          Storyboard.renderScenesList();
          Storyboard.renderScenesList();
          
          const statusMessages = { 'not-verified': 'Non v√©rifi√©', 'to-work': '√Ä travailler', 'verified': 'V√©rifi√©' };
          Utils.toast(`Sc√®ne : ${statusMessages[status]}`, 'success');
      },
      
      updateQuickNav: () => {
          els.quickNav.innerHTML = '';
          state.data.scenes.forEach((s, i) => {
              const a = document.createElement('div');
              a.className = 'qn-link';
              a.innerText = (i + 1);
              a.title = s.title;
              a.onclick = () => {
                  const activeTab = document.querySelector('.tab-content.active').id;
                  if(activeTab === 'tab-script') {
                      // V√©rifier si on est en Vue Sc√®nes ou Vue Script Continue
                      const isContinuousView = document.getElementById('scriptContinuousContainer')?.style.display !== 'none';
                      if(isContinuousView) {
                          // Vue Script Continue
                          const el = document.querySelector(`.script-continuous-scene[data-scene-id="${s.id}"]`);
                          if(el) {
                              el.scrollIntoView({behavior: "smooth", block: "start"});
                              ScriptEditor.setActiveScene(s.id, i);
                          }
                      } else {
                          // Vue Sc√®nes
                          const el = document.querySelector(`.script-row[data-id="${s.id}"]`);
                          if(el) el.scrollIntoView({behavior: "smooth", block: "start"});
                      }
                  } else if (activeTab === 'tab-board') {
                       const el = document.querySelector(`.card[data-id="${s.id}"]`);
                       if(el) el.scrollIntoView({behavior: "smooth", block: "center"});
                  }
              };
              els.quickNav.appendChild(a);
          });
      },
      
      renderBoard: () => { 
          els.boardList.innerHTML = ''; 
          const isView = state.currentRole === 'viewer'; 
          state.data.scenes.forEach((s, idx) => { 
              const el = document.createElement('div'); 
              const isFinal = s.isFinal === true;
              el.className = 'card ' + (isFinal ? 'is-final' : 'is-draft'); 
              el.draggable = !isView; el.dataset.id = s.id; 
              const tag = state.data.tags.find(t => t.id === s.tag_id) || {name:'', color: 'transparent'}; 
              if(tag.color !== 'transparent') el.style.borderLeftColor = tag.color; 
              const badge = tag.color !== 'transparent' ? `<span class="tag-badge" style="background:${tag.color}" title="${Utils.escape(tag.name)}"></span>` : ''; 
              const commentBtn = `<span class="comment-badge" data-scene="${s.id}" onclick="event.stopPropagation(); app.Comments.open('${s.id}')" title="Commentaires" style="display:none;">0</span>`;
              const sceneStatus = s.status || 'not-verified';
              const statusLabels = { 'not-verified': 'üî¥', 'to-work': 'üü°', 'verified': 'üü¢' };
              const statusBadge = `<div class="scene-status-container"><span class="scene-status-badge ${sceneStatus}" onclick="app.UI.toggleSceneStatus('${s.id}', event)">${statusLabels[sceneStatus]}</span></div>`;
              const finalBadge = isFinal ? `<span class="scene-status-badge final">‚úÖ Finale</span>` : `<span class="scene-status-badge draft">üìù Brouillon</span>`;
              const finalizeBtn = isView ? '' : (isFinal 
                  ? `<button class="unfinalize-btn" onclick="event.stopPropagation(); app.Actions.unfinalizeScene('${s.id}')">üìù Repasser en brouillon</button>`
                  : `<button class="finalize-btn" onclick="event.stopPropagation(); app.Actions.finalizeScene('${s.id}')">‚úÖ Finaliser</button>`);
              const actions = isView ? '' : `<div class="card-actions"><button onclick="event.stopPropagation(); app.Actions.editScene('${s.id}')">‚úèÔ∏è</button><button onclick="event.stopPropagation(); app.Actions.deleteScene('${s.id}')" style="color:var(--danger);border-color:var(--danger)">üóëÔ∏è</button></div>`; 
              el.innerHTML = `${actions}<h3>${badge}${Utils.escape(s.title)} <small>#${idx + 1}</small> ${finalBadge}${commentBtn}</h3><div style="margin: 5px 0;">${statusBadge}</div><div class="meta">${Utils.escape(s.perso)} ‚Ä¢ ${Utils.escape(s.time)} min</div><div class="resume-text">${Utils.escape(s.resume)}</div><div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;"><button onclick="event.stopPropagation(); app.Comments.open('${s.id}')" style="padding:5px 10px; background:var(--bg); border:1px solid var(--border); border-radius:4px; cursor:pointer; font-size:0.8rem;">üí¨ Commentaires</button>${finalizeBtn}</div>`; 
              if(!isView) { 
                  el.addEventListener('contextmenu', (e) => Actions.openTagMenu(e, s.id)); 
                  el.addEventListener('dragstart', ()=>el.classList.add('dragging')); 
                  el.addEventListener('dragend', ()=>{el.classList.remove('dragging'); Actions.updateOrder('board');}); 
              } 
              els.boardList.appendChild(el); 
          }); 
          UI.updateQuickNav();
          UI.loadBoardMode();
          Comments.updateAllBadges();
      },
      
      renderScript: () => { 
          // Si vue continue active, mettre √† jour aussi cette vue
          if(ScriptEditor.viewMode === 'continuous') {
              ScriptEditor.renderContinuous();
          }
          
          const focusedId = document.activeElement && document.activeElement.closest('.script-row') ? document.activeElement.closest('.script-row').dataset.id : null; 
          els.scriptContainer.innerHTML = ''; 
          if(state.data.scenes.length === 0) { els.scriptContainer.innerHTML = '<div style="text-align:center;margin-top:50px;color:var(--text-sec)">Ajoutez des sc√®nes pour commencer.</div>'; return; } 
          const isView = state.currentRole === 'viewer' || !Permissions.canEdit('scenario'); 
          state.data.scenes.forEach((scene, idx) => { 
              const row = document.createElement('div'); 
              const sceneIsFinal = scene.isFinal === true;
              row.className = 'script-row ' + (sceneIsFinal ? 'is-final' : 'is-draft'); 
              row.draggable = false; row.dataset.id = scene.id; 
              const contentHtml = scene.scriptContent || "<div class='sc-action'><br></div>"; 
              const tag = state.data.tags.find(t => t.id === scene.tag_id) || {name:'', color: 'transparent'}; 
              const infoStyle = tag.color !== 'transparent' ? `border-left-color:${tag.color}` : ''; 
              const badge = tag.color !== 'transparent' ? `<span class="tag-badge" style="background:${tag.color}" title="${Utils.escape(tag.name)}"></span>` : ''; 
              
              const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
              const versionCount = scene.versions ? scene.versions.length : 0;
              const sceneStatus = scene.status || 'not-verified';
              const statusLabels = { 'not-verified': 'üî¥', 'to-work': 'üü°', 'verified': 'üü¢' };
              const statusBadge = `<div class="scene-status-container" style="margin-left:10px;"><span class="scene-status-badge ${sceneStatus}" onclick="app.UI.toggleSceneStatus('${scene.id}', event)">${statusLabels[sceneStatus]}</span></div>`;
              const isFinal = scene.isFinal === true;
              const finalBadge = isFinal ? `<span class="scene-status-badge final">‚úÖ Finale</span>` : `<span class="scene-status-badge draft">üìù Brouillon</span>`;
              const finalizeBtn = isView ? '' : (isFinal 
                  ? `<button class="unfinalize-btn" onclick="event.stopPropagation(); app.Actions.unfinalizeScene('${scene.id}')" style="width:100%;">üìù Repasser en brouillon</button>`
                  : `<button class="finalize-btn" onclick="event.stopPropagation(); app.Actions.finalizeScene('${scene.id}')" style="width:100%;">‚úÖ Finaliser cette sc√®ne</button>`);
              const sidebarBtns = `
                  <div class="script-sidebar-btns">
                      <button onclick="event.stopPropagation(); app.StoryboardPreview.open('${scene.id}')">üì∑ Storyboard (${shotCount})</button>
                      <button onclick="event.stopPropagation(); app.Comments.open('${scene.id}')">üí¨ Commentaires <span class="comment-badge" data-scene="${scene.id}" style="display:none;">0</span></button>
                      <hr style="border:none; border-top:1px solid var(--border); margin:8px 0;">
                      <button onclick="event.stopPropagation(); app.SceneVersions.save('${scene.id}')">üì∏ Sauvegarder version</button>
                      <button onclick="event.stopPropagation(); app.SceneVersions.openModal('${scene.id}')">üìú Historique${versionCount > 0 ? ' (' + versionCount + ')' : ''}</button>
                      <hr style="border:none; border-top:1px solid var(--border); margin:8px 0;">
                      <div style="text-align:center; margin-bottom:5px;">${finalBadge}</div>
                      ${finalizeBtn}
                      <hr style="border:none; border-top:1px solid var(--border); margin:8px 0;">
                      <button onclick="event.stopPropagation(); app.ScriptEditor.openSearchReplace()">üîç Rechercher</button>
                      <button onclick="event.stopPropagation(); app.ScriptImport.openModal()">üìÑ Importer PDF/FDX</button>
                  </div>
              `;
              row.innerHTML = `<div class="lock-overlay">üîí</div><div class="script-info-col" style="${infoStyle}"><h3 style="cursor:context-menu; display:flex; align-items:center; flex-wrap:wrap;">${badge}${Utils.escape(scene.title)}${statusBadge}</h3><div style="margin-bottom:10px;font-size:0.8em">#${idx+1} ‚Ä¢ ${Utils.escape(scene.time)} min</div><div style="margin-bottom:10px; font-size:0.85rem; color:var(--text-main); font-weight:normal;">${Utils.escape(scene.perso)}</div><strong>R√©sum√©:</strong><p>${Utils.escape(scene.resume)||'-'}</p>${sidebarBtns}</div><div class="script-write-col"><div class="scene-heading-print">${Utils.escape(scene.title)}</div><div class="format-bar scene-format-bar" id="toolbar-${scene.id}" style="display:none;"><button class="fmt-btn nav-btn" onclick="app.ScriptEditor.goToScene(${idx - 1})" ${idx === 0 ? 'disabled style="opacity:0.4"' : ''} title="Sc√®ne pr√©c√©dente">‚¨ÖÔ∏è</button><button class="fmt-btn active" data-type="sc-action" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-action', event)" title="Action">Action</button><button class="fmt-btn" data-type="sc-perso" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-perso', event)" title="Personnage">Perso</button><button class="fmt-btn" data-type="sc-dial" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-dial', event)" title="Dialogue">Dial</button><button class="fmt-btn" data-type="sc-paren" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-paren', event)" title="Didascalie">Didas</button><button class="fmt-btn" data-type="sc-trans" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-trans', event)" title="Transition">Trans</button><button class="fmt-btn" data-type="sc-centered" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-centered', event)" title="Centr√©">Centr√©</button><button class="fmt-btn" data-type="sc-note" onmousedown="app.ScriptEditor.format(${scene.id}, 'sc-note', event)" title="Note">Note</button><span class="scene-nav-indicator">${idx + 1}/${state.data.scenes.length}</span><button class="fmt-btn" onclick="app.ScriptEditor.insertSceneAfter(${idx})" title="Ins√©rer nouvelle sc√®ne apr√®s">‚ûï</button><button class="fmt-btn nav-btn" onclick="app.ScriptEditor.goToScene(${idx + 1})" ${idx === state.data.scenes.length - 1 ? 'disabled style="opacity:0.4"' : ''} title="Sc√®ne suivante">‚û°Ô∏è</button></div><div class="script-editor-box" contenteditable="${!isView}" spellcheck="true" lang="fr" id="editor-${scene.id}">${contentHtml}</div></div>`;
              els.scriptContainer.appendChild(row); 
              if(!isView) { 
                  const handle = row.querySelector('.script-info-col'); 
                  handle.addEventListener('contextmenu', (e) => Actions.openTagMenu(e, scene.id)); 
                  handle.addEventListener('mousedown', (e) => { if(e.button===0) row.setAttribute('draggable', 'true'); }); 
                  handle.addEventListener('mouseup', () => row.setAttribute('draggable', 'false')); 
                  row.addEventListener('dragstart', () => row.classList.add('dragging')); 
                  row.addEventListener('dragend', () => { row.classList.remove('dragging'); row.setAttribute('draggable', 'false'); Actions.updateOrder('script'); }); 
                  const editor = document.getElementById(`editor-${scene.id}`); const toolbar = document.getElementById(`toolbar-${scene.id}`); 
                  editor.addEventListener('input', () => { const s = state.data.scenes.find(x => x.id === scene.id); if(s) s.scriptContent = editor.innerHTML; ScriptEditor.checkAC(editor); Store.updateScene(scene.id, editor.innerHTML); }); 
                  ['keyup', 'mouseup', 'click'].forEach(evt => editor.addEventListener(evt, () => ScriptEditor.updateToolbar(editor, toolbar))); 
                  editor.addEventListener('keydown', (e) => ScriptEditor.handleKey(e, editor, toolbar, scene.id)); 
                  editor.addEventListener('focus', () => Store.acquireLock(scene.id)); 
                  editor.addEventListener('blur', () => Store.releaseLock(scene.id)); 
              } 
          }); 
          UI.applyLocks(); 
          UI.updateQuickNav();
          Comments.updateAllBadges();
      },
      
      renderDataTab: (type, container) => {
          const arr = state.data[type]; container.innerHTML = '';
          if(!arr || arr.length === 0) { 
              const emptyStates = {
                  characters: {
                      icon: 'üé≠',
                      title: 'Aucun personnage',
                      desc: 'Ajoutez les personnages de votre histoire. Ils pourront ensuite √™tre li√©s aux com√©diens et appara√Ætront dans le d√©pouillement.',
                      btn: '+ Ajouter un personnage',
                      action: 'app.Actions.addDataItem(\'characters\')'
                  },
                  actors: {
                      icon: 'üé¨',
                      title: 'Aucun com√©dien',
                      desc: 'Constituez votre casting en ajoutant des com√©diens. Vous pourrez les associer aux personnages et g√©rer leurs disponibilit√©s.',
                      btn: '+ Ajouter un com√©dien',
                      action: 'app.Actions.addDataItem(\'actors\')'
                  },
                  locations: {
                      icon: 'üè†',
                      title: 'Aucun d√©cor',
                      desc: 'Ajoutez les d√©cors de votre sc√©nario. Vous pourrez ensuite renseigner les lieux r√©els de tournage avec adresse et contact.',
                      btn: '+ Ajouter un d√©cor',
                      action: 'app.Actions.addDataItem(\'locations\')'
                  }
              };
              const es = emptyStates[type] || { icon: 'üìÅ', title: 'Aucune donn√©e', desc: '', btn: '+ Ajouter', action: '' };
              container.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">${es.icon}</div>
                      <div class="empty-state-title">${es.title}</div>
                      <div class="empty-state-desc">${es.desc}</div>
                      <button class="empty-state-btn" onclick="${es.action}">${es.btn}</button>
                      <div class="empty-state-tips">üí° <strong>Astuce :</strong> Vous pouvez aussi importer depuis un sc√©nario existant via le menu Fichier.</div>
                  </div>
              `;
              return; 
          } 
          
          // D√©terminer les permissions selon le type
          const typeToSection = { 'characters': 'personnages', 'actors': 'comediens', 'locations': 'lieux' };
          const sectionName = typeToSection[type];
          const isView = state.currentRole === 'viewer' || (sectionName && !Permissions.canEdit(sectionName)); 
          let groupType = '';
          if(type === 'characters') groupType = 'perso'; else if(type === 'actors') groupType = 'actor'; else if(type === 'locations') groupType = 'lieu';

          const relevantGroups = state.data.groups.filter(g => g.type === groupType);
          
          // Barre de toggle vue compacte / d√©taill√©e
          const viewMode = CardModal.getViewMode(type);
          const toggleBar = document.createElement('div');
          toggleBar.className = 'view-toggle-bar';
          toggleBar.innerHTML = `
              <button class="view-toggle-btn ${viewMode === 'compact' ? 'active' : ''}" onclick="app.CardModal.setViewMode('${type}', 'compact')">üî≤ Compact</button>
              <button class="view-toggle-btn ${viewMode === 'detailed' ? 'active' : ''}" onclick="app.CardModal.setViewMode('${type}', 'detailed')">üìã D√©taill√©</button>
          `;
          container.appendChild(toggleBar);
          
          if(viewMode === 'compact') {
              // Vue compacte : grille de petites cartes
              relevantGroups.forEach(grp => {
                  const itemsInGroup = arr.filter(item => item.group_id === grp.id);
                  if(itemsInGroup.length > 0) {
                      const section = document.createElement('div'); section.className = 'group-section';
                      section.innerHTML = `<div class="group-header">${grp.name}</div><div class="compact-cards-grid"></div>`;
                      const grid = section.querySelector('.compact-cards-grid');
                      CardModal.renderCompactCards(itemsInGroup, type, grid);
                      container.appendChild(section);
                  }
              });
              const noGroup = arr.filter(item => !item.group_id || !relevantGroups.find(g => g.id === item.group_id));
              if(noGroup.length > 0) {
                  const section = document.createElement('div'); section.className = 'group-section';
                  section.innerHTML = `<div class="group-header" style="color:var(--text-sec); border-color:var(--border)">Non class√©</div><div class="compact-cards-grid"></div>`;
                  const grid = section.querySelector('.compact-cards-grid');
                  CardModal.renderCompactCards(noGroup, type, grid);
                  container.appendChild(section);
              }
          } else {
              // Vue d√©taill√©e : fiches compl√®tes (ancien mode)
              relevantGroups.forEach(grp => {
                  const itemsInGroup = arr.filter(item => item.group_id === grp.id);
                  if(itemsInGroup.length > 0) {
                      const section = document.createElement('div'); section.className = 'group-section';
                      section.innerHTML = `<div class="group-header">${grp.name}</div><div class="data-grid"></div>`;
                      const grid = section.querySelector('.data-grid');
                      UI.renderDataCards(itemsInGroup, type, grid, relevantGroups);
                      container.appendChild(section);
                  }
              });
              const noGroup = arr.filter(item => !item.group_id || !relevantGroups.find(g => g.id === item.group_id));
              if(noGroup.length > 0) {
                  const section = document.createElement('div'); section.className = 'group-section';
                  section.innerHTML = `<div class="group-header" style="color:var(--text-sec); border-color:var(--border)">Non class√©</div><div class="data-grid"></div>`;
                  const grid = section.querySelector('.data-grid');
                  UI.renderDataCards(noGroup, type, grid, relevantGroups);
                  container.appendChild(section);
              }
          }
      },
      
      renderDataCards: (items, type, container, availableGroups) => {
          const isView = state.currentRole === 'viewer';
          items.forEach((item) => { 
              const idx = state.data[type].indexOf(item);
              const div = document.createElement('div'); div.className = 'data-card'; 
              const delBtn = isView ? '' : `<button onclick="app.Actions.deleteDataItem('${type}', ${idx})" style="color:var(--danger);border:none;background:none;cursor:pointer">üóëÔ∏è</button>`; 
              
              let groupSelect = '';
              if(!isView) {
                  groupSelect = `<select class="group-select" onchange="app.Actions.changeGroup('${type}', ${idx}, this.value)">`;
                  groupSelect += `<option value="">-- Groupe --</option>`;
                  availableGroups.forEach(g => { groupSelect += `<option value="${g.id}" ${item.group_id === g.id ? 'selected' : ''}>${g.name}</option>`; });
                  groupSelect += `</select>`;
              }

              let contentHtml = '';
              if (type === 'actors') {
                  // V√©rifier si le profil est verrouill√© (revendiqu√© par quelqu'un)
                  const isLocked = !!item.publicProfileId;
                  const isReadOnly = isView || isLocked;
                  
                  // Trouver le personnage que cet acteur joue
                  const linkedCharacter = state.data.characters.find(c => c.actor_id === item.id);
                  
                  contentHtml += `<div class="actor-card-header">`;
                  if(item.photo) contentHtml += `<img src="${item.photo}" class="actor-photo-preview">`;
                  const isInContacts = state.contacts && state.contacts.actors && state.contacts.actors.some(c => c.id === item.id);
                  const lockedBadge = isLocked ? `<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">üîí Profil revendiqu√©</span>` : '';
                  contentHtml += `<div style="flex-grow:1;"><div style="font-weight:bold; font-size:1rem; margin-bottom:5px; display:flex; align-items:center; gap:8px;">${Utils.escape(item.name)} ${lockedBadge} ${!isView ? `<button class="save-contact-btn ${isInContacts ? 'saved' : ''}" onclick="event.stopPropagation(); app.Contacts.saveActorToContacts(${idx})" title="${isInContacts ? 'D√©j√† dans vos contacts' : 'Sauvegarder dans contacts'}">${isInContacts ? '‚≠ê' : '‚òÜ'}</button>` : ''}</div>`;
                  contentHtml += `<select class="actor-input" style="margin-bottom:5px; width:auto;" onchange="app.Actions.updateActorMeta(${idx}, 'gender', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      ${ProfileRenderer.selectOptions.gender.map(o => '<option value="'+o.value+'" '+(item.gender === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                  </select>`;
                  
                  // Afficher le r√¥le
                  if(linkedCharacter) {
                      contentHtml += `<div style="color:var(--primary); font-size:0.9rem; margin-bottom:5px;">üé≠ Joue : <strong>${Utils.escape(linkedCharacter.name)}</strong></div>`;
                  } else {
                      contentHtml += `<div style="color:var(--text-sec); font-size:0.85rem; margin-bottom:5px; font-style:italic;">Aucun personnage li√©</div>`;
                  }
                  
                  if(!isReadOnly) contentHtml += `<input class="actor-input" placeholder="URL Photo" value="${item.photo||''}" onchange="app.Actions.updateActorMeta(${idx}, 'photo', this.value)">`;
                  contentHtml += `</div>${delBtn}</div>`;
                  contentHtml += `<div class="actor-input-row" style="margin-top:10px;">`;
                  contentHtml += `<input class="actor-input" placeholder="Email" value="${item.email||''}" onchange="app.Actions.updateActorMeta(${idx}, 'email', this.value)" ${isReadOnly?'disabled':''}>`;
                  contentHtml += `<input class="actor-input" placeholder="T√©l" value="${item.phone||''}" onchange="app.Actions.updateActorMeta(${idx}, 'phone', this.value)" ${isReadOnly?'disabled':''}>`;
                  contentHtml += `</div>`;
                  contentHtml += `<div class="actor-input-row" style="margin-top:5px;">`;
                  contentHtml += `<input class="actor-input" placeholder="üìç Ville / R√©gion" value="${item.city||''}" onchange="app.Actions.updateActorMeta(${idx}, 'city', this.value)" ${isReadOnly?'disabled':''}>`;
                  contentHtml += `<input class="actor-input" placeholder="Site Web" value="${item.website||''}" onchange="app.Actions.updateActorMeta(${idx}, 'website', this.value)" ${isReadOnly?'disabled':''}>`;
                  contentHtml += `</div>`;
                  contentHtml += `<textarea class="data-desc" style="margin-top:5px;" placeholder="Adresse / Notes..." oninput="app.Actions.updateActorMeta(${idx}, 'address', this.value)" ${isReadOnly?'disabled':''}>${item.address || ''}</textarea>`;
                  contentHtml += `<textarea class="data-desc" style="margin-top:5px; height:50px;" placeholder="Bio..." oninput="app.Actions.updateDataItem('${type}', ${idx}, this.value)" ${isReadOnly?'disabled':''}>${item.bio || ''}</textarea>`;
                  
                  // Section Description physique (v√©rifier visibilit√©)
                  if(UI.isSectionVisibleForProject(item, 'physical')) {
                  contentHtml += `<div class="actor-physical-section" style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üìè Description physique</strong>
                      <div class="actor-input-row" style="margin-bottom:8px;">
                          <input class="actor-input" type="number" placeholder="Taille (cm)" value="${item.height || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'height', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="actor-input" type="number" placeholder="Poids (kg)" value="${item.weight || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'weight', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="actor-input" type="number" placeholder="√Çge" value="${item.age || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'age', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>
                      <div class="actor-input-row" style="margin-bottom:8px;">
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'eyeColor', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.eyeColor.map(o => '<option value="'+o.value+'" '+(item.eyeColor === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'hairColor', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.hairColor.map(o => '<option value="'+o.value+'" '+(item.hairColor === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'hairLength', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.hairLength.map(o => '<option value="'+o.value+'" '+(item.hairLength === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                      </div>
                      <div class="actor-input-row" style="margin-bottom:8px;">
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'corpulence', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.corpulence.map(o => '<option value="'+o.value+'" '+(item.corpulence === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'ethnicity', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.ethnicity.map(o => '<option value="'+o.value+'" '+(item.ethnicity === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                      </div>
                      <div class="actor-input-row">
                          <input class="actor-input" placeholder="Sports pratiqu√©s (√©quitation, natation...)" value="${item.sports || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'sports', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="actor-input" placeholder="Langues parl√©es (fran√ßais, anglais...)" value="${item.languages || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'languages', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>
                  </div>`;
                  }
                  
                  // Section Galerie Photos (v√©rifier visibilit√©)
                  if(UI.isSectionVisibleForProject(item, 'gallery')) {
                  const galleryPhotos = item.galleryPhotos || [];
                  const galleryHTML = galleryPhotos.map((url, i) => `
                      <div style="position:relative; width:80px; height:80px;">
                          <img src="${url}" style="width:100%; height:100%; object-fit:cover; border-radius:6px; border:1px solid var(--border);">
                          ${!isReadOnly ? `<button onclick="app.Actions.removeActorGalleryPhoto(${idx}, ${i})" style="position:absolute; top:-5px; right:-5px; width:20px; height:20px; border-radius:50%; background:var(--danger); color:white; border:none; cursor:pointer; font-size:12px;">‚úï</button>` : ''}
                      </div>
                  `).join('');
                  
                  contentHtml += `<div style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üì∏ Galerie Photos</strong>
                      <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
                          ${galleryHTML || '<span style="color:var(--text-sec); font-size:0.85rem;">Aucune photo</span>'}
                      </div>
                      ${!isReadOnly ? `<div style="display:flex; gap:10px;">
                          <input class="actor-input" type="url" id="actor-gallery-input-${idx}" placeholder="URL de la photo..." style="flex:1;">
                          <button onclick="app.Actions.addActorGalleryPhoto(${idx})" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                      </div>` : ''}
                  </div>`;
                  }
                  
                  // Section Bande D√©mo (v√©rifier visibilit√©)
                  if(UI.isSectionVisibleForProject(item, 'demoreel')) {
                  contentHtml += `<div style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üé¨ Bande D√©mo</strong>
                      <input class="actor-input" type="url" placeholder="URL YouTube ou Vimeo (https://...)" value="${item.demoreel || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'demoreel', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      ${item.demoreel ? `<div style="margin-top:10px;"><iframe src="${ProfileRenderer.getEmbedUrl(item.demoreel)}" width="100%" height="200" frameborder="0" allowfullscreen style="border-radius:8px;"></iframe></div>` : ''}
                  </div>`;
                  }
                  
                  // Section Tarif pour les acteurs (v√©rifier visibilit√©)
                  if(UI.isSectionVisibleForProject(item, 'tarif')) {
                  const actorCurrencyOptions = (CONFIG.currencies || ['‚Ç¨', '$', '¬£', 'CHF']).map(c => `<option value="${c}" ${item.rateCurrency === c ? 'selected' : ''}>${c}</option>`).join('');
                  const actorRateTypeOptions = (CONFIG.rateTypes || ['Jour', 'Semaine', 'Forfait', 'Heure']).map(t => `<option value="${t}" ${item.rateType === t ? 'selected' : ''}>${t}</option>`).join('');
                  
                  contentHtml += `<div class="actor-input-row" style="margin-top:10px;">
                      <input type="number" class="actor-input" placeholder="Tarif" value="${item.dailyRate || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'dailyRate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      <select class="actor-input" style="width:auto;" onchange="app.Actions.updateActorMeta(${idx}, 'rateCurrency', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          ${actorCurrencyOptions}
                      </select>
                      <select class="actor-input" style="width:auto;" onchange="app.Actions.updateActorMeta(${idx}, 'rateType', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          ${actorRateTypeOptions}
                      </select>
                      <label style="display:flex; align-items:center; gap:5px; cursor:pointer; white-space:nowrap;">
                          <input type="checkbox" ${item.rateNegotiable ? 'checked' : ''} onchange="app.Actions.updateActorMeta(${idx}, 'rateNegotiable', this.checked)" ${isReadOnly ? 'disabled' : ''}>
                          <span style="font-size:0.85rem;">ü§ù N√©gociable</span>
                      </label>
                  </div>`;
                  
                  // Section Statut professionnel
                  contentHtml += `<div style="margin-top:10px; padding:10px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong style="font-size: 0.9rem;">üìã Statut professionnel</strong>
                      <div class="actor-input-row" style="margin-top:8px;">
                          <select class="actor-input" onchange="app.Actions.updateActorMeta(${idx}, 'professionalStatus', this.value); app.UI.renderDataTab('actors', els.actorContainer);" ${isReadOnly ? 'disabled' : ''}>
                              ${ProfileRenderer.selectOptions.professionalStatus.map(o => '<option value="'+o.value+'" '+(item.professionalStatus === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                          </select>
                      </div>
                      ${item.professionalStatus === 'intermittent' ? `
                      <div class="actor-input-row" style="margin-top:8px;">
                          <input class="actor-input" placeholder="N¬∞ S√©curit√© Sociale" value="${item.numSecu || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'numSecu', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="actor-input" placeholder="N¬∞ Cong√©s Spectacles" value="${item.numCongesSpectacles || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'numCongesSpectacles', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>` : ''}
                      ${item.professionalStatus === 'micro-entrepreneur' ? `
                      <div class="actor-input-row" style="margin-top:8px;">
                          <input class="actor-input" placeholder="N¬∞ SIRET" value="${item.siret || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'siret', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>` : ''}
                      
                      <strong style="font-size: 0.9rem; display:block; margin-top:15px;">ü§ù Type de collaboration</strong>
                      <div class="collab-type-selector">
                          <div class="collab-type-btn pro ${item.collabType === 'pro' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Actions.updateActorMeta(${idx}, 'collabType', 'pro'); app.UI.renderDataTab('actors', els.actorContainer);` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                              üé¨ Pro
                          </div>
                          <div class="collab-type-btn semi-pro ${item.collabType === 'semi-pro' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Actions.updateActorMeta(${idx}, 'collabType', 'semi-pro'); app.UI.renderDataTab('actors', els.actorContainer);` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                              ‚ö° Semi-pro
                          </div>
                          <div class="collab-type-btn benevole ${item.collabType === 'benevole' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Actions.updateActorMeta(${idx}, 'collabType', 'benevole'); app.UI.renderDataTab('actors', els.actorContainer);` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                              ‚ù§Ô∏è B√©n√©vole
                          </div>
                      </div>
                      <p style="font-size:0.75rem; color:var(--text-sec); margin-top:8px; margin-bottom:0;">
                          ${item.collabType === 'pro' ? 'üíº Contrat classique, horaires et tarifs standards' : 
                            item.collabType === 'semi-pro' ? 'ü§ù Flexible sur les conditions mais r√©mun√©r√©¬∑e' : 
                            item.collabType === 'benevole' ? 'üéÅ Pas de r√©mun√©ration, d√©fraiement repas + transport' : 
                            'S√©lectionnez votre type de collaboration pr√©f√©r√©'}
                      </p>
                  </div>`;
                  }
                  
                  // Section Disponibilit√©s pour les acteurs (v√©rifier visibilit√©)
                  if(UI.isSectionVisibleForProject(item, 'calendar')) {
                  const actorAvailDates = item.availabilityDates || [];
                  const actorAvailDatesHTML = actorAvailDates.map((d, i) => `<span style="display:inline-flex; align-items:center; background:#E8F5E9; border:1px solid #4CAF50; color:#2E7D32; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">‚úì ${d.from} ‚Üí ${d.to} ${!isReadOnly ? `<span onclick="app.Actions.removeActorAvailability(${idx}, ${i})" style="cursor:pointer; color:var(--danger); margin-left:5px;">‚úñ</span>` : ''}</span>`).join('');
                  
                  // Indisponibilit√©s
                  const actorUnavailDates = item.unavailabilityDates || [];
                  const actorUnavailDatesHTML = actorUnavailDates.map((d, i) => `<span style="display:inline-flex; align-items:center; background:#FFEBEE; border:1px solid #f44336; color:#C62828; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">‚úó ${d.from} ‚Üí ${d.to} ${d.reason ? '(' + Utils.escape(d.reason) + ')' : ''} ${!isReadOnly ? `<span onclick="app.Actions.removeActorUnavailability(${idx}, ${i})" style="cursor:pointer; color:var(--danger); margin-left:5px;">‚úñ</span>` : ''}</span>`).join('');
                  
                  contentHtml += `<div class="crew-availability-section" style="margin-top:10px;">
                      <strong style="font-size: 0.9rem;">üìÖ Disponibilit√©s & Indisponibilit√©s</strong>
                      <textarea class="actor-input" style="min-height: 50px; margin-top: 5px; width:100%;" placeholder="Situation / Notes de disponibilit√©..." onchange="app.Actions.updateActorMeta(${idx}, 'availabilityText', this.value)" ${isReadOnly ? 'disabled' : ''}>${item.availabilityText || ''}</textarea>
                      <div id="actor-calendar-${idx}"></div>
                      <div style="margin-top: 10px;">
                          <div style="margin-bottom:5px; font-size:0.85rem; color:var(--text-sec);">üü¢ Disponible :</div>
                          ${actorAvailDatesHTML || '<span style="color:var(--text-sec); font-size:0.8rem;">Aucune p√©riode renseign√©e</span>'}
                      </div>
                      <div style="margin-top: 10px;">
                          <div style="margin-bottom:5px; font-size:0.85rem; color:var(--text-sec);">üî¥ Indisponible :</div>
                          ${actorUnavailDatesHTML || '<span style="color:var(--text-sec); font-size:0.8rem;">Aucune p√©riode renseign√©e</span>'}
                          </div>
                  </div>`;
                  }
                  
                  // Section V√©hicule (v√©rifier visibilit√©)
                  if(UI.isSectionVisibleForProject(item, 'vehicle')) {
                  contentHtml += `<div class="crew-vehicle-section" style="margin-top:10px;">
                      <label class="crew-vehicle-toggle">
                          <input type="checkbox" ${item.hasVehicle ? 'checked' : ''} onchange="app.Actions.toggleActorVehicle(${idx}, this.checked)" ${isReadOnly ? 'disabled' : ''}>
                          <strong>üöó Poss√®de un v√©hicule</strong>
                      </label>
                      <div class="crew-vehicle-details ${item.hasVehicle ? 'visible' : ''}" id="actor-vehicle-${idx}">
                          <div class="actor-input-row" style="margin-top:8px;">
                              <input class="actor-input" placeholder="Type de v√©hicule" value="${item.vehicleType || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'vehicleType', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              <input class="actor-input" placeholder="Immatriculation" value="${item.vehiclePlate || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'vehiclePlate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          </div>
                          <div class="actor-input-row" style="margin-top:8px;">
                              <input class="actor-input" type="number" min="1" max="9" placeholder="Nb places dispo" value="${item.vehicleSeats || ''}" onchange="app.Actions.updateActorMeta(${idx}, 'vehicleSeats', this.value)" ${isReadOnly ? 'disabled' : ''}>
                              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                  <input type="checkbox" ${item.vehicleTrunk ? 'checked' : ''} onchange="app.Actions.updateActorMeta(${idx}, 'vehicleTrunk', this.checked)" ${isReadOnly ? 'disabled' : ''}>
                                  <span>üß≥ Coffre disponible</span>
                              </label>
                          </div>
                          <textarea class="data-desc" style="margin-top:8px; height:40px;" placeholder="Notes v√©hicule..." oninput="app.Actions.updateActorMeta(${idx}, 'vehicleNotes', this.value)" ${isReadOnly ? 'disabled' : ''}>${item.vehicleNotes || ''}</textarea>
                      </div>
                  </div>`;
                  }
                  
                  // Bouton Contrat
                  if(!isView) {
                      contentHtml += `<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border); display:flex; gap:10px; flex-wrap:wrap;">
                          <button onclick="app.Contracts.openModal('actor', ${idx})" style="padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem;">üìù Contrat</button>
                      </div>`;
                  }
                  
                  // Bouton Contrat
                  if(!isView) {
                      contentHtml += `<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border); display:flex; gap:10px; flex-wrap:wrap;">
                          <button onclick="app.Contracts.openModal('actor', ${idx})" style="padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem;">üìù Contrat</button>
                      </div>`;
                  }
                  
                  contentHtml += groupSelect;
              } else if(type === 'locations') {
                  // === D√âCORS : Fiche enrichie ===
                  contentHtml += `<div class="data-header"><span class="data-name">üè† ${Utils.escape(item.name)}</span>${delBtn}</div>`;
                  contentHtml += `<textarea class="data-desc" placeholder="Description du d√©cor..." oninput="app.Actions.updateDataItem('${type}', ${idx}, this.value)" ${isView?'disabled':''}>${item.desc || ''}</textarea>`;
                  
                  // Section Adresse & Contact
                  contentHtml += `<div style="margin-top:12px; padding:12px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong style="font-size:0.9rem; display:block; margin-bottom:10px;">üìç Lieu de tournage</strong>
                      <input class="actor-input" placeholder="Nom du lieu r√©el (ex: Mus√©e d'Histoire Naturelle)" value="${item.realName || ''}" oninput="app.Actions.updateLocationMeta(${idx}, 'realName', this.value)" ${isView?'disabled':''} style="margin-bottom:8px;">
                      <div class="address-autocomplete-container" style="position:relative; margin-bottom:8px;">
                          <input class="actor-input" id="loc-address-${idx}" placeholder="Adresse compl√®te (autocompl√©tion)" value="${item.address || ''}" oninput="app.Actions.searchLocationAddress(${idx}, this.value)" ${isView?'disabled':''} autocomplete="off">
                          <div id="loc-suggestions-${idx}" class="address-suggestions"></div>
                      </div>
                      <div style="display:flex; gap:8px; margin-bottom:8px;">
                          <input class="actor-input" placeholder="üë§ Contact sur place" value="${item.contactName || ''}" oninput="app.Actions.updateLocationMeta(${idx}, 'contactName', this.value)" ${isView?'disabled':''} style="flex:1;">
                          <input class="actor-input" placeholder="üìû T√©l√©phone" value="${item.contactPhone || ''}" oninput="app.Actions.updateLocationMeta(${idx}, 'contactPhone', this.value)" ${isView?'disabled':''} style="width:140px;">
                      </div>
                      <textarea class="data-desc" style="min-height:40px;" placeholder="Notes d'acc√®s (code porte, parking, interphone...)" oninput="app.Actions.updateLocationMeta(${idx}, 'accessNotes', this.value)" ${isView?'disabled':''}>${item.accessNotes || ''}</textarea>
                  </div>`;
                  
                  // Section Photos de rep√©rage
                  contentHtml += `<div style="margin-top:12px; padding:12px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                      <strong style="font-size:0.9rem; display:block; margin-bottom:10px;">üì∏ Photos de rep√©rage</strong>
                      <div id="location-gallery-${idx}" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
                          ${(item.galleryPhotos || []).map((photo, pIdx) => `
                              <div style="position:relative; width:80px; height:80px;">
                                  <img src="${photo}" style="width:100%; height:100%; object-fit:cover; border-radius:4px; cursor:pointer;" onclick="window.open('${photo}', '_blank')">
                                  ${!isView ? `<button onclick="app.Actions.removeLocationPhoto(${idx}, ${pIdx})" style="position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; border:none; border-radius:50%; width:18px; height:18px; cursor:pointer; font-size:10px;">‚úï</button>` : ''}
                              </div>
                          `).join('')}
                          ${(item.galleryPhotos || []).length === 0 ? '<span style="color:var(--text-sec); font-size:0.85rem; font-style:italic;">Aucune photo</span>' : ''}
                      </div>
                      ${!isView ? `<input class="actor-input" placeholder="URL de la photo √† ajouter" onkeydown="if(event.key==='Enter'){app.Actions.addLocationPhoto(${idx}, this.value); this.value='';}" style="font-size:0.85rem;">` : ''}
                  </div>`;
                  
                  // Sc√®nes tourn√©es dans ce d√©cor
                  const locationScenes = state.data.scenes.filter(s => {
                      if(!s.title) return false;
                      const locMatch = s.title.match(/^(?:INT\.|EXT\.|I\/E)\s*([^\-]+)/i);
                      if(locMatch && locMatch[1]) {
                          return locMatch[1].trim().toUpperCase() === item.name.toUpperCase();
                      }
                      return false;
                  });
                  
                  if(locationScenes.length > 0) {
                      const sceneNumbers = locationScenes.map(s => {
                          const scIdx = state.data.scenes.indexOf(s) + 1;
                          return `<span onclick="app.UI.switchTab('script')" style="cursor:pointer; color:var(--primary); text-decoration:underline;">#${scIdx}</span>`;
                      }).join(', ');
                      contentHtml += `<div style="margin-top:8px; padding:8px; background:var(--bg); border-radius:4px; font-size:0.85rem;">
                          <strong>üé¨ Sc√®nes dans ce d√©cor :</strong> ${sceneNumbers} <span style="color:var(--text-sec);">(${locationScenes.length} sc√®ne${locationScenes.length > 1 ? 's' : ''})</span>
                      </div>`;
                  } else {
                      contentHtml += `<div style="margin-top:8px; padding:8px; background:var(--bg); border-radius:4px; font-size:0.85rem; color:var(--text-sec);">
                          <em>Aucune sc√®ne dans ce d√©cor</em>
                      </div>`;
                  }
                  
                  // S√©lecteur de groupe pour les d√©cors
                  contentHtml += groupSelect;
              } else {
                  // PERSONNAGES (characters)
                  const contentKey = 'bio';
                  contentHtml += `<div class="data-header"><span class="data-name">${Utils.escape(item.name)}</span>${delBtn}</div>`;
                  contentHtml += `<textarea class="data-desc" placeholder="Notes..." oninput="app.Actions.updateDataItem('${type}', ${idx}, this.value)" ${isView?'disabled':''}>${item[contentKey] || ''}</textarea>`;
                  
                  if(type === 'characters') {
                  // Dropdown sexe pour personnages
                  contentHtml += `<select class="group-select" style="margin-top:8px; margin-bottom:8px; width:auto; border-color:var(--border);" onchange="app.Actions.updateCharacterMeta(${idx}, 'gender', this.value)" ${isView ? 'disabled' : ''}>
                      ${ProfileRenderer.selectOptions.gender.map(o => '<option value="'+o.value+'" '+(item.gender === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
                  </select>`;
                  
                  // Trouver les sc√®nes o√π ce personnage appara√Æt
                  const characterScenes = state.data.scenes.filter(s => {
                      if(!s.perso) return false;
                      const names = s.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
                      return names.includes(item.name.toUpperCase());
                  });
                  
                  if(characterScenes.length > 0) {
                      const sceneNumbers = characterScenes.map(s => {
                          const idx = state.data.scenes.indexOf(s) + 1;
                          return `#${idx}`;
                      }).join(', ');
                      contentHtml += `<div style="margin-top:8px; padding:8px; background:var(--bg); border-radius:4px; font-size:0.85rem;">
                          <strong>üìç Appara√Æt dans :</strong> ${sceneNumbers} <span style="color:var(--text-sec);">(${characterScenes.length} sc√®ne${characterScenes.length > 1 ? 's' : ''})</span>
                      </div>`;
                  } else {
                      contentHtml += `<div style="margin-top:8px; padding:8px; background:var(--bg); border-radius:4px; font-size:0.85rem; color:var(--text-sec);">
                          <em>N'appara√Æt dans aucune sc√®ne</em>
                      </div>`;
                  }
                  
                  if(!isView) {
                      contentHtml += `<select class="group-select" style="margin-top:5px; width:100%; border-color:var(--border);" onchange="app.Actions.linkActor(${idx}, this.value)">`; 
                      contentHtml += `<option value="">-- Lier Com√©dien.ne --</option>`;
                      if(state.data.actors) {
                          state.data.actors.forEach(actor => {
                              const isSelected = item.actor_id && item.actor_id === actor.id ? 'selected' : '';
                              contentHtml += `<option value="${actor.id}" ${isSelected}>${actor.name}</option>`;
                          });
                      }
                      contentHtml += `</select>`;
                  } else if (item.actor_id) {
                      const actor = state.data.actors.find(a => a.id === item.actor_id);
                      if(actor) contentHtml += `<div style="margin-top:5px;font-size:0.85rem;color:var(--primary)">üé≠ ${actor.name}</div>`;
                  }
              }
                  contentHtml += groupSelect;
              }
              div.innerHTML = contentHtml; 
              container.appendChild(div); 
          });
          
          // Initialiser les calendriers pour les acteurs
          if(type === 'actors') {
              setTimeout(() => {
                  items.forEach((item, i) => {
                      const idx = state.data.actors.indexOf(item);
                      const calContainer = document.getElementById('actor-calendar-' + idx);
                      if(calContainer && state.currentRole !== 'viewer') {
                          UI.renderAvailabilityCalendar('actor-calendar-' + idx, 'actor', idx);
                      }
                  });
              }, 100);
          }
      },
      
	  renderCrewTab: () => {
          const container = document.getElementById('crewContainer');
          container.innerHTML = '';
          
          if(!state.data.crew || state.data.crew.length === 0) {
              container.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">üé•</div>
                      <div class="empty-state-title">Aucun technicien</div>
                      <div class="empty-state-desc">Constituez votre √©quipe technique en ajoutant des membres. Vous pourrez g√©rer leurs r√¥les, tarifs et disponibilit√©s.</div>
                      <button class="empty-state-btn" onclick="app.Crew.addMember()">+ Ajouter un technicien</button>
                      <div class="empty-state-tips">üí° <strong>Astuce :</strong> Organisez votre √©quipe par d√©partements (R√©alisation, Image, Son, etc.)</div>
                  </div>
              `;
              return;
          }
          
          const isView = state.currentRole === 'viewer' || !Permissions.canEdit('equipe');
          const crewGroups = state.data.groups.filter(g => g.type === 'crew');
          
          // Barre de toggle vue compacte / d√©taill√©e
          const viewMode = CardModal.getViewMode('crew');
          const toggleBar = document.createElement('div');
          toggleBar.className = 'view-toggle-bar';
          toggleBar.innerHTML = `
              <button class="view-toggle-btn ${viewMode === 'compact' ? 'active' : ''}" onclick="app.CardModal.setViewMode('crew', 'compact')">üî≤ Compact</button>
              <button class="view-toggle-btn ${viewMode === 'detailed' ? 'active' : ''}" onclick="app.CardModal.setViewMode('crew', 'detailed')">üìã D√©taill√©</button>
          `;
          container.appendChild(toggleBar);
          
          if(viewMode === 'compact') {
              // Vue compacte
              crewGroups.forEach(grp => {
                  const membersInGroup = state.data.crew.filter(m => m.group_id === grp.id);
                  if(membersInGroup.length > 0) {
                      const section = document.createElement('div');
                      section.className = 'group-section';
                      section.innerHTML = `<div class="group-header">${grp.name}</div><div class="compact-cards-grid"></div>`;
                      const grid = section.querySelector('.compact-cards-grid');
                      CardModal.renderCompactCrewCards(membersInGroup, grid, isView);
                      container.appendChild(section);
                  }
              });
              
              const noGroup = state.data.crew.filter(m => !m.group_id || !crewGroups.find(g => g.id === m.group_id));
              if(noGroup.length > 0) {
                  const section = document.createElement('div');
                  section.className = 'group-section';
                  section.innerHTML = `<div class="group-header" style="color:var(--text-sec); border-color:var(--border)">Non class√©</div><div class="compact-cards-grid"></div>`;
                  const grid = section.querySelector('.compact-cards-grid');
                  CardModal.renderCompactCrewCards(noGroup, grid, isView);
                  container.appendChild(section);
              }
          } else {
              // Vue d√©taill√©e (ancien mode)
              crewGroups.forEach(grp => {
                  const membersInGroup = state.data.crew.filter(m => m.group_id === grp.id);
                  if(membersInGroup.length > 0) {
                      const section = document.createElement('div');
                      section.className = 'group-section';
                      section.innerHTML = `<div class="group-header">${grp.name}</div><div class="data-grid"></div>`;
                      const grid = section.querySelector('.data-grid');
                      
                      membersInGroup.forEach(member => {
                          const idx = state.data.crew.indexOf(member);
                          const card = UI.createCrewCard(member, idx, crewGroups, isView);
                          grid.appendChild(card);
                      });
                      
                      container.appendChild(section);
                  }
              });
              
              const noGroup = state.data.crew.filter(m => !m.group_id || !crewGroups.find(g => g.id === m.group_id));
              if(noGroup.length > 0) {
                  const section = document.createElement('div');
                  section.className = 'group-section';
                  section.innerHTML = `<div class="group-header" style="color:var(--text-sec); border-color:var(--border)">Non class√©</div><div class="data-grid"></div>`;
                  const grid = section.querySelector('.data-grid');
                  
                  noGroup.forEach(member => {
                      const idx = state.data.crew.indexOf(member);
                      const card = UI.createCrewCard(member, idx, crewGroups, isView);
                      grid.appendChild(card);
                  });
                  
                  container.appendChild(section);
              }
              
              // Initialiser les calendriers pour les techniciens (mode d√©taill√© uniquement)
              if(!isView) {
                  setTimeout(() => {
                      state.data.crew.forEach((member, idx) => {
                          const calContainer = document.getElementById('crew-calendar-' + idx);
                          if(calContainer) {
                              UI.renderAvailabilityCalendar('crew-calendar-' + idx, 'crew', idx);
                          }
                      });
                  }, 100);
              }
          }
      },
      
      createCrewCard: (member, idx, availableGroups, isView) => {
          // V√©rifier si le profil est verrouill√© (revendiqu√© par quelqu'un)
          const isLocked = !!member.publicProfileId;
          const isReadOnly = isView || isLocked;
          
          const card = document.createElement('div');
          card.className = 'crew-card';
          
          const roles = member.group_id ? Crew.getRolesForGroup(member.group_id) : [];
          
          let rolesOptions = '<option value="">-- Fonction --</option>';
          roles.forEach(r => {
              rolesOptions += `<option value="${r}" ${member.role === r ? 'selected' : ''}>${r}</option>`;
          });
          rolesOptions += '<option value="__custom__">‚ûï Autre...</option>';
          
          let groupOptions = '<option value="">-- D√©partement --</option>';
          availableGroups.forEach(g => {
              groupOptions += `<option value="${g.id}" ${member.group_id === g.id ? 'selected' : ''}>${g.name}</option>`;
          });
          
          let currencyOptions = '';
          CONFIG.currencies.forEach(c => {
              currencyOptions += `<option value="${c}" ${member.rateCurrency === c ? 'selected' : ''}>${c}</option>`;
          });
          
          let rateTypeOptions = '';
          CONFIG.rateTypes.forEach(t => {
              rateTypeOptions += `<option value="${t}" ${member.rateType === t ? 'selected' : ''}>${t}</option>`;
          });
          
          // Availability dates HTML
          let availDatesHTML = '';
          if(member.availabilityDates && member.availabilityDates.length > 0) {
              member.availabilityDates.forEach((d, dIdx) => {
                  const fromDate = new Date(d.from).toLocaleDateString();
                  const toDate = d.to ? new Date(d.to).toLocaleDateString() : fromDate;
                  availDatesHTML += `
                      <span style="display:inline-flex; align-items:center; background:#E8F5E9; border:1px solid #4CAF50; color:#2E7D32; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">‚úì ${fromDate} ‚Üí ${toDate} ${!isReadOnly ? `<span onclick="app.Crew.removeAvailabilityDate(${idx}, ${dIdx})" style="cursor:pointer; color:var(--danger); margin-left:5px;">‚úñ</span>` : ''}</span>
                  `;
              });
          }
          
          // Unavailability dates HTML
          let unavailDatesHTML = '';
          if(member.unavailabilityDates && member.unavailabilityDates.length > 0) {
              member.unavailabilityDates.forEach((d, dIdx) => {
                  const fromDate = new Date(d.from).toLocaleDateString();
                  const toDate = d.to ? new Date(d.to).toLocaleDateString() : fromDate;
                  unavailDatesHTML += `
                      <span style="display:inline-flex; align-items:center; background:#FFEBEE; border:1px solid #f44336; color:#C62828; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">‚úó ${fromDate} ‚Üí ${toDate} ${d.reason ? '(' + Utils.escape(d.reason) + ')' : ''} ${!isReadOnly ? `<span onclick="app.Crew.removeUnavailabilityDate(${idx}, ${dIdx})" style="cursor:pointer; color:var(--danger); margin-left:5px;">‚úñ</span>` : ''}</span>
                  `;
              });
          }
          
          card.innerHTML = `
              <div class="crew-card-header">
                  ${member.photo ? `<img src="${member.photo}" class="crew-photo-preview">` : '<div class="crew-photo-preview" style="display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üë§</div>'}
                  <div class="crew-info-main">
                      <div class="crew-name" style="display:flex; align-items:center; gap:8px;">${Utils.escape(member.name)} ${isLocked ? `<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">üîí Profil revendiqu√©</span>` : ''} ${!isView ? `<button class="save-contact-btn ${state.contacts && state.contacts.crew && state.contacts.crew.some(c => c.id === member.id) ? 'saved' : ''}" onclick="event.stopPropagation(); app.Contacts.saveCrewToContacts(${idx})" title="Sauvegarder dans contacts">${state.contacts && state.contacts.crew && state.contacts.crew.some(c => c.id === member.id) ? '‚≠ê' : '‚òÜ'}</button>` : ''}</div>
                      <div class="crew-role">${member.role || 'Fonction non d√©finie'}</div>
                  </div>
                  ${!isView ? `<button onclick="app.Crew.deleteMember(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem;">üóëÔ∏è</button>` : ''}
              </div>
              
              ${!isView ? `
              <div class="crew-row">
                  <select class="crew-input" onchange="app.Crew.updateMember(${idx}, 'group_id', this.value)" title="D√©partement" ${isLocked ? 'disabled' : ''}>
                      ${groupOptions}
                  </select>
                  <select class="crew-input" id="role-select-${idx}" onchange="app.UI.handleRoleChange(${idx}, this.value)" ${isLocked ? 'disabled' : ''}>
                      ${rolesOptions}
                  </select>
              </div>
              <select class="crew-input" style="margin-top:8px;" onchange="app.Crew.updateMember(${idx}, 'gender', this.value)" ${isLocked ? 'disabled' : ''}>
                  ${ProfileRenderer.selectOptions.gender.map(o => '<option value="'+o.value+'" '+(member.gender === o.value ? 'selected' : '')+'>'+o.label+'</option>').join('')}
              </select>
              ` : ''}
              
              ${!isReadOnly ? `<input class="crew-input" placeholder="URL Photo" value="${member.photo || ''}" onchange="app.Crew.updateMember(${idx}, 'photo', this.value)">` : ''}
              
              <div class="crew-row">
                  <input class="crew-input" placeholder="Email" value="${member.email || ''}" onchange="app.Crew.updateMember(${idx}, 'email', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  <input class="crew-input" placeholder="T√©l√©phone" value="${member.phone || ''}" onchange="app.Crew.updateMember(${idx}, 'phone', this.value)" ${isReadOnly ? 'disabled' : ''}>
              </div>
              
              <div class="crew-row">
                  <input class="crew-input" placeholder="üìç Ville / R√©gion" value="${member.city || ''}" onchange="app.Crew.updateMember(${idx}, 'city', this.value)" ${isReadOnly ? 'disabled' : ''}>
              </div>
              
              <textarea class="crew-input" style="min-height: 60px;" placeholder="Adresse..." onchange="app.Crew.updateMember(${idx}, 'address', this.value)" ${isReadOnly ? 'disabled' : ''}>${member.address || ''}</textarea>
              
              ${UI.isSectionVisibleForProject(member, 'crew-gallery') ? `<div style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                  <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üì∏ Galerie Photos</strong>
                  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
                      ${(member.galleryPhotos || []).map((url, i) => `
                          <div style="position:relative; width:80px; height:80px;">
                              <img src="${url}" style="width:100%; height:100%; object-fit:cover; border-radius:6px; border:1px solid var(--border);">
                              ${!isReadOnly ? `<button onclick="app.Crew.removeGalleryPhoto(${idx}, ${i})" style="position:absolute; top:-5px; right:-5px; width:20px; height:20px; border-radius:50%; background:var(--danger); color:white; border:none; cursor:pointer; font-size:12px;">‚úï</button>` : ''}
                          </div>
                      `).join('') || '<span style="color:var(--text-sec); font-size:0.85rem;">Aucune photo</span>'}
                  </div>
                  ${!isReadOnly ? `<div style="display:flex; gap:10px;">
                      <input class="crew-input" type="url" id="crew-gallery-input-${idx}" placeholder="URL de la photo..." style="flex:1;">
                      <button onclick="app.Crew.addGalleryPhoto(${idx})" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">+ Ajouter</button>
                  </div>` : ''}
              </div>` : ''}
              
              ${UI.isSectionVisibleForProject(member, 'crew-demoreel') ? `<div style="margin-top:15px; padding:15px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                  <strong style="font-size: 0.9rem; display:block; margin-bottom:10px;">üé¨ Bande D√©mo</strong>
                  <input class="crew-input" type="url" placeholder="URL YouTube ou Vimeo (https://...)" value="${member.demoreel || ''}" onchange="app.Crew.updateMember(${idx}, 'demoreel', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  ${member.demoreel ? `<div style="margin-top:10px;"><iframe src="${ProfileRenderer.getEmbedUrl(member.demoreel)}" width="100%" height="200" frameborder="0" allowfullscreen style="border-radius:8px;"></iframe></div>` : ''}
              </div>` : ''}
              
              ${UI.isSectionVisibleForProject(member, 'tarif') ? `<div class="crew-rate-row" style="margin-top: 10px;">
                  <input type="number" class="crew-input crew-rate-amount" placeholder="Tarif" value="${member.dailyRate || ''}" onchange="app.Crew.updateMember(${idx}, 'dailyRate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  <select class="crew-input crew-rate-currency" onchange="app.Crew.updateMember(${idx}, 'rateCurrency', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      ${currencyOptions}
                  </select>
                  <select class="crew-input crew-rate-type" onchange="app.Crew.updateMember(${idx}, 'rateType', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      ${rateTypeOptions}
                  </select>
                  <label style="display:flex; align-items:center; gap:5px; cursor:pointer; white-space:nowrap;">
                      <input type="checkbox" ${member.rateNegotiable ? 'checked' : ''} onchange="app.Crew.updateMember(${idx}, 'rateNegotiable', this.checked)" ${isReadOnly ? 'disabled' : ''}>
                      <span style="font-size:0.85rem;">ü§ù N√©gociable</span>
                  </label>
              </div>
              
              <div style="margin-top:10px; padding:10px; background:var(--bg); border-radius:8px; border:1px solid var(--border);">
                  <strong style="font-size: 0.9rem;">üìã Statut professionnel</strong>
                  <div style="margin-top:8px;">
                      <select class="crew-input" style="width:100%;" onchange="app.Crew.updateMember(${idx}, 'professionalStatus', this.value); app.UI.renderCrewTab();" ${isReadOnly ? 'disabled' : ''}>
                          <option value="" ${!member.professionalStatus ? 'selected' : ''}>-- Statut --</option>
                          <option value="intermittent" ${member.professionalStatus === 'intermittent' ? 'selected' : ''}>Intermittent¬∑e du spectacle</option>
                          <option value="micro-entrepreneur" ${member.professionalStatus === 'micro-entrepreneur' ? 'selected' : ''}>Micro-entrepreneur¬∑e</option>
                          <option value="amateur" ${member.professionalStatus === 'amateur' ? 'selected' : ''}>Amateur¬∑rice (pas de statut)</option>
                      </select>
                  </div>
                  ${member.professionalStatus === 'intermittent' ? `
                  <div class="crew-rate-row" style="margin-top:8px;">
                      <input class="crew-input" placeholder="N¬∞ S√©curit√© Sociale" value="${member.numSecu || ''}" onchange="app.Crew.updateMember(${idx}, 'numSecu', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      <input class="crew-input" placeholder="N¬∞ Cong√©s Spectacles" value="${member.numCongesSpectacles || ''}" onchange="app.Crew.updateMember(${idx}, 'numCongesSpectacles', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  </div>` : ''}
                  ${member.professionalStatus === 'micro-entrepreneur' ? `
                  <div style="margin-top:8px;">
                      <input class="crew-input" style="width:100%;" placeholder="N¬∞ SIRET" value="${member.siret || ''}" onchange="app.Crew.updateMember(${idx}, 'siret', this.value)" ${isReadOnly ? 'disabled' : ''}>
                  </div>` : ''}
                  
                  <strong style="font-size: 0.9rem; display:block; margin-top:15px;">ü§ù Type de collaboration</strong>
                  <div class="collab-type-selector">
                      <div class="collab-type-btn pro ${member.collabType === 'pro' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Crew.updateMember(${idx}, 'collabType', 'pro'); app.UI.renderCrewTab();` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                          üé¨ Pro
                      </div>
                      <div class="collab-type-btn semi-pro ${member.collabType === 'semi-pro' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Crew.updateMember(${idx}, 'collabType', 'semi-pro'); app.UI.renderCrewTab();` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                          ‚ö° Semi-pro
                      </div>
                      <div class="collab-type-btn benevole ${member.collabType === 'benevole' ? 'selected' : ''}" onclick="${!isReadOnly ? `app.Crew.updateMember(${idx}, 'collabType', 'benevole'); app.UI.renderCrewTab();` : ''}" ${isReadOnly ? 'style="pointer-events:none;opacity:0.6;"' : ''}>
                          ‚ù§Ô∏è B√©n√©vole
                      </div>
                  </div>
                  <p style="font-size:0.75rem; color:var(--text-sec); margin-top:8px; margin-bottom:0;">
                      ${member.collabType === 'pro' ? 'üíº Contrat classique, horaires et tarifs standards' : 
                        member.collabType === 'semi-pro' ? 'ü§ù Flexible sur les conditions mais r√©mun√©r√©¬∑e' : 
                        member.collabType === 'benevole' ? 'üéÅ Pas de r√©mun√©ration, d√©fraiement repas + transport' : 
                        'S√©lectionnez votre type de collaboration pr√©f√©r√©'}
                  </p>
              </div>` : ''}
              
              ${UI.isSectionVisibleForProject(member, 'calendar') ? `<div class="crew-availability-section">
                  <strong style="font-size: 0.9rem;">üìÖ Disponibilit√©s & Indisponibilit√©s</strong>
                  <textarea class="crew-input" style="min-height: 50px; margin-top: 5px;" placeholder="Situation / Notes de disponibilit√©..." onchange="app.Crew.updateMember(${idx}, 'availabilityText', this.value)" ${isReadOnly ? 'disabled' : ''}>${member.availabilityText || ''}</textarea>
                  <div id="crew-calendar-${idx}"></div>
                  <div style="margin-top: 10px;">
                      <div style="margin-bottom:5px; font-size:0.85rem; color:var(--text-sec);">üü¢ Disponible :</div>
                      ${availDatesHTML || '<span style="color:var(--text-sec); font-size:0.8rem;">Aucune p√©riode renseign√©e</span>'}
                  </div>
                  <div style="margin-top: 10px;">
                      <div style="margin-bottom:5px; font-size:0.85rem; color:var(--text-sec);">üî¥ Indisponible :</div>
                      ${unavailDatesHTML || '<span style="color:var(--text-sec); font-size:0.8rem;">Aucune p√©riode renseign√©e</span>'}
                      </div>
              </div>` : ''}
              
              ${UI.isSectionVisibleForProject(member, 'vehicle') ? `<div class="crew-vehicle-section">
                  <label class="crew-vehicle-toggle">
                      <input type="checkbox" ${member.hasVehicle ? 'checked' : ''} onchange="app.Crew.toggleVehicle(${idx}, this.checked)" ${isReadOnly ? 'disabled' : ''}>
                      <strong>üöó Poss√®de un v√©hicule</strong>
                  </label>
                  <div class="crew-vehicle-details ${member.hasVehicle ? 'visible' : ''}" id="crew-vehicle-${idx}">
                      <div class="crew-row">
                          <input class="crew-input" placeholder="Type de v√©hicule" value="${member.vehicleType || ''}" onchange="app.Crew.updateMember(${idx}, 'vehicleType', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <input class="crew-input" placeholder="Immatriculation" value="${member.vehiclePlate || ''}" onchange="app.Crew.updateMember(${idx}, 'vehiclePlate', this.value)" ${isReadOnly ? 'disabled' : ''}>
                      </div>
                      <div class="crew-row" style="margin-top: 10px;">
                          <input class="crew-input" type="number" min="1" max="9" placeholder="Nb places dispo" value="${member.vehicleSeats || ''}" onchange="app.Crew.updateMember(${idx}, 'vehicleSeats', this.value)" ${isReadOnly ? 'disabled' : ''}>
                          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                              <input type="checkbox" ${member.vehicleTrunk ? 'checked' : ''} onchange="app.Crew.updateMember(${idx}, 'vehicleTrunk', this.checked)" ${isReadOnly ? 'disabled' : ''}>
                              <span>üß≥ Coffre disponible</span>
                          </label>
                      </div>
                      <textarea class="crew-input" style="min-height: 40px; margin-top: 10px;" placeholder="Notes v√©hicule..." onchange="app.Crew.updateMember(${idx}, 'vehicleNotes', this.value)" ${isReadOnly ? 'disabled' : ''}>${member.vehicleNotes || ''}</textarea>
                  </div>
              </div>` : ''}
              
              <textarea class="crew-input" style="min-height: 60px; margin-top: 10px;" placeholder="Notes g√©n√©rales..." onchange="app.Crew.updateMember(${idx}, 'notes', this.value)" ${isReadOnly ? 'disabled' : ''}>${member.notes || ''}</textarea>
              
              ${!isReadOnly ? `<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border); display:flex; gap:10px; flex-wrap:wrap;">
                  <button onclick="app.Contracts.openModal('crew', ${idx})" style="padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem;">üìù Contrat</button>
              </div>` : ''}
          `;
          
          return card;
      },
      
      handleRoleChange: (idx, value) => {
          if(value === '__custom__') {
              const member = state.data.crew[idx];
              const newRole = Crew.addCustomRole(member.group_id);
              if(newRole) {
                  Crew.updateMember(idx, 'role', newRole);
                  UI.renderCrewTab();
              } else {
                  // Reset select
                  document.getElementById(`role-select-${idx}`).value = member.role || '';
              }
          } else {
              Crew.updateMember(idx, 'role', value);
          }
      },

      handleDragOver: (e, container, selector) => { e.preventDefault(); if(state.currentRole === 'viewer') return; const after = Utils.getDragAfterElement(container, e.clientY, selector); const drag = document.querySelector(selector + '.dragging'); if(drag) after ? container.insertBefore(drag, after) : container.appendChild(drag); },
      goToStoryboard: (sceneId) => {
        UI.switchTab('storyboard');
        setTimeout(() => {
            const scene = state.data.scenes.find(s => s.id === sceneId || String(s.id) === String(sceneId));
            if(scene) {
                Storyboard.selectScene(scene.id);
            }
        }, 150);
    },
	
	renderAvailabilityCalendar: (containerId, personType, personIdx) => {
        const container = document.getElementById(containerId);
        if(!container) return;
        
        const person = personType === 'actor' ? state.data.actors[personIdx] : state.data.crew[personIdx];
        if(!person) return;
        
        // V√©rifier si le profil est verrouill√© (revendiqu√©)
        const isLocked = !!person.publicProfileId;
        
        const today = new Date();
        const currentMonth = person._calendarMonth !== undefined ? person._calendarMonth : today.getMonth();
        const currentYear = person._calendarYear !== undefined ? person._calendarYear : today.getFullYear();
        
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        
        const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        
        const availDates = person.availabilityDates || [];
        const unavailDates = person.unavailabilityDates || [];
        const shootDates = person.shootingDates || [];
        
        const isDateShooting = (dateStr) => {
            return shootDates.find(sd => sd.date === dateStr);
        };
        
        const isDateAvailable = (dateStr) => {
            return availDates.some(range => {
                const from = new Date(range.from);
                const to = new Date(range.to);
                const check = new Date(dateStr);
                return check >= from && check <= to;
            });
        };
        
        const isDateUnavailable = (dateStr) => {
            return unavailDates.some(range => {
                const from = new Date(range.from);
                const to = new Date(range.to);
                const check = new Date(dateStr);
                return check >= from && check <= to;
            });
        };
        
        let html = `<div class="availability-calendar">
            <div class="availability-calendar-header">
                <button onclick="app.UI.changeCalendarMonth('${containerId}', '${personType}', ${personIdx}, -1)">‚óÄ</button>
                <strong>${monthNames[currentMonth]} ${currentYear}</strong>
                <button onclick="app.UI.changeCalendarMonth('${containerId}', '${personType}', ${personIdx}, 1)">‚ñ∂</button>
            </div>
            ${isLocked ? `<div style="font-size:0.7rem; text-align:center; margin-bottom:5px; color:var(--text-sec);">üîí Calendrier en lecture seule</div>` : `<div style="font-size:0.7rem; text-align:center; margin-bottom:5px; color:var(--text-sec);">üü¢ dispo | üî¥ indispo | üé¨ tournage</div>`}
            <div class="availability-calendar-grid">`;
        
        dayNames.forEach(d => {
            html += `<div class="availability-calendar-day-header">${d}</div>`;
        });
        
        for(let i = 0; i < startDay; i++) {
            html += `<div class="availability-calendar-day empty"></div>`;
        }
        
        for(let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === day;
            const isAvail = isDateAvailable(dateStr);
            const isUnavail = isDateUnavailable(dateStr);
            
            const shootingInfo = isDateShooting(dateStr);
            
            let dayClass = 'availability-calendar-day';
            if(isToday) dayClass += ' today';
            if(shootingInfo) dayClass += ' shooting';
            else if(isAvail) dayClass += ' available';
            if(isUnavail) dayClass += ' unavailable';
            if(isLocked) dayClass += ' locked';
            
            const shootTitle = shootingInfo ? `title="üé¨ J${shootingInfo.dayNumber} - ${shootingInfo.projectName}${shootingInfo.callTime ? ' | Convoc: ' + shootingInfo.callTime : ''}${shootingInfo.location ? ' | ' + shootingInfo.location : ''}"` : '';
            
            html += `<div class="${dayClass}" 
                data-date="${dateStr}"
                ${shootTitle}
                ${!isLocked ? `onmousedown="app.UI.startCalendarDrag('${containerId}', '${personType}', ${personIdx}, '${dateStr}', event)"
                onmouseenter="app.UI.continueCalendarDrag('${dateStr}')"
                onmouseup="app.UI.endCalendarDrag()"` : ''}
                oncontextmenu="return false;">${day}</div>`;
        }
        
        html += `</div></div>`;
        container.innerHTML = html;
    },
    
    changeCalendarMonth: (containerId, personType, personIdx, delta) => {
        const person = personType === 'actor' ? state.data.actors[personIdx] : state.data.crew[personIdx];
        if(!person) return;
        
        const today = new Date();
        let currentMonth = person._calendarMonth !== undefined ? person._calendarMonth : today.getMonth();
        let currentYear = person._calendarYear !== undefined ? person._calendarYear : today.getFullYear();
        
        currentMonth += delta;
        if(currentMonth > 11) { currentMonth = 0; currentYear++; }
        if(currentMonth < 0) { currentMonth = 11; currentYear--; }
        
        person._calendarMonth = currentMonth;
        person._calendarYear = currentYear;
        
        UI.renderAvailabilityCalendar(containerId, personType, personIdx);
    },
    
    _calendarDrag: { active: false, containerId: null, personType: null, personIdx: null, startDate: null, dates: [], isRightClick: false },
    
    startCalendarDrag: (containerId, personType, personIdx, dateStr, event) => {
        event.preventDefault();
        const isRightClick = event.button === 2;
        UI._calendarDrag = { active: true, containerId, personType, personIdx, startDate: dateStr, dates: [dateStr], isRightClick };
        document.addEventListener('mouseup', UI.endCalendarDrag);
    },
    
    continueCalendarDrag: (dateStr) => {
        if(!UI._calendarDrag.active) return;
        if(!UI._calendarDrag.dates.includes(dateStr)) {
            UI._calendarDrag.dates.push(dateStr);
        }
        const container = document.getElementById(UI._calendarDrag.containerId);
        if(container) {
            const color = UI._calendarDrag.isRightClick ? '#f44336' : '#4CAF50';
            container.querySelectorAll('.availability-calendar-day').forEach(el => {
                if(UI._calendarDrag.dates.includes(el.dataset.date)) {
                    el.style.background = color;
                    el.style.color = 'white';
                }
            });
        }
    },
    
    endCalendarDrag: () => {
        if(!UI._calendarDrag.active) return;
        
        const { personType, personIdx, dates, isRightClick } = UI._calendarDrag;
        if(dates.length > 0) {
            dates.sort();
            const from = dates[0];
            const to = dates[dates.length - 1];
            
            const person = personType === 'actor' ? state.data.actors[personIdx] : state.data.crew[personIdx];
            if(person) {
                // Initialiser les tableaux si n√©cessaire
                if(!person.availabilityDates) person.availabilityDates = [];
                if(!person.unavailabilityDates) person.unavailabilityDates = [];
                
                const targetArray = isRightClick ? person.unavailabilityDates : person.availabilityDates;
                const otherArray = isRightClick ? person.availabilityDates : person.unavailabilityDates;
                
                // V√©rifier si on clique sur une date d√©j√† dans le m√™me √©tat (pour la d√©s√©lectionner)
                if(dates.length === 1) {
                    const existingIdx = targetArray.findIndex(range => {
                        const checkDate = new Date(dates[0]);
                        return checkDate >= new Date(range.from) && checkDate <= new Date(range.to);
                    });
                    if(existingIdx > -1) {
                        // D√©s√©lectionner
                        targetArray.splice(existingIdx, 1);
                    } else {
                        // Retirer de l'autre √©tat si pr√©sent
                        const otherIdx = otherArray.findIndex(range => {
                            const checkDate = new Date(dates[0]);
                            return checkDate >= new Date(range.from) && checkDate <= new Date(range.to);
                        });
                        if(otherIdx > -1) {
                            otherArray.splice(otherIdx, 1);
                        }
                        // Ajouter au nouvel √©tat
                        targetArray.push({ from, to });
                    }
                } else {
                    // S√©lection multiple : ajouter la plage
                    targetArray.push({ from, to });
                }
                
                Store.save();
                UI.renderAvailabilityCalendar(UI._calendarDrag.containerId, personType, personIdx);
                
                // Rafra√Æchir aussi la liste des dates
                if(personType === 'actor') {
                    UI.renderDataTab('actors', els.actorContainer);
                } else {
                    UI.renderCrewTab();
                }
            }
        }
        
        UI._calendarDrag = { active: false, containerId: null, personType: null, personIdx: null, startDate: null, dates: [], isRightClick: false };
        document.removeEventListener('mouseup', UI.endCalendarDrag);
    },
	
	applyTabPermissions: () => {
          if(state.currentRole === 'owner') {
              // Le propri√©taire voit tout
              document.querySelectorAll('.tab-btn').forEach(btn => {
                  btn.style.opacity = '1';
                  btn.style.pointerEvents = 'auto';
              });
              return;
          }
          
const tabToSection = {
        'synopsis': 'synopsis', 'board': 'sequencier', 'script': 'scenario', 
        'storyboard': 'storyboard', 'chars': 'personnages', 'locs': 'lieux',
        'actors': 'comediens', 'resources': 'ressources', 'crew': 'equipe', 'breakdown': 'depouillement',
        'stats': 'stats', 'planning': 'planning', 'expenses': 'depenses'
    };
          
          document.querySelectorAll('.tab-btn').forEach(btn => {
              const tabName = btn.dataset.tab;
              const section = tabToSection[tabName];
              
              if(section && !Permissions.canAccess(section)) {
                  btn.style.opacity = '0.4';
                  btn.style.pointerEvents = 'none';
                  btn.title = 'üîí Acc√®s restreint';
              } else {
                  btn.style.opacity = '1';
                  btn.style.pointerEvents = 'auto';
                  btn.title = '';
                  
                  // Indiquer si lecture seule
                  if(section && !Permissions.canEdit(section)) {
                      btn.title = 'üëÅÔ∏è Lecture seule';
                  }
              }
          });
      },
	
	initCategoriesDragDrop: () => {
        const nav = document.getElementById('tabsCategories');
        if(!nav) return;
        
        let draggedCat = null;
        
        nav.querySelectorAll('.tab-category').forEach(cat => {
            cat.addEventListener('dragstart', (e) => {
                draggedCat = cat;
                cat.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            cat.addEventListener('dragend', () => {
                cat.classList.remove('dragging');
                nav.querySelectorAll('.tab-category').forEach(c => c.classList.remove('drag-over'));
                draggedCat = null;
                UI.saveCategoriesOrder();
            });
            
            cat.addEventListener('dragover', (e) => {
                e.preventDefault();
                if(draggedCat && draggedCat !== cat) {
                    cat.classList.add('drag-over');
                }
            });
            
            cat.addEventListener('dragleave', () => {
                cat.classList.remove('drag-over');
            });
            
            cat.addEventListener('drop', (e) => {
                e.preventDefault();
                cat.classList.remove('drag-over');
                if(draggedCat && draggedCat !== cat) {
                    const allCats = [...nav.querySelectorAll('.tab-category')];
                    const draggedIdx = allCats.indexOf(draggedCat);
                    const targetIdx = allCats.indexOf(cat);
                    
                    if(draggedIdx < targetIdx) {
                        cat.after(draggedCat);
                    } else {
                        cat.before(draggedCat);
                    }
                }
            });
        });
    },
    
    saveCategoriesOrder: () => {
        const nav = document.getElementById('tabsCategories');
        if(!nav) return;
        const order = [...nav.querySelectorAll('.tab-category')].map(c => c.dataset.category);
        if(!state.data.uiConfig) state.data.uiConfig = { tabColors: {}, categoryColors: {}, subColors: {}, tabsOrder: [], categoriesOrder: [], hiddenTabs: [], hiddenCategories: [] };
        state.data.uiConfig.categoriesOrder = order;
        Store.save();
    },
    
    loadCategoriesOrder: () => {
        const uiConfig = state.data?.uiConfig || {};
        const order = uiConfig.categoriesOrder || [];
        if(order.length > 0) {
            const nav = document.getElementById('tabsCategories');
            if(!nav) return;
            const toggle = document.getElementById('hiddenCategoriesToggle');
            order.forEach(catName => {
                const cat = nav.querySelector(`.tab-category[data-category="${catName}"]`);
                if(cat) nav.insertBefore(cat, toggle);
            });
        }
    },
    
    loadCategoryTabsOrder: () => {
        const uiConfig = state.data?.uiConfig || {};
        const savedOrder = uiConfig.categoryTabsOrder || {};
        const savedLabels = uiConfig.categoryLabelsCustom || {};
        
        // Restaurer l'ordre des sous-onglets pour chaque cat√©gorie
        Object.keys(savedOrder).forEach(category => {
            if(savedOrder[category] && savedOrder[category].length > 0) {
                UI.categoryTabs[category] = savedOrder[category];
            }
        });
        
        // Restaurer les labels personnalis√©s (pour les onglets d√©plac√©s)
        Object.keys(savedLabels).forEach(category => {
            if(savedLabels[category]) {
                UI.categoryLabels[category] = { ...UI.categoryLabels[category], ...savedLabels[category] };
            }
        });
    },
    
	initTabsDragDrop: () => {
        const nav = document.getElementById('tabsNav');
        if(!nav) return;
        
        let draggedTab = null;
        
        nav.querySelectorAll('.tab-btn').forEach(tab => {
            tab.addEventListener('dragstart', (e) => {
                draggedTab = tab;
                tab.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            tab.addEventListener('dragend', () => {
                tab.classList.remove('dragging');
                nav.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('drag-over'));
                draggedTab = null;
                UI.updateTabNumbers();
            });
            
            tab.addEventListener('dragover', (e) => {
                e.preventDefault();
                if(draggedTab && draggedTab !== tab) {
                    tab.classList.add('drag-over');
                }
            });
            
            tab.addEventListener('dragleave', () => {
                tab.classList.remove('drag-over');
            });
            
            tab.addEventListener('drop', (e) => {
                e.preventDefault();
                tab.classList.remove('drag-over');
                if(draggedTab && draggedTab !== tab) {
                    const allTabs = [...nav.querySelectorAll('.tab-btn')];
                    const draggedIdx = allTabs.indexOf(draggedTab);
                    const targetIdx = allTabs.indexOf(tab);
                    
                    if(draggedIdx < targetIdx) {
                        tab.after(draggedTab);
                    } else {
                        tab.before(draggedTab);
                    }
                }
            });
        });
    },
    
    updateTabNumbers: () => {
        const nav = document.getElementById('tabsNav');
        if(!nav) return;
        
        nav.querySelectorAll('.tab-btn').forEach((tab, idx) => {
            const text = tab.textContent.replace(/^\d+\.\s*/, '');
            tab.textContent = `${idx + 1}. ${text}`;
        });
    },
	
	  applyLocks: () => {
          document.querySelectorAll('.script-row').forEach(row => {
              const sid = row.dataset.id;
              const lock = state.activeLocks[sid];
              const editor = row.querySelector('.script-editor-box');
              const overlay = row.querySelector('.lock-overlay');
              if(lock && lock.uid !== state.currentUser.uid) { row.classList.add('is-locked'); editor.contentEditable = "false"; overlay.innerText = `üîí Modifi√© par ${lock.user.split('@')[0]}`; } 
              else { row.classList.remove('is-locked'); if(state.currentRole !== 'viewer') editor.contentEditable = "true"; }
          });
      },
      
      // V√©rifie si une section est visible pour un profil dans le contexte projet
      isSectionVisibleForProject: (item, section) => {
          if(!item || !item.hiddenProject) return true;
          return !item.hiddenProject.includes(section);
      }
  };
  
 const Actions = {
      openShareModal: () => { if(state.currentRole !== 'owner') return Utils.toast("Seul le propri√©taire peut partager.", "warning"); els.shareModal.style.display = 'flex'; },
      
      // V62: NOUVELLE GESTION DES VERSIONS
      openVersionModal: () => {
          els.versionModal.style.display = 'flex';
          UI.renderVersionList();
      },
      
      // Sauvegarde manuelle (bouton)
      createManualSnapshot: () => {
          Actions.createAutoSnapshot('Manuel');
          Utils.toast("Sauvegarde cr√©√©e !", "success");
      },
      
      // Sauvegarde automatique (appel√©e par Store.save)
      createAutoSnapshot: (trigger = 'Auto') => {
          // Clonage profond des donn√©es actuelles
          const snapshotData = JSON.parse(JSON.stringify(state.data));
          
          // Ne pas stocker les snapshots dans un snapshot
          delete snapshotData.snapshots;
          
          const snapshot = {
              trigger: trigger,
              date: new Date().toISOString(),
              dateDisplay: new Date().toLocaleString('fr-FR'),
              user: state.currentUser?.email || 'Inconnu',
              filmId: state.data.filmId,
              data: snapshotData
          };
          
          if(!state.data.snapshots) state.data.snapshots = [];
          
          // Ajouter au d√©but (plus r√©cent en premier)
          state.data.snapshots.unshift(snapshot);
          
          // Garder seulement les 20 derni√®res sauvegardes
          if(state.data.snapshots.length > 20) {
              state.data.snapshots = state.data.snapshots.slice(0, 20);
          }
      },
      
      // V√©rifier si on doit cr√©er un snapshot auto (toutes les 5 min max)
      shouldAutoSnapshot: () => {
          if(!state.data.snapshots || state.data.snapshots.length === 0) return true;
          
          const lastSnapshot = state.data.snapshots[0];
          if(!lastSnapshot.date) return true;
          
          const lastDate = new Date(lastSnapshot.date);
          const now = new Date();
          const diffMinutes = (now - lastDate) / (1000 * 60);
          
          return diffMinutes >= 5;
      },
      
      restoreSnapshot: async (index) => {
          const snap = state.data.snapshots[index];
          if(!snap) return;
          
          if(!await ConfirmModal.show({ title: 'Restaurer cette sauvegarde ?', message: 'Toutes les donn√©es actuelles seront REMPLAC√âES.\n\nCette action est irr√©versible.', icon: '‚ö†Ô∏è', dangerous: true, confirmText: 'Restaurer' })) return;
          
          // On garde l'historique des snapshots actuel et le filmId
          const currentSnapshots = state.data.snapshots;
          const currentFilmId = state.data.filmId;
          
          // On restaure les donn√©es
          state.data = JSON.parse(JSON.stringify(snap.data));
          
          // On r√©injecte l'historique √† jour et le filmId
          state.data.snapshots = currentSnapshots;
          state.data.filmId = currentFilmId;
          
          History.log('EDIT', `Restauration sauvegarde du ${snap.dateDisplay}`);
          Store.save();
          UI.renderAll();
          els.versionModal.style.display = 'none';
          Utils.toast("Projet restaur√© !", "success");
      },
      
      deleteSnapshot: async (index) => {
          if(!await ConfirmModal.confirmDelete("Cette sauvegarde sera d√©finitivement supprim√©e.")) return;
          state.data.snapshots.splice(index, 1);
          Store.save();
          UI.renderVersionList();
      },

      addScene: () => { 
          if(state.currentRole==='viewer')return; 
          const p = (els.inpPre.value.trim() || 'EXT').toUpperCase(); 
          const l = (els.inpLoc.value.trim() || 'LIEU').toUpperCase(); 
          const s = (els.inpSuff.value.trim() || 'JOUR').toUpperCase(); 
          
          // Cr√©er le breakdown initial avec les techniciens essentiels
          const initialBreakdown = { 'TECHNICIENS': [] };
          const essentialGroups = ['gc1', 'gc3', 'gc4']; // Image, R√©alisation, Son
          essentialGroups.forEach(groupId => {
              const members = state.data.crew.filter(c => c.group_id === groupId);
              members.forEach(member => {
                  if(!initialBreakdown['TECHNICIENS'].includes(member.name)) {
                      initialBreakdown['TECHNICIENS'].push(member.name);
                  }
              });
          });
          
          // Synchroniser aussi les com√©diens des personnages
          const persoInput = els.inpPerso.value.trim();
          if(persoInput) {
              const characterNames = persoInput.split(/[,;]/).map(n => n.trim().toUpperCase());
              characterNames.forEach(charName => {
                  // Chercher le personnage et son com√©dien associ√©
                  const character = state.data.characters?.find(c => c.name.toUpperCase() === charName);
                  if(character && character.actor_id) {
                      const actor = state.data.actors?.find(a => a.id === character.actor_id);
                      if(actor && actor.name) {
                          if(!initialBreakdown['COMEDIENS']) initialBreakdown['COMEDIENS'] = [];
                          if(!initialBreakdown['COMEDIENS'].includes(actor.name)) {
                              initialBreakdown['COMEDIENS'].push(actor.name);
                          }
                      }
                  }
              });
          }
          
          const scene = { id: Utils.generateUniqueId(), title: `${p}. ${l} - ${s}`, perso: els.inpPerso.value.trim(), time: els.inpTime.value.trim(), resume: els.inpResume.value, scriptContent: "<div class='sc-action'><br></div>", breakdown: initialBreakdown, tag_id: 't1', lastModified: Date.now(), lastModifiedBy: state.currentUser.email }; 
          
          const isEdit = !!state.currentEditingId;
          
          if(state.currentEditingId) { 
              const idx = state.data.scenes.findIndex(x => x.id == state.currentEditingId); 
              if(idx > -1) { 
                  scene.id = state.currentEditingId; 
                  scene.scriptContent = state.data.scenes[idx].scriptContent; 
                  scene.breakdown = state.data.scenes[idx].breakdown || {}; 
                  scene.tag_id = state.data.scenes[idx].tag_id; 
                  state.data.scenes[idx] = scene; 
              } 
              state.currentEditingId = null; 
              const formBtn = els.editSceneForm?.querySelector('button');
              if(formBtn) formBtn.innerText = '‚ûï Ajouter Sc√®ne'; 
          } else { 
              state.data.scenes.push(scene); 
          } 
          
          // Log historique
          History.log(isEdit ? 'EDIT' : 'ADD', `${isEdit ? 'Modification' : 'Ajout'} sc√®ne : ${scene.title}`);
          
          // RESET UI & FORM POSITION
          els.inpPre.value=''; els.inpLoc.value=''; els.inpSuff.value=''; els.inpPerso.value=''; els.inpTime.value=''; els.inpResume.value=''; 
          
          document.querySelector('.board-main').prepend(els.editSceneForm);
          
          els.inpPre.focus(); 
          UI.renderBoard(); 
          UI.renderScript(); 
          Store.save();
          Utils.notifyImpact('board', ['script', 'breakdown'], isEdit ? 'modifi√©' : 'ajout√©');
      },
      
      editScene: (id) => { 
          if(state.currentRole==='viewer')return; 
          const s = state.data.scenes.find(x => x.id === id || String(x.id) === String(id)); if(!s)return; 
          const parts = s.title.match(/^([^\.]+)\.\s*(.+?)\s*-\s*(.+)$/); 
          if(parts) { els.inpPre.value = parts[1]; els.inpLoc.value = parts[2]; els.inpSuff.value = parts[3]; } 
          else { els.inpPre.value = "EXT"; els.inpLoc.value = s.title; els.inpSuff.value = "JOUR"; } 
          els.inpPerso.value=s.perso; els.inpTime.value=s.time; els.inpResume.value=s.resume; 
          state.currentEditingId=id; 
          const formBtn = els.editSceneForm?.querySelector('button');
          if(formBtn) formBtn.innerText='üíæ Mettre √† jour'; 
          
          // DEPLACEMENT DU FORMULAIRE
          const card = document.querySelector(`.card[data-id="${id}"]`);
          if(card) {
              els.boardList.insertBefore(els.editSceneForm, card);
              els.editSceneForm.scrollIntoView({behavior: "smooth", block: "center"});
          } else {
              window.scrollTo(0,0);
          }
      },
      
      finalizeScene: async (id) => {
          if(state.currentRole === 'viewer') return;
          const scene = state.data.scenes.find(s => s.id === id);
          if(!scene) return;
          
          const confirmed = await ConfirmModal.show({
              title: '‚úÖ Finaliser cette sc√®ne ?',
              message: `Le texte de "${scene.title}" sera consid√©r√© comme d√©finitif et vous pourrez commencer le d√©pouillement.\n\nVous pourrez toujours repasser en brouillon plus tard (le d√©pouillement sera r√©initialis√©).`,
              icon: '‚úÖ',
              confirmText: 'Finaliser'
          });
          
          if(confirmed) {
              scene.isFinal = true;
              scene.finalizedAt = new Date().toISOString();
              scene.finalizedBy = state.currentUser?.email || 'Inconnu';
              Store.save();
              UI.renderBoard();
              UI.renderScript();
              Utils.toast(`"${scene.title}" est maintenant finale`, 'success');
          }
      },
      
      unfinalizeScene: async (id) => {
          if(state.currentRole === 'viewer') return;
          const scene = state.data.scenes.find(s => s.id === id);
          if(!scene) return;
          
          // V√©rifier si la sc√®ne a un d√©pouillement
          const hasBreakdown = scene.breakdown && Object.values(scene.breakdown).some(arr => arr && arr.length > 0);
          
          let message = `"${scene.title}" repassera en mode brouillon.`;
          if(hasBreakdown) {
              message += `\n\n‚ö†Ô∏è ATTENTION : Le d√©pouillement de cette sc√®ne (${Object.values(scene.breakdown).flat().length} √©l√©ments) sera SUPPRIM√â car le texte pourrait changer.`;
          }
          
          const confirmed = await ConfirmModal.show({
              title: 'üìù Repasser en brouillon ?',
              message: message,
              icon: 'üìù',
              dangerous: hasBreakdown,
              confirmText: hasBreakdown ? 'Supprimer le d√©pouillement et continuer' : 'Repasser en brouillon'
          });
          
          if(confirmed) {
              scene.isFinal = false;
              
              // Supprimer le d√©pouillement si pr√©sent
              if(hasBreakdown) {
                  scene.breakdown = {};
                  Utils.toast('D√©pouillement r√©initialis√©', 'info');
              }
              
              Store.save();
              UI.renderBoard();
              UI.renderScript();
              Breakdown.init();
              Utils.toast(`"${scene.title}" est maintenant en brouillon`, 'success');
          }
      },
      
      deleteScene: async (id) => { 
          if(state.currentRole==='viewer') return; 
          const sceneToDelete = state.data.scenes.find(s => s.id === id || String(s.id) === String(id));
          if(!sceneToDelete) return;
          
          // V√©rifier si la sc√®ne est dans une feuille de service
          const affectedDays = (state.data.shootingDays || []).filter(day => 
              day.scenes && day.scenes.some(ref => ref.sceneId === id || String(ref.sceneId) === String(id))
          );
          
          let confirmMessage = 'Supprimer cette sc√®ne ?';
          if(affectedDays.length > 0) {
              const dayNames = affectedDays.map(d => d.name || Utils.formatDate(d.date || d.startDate)).join(', ');
              confirmMessage = `‚ö†Ô∏è ATTENTION !\n\nCette sc√®ne est programm√©e dans ${affectedDays.length} jour(s) de tournage :\n${dayNames}\n\nLa sc√®ne sera automatiquement retir√©e de ces feuilles de service.\n\nVoulez-vous vraiment supprimer cette sc√®ne ?`;
          }
          
          if(await ConfirmModal.show({ title: 'Supprimer cette sc√®ne ?', message: confirmMessage, icon: 'üóëÔ∏è', dangerous: true, confirmText: 'Supprimer' })){ 
              // 1. Supprimer les plans storyboard associ√©s
              if(state.data.shots) {
                  state.data.shots = state.data.shots.filter(shot => shot.sceneId !== id && String(shot.sceneId) !== String(id));
              }
              
              // 2. Retirer la sc√®ne du planning (journ√©es de tournage)
              if(state.data.shootingDays) {
                  state.data.shootingDays.forEach(day => {
                      if(day.scenes) {
                          day.scenes = day.scenes.filter(ref => ref.sceneId !== id && String(ref.sceneId) !== String(id));
                      }
                  });
                  // Supprimer les jours de tournage vides
                  state.data.shootingDays = state.data.shootingDays.filter(day => day.scenes && day.scenes.length > 0);
              }
              
              // 3. Supprimer les commentaires Firebase
              if(state.currentProjectId) {
                  firebase.database().ref(`all_projects/${state.currentProjectId}/comments/${id}`).remove().catch(e => console.warn('Erreur suppression commentaires:', e));
              }
              
              // 4. Supprimer la sc√®ne
              state.data.scenes = state.data.scenes.filter(s => s.id !== id && String(s.id) !== String(id)); 
              if(state.currentEditingId === id) {
                  state.currentEditingId = null;
                  const btn = document.querySelector('.controls-row button');
                  if(btn) btn.innerText = '‚ûï Ajouter Sc√®ne';
                  if(els.inpPre) els.inpPre.value=''; 
                  if(els.inpLoc) els.inpLoc.value=''; 
                  if(els.inpSuff) els.inpSuff.value=''; 
                  if(els.inpPerso) els.inpPerso.value=''; 
                  if(els.inpTime) els.inpTime.value=''; 
                  if(els.inpResume) els.inpResume.value='';
              }
              // Log historique
              History.log('DELETE', `Suppression sc√®ne : ${sceneToDelete?.title || 'Sans titre'}`);
              UI.renderBoard(); 
              UI.renderScript(); 
              Store.save();
              Utils.notifyImpact('board', ['script', 'breakdown', 'storyboard', 'planning'], 'supprim√©');
          } 
      },
      
      updateOrder: (fromTab) => { 
          let newIds = []; 
          if (fromTab === 'script') newIds = Array.from(els.scriptContainer.children).map(c => c.dataset.id); 
          else newIds = Array.from(els.boardList.children).map(c => c.dataset.id); 
          
          const newScenes = []; 
          newIds.forEach(id => { const s = state.data.scenes.find(x => String(x.id) === String(id)); if(s) newScenes.push(s); }); 
          
          if(newScenes.length === state.data.scenes.length) {
              // V√©rifier si des sc√®nes planifi√©es ont chang√© de num√©ro
              const plannedScenes = [];
              if(state.data.shootingDays) {
                  state.data.shootingDays.forEach(day => {
                      (day.scenes || []).forEach(ref => {
                          const oldIdx = state.data.scenes.findIndex(s => s.id === ref.sceneId);
                          const newIdx = newScenes.findIndex(s => s.id === ref.sceneId);
                          if(oldIdx !== -1 && newIdx !== -1 && oldIdx !== newIdx) {
                              const scene = newScenes[newIdx];
                              plannedScenes.push({
                                  title: scene.title,
                                  oldNum: oldIdx + 1,
                                  newNum: newIdx + 1,
                                  day: day.name || Utils.formatDate(day.date || day.startDate)
                              });
                          }
                      });
                  });
              }
              
              state.data.scenes = newScenes; 
              if(fromTab === 'script') UI.renderScript(); else UI.renderBoard(); 
              Store.save();
              
              // Notifier si des sc√®nes planifi√©es ont chang√© de num√©ro
              if(plannedScenes.length > 0) {
                  const details = plannedScenes.slice(0, 3).map(p => `#${p.oldNum}‚Üí#${p.newNum} (${p.day})`).join(', ');
                  const more = plannedScenes.length > 3 ? ` +${plannedScenes.length - 3} autres` : '';
                  Utils.toast(`‚ö†Ô∏è Sc√®nes planifi√©es renum√©rot√©es : ${details}${more}`, 'warning', 5000);
              }
          } else {
              console.error("Erreur de tri : d√©calage d'IDs d√©tect√©.", newIds, newScenes.length, state.data.scenes.length);
          }
      },
      
      syncCharacters: () => { const found = new Set(); state.data.scenes.forEach(s => { if(!s.perso) return; s.perso.split(/[,;]|\bet\b/i).map(n=>n.trim()).filter(n=>n.length).forEach(n=>found.add(n)); }); found.forEach(name => { if(!state.data.characters.find(c => c.name.toLowerCase() === name.toLowerCase())) state.data.characters.push({ name: name, bio: "", group_id: "", gender: "" }); }); },
      syncLocations: () => { const found = new Set(); state.data.scenes.forEach(s => { const parts = s.title.match(/^[^\.]+\.\s*(.+?)\s*-/); if(parts && parts[1]) found.add(parts[1].trim().toUpperCase()); }); found.forEach(locName => { if(!state.data.locations.find(l => l.name === locName)) state.data.locations.push({ name: locName, desc: "", group_id: "" }); }); },
      updateDataItem: (type, idx, val) => { if(state.data[type][idx]) { const key = (type === 'characters' || type === 'actors') ? 'bio' : 'desc'; state.data[type][idx][key] = val; Store.save(); } },
      deleteDataItem: async (type, idx) => { 
          if(await ConfirmModal.confirmDelete("Cet √©l√©ment sera supprim√©.")) { 
              // Si on supprime un acteur, d√©lier les personnages associ√©s
              if(type === 'actors') {
                  const actorId = state.data.actors[idx]?.id;
                  const actorName = state.data.actors[idx]?.name;
                  let impactedTabs = [];
                  if(actorId) {
                      // V√©rifier si le com√©dien √©tait planifi√©
                      let plannedDays = 0;
                      if(state.data.shootingDays) {
                          state.data.shootingDays.forEach(day => {
                              if(day.callSheet && day.callSheet.some(call => call.personId === actorId && call.type === 'actor')) {
                                  plannedDays++;
                              }
                          });
                      }
                      if(plannedDays > 0) impactedTabs.push('planning');
                      
                      // D√©lier les personnages
                      let linkedChars = 0;
                      state.data.characters.forEach(char => {
                          if(char.actor_id === actorId) {
                              delete char.actor_id;
                              linkedChars++;
                          }
                      });
                      if(linkedChars > 0) impactedTabs.push('chars');
                      
                      // Retirer des feuilles de service (callSheet)
                      if(state.data.shootingDays) {
                          state.data.shootingDays.forEach(day => {
                              if(day.callSheet) {
                                  day.callSheet = day.callSheet.filter(
                                      call => !(call.personId === actorId && call.type === 'actor')
                                  );
                              }
                          });
                      }
                      // Supprimer les d√©penses de salaire associ√©es
                      if(state.data.expenses) {
                          const hadExpenses = state.data.expenses.some(e => e.salaryPersonId === actorId && e.salaryPersonType === 'actor');
                          if(hadExpenses) impactedTabs.push('expenses');
                          state.data.expenses = state.data.expenses.filter(
                              e => !(e.salaryPersonId === actorId && e.salaryPersonType === 'actor')
                          );
                      }
                      
                      // Notification si impacts
                      if(impactedTabs.length > 0) {
                          Utils.notifyImpact('actors', impactedTabs, 'supprim√©');
                      }
                  }
              }
              
              // Si on supprime un personnage, le retirer du breakdown de toutes les sc√®nes
              if(type === 'characters') {
                  const charName = state.data.characters[idx]?.name;
                  if(charName) {
                      let hadBreakdown = false;
                      state.data.scenes.forEach(scene => {
                          if(scene.breakdown && scene.breakdown["PERSONNAGES"]) {
                              const before = scene.breakdown["PERSONNAGES"].length;
                              scene.breakdown["PERSONNAGES"] = scene.breakdown["PERSONNAGES"].filter(
                                  name => name.toLowerCase() !== charName.toLowerCase()
                              );
                              if(scene.breakdown["PERSONNAGES"].length < before) hadBreakdown = true;
                          }
                      });
                      if(hadBreakdown) Utils.notifyImpact('chars', 'breakdown', 'supprim√©');
                  }
              }
              
              // Si on supprime un lieu, le retirer du breakdown de toutes les sc√®nes
              if(type === 'locations') {
                  const locName = state.data.locations[idx]?.name;
                  if(locName) {
                      let hadBreakdown = false;
                      state.data.scenes.forEach(scene => {
                          if(scene.breakdown && scene.breakdown["DECORS-LIEUX"]) {
                              const before = scene.breakdown["DECORS-LIEUX"].length;
                              scene.breakdown["DECORS-LIEUX"] = scene.breakdown["DECORS-LIEUX"].filter(
                                  name => name.toLowerCase() !== locName.toLowerCase()
                              );
                              if(scene.breakdown["DECORS-LIEUX"].length < before) hadBreakdown = true;
                          }
                      });
                      if(hadBreakdown) Utils.notifyImpact('locs', 'breakdown', 'supprim√©');
                  }
              }
              
              state.data[type].splice(idx, 1); 
              Store.save(); 
              type === 'characters' ? UI.renderDataTab('characters', els.charContainer) : (type === 'actors' ? UI.renderDataTab('actors', els.actorContainer) : UI.renderDataTab('locations', els.locContainer)); 
          } 
      },
      addGroup: (type) => { 
        const typeLabel = type === 'perso' ? 'personnages' : (type === 'actor' ? 'com√©diens' : 'lieux');
        
        const modal = document.createElement('div');
        modal.id = 'add-group-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10001;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:400px;width:90%;">
                <h3 style="margin-top:0;">‚ûï Nouveau groupe de ${typeLabel}</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Ic√¥ne</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div id="new-group-icon" style="width:50px;height:50px;background:var(--bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:pointer;border:2px solid var(--border);">üìÅ</div>
                        <button onclick="app.Utils.showIconPicker((icon) => document.getElementById('new-group-icon').textContent = icon)" style="padding:8px 15px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Changer</button>
                    </div>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Nom du groupe</label>
                    <input type="text" id="new-group-name" placeholder="Ex: Protagonistes, D√©cors nuit..." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;background:var(--input-bg);color:var(--text-main);">
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:10px 20px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Annuler</button>
                    <button onclick="app.Actions.confirmAddGroup('${type}')" style="padding:10px 20px;background:var(--success);color:white;border:none;border-radius:6px;cursor:pointer;">Cr√©er</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('new-group-name').focus();
    },
    
    confirmAddGroup: (type) => {
        const name = document.getElementById('new-group-name').value.trim();
        const icon = document.getElementById('new-group-icon').textContent;
        
        if(!name) {
            Utils.toast('Veuillez entrer un nom pour le groupe.', 'warning');
            return;
        }
        
        state.data.groups.push({ id: 'g'+Date.now(), name: icon + ' ' + name, type: type, icon: icon });
        History.log('ADD', `Ajout groupe : ${icon} ${name}`);
        Store.save();
        
        // Fermer le modal
        const modal = document.getElementById('add-group-modal');
        if(modal) modal.remove();
        
        if(type==='perso') UI.renderDataTab('characters', els.charContainer); 
        else if(type==='actor') UI.renderDataTab('actors', els.actorContainer); 
        else UI.renderDataTab('locations', els.locContainer);
    },
      changeGroup: (type, idx, gid) => { state.data[type][idx].group_id = gid; Store.save(); if(type==='characters') UI.renderDataTab(type, els.charContainer); else if(type==='actors') UI.renderDataTab(type, els.actorContainer); else UI.renderDataTab(type, els.locContainer); },
      // V√©rifie si un profil public existe pour cet email et propose de le lier
      checkAndLinkPublicProfile: async (email, type, idx) => {
          if(!email || !email.includes('@')) return false;
          
          const dbPath = type === 'actor' ? 'public_actors' : 'public_crew';
          const typeLabel = type === 'actor' ? 'com√©dien' : 'technicien';
          const dataArray = type === 'actor' ? state.data.actors : state.data.crew;
          
          try {
              const query = firebase.database().ref(dbPath).orderByChild('email').equalTo(email.toLowerCase());
              const snap = await query.once('value');
              
              if(snap.exists()) {
                  const profiles = snap.val();
                  const profileId = Object.keys(profiles)[0];
                  const existingProfile = profiles[profileId];
                  
                  // Cr√©er le modal de confirmation
                  const modal = document.createElement('div');
                  modal.id = 'link-profile-modal';
                  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:99999;';
                  modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                  
                  const photoHtml = existingProfile.photo 
                      ? `<img src="${existingProfile.photo}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:10px;">` 
                      : `<div style="width:80px;height:80px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:2rem;color:white;margin-bottom:10px;">${(existingProfile.name || '?')[0].toUpperCase()}</div>`;
                  
                  modal.innerHTML = `
                      <div style="background:var(--panel-bg);border-radius:12px;padding:25px;width:450px;max-width:90%;text-align:center;">
                          <h3 style="margin:0 0 20px;color:var(--text-main);">üîç Profil existant trouv√© !</h3>
                          
                          <p style="color:var(--text-sec);margin-bottom:20px;">Un profil ${typeLabel} existe d√©j√† √† l'adresse <strong>${email}</strong></p>
                          
                          <div style="background:var(--bg);border-radius:10px;padding:20px;margin-bottom:20px;">
                              ${photoHtml}
                              <div style="font-size:1.2rem;font-weight:bold;color:var(--text-main);">${Utils.escape(existingProfile.name || 'Sans nom')}</div>
                              <div style="color:var(--text-sec);margin-top:5px;">${Utils.escape(existingProfile.city || '')} ${existingProfile.age ? '‚Ä¢ ' + existingProfile.age + ' ans' : ''}</div>
                              ${existingProfile.role ? `<div style="color:var(--primary);margin-top:5px;">${Utils.escape(existingProfile.role)}</div>` : ''}
                              ${existingProfile.department ? `<div style="color:var(--text-sec);font-size:0.9rem;">${Utils.escape(existingProfile.department)}</div>` : ''}
                          </div>
                          
                          <p style="color:var(--text-main);margin-bottom:20px;">Est-ce la bonne personne ?</p>
                          
                          <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                              <button onclick="app.Actions.confirmLinkProfile('${profileId}', '${type}', ${idx})" style="padding:12px 25px;background:var(--success);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">‚úÖ Oui, lier ce profil</button>
                              <button onclick="document.getElementById('link-profile-modal').remove()" style="padding:12px 25px;background:var(--bg);color:var(--text-main);border:1px solid var(--border);border-radius:8px;cursor:pointer;">‚ùå Non, ce n'est pas lui/elle</button>
                          </div>
                          
                          <p style="color:var(--text-sec);font-size:0.85rem;margin-top:15px;">Si ce n'est pas la bonne personne, v√©rifiez l'adresse email.</p>
                      </div>
                  `;
                  
                  document.body.appendChild(modal);
                  return true; // Profil trouv√©
              }
              return false; // Pas de profil trouv√©
          } catch(e) {
              console.warn('Erreur v√©rification profil:', e);
              return false;
          }
      },
      
      // Confirme la liaison d'un profil public
      confirmLinkProfile: async (profileId, type, idx) => {
          const dbPath = type === 'actor' ? 'public_actors' : 'public_crew';
          const dataArray = type === 'actor' ? state.data.actors : state.data.crew;
          
          try {
              const snap = await firebase.database().ref(dbPath + '/' + profileId).once('value');
              const publicData = snap.val();
              
              if(publicData && dataArray[idx]) {
                  // Lier le profil
                  dataArray[idx].publicProfileId = profileId;
                  
                  // Mettre √† jour les donn√©es
                  dataArray[idx].name = publicData.name || dataArray[idx].name;
                  dataArray[idx].photo = publicData.photo || dataArray[idx].photo;
                  dataArray[idx].phone = publicData.phone || dataArray[idx].phone;
                  dataArray[idx].city = publicData.city || dataArray[idx].city;
                  dataArray[idx].bio = publicData.bio || dataArray[idx].bio;
                  
                  Store.save();
                  
                  // Fermer le modal
                  document.getElementById('link-profile-modal')?.remove();
                  
                  // Re-render
                  if(type === 'actor') {
                      UI.renderDataTab('actors', els.actorContainer);
                  } else {
                      UI.renderCrewTab();
                  }
                  
                  Utils.toast('Profil li√© avec succ√®s !', 'success');
                  
                  // Proposer de notifier
                  const person = dataArray[idx];
                  setTimeout(async () => {
                      if(await ConfirmModal.show({ title: 'Pr√©venir cette personne ?', message: `Envoyer une notification √† ${person.name} pour l'informer qu'il/elle a √©t√© ajout√©(e) au projet ?`, icon: 'üìß', confirmText: 'Envoyer' })) {
                          Actions.notifyNewProfile(person, type);
                      }
                  }, 300);
              }
          } catch(e) {
              console.error('Erreur liaison profil:', e);
              Utils.toast('Erreur lors de la liaison', 'error');
          }
      },
      
      // Synchronise les acteurs du projet avec leurs profils publics
      syncActorsFromPublicProfiles: async () => {
          if(!state.data.actors) return;
          
          let hasChanges = false;
          
          // D'abord, v√©rifier si des acteurs sans publicProfileId correspondent √† un profil public existant
          for(let i = 0; i < state.data.actors.length; i++) {
              const actor = state.data.actors[i];
              if(!actor.publicProfileId && actor.email) {
                  try {
                      // Chercher par email dans public_actors
                      const query = firebase.database().ref('public_actors').orderByChild('email').equalTo(actor.email.toLowerCase());
                      const snap = await query.once('value');
                      if(snap.exists()) {
                          const profiles = snap.val();
                          const profileId = Object.keys(profiles)[0];
                          actor.publicProfileId = profileId;
                          hasChanges = true;
                      }
                  } catch(e) {
                      console.warn('Erreur v√©rification profil public:', e);
                  }
              }
          }
          
          // Ensuite, synchroniser les donn√©es des profils li√©s
          for(let i = 0; i < state.data.actors.length; i++) {
              const actor = state.data.actors[i];
              if(actor.publicProfileId) {
                  try {
                      const snap = await firebase.database().ref('public_actors/' + actor.publicProfileId).once('value');
                      const publicData = snap.val();
                      if(publicData) {
                          // Mettre √† jour les donn√©es de l'acteur avec le profil public
                          actor.name = publicData.name || actor.name;
                          actor.photo = publicData.photo || actor.photo;
                          actor.phone = publicData.phone || actor.phone;
                          actor.bio = publicData.bio || actor.bio;
                          actor.gender = publicData.gender || actor.gender;
                          actor.height = publicData.height || actor.height;
                          actor.age = publicData.age || actor.age;
                          actor.eyeColor = publicData.eyeColor || actor.eyeColor;
                          actor.hairColor = publicData.hairColor || actor.hairColor;
                          actor.ethnicity = publicData.ethnicity || actor.ethnicity;
                          actor.languages = publicData.languages || actor.languages;
                          actor.sports = publicData.sports || actor.sports;
                          actor.dailyRate = publicData.dailyRate || actor.dailyRate;
                          actor.rateCurrency = publicData.rateCurrency || actor.rateCurrency;
                          actor.rateType = publicData.rateType || actor.rateType;
                          actor.website = publicData.website || actor.website;
                          actor.city = publicData.city || actor.city;
                          actor.weight = publicData.weight || actor.weight;
                          actor.hairLength = publicData.hairLength || actor.hairLength;
                          actor.corpulence = publicData.corpulence || actor.corpulence;
                          actor.demoreel = publicData.demoreel || actor.demoreel;
                          actor.galleryPhotos = publicData.galleryPhotos || actor.galleryPhotos || [];
                          actor.hasVehicle = publicData.hasVehicle || actor.hasVehicle;
                          actor.vehicleType = publicData.vehicleType || actor.vehicleType;
                          actor.vehiclePlate = publicData.vehiclePlate || actor.vehiclePlate;
                          actor.vehicleSeats = publicData.vehicleSeats || actor.vehicleSeats;
                          actor.vehicleTrunk = publicData.vehicleTrunk || actor.vehicleTrunk;
                          actor.vehicleNotes = publicData.vehicleNotes || actor.vehicleNotes;
                          actor.availabilityText = publicData.availabilityText || actor.availabilityText;
                          actor.availabilityDates = publicData.availabilityDates || actor.availabilityDates;
                          actor.unavailabilityDates = publicData.unavailabilityDates || actor.unavailabilityDates;
                          actor.professionalStatus = publicData.professionalStatus || actor.professionalStatus;
                          actor.collabType = publicData.collabType || actor.collabType;
                          // Pr√©f√©rences de visibilit√©
                          actor.hiddenProject = publicData.hiddenProject || [];
                          // Marquer comme synchronis√©
                          actor.lastSyncedAt = Date.now();
                      }
                  } catch(e) {
                      console.warn('Erreur sync profil public:', e);
                  }
              }
          }
          // Sauvegarder les donn√©es mises √† jour
          Store.save();
      },
      
      // Synchronise les techniciens du projet avec leurs profils publics
      syncCrewFromPublicProfiles: async () => {
          if(!state.data.crew) return;
          
          let hasChanges = false;
          
          // D'abord, v√©rifier si des techniciens sans publicProfileId correspondent √† un profil public existant
          for(let i = 0; i < state.data.crew.length; i++) {
              const member = state.data.crew[i];
              if(!member.publicProfileId && member.email) {
                  try {
                      // Chercher par email dans public_crew
                      const query = firebase.database().ref('public_crew').orderByChild('email').equalTo(member.email.toLowerCase());
                      const snap = await query.once('value');
                      if(snap.exists()) {
                          const profiles = snap.val();
                          const profileId = Object.keys(profiles)[0];
                          member.publicProfileId = profileId;
                          hasChanges = true;
                      }
                  } catch(e) {
                      console.warn('Erreur v√©rification profil public:', e);
                  }
              }
          }
          
          // Ensuite, synchroniser les donn√©es des profils li√©s
          for(let i = 0; i < state.data.crew.length; i++) {
              const member = state.data.crew[i];
              if(member.publicProfileId) {
                  try {
                      const snap = await firebase.database().ref('public_crew/' + member.publicProfileId).once('value');
                      const publicData = snap.val();
                      if(publicData) {
                          // Mettre √† jour les donn√©es du technicien avec le profil public
                          member.name = publicData.name || member.name;
                          member.photo = publicData.photo || member.photo;
                          member.phone = publicData.phone || member.phone;
                          member.email = publicData.email || member.email;
                          member.address = publicData.address || member.address;
                          member.gender = publicData.gender || member.gender;
                          member.role = publicData.role || member.role;
                          member.department = publicData.department || member.department;
                          member.dailyRate = publicData.dailyRate || member.dailyRate;
                          member.rateCurrency = publicData.rateCurrency || member.rateCurrency;
                          member.city = publicData.city || member.city;
                          member.rateType = publicData.rateType || member.rateType;
                          member.availabilityText = publicData.availabilityText || member.availabilityText;
                          member.availabilityDates = publicData.availabilityDates || member.availabilityDates;
                          member.unavailabilityDates = publicData.unavailabilityDates || member.unavailabilityDates;
                          member.demoreel = publicData.demoreel || member.demoreel;
                          member.galleryPhotos = publicData.crewGalleryPhotos || publicData.galleryPhotos || member.galleryPhotos || [];
                          member.hasVehicle = publicData.hasVehicle || member.hasVehicle;
                          member.vehicleType = publicData.vehicleType || member.vehicleType;
                          member.vehiclePlate = publicData.vehiclePlate || member.vehiclePlate;
                          member.vehicleSeats = publicData.vehicleSeats || member.vehicleSeats;
                          member.vehicleTrunk = publicData.vehicleTrunk || member.vehicleTrunk;
                          member.vehicleNotes = publicData.vehicleNotes || member.vehicleNotes;
                          member.professionalStatus = publicData.professionalStatus || member.professionalStatus;
                          member.collabType = publicData.collabType || member.collabType;
                          // Pr√©f√©rences de visibilit√©
                          member.hiddenProject = publicData.hiddenProject || [];
                          // Marquer comme synchronis√©
                          member.lastSyncedAt = Date.now();
                      }
                  } catch(e) {
                      console.warn('Erreur sync profil public crew:', e);
                  }
              }
          }
          // Sauvegarder les donn√©es mises √† jour
          Store.save();
      },
      
      linkActor: (charIdx, actorId) => { 
          if(!state.data.characters[charIdx]) return; 
          state.data.characters[charIdx].actor_id = actorId; 
          
          const character = state.data.characters[charIdx];
          
          // Mettre √† jour le sexe du personnage selon le com√©dien li√©
          if(actorId) {
              const actor = state.data.actors.find(a => a.id === actorId || String(a.id) === String(actorId));
              if(actor && actor.gender) {
                  state.data.characters[charIdx].gender = actor.gender;
              }
              
              // Synchroniser le com√©dien dans le d√©pouillement des sc√®nes o√π ce personnage appara√Æt
              if(actor && actor.name && character.name) {
                  const charNameUpper = character.name.toUpperCase();
                  state.data.scenes.forEach(scene => {
                      // V√©rifier si le personnage est dans cette sc√®ne
                      const hasCharacter = scene.perso && scene.perso.toUpperCase().includes(charNameUpper);
                      const inBreakdown = scene.breakdown && scene.breakdown['PERSONNAGES'] && 
                          scene.breakdown['PERSONNAGES'].some(p => p.toUpperCase() === charNameUpper);
                      
                      if(hasCharacter || inBreakdown) {
                          if(!scene.breakdown) scene.breakdown = {};
                          if(!scene.breakdown['COMEDIENS']) scene.breakdown['COMEDIENS'] = [];
                          if(!scene.breakdown['COMEDIENS'].includes(actor.name)) {
                              scene.breakdown['COMEDIENS'].push(actor.name);
                          }
                      }
                  });
              }
          }
          
          Store.save(); 
          UI.renderDataTab('characters', els.charContainer);
          if(actorId) {
              Utils.notifyImpact('chars', 'breakdown', 'li√©');
          }
      },
      addActor: async () => { 
          if(state.currentRole !== 'owner' && !Permissions.canEdit('comediens')) {
              Utils.toast('Vous n\'avez pas la permission d\'ajouter des com√©diens.', 'error');
              return;
          }
          const name = await ConfirmModal.prompt("Entrez le nom du com√©dien ou de la com√©dienne.", "Nouveau com√©dien", "Nom..."); if(name) { const newActor = { id: 'act_'+Date.now(), name: name, gender: "", bio: "", email: "", phone: "", address: "", city: "", website: "", photo: "", group_id: "", hasVehicle: false, vehicleType: "", vehiclePlate: "", vehicleSeats: "", vehicleTrunk: false, vehicleNotes: "", dailyRate: "", rateCurrency: "‚Ç¨", rateType: "Jour", availabilityText: "", availabilityDates: [], color: "", height: "", weight: "", age: "", eyeColor: "", hairColor: "", hairLength: "", ethnicity: "", corpulence: "", sports: "", languages: "", demoreel: "", galleryPhotos: [] }; state.data.actors.push(newActor); History.log('ADD', `Ajout com√©dien : ${name}`); Store.save(); UI.renderDataTab('actors', els.actorContainer); } },
      updateActorMeta: (idx, field, val) => { 
          if(state.data.actors[idx]) { 
              const oldVal = state.data.actors[idx][field];
              state.data.actors[idx][field] = val; 
              Store.save(); 
              if(field === 'photo') UI.renderDataTab('actors', els.actorContainer);
              
              // Si on ajoute un email valide, v√©rifier si un profil public existe
              if(field === 'email' && val && val.includes('@') && val !== oldVal) {
                  Actions.checkAndLinkPublicProfile(val, 'actor', idx).then(found => {
                      if(!found) {
                          // Pas de profil existant, proposer de notifier pour cr√©er
                          const actor = state.data.actors[idx];
                          setTimeout(async () => {
                              if(await ConfirmModal.show({ title: 'Envoyer une invitation ?', message: `Aucun profil com√©dien trouv√© pour ${val}.\n\nEnvoyer une invitation √† ${actor.name} pour cr√©er son profil ?`, icon: 'üì®', confirmText: 'Inviter' })) {
                                  Actions.notifyNewProfile(actor, 'actor');
                              }
                          }, 300);
                      }
                  });
              }
          } 
      },
      updateCharacterMeta: (idx, field, val) => { if(state.data.characters[idx]) { state.data.characters[idx][field] = val; Store.save(); } },
      toggleActorVehicle: (idx, hasVehicle) => { if(state.data.actors[idx]) { state.data.actors[idx].hasVehicle = hasVehicle; Store.save(); const vehicleDetails = document.getElementById(`actor-vehicle-${idx}`); if(vehicleDetails) { if(hasVehicle) { vehicleDetails.classList.add('visible'); } else { vehicleDetails.classList.remove('visible'); } } } },
      addActorGalleryPhoto: (idx) => {
          const input = document.getElementById(`actor-gallery-input-${idx}`);
          if(!input || !input.value.trim()) { Utils.toast('Veuillez entrer une URL de photo.', 'warning'); return; }
          if(!state.data.actors[idx].galleryPhotos) state.data.actors[idx].galleryPhotos = [];
          state.data.actors[idx].galleryPhotos.push(input.value.trim());
          Store.save();
          UI.renderDataTab('actors', els.actorContainer);
      },
      removeActorGalleryPhoto: (actorIdx, photoIdx) => {
          if(state.data.actors[actorIdx] && state.data.actors[actorIdx].galleryPhotos) {
              state.data.actors[actorIdx].galleryPhotos.splice(photoIdx, 1);
              Store.save();
              UI.renderDataTab('actors', els.actorContainer);
          }
      },
      
      removeActorAvailability: (actorIdx, dateIdx) => {
          if(state.data.actors[actorIdx] && state.data.actors[actorIdx].availabilityDates) {
              state.data.actors[actorIdx].availabilityDates.splice(dateIdx, 1);
              Store.save();
              UI.renderDataTab('actors', els.actorContainer);
          }
      },

      
      removeActorUnavailability: (actorIdx, dateIdx) => {
          if(state.data.actors[actorIdx] && state.data.actors[actorIdx].unavailabilityDates) {
              state.data.actors[actorIdx].unavailabilityDates.splice(dateIdx, 1);
              Store.save();
              UI.renderDataTab('actors', els.actorContainer);
          }
      },
      
      // === D√âCORS (locations) ===
      updateLocationMeta: (idx, field, value) => {
          if(state.data.locations[idx]) {
              state.data.locations[idx][field] = value;
              Store.save();
          }
      },
      addLocationPhoto: (idx, url) => {
          if(!url || !url.trim()) return;
          if(state.data.locations[idx]) {
              if(!state.data.locations[idx].galleryPhotos) state.data.locations[idx].galleryPhotos = [];
              state.data.locations[idx].galleryPhotos.push(url.trim());
              Store.save();
              UI.renderDataTab('locations', els.locContainer);
              Utils.toast('Photo ajout√©e', 'success');
          }
      },
      removeLocationPhoto: (locIdx, photoIdx) => {
          if(state.data.locations[locIdx] && state.data.locations[locIdx].galleryPhotos) {
              state.data.locations[locIdx].galleryPhotos.splice(photoIdx, 1);
              Store.save();
              UI.renderDataTab('locations', els.locContainer);
          }
      },
      locationSearchTimeout: null,
      searchLocationAddress: (idx, query) => {
          clearTimeout(Actions.locationSearchTimeout);
          const suggestions = document.getElementById('loc-suggestions-' + idx);
          if(!suggestions) return;
          
          // Sauvegarder la valeur saisie
          if(state.data.locations[idx]) {
              state.data.locations[idx].address = query;
          }
          
          if(!query || query.length < 3) {
              suggestions.classList.remove('visible');
              return;
          }
          
          Actions.locationSearchTimeout = setTimeout(async () => {
              try {
                  // Utiliser l'API Adresse du gouvernement fran√ßais (plus pr√©cise)
                  const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
                  const data = await response.json();
                  
                  if(data.features && data.features.length > 0) {
                      suggestions.innerHTML = data.features.map(f => {
                          const props = f.properties;
                          const label = props.label || '';
                          const context = props.context || '';
                          return `<div class="address-suggestion" onclick="app.Actions.selectLocationAddress(${idx}, '${Utils.escape(label).replace(/'/g, "\\'")}')">
                              <div class="address-suggestion-main">${Utils.escape(props.name || label.split(',')[0])}</div>
                              <div class="address-suggestion-secondary">${Utils.escape(context)}</div>
                          </div>`;
                      }).join('');
                      suggestions.classList.add('visible');
                  } else {
                      suggestions.innerHTML = '<div class="address-suggestion" style="color:var(--text-sec); cursor:default;">Aucun r√©sultat</div>';
                      suggestions.classList.add('visible');
                  }
              } catch(e) {
                  console.error('Erreur recherche adresse:', e);
                  suggestions.classList.remove('visible');
              }
          }, 300);
      },
      selectLocationAddress: (idx, address) => {
          if(state.data.locations[idx]) {
              state.data.locations[idx].address = address;
              Store.save();
              document.getElementById('loc-address-' + idx).value = address;
              document.getElementById('loc-suggestions-' + idx).classList.remove('visible');
              Utils.toast('Adresse enregistr√©e', 'success');
          }
      },
      
      notifyNewProfile: async (person, type) => {
          try {
              const projectTitle = document.getElementById('projectTitle')?.value || 'Un projet';
              const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'Un r√©alisateur';
              const typeLabel = type === 'actor' ? 'com√©dien.ne' : 'technicien.ne';
              
              // Cr√©er un pending claim dans Firebase
              const recipientEmailKey = Utils.sanitizeEmail(person.email);
              const claimId = 'claim_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);
              
              const claimData = {
                  id: claimId,
                  type: type,
                  localId: person.id,
                  name: person.name,
                  email: person.email,
                  phone: person.phone || '',
                  photo: person.photo || '',
                  bio: person.bio || '',
                  gender: person.gender || '',
                  // Donn√©es sp√©cifiques acteur
                  height: person.height || '',
                  age: person.age || '',
                  eyeColor: person.eyeColor || '',
                  hairColor: person.hairColor || '',
                  ethnicity: person.ethnicity || '',
                  languages: person.languages || '',
                  sports: person.sports || '',
                  // Donn√©es sp√©cifiques technicien
                  role: person.role || '',
                  department: person.group_id || '',
                  dailyRate: person.dailyRate || '',
                  rateCurrency: person.rateCurrency || '‚Ç¨',
                  // M√©tadonn√©es
                  createdBy: state.currentUser.email,
                  createdByName: senderName,
                  projectId: state.currentProjectId,
                  projectTitle: projectTitle,
                  createdAt: new Date().toISOString()
              };
              
              await firebase.database().ref(`pending_profile_claims/${recipientEmailKey}/${claimId}`).set(claimData);
              
              await Messages.send(person.email, {
                  type: 'claim',
                  title: `üéÅ Un profil ${typeLabel} a √©t√© cr√©√© √† votre nom`,
                  content: `Bonjour ${person.name},\n\n${senderName} a cr√©√© un profil √† votre nom en tant que ${typeLabel} sur le projet "${projectTitle}" dans Moteur.\n\nüëâ Connectez-vous pour revendiquer ce profil et le compl√©ter. Il appara√Ætra ensuite dans l'Univers et vous pourrez √™tre contact√©(e) par d'autres productions !`,
                  projectId: state.currentProjectId,
                  projectTitle: projectTitle,
                  claimId: claimId
              });
              
              await Messages.sendEmailPing(person.email, person.name, 'claim', {
                  senderName: senderName,
                  projectTitle: projectTitle,
                  typeLabel: typeLabel
              });
              
              Utils.toast(`${person.name} a √©t√© notifi√©(e) par email !`, 'success');
          } catch(e) {
              console.error('Erreur notification:', e);
              Utils.toast('Erreur lors de l\'envoi de la notification', 'error');
          }
      },
      openTagMenu: (e, sceneId) => { e.preventDefault(); if(state.currentRole === 'viewer') return; state.contextSceneId = sceneId; els.tagCtxMenu.innerHTML = ''; state.data.tags.forEach(t => { const div = document.createElement('div'); div.innerHTML = `<span class="tag-dot" style="background:${t.color}"></span> ${t.name}`; div.onclick = () => { Actions.setTag(t.id); }; els.tagCtxMenu.appendChild(div); }); const hr = document.createElement('hr'); hr.style.margin="5px 0"; hr.style.border="none"; hr.style.borderTop="1px solid var(--border)"; els.tagCtxMenu.appendChild(hr); const newDiv = document.createElement('div'); newDiv.innerHTML = `<span>‚ûï Cr√©er un Tag...</span>`; newDiv.onclick = Actions.openTagModal; els.tagCtxMenu.appendChild(newDiv); els.tagCtxMenu.style.display = 'block'; const menuRect = els.tagCtxMenu.getBoundingClientRect(); let top = e.clientY; let left = e.clientX; if(left + 150 > window.innerWidth) left = window.innerWidth - 160; if(top + 200 > window.innerHeight) top = window.innerHeight - 210; if(left < 10) left = 10; if(top < 10) top = 10; els.tagCtxMenu.style.top = top + 'px'; els.tagCtxMenu.style.left = left + 'px'; },
      setTag: (tagId) => { const s = state.data.scenes.find(x => x.id === state.contextSceneId); if(s) { s.tag_id = tagId; Store.save(); UI.renderBoard(); UI.renderScript(); } els.tagCtxMenu.style.display = 'none'; },
      openTagModal: () => { els.tagCtxMenu.style.display='none'; els.tagModal.style.display='flex'; document.getElementById('tag-new-name').value=''; },
      saveNewTag: () => { const name = document.getElementById('tag-new-name').value.trim(); const color = document.getElementById('tag-new-color').value; if(!name) return Utils.toast("Nom requis", "warning"); const newTag = { id: 't'+Date.now(), name: name, color: color }; state.data.tags.push(newTag); Store.save(); Actions.setTag(newTag.id); els.tagModal.style.display='none'; },
      openExportModal: () => { els.exportModal.style.display = 'flex'; },
      confirmExport: () => { 
    els.exportModal.style.display = 'none'; 
    const opts = { 
        author: document.getElementById('exp-author').value, 
        phone: document.getElementById('exp-phone').value, 
        web: document.getElementById('exp-web').value, 
        reg: document.getElementById('exp-reg').value, 
        synop: document.getElementById('exp-synop').checked, 
        board: document.getElementById('exp-board').checked, 
        script: document.getElementById('exp-script').checked, 
        chars: document.getElementById('exp-chars').checked, 
        actors: document.getElementById('exp-actors').checked, 
        locs: document.getElementById('exp-locs').checked, 
        storyboard: document.getElementById('exp-storyboard').checked,
        crew: document.getElementById('exp-crew').checked,
        breakdown: document.getElementById('exp-breakdown').checked, 
        stats: document.getElementById('exp-stats').checked 
    }; 
    Exporter.toPDF(opts); 
}
  };
  
  const Breakdown = {
      init: () => {
          els.bdRightContent.innerHTML = '';
          if(state.data.scenes.length === 0) { els.bdScriptContent.innerHTML = 'Aucune sc√®ne.'; return; }
          state.data.scenes.forEach((s, idx) => {
              const isFinal = s.isFinal === true;
              if(isFinal) Breakdown.autoFill(s);
              const card = document.createElement('div'); card.className = 'bd-scene-card';
              const header = document.createElement('div');
              header.className = 'bd-scene-header' + (s.id === state.activeBdSceneId ? ' active' : '');
              const bdStatus = s.status || 'not-verified';
              const bdStatusLabels = { 'not-verified': 'üî¥', 'to-work': 'üü°', 'verified': 'üü¢' };
              const finalBadge = isFinal ? `<span class="scene-status-badge final" style="margin-left:8px;">‚úÖ Finale</span>` : `<span class="scene-status-badge draft" style="margin-left:8px;">üìù Brouillon</span>`;
              header.innerHTML = `<span class="bd-scene-title">#${idx+1} - ${Utils.escape(s.title)}</span>${finalBadge}<div class="scene-status-container" style="margin-left:10px;"><span class="scene-status-badge ${bdStatus}" onclick="app.UI.toggleSceneStatus('${s.id}', event)">${bdStatusLabels[bdStatus]}</span></div> <small>${s.id === state.activeBdSceneId ? '‚ñº' : '‚ñ∂'}</small>`;
              header.onclick = () => { state.activeBdSceneId = (state.activeBdSceneId === s.id) ? null : s.id; Breakdown.init(); };
              const details = document.createElement('div');
              details.className = 'bd-scene-details' + (s.id === state.activeBdSceneId ? ' open' : '');
              
              if(!isFinal) {
                  // Sc√®ne en brouillon - afficher message de blocage
                  details.innerHTML = `
                      <div style="padding: 15px; text-align: center; background: #fff8e1; border-radius: 8px; margin: 10px 0;">
                          <div style="font-size: 1.5rem; margin-bottom: 8px;">üìù</div>
                          <div style="font-weight: 600; color: #ef6c00; margin-bottom: 5px;">Sc√®ne en brouillon</div>
                          <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Finalisez cette sc√®ne pour pouvoir la d√©pouiller.</div>
                          <button onclick="app.Actions.finalizeScene('${s.id}')" class="finalize-btn">‚úÖ Finaliser cette sc√®ne</button>
                      </div>
                  `;
              } else {
                  // Sc√®ne finalis√©e - afficher le d√©pouillement
                  let hasItems = false;
                  CONFIG.bdCategories.forEach(cat => {
                      const items = s.breakdown[cat] || [];
                      if(items.length > 0) {
                          hasItems = true;
                          const group = document.createElement('div'); group.className = 'bd-cat-group';
                          let html = `<div class="bd-cat-name">${cat}</div><div class="bd-tags-container">`;
                          const canEditBd = state.currentRole === 'owner' || Permissions.canEdit('depouillement');
                          items.forEach((item, i) => { html += `<span class="bd-tag" data-term="${item.toLowerCase()}">${Utils.escape(item)} ${canEditBd ? `<button onclick="app.Breakdown.removeItem('${s.id}', '${cat}', ${i}, event)">√ó</button>` : ''}</span>`; });
                          html += `</div>`;
                          group.innerHTML = html;
                          details.appendChild(group);
                      }
                  });
                  if(!hasItems) details.innerHTML = '<div style="font-size:0.8rem;color:var(--text-sec);font-style:italic">Rien. S√©lectionnez du texte √† gauche et faites clic-droit pour d√©pouiller.</div>';
              }
              card.appendChild(header); card.appendChild(details); els.bdRightContent.appendChild(card);
          });
          if(state.activeBdSceneId) { const scene = state.data.scenes.find(s => s.id === state.activeBdSceneId); if(scene) Breakdown.renderLeft(scene); }
      },
      autoFill: (scene) => {
          if(!scene.breakdown) scene.breakdown = {};
          const locMatch = scene.title.match(/^(?:INT\.|EXT\.|I\/E)\s*([^\-]+)/i);
          if(locMatch && locMatch[1]) { const loc = locMatch[1].trim().toUpperCase(); if(!scene.breakdown["DECORS-LIEUX"]) scene.breakdown["DECORS-LIEUX"] = []; if(!scene.breakdown["DECORS-LIEUX"].includes(loc)) scene.breakdown["DECORS-LIEUX"].push(loc); }
          if(scene.perso) { const names = scene.perso.split(/[,;]|\bet\b/i).map(n => n.trim()).filter(n => n.length > 0); if(!scene.breakdown["PERSONNAGES"]) scene.breakdown["PERSONNAGES"] = []; names.forEach(n => { if(!scene.breakdown["PERSONNAGES"].includes(n)) scene.breakdown["PERSONNAGES"].push(n); }); }
      },
      renderLeft: (scene) => {
          const isFinal = scene.isFinal === true;
          let html = scene.scriptContent || "<p><em>(Vide)</em></p>";
          let titleHtml = scene.title;
          
          if(!isFinal) {
              // Sc√®ne en brouillon - afficher le texte avec un overlay d'avertissement
              const finalBadge = `<span class="scene-status-badge draft" style="margin-left:10px;">üìù Brouillon</span>`;
              els.bdScriptContent.innerHTML = `
                  <div class="bd-script-text" style="position:relative;">
                      <h3 style="text-decoration:underline;margin-top:0">${titleHtml}${finalBadge}</h3>
                      ${html}
                      <div style="position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(255,152,0,0.05); pointer-events:none;"></div>
                  </div>
                  <div style="margin-top:15px; padding:15px; background:#fff8e1; border:2px dashed #ff9800; border-radius:8px; text-align:center;">
                      <p style="margin:0 0 10px 0; color:#e65100; font-weight:600;">‚ö†Ô∏è Cette sc√®ne est en brouillon</p>
                      <p style="margin:0 0 15px 0; color:#666; font-size:0.9rem;">Le d√©pouillement sera possible une fois la sc√®ne finalis√©e.</p>
                      <button onclick="app.Actions.finalizeScene('${scene.id}')" class="finalize-btn">‚úÖ Finaliser cette sc√®ne</button>
                  </div>
              `;
              return;
          }
          
          // Sc√®ne finalis√©e - afficher normalement avec les marquages
          const finalBadge = `<span class="scene-status-badge final" style="margin-left:10px;">‚úÖ Finale</span>`;
          if(scene.breakdown) {
              const allItems = []; Object.values(scene.breakdown).forEach(arr => allItems.push(...arr));
              allItems.sort((a, b) => b.length - a.length);
              allItems.forEach(term => { 
                  if(!term) return; 
                  const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                  const regex = new RegExp(`(?<![\\w-])${safeTerm}(?![\\w-])`, 'gi'); 
                  html = html.replace(regex, (match) => `<span class="bd-marked" data-term="${term.toLowerCase()}">${match}</span>`);
                  // Aussi marquer dans le titre (pour les d√©cors-lieux)
                  titleHtml = titleHtml.replace(regex, (match) => `<span class="bd-marked" data-term="${term.toLowerCase()}">${match}</span>`);
              });
          }
          els.bdScriptContent.innerHTML = `<div class="bd-script-text"><h3 style="text-decoration:underline;margin-top:0">${titleHtml}${finalBadge}</h3>${html}</div>`;
          // Ajouter les listeners de hover pour la liaison visuelle
          Breakdown.setupLinkHovers();
      },
      setupLinkHovers: () => {
          const svg = document.getElementById('bd-link-svg');
          if(!svg) return;
          svg.innerHTML = '';
          const layout = document.querySelector('.breakdown-layout');
          if(!layout) return;
          
          const highlightPair = (term) => {
              document.querySelectorAll(`.bd-marked[data-term="${term}"], .bd-tag[data-term="${term}"]`).forEach(el => el.classList.add('bd-highlight'));
              // Recalculer layoutRect √† chaque hover pour √©viter les d√©calages
              const currentLayoutRect = layout.getBoundingClientRect();
              drawLink(term, currentLayoutRect, svg);
          };
          const unhighlightAll = () => {
              document.querySelectorAll('.bd-highlight').forEach(el => el.classList.remove('bd-highlight'));
              svg.innerHTML = '';
          };
          
          document.querySelectorAll('.bd-marked[data-term]').forEach(el => {
              el.addEventListener('mouseenter', () => highlightPair(el.dataset.term));
              el.addEventListener('mouseleave', unhighlightAll);
          });
          document.querySelectorAll('.bd-tag[data-term]').forEach(el => {
              el.addEventListener('mouseenter', () => highlightPair(el.dataset.term));
              el.addEventListener('mouseleave', unhighlightAll);
          });
          
          function drawLink(term, layoutRect, svg) {
              svg.innerHTML = '';
              const marked = document.querySelector(`.bd-marked[data-term="${term}"]`);
              const tag = document.querySelector(`.bd-tag[data-term="${term}"]`);
              if(!marked || !tag) return;
              // V√©rifier que les √©l√©ments sont visibles
              const r1 = marked.getBoundingClientRect();
              const r2 = tag.getBoundingClientRect();
              if(r1.width === 0 || r2.width === 0) return;
              const scrollLeft = layout.scrollLeft || 0;
              const scrollTop = layout.scrollTop || 0;
              const x1 = r1.right - layoutRect.left + scrollLeft;
              const y1 = r1.top + r1.height/2 - layoutRect.top + scrollTop;
              const x2 = r2.left - layoutRect.left + scrollLeft;
              const y2 = r2.top + r2.height/2 - layoutRect.top + scrollTop;
              const cx1 = x1 + (x2 - x1) * 0.3;
              const cx2 = x1 + (x2 - x1) * 0.7;
              const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
              path.setAttribute('d', `M${x1},${y1} C${cx1},${y1} ${cx2},${y2} ${x2},${y2}`);
              const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
              arrow.setAttribute('points', `${x2},${y2} ${x2-8},${y2-4} ${x2-8},${y2+4}`);
              arrow.setAttribute('fill', '#ffd700');
              svg.appendChild(path);
              svg.appendChild(arrow);
          }
      },
      handleRightClick: (e) => { 
          if(state.currentRole === 'viewer' || !Permissions.canEdit('depouillement')) return; 
          if(!state.activeBdSceneId) return; 
          
          // V√©rifier si la sc√®ne est finalis√©e
          const scene = state.data.scenes.find(s => s.id === state.activeBdSceneId);
          if(!scene || scene.isFinal !== true) {
              e.preventDefault();
              Utils.toast('Finalisez cette sc√®ne avant de pouvoir la d√©pouiller', 'warning');
              return;
          }
          
          const sel = window.getSelection(); 
          const text = sel.toString().trim(); 
          
          e.preventDefault(); 
          
          // Si pas de texte s√©lectionn√©, montrer menu pour ajouter technicien
          if(text.length < 1) {
              els.bdCtxMenu.innerHTML = `<div class="ctx-title">Ajouter technicien(s) :</div>`;
              
              // Option pour ajouter tous les techniciens
              const addAllDiv = document.createElement('div');
              addAllDiv.innerText = '‚ö° Ajouter TOUS les techniciens';
              addAllDiv.style.fontWeight = 'bold';
              addAllDiv.style.borderBottom = '2px solid var(--border)';
              addAllDiv.onclick = () => { 
                  if(state.data.crew && state.data.crew.length > 0) {
                      state.data.crew.forEach(member => {
                          Breakdown.addItemSilent(state.activeBdSceneId, 'TECHNICIENS', member.name);
                      });
                      Store.save();
                      Breakdown.init();
                  }
                  els.bdCtxMenu.style.display = 'none'; 
              };
              els.bdCtxMenu.appendChild(addAllDiv);
              
              // Liste des techniciens
              if(state.data.crew && state.data.crew.length > 0) {
                  state.data.crew.forEach(member => {
                      const div = document.createElement('div');
                      div.innerText = `${member.name} (${member.role || 'Technicien'})`;
                      div.onclick = () => { 
                          Breakdown.addItem(state.activeBdSceneId, 'TECHNICIENS', member.name); 
                          els.bdCtxMenu.style.display = 'none'; 
                      };
                      els.bdCtxMenu.appendChild(div);
                  });
              } else {
                  const emptyDiv = document.createElement('div');
                  emptyDiv.innerText = '(Aucun technicien)';
                  emptyDiv.style.color = 'var(--text-sec)';
                  els.bdCtxMenu.appendChild(emptyDiv);
              }
              
              els.bdCtxMenu.style.display = 'block';
              let top1 = e.clientY; let left1 = e.clientX;
              if(left1 + 200 > window.innerWidth) left1 = window.innerWidth - 210;
              if(top1 + 300 > window.innerHeight) top1 = window.innerHeight - 310;
              if(left1 < 10) left1 = 10; if(top1 < 10) top1 = 10;
              els.bdCtxMenu.style.top = top1 + 'px'; 
              els.bdCtxMenu.style.left = left1 + 'px';
              return;
          }
          
          els.bdCtxMenu.innerHTML = `<div class="ctx-title">Ajouter √† :</div>`; 
          
          CONFIG.bdCategories.forEach(cat => { 
              const div = document.createElement('div'); 
              div.innerText = cat; 
              
              if(cat === 'TECHNICIENS' || cat === 'COMEDIENS') {
                  // Clic pour afficher la liste des personnes
                  div.innerHTML = `${cat} ‚ñ∂`;
                  div.style.cursor = 'pointer';
                  div.style.fontWeight = 'bold';
                  
                  const isCrew = cat === 'TECHNICIENS';
                  const dataList = isCrew ? state.data.crew : state.data.actors;
                  const itemLabel = isCrew ? 'technicien' : 'com√©dien';
                  
                  div.onclick = (ev) => {
                      ev.stopPropagation();
                      Breakdown.showPersonMenu(cat, text, sel, dataList, itemLabel);
                  };
              } else {
                  div.onclick = () => { 
                      Breakdown.addItem(state.activeBdSceneId, cat, text); 
                      els.bdCtxMenu.style.display = 'none'; 
                      sel.removeAllRanges(); 
                  };
              }
              
              els.bdCtxMenu.appendChild(div); 
          }); 
          
          els.bdCtxMenu.style.display = 'block';
          let top2 = e.clientY; let left2 = e.clientX;
          if(left2 + 200 > window.innerWidth) left2 = window.innerWidth - 210;
          if(top2 + 350 > window.innerHeight) top2 = window.innerHeight - 360;
          if(left2 < 10) left2 = 10; if(top2 < 10) top2 = 10;
          els.bdCtxMenu.style.top = top2 + 'px'; 
          els.bdCtxMenu.style.left = left2 + 'px'; 
      },
      addItem: (sceneId, cat, text) => { 
          if(state.currentRole === 'viewer' || !Permissions.canEdit('depouillement')) return; 
          const scene = state.data.scenes.find(s => s.id === sceneId); 
          if(!scene) return; 
          if(!scene.breakdown) scene.breakdown = {}; 
          if(!scene.breakdown[cat]) scene.breakdown[cat] = []; 
          
          if(!scene.breakdown[cat].includes(text)) { 
              scene.breakdown[cat].push(text); 
              if(cat === "PERSONNAGES") ScriptEditor.syncCharMeta(text, sceneId); 
              
              // Auto-ajouter les techniciens responsables de cette cat√©gorie
              if(cat !== 'TECHNICIENS' && cat !== 'PERSONNAGES' && cat !== 'DECORS-LIEUX') {
                  Breakdown.autoAddResponsibleCrew(sceneId, cat);
              }
              
              // Auto-cr√©er une fiche Ressource pour ACCESSOIRES, COSTUMES, VEHICULES
              if(cat === 'ACCESSOIRES' || cat === 'COSTUMES' || cat === 'VEHICULES') {
                  Breakdown.autoCreateResource(text, cat);
              }
              
              Store.save(); 
              Breakdown.init(); 
          } 
      },
      
      // Ajouter un √©l√©ment sans sauvegarder (pour ajout en masse)
      showMainContextMenu: (text, sel) => {
          els.bdCtxMenu.innerHTML = `<div class="ctx-title">Ajouter √† :</div>`; 
          
          CONFIG.bdCategories.forEach(cat => { 
              const div = document.createElement('div'); 
              div.innerText = cat; 
              
              if(cat === 'TECHNICIENS' || cat === 'COMEDIENS') {
                  div.innerHTML = `${cat} ‚ñ∂`;
                  div.style.cursor = 'pointer';
                  div.style.fontWeight = 'bold';
                  
                  const isCrew = cat === 'TECHNICIENS';
                  const dataList = isCrew ? state.data.crew : state.data.actors;
                  const itemLabel = isCrew ? 'technicien' : 'com√©dien';
                  
                  div.onclick = (ev) => {
                      ev.stopPropagation();
                      Breakdown.showPersonMenu(cat, text, sel, dataList, itemLabel);
                  };
              } else {
                  div.onclick = () => { 
                      Breakdown.addItem(state.activeBdSceneId, cat, text); 
                      els.bdCtxMenu.style.display = 'none'; 
                      if(sel) sel.removeAllRanges(); 
                  };
              }
              
              els.bdCtxMenu.appendChild(div); 
          });
      },
      
      showPersonMenu: (cat, text, sel, dataList, itemLabel) => {
          els.bdCtxMenu.innerHTML = '';
          
          // Cr√©er le titre avec bouton retour (tout cliquable)
          const titleDiv = document.createElement('div');
          titleDiv.className = 'ctx-title';
          titleDiv.style.cssText = 'display:flex; align-items:center; gap:10px; cursor:pointer;';
          titleDiv.innerHTML = `‚óÄ Ajouter ${itemLabel} :`;
          titleDiv.onclick = (ev) => {
              ev.stopPropagation();
              Breakdown.showMainContextMenu(text, sel);
          };
          els.bdCtxMenu.appendChild(titleDiv);
          
          // Option ajouter tous
          const addAllDiv = document.createElement('div');
          addAllDiv.innerText = `‚ö° TOUS les ${itemLabel}s`;
          addAllDiv.style.fontWeight = 'bold';
          addAllDiv.style.borderBottom = '2px solid var(--border)';
          addAllDiv.onclick = () => { 
              if(dataList && dataList.length > 0) {
                  dataList.forEach(person => {
                      Breakdown.addItemSilent(state.activeBdSceneId, cat, person.name);
                  });
                  Store.save();
                  Breakdown.init();
              }
              els.bdCtxMenu.style.display = 'none';
          };
          els.bdCtxMenu.appendChild(addAllDiv);
          
          // Liste des personnes
          if(dataList && dataList.length > 0) {
              dataList.forEach(person => {
                  const personDiv = document.createElement('div');
                  personDiv.innerText = `${person.name}${person.role ? ' (' + person.role + ')' : ''}`;
                  personDiv.onclick = () => { 
                      Breakdown.addItem(state.activeBdSceneId, cat, person.name); 
                      els.bdCtxMenu.style.display = 'none';
                  };
                  els.bdCtxMenu.appendChild(personDiv);
              });
          } else {
              const emptyDiv = document.createElement('div');
              emptyDiv.innerText = `(Aucun ${itemLabel})`;
              emptyDiv.style.color = 'var(--text-sec)';
              els.bdCtxMenu.appendChild(emptyDiv);
          }
      },
      
      addItemSilent: (sceneId, cat, text) => {
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          if(!scene.breakdown) scene.breakdown = {};
          if(!scene.breakdown[cat]) scene.breakdown[cat] = [];
          if(!scene.breakdown[cat].includes(text)) {
              scene.breakdown[cat].push(text);
          }
      },
      
      // Auto-ajouter les techniciens responsables d'une cat√©gorie
      autoAddResponsibleCrew: (sceneId, category) => {
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          
          if(!scene.breakdown) scene.breakdown = {};
          if(!scene.breakdown['TECHNICIENS']) scene.breakdown['TECHNICIENS'] = [];
          
          // Trouver les groupes responsables de cette cat√©gorie
          Object.keys(CONFIG.crewToBreakdownMap).forEach(groupId => {
              if(CONFIG.crewToBreakdownMap[groupId].includes(category)) {
                  // Trouver les techniciens de ce groupe
                  const members = state.data.crew.filter(c => c.group_id === groupId);
                  members.forEach(member => {
                      if(!scene.breakdown['TECHNICIENS'].includes(member.name)) {
                          scene.breakdown['TECHNICIENS'].push(member.name);
                      }
                  });
              }
          });
      },
      
      // Auto-cr√©er une fiche Ressource depuis le d√©pouillement
      autoCreateResource: (text, bdCategory) => {
          if(!state.data.resources) state.data.resources = [];
          
          // Mapper la cat√©gorie du d√©pouillement vers la cat√©gorie ressource
          const categoryMap = { 'ACCESSOIRES': 'accessoire', 'COSTUMES': 'costume', 'VEHICULES': 'vehicule' };
          const resCategory = categoryMap[bdCategory];
          if(!resCategory) return;
          
          // V√©rifier si une ressource avec ce nom exact existe d√©j√†
          const exists = state.data.resources.some(r => 
              r.name.toLowerCase() === text.toLowerCase() ||
              (r.aliases || []).some(a => a.toLowerCase() === text.toLowerCase())
          );
          
          if(!exists) {
              state.data.resources.push({
                  id: 'res_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7),
                  name: text,
                  category: resCategory,
                  photo: '',
                  description: '',
                  note: '',
                  owner: null,
                  aliases: [],
                  autoCreated: true
              });
          }
      },
      
      removeItem: async (sceneId, cat, idx, e) => { 
          if(e) e.stopPropagation(); 
          if(state.currentRole === 'viewer' || !Permissions.canEdit('depouillement')) return; 
          const scene = state.data.scenes.find(s => s.id === sceneId); 
          if(!scene || !scene.breakdown || !scene.breakdown[cat]) return;
          
          const itemName = scene.breakdown[cat][idx];
          
          // V√©rifier si c'est une ressource (ACCESSOIRES, COSTUMES, VEHICULES)
          if(cat === 'ACCESSOIRES' || cat === 'COSTUMES' || cat === 'VEHICULES') {
              const categoryMap = { 'ACCESSOIRES': 'accessoire', 'COSTUMES': 'costume', 'VEHICULES': 'vehicule' };
              const resCat = categoryMap[cat];
              const resource = (state.data.resources || []).find(r => 
                  r.category === resCat && (r.name.toLowerCase() === itemName.toLowerCase() || (r.aliases || []).some(a => a.toLowerCase() === itemName.toLowerCase()))
              );
              
              if(resource) {
                  // V√©rifier si c'est la derni√®re occurrence dans le d√©pouillement
                  let count = 0;
                  state.data.scenes.forEach(s => {
                      if(s.breakdown && s.breakdown[cat]) {
                          s.breakdown[cat].forEach(item => {
                              if(item.toLowerCase() === itemName.toLowerCase()) count++;
                          });
                      }
                  });
                  
                  if(count <= 1) {
                      const deleteResource = await UI.confirmModal({
                          title: 'üóëÔ∏è Supprimer aussi la fiche Ressource ?',
                          message: `"${itemName}" n'appara√Æt plus dans aucune sc√®ne. Voulez-vous aussi supprimer la fiche Ressource associ√©e ?`,
                          confirmText: 'Supprimer la fiche',
                          cancelText: 'Garder la fiche',
                          type: 'warning'
                      });
                      
                      if(deleteResource) {
                          state.data.resources = state.data.resources.filter(r => r.id !== resource.id);
                      }
                  }
              }
          }
          
          scene.breakdown[cat].splice(idx, 1); 
          Store.save(); 
          Breakdown.init(); 
      },
      
      // ========== EXPORT PDF D√âPOUILLEMENT ==========
      exportPDF: () => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF('p', 'mm', 'a4');
          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();
          const margin = 15;
          let y = margin;
          
          const projectTitle = state.data.title || 'Projet sans titre';
          const scenes = state.data.scenes || [];
          
          if(scenes.length === 0) {
              Utils.toast('Aucune sc√®ne √† exporter', 'warning');
              return;
          }
          
          // Couleurs par cat√©gorie
          const catColors = {
              'PERSONNAGES': [76, 175, 80],
              'FIGURANTS': [139, 195, 74],
              'COSTUMES': [156, 39, 176],
              'MAQUILLAGE': [233, 30, 99],
              'ACCESSOIRES': [255, 152, 0],
              'V√âHICULES': [96, 125, 139],
              'DECORS-LIEUX': [33, 150, 243],
              'EFFETS SP√âCIAUX': [244, 67, 54],
              'SONS': [0, 188, 212],
              'ANIMAUX': [121, 85, 72],
              'CASCADES': [255, 87, 34],
              'NOTES': [158, 158, 158]
          };
          
          // ===== PAGE DE TITRE =====
          doc.setFillColor(43, 110, 246);
          doc.rect(0, 0, pageWidth, 50, 'F');
          
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(24);
          doc.setFont('helvetica', 'bold');
          doc.text('D√âPOUILLEMENT', pageWidth / 2, 25, { align: 'center' });
          
          doc.setFontSize(14);
          doc.setFont('helvetica', 'normal');
          doc.text(projectTitle, pageWidth / 2, 38, { align: 'center' });
          
          y = 60;
          
          // L√©gende des cat√©gories
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(50, 50, 50);
          doc.text('L√©gende des cat√©gories :', margin, y);
          y += 6;
          
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          let legendX = margin;
          let legendCol = 0;
          Object.entries(catColors).forEach(([cat, rgb], idx) => {
              if(legendCol >= 3) {
                  legendCol = 0;
                  legendX = margin;
                  y += 5;
              }
              doc.setFillColor(rgb[0], rgb[1], rgb[2]);
              doc.circle(legendX + 2, y - 1, 2, 'F');
              doc.setTextColor(50, 50, 50);
              doc.text(cat, legendX + 6, y);
              legendX += 60;
              legendCol++;
          });
          
          y += 15;
          
          // ===== D√âPOUILLEMENT PAR SC√àNE =====
          scenes.forEach((scene, sceneIdx) => {
              const breakdown = scene.breakdown || {};
              const hasContent = Object.values(breakdown).some(arr => arr && arr.length > 0);
              
              if(!hasContent) return;
              
              // Nouvelle page si n√©cessaire
              if(y > pageHeight - 60) {
                  doc.addPage();
                  y = margin;
              }
              
              // En-t√™te de sc√®ne
              doc.setFillColor(240, 240, 240);
              doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
              doc.setDrawColor(200, 200, 200);
              doc.rect(margin, y, pageWidth - margin * 2, 10, 'S');
              
              doc.setFontSize(10);
              doc.setFont('helvetica', 'bold');
              doc.setTextColor(50, 50, 50);
              const sceneTitle = `#${sceneIdx + 1} - ${scene.title || 'Sans titre'}`;
              doc.text(sceneTitle, margin + 3, y + 7);
              
              // Badge statut
              if(scene.isFinal) {
                  doc.setFillColor(40, 167, 69);
                  doc.setTextColor(255, 255, 255);
                  doc.roundedRect(pageWidth - margin - 20, y + 2, 18, 6, 1, 1, 'F');
                  doc.setFontSize(6);
                  doc.text('FINAL', pageWidth - margin - 11, y + 6, { align: 'center' });
              } else {
                  doc.setFillColor(255, 193, 7);
                  doc.setTextColor(0, 0, 0);
                  doc.roundedRect(pageWidth - margin - 25, y + 2, 23, 6, 1, 1, 'F');
                  doc.setFontSize(6);
                  doc.text('BROUILLON', pageWidth - margin - 13.5, y + 6, { align: 'center' });
              }
              
              y += 14;
              
              // Cat√©gories du d√©pouillement
              Object.entries(breakdown).forEach(([cat, items]) => {
                  if(!items || items.length === 0) return;
                  
                  if(y > pageHeight - 25) {
                      doc.addPage();
                      y = margin;
                  }
                  
                  const rgb = catColors[cat] || [100, 100, 100];
                  
                  // Nom de la cat√©gorie
                  doc.setFillColor(rgb[0], rgb[1], rgb[2]);
                  doc.circle(margin + 2, y + 1, 2, 'F');
                  doc.setFontSize(9);
                  doc.setFont('helvetica', 'bold');
                  doc.setTextColor(rgb[0], rgb[1], rgb[2]);
                  doc.text(cat, margin + 6, y + 2);
                  
                  // Liste des √©l√©ments
                  doc.setFont('helvetica', 'normal');
                  doc.setTextColor(50, 50, 50);
                  doc.setFontSize(8);
                  
                  const itemsText = items.map(item => typeof item === 'string' ? item : item.name || item).join(', ');
                  const lines = doc.splitTextToSize(itemsText, pageWidth - margin * 2 - 10);
                  
                  y += 5;
                  lines.forEach(line => {
                      if(y > pageHeight - 15) {
                          doc.addPage();
                          y = margin;
                      }
                      doc.text(line, margin + 6, y);
                      y += 4;
                  });
                  
                  y += 3;
              });
              
              y += 8;
          });
          
          // ===== R√âCAPITULATIF GLOBAL =====
          doc.addPage();
          y = margin;
          
          doc.setFillColor(43, 110, 246);
          doc.rect(0, 0, pageWidth, 20, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(14);
          doc.setFont('helvetica', 'bold');
          doc.text('R√âCAPITULATIF GLOBAL', pageWidth / 2, 13, { align: 'center' });
          
          y = 30;
          
          // Agr√©gation par cat√©gorie
          const globalBreakdown = {};
          scenes.forEach(scene => {
              const breakdown = scene.breakdown || {};
              Object.entries(breakdown).forEach(([cat, items]) => {
                  if(!items || items.length === 0) return;
                  if(!globalBreakdown[cat]) globalBreakdown[cat] = new Set();
                  items.forEach(item => {
                      const name = typeof item === 'string' ? item : item.name || item;
                      globalBreakdown[cat].add(name);
                  });
              });
          });
          
          Object.entries(globalBreakdown).forEach(([cat, itemsSet]) => {
              if(y > pageHeight - 30) {
                  doc.addPage();
                  y = margin;
              }
              
              const rgb = catColors[cat] || [100, 100, 100];
              const items = Array.from(itemsSet);
              
              // En-t√™te cat√©gorie
              doc.setFillColor(rgb[0], rgb[1], rgb[2]);
              doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
              doc.setTextColor(255, 255, 255);
              doc.setFontSize(10);
              doc.setFont('helvetica', 'bold');
              doc.text(`${cat} (${items.length})`, margin + 3, y + 6);
              y += 10;
              
              // Liste
              doc.setTextColor(50, 50, 50);
              doc.setFontSize(9);
              doc.setFont('helvetica', 'normal');
              
              items.forEach((item, idx) => {
                  if(y > pageHeight - 15) {
                      doc.addPage();
                      y = margin;
                  }
                  // Compter dans combien de sc√®nes
                  const sceneCount = scenes.filter(s => {
                      const bd = s.breakdown?.[cat] || [];
                      return bd.some(i => (typeof i === 'string' ? i : i.name) === item);
                  }).length;
                  
                  doc.text(`‚Ä¢ ${item}`, margin + 3, y);
                  doc.setTextColor(150, 150, 150);
                  doc.text(`(${sceneCount} sc√®ne${sceneCount > 1 ? 's' : ''})`, margin + 100, y);
                  doc.setTextColor(50, 50, 50);
                  y += 5;
              });
              
              y += 8;
          });
          
          // ===== PIED DE PAGE =====
          const totalPages = doc.internal.getNumberOfPages();
          for(let i = 1; i <= totalPages; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.setTextColor(150, 150, 150);
              doc.text(`${projectTitle} - D√©pouillement`, margin, pageHeight - 8);
              doc.text(`Page ${i}/${totalPages}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
              doc.text(`G√©n√©r√© par Moteur - ${new Date().toLocaleDateString('fr-FR')}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
          }
          
          // T√©l√©charger
          const filename = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'depouillement') + '_depouillement.pdf';
          doc.save(filename);
          
          Utils.toast('D√©pouillement PDF export√© !', 'success');
          History.log('EXPORT', 'D√©pouillement PDF g√©n√©r√©');
      }
  };

// ============ MOOD BOARD MODULE ============
const ColorWheel = {
    canvas: null,
    ctx: null,
    size: 280,
    centerX: 140,
    centerY: 140,
    radius: 130,
    baseHue: 0,
    baseSaturation: 100,
    brightness: 50,
    harmony: 'analogous',
    colors: [],
    isDragging: false,
    onComplete: null,
    
    harmonies: {
        analogous: { name: 'Semblable', angles: [-30, -15, 0, 15, 30], saturations: null },
        shades: { name: 'Nuances', angles: [0, 0, 0, 0, 0], saturations: [100, 75, 50, 25, 10], lightnesses: [25, 35, 50, 65, 80] },
        complementary: { name: 'Compl√©mentaire', angles: [0, 15, 180, 165, 195], saturations: [100, 60, 100, 70, 70] },
        splitComplementary: { name: 'Compl. partag√©es', angles: [0, 10, 150, 180, 210], saturations: null },
        triadic: { name: 'Triade', angles: [0, 120, 240, 10, 130], saturations: [100, 100, 100, 60, 60] },
        tetradic: { name: 'Carr√©', angles: [0, 90, 180, 270, 45], saturations: null },
        compound: { name: 'Composite', angles: [0, 30, 60, 180, 210], saturations: null },
        monochromatic: { name: 'Monochrome', angles: [0, 0, 0, 0, 0], saturations: [100, 80, 60, 40, 20] }
    },
    
    open: (callback) => {
        ColorWheel.onComplete = callback;
        ColorWheel.baseHue = Math.random() * 360;
        ColorWheel.baseSaturation = 100;
        ColorWheel.brightness = 50;
        ColorWheel.harmony = 'analogous';
        
        const modal = document.createElement('div');
        modal.className = 'color-wheel-modal';
        modal.id = 'colorWheelModal';
        modal.onclick = (e) => { if(e.target === modal) ColorWheel.close(); };
        
        modal.innerHTML = `
            <div class="color-wheel-container">
                <div class="color-wheel-header">
                    <h3>üé® G√©n√©rateur de palette</h3>
                    <button class="color-wheel-close" onclick="ColorWheel.close()">‚úï</button>
                </div>
                <div class="color-wheel-body">
                    <div class="color-wheel-left">
                        <div class="color-wheel-canvas-wrap" id="colorWheelWrap">
                            <canvas id="colorWheelCanvas" width="280" height="280"></canvas>
                        </div>
                        <div class="harmony-selector">
                            <label>Type d'harmonie</label>
                            <select id="harmonySelect" onchange="ColorWheel.setHarmony(this.value)">
                                <option value="analogous">Semblable (Analogues)</option>
                                <option value="shades">Nuances</option>
                                <option value="complementary">Compl√©mentaire</option>
                                <option value="splitComplementary">Compl√©mentaires partag√©es</option>
                                <option value="triadic">Triade</option>
                                <option value="tetradic">Carr√© (T√©tradique)</option>
                                <option value="compound">Composite</option>
                                <option value="monochromatic">Monochrome</option>
                            </select>
                        </div>
                        <div class="brightness-slider">
                            <label>Luminosit√©: <span id="brightnessValue">50</span>%</label>
                            <input type="range" id="brightnessRange" min="10" max="90" value="50" oninput="ColorWheel.setBrightness(this.value)">
                        </div>
                    </div>
                    <div class="color-wheel-right">
                        <div class="generated-colors" id="generatedColors"></div>
                    </div>
                </div>
                <div class="color-wheel-actions">
                    <button class="cancel" onclick="ColorWheel.close()">Annuler</button>
                    <button class="confirm" onclick="ColorWheel.addToBoard()">Ajouter au moodboard</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        ColorWheel.canvas = document.getElementById('colorWheelCanvas');
        ColorWheel.ctx = ColorWheel.canvas.getContext('2d');
        
        ColorWheel.drawWheel();
        ColorWheel.generateColors();
        ColorWheel.updateMarkers();
        ColorWheel.setupEvents();
    },
    
    close: () => {
        const modal = document.getElementById('colorWheelModal');
        if(modal) modal.remove();
    },
    
    drawWheel: () => {
        const ctx = ColorWheel.ctx;
        const cx = ColorWheel.centerX;
        const cy = ColorWheel.centerY;
        const radius = ColorWheel.radius;
        
        ctx.clearRect(0, 0, ColorWheel.size, ColorWheel.size);
        
        for(let angle = 0; angle < 360; angle += 1) {
            for(let r = 0; r < radius; r += 1) {
                const hue = angle;
                const saturation = (r / radius) * 100;
                const lightness = ColorWheel.brightness;
                
                ctx.beginPath();
                ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                
                const rad = (angle - 90) * Math.PI / 180;
                const x = cx + r * Math.cos(rad);
                const y = cy + r * Math.sin(rad);
                
                ctx.arc(x, y, 1.5, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        ctx.lineWidth = 2;
        ctx.stroke();
    },
    
    setupEvents: () => {
        const wrap = document.getElementById('colorWheelWrap');
        
        wrap.addEventListener('mousedown', (e) => {
            ColorWheel.isDragging = true;
            ColorWheel.handleDrag(e);
        });
        
        document.addEventListener('mousemove', (e) => {
            if(ColorWheel.isDragging) ColorWheel.handleDrag(e);
        });
        
        document.addEventListener('mouseup', () => {
            ColorWheel.isDragging = false;
        });
    },
    
    handleDrag: (e) => {
        const rect = ColorWheel.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left - ColorWheel.centerX;
        const y = e.clientY - rect.top - ColorWheel.centerY;
        
        let angle = Math.atan2(y, x) * 180 / Math.PI + 90;
        if(angle < 0) angle += 360;
        
        const distance = Math.sqrt(x * x + y * y);
        const saturation = Math.min(100, Math.max(10, (distance / ColorWheel.radius) * 100));
        
        ColorWheel.baseHue = angle;
        ColorWheel.baseSaturation = saturation;
        
        ColorWheel.generateColors();
        ColorWheel.updateMarkers();
    },
    
    setHarmony: (harmony) => {
        ColorWheel.harmony = harmony;
        ColorWheel.generateColors();
        ColorWheel.updateMarkers();
    },
    
    setBrightness: (value) => {
        ColorWheel.brightness = parseInt(value);
        document.getElementById('brightnessValue').textContent = value;
        ColorWheel.drawWheel();
        ColorWheel.generateColors();
        ColorWheel.updateMarkers();
    },
    
    generateColors: () => {
        const h = ColorWheel.harmony;
        const harmonyData = ColorWheel.harmonies[h];
        const baseHue = ColorWheel.baseHue;
        const baseSat = ColorWheel.baseSaturation;
        const light = ColorWheel.brightness;
        
        ColorWheel.colors = [];
        
        for(let i = 0; i < 5; i++) {
            let hue = (baseHue + harmonyData.angles[i] + 360) % 360;
            // Appliquer la saturation de base proportionnellement
            let sat;
            if(harmonyData.saturations) {
                sat = (harmonyData.saturations[i] / 100) * baseSat;
            } else {
                sat = baseSat;
            }
            let l = harmonyData.lightnesses ? harmonyData.lightnesses[i] : light;
            
            ColorWheel.colors.push({
                hue: hue,
                saturation: Math.round(sat),
                lightness: l,
                hex: ColorWheel.hslToHex(hue, sat, l)
            });
        }
        
        ColorWheel.renderColors();
    },
    
    hslToHex: (h, s, l) => {
        s /= 100;
        l /= 100;
        const a = s * Math.min(l, 1 - l);
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
    },
    
    hexToRgb: (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    },
    
    renderColors: () => {
        const container = document.getElementById('generatedColors');
        if(!container) return;
        
        container.innerHTML = ColorWheel.colors.map((c, i) => {
            const rgb = ColorWheel.hexToRgb(c.hex);
            return `
                <div class="generated-color-item" onclick="navigator.clipboard.writeText('${c.hex}'); Utils.toast('${c.hex} copi√© !', 'success');">
                    <div class="generated-color-swatch" style="background: ${c.hex}"></div>
                    <div class="generated-color-info">
                        <div class="generated-color-hex">${c.hex}</div>
                        <div class="generated-color-rgb">RGB(${rgb.r}, ${rgb.g}, ${rgb.b})</div>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    updateMarkers: () => {
        const wrap = document.getElementById('colorWheelWrap');
        if(!wrap) return;
        
        wrap.querySelectorAll('.color-wheel-marker').forEach(m => m.remove());
        
        ColorWheel.colors.forEach((c, i) => {
            const marker = document.createElement('div');
            marker.className = 'color-wheel-marker' + (i === 0 ? ' main draggable' : '');
            
            const rad = (c.hue - 90) * Math.PI / 180;
            const dist = (c.saturation / 100) * ColorWheel.radius;
            const x = ColorWheel.centerX + dist * Math.cos(rad);
            const y = ColorWheel.centerY + dist * Math.sin(rad);
            
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            marker.style.backgroundColor = c.hex;
            
            wrap.appendChild(marker);
        });
    },
    
    addToBoard: () => {
        const hexColors = ColorWheel.colors.map(c => c.hex);
        const harmonyName = ColorWheel.harmonies[ColorWheel.harmony].name;
        
        ColorWheel.close();
        
        if(ColorWheel.onComplete) {
            ColorWheel.onComplete(hexColors, harmonyName);
        }
    }
};

const MoodBoard = {
    currentBoardId: null,
    selectedElementId: null,
    zoom: 1,
    panX: 0,
    panY: 0,
    isPanning: false,
    panStartX: 0,
    panStartY: 0,
    isDraggingElement: false,
    isResizingElement: false,
    resizeHandle: null,
    dragOffsetX: 0,
    dragOffsetY: 0,
    
    init: () => {
        MoodBoard.renderBoardsList();
        MoodBoard.setupCanvasEvents();
        MoodBoard.updateEmptyState();
    },
    
    // Initialiser les √©v√©nements du canvas
    setupCanvasEvents: () => {
        const wrapper = document.getElementById('moodboardCanvasWrapper');
        const canvas = document.getElementById('moodboardCanvas');
        if(!wrapper || !canvas) return;
        
        // Menu radial au clic droit
        wrapper.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const board = MoodBoard.getCurrentBoard();
            if(!board) return;
            
            // Position du clic relative au canvas
            const rect = canvas.getBoundingClientRect();
            MoodBoard.contextX = (e.clientX - rect.left - MoodBoard.panX) / MoodBoard.zoom;
            MoodBoard.contextY = (e.clientY - rect.top - MoodBoard.panY) / MoodBoard.zoom;
            
            // V√©rifier si on clique sur un √©l√©ment
            const clickedElement = e.target.closest('.moodboard-element');
            if(clickedElement) {
                MoodBoard.showElementContextMenu(e.clientX, e.clientY, clickedElement.dataset.id);
            } else {
                MoodBoard.showRadialMenu(e.clientX, e.clientY);
            }
        });
        
        // Pan avec clic milieu ou espace + clic
        wrapper.addEventListener('mousedown', (e) => {
            if(e.target === canvas || e.target === wrapper) {
                if(e.button === 1 || (e.button === 0 && e.target === canvas)) {
                    MoodBoard.isPanning = true;
                    MoodBoard.panStartX = e.clientX - MoodBoard.panX;
                    MoodBoard.panStartY = e.clientY - MoodBoard.panY;
                    canvas.classList.add('dragging');
                    e.preventDefault();
                }
                // D√©s√©lectionner si clic sur canvas vide
                if(e.target === canvas) {
                    MoodBoard.selectElement(null);
                }
            }
        });
        
        wrapper.addEventListener('mousemove', (e) => {
            if(MoodBoard.isPanning) {
                MoodBoard.panX = e.clientX - MoodBoard.panStartX;
                MoodBoard.panY = e.clientY - MoodBoard.panStartY;
                MoodBoard.updateCanvasTransform();
            }
        });
        
        wrapper.addEventListener('mouseup', () => {
            MoodBoard.isPanning = false;
            canvas.classList.remove('dragging');
        });
        
        wrapper.addEventListener('mouseleave', () => {
            MoodBoard.isPanning = false;
            canvas.classList.remove('dragging');
        });
        
        // Zoom avec molette
        wrapper.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newZoom = Math.max(0.1, Math.min(3, MoodBoard.zoom + delta));
            MoodBoard.zoom = newZoom;
            MoodBoard.updateCanvasTransform();
            MoodBoard.updateZoomDisplay();
        });
        
        // Drag & drop fichiers
        wrapper.addEventListener('dragover', (e) => {
            e.preventDefault();
            wrapper.style.background = 'rgba(59, 130, 246, 0.1)';
        });
        
        wrapper.addEventListener('dragleave', () => {
            wrapper.style.background = '';
        });
        
        wrapper.addEventListener('drop', (e) => {
            e.preventDefault();
            wrapper.style.background = '';
            const files = e.dataTransfer.files;
            if(files.length > 0) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / MoodBoard.zoom;
                const y = (e.clientY - rect.top) / MoodBoard.zoom;
                Array.from(files).forEach((file, i) => {
                    if(file.type.startsWith('image/')) {
                        MoodBoard.addImageFromFile(file, x + i * 20, y + i * 20);
                    }
                });
            }
        });
    },
    
    updateCanvasTransform: () => {
        const canvas = document.getElementById('moodboardCanvas');
        if(canvas) {
            canvas.style.transform = `translate(${MoodBoard.panX}px, ${MoodBoard.panY}px) scale(${MoodBoard.zoom})`;
        }
        MoodBoard.updateMinimap();
    },
    
    updateZoomDisplay: () => {
        const display = document.getElementById('moodboardZoomLevel');
        if(display) {
            display.textContent = Math.round(MoodBoard.zoom * 100) + '%';
        }
    },
    
    zoomIn: () => {
        MoodBoard.zoom = Math.min(3, MoodBoard.zoom + 0.1);
        MoodBoard.updateCanvasTransform();
        MoodBoard.updateZoomDisplay();
    },
    
    zoomOut: () => {
        MoodBoard.zoom = Math.max(0.1, MoodBoard.zoom - 0.1);
        MoodBoard.updateCanvasTransform();
        MoodBoard.updateZoomDisplay();
    },
    
    zoomReset: () => {
        MoodBoard.zoom = 1;
        MoodBoard.panX = 0;
        MoodBoard.panY = 0;
        MoodBoard.updateCanvasTransform();
        MoodBoard.updateZoomDisplay();
    },
    
    updateMinimap: () => {
        // TODO: Impl√©menter la minimap
    },
    
    updateEmptyState: () => {
        const empty = document.getElementById('moodboardEmpty');
        const canvas = document.getElementById('moodboardCanvas');
        const boards = state.data.moodboards || [];
        
        if(boards.length === 0) {
            if(empty) empty.style.display = 'flex';
            if(canvas) canvas.style.display = 'none';
        } else {
            if(empty) empty.style.display = 'none';
            if(canvas) canvas.style.display = 'block';
        }
    },
    
    // ===== GESTION DES PLANCHES =====
    
    createBoard: async () => {
        // Cr√©er une modale personnalis√©e avec nom + liaison
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'confirm-modal-overlay';
            modal.onclick = (e) => { if(e.target === modal) { modal.remove(); resolve(); } };
            
            // Construire les options de liaison par cat√©gories
            let linkOptionsHtml = '<option value="project">üé¨ Projet entier</option>';
            
            // Sc√®nes
            if((state.data.scenes || []).length > 0) {
                linkOptionsHtml += '<optgroup label="üìÑ Sc√®nes">';
                (state.data.scenes || []).forEach((scene, i) => {
                    linkOptionsHtml += `<option value="scene_${scene.id}">Sc√®ne ${i+1}: ${Utils.escape(scene.title || 'Sans titre')}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            // Personnages
            if((state.data.characters || []).length > 0) {
                linkOptionsHtml += '<optgroup label="üë§ Personnages">';
                (state.data.characters || []).forEach(char => {
                    linkOptionsHtml += `<option value="character_${char.id}">${Utils.escape(char.name)}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            // Com√©diens
            if((state.data.actors || []).length > 0) {
                linkOptionsHtml += '<optgroup label="üé≠ Com√©diens">';
                (state.data.actors || []).forEach(actor => {
                    linkOptionsHtml += `<option value="actor_${actor.id}">${Utils.escape(actor.name)}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            // D√©cors
            if((state.data.locations || []).length > 0) {
                linkOptionsHtml += '<optgroup label="üìç D√©cors">';
                (state.data.locations || []).forEach(loc => {
                    linkOptionsHtml += `<option value="location_${loc.id}">${Utils.escape(loc.name)}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            // Ressources
            if((state.data.resources || []).length > 0) {
                linkOptionsHtml += '<optgroup label="üì¶ Ressources">';
                (state.data.resources || []).forEach(res => {
                    linkOptionsHtml += `<option value="resource_${res.id}">${Utils.escape(res.name)}</option>`;
                });
                linkOptionsHtml += '</optgroup>';
            }
            
            modal.innerHTML = `
                <div class="confirm-modal-box" style="max-width: 450px;">
                    <div class="confirm-modal-icon">üé®</div>
                    <div class="confirm-modal-title">Nouvelle planche</div>
                    <div style="text-align: left; margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nom de la planche :</label>
                        <input type="text" id="mbNewBoardName" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);" value="Planche ${(state.data.moodboards || []).length + 1}" placeholder="Ex: Ambiance g√©n√©rale...">
                    </div>
                    <div style="text-align: left; margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Lier √† :</label>
                        <select id="mbNewBoardLink" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                            ${linkOptionsHtml}
                        </select>
                    </div>
                    <div class="confirm-modal-buttons">
                        <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                        <button class="confirm-modal-btn confirm" id="mbCreateBoardBtn">Cr√©er</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const nameInput = modal.querySelector('#mbNewBoardName');
            const linkSelect = modal.querySelector('#mbNewBoardLink');
            const createBtn = modal.querySelector('#mbCreateBoardBtn');
            
            nameInput.focus();
            nameInput.select();
            
            nameInput.onkeydown = (e) => { if(e.key === 'Enter') createBtn.click(); if(e.key === 'Escape') modal.remove(); };
            
            createBtn.onclick = () => {
                const name = nameInput.value.trim();
                if(!name) {
                    Utils.toast('Entrez un nom pour la planche', 'warning');
                    return;
                }
                
                const linkValue = linkSelect.value;
                let linkedTo = { type: 'project' };
                if(linkValue !== 'project') {
                    const [type, ...idParts] = linkValue.split('_');
                    linkedTo = { type, id: idParts.join('_') };
                }
                
                if(!state.data.moodboards) state.data.moodboards = [];
                
                const board = {
                    id: 'mb_' + Date.now(),
                    name: name,
                    format: 'free',
                    linkedTo: linkedTo,
                    elements: [],
                    createdAt: Date.now(),
                    modifiedAt: Date.now()
                };
                
                state.data.moodboards.push(board);
                Store.save();
                
                modal.remove();
                
                MoodBoard.renderBoardsList();
                MoodBoard.selectBoard(board.id);
                MoodBoard.updateEmptyState();
                
                Utils.toast('Planche "' + name + '" cr√©√©e', 'success');
                resolve(board);
            };
        });
    },
    
    renderBoardsList: () => {
        const container = document.getElementById('moodboardBoardsList');
        if(!container) return;
        
        const boards = state.data.moodboards || [];
        
        if(boards.length === 0) {
            container.innerHTML = '<span style="color: var(--text-sec); font-style: italic; padding: 5px;">Aucune planche</span>';
            return;
        }
        
        container.innerHTML = boards.map(board => {
            const isActive = board.id === MoodBoard.currentBoardId;
            const linkedIcon = board.linkedTo ? 'üîó ' : '';
            return `
                <div class="moodboard-board-tab ${isActive ? 'active' : ''}" onclick="app.MoodBoard.selectBoard('${board.id}')">
                    ${linkedIcon}${Utils.escape(board.name)}
                    <span class="tab-close" onclick="event.stopPropagation(); app.MoodBoard.deleteBoard('${board.id}')">√ó</span>
                </div>
            `;
        }).join('');
        
        // Bouton ajouter
        container.innerHTML += `
            <div class="moodboard-board-tab" onclick="app.MoodBoard.createBoard()" style="border-style: dashed;">
                + Nouvelle
            </div>
        `;
    },
    
    selectBoard: (boardId) => {
        MoodBoard.currentBoardId = boardId;
        MoodBoard.selectedElementId = null;
        
        // S'assurer que la planche a un tableau elements
        const board = MoodBoard.getCurrentBoard();
        if(board && !board.elements) {
            board.elements = [];
            Store.save();
        }
        
        MoodBoard.renderBoardsList();
        MoodBoard.renderCanvas();
        
        // Mettre √† jour le format
        if(board) {
            const formatSelect = document.getElementById('moodboardFormat');
            if(formatSelect) formatSelect.value = board.format || 'free';
        }
    },
    
    getCurrentBoard: () => {
        if(!MoodBoard.currentBoardId) return null;
        const board = (state.data.moodboards || []).find(b => b.id === MoodBoard.currentBoardId);
        if(board && !board.elements) {
            board.elements = [];
        }
        return board;
    },
    
    deleteBoard: async (boardId) => {
        const board = (state.data.moodboards || []).find(b => b.id === boardId);
        if(!board) return;
        
        const confirmed = await ConfirmModal.show({
            title: 'Supprimer la planche ?',
            message: `Voulez-vous vraiment supprimer "${board.name}" et tous ses √©l√©ments ?`,
            type: 'danger',
            confirmText: 'Supprimer'
        });
        
        if(!confirmed) return;
        
        state.data.moodboards = state.data.moodboards.filter(b => b.id !== boardId);
        
        if(MoodBoard.currentBoardId === boardId) {
            MoodBoard.currentBoardId = state.data.moodboards.length > 0 ? state.data.moodboards[0].id : null;
        }
        
        Store.save();
        MoodBoard.renderBoardsList();
        MoodBoard.renderCanvas();
        MoodBoard.updateEmptyState();
        
        Utils.toast('Planche supprim√©e', 'success');
    },
    
    changeFormat: (format) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        board.format = format;
        board.modifiedAt = Date.now();
        Store.save();
        
        // Mettre √† jour la classe du canvas
        const canvas = document.getElementById('moodboardCanvas');
        if(canvas) {
            canvas.className = 'moodboard-canvas format-' + format;
        }
        
        // Synchroniser tous les selects de format
        const formatSelect = document.getElementById('moodboardFormat');
        if(formatSelect) formatSelect.value = format;
        
        // Mettre √† jour le panneau info si ouvert
        MoodBoard.updateInfoPanel();
        
        // Recentrer la vue
        MoodBoard.zoomReset();
        
        Utils.toast('Format: ' + format.replace('-', ' ').toUpperCase(), 'success');
    },
    
    // ===== GESTION DES √âL√âMENTS =====
    
    addElement: async (type) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('Cr√©ez d\'abord une planche', 'warning');
            return;
        }
        
        let element = {
            id: 'el_' + Date.now(),
            type: type,
            x: 100 + Math.random() * 200,
            y: 100 + Math.random() * 200,
            width: 200,
            height: 200,
            linkedTo: null,
            createdAt: Date.now()
        };
        
        if(type === 'image') {
            // Ouvrir le s√©lecteur de fichier
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    MoodBoard.addImageFromFile(file, element.x, element.y);
                }
            };
            input.click();
            return;
        }
        
        if(type === 'text') {
            element.content = 'Double-cliquez pour √©diter...';
            element.fontSize = 16;
            element.width = 250;
            element.height = 150;
        }
        
        if(type === 'palette') {
            element.colors = ['#264653', '#2a9d8f', '#e9c46a', '#f4a261', '#e76f51', '#ffffff'];
            element.width = 180;
            element.height = 130;
        }
        
        if(type === 'link') {
            const url = await ConfirmModal.prompt({
                title: 'Ajouter un lien',
                message: 'URL du lien (image, vid√©o, r√©f√©rence...) :',
                placeholder: 'https://...'
            });
            if(!url) return;
            
            element.url = url;
            element.title = url.split('/').pop() || 'Lien';
            element.width = 180;
            element.height = 120;
        }
        
        board.elements.push(element);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        MoodBoard.selectElement(element.id);
    },
    
    addImageFromFile: (file, x, y) => {
        const boardId = MoodBoard.currentBoardId;
        if(!boardId) {
            Utils.toast('S√©lectionnez d\'abord une planche', 'warning');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            const img = new Image();
            img.onload = () => {
                // R√©cup√©rer la planche au moment de l'ajout (pas avant)
                const board = MoodBoard.getCurrentBoard();
                if(!board) {
                    Utils.toast('Erreur: planche non trouv√©e', 'error');
                    return;
                }
                
                // Calculer les dimensions proportionnelles
                let width = img.width;
                let height = img.height;
                const maxSize = 400;
                
                if(width > maxSize || height > maxSize) {
                    if(width > height) {
                        height = (height / width) * maxSize;
                        width = maxSize;
                    } else {
                        width = (width / height) * maxSize;
                        height = maxSize;
                    }
                }
                
                const element = {
                    id: 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    type: 'image',
                    x: x || 100,
                    y: y || 100,
                    width: Math.round(width),
                    height: Math.round(height),
                    src: dataUrl,
                    fileName: file.name,
                    linkedTo: null,
                    createdAt: Date.now()
                };
                
                board.elements.push(element);
                board.modifiedAt = Date.now();
                Store.save();
                
                MoodBoard.renderCanvas();
                Utils.toast('Image ajout√©e: ' + file.name, 'success');
            };
            img.onerror = () => {
                Utils.toast('Erreur de chargement de l\'image', 'error');
            };
            img.src = dataUrl;
        };
        reader.onerror = () => {
            Utils.toast('Erreur de lecture du fichier', 'error');
        };
        reader.readAsDataURL(file);
    },
    
    renderElementsList: () => {
        const container = document.getElementById('moodboardElementsList');
        const countEl = document.getElementById('moodboardElementsCount');
        if(!container) return;
        
        const board = MoodBoard.getCurrentBoard();
        if(!board || !board.elements || board.elements.length === 0) {
            container.innerHTML = '<p style="color: var(--text-sec); text-align: center; padding: 20px; font-size: 0.85rem;">Aucun √©l√©ment<br><small>Clic droit sur le canvas pour ajouter</small></p>';
            if(countEl) countEl.textContent = '0';
            return;
        }
        
        if(countEl) countEl.textContent = board.elements.length;
        
        const typeIcons = {
            'image': 'üñºÔ∏è',
            'drawing': '‚úèÔ∏è',
            'text': 'üìù',
            'palette': 'üé®',
            'link': 'üîó',
            'file': 'üìÅ'
        };
        
        const typeLabels = {
            'image': 'Image',
            'drawing': 'Dessin',
            'text': 'Texte',
            'palette': 'Palette',
            'link': 'Lien',
            'file': 'Fichier'
        };
        
        container.innerHTML = board.elements.map(el => {
            const isSelected = el.id === MoodBoard.selectedElementId;
            const icon = typeIcons[el.type] || 'üìÑ';
            const typeLabel = typeLabels[el.type] || el.type;
            
            let name = '';
            if(el.type === 'text') name = (el.content || '').substring(0, 25) + (el.content?.length > 25 ? '...' : '');
            else if(el.type === 'image' || el.type === 'file') name = el.fileName || 'Sans nom';
            else if(el.type === 'palette') name = el.paletteName || 'Palette';
            else if(el.type === 'link') name = el.title || 'Lien';
            else if(el.type === 'drawing') name = 'Dessin';
            else name = typeLabel;
            
            let linkedHtml = '';
            if(el.linkedTo) {
                const linkedLabel = MoodBoard.getLinkLabel(el.linkedTo);
                linkedHtml = `<div class="el-linked">üîó ${linkedLabel}</div>`;
            }
            
            return `
                <div class="moodboard-element-item ${isSelected ? 'selected' : ''}" 
                     onclick="app.MoodBoard.selectElement('${el.id}')"
                     ondblclick="app.MoodBoard.focusElement('${el.id}')">
                    <span class="el-icon">${icon}</span>
                    <div class="el-info">
                        <div class="el-type">${typeLabel}</div>
                        <div class="el-name">${Utils.escape(name)}</div>
                        ${linkedHtml}
                    </div>
                    <div class="el-actions">
                        <button onclick="event.stopPropagation(); app.MoodBoard.editElement('${el.id}')" title="Modifier">‚úèÔ∏è</button>
                        <button onclick="event.stopPropagation(); app.MoodBoard.deleteElement('${el.id}')" title="Supprimer">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    getLinkLabel: (linkedTo) => {
        if(!linkedTo) return '';
        if(linkedTo.type === 'project') return 'Projet';
        
        const collections = {
            'scene': state.data.scenes,
            'character': state.data.characters,
            'actor': state.data.actors,
            'location': state.data.locations,
            'resource': state.data.resources
        };
        
        const labels = {
            'scene': 'Sc√®ne',
            'character': 'Personnage',
            'actor': 'Com√©dien',
            'location': 'D√©cor',
            'resource': 'Ressource'
        };
        
        const collection = collections[linkedTo.type] || [];
        const item = collection.find(i => i.id === linkedTo.id);
        
        if(item) {
            return `${labels[linkedTo.type]}: ${item.name || item.title || linkedTo.id}`;
        }
        return labels[linkedTo.type] || linkedTo.type;
    },
    
    moveElementUp: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const index = board.elements.findIndex(el => el.id === elementId);
        if(index < board.elements.length - 1) {
            // √âchanger avec l'√©l√©ment suivant (plus haut dans le z-index)
            const temp = board.elements[index];
            board.elements[index] = board.elements[index + 1];
            board.elements[index + 1] = temp;
            
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('√âl√©ment mont√©', 'success');
        } else {
            Utils.toast('D√©j√† au premier plan', 'info');
        }
    },
    
    moveElementDown: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const index = board.elements.findIndex(el => el.id === elementId);
        if(index > 0) {
            // √âchanger avec l'√©l√©ment pr√©c√©dent (plus bas dans le z-index)
            const temp = board.elements[index];
            board.elements[index] = board.elements[index - 1];
            board.elements[index - 1] = temp;
            
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('√âl√©ment descendu', 'success');
        } else {
            Utils.toast('D√©j√† en arri√®re-plan', 'info');
        }
    },
    
    focusElement: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        // Centrer la vue sur l'√©l√©ment
        const wrapper = document.getElementById('moodboardCanvasWrapper');
        if(!wrapper) return;
        
        const wrapperRect = wrapper.getBoundingClientRect();
        const centerX = wrapperRect.width / 2;
        const centerY = wrapperRect.height / 2;
        
        MoodBoard.panX = centerX - (element.x + element.width / 2) * MoodBoard.zoom;
        MoodBoard.panY = centerY - (element.y + element.height / 2) * MoodBoard.zoom;
        
        MoodBoard.updateCanvasTransform();
        MoodBoard.selectElement(elementId);
    },
    
    renderCanvas: () => {
        const canvas = document.getElementById('moodboardCanvas');
        if(!canvas) return;
        
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            canvas.innerHTML = '';
            MoodBoard.renderElementsList();
            return;
        }
        
        // Appliquer le format
        canvas.className = 'moodboard-canvas format-' + (board.format || 'free');
        
        // Rendre les √©l√©ments
        canvas.innerHTML = board.elements.map(el => MoodBoard.renderElement(el)).join('');
        
        // Attacher les √©v√©nements
        board.elements.forEach(el => {
            MoodBoard.attachElementEvents(el.id);
        });
        
        // Mettre √† jour la liste des √©l√©ments dans la sidebar
        MoodBoard.renderElementsList();
    },
    
    renderElement: (el) => {
        const isSelected = el.id === MoodBoard.selectedElementId;
        const linkedBadge = el.linkedTo ? `<div class="element-linked-badge" title="Li√© √†: ${el.linkedTo.type}">üîó</div>` : '';
        let content = '';
        
        if(el.type === 'image' || el.type === 'drawing') {
            content = `<img class="moodboard-element-image" src="${el.src}" alt="">`;
        }
        
        if(el.type === 'text') {
            const style = `
                font-family: ${el.fontFamily || 'Inter, sans-serif'};
                font-size: ${el.fontSize || 18}px;
                text-align: ${el.textAlign || 'left'};
                color: ${el.textColor || '#333333'};
            `;
            content = `<div class="moodboard-element-text" style="${style}">${Utils.escape(el.content || '').replace(/\n/g, '<br>')}</div>`;
        }
        
        if(el.type === 'palette') {
            const colors = el.colors || ['#000000'];
            content = `<div class="moodboard-element-palette">
                ${el.paletteName ? `<div class="palette-title">${Utils.escape(el.paletteName)}</div>` : ''}
                <div class="palette-colors">
                    ${colors.map(c => `<div class="color-swatch" title="${c}">
                        <div class="color-swatch-box" style="background: ${c};"></div>
                        <span>${c}</span>
                    </div>`).join('')}
                </div>
            </div>`;
        }
        
        if(el.type === 'shape') {
            const shape = MoodBoard.shapes.find(s => s.id === el.shapeId);
            if(shape) {
                content = `<div class="moodboard-element-shape" style="color: ${el.color || '#000000'}; transform: rotate(${el.rotation || 0}deg);">
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none">${shape.svg}</svg>
                </div>`;
            }
        }
        
        if(el.type === 'link') {
            content = `<div class="moodboard-element-link" ondblclick="window.open('${el.url}', '_blank')">
                <div class="link-icon">üîó</div>
                <div class="link-title">${Utils.escape(el.title || 'Lien')}</div>
                <div class="link-url">${Utils.escape(el.url || '').substring(0, 40)}...</div>
            </div>`;
        }
        
        if(el.type === 'file') {
            const icon = el.fileType.includes('pdf') ? 'üìÑ' : 
                        el.fileType.includes('word') || el.fileType.includes('doc') ? 'üìù' : 'üìÅ';
            const size = el.fileSize > 1024*1024 ? (el.fileSize/1024/1024).toFixed(1) + ' MB' : (el.fileSize/1024).toFixed(0) + ' KB';
            content = `<div class="moodboard-element-file" ondblclick="app.MoodBoard.openFile('${el.id}')">
                <div class="file-icon">${icon}</div>
                <div class="file-name">${Utils.escape(el.fileName || 'Fichier')}</div>
                <div class="file-size">${size}</div>
            </div>`;
        }
        
        const rotateHandle = (el.type === 'shape' || el.type === 'image' || el.type === 'drawing') ? '<div class="rotate-handle" data-action="rotate"></div>' : '';
        
        return `
            <div class="moodboard-element ${isSelected ? 'selected' : ''}" 
                 id="mb-el-${el.id}"
                 data-id="${el.id}"
                 style="left: ${el.x}px; top: ${el.y}px; width: ${el.width}px; height: ${el.height}px; transform: rotate(${el.rotation || 0}deg);">
                ${linkedBadge}
                ${rotateHandle}
                ${content}
                <div class="resize-handle se"></div>
                <div class="resize-handle sw"></div>
                <div class="resize-handle ne"></div>
                <div class="resize-handle nw"></div>
            </div>
        `;
    },
    
    attachElementEvents: (elementId) => {
        const el = document.getElementById('mb-el-' + elementId);
        if(!el) return;
        
        // S√©lection au clic
        el.addEventListener('mousedown', (e) => {
            if(e.target.classList.contains('resize-handle')) {
                MoodBoard.startResize(elementId, e);
            } else if(e.target.classList.contains('rotate-handle')) {
                MoodBoard.startRotate(elementId, e);
            } else if(!e.target.classList.contains('moodboard-element-text')) {
                MoodBoard.startDrag(elementId, e);
            }
            MoodBoard.selectElement(elementId);
            e.stopPropagation();
        });
        
        // √âdition du texte
        const textEl = el.querySelector('.moodboard-element-text');
        if(textEl) {
            textEl.addEventListener('blur', () => {
                MoodBoard.updateElementContent(elementId, textEl.innerText);
            });
        }
    },
    
    selectElement: (elementId) => {
        MoodBoard.selectedElementId = elementId;
        
        // Mettre √† jour les classes
        document.querySelectorAll('.moodboard-element').forEach(el => {
            el.classList.toggle('selected', el.dataset.id === elementId);
        });
        
        // Mettre √† jour le panneau d'info
        MoodBoard.updateInfoPanel();
    },
    
    startRotate: (elementId, e) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        const domEl = document.getElementById('mb-el-' + elementId);
        if(!domEl) return;
        
        const rect = domEl.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
        const startRotation = element.rotation || 0;
        
        const onMouseMove = (e) => {
            const currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
            let newRotation = startRotation + (currentAngle - startAngle);
            
            // Snap √† 15¬∞ si Shift est press√©
            if(e.shiftKey) {
                newRotation = Math.round(newRotation / 15) * 15;
            }
            
            element.rotation = newRotation;
            domEl.style.transform = `rotate(${newRotation}deg)`;
        };
        
        const onMouseUp = () => {
            board.modifiedAt = Date.now();
            Store.save();
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        e.preventDefault();
    },
    
    startRotate: (elementId, e) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        const domEl = document.getElementById('mb-el-' + elementId);
        if(!domEl) return;
        
        const rect = domEl.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
        const startRotation = element.rotation || 0;
        
        const onMouseMove = (e) => {
            const currentAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
            let newRotation = startRotation + (currentAngle - startAngle);
            
            // Snap √† 15¬∞ si Shift est press√©
            if(e.shiftKey) {
                newRotation = Math.round(newRotation / 15) * 15;
            }
            
            element.rotation = newRotation;
            domEl.style.transform = `rotate(${newRotation}deg)`;
        };
        
        const onMouseUp = () => {
            board.modifiedAt = Date.now();
            Store.save();
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        e.preventDefault();
    },
    
    startDrag: (elementId, e) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.isDraggingElement = true;
        MoodBoard.dragOffsetX = (e.clientX / MoodBoard.zoom) - element.x;
        MoodBoard.dragOffsetY = (e.clientY / MoodBoard.zoom) - element.y;
        
        const onMouseMove = (e) => {
            if(!MoodBoard.isDraggingElement) return;
            
            const newX = (e.clientX / MoodBoard.zoom) - MoodBoard.dragOffsetX;
            const newY = (e.clientY / MoodBoard.zoom) - MoodBoard.dragOffsetY;
            
            element.x = Math.max(0, newX);
            element.y = Math.max(0, newY);
            
            const domEl = document.getElementById('mb-el-' + elementId);
            if(domEl) {
                domEl.style.left = element.x + 'px';
                domEl.style.top = element.y + 'px';
            }
        };
        
        const onMouseUp = () => {
            MoodBoard.isDraggingElement = false;
            board.modifiedAt = Date.now();
            Store.save();
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    },
    
    startResize: (elementId, e) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.isResizingElement = true;
        MoodBoard.resizeHandle = e.target.classList.contains('se') ? 'se' :
                                 e.target.classList.contains('sw') ? 'sw' :
                                 e.target.classList.contains('ne') ? 'ne' : 'nw';
        
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = element.width;
        const startHeight = element.height;
        const startElX = element.x;
        const startElY = element.y;
        
        const onMouseMove = (e) => {
            if(!MoodBoard.isResizingElement) return;
            
            const dx = (e.clientX - startX) / MoodBoard.zoom;
            const dy = (e.clientY - startY) / MoodBoard.zoom;
            
            if(MoodBoard.resizeHandle === 'se') {
                element.width = Math.max(80, startWidth + dx);
                element.height = Math.max(80, startHeight + dy);
            } else if(MoodBoard.resizeHandle === 'sw') {
                element.width = Math.max(80, startWidth - dx);
                element.height = Math.max(80, startHeight + dy);
                element.x = startElX + (startWidth - element.width);
            } else if(MoodBoard.resizeHandle === 'ne') {
                element.width = Math.max(80, startWidth + dx);
                element.height = Math.max(80, startHeight - dy);
                element.y = startElY + (startHeight - element.height);
            } else if(MoodBoard.resizeHandle === 'nw') {
                element.width = Math.max(80, startWidth - dx);
                element.height = Math.max(80, startHeight - dy);
                element.x = startElX + (startWidth - element.width);
                element.y = startElY + (startHeight - element.height);
            }
            
            const domEl = document.getElementById('mb-el-' + elementId);
            if(domEl) {
                domEl.style.left = element.x + 'px';
                domEl.style.top = element.y + 'px';
                domEl.style.width = element.width + 'px';
                domEl.style.height = element.height + 'px';
            }
        };
        
        const onMouseUp = () => {
            MoodBoard.isResizingElement = false;
            board.modifiedAt = Date.now();
            Store.save();
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    },
    
    updateElementContent: (elementId, content) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        element.content = content;
        board.modifiedAt = Date.now();
        Store.save();
    },
    
    editElement: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        if(element.type === 'text') {
            MoodBoard.showTextPanel(element);
        }
        
        if(element.type === 'palette') {
            const colorsStr = await ConfirmModal.prompt('Entrez les couleurs (s√©par√©es par des virgules) :', 'Modifier la palette', '#264653, #2a9d8f...', (element.colors || []).join(', '));
            if(colorsStr === null) return;
            
            element.colors = colorsStr.split(',').map(c => c.trim()).filter(c => c);
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Palette modifi√©e', 'success');
        }
        
        if(element.type === 'link') {
            const url = await ConfirmModal.prompt('URL du lien :', 'Modifier le lien', 'https://...', element.url || '');
            if(url === null) return;
            
            element.url = url;
            try { element.title = new URL(url).hostname; } catch(e) { element.title = 'Lien'; }
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Lien modifi√©', 'success');
        }
        
        if(element.type === 'drawing') {
            // R√©ouvrir l'√©diteur de dessin avec l'image existante
            MoodBoard.editDrawing(element);
        }
        
        if(element.type === 'image') {
            // Permettre de remplacer l'image
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    element.src = ev.target.result;
                    element.fileName = file.name;
                    board.modifiedAt = Date.now();
                    Store.save();
                    MoodBoard.renderCanvas();
                    Utils.toast('Image remplac√©e', 'success');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
        
        if(element.type === 'file') {
            Utils.toast('Double-cliquez pour ouvrir le fichier', 'info');
        }
    },
    
    showTextEditPanel: (element) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const modal = document.createElement('div');
        modal.className = 'confirm-modal-overlay';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="confirm-modal-box" style="max-width: 500px;">
                <div class="confirm-modal-icon">üìù</div>
                <div class="confirm-modal-title">Modifier le texte</div>
                <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; align-items: center;">
                    <select id="mbEditTextFont" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); min-width: 120px;">
                        <option value="Inter, sans-serif" ${element.fontFamily?.includes('Inter') ? 'selected' : ''}>Inter</option>
                        <option value="Georgia, serif" ${element.fontFamily?.includes('Georgia') ? 'selected' : ''}>Georgia</option>
                        <option value="'Courier New', monospace" ${element.fontFamily?.includes('Courier') ? 'selected' : ''}>Courier</option>
                        <option value="'Comic Sans MS', cursive" ${element.fontFamily?.includes('Comic') ? 'selected' : ''}>Comic Sans</option>
                        <option value="Impact, sans-serif" ${element.fontFamily?.includes('Impact') ? 'selected' : ''}>Impact</option>
                        <option value="'Times New Roman', serif" ${element.fontFamily?.includes('Times') ? 'selected' : ''}>Times</option>
                        <option value="Arial, sans-serif" ${element.fontFamily?.includes('Arial') ? 'selected' : ''}>Arial</option>
                        <option value="Verdana, sans-serif" ${element.fontFamily?.includes('Verdana') ? 'selected' : ''}>Verdana</option>
                    </select>
                    <select id="mbEditTextSize" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
                        <option value="12" ${element.fontSize == 12 ? 'selected' : ''}>12px</option>
                        <option value="14" ${element.fontSize == 14 ? 'selected' : ''}>14px</option>
                        <option value="18" ${element.fontSize == 18 || !element.fontSize ? 'selected' : ''}>18px</option>
                        <option value="24" ${element.fontSize == 24 ? 'selected' : ''}>24px</option>
                        <option value="32" ${element.fontSize == 32 ? 'selected' : ''}>32px</option>
                        <option value="48" ${element.fontSize == 48 ? 'selected' : ''}>48px</option>
                        <option value="64" ${element.fontSize == 64 ? 'selected' : ''}>64px</option>
                    </select>
                    <input type="color" id="mbEditTextColor" value="${element.textColor || '#333333'}" style="width: 45px; height: 36px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; padding: 2px;">
                </div>
                <div style="margin: 15px 0;">
                    <textarea id="mbEditTextContent" style="width: 100%; height: 120px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); resize: vertical; font-family: ${element.fontFamily || 'Inter, sans-serif'}; font-size: ${element.fontSize || 18}px; color: ${element.textColor || '#333333'};">${Utils.escape(element.content || '')}</textarea>
                </div>
                <div class="confirm-modal-buttons">
                    <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                    <button class="confirm-modal-btn confirm" id="mbSaveTextBtn">Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const textarea = document.getElementById('mbEditTextContent');
        const fontSelect = document.getElementById('mbEditTextFont');
        const sizeSelect = document.getElementById('mbEditTextSize');
        const colorInput = document.getElementById('mbEditTextColor');
        
        // Pr√©visualisation en direct
        const updatePreview = () => {
            textarea.style.fontFamily = fontSelect.value;
            textarea.style.fontSize = sizeSelect.value + 'px';
            textarea.style.color = colorInput.value;
        };
        
        fontSelect.onchange = updatePreview;
        sizeSelect.onchange = updatePreview;
        colorInput.oninput = updatePreview;
        
        modal.querySelector('#mbSaveTextBtn').onclick = () => {
            element.content = textarea.value;
            element.fontFamily = fontSelect.value;
            element.fontSize = parseInt(sizeSelect.value);
            element.textColor = colorInput.value;
            
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            modal.remove();
            Utils.toast('Texte modifi√©', 'success');
        };
        
        textarea.focus();
    },
    
    linkElement: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.showLinkModal(element, (linkedTo) => {
            element.linkedTo = linkedTo;
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Liaison mise √† jour', 'success');
        });
    },
    
    showLinkModal: (target, callback) => {
        const modal = document.createElement('div');
        modal.className = 'confirm-modal-overlay';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        // Construire les cat√©gories
        const categories = [
            { id: 'project', icon: 'üé¨', label: 'Projet', items: [{ id: 'project', name: 'Projet entier' }] },
            { id: 'scene', icon: 'üìÑ', label: 'Sc√®nes', items: (state.data.scenes || []).map((s, i) => ({ id: s.id, name: `Sc√®ne ${i+1}: ${s.title || 'Sans titre'}` })) },
            { id: 'character', icon: 'üë§', label: 'Personnages', items: (state.data.characters || []).map(c => ({ id: c.id, name: c.name })) },
            { id: 'actor', icon: 'üé≠', label: 'Com√©diens', items: (state.data.actors || []).map(a => ({ id: a.id, name: a.name })) },
            { id: 'location', icon: 'üìç', label: 'D√©cors', items: (state.data.locations || []).map(l => ({ id: l.id, name: l.name })) },
            { id: 'resource', icon: 'üì¶', label: 'Ressources', items: (state.data.resources || []).map(r => ({ id: r.id, name: r.name })) }
        ];
        
        // Valeur actuelle
        const currentType = target.linkedTo?.type || '';
        const currentId = target.linkedTo?.id || '';
        
        let categoriesHtml = categories.map(cat => {
            if(cat.items.length === 0) return '';
            const isActive = cat.id === currentType || (cat.id === 'project' && currentType === 'project');
            return `<button class="mb-link-cat-btn ${isActive ? 'active' : ''}" data-cat="${cat.id}" style="padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px; background: ${isActive ? 'var(--primary)' : 'var(--bg)'}; color: ${isActive ? 'white' : 'var(--text)'}; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span>${cat.icon}</span>
                <span>${cat.label}</span>
                <span style="opacity: 0.6; font-size: 0.8rem;">(${cat.items.length})</span>
            </button>`;
        }).join('');
        
        modal.innerHTML = `
            <div class="confirm-modal-box" style="max-width: 550px; max-height: 80vh; display: flex; flex-direction: column;">
                <div class="confirm-modal-icon">üîó</div>
                <div class="confirm-modal-title">Lier √† un √©l√©ment</div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; justify-content: center;">
                    ${categoriesHtml}
                    <button class="mb-link-cat-btn ${!currentType ? 'active' : ''}" data-cat="" style="padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px; background: ${!currentType ? 'var(--primary)' : 'var(--bg)'}; color: ${!currentType ? 'white' : 'var(--text)'}; cursor: pointer;">
                        ‚ùå Aucune liaison
                    </button>
                </div>
                
                <div id="mbLinkItemsList" style="flex: 1; overflow-y: auto; max-height: 300px; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                    <p style="text-align: center; color: var(--text-sec);">S√©lectionnez une cat√©gorie</p>
                </div>
                
                <div class="confirm-modal-buttons">
                    <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const itemsList = modal.querySelector('#mbLinkItemsList');
        const catButtons = modal.querySelectorAll('.mb-link-cat-btn');
        
        const showItems = (catId) => {
            catButtons.forEach(btn => {
                btn.style.background = btn.dataset.cat === catId ? 'var(--primary)' : 'var(--bg)';
                btn.style.color = btn.dataset.cat === catId ? 'white' : 'var(--text)';
            });
            
            if(!catId) {
                // Aucune liaison
                callback(null);
                modal.remove();
                return;
            }
            
            const cat = categories.find(c => c.id === catId);
            if(!cat) return;
            
            if(catId === 'project') {
                callback({ type: 'project' });
                modal.remove();
                return;
            }
            
            itemsList.innerHTML = cat.items.map(item => {
                const isSelected = currentType === catId && currentId === item.id;
                return `<div class="mb-link-item" data-type="${catId}" data-id="${item.id}" style="padding: 12px; border-radius: 6px; cursor: pointer; margin-bottom: 5px; background: ${isSelected ? 'var(--primary)' : 'var(--bg)'}; color: ${isSelected ? 'white' : 'var(--text)'}; transition: background 0.2s;">
                    ${cat.icon} ${Utils.escape(item.name)}
                </div>`;
            }).join('');
            
            itemsList.querySelectorAll('.mb-link-item').forEach(item => {
                item.onmouseenter = () => { if(!item.style.background.includes('primary')) item.style.background = 'var(--border)'; };
                item.onmouseleave = () => { if(!item.style.background.includes('primary')) item.style.background = 'var(--bg)'; };
                item.onclick = () => {
                    callback({ type: item.dataset.type, id: item.dataset.id });
                    modal.remove();
                };
            });
        };
        
        catButtons.forEach(btn => {
            btn.onclick = () => showItems(btn.dataset.cat);
        });
        
        // Afficher la cat√©gorie actuelle si elle existe
        if(currentType && currentType !== 'project') {
            showItems(currentType);
        }
    },
    
    duplicateElement: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        const newElement = JSON.parse(JSON.stringify(element));
        newElement.id = 'el_' + Date.now();
        newElement.x += 30;
        newElement.y += 30;
        newElement.createdAt = Date.now();
        
        board.elements.push(newElement);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        MoodBoard.selectElement(newElement.id);
        Utils.toast('√âl√©ment dupliqu√©', 'success');
    },
    
    deleteElement: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        board.elements = board.elements.filter(el => el.id !== elementId);
        board.modifiedAt = Date.now();
        Store.save();
        
        if(MoodBoard.selectedElementId === elementId) {
            MoodBoard.selectedElementId = null;
        }
        
        MoodBoard.renderCanvas();
        Utils.toast('√âl√©ment supprim√©', 'success');
    },
    
    // ===== PANNEAU D'INFO =====
    
    toggleInfoPanel: () => {
        const panel = document.getElementById('moodboardInfoPanel');
        if(panel) {
            panel.classList.toggle('active');
            MoodBoard.updateInfoPanel();
        }
    },
    
    updateInfoPanel: () => {
        const panel = document.getElementById('moodboardInfoPanel');
        const content = document.getElementById('moodboardInfoContent');
        const title = document.getElementById('moodboardInfoTitle');
        if(!panel || !content || !panel.classList.contains('active')) return;
        
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === MoodBoard.selectedElementId);
        
        if(element) {
            title.textContent = '√âl√©ment: ' + element.type;
            content.innerHTML = `
                <div class="info-row">
                    <label>Position X</label>
                    <input type="number" value="${Math.round(element.x)}" onchange="app.MoodBoard.updateElementProp('${element.id}', 'x', parseFloat(this.value))">
                </div>
                <div class="info-row">
                    <label>Position Y</label>
                    <input type="number" value="${Math.round(element.y)}" onchange="app.MoodBoard.updateElementProp('${element.id}', 'y', parseFloat(this.value))">
                </div>
                <div class="info-row">
                    <label>Largeur</label>
                    <input type="number" value="${Math.round(element.width)}" onchange="app.MoodBoard.updateElementProp('${element.id}', 'width', parseFloat(this.value))">
                </div>
                <div class="info-row">
                    <label>Hauteur</label>
                    <input type="number" value="${Math.round(element.height)}" onchange="app.MoodBoard.updateElementProp('${element.id}', 'height', parseFloat(this.value))">
                </div>
                <div class="info-row">
                    <label>Li√© √†</label>
                    <input type="text" value="${element.linkedTo ? element.linkedTo.type + (element.linkedTo.id ? ': ' + element.linkedTo.id : '') : 'Aucun'}" readonly style="cursor: pointer;" onclick="app.MoodBoard.linkElement('${element.id}')">
                </div>
            `;
        } else if(board) {
            title.textContent = 'Planche: ' + board.name;
            content.innerHTML = `
                <div class="info-row">
                    <label>Nom</label>
                    <input type="text" value="${Utils.escape(board.name)}" onchange="app.MoodBoard.updateBoardName(this.value)">
                </div>
                <div class="info-row">
                    <label>Format</label>
                    <select onchange="app.MoodBoard.changeFormat(this.value)">
                        <option value="free" ${board.format === 'free' ? 'selected' : ''}>Libre (infini)</option>
                        <option value="a4-landscape" ${board.format === 'a4-landscape' ? 'selected' : ''}>A4 Paysage</option>
                        <option value="a4-portrait" ${board.format === 'a4-portrait' ? 'selected' : ''}>A4 Portrait</option>
                        <option value="a3-landscape" ${board.format === 'a3-landscape' ? 'selected' : ''}>A3 Paysage</option>
                        <option value="a3-portrait" ${board.format === 'a3-portrait' ? 'selected' : ''}>A3 Portrait</option>
                        <option value="a2-landscape" ${board.format === 'a2-landscape' ? 'selected' : ''}>A2 Paysage</option>
                        <option value="a2-portrait" ${board.format === 'a2-portrait' ? 'selected' : ''}>A2 Portrait</option>
                        <option value="a0-landscape" ${board.format === 'a0-landscape' ? 'selected' : ''}>A0 Paysage</option>
                        <option value="a0-portrait" ${board.format === 'a0-portrait' ? 'selected' : ''}>A0 Portrait</option>
                    </select>
                </div>
                <div class="info-row">
                    <label>√âl√©ments</label>
                    <input type="text" value="${board.elements.length}" readonly>
                </div>
                <div class="info-row">
                    <label>Lier la planche √†</label>
                    <button onclick="app.MoodBoard.linkBoard()" style="width: 100%; padding: 8px; cursor: pointer;">üîó Configurer...</button>
                </div>
            `;
        } else {
            title.textContent = 'Propri√©t√©s';
            content.innerHTML = '<p style="color: var(--text-sec);">S√©lectionnez une planche ou un √©l√©ment</p>';
        }
    },
    
    updateElementProp: (elementId, prop, value) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        element[prop] = value;
        board.modifiedAt = Date.now();
        Store.save();
        MoodBoard.renderCanvas();
    },
    
    updateBoardName: (name) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        board.name = name;
        board.modifiedAt = Date.now();
        Store.save();
        MoodBoard.renderBoardsList();
    },
    
    linkBoard: async () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        // Similaire √† linkElement mais pour la planche
        const options = [
            { value: '', label: '‚Äî Aucune liaison ‚Äî' },
            { value: 'project', label: 'üé¨ Projet global' }
        ];
        
        (state.data.scenes || []).forEach((scene, i) => {
            options.push({ value: `scene_${scene.id}`, label: `üìÑ Sc√®ne ${i+1}: ${scene.title}` });
        });
        
        (state.data.characters || []).forEach(char => {
            options.push({ value: `character_${char.id}`, label: `üë§ ${char.name}` });
        });
        
        (state.data.actors || []).forEach(actor => {
            options.push({ value: `actor_${actor.id}`, label: `üé≠ ${actor.name}` });
        });
        
        (state.data.locations || []).forEach(loc => {
            options.push({ value: `location_${loc.id}`, label: `üìç ${loc.name}` });
        });
        
        const currentValue = board.linkedTo ? `${board.linkedTo.type}_${board.linkedTo.id || ''}` : '';
        
        const result = await ConfirmModal.prompt({
            title: 'Lier cette planche',
            message: 'Associer cette planche √† :',
            defaultValue: currentValue,
            type: 'select',
            options: options
        });
        
        if(result === null) return;
        
        if(result === '') {
            board.linkedTo = null;
        } else if(result === 'project') {
            board.linkedTo = { type: 'project' };
        } else {
            const [type, id] = result.split('_');
            board.linkedTo = { type, id };
        }
        
        board.modifiedAt = Date.now();
        Store.save();
        MoodBoard.renderBoardsList();
        MoodBoard.updateInfoPanel();
        Utils.toast('Liaison mise √† jour', 'success');
    },
    
    // ===== MENU RADIAL =====
    
    contextX: 0,
    contextY: 0,
    
    showRadialMenu: (x, y) => {
        MoodBoard.hideRadialMenu();
        
        const items = [
            { icon: '‚úèÔ∏è', label: 'Dessiner', action: 'draw', angle: 0 },
            { icon: 'üìù', label: 'Texte', action: 'text', angle: 60 },
            { icon: 'üé®', label: 'Palette', action: 'palette', angle: 120 },
            { icon: '‚¨°', label: 'Formes', action: 'shapes', angle: 180 },
            { icon: 'üìÅ', label: 'Image / Fichier', action: 'file', angle: 240 },
            { icon: 'üîó', label: 'Lien web', action: 'link', angle: 300 }
        ];
        
        const radius = 80;
        
        const overlay = document.createElement('div');
        overlay.className = 'moodboard-radial-overlay';
        overlay.onclick = () => MoodBoard.hideRadialMenu();
        document.body.appendChild(overlay);
        
        const menu = document.createElement('div');
        menu.className = 'moodboard-radial-menu';
        menu.id = 'moodboardRadialMenu';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        
        // Centre du menu
        const center = document.createElement('div');
        center.className = 'moodboard-radial-center';
        center.innerHTML = '‚úï';
        center.onclick = () => MoodBoard.hideRadialMenu();
        menu.appendChild(center);
        
        // Items du menu
        items.forEach((item, i) => {
            const el = document.createElement('div');
            el.className = 'moodboard-radial-item';
            el.innerHTML = `${item.icon}<span class="radial-tooltip">${item.label}</span>`;
            
            const angleRad = (item.angle - 90) * Math.PI / 180;
            const itemX = Math.cos(angleRad) * radius;
            const itemY = Math.sin(angleRad) * radius;
            
            el.style.left = itemX + 'px';
            el.style.top = itemY + 'px';
            el.style.transitionDelay = (i * 0.03) + 's';
            
            el.onclick = () => {
                MoodBoard.hideRadialMenu();
                MoodBoard.handleRadialAction(item.action);
            };
            
            menu.appendChild(el);
        });
        
        document.body.appendChild(menu);
        
        // Activer l'animation
        requestAnimationFrame(() => menu.classList.add('active'));
    },
    
    hideRadialMenu: () => {
        const menu = document.getElementById('moodboardRadialMenu');
        const overlay = document.querySelector('.moodboard-radial-overlay');
        const submenu = document.querySelector('.moodboard-palette-submenu, .moodboard-text-panel');
        if(menu) menu.remove();
        if(overlay) overlay.remove();
        if(submenu) submenu.remove();
    },
    
    handleRadialAction: (action) => {
        switch(action) {
            case 'draw':
                MoodBoard.openDrawingTool();
                break;
            case 'text':
                MoodBoard.showTextPanel();
                break;
            case 'palette':
                ColorWheel.open((colors, name) => MoodBoard.addPaletteToBoard(colors, name));
                break;
            case 'shapes':
                MoodBoard.showShapesMenu();
                break;
            case 'file':
                MoodBoard.uploadFile();
                break;
            case 'link':
                MoodBoard.addWebLink();
                break;
        }
    },
    
    showElementContextMenu: (x, y, elementId) => {
        MoodBoard.hideRadialMenu();
        MoodBoard.selectElement(elementId);
        
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        
        const overlay = document.createElement('div');
        overlay.className = 'moodboard-radial-overlay';
        overlay.onclick = () => MoodBoard.hideRadialMenu();
        document.body.appendChild(overlay);
        
        const menu = document.createElement('div');
        menu.className = 'moodboard-radial-menu';
        menu.id = 'moodboardRadialMenu';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        
        let items = [
            { icon: '‚¨ÜÔ∏è', label: 'Monter', action: () => MoodBoard.moveElementUp(elementId) },
            { icon: '‚¨áÔ∏è', label: 'Descendre', action: () => MoodBoard.moveElementDown(elementId) },
            { icon: 'üîó', label: 'Lier √†...', action: () => MoodBoard.linkElement(elementId) },
            { icon: 'üìã', label: 'Dupliquer', action: () => MoodBoard.duplicateElement(elementId) },
            { icon: '‚úèÔ∏è', label: 'Modifier', action: () => MoodBoard.editElement(elementId) },
            { icon: 'üóëÔ∏è', label: 'Supprimer', action: () => MoodBoard.deleteElement(elementId) }
        ];
        
        // Ajouter option couleur pour les formes
        if(element && element.type === 'shape') {
            items.splice(4, 0, { icon: 'üé®', label: 'Couleur', action: () => MoodBoard.changeShapeColor(elementId) });
        }
        
        // Ajouter option renommer pour les palettes
        if(element && element.type === 'palette') {
            items.splice(4, 0, { icon: '‚úèÔ∏è', label: 'Renommer', action: () => MoodBoard.renamePalette(elementId) });
        }
        
        // Ajouter option renommer pour les palettes
        if(element && element.type === 'palette') {
            items.splice(4, 0, { icon: '‚úèÔ∏è', label: 'Renommer', action: () => MoodBoard.renamePalette(elementId) });
        }
        
        const radius = 85;
        
        const center = document.createElement('div');
        center.className = 'moodboard-radial-center';
        center.innerHTML = '‚úï';
        center.onclick = () => MoodBoard.hideRadialMenu();
        menu.appendChild(center);
        
        items.forEach((item, i) => {
            const el = document.createElement('div');
            el.className = 'moodboard-radial-item';
            el.innerHTML = `${item.icon}<span class="radial-tooltip">${item.label}</span>`;
            
            const angle = (i * 60);  // 6 items = 60¬∞ entre chaque
            const angleRad = (angle - 90) * Math.PI / 180;
            const itemX = Math.cos(angleRad) * radius;
            const itemY = Math.sin(angleRad) * radius;
            
            el.style.left = itemX + 'px';
            el.style.top = itemY + 'px';
            el.style.transitionDelay = (i * 0.03) + 's';
            
            el.onclick = () => {
                MoodBoard.hideRadialMenu();
                item.action();
            };
            
            menu.appendChild(el);
        });
        
        document.body.appendChild(menu);
        requestAnimationFrame(() => menu.classList.add('active'));
    },
    
    // ===== OUTILS DU MENU RADIAL =====
    
    editDrawing: (element) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board || !element) return;
        
        // Charger l'image existante dans le DrawingEditor
        DrawingEditor.open(null, (dataUrl) => {
            if(dataUrl) {
                element.src = dataUrl;
                board.modifiedAt = Date.now();
                Store.save();
                MoodBoard.renderCanvas();
                Utils.toast('Dessin modifi√©', 'success');
            }
        });
        
        // Charger l'image existante dans le premier calque apr√®s ouverture
        setTimeout(() => {
            if(element.src && DrawingEditor.layers.length > 0) {
                const img = new Image();
                img.onload = () => {
                    const ctx = DrawingEditor.layers[0].canvas.getContext('2d');
                    ctx.clearRect(0, 0, 800, 600);
                    ctx.drawImage(img, 0, 0, 800, 600);
                    DrawingEditor.redraw();
                };
                img.src = element.src;
            }
        }, 100);
    },
    
    openDrawingTool: () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        // Utiliser le DrawingEditor du Storyboard avec callback
        DrawingEditor.open(null, (dataUrl) => {
            if(dataUrl) {
                const element = {
                    id: 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    type: 'drawing',
                    x: MoodBoard.contextX,
                    y: MoodBoard.contextY,
                    width: 400,
                    height: 300,
                    src: dataUrl,
                    linkedTo: null,
                    createdAt: Date.now()
                };
                
                board.elements.push(element);
                board.modifiedAt = Date.now();
                Store.save();
                MoodBoard.renderCanvas();
                Utils.toast('Dessin ajout√©', 'success');
            }
        });
    },
    
    showTextPanel: (existingElement = null) => {
        const isEdit = !!existingElement;
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const modal = document.createElement('div');
        modal.className = 'confirm-modal-overlay';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        const currentContent = isEdit ? existingElement.content || '' : '';
        const currentFont = isEdit ? existingElement.fontFamily || 'Inter, sans-serif' : 'Inter, sans-serif';
        const currentSize = isEdit ? existingElement.fontSize || 18 : 18;
        const currentColor = isEdit ? existingElement.textColor || '#333333' : '#333333';
        const currentBold = isEdit ? existingElement.fontBold || false : false;
        const currentItalic = isEdit ? existingElement.fontItalic || false : false;
        const currentUnderline = isEdit ? existingElement.fontUnderline || false : false;
        const currentAlign = isEdit ? existingElement.textAlign || 'left' : 'left';
        const currentBgColor = isEdit ? existingElement.bgColor || 'transparent' : 'transparent';
        
        modal.innerHTML = `
            <div class="confirm-modal-box" style="max-width: 550px;">
                <div class="confirm-modal-icon">üìù</div>
                <div class="confirm-modal-title">${isEdit ? 'Modifier le texte' : 'Ajouter du texte'}</div>
                
                <!-- Ligne 1: Police et taille -->
                <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; align-items: center;">
                    <select id="mbTextFont" style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); min-width: 130px;">
                        <option value="Inter, sans-serif" ${currentFont.includes('Inter') ? 'selected' : ''}>Inter</option>
                        <option value="Georgia, serif" ${currentFont.includes('Georgia') ? 'selected' : ''}>Georgia</option>
                        <option value="'Courier New', monospace" ${currentFont.includes('Courier') ? 'selected' : ''}>Courier New</option>
                        <option value="'Comic Sans MS', cursive" ${currentFont.includes('Comic') ? 'selected' : ''}>Comic Sans</option>
                        <option value="Impact, sans-serif" ${currentFont.includes('Impact') ? 'selected' : ''}>Impact</option>
                        <option value="'Times New Roman', serif" ${currentFont.includes('Times') ? 'selected' : ''}>Times New Roman</option>
                        <option value="Arial, sans-serif" ${currentFont.includes('Arial') ? 'selected' : ''}>Arial</option>
                        <option value="Verdana, sans-serif" ${currentFont.includes('Verdana') ? 'selected' : ''}>Verdana</option>
                        <option value="'Trebuchet MS', sans-serif" ${currentFont.includes('Trebuchet') ? 'selected' : ''}>Trebuchet</option>
                        <option value="'Lucida Console', monospace" ${currentFont.includes('Lucida') ? 'selected' : ''}>Lucida Console</option>
                    </select>
                    <select id="mbTextSize" style="padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); width: 75px;">
                        <option value="10" ${currentSize == 10 ? 'selected' : ''}>10px</option>
                        <option value="12" ${currentSize == 12 ? 'selected' : ''}>12px</option>
                        <option value="14" ${currentSize == 14 ? 'selected' : ''}>14px</option>
                        <option value="16" ${currentSize == 16 ? 'selected' : ''}>16px</option>
                        <option value="18" ${currentSize == 18 ? 'selected' : ''}>18px</option>
                        <option value="24" ${currentSize == 24 ? 'selected' : ''}>24px</option>
                        <option value="32" ${currentSize == 32 ? 'selected' : ''}>32px</option>
                        <option value="48" ${currentSize == 48 ? 'selected' : ''}>48px</option>
                        <option value="64" ${currentSize == 64 ? 'selected' : ''}>64px</option>
                        <option value="72" ${currentSize == 72 ? 'selected' : ''}>72px</option>
                    </select>
                </div>
                
                <!-- Ligne 2: Style et alignement -->
                <div style="display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; align-items: center;">
                    <div style="display: flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: 6px; border: 1px solid var(--border);">
                        <button type="button" id="mbTextBold" class="mb-text-style-btn ${currentBold ? 'active' : ''}" title="Gras" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: ${currentBold ? 'var(--primary)' : 'transparent'}; color: ${currentBold ? 'white' : 'var(--text)'};">B</button>
                        <button type="button" id="mbTextItalic" class="mb-text-style-btn ${currentItalic ? 'active' : ''}" title="Italique" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; font-style: italic; background: ${currentItalic ? 'var(--primary)' : 'transparent'}; color: ${currentItalic ? 'white' : 'var(--text)'};">I</button>
                        <button type="button" id="mbTextUnderline" class="mb-text-style-btn ${currentUnderline ? 'active' : ''}" title="Soulign√©" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; text-decoration: underline; background: ${currentUnderline ? 'var(--primary)' : 'transparent'}; color: ${currentUnderline ? 'white' : 'var(--text)'};">U</button>
                    </div>
                    <div style="display: flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: 6px; border: 1px solid var(--border);">
                        <button type="button" id="mbTextAlignLeft" class="mb-text-align-btn ${currentAlign === 'left' ? 'active' : ''}" title="Aligner √† gauche" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; background: ${currentAlign === 'left' ? 'var(--primary)' : 'transparent'}; color: ${currentAlign === 'left' ? 'white' : 'var(--text)'};">‚¨õ</button>
                        <button type="button" id="mbTextAlignCenter" class="mb-text-align-btn ${currentAlign === 'center' ? 'active' : ''}" title="Centrer" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; background: ${currentAlign === 'center' ? 'var(--primary)' : 'transparent'}; color: ${currentAlign === 'center' ? 'white' : 'var(--text)'};">‚¨õ</button>
                        <button type="button" id="mbTextAlignRight" class="mb-text-align-btn ${currentAlign === 'right' ? 'active' : ''}" title="Aligner √† droite" style="width: 32px; height: 32px; border: none; border-radius: 4px; cursor: pointer; background: ${currentAlign === 'right' ? 'var(--primary)' : 'transparent'}; color: ${currentAlign === 'right' ? 'white' : 'var(--text)'};">‚¨õ</button>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center; margin-left: auto;">
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Texte:</label>
                        <input type="color" id="mbTextColor" value="${currentColor}" style="width: 36px; height: 32px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; padding: 2px;">
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Fond:</label>
                        <input type="color" id="mbTextBgColor" value="${currentBgColor === 'transparent' ? '#ffffff' : currentBgColor}" style="width: 36px; height: 32px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; padding: 2px;">
                        <label style="font-size: 0.75rem; display: flex; align-items: center; gap: 3px;"><input type="checkbox" id="mbTextBgTransparent" ${currentBgColor === 'transparent' ? 'checked' : ''}> Transparent</label>
                    </div>
                </div>
                
                <!-- Zone de texte -->
                <div style="margin: 15px 0;">
                    <textarea id="mbTextContent" placeholder="Votre texte ici..." style="width: 100%; height: 130px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: ${currentBgColor === 'transparent' ? 'var(--bg)' : currentBgColor}; color: ${currentColor}; resize: vertical; font-family: ${currentFont}; font-size: ${currentSize}px; font-weight: ${currentBold ? 'bold' : 'normal'}; font-style: ${currentItalic ? 'italic' : 'normal'}; text-decoration: ${currentUnderline ? 'underline' : 'none'}; text-align: ${currentAlign};">${Utils.escape(currentContent)}</textarea>
                </div>
                
                <div class="confirm-modal-buttons">
                    <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                    <button class="confirm-modal-btn confirm" id="mbSaveTextBtn">${isEdit ? 'Enregistrer' : 'Ajouter'}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const textarea = document.getElementById('mbTextContent');
        const fontSelect = document.getElementById('mbTextFont');
        const sizeSelect = document.getElementById('mbTextSize');
        const colorInput = document.getElementById('mbTextColor');
        const bgColorInput = document.getElementById('mbTextBgColor');
        const bgTransparentCb = document.getElementById('mbTextBgTransparent');
        const boldBtn = document.getElementById('mbTextBold');
        const italicBtn = document.getElementById('mbTextItalic');
        const underlineBtn = document.getElementById('mbTextUnderline');
        const alignLeftBtn = document.getElementById('mbTextAlignLeft');
        const alignCenterBtn = document.getElementById('mbTextAlignCenter');
        const alignRightBtn = document.getElementById('mbTextAlignRight');
        
        let isBold = currentBold;
        let isItalic = currentItalic;
        let isUnderline = currentUnderline;
        let textAlign = currentAlign;
        
        // Pr√©visualisation en direct
        const updatePreview = () => {
            textarea.style.fontFamily = fontSelect.value;
            textarea.style.fontSize = sizeSelect.value + 'px';
            textarea.style.color = colorInput.value;
            textarea.style.fontWeight = isBold ? 'bold' : 'normal';
            textarea.style.fontStyle = isItalic ? 'italic' : 'normal';
            textarea.style.textDecoration = isUnderline ? 'underline' : 'none';
            textarea.style.textAlign = textAlign;
            textarea.style.background = bgTransparentCb.checked ? 'var(--bg)' : bgColorInput.value;
        };
        
        const updateStyleBtn = (btn, active) => {
            btn.style.background = active ? 'var(--primary)' : 'transparent';
            btn.style.color = active ? 'white' : 'var(--text)';
        };
        
        const updateAlignBtns = () => {
            updateStyleBtn(alignLeftBtn, textAlign === 'left');
            updateStyleBtn(alignCenterBtn, textAlign === 'center');
            updateStyleBtn(alignRightBtn, textAlign === 'right');
        };
        
        fontSelect.onchange = updatePreview;
        sizeSelect.onchange = updatePreview;
        colorInput.oninput = updatePreview;
        bgColorInput.oninput = updatePreview;
        bgTransparentCb.onchange = updatePreview;
        
        boldBtn.onclick = () => { isBold = !isBold; updateStyleBtn(boldBtn, isBold); updatePreview(); };
        italicBtn.onclick = () => { isItalic = !isItalic; updateStyleBtn(italicBtn, isItalic); updatePreview(); };
        underlineBtn.onclick = () => { isUnderline = !isUnderline; updateStyleBtn(underlineBtn, isUnderline); updatePreview(); };
        
        alignLeftBtn.onclick = () => { textAlign = 'left'; updateAlignBtns(); updatePreview(); };
        alignCenterBtn.onclick = () => { textAlign = 'center'; updateAlignBtns(); updatePreview(); };
        alignRightBtn.onclick = () => { textAlign = 'right'; updateAlignBtns(); updatePreview(); };
        
        document.getElementById('mbSaveTextBtn').onclick = () => {
            const content = textarea.value.trim();
            if(!content) {
                Utils.toast('Entrez du texte', 'warning');
                return;
            }
            
            const textData = {
                content: content,
                fontFamily: fontSelect.value,
                fontSize: parseInt(sizeSelect.value),
                textColor: colorInput.value,
                fontBold: isBold,
                fontItalic: isItalic,
                fontUnderline: isUnderline,
                textAlign: textAlign,
                bgColor: bgTransparentCb.checked ? 'transparent' : bgColorInput.value
            };
            
            if(isEdit) {
                Object.assign(existingElement, textData);
            } else {
                const element = {
                    id: 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    type: 'text',
                    x: MoodBoard.contextX,
                    y: MoodBoard.contextY,
                    width: 280,
                    height: 160,
                    ...textData,
                    linkedTo: null,
                    createdAt: Date.now()
                };
                board.elements.push(element);
            }
            
            board.modifiedAt = Date.now();
            Store.save();
            modal.remove();
            MoodBoard.renderCanvas();
            Utils.toast(isEdit ? 'Texte modifi√©' : 'Texte ajout√©', 'success');
        };
        
        textarea.focus();
    },
    
    palettePresets: [
        { name: 'Compl√©mentaire', desc: '2 couleurs oppos√©es', colors: ['#E63946', '#1D3557', '#F1FAEE', '#A8DADC', '#457B9D'] },
        { name: 'Analogue', desc: 'Couleurs voisines', colors: ['#264653', '#2A9D8F', '#E9C46A', '#F4A261', '#E76F51'] },
        { name: 'Triadique', desc: '3 couleurs √©quidistantes', colors: ['#FF6B6B', '#4ECDC4', '#FFE66D', '#95E1D3', '#F38181'] },
        { name: 'Monochrome', desc: 'Nuances d\'une couleur', colors: ['#0B3954', '#087E8B', '#56A3A6', '#BFD7EA', '#FFFFFF'] },
        { name: 'Pastel', desc: 'Tons doux et clairs', colors: ['#FFB5A7', '#FCD5CE', '#F8EDEB', '#F9DCC4', '#FEC89A'] },
        { name: 'N√©on', desc: 'Couleurs vives', colors: ['#FF00FF', '#00FFFF', '#FFFF00', '#FF0080', '#00FF00'] },
        { name: 'Terre', desc: 'Tons naturels', colors: ['#5C4033', '#8B7355', '#C4A77D', '#E6D5AC', '#F5E6CC'] }
    ],
    
    showPaletteSubmenu: () => {
        const submenu = document.createElement('div');
        submenu.className = 'moodboard-palette-submenu';
        submenu.style.left = (MoodBoard.contextX * MoodBoard.zoom + MoodBoard.panX + 50) + 'px';
        submenu.style.top = (MoodBoard.contextY * MoodBoard.zoom + MoodBoard.panY) + 'px';
        submenu.style.maxHeight = '70vh';
        submenu.style.overflowY = 'auto';
        
        let html = '<h4>üé® Choisir une palette</h4>';
        
        // Option Color Wheel EN PREMIER (comme Adobe Color)
        html += `
            <div class="moodboard-palette-option" onclick="MoodBoard.hideRadialMenu(); ColorWheel.open((colors, name) => MoodBoard.addPaletteToBoard(colors, name));" style="background: linear-gradient(135deg, rgba(255,100,100,0.1), rgba(100,100,255,0.1)); border: 2px solid var(--primary);">
                <div class="moodboard-palette-preview"><span style="background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); border-radius: 50%; width: 100%; height: 100%;"></span></div>
                <div>
                    <div class="palette-name">üé® Roue chromatique</div>
                    <div class="palette-desc">Cr√©er avec Adobe Color style</div>
                </div>
            </div>
        `;
        
        MoodBoard.palettePresets.forEach((palette, index) => {
            const colorsHtml = palette.colors.map(c => `<span style="background:${c}"></span>`).join('');
            
            html += `
                <div class="moodboard-palette-option" onclick="app.MoodBoard.addPaletteByIndex(${index})">
                    <div class="moodboard-palette-preview">${colorsHtml}</div>
                    <div>
                        <div class="palette-name">${palette.name}</div>
                        <div class="palette-desc">${palette.desc}</div>
                    </div>
                </div>
            `;
        });
        
        // Option personnalis√©e
        html += `
            <div class="moodboard-palette-option" onclick="app.MoodBoard.addCustomPalette()">
                <div class="moodboard-palette-preview"><span style="background:linear-gradient(45deg, red, blue, green)"></span></div>
                <div>
                    <div class="palette-name">Personnalis√©e</div>
                    <div class="palette-desc">Entrer les codes hex</div>
                </div>
            </div>
        `;
        
        submenu.innerHTML = html;
        
        const wrapper = document.getElementById('moodboardCanvasWrapper');
        wrapper.appendChild(submenu);
    },
    
    addPaletteByIndex: (index) => {
        const palette = MoodBoard.palettePresets[index];
        if(palette) {
            MoodBoard.hideRadialMenu();
            MoodBoard.addPaletteToBoard(palette.colors, palette.name);
        }
    },
    
    addCustomPalette: async () => {
        MoodBoard.hideRadialMenu();
        const colorsStr = await ConfirmModal.prompt({
            title: 'Palette personnalis√©e',
            message: 'Entrez vos couleurs (codes hex s√©par√©s par des virgules) :',
            defaultValue: '#264653, #2A9D8F, #E9C46A, #F4A261, #E76F51',
            placeholder: '#FF0000, #00FF00, #0000FF...'
        });
        if(!colorsStr) return;
        const colors = colorsStr.split(',').map(c => c.trim()).filter(c => c);
        MoodBoard.addPaletteToBoard(colors, 'Personnalis√©e');
    },
    
  shapes: [
        // Formes de base
        { id: 'rect', icon: '‚¨ú', name: 'Rectangle', svg: '<rect x="5" y="5" width="90" height="90" fill="currentColor"/>' },
        { id: 'rect-rounded', icon: '‚ñ¢', name: 'Rectangle arrondi', svg: '<rect x="5" y="5" width="90" height="90" fill="currentColor" rx="15"/>' },
        { id: 'circle', icon: '‚¨§', name: 'Cercle', svg: '<circle cx="50" cy="50" r="45" fill="currentColor"/>' },
        { id: 'ellipse', icon: '‚¨≠', name: 'Ellipse', svg: '<ellipse cx="50" cy="50" rx="45" ry="30" fill="currentColor"/>' },
        { id: 'triangle', icon: '‚ñ≤', name: 'Triangle', svg: '<polygon points="50,5 95,95 5,95" fill="currentColor"/>' },
        { id: 'triangle-down', icon: '‚ñº', name: 'Triangle invers√©', svg: '<polygon points="5,5 95,5 50,95" fill="currentColor"/>' },
        { id: 'diamond', icon: '‚óÜ', name: 'Losange', svg: '<polygon points="50,5 95,50 50,95 5,50" fill="currentColor"/>' },
        { id: 'pentagon', icon: '‚¨†', name: 'Pentagone', svg: '<polygon points="50,5 97,38 79,95 21,95 3,38" fill="currentColor"/>' },
        { id: 'hexagon', icon: '‚¨°', name: 'Hexagone', svg: '<polygon points="50,5 93,25 93,75 50,95 7,75 7,25" fill="currentColor"/>' },
        { id: 'octagon', icon: '‚ØÉ', name: 'Octogone', svg: '<polygon points="30,5 70,5 95,30 95,70 70,95 30,95 5,70 5,30" fill="currentColor"/>' },
        { id: 'star', icon: '‚òÖ', name: '√âtoile 5', svg: '<polygon points="50,5 61,35 95,35 68,57 79,91 50,70 21,91 32,57 5,35 39,35" fill="currentColor"/>' },
        { id: 'star4', icon: '‚ú¶', name: '√âtoile 4', svg: '<polygon points="50,5 60,40 95,50 60,60 50,95 40,60 5,50 40,40" fill="currentColor"/>' },
        // Fl√®ches
        { id: 'arrow-right', icon: '‚û°Ô∏è', name: 'Fl√®che droite', svg: '<polygon points="5,30 55,30 55,10 95,50 55,90 55,70 5,70" fill="currentColor"/>' },
        { id: 'arrow-left', icon: '‚¨ÖÔ∏è', name: 'Fl√®che gauche', svg: '<polygon points="95,30 45,30 45,10 5,50 45,90 45,70 95,70" fill="currentColor"/>' },
        { id: 'arrow-up', icon: '‚¨ÜÔ∏è', name: 'Fl√®che haut', svg: '<polygon points="30,95 30,45 10,45 50,5 90,45 70,45 70,95" fill="currentColor"/>' },
        { id: 'arrow-down', icon: '‚¨áÔ∏è', name: 'Fl√®che bas', svg: '<polygon points="30,5 30,55 10,55 50,95 90,55 70,55 70,5" fill="currentColor"/>' },
        { id: 'arrow-double', icon: '‚ÜîÔ∏è', name: 'Fl√®che double', svg: '<polygon points="5,50 25,30 25,42 75,42 75,30 95,50 75,70 75,58 25,58 25,70" fill="currentColor"/>' },
        { id: 'chevron-right', icon: '‚Ä∫', name: 'Chevron droite', svg: '<polygon points="25,5 75,50 25,95 35,95 85,50 35,5" fill="currentColor"/>' },
        { id: 'chevron-left', icon: '‚Äπ', name: 'Chevron gauche', svg: '<polygon points="75,5 25,50 75,95 65,95 15,50 65,5" fill="currentColor"/>' },
        // Bulles et communication
        { id: 'bubble', icon: 'üí¨', name: 'Bulle parole', svg: '<path d="M5,5 L95,5 Q98,5 98,8 L98,65 Q98,68 95,68 L35,68 L20,90 L20,68 L5,68 Q2,68 2,65 L2,8 Q2,5 5,5 Z" fill="currentColor"/>' },
        { id: 'bubble-round', icon: 'üó®Ô∏è', name: 'Bulle ronde', svg: '<ellipse cx="50" cy="40" rx="45" ry="35" fill="currentColor"/><polygon points="25,65 35,90 45,68" fill="currentColor"/>' },
        { id: 'bubble-thought', icon: 'üí≠', name: 'Bulle pens√©e', svg: '<ellipse cx="50" cy="35" rx="40" ry="30" fill="currentColor"/><circle cx="25" cy="75" r="8" fill="currentColor"/><circle cx="15" cy="90" r="5" fill="currentColor"/>' },
        // Symboles
        { id: 'heart', icon: '‚ù§Ô∏è', name: 'C≈ìur', svg: '<path d="M50,90 C15,60 5,35 20,20 C35,5 50,15 50,30 C50,15 65,5 80,20 C95,35 85,60 50,90 Z" fill="currentColor"/>' },
        { id: 'cross', icon: '‚úö', name: 'Croix', svg: '<polygon points="35,5 65,5 65,35 95,35 95,65 65,65 65,95 35,95 35,65 5,65 5,35 35,35" fill="currentColor"/>' },
        { id: 'x-mark', icon: '‚úï', name: 'X', svg: '<polygon points="20,5 50,35 80,5 95,20 65,50 95,80 80,95 50,65 20,95 5,80 35,50 5,20" fill="currentColor"/>' },
        { id: 'check', icon: '‚úì', name: 'Check', svg: '<polygon points="10,50 20,40 40,60 80,20 90,30 40,85" fill="currentColor"/>' },
        { id: 'plus', icon: 'Ôºã', name: 'Plus', svg: '<rect x="40" y="10" width="20" height="80" fill="currentColor"/><rect x="10" y="40" width="80" height="20" fill="currentColor"/>' },
        { id: 'minus', icon: '‚àí', name: 'Moins', svg: '<rect x="10" y="40" width="80" height="20" fill="currentColor" rx="3"/>' },
        // Lignes
        { id: 'line-h', icon: '‚îÄ', name: 'Ligne horizontale', svg: '<rect x="5" y="45" width="90" height="10" fill="currentColor"/>' },
        { id: 'line-v', icon: '‚îÇ', name: 'Ligne verticale', svg: '<rect x="45" y="5" width="10" height="90" fill="currentColor"/>' },
        { id: 'line-diag', icon: '‚ï±', name: 'Ligne diagonale', svg: '<polygon points="90,5 95,10 10,95 5,90" fill="currentColor"/>' },
        // Cadres
        { id: 'frame', icon: '‚òê', name: 'Cadre', svg: '<rect x="5" y="5" width="90" height="90" fill="none" stroke="currentColor" stroke-width="8"/>' },
        { id: 'frame-rounded', icon: '‚Éû', name: 'Cadre arrondi', svg: '<rect x="5" y="5" width="90" height="90" fill="none" stroke="currentColor" stroke-width="8" rx="15"/>' },
        { id: 'circle-frame', icon: '‚óã', name: 'Cercle vide', svg: '<circle cx="50" cy="50" r="42" fill="none" stroke="currentColor" stroke-width="8"/>' }
    ],
    
    showShapesMenu: () => {
        MoodBoard.hideRadialMenu();
        
        const menu = document.createElement('div');
        menu.className = 'moodboard-shape-submenu';
        menu.id = 'moodboardShapeMenu';
        
        MoodBoard.shapes.forEach(shape => {
            const btn = document.createElement('div');
            btn.className = 'moodboard-shape-option';
            btn.innerHTML = shape.icon;
            btn.title = shape.name;
            btn.onclick = () => {
                MoodBoard.addShape(shape.id);
                menu.remove();
            };
            menu.appendChild(btn);
        });
        
        document.body.appendChild(menu);
        
        // Positionner pr√®s du clic mais toujours visible
        const wrapper = document.getElementById('moodboardCanvasWrapper');
        const rect = wrapper.getBoundingClientRect();
        let posX = MoodBoard.contextX * MoodBoard.zoom + MoodBoard.panX + rect.left;
        let posY = MoodBoard.contextY * MoodBoard.zoom + MoodBoard.panY + rect.top;
        
        // Ajuster si le menu d√©passe √† droite
        const menuRect = menu.getBoundingClientRect();
        if(posX + menuRect.width > window.innerWidth - 20) {
            posX = window.innerWidth - menuRect.width - 20;
        }
        // Ajuster si le menu d√©passe en bas
        if(posY + menuRect.height > window.innerHeight - 20) {
            posY = window.innerHeight - menuRect.height - 20;
        }
        // Ajuster si le menu d√©passe en haut ou √† gauche
        if(posX < 20) posX = 20;
        if(posY < 20) posY = 20;
        
        menu.style.left = posX + 'px';
        menu.style.top = posY + 'px';
        
        // Fermer si clic ailleurs
        setTimeout(() => {
            const closeHandler = (e) => {
                if(!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            document.addEventListener('click', closeHandler);
        }, 100);
    },
    
    renamePalette: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.hideRadialMenu();
        
        const newName = await ConfirmModal.prompt('Nom de la palette :', 'Renommer la palette', 'Nom...', element.paletteName || 'Sans nom');
        if(newName !== null && newName.trim()) {
            element.paletteName = newName.trim();
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            Utils.toast('Palette renomm√©e', 'success');
        }
    },
    
    changeShapeColor: async (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element) return;
        
        MoodBoard.hideRadialMenu();
        
        const modal = document.createElement('div');
        modal.className = 'confirm-modal-overlay';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="confirm-modal-box" style="max-width: 350px;">
                <div class="confirm-modal-icon">üé®</div>
                <div class="confirm-modal-title">Couleur de la forme</div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0;">
                    ${['#000000', '#FFFFFF', '#FF0000', '#FF6B00', '#FFD700', '#00C853', '#2196F3', '#9C27B0', '#E91E63', '#795548', '#607D8B', '#00BCD4'].map(c => 
                        `<div onclick="document.getElementById('shapeColorInput').value='${c}'; document.getElementById('shapeColorPreview').style.background='${c}';" 
                             style="width: 40px; height: 40px; background: ${c}; border-radius: 8px; cursor: pointer; border: 2px solid ${c === '#FFFFFF' ? '#ddd' : 'transparent'}; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>`
                    ).join('')}
                </div>
                <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0;">
                    <div id="shapeColorPreview" style="width: 50px; height: 50px; background: ${element.color || '#000000'}; border-radius: 8px; border: 1px solid #ddd;"></div>
                    <input type="color" id="shapeColorInput" value="${element.color || '#000000'}" 
                           onchange="document.getElementById('shapeColorPreview').style.background=this.value"
                           style="flex: 1; height: 50px; cursor: pointer; border: none; border-radius: 8px;">
                </div>
                <div class="confirm-modal-buttons">
                    <button class="confirm-modal-btn cancel" onclick="this.closest('.confirm-modal-overlay').remove()">Annuler</button>
                    <button class="confirm-modal-btn confirm" id="applyShapeColorBtn">Appliquer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('applyShapeColorBtn').onclick = () => {
            element.color = document.getElementById('shapeColorInput').value;
            board.modifiedAt = Date.now();
            Store.save();
            MoodBoard.renderCanvas();
            modal.remove();
            Utils.toast('Couleur modifi√©e', 'success');
        };
    },
    
    addShape: (shapeId) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const shape = MoodBoard.shapes.find(s => s.id === shapeId);
        if(!shape) return;
        
        const element = {
            id: 'el_' + Date.now(),
            type: 'shape',
            shapeId: shapeId,
            x: MoodBoard.contextX,
            y: MoodBoard.contextY,
            width: 150,
            height: 150,
            color: '#000000',
            rotation: 0,
            linkedTo: null,
            createdAt: Date.now()
        };
        
        board.elements.push(element);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        Utils.toast('Forme ajout√©e', 'success');
    },
    
    addPaletteToBoard: (colors, name) => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const element = {
            id: 'el_' + Date.now(),
            type: 'palette',
            x: MoodBoard.contextX,
            y: MoodBoard.contextY,
            width: 500,
            height: 200,
            colors: colors,
            paletteName: name,
            linkedTo: null,
            createdAt: Date.now()
        };
        
        board.elements.push(element);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        Utils.toast('Palette "' + name + '" ajout√©e', 'success');
    },
    
    uploadImage: () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('S√©lectionnez d\'abord une planche', 'warning');
            return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,.png,.jpg,.jpeg,.gif,.webp,.svg,.bmp';
        input.multiple = true;
        input.onchange = (e) => {
            Array.from(e.target.files).forEach((file, i) => {
                MoodBoard.addImageFromFile(file, MoodBoard.contextX + i * 30, MoodBoard.contextY + i * 30);
            });
        };
        input.click();
    },
    
    uploadFile: () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('S√©lectionnez d\'abord une planche', 'warning');
            return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf,.doc,.docx,.txt,.rtf,.xls,.xlsx,.ppt,.pptx,image/*';
        input.multiple = true;
        input.onchange = async (e) => {
            Array.from(e.target.files).forEach((file, i) => {
                const offsetX = MoodBoard.contextX + i * 30;
                const offsetY = MoodBoard.contextY + i * 30;
                
                if(file.type.startsWith('image/')) {
                    MoodBoard.addImageFromFile(file, offsetX, offsetY);
                    return;
                }
                
                // Pour les documents, cr√©er un √©l√©ment fichier
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const currentBoard = MoodBoard.getCurrentBoard();
                    if(!currentBoard) return;
                    
                    const element = {
                        id: 'el_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                        type: 'file',
                        x: offsetX,
                        y: offsetY,
                        width: 180,
                        height: 140,
                        fileName: file.name,
                        fileType: file.type || MoodBoard.getFileType(file.name),
                        fileSize: file.size,
                        fileData: ev.target.result,
                        linkedTo: null,
                        createdAt: Date.now()
                    };
                    
                    currentBoard.elements.push(element);
                    currentBoard.modifiedAt = Date.now();
                    Store.save();
                    
                    MoodBoard.renderCanvas();
                    Utils.toast('Fichier ajout√©: ' + file.name, 'success');
                };
                reader.readAsDataURL(file);
            });
        };
        input.click();
    },
    
    getFileType: (fileName) => {
        const ext = fileName.split('.').pop().toLowerCase();
        const types = {
            'pdf': 'application/pdf',
            'doc': 'application/msword',
            'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'xls': 'application/vnd.ms-excel',
            'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'ppt': 'application/vnd.ms-powerpoint',
            'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
            'txt': 'text/plain',
            'rtf': 'application/rtf'
        };
        return types[ext] || 'application/octet-stream';
    },
    
    openFile: (elementId) => {
        const board = MoodBoard.getCurrentBoard();
        const element = board?.elements.find(el => el.id === elementId);
        if(!element || !element.fileData) return;
        
        // Ouvrir le fichier dans un nouvel onglet
        const win = window.open();
        if(element.fileType.includes('pdf')) {
            win.document.write(`<iframe src="${element.fileData}" style="width:100%;height:100%;border:none;"></iframe>`);
        } else {
            win.document.write(`<html><head><title>${element.fileName}</title></head><body>
                <p>Fichier: <strong>${element.fileName}</strong></p>
                <p><a href="${element.fileData}" download="${element.fileName}">üì• T√©l√©charger</a></p>
            </body></html>`);
        }
    },
    
    addWebLink: async () => {
        const url = await ConfirmModal.prompt({
            title: 'Ajouter un lien web',
            message: 'URL du lien (page web, image, vid√©o...) :',
            placeholder: 'https://...'
        });
        
        if(!url) return;
        
        const board = MoodBoard.getCurrentBoard();
        if(!board) return;
        
        const element = {
            id: 'el_' + Date.now(),
            type: 'link',
            x: MoodBoard.contextX,
            y: MoodBoard.contextY,
            width: 200,
            height: 120,
            url: url,
            title: new URL(url).hostname || 'Lien',
            linkedTo: null,
            createdAt: Date.now()
        };
        
        board.elements.push(element);
        board.modifiedAt = Date.now();
        Store.save();
        
        MoodBoard.renderCanvas();
        Utils.toast('Lien ajout√©', 'success');
    },
    
    // ===== EXPORT =====
    
    // Convertir un SVG en image pour l'export
    svgToImage: (svgContent, color, width, height) => {
        return new Promise((resolve) => {
            const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="${width}" height="${height}">${svgContent.replace(/currentColor/g, color)}</svg>`;
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => resolve(null);
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
        });
    },
    
    exportPNG: async () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('Aucune planche s√©lectionn√©e', 'warning');
            return;
        }
        
        Utils.toast('G√©n√©ration du PNG en cours...', 'info');
        
        const canvasW = board.canvasWidth || 1200;
        const canvasH = board.canvasHeight || 800;
        const scale = 2;
        
        const canvas = document.createElement('canvas');
        canvas.width = canvasW * scale;
        canvas.height = canvasH * scale;
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.scale(scale, scale);
        
        const elements = board.elements || [];
        
        // Pr√©parer les images (images, dessins ET formes SVG)
        const imagesToLoad = [];
        elements.forEach(el => {
            if((el.type === 'image' || el.type === 'drawing') && el.src) {
                imagesToLoad.push({ el, type: 'image' });
            } else if(el.type === 'shape') {
                imagesToLoad.push({ el, type: 'shape' });
            }
        });
        
        // Charger toutes les images et convertir les SVG
        for(const item of imagesToLoad) {
            if(item.type === 'image') {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                await new Promise(resolve => {
                    img.onload = () => { item.el.imgLoaded = img; resolve(); };
                    img.onerror = () => resolve();
                    img.src = item.el.src;
                });
            } else if(item.type === 'shape') {
                const shape = MoodBoard.shapes.find(s => s.id === item.el.shapeId);
                if(shape) {
                    const w = item.el.width || 100;
                    const h = item.el.height || 100;
                    item.el.shapeImg = await MoodBoard.svgToImage(shape.svg, item.el.color || '#000000', w * scale, h * scale);
                }
            }
        }
        
        // Dessiner tous les √©l√©ments
        elements.forEach(el => {
            const x = el.x || 0;
            const y = el.y || 0;
            const w = el.width || 100;
            const h = el.height || 100;
            
            ctx.save();
            
            if(el.rotation) {
                ctx.translate(x + w/2, y + h/2);
                ctx.rotate(el.rotation * Math.PI / 180);
                ctx.translate(-(x + w/2), -(y + h/2));
            }
            
            if(el.type === 'image' || el.type === 'drawing') {
                if(el.imgLoaded) ctx.drawImage(el.imgLoaded, x, y, w, h);
            } else if(el.type === 'text') {
                ctx.fillStyle = el.textColor || el.color || '#333333';
                ctx.font = `${el.bold ? 'bold ' : ''}${el.fontSize || 14}px ${el.fontFamily || 'Arial'}`;
                ctx.textAlign = el.textAlign || el.align || 'left';
                const lines = (el.content || '').split('\n');
                lines.forEach((line, i) => {
                    ctx.fillText(line, x + 5, y + 20 + (i * (el.fontSize || 14) * 1.2));
                });
            } else if(el.type === 'palette') {
                const colors = el.colors || [];
                const colorW = w / Math.max(colors.length, 1);
                colors.forEach((color, i) => {
                    ctx.fillStyle = color;
                    ctx.fillRect(x + (i * colorW), y, colorW, h * 0.7);
                    ctx.fillStyle = '#333';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(color, x + (i * colorW) + colorW/2, y + h * 0.9);
                });
                if(el.paletteName) {
                    ctx.fillStyle = '#666';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(el.paletteName, x, y - 5);
                }
            } else if(el.type === 'shape') {
                if(el.shapeImg) {
                    ctx.drawImage(el.shapeImg, x, y, w, h);
                } else {
                    ctx.fillStyle = el.color || '#000000';
                    ctx.fillRect(x, y, w, h);
                }
            } else if(el.type === 'link') {
                ctx.fillStyle = '#f0f0f0';
                ctx.strokeStyle = '#ccc';
                ctx.fillRect(x, y, w, h);
                ctx.strokeRect(x, y, w, h);
                ctx.fillStyle = '#2b6ef6';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('üîó ' + (el.url || 'Lien').substring(0, 30), x + 5, y + h/2 + 4);
            }
            
            ctx.restore();
        });
        
        // Nom de fichier explicite
        const projectTitle = state.data?.title || 'Projet';
        const boardName = board.name || 'MoodBoard';
        const filename = `${projectTitle}_MoodBoard_${boardName}`.replace(/[^a-z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß_-]/gi, '_') + '.png';
        
        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        Utils.toast('PNG export√© !', 'success');
        History.log('EXPORT', `MoodBoard "${board.name}" export√© en PNG`);
    },
    
    exportPDF: async () => {
        const board = MoodBoard.getCurrentBoard();
        if(!board) {
            Utils.toast('Aucune planche s√©lectionn√©e', 'warning');
            return;
        }
        
        Utils.toast('G√©n√©ration du PDF en cours...', 'info');
        
        const { jsPDF } = window.jspdf;
        const format = board.format || 'a4-landscape';
        
        // D√©finir orientation et format
        let orientation = 'landscape';
        let pageFormat = 'a4';
        if(format.includes('portrait')) orientation = 'portrait';
        if(format.includes('a3')) pageFormat = 'a3';
        else if(format.includes('a2')) pageFormat = 'a2';
        else if(format.includes('a0')) pageFormat = 'a0';
        
        const doc = new jsPDF({ orientation, format: pageFormat, unit: 'mm' });
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // En-t√™te
        doc.setFillColor(43, 110, 246);
        doc.rect(0, 0, pageWidth, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(board.name || 'MoodBoard', 10, 10);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        const projectTitle = state.data?.title || 'Projet';
        doc.text(projectTitle, pageWidth - 10, 10, { align: 'right' });
        
        // Liaison si elle existe
        if(board.linkedTo) {
            doc.setTextColor(200, 200, 200);
            doc.setFontSize(8);
            let linkText = '';
            if(board.linkedTo.type === 'scene') {
                const scene = state.data.scenes.find(s => s.id === board.linkedTo.id);
                linkText = scene ? `Li√© √† : ${scene.title}` : '';
            } else if(board.linkedTo.type === 'character') {
                const char = state.data.characters.find(c => c.id === board.linkedTo.id);
                linkText = char ? `Li√© √† : ${char.name}` : '';
            }
            if(linkText) doc.text(linkText, pageWidth / 2, 10, { align: 'center' });
        }
        
        // Zone de travail
        const margin = 10;
        const workY = 20;
        const workWidth = pageWidth - (margin * 2);
        const workHeight = pageHeight - workY - margin;
        
        // Calculer le scale pour adapter les √©l√©ments au PDF
        const canvasW = board.canvasWidth || 1200;
        const canvasH = board.canvasHeight || 800;
        const scaleX = workWidth / canvasW;
        const scaleY = workHeight / canvasH;
        const scale = Math.min(scaleX, scaleY);
        
        // Fond blanc pour la zone de travail
        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(200, 200, 200);
        doc.rect(margin, workY, workWidth, workHeight, 'FD');
        
        // Dessiner les √©l√©ments
        const elements = board.elements || [];
        
        // Pr√©-convertir les formes SVG en images pour le PDF
        const shapeImages = {};
        for(const el of elements) {
            if(el.type === 'shape') {
                const shape = MoodBoard.shapes.find(s => s.id === el.shapeId);
                if(shape) {
                    const imgW = 200;
                    const imgH = 200;
                    const svgImg = await MoodBoard.svgToImage(shape.svg, el.color || '#000000', imgW, imgH);
                    if(svgImg) {
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = imgW;
                        tempCanvas.height = imgH;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(svgImg, 0, 0, imgW, imgH);
                        shapeImages[el.id] = tempCanvas.toDataURL('image/png');
                    }
                }
            }
        }
        
        for(const el of elements) {
            const x = margin + (el.x * scale);
            const y = workY + (el.y * scale);
            const w = (el.width || 100) * scale;
            const h = (el.height || 100) * scale;
            
            try {
                if(el.type === 'image' || el.type === 'drawing') {
                    if(el.src && el.src.startsWith('data:image')) {
                        doc.addImage(el.src, 'PNG', x, y, w, h);
                    }
                } else if(el.type === 'text') {
                    doc.setTextColor(el.textColor || el.color || '#333333');
                    doc.setFontSize(Math.max(8, (el.fontSize || 14) * scale * 0.5));
                    doc.setFont('helvetica', el.bold ? 'bold' : 'normal');
                    const textLines = doc.splitTextToSize(el.content || '', w);
                    doc.text(textLines, x + 2, y + 5);
                } else if(el.type === 'palette') {
                    const colors = el.colors || [];
                    const colorW = w / Math.max(colors.length, 1);
                    colors.forEach((color, i) => {
                        const hex = color.replace('#', '');
                        const r = parseInt(hex.substr(0, 2), 16);
                        const g = parseInt(hex.substr(2, 2), 16);
                        const b = parseInt(hex.substr(4, 2), 16);
                        doc.setFillColor(r, g, b);
                        doc.rect(x + (i * colorW), y, colorW, h * 0.7, 'F');
                        doc.setTextColor(50, 50, 50);
                        doc.setFontSize(6);
                        doc.text(color, x + (i * colorW) + colorW/2, y + h * 0.85, { align: 'center' });
                    });
                    if(el.paletteName) {
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(el.paletteName, x, y - 2);
                    }
                } else if(el.type === 'shape') {
                    if(shapeImages[el.id]) {
                        doc.addImage(shapeImages[el.id], 'PNG', x, y, w, h);
                    } else {
                        const hex = (el.color || '#000000').replace('#', '');
                        const r = parseInt(hex.substr(0, 2), 16);
                        const g = parseInt(hex.substr(2, 2), 16);
                        const b = parseInt(hex.substr(4, 2), 16);
                        doc.setFillColor(r, g, b);
                        doc.rect(x, y, w, h, 'F');
                    }
                } else if(el.type === 'link') {
                    doc.setFillColor(240, 240, 240);
                    doc.setDrawColor(180, 180, 180);
                    doc.roundedRect(x, y, w, h, 3, 3, 'FD');
                    doc.setTextColor(43, 110, 246);
                    doc.setFontSize(8);
                    const urlText = el.url ? (el.url.length > 40 ? el.url.substring(0, 40) + '...' : el.url) : 'Lien';
                    doc.text('üîó ' + urlText, x + 3, y + h/2 + 2);
                }
            } catch(err) {
                console.warn('Erreur export √©l√©ment:', el.type, err);
            }
        }
        
        // Pied de page
        doc.setTextColor(150, 150, 150);
        doc.setFontSize(7);
        doc.text(`G√©n√©r√© par Moteur - ${new Date().toLocaleDateString('fr-FR')}`, margin, pageHeight - 3);
        doc.text(`${elements.length} √©l√©ment(s)`, pageWidth - margin, pageHeight - 3, { align: 'right' });
        
        // Nom de fichier explicite
        const boardName = board.name || 'MoodBoard';
        const filename = `${projectTitle}_MoodBoard_${boardName}`.replace(/[^a-z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß_-]/gi, '_') + '.pdf';
        doc.save(filename);
        
        Utils.toast('PDF export√© !', 'success');
        History.log('EXPORT', `MoodBoard "${board.name}" export√© en PDF`);
    }
};

const Storyboard = {
    currentSceneId: null,
    
    init: () => {
        Storyboard.renderScenesList();
        document.getElementById('sbNoScene').style.display = 'flex';
        document.getElementById('sbShotsContainer').style.display = 'none';
    },
    
    renderScenesList: () => {
        const container = document.getElementById('sbScenesList');
        container.innerHTML = '';
        
        if(state.data.scenes.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üé¨</div>
                    <div class="empty-state-title">Aucune sc√®ne</div>
                    <div class="empty-state-desc">Cr√©ez votre premi√®re sc√®ne pour commencer √† construire votre s√©quencier. Chaque sc√®ne peut avoir un titre, un r√©sum√© et des personnages.</div>
                    <button class="empty-state-btn" onclick="app.Actions.addScene()">+ Ajouter une sc√®ne</button>
                    <div class="empty-state-tips">üí° <strong>Astuce :</strong> Importez un sc√©nario existant pour g√©n√©rer automatiquement les sc√®nes.</div>
                </div>
            `;
            return;
        }
        
        state.data.scenes.forEach((scene, idx) => {
            const shotCount = state.data.shots.filter(s => s.sceneId === scene.id).length;
            const sceneStatus = scene.status || 'not-verified';
            const statusLabels = { 'not-verified': 'üî¥', 'to-work': 'üü°', 'verified': 'üü¢' };
            const div = document.createElement('div');
            div.className = 'sb-scene-item' + (Storyboard.currentSceneId === scene.id ? ' active' : '');
            div.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div class="sb-scene-title">#${idx + 1} ${Utils.escape(scene.title)}</div>
                    <div class="scene-status-container"><span class="scene-status-badge ${sceneStatus}" onclick="event.stopPropagation(); app.UI.toggleSceneStatus('${scene.id}', event)">${statusLabels[sceneStatus]}</span></div>
                </div>
                <div class="sb-scene-meta">${shotCount} plan(s)</div>
            `;
            div.onclick = () => Storyboard.selectScene(scene.id);
            container.appendChild(div);
        });
    },
    
    selectScene: (sceneId) => {
        Storyboard.currentSceneId = sceneId;
        Storyboard.renderScenesList();
        document.getElementById('sbNoScene').style.display = 'none';
        document.getElementById('sbShotsContainer').style.display = 'block';
        Storyboard.renderShots();
    },
    
    renderShots: () => {
        const container = document.getElementById('sbShotsList');
        container.innerHTML = '';
        
        if(!state.data.shots) state.data.shots = [];
        
        const shots = state.data.shots
            .filter(s => s.sceneId === Storyboard.currentSceneId)
            .sort((a, b) => a.order - b.order);
        
        if(shots.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-sec); padding: 40px;">Aucun plan cr√©√©</div>';
            return;
        }
        
        // Create compact grid
        const grid = document.createElement('div');
        grid.className = 'shots-compact-grid';
        
        shots.forEach((shot, idx) => {
            const card = Storyboard.createCompactCard(shot, idx);
            grid.appendChild(card);
        });
        
        container.appendChild(grid);
        
        // Setup drag and drop
        if(state.currentRole !== 'viewer') {
            Storyboard.setupDragDrop(grid);
        }
    },
    
    createCompactCard: (shot, idx) => {
        const sceneIndex = state.data.scenes.findIndex(s => s.id === Storyboard.currentSceneId) + 1;
        const card = document.createElement('div');
        card.className = 'shot-compact-card';
        card.draggable = state.currentRole !== 'viewer';
        card.dataset.shotId = shot.id;
        
        let imageHTML = '';
        if(shot.imageType === 'upload' && shot.imageUrl) {
            imageHTML = `<img src="${shot.imageUrl}" alt="Plan ${sceneIndex}.${idx + 1}">`;
        } else if(shot.imageType === 'drawing' && shot.drawingData) {
            imageHTML = `<canvas id="compact-preview-${shot.id}" width="800" height="600" style="max-width: 100%; max-height: 100%; object-fit: contain;"></canvas>`;
        } else {
            imageHTML = `<div style="color: #999; font-size: 2rem;">üé®</div>`;
        }
        
        const dirtyIndicator = shot.isDirty ? '<div class="shot-dirty-indicator">‚óè</div>' : '';
        
        // Construire les infos techniques (acronymes)
        const techParts = [];
        if(shot.shotType) techParts.push(Storyboard.extractAcronym(shot.shotType));
        if(shot.cameraMove) techParts.push(Storyboard.extractAcronym(shot.cameraMove));
        if(shot.cameraMode) techParts.push(Storyboard.extractAcronym(shot.cameraMode));
        const techInfo = techParts.length > 0 ? `<div class="shot-compact-tech">${techParts.join(' ‚Ä¢ ')}</div>` : '';
        const nameInfo = shot.name ? `<div class="shot-compact-name">${Utils.escape(shot.name)}</div>` : '';
        
        card.innerHTML = `
            ${dirtyIndicator}
            <div class="shot-compact-image" onclick="app.Storyboard.openEditModal('${shot.id}')">
                ${imageHTML}
            </div>
            <div class="shot-compact-footer">
                <span>Plan ${sceneIndex}.${idx + 1}</span>
                ${state.currentRole !== 'viewer' ? `<button class="shot-compact-delete" onclick="app.Storyboard.deleteShot('${shot.id}', event)">üóëÔ∏è</button>` : ''}
            </div>
            ${nameInfo}
            ${techInfo}
        `;
        
        // Render drawing preview
        setTimeout(() => {
            if(shot.imageType === 'drawing' && shot.drawingData) {
                const canvas = document.getElementById(`compact-preview-${shot.id}`);
                if(canvas) {
                    const ctx = canvas.getContext('2d');
                    DrawingEditor.renderDrawingData(ctx, shot.drawingData);
                }
            }
        }, 100);
        
        return card;
    },
    
    setupDragDrop: (container) => {
        const cards = container.querySelectorAll('.shot-compact-card');
        
        cards.forEach(card => {
            card.addEventListener('dragstart', () => {
                card.classList.add('dragging');
            });
            
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                Storyboard.updateShotOrder();
            });
        });
        
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = Storyboard.getDragAfterElement(container, e.clientX, e.clientY);
            const dragging = document.querySelector('.shot-compact-card.dragging');
            
            if(afterElement == null) {
                container.appendChild(dragging);
            } else {
                container.insertBefore(dragging, afterElement);
            }
        });
    },
    
    getDragAfterElement: (container, x, y) => {
        const draggableElements = [...container.querySelectorAll('.shot-compact-card:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offsetX = x - box.left - box.width / 2;
            const offsetY = y - box.top - box.height / 2;
            const offset = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
            
            if(offset < closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.POSITIVE_INFINITY }).element;
    },
    
    updateShotOrder: () => {
        const cards = document.querySelectorAll('.shot-compact-card');
        const newOrder = [];
        
        cards.forEach((card, idx) => {
            const shotId = card.dataset.shotId;
            const shot = state.data.shots.find(s => s.id === shotId);
            if(shot) {
                shot.order = idx;
                newOrder.push(shot);
            }
        });
        
        Store.save();
    },
    
    createShotCard: (shot, idx) => {
        const card = document.createElement('div');
        card.className = 'shot-card';
        card.dataset.shotId = shot.id;
        
        let imagePreview = '';
        if(shot.imageType === 'upload' && shot.imageUrl) {
            imagePreview = `<img src="${shot.imageUrl}" alt="Plan ${idx + 1}">`;
        } else if(shot.imageType === 'drawing' && shot.drawingData) {
            imagePreview = `<canvas id="preview-${shot.id}" width="800" height="600"></canvas>`;
        } else {
            imagePreview = `<div class="shot-upload-zone">
                <div style="font-size: 3rem; margin-bottom: 10px;">üé®</div>
                <div>Cliquez pour ajouter une image</div>
            </div>`;
        }
        
        const isView = state.currentRole === 'viewer';
        
        card.innerHTML = `
            <div class="shot-header">
                <h3 style="margin: 0;">Plan ${idx + 1}</h3>
                ${!isView ? `<button onclick="app.Storyboard.deleteShot('${shot.id}')" style="background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">üóëÔ∏è Supprimer</button>` : ''}
            </div>
            
            <div class="shot-preview" onclick="${!isView ? `app.Storyboard.openImageMenu('${shot.id}')` : ''}">
                ${imagePreview}
            </div>
            
            <div class="shot-meta-grid">
                <input type="text" class="shot-input" placeholder="Nom du plan" value="${shot.name || ''}" 
                    onchange="app.Storyboard.updateShot('${shot.id}', 'name', this.value)" ${isView ? 'disabled' : ''}>
                
                <select class="shot-input" onchange="app.Storyboard.updateShot('${shot.id}', 'shotType', this.value)" ${isView ? 'disabled' : ''}>
                    <option value="">Type de plan...</option>
                    ${CONFIG.shotTypes.map(t => `<option value="${t}" ${shot.shotType === t ? 'selected' : ''}>${t}</option>`).join('')}
                </select>
                
                <select class="shot-input" onchange="app.Storyboard.updateShot('${shot.id}', 'cameraMove', this.value)" ${isView ? 'disabled' : ''}>
                    <option value="">Mouvement...</option>
                    ${CONFIG.cameraMoves.map(m => `<option value="${m}" ${shot.cameraMove === m ? 'selected' : ''}>${m}</option>`).join('')}
                </select>
                
                <select class="shot-input" onchange="app.Storyboard.updateShot('${shot.id}', 'cameraMode', this.value)" ${isView ? 'disabled' : ''}>
                    <option value="">Mode cam√©ra...</option>
                    ${CONFIG.cameraModes.map(m => `<option value="${m}" ${shot.cameraMode === m ? 'selected' : ''}>${m}</option>`).join('')}
                </select>
            </div>
            
            <textarea class="shot-textarea" placeholder="Description du plan..." 
                onchange="app.Storyboard.updateShot('${shot.id}', 'description', this.value)" ${isView ? 'disabled' : ''}>${shot.description || ''}</textarea>
            
            <textarea class="shot-textarea" placeholder="Direction des acteurs..." 
                onchange="app.Storyboard.updateShot('${shot.id}', 'actorDirection', this.value)" ${isView ? 'disabled' : ''}>${shot.actorDirection || ''}</textarea>
            
            <textarea class="shot-textarea" placeholder="Direction technique..." 
                onchange="app.Storyboard.updateShot('${shot.id}', 'technicalDirection', this.value)" ${isView ? 'disabled' : ''}>${shot.technicalDirection || ''}</textarea>
            
            ${shot.versions && shot.versions.length > 0 ? `
                <div style="margin-top: 15px; padding: 10px; background: var(--bg); border-radius: 6px;">
                    <strong>Versions sauvegard√©es (${shot.versions.length})</strong>
                    <select class="shot-input" style="margin-top: 5px;" onchange="app.Storyboard.restoreVersion('${shot.id}', this.value)">
                        <option value="">Restaurer une version...</option>
                        ${shot.versions.map((v, i) => `<option value="${i}">Version ${i + 1} - ${new Date(v.timestamp).toLocaleString()}</option>`).join('')}
                    </select>
                </div>
            ` : ''}
        `;
        
        // Render drawing preview if exists
        setTimeout(() => {
            if(shot.imageType === 'drawing' && shot.drawingData) {
                const canvas = document.getElementById(`preview-${shot.id}`);
                if(canvas) {
                    const ctx = canvas.getContext('2d');
                    DrawingEditor.renderDrawingData(ctx, shot.drawingData);
                }
            }
        }, 100);
        
        return card;
    },
    
    addShot: () => {
        if(state.currentRole === 'viewer') return;
        if(state.currentRole !== 'owner' && !Permissions.canEdit('storyboard')) {
            Utils.toast('Vous n\'avez pas la permission de modifier le storyboard.', 'error');
            return;
        }
        if(!Storyboard.currentSceneId) return;
        
        const existingShots = state.data.shots.filter(s => s.sceneId === Storyboard.currentSceneId);
        const maxOrder = existingShots.length > 0 ? Math.max(...existingShots.map(s => s.order)) : -1;
        
        const newShot = {
            id: Utils.generateUniqueId(),
            sceneId: Storyboard.currentSceneId,
            order: maxOrder + 1,
            name: '',
            imageType: null,
            imageUrl: null,
            drawingData: null,
            shotType: '',
            cameraMove: '',
            cameraMode: '',
            description: '',
            actorDirection: '',
            technicalDirection: '',
            versions: [],
            isDirty: false,
            lastModified: Date.now()
        };
        
        state.data.shots.push(newShot);
        const scene = state.data.scenes.find(s => s.id === Storyboard.currentSceneId);
        History.log('ADD', `Ajout plan storyboard : ${scene?.title || 'Sc√®ne inconnue'}`);
        Store.save();
        Storyboard.renderShots();
        Storyboard.renderScenesList();
    },
    
    deleteShot: async (shotId, event) => {
        if(event) event.stopPropagation();
        if(state.currentRole === 'viewer' || !Permissions.canEdit('storyboard')) return;
        if(!await ConfirmModal.confirmDelete("Ce plan sera d√©finitivement supprim√©.")) return;
        
        const shot = state.data.shots.find(s => s.id === shotId);
        const scene = state.data.scenes.find(s => s.id === shot?.sceneId);
        state.data.shots = state.data.shots.filter(s => s.id !== shotId);
        History.log('DELETE', `Suppression plan storyboard : ${scene?.title || 'Sc√®ne inconnue'}`);
        Store.save();
        Storyboard.renderShots();
        Storyboard.renderScenesList();
    },
    
    updateShot: (shotId, field, value) => {
        if(state.currentRole === 'viewer' || !Permissions.canEdit('storyboard')) return;
        
        const shot = state.data.shots.find(s => s.id === shotId);
        if(shot) {
            shot[field] = value;
            shot.lastModified = Date.now();
            Store.save();
        }
    },
    
    openImageMenu: (shotId) => {
        if(state.currentRole === 'viewer') return;
        
        // Cr√©er le menu modal
        const menu = document.createElement('div');
        menu.id = 'image-menu-modal';
        menu.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 99999;';
        menu.onclick = (e) => { if(e.target === menu) menu.remove(); };
        
        menu.innerHTML = `
            <div style="background: var(--panel-bg); border-radius: 12px; padding: 25px; text-align: center; min-width: 300px;">
                <h3 style="margin: 0 0 20px; color: var(--text-main);">üñºÔ∏è Ajouter une image</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="app.Storyboard.chooseDrawing('${shotId}')" style="padding: 15px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                        üé® Dessiner
                    </button>
                    <button onclick="app.Storyboard.chooseImport('${shotId}')" style="padding: 15px 20px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                        üì∑ Importer une image
                    </button>
                    <button onclick="document.getElementById('image-menu-modal').remove()" style="padding: 12px 20px; background: var(--bg); color: var(--text-main); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 0.95rem;">
                        ‚úñ Annuler
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(menu);
    },
    
    chooseDrawing: (shotId) => {
        document.getElementById('image-menu-modal').remove();
        DrawingEditor.open(shotId, () => {
            // Callback apr√®s sauvegarde du dessin
            if(Storyboard.currentEditingShotId === shotId) {
                Storyboard.refreshEditModal(shotId);
            }
        });
    },
    
    chooseImport: (shotId) => {
        document.getElementById('image-menu-modal').remove();
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => Storyboard.handleImageUpload(shotId, e);
        input.click();
    },
    
    handleImageUpload: (shotId, event) => {
        const file = event.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const shot = state.data.shots.find(s => s.id === shotId);
            if(shot) {
                shot.imageType = 'upload';
                shot.imageUrl = e.target.result;
                shot.lastModified = Date.now();
                Store.save();
                Storyboard.renderShots();
                // Rafra√Æchir la modale si elle est ouverte
                if(Storyboard.currentEditingShotId === shotId) {
                    Storyboard.refreshEditModal(shotId);
                }
            }
        };
        reader.readAsDataURL(file);
    },
    
	currentEditingShotId: null,
    
    openEditModal: (shotId) => {
        if(state.currentRole === 'viewer') return;
        
        Storyboard.currentEditingShotId = shotId;
        const shot = state.data.shots.find(s => s.id === shotId);
        if(!shot) return;
        
        const sceneIndex = state.data.scenes.findIndex(s => s.id === shot.sceneId) + 1;
        const shotIndex = state.data.shots.filter(s => s.sceneId === shot.sceneId && s.order <= shot.order).length;
        
        document.getElementById('shotEditTitle').innerText = `√âdition Plan ${sceneIndex}.${shotIndex}`;
        
        const content = document.getElementById('shotEditContent');
        content.innerHTML = Storyboard.createShotCard(shot, shotIndex - 1).innerHTML;
        
        // Setup change detection
        content.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('change', () => {
                Storyboard.markAsDirty();
            });
        });
        
        document.getElementById('shot-edit-modal').classList.add('active');
    },
    
    closeEditModal: async () => {
        const saveBtn = document.getElementById('shotEditSaveBtn');
        
        if(saveBtn.classList.contains('visible')) {
            if(!await ConfirmModal.show({ title: 'Modifications non sauvegard√©es', message: 'Vous avez des modifications non sauvegard√©es.\n\nFermer quand m√™me ?', icon: '‚ö†Ô∏è', dangerous: true, confirmText: 'Fermer sans sauvegarder', cancelText: 'Annuler' })) {
                return;
            }
        }
        
        document.getElementById('shot-edit-modal').classList.remove('active');
        Storyboard.currentEditingShotId = null;
        Storyboard.renderShots();
    },
    
    refreshEditModal: (shotId) => {
        const shot = state.data.shots.find(s => s.id === shotId);
        if(!shot) return;
        
        const sceneIndex = state.data.scenes.findIndex(s => s.id === shot.sceneId) + 1;
        const shotIndex = state.data.shots.filter(s => s.sceneId === shot.sceneId && s.order <= shot.order).length;
        
        const content = document.getElementById('shotEditContent');
        content.innerHTML = Storyboard.createShotCard(shot, shotIndex - 1).innerHTML;
        
        // Re-setup change detection
        content.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('change', () => {
                Storyboard.markAsDirty();
            });
        });
    },
    
    markAsDirty: () => {
        const shot = state.data.shots.find(s => s.id === Storyboard.currentEditingShotId);
        if(shot) {
            shot.isDirty = true;
        }
        
        document.getElementById('shotEditSaveBtn').classList.add('visible');
    },
    
    saveCurrentShot: () => {
        const shot = state.data.shots.find(s => s.id === Storyboard.currentEditingShotId);
        if(!shot) return;
        
        shot.isDirty = false;
        shot.lastModified = Date.now();
        
        Store.save();
        
        document.getElementById('shotEditSaveBtn').classList.remove('visible');
        
        Utils.toast('Plan sauvegard√© !', 'success');
        
        Storyboard.closeEditModal();
    },
	
    restoreVersion: (shotId, versionIdx) => {
        if(!versionIdx) return;
        
        const shot = state.data.shots.find(s => s.id === shotId);
        if(shot && shot.versions && shot.versions[versionIdx]) {
            shot.drawingData = JSON.parse(JSON.stringify(shot.versions[versionIdx].data));
            shot.lastModified = Date.now();
            Store.save();
            Storyboard.renderShots();
        }
    },
	currentView: 'edit',
    printConfig: {
        shotNumber: true,
        shotType: true,
        cameraMove: true,
        cameraMode: true,
        description: true,
        actorDirection: true,
        techDirection: true,
        sceneTitle: true
    },
    
    // Extraire l'acronyme entre parenth√®ses, ex: "Gros plan (GP)" ‚Üí "GP"
    extractAcronym: (value) => {
        if(!value) return '';
        const match = value.match(/\(([^)]+)\)/);
        return match ? match[1] : value;
    },
    
    switchView: (view) => {
        Storyboard.currentView = view;
        
        document.querySelectorAll('.sb-toggle-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if(view === 'edit') {
            document.getElementById('sbEditView').style.display = 'flex';
            document.getElementById('sbPrintPreview').classList.remove('active');
        } else if(view === 'preview') {
            document.getElementById('sbEditView').style.display = 'none';
            document.getElementById('sbPrintPreview').classList.add('active');
            Storyboard.renderPrintPreview('sbPrintPreview');
        }
    },
    
    toggleConfig: () => {
        const panel = document.getElementById('sbConfigPanel');
        panel.classList.toggle('open');
    },
    
    applyConfig: () => {
        Storyboard.printConfig = {
            shotNumber: document.getElementById('cfg-shot-number').checked,
            shotType: document.getElementById('cfg-shot-type').checked,
            cameraMove: document.getElementById('cfg-camera-move').checked,
            cameraMode: document.getElementById('cfg-camera-mode').checked,
            description: document.getElementById('cfg-description').checked,
            actorDirection: document.getElementById('cfg-actor-direction').checked,
            techDirection: document.getElementById('cfg-tech-direction').checked,
            sceneTitle: document.getElementById('cfg-scene-title').checked
        };
        
        document.getElementById('sbConfigPanel').classList.remove('open');
        
        if(Storyboard.currentView === 'preview') {
            Storyboard.renderPrintPreview('sbPrintPreview');
        }
        
        Utils.toast('Configuration appliqu√©e !', 'success');
    },
    
    openFullscreen: () => {
        document.getElementById('sbFullscreenModal').classList.add('active');
        Storyboard.renderPrintPreview('sbFullscreenContent');
    },
    
    closeFullscreen: () => {
        document.getElementById('sbFullscreenModal').classList.remove('active');
    },
    
    renderPrintPreview: (containerId) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        if(!state.data.shots || state.data.shots.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 50px;">Aucun plan √† afficher</div>';
            return;
        }
        
        // Group shots by scene
        const sceneGroups = {};
        state.data.scenes.forEach(scene => {
            const sceneShots = state.data.shots
                .filter(s => s.sceneId === scene.id)
                .sort((a, b) => a.order - b.order);
            
            if(sceneShots.length > 0) {
                sceneGroups[scene.id] = {
                    scene: scene,
                    shots: sceneShots
                };
            }
        });
        
        // Render pages
        Object.values(sceneGroups).forEach(group => {
            const { scene, shots } = group;
            const sceneIndex = state.data.scenes.indexOf(scene) + 1;
            
            // Split shots into pages of 6
            for(let i = 0; i < shots.length; i += 6) {
                const pageShots = shots.slice(i, i + 6);
                const page = Storyboard.createPrintPage(scene, sceneIndex, pageShots, i);
                container.appendChild(page);
            }
        });
    },
    
    createPrintPage: (scene, sceneIndex, shots, startIndex) => {
        const page = document.createElement('div');
        page.className = 'sb-print-page';
        
        if(Storyboard.printConfig.sceneTitle) {
            const title = document.createElement('h2');
            title.innerText = `Sc√®ne ${sceneIndex} - ${scene.title}`;
            page.appendChild(title);
        }
        
        const grid = document.createElement('div');
        grid.className = 'sb-print-grid';
        
        shots.forEach((shot, idx) => {
            const shotCard = Storyboard.createPrintShot(shot, sceneIndex, startIndex + idx + 1);
            grid.appendChild(shotCard);
        });
        
        page.appendChild(grid);
        return page;
    },
    
    createPrintShot: (shot, sceneIndex, shotIndex) => {
        const card = document.createElement('div');
        card.className = 'sb-print-shot';
        
        // Image
        const imageDiv = document.createElement('div');
        imageDiv.className = 'sb-print-shot-image';
        
        if(shot.imageType === 'upload' && shot.imageUrl) {
            const img = document.createElement('img');
            img.src = shot.imageUrl;
            imageDiv.appendChild(img);
        } else if(shot.imageType === 'drawing' && shot.drawingData) {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            DrawingEditor.renderDrawingData(ctx, shot.drawingData);
            imageDiv.appendChild(canvas);
        } else {
            imageDiv.innerHTML = '<div style="color: #999;">Pas d\'image</div>';
        }
        
        card.appendChild(imageDiv);
        
        // Info
        const infoDiv = document.createElement('div');
        infoDiv.className = 'sb-print-shot-info';
        
        let infoHTML = '';
        
        // Header line
        const headerParts = [];
        if(Storyboard.printConfig.shotNumber) {
            headerParts.push(`<strong>Plan ${sceneIndex}.${shotIndex}</strong>`);
        }
        if(shot.name) {
            headerParts.push(shot.name);
        }
        if(headerParts.length > 0) {
            infoHTML += `<div class="sb-print-shot-header">${headerParts.join(' - ')}</div>`;
        }
        
        // Meta line (avec acronymes)
        const metaParts = [];
        if(Storyboard.printConfig.shotType && shot.shotType) {
            metaParts.push(Storyboard.extractAcronym(shot.shotType));
        }
        if(Storyboard.printConfig.cameraMove && shot.cameraMove) {
            metaParts.push(Storyboard.extractAcronym(shot.cameraMove));
        }
        if(Storyboard.printConfig.cameraMode && shot.cameraMode) {
            metaParts.push(Storyboard.extractAcronym(shot.cameraMode));
        }
        if(metaParts.length > 0) {
            infoHTML += `<div class="sb-print-shot-meta">${metaParts.join(' ‚Ä¢ ')}</div>`;
        }
        
        // Description section
        if(Storyboard.printConfig.description && shot.description) {
            infoHTML += `<div class="sb-print-shot-desc"><strong>Description :</strong> ${Utils.escape(shot.description)}</div>`;
        }
        
        if(Storyboard.printConfig.actorDirection && shot.actorDirection) {
            infoHTML += `<div class="sb-print-shot-desc"><strong>Direction acteurs :</strong> ${Utils.escape(shot.actorDirection)}</div>`;
        }
        
        if(Storyboard.printConfig.techDirection && shot.technicalDirection) {
            infoHTML += `<div class="sb-print-shot-desc"><strong>Direction technique :</strong> ${Utils.escape(shot.technicalDirection)}</div>`;
        }
        
        infoDiv.innerHTML = infoHTML;
        card.appendChild(infoDiv);
        
        return card;
    },
    
    // ========== EXPORT PDF STORYBOARD ==========
    exportPDF: async () => {
        const { jsPDF } = window.jspdf;
        const scenes = state.data.scenes || [];
        const shots = state.data.shots || [];
        
        if(shots.length === 0) {
            Utils.toast('Aucun plan √† exporter', 'warning');
            return;
        }
        
        Utils.toast('G√©n√©ration du PDF en cours...', 'info');
        
        const doc = new jsPDF('l', 'mm', 'a4'); // Paysage
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 10;
        const projectTitle = state.data.title || 'Projet sans titre';
        
        // Configuration d'affichage - utiliser la config compl√®te
        const config = Storyboard.printConfig || {};
        const showShotNumber = config.shotNumber !== false;
        const showShotType = config.shotType !== false;
        const showCameraMove = config.cameraMove !== false;
        const showCameraMode = config.cameraMode !== false;
        const showDescription = config.description !== false;
        const showActorDirection = config.actorDirection !== false;
        const showTechDirection = config.techDirection !== false;
        
        // Acronymes
        const shotTypes = { 'Plan g√©n√©ral': 'PG', 'Plan d\'ensemble': 'PE', 'Plan moyen': 'PM', 'Plan am√©ricain': 'PA', 'Plan rapproch√©': 'PR', 'Gros plan': 'GP', 'Tr√®s gros plan': 'TGP', 'Insert': 'INS' };
        const cameraMoves = { 'Fixe': 'FIX', 'Panoramique': 'PAN', 'Travelling': 'TRAV', 'Zoom': 'ZOOM', 'Steadicam': 'STEAD', 'Drone': 'DRONE', 'Grue': 'GRUE', '√âpaule': '√âP' };
        const cameraModes = { 'Objectif': 'OBJ', 'Subjectif': 'SUBJ', 'Semi-subjectif': 'SEMI', 'Point de vue': 'PDV' };
        
        // Grouper les plans par sc√®ne
        const sceneShots = {};
        shots.forEach(shot => {
            if(!sceneShots[shot.sceneId]) sceneShots[shot.sceneId] = [];
            sceneShots[shot.sceneId].push(shot);
        });
        
        let pageNum = 0;
        
        // Pour chaque sc√®ne qui a des plans
        for(const scene of scenes) {
            const sceneIdx = scenes.indexOf(scene);
            const shotsList = sceneShots[scene.id] || [];
            if(shotsList.length === 0) continue;
            
            // 4 plans par page (2x2)
            const shotsPerPage = 4;
            const shotWidth = (pageWidth - margin * 3) / 2;
            const shotHeight = (pageHeight - margin * 3 - 15) / 2;
            const imageHeight = shotHeight * 0.55; // R√©duit pour plus d'espace texte
            
            for(let i = 0; i < shotsList.length; i += shotsPerPage) {
                if(pageNum > 0) doc.addPage();
                pageNum++;
                
                // En-t√™te de page
                doc.setFillColor(43, 110, 246);
                doc.rect(0, 0, pageWidth, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`STORYBOARD - ${projectTitle}`, margin, 8);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`Sc√®ne #${sceneIdx + 1} : ${scene.title || 'Sans titre'}`, pageWidth - margin, 8, { align: 'right' });
                
                // Dessiner les plans (grille 2x2)
                const pageShots = shotsList.slice(i, i + shotsPerPage);
                
                pageShots.forEach((shot, idx) => {
                    const col = idx % 2;
                    const row = Math.floor(idx / 2);
                    const x = margin + col * (shotWidth + margin);
                    const y = 15 + row * (shotHeight + margin);
                    
                    // Cadre du plan
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.rect(x, y, shotWidth, shotHeight);
                    
                    // Zone image
                    doc.setFillColor(245, 245, 245);
                    doc.rect(x, y, shotWidth, imageHeight, 'F');
                    
                    // Image du plan
                    if(shot.image) {
                        try {
                            doc.addImage(shot.image, 'PNG', x + 2, y + 2, shotWidth - 4, imageHeight - 4);
                        } catch(e) {
                            doc.setTextColor(180, 180, 180);
                            doc.setFontSize(20);
                            doc.text('üé¨', x + shotWidth/2, y + imageHeight/2, { align: 'center' });
                        }
                    } else {
                        doc.setTextColor(180, 180, 180);
                        doc.setFontSize(20);
                        doc.text('üé¨', x + shotWidth/2, y + imageHeight/2, { align: 'center' });
                    }
                    
                    // Infos du plan
                    let infoY = y + imageHeight + 4;
                    const maxInfoY = y + shotHeight - 2;
                    doc.setTextColor(50, 50, 50);
                    
                    // Ligne 1: Num√©ro, nom et infos techniques
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    let header = [];
                    if(showShotNumber) header.push(`Plan ${i + idx + 1}`);
                    if(shot.name) header.push(`"${shot.name}"`);
                    if(showShotType && shot.shotType) header.push(shotTypes[shot.shotType] || Storyboard.extractAcronym(shot.shotType));
                    if(showCameraMove && shot.cameraMove) header.push(cameraMoves[shot.cameraMove] || Storyboard.extractAcronym(shot.cameraMove));
                    if(showCameraMode && shot.cameraMode) header.push(cameraModes[shot.cameraMode] || Storyboard.extractAcronym(shot.cameraMode));
                    
                    if(header.length > 0) {
                        doc.text(header.join(' ‚Ä¢ '), x + 3, infoY);
                        infoY += 4;
                    }
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    
                    // Description
                    if(showDescription && shot.description && infoY < maxInfoY) {
                        const lines = doc.splitTextToSize(`üìù ${shot.description}`, shotWidth - 6);
                        lines.slice(0, 2).forEach(line => {
                            if(infoY < maxInfoY) { doc.text(line, x + 3, infoY); infoY += 3.5; }
                        });
                    }
                    
                    // Direction acteurs
                    if(showActorDirection && shot.actorDirection && infoY < maxInfoY) {
                        const lines = doc.splitTextToSize(`üé≠ ${shot.actorDirection}`, shotWidth - 6);
                        lines.slice(0, 2).forEach(line => {
                            if(infoY < maxInfoY) { doc.text(line, x + 3, infoY); infoY += 3.5; }
                        });
                    }
                    
                    // Direction technique
                    if(showTechDirection && shot.technicalDirection && infoY < maxInfoY) {
                        const lines = doc.splitTextToSize(`‚öôÔ∏è ${shot.technicalDirection}`, shotWidth - 6);
                        lines.slice(0, 2).forEach(line => {
                            if(infoY < maxInfoY) { doc.text(line, x + 3, infoY); infoY += 3.5; }
                        });
                    }
                });
                
                // Pied de page
                doc.setFontSize(7);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${pageNum}`, pageWidth / 2, pageHeight - 5, { align: 'center' });
            }
        }
        
        // Nom de fichier explicite
        const filename = `${projectTitle}_Storyboard`.replace(/[^a-z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß_-]/gi, '_') + '.pdf';
        doc.save(filename);
        
        Utils.toast('Storyboard PDF export√© !', 'success');
        History.log('EXPORT', 'Storyboard PDF g√©n√©r√©');
    }
};

const DrawingEditor = {
    currentShotId: null,
    moodboardCallback: null,
    canvas: null,
    ctx: null,
    layers: [],
    currentLayerIndex: 0,
    isDrawing: false,
    lastX: 0,
    lastY: 0,
    currentTool: 'pencil',
    currentColor: '#000000',
    brushSize: 10,
    opacity: 100,
    history: [],
    historyStep: -1,
    
    colors: ['#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080'],
    
    open: (shotId, moodboardCallback = null) => {
        DrawingEditor.currentShotId = shotId;
        DrawingEditor.moodboardCallback = moodboardCallback;
        const modal = document.getElementById('drawing-modal');
        modal.style.display = 'flex';
        
        DrawingEditor.canvas = document.getElementById('drawingCanvas');
        DrawingEditor.ctx = DrawingEditor.canvas.getContext('2d');
        
        // Load existing drawing or create new
        if(shotId) {
            const shot = state.data.shots.find(s => s.id === shotId);
            if(shot && shot.drawingData) {
                DrawingEditor.layers = JSON.parse(JSON.stringify(shot.drawingData.layers));
                DrawingEditor.currentLayerIndex = shot.drawingData.currentLayer || 0;
                // Restaurer les calques depuis les donn√©es sauvegard√©es
                DrawingEditor.layers.forEach(layer => {
                    if(layer.imageData) {
                        const canvas = document.createElement('canvas');
                        canvas.width = 800;
                        canvas.height = 600;
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.onload = () => {
                            ctx.drawImage(img, 0, 0);
                            DrawingEditor.redraw();
                        };
                        img.src = layer.imageData;
                        layer.canvas = canvas;
                    } else {
                        layer.canvas = document.createElement('canvas');
                        layer.canvas.width = 800;
                        layer.canvas.height = 600;
                    }
                });
            } else {
                DrawingEditor.layers = [DrawingEditor.createNewLayer()];
                DrawingEditor.currentLayerIndex = 0;
            }
        } else {
            // Mode MoodBoard : nouveau dessin vierge
            DrawingEditor.layers = [DrawingEditor.createNewLayer()];
            DrawingEditor.currentLayerIndex = 0;
        }
        
        DrawingEditor.setupCanvas();
        DrawingEditor.renderColorPalette();
        DrawingEditor.renderLayers();
        DrawingEditor.redraw();
        DrawingEditor.saveState();
    },
    
    close: async () => {
        const shotId = DrawingEditor.currentShotId;
        const callback = DrawingEditor.moodboardCallback;
        
        if(await ConfirmModal.show({ title: 'Sauvegarder ?', message: 'Voulez-vous sauvegarder les modifications apport√©es √† ce dessin ?', icon: 'üíæ', confirmText: 'Sauvegarder' })) {
            if(callback) {
                // Mode MoodBoard : retourner l'image via callback
                const dataUrl = DrawingEditor.getCompositeImage();
                callback(dataUrl);
            } else {
                // Mode Storyboard classique
                DrawingEditor.save();
                if(Storyboard.currentEditingShotId === shotId) {
                    setTimeout(() => Storyboard.refreshEditModal(shotId), 100);
                }
            }
        }
        document.getElementById('drawing-modal').style.display = 'none';
        DrawingEditor.currentShotId = null;
        DrawingEditor.moodboardCallback = null;
        DrawingEditor.layers = [];
        DrawingEditor.history = [];
        DrawingEditor.historyStep = -1;
    },
    
    getCompositeImage: () => {
        // Cr√©er un canvas composite avec tous les calques visibles
        const composite = document.createElement('canvas');
        composite.width = 800;
        composite.height = 600;
        const ctx = composite.getContext('2d');
        
        // Fond blanc
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, composite.width, composite.height);
        
        // Superposer les calques visibles
        DrawingEditor.layers.forEach(layer => {
            if(layer.visible) {
                ctx.drawImage(layer.canvas, 0, 0);
            }
        });
        
        return composite.toDataURL('image/png');
    },
    
    setupCanvas: () => {
        DrawingEditor.canvas.addEventListener('mousedown', DrawingEditor.startDrawing);
        DrawingEditor.canvas.addEventListener('mousemove', DrawingEditor.draw);
        DrawingEditor.canvas.addEventListener('mouseup', DrawingEditor.stopDrawing);
        DrawingEditor.canvas.addEventListener('mouseout', DrawingEditor.stopDrawing);
        
        // Touch support
        DrawingEditor.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            DrawingEditor.canvas.dispatchEvent(mouseEvent);
        });
        
        DrawingEditor.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            DrawingEditor.canvas.dispatchEvent(mouseEvent);
        });
        
        DrawingEditor.canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup', {});
            DrawingEditor.canvas.dispatchEvent(mouseEvent);
        });
    },
    
    createNewLayer: () => {
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 600;
        return {
            id: Utils.generateUniqueId(),
            canvas: canvas,
            visible: true,
            name: 'Calque ' + (DrawingEditor.layers.length + 1)
        };
    },
    
    renderColorPalette: () => {
        const container = document.getElementById('colorPalette');
        container.innerHTML = '';
        
        DrawingEditor.colors.forEach(color => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch' + (DrawingEditor.currentColor === color ? ' active' : '');
            swatch.style.background = color;
            swatch.onclick = () => {
                DrawingEditor.currentColor = color;
                DrawingEditor.renderColorPalette();
            };
            container.appendChild(swatch);
        });
    },
    
    renderLayers: () => {
        const container = document.getElementById('layersList');
        container.innerHTML = '';
        
        DrawingEditor.layers.forEach((layer, idx) => {
            const item = document.createElement('div');
            item.className = 'layer-item' + (idx === DrawingEditor.currentLayerIndex ? ' active' : '');
            item.innerHTML = `
                <span class="layer-visibility" onclick="app.DrawingEditor.toggleLayerVisibility(${idx})">${layer.visible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}</span>
                <span style="flex: 1;">${layer.name}</span>
                ${DrawingEditor.layers.length > 1 ? `<button onclick="app.DrawingEditor.deleteLayer(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer;">üóëÔ∏è</button>` : ''}
            `;
            item.onclick = (e) => {
                if(!e.target.closest('button') && !e.target.closest('.layer-visibility')) {
                    DrawingEditor.currentLayerIndex = idx;
                    DrawingEditor.renderLayers();
                }
            };
            container.appendChild(item);
        });
    },
    
    startDrawing: (e) => {
        const rect = DrawingEditor.canvas.getBoundingClientRect();
        const x = Math.floor(e.clientX - rect.left);
        const y = Math.floor(e.clientY - rect.top);
        
        DrawingEditor.isDrawing = true;
        DrawingEditor.lastX = x;
        DrawingEditor.lastY = y;
    },
    
    draw: (e) => {
        if(!DrawingEditor.isDrawing) return;
        
        const rect = DrawingEditor.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const layer = DrawingEditor.layers[DrawingEditor.currentLayerIndex];
        const ctx = layer.canvas.getContext('2d');
        const tool = DrawingEditor.currentTool;
        
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // Configuration selon l'outil
        if(tool === 'eraser') {
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = DrawingEditor.brushSize;
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'destination-out';
        } else if(tool === 'pencil') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            ctx.lineWidth = Math.max(1, DrawingEditor.brushSize * 0.5);
            ctx.globalAlpha = (DrawingEditor.opacity / 100) * 0.8;
            ctx.globalCompositeOperation = 'source-over';
        } else if(tool === 'pen') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            ctx.lineWidth = Math.max(1, DrawingEditor.brushSize * 0.7);
            ctx.globalAlpha = DrawingEditor.opacity / 100;
            ctx.globalCompositeOperation = 'source-over';
        } else if(tool === 'marker') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            ctx.lineWidth = DrawingEditor.brushSize;
            ctx.globalAlpha = DrawingEditor.opacity / 100;
            ctx.globalCompositeOperation = 'source-over';
        } else if(tool === 'highlighter') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            ctx.lineWidth = DrawingEditor.brushSize * 2;
            ctx.globalAlpha = 0.3;
            ctx.globalCompositeOperation = 'multiply';
            ctx.lineCap = 'square';
        } else if(tool === 'brush') {
            ctx.strokeStyle = DrawingEditor.currentColor;
            const speed = Math.sqrt(Math.pow(x - DrawingEditor.lastX, 2) + Math.pow(y - DrawingEditor.lastY, 2));
            ctx.lineWidth = Math.max(1, DrawingEditor.brushSize * (1 + speed * 0.02));
            ctx.globalAlpha = DrawingEditor.opacity / 100;
            ctx.globalCompositeOperation = 'source-over';
        } else if(tool === 'airbrush') {
            ctx.globalAlpha = 0.1;
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = DrawingEditor.currentColor;
            for(let i = 0; i < 20; i++) {
                const offsetX = (Math.random() - 0.5) * DrawingEditor.brushSize * 2;
                const offsetY = (Math.random() - 0.5) * DrawingEditor.brushSize * 2;
                ctx.beginPath();
                ctx.arc(x + offsetX, y + offsetY, Math.random() * 2, 0, Math.PI * 2);
                ctx.fill();
            }
            DrawingEditor.lastX = x;
            DrawingEditor.lastY = y;
            DrawingEditor.redraw();
            return;
        }
        
        ctx.beginPath();
        ctx.moveTo(DrawingEditor.lastX, DrawingEditor.lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        // Reset composite operation
        ctx.globalCompositeOperation = 'source-over';
        
        DrawingEditor.lastX = x;
        DrawingEditor.lastY = y;
        
        DrawingEditor.redraw();
    },
    
    stopDrawing: () => {
        if(DrawingEditor.isDrawing) {
            DrawingEditor.isDrawing = false;
            DrawingEditor.saveState();
        }
    },
	
	redraw: () => {
        // Clear main canvas
        DrawingEditor.ctx.clearRect(0, 0, DrawingEditor.canvas.width, DrawingEditor.canvas.height);
        
        // Draw all visible layers
        DrawingEditor.layers.forEach(layer => {
            if(layer.visible) {
                DrawingEditor.ctx.drawImage(layer.canvas, 0, 0);
            }
        });
    },
    
    setTool: (tool) => {
        DrawingEditor.currentTool = tool;
        document.querySelectorAll('.drawing-sidebar .brush-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    },
    
    setBrushSize: (size) => {
        DrawingEditor.brushSize = parseInt(size);
    },
    
    setOpacity: (value) => {
        DrawingEditor.opacity = parseInt(value);
        document.getElementById('opacityValue').innerText = value + '%';
    },
    
    addLayer: () => {
        const newLayer = DrawingEditor.createNewLayer();
        DrawingEditor.layers.push(newLayer);
        DrawingEditor.currentLayerIndex = DrawingEditor.layers.length - 1;
        DrawingEditor.renderLayers();
        DrawingEditor.saveState();
    },
    
    deleteLayer: async (idx) => {
        if(DrawingEditor.layers.length === 1) {
            Utils.toast('Impossible de supprimer le dernier calque', 'warning');
            return;
        }
        
        if(await ConfirmModal.confirmDelete("Ce calque sera supprim√©.")) {
            DrawingEditor.layers.splice(idx, 1);
            if(DrawingEditor.currentLayerIndex >= DrawingEditor.layers.length) {
                DrawingEditor.currentLayerIndex = DrawingEditor.layers.length - 1;
            }
            DrawingEditor.renderLayers();
            DrawingEditor.redraw();
            DrawingEditor.saveState();
        }
    },
    
    toggleLayerVisibility: (idx) => {
        DrawingEditor.layers[idx].visible = !DrawingEditor.layers[idx].visible;
        DrawingEditor.renderLayers();
        DrawingEditor.redraw();
    },
    
    clear: async () => {
        if(!await ConfirmModal.confirmDelete("Tout le dessin sera effac√©.", "Effacer tout ?")) return;
        
        const layer = DrawingEditor.layers[DrawingEditor.currentLayerIndex];
        const ctx = layer.canvas.getContext('2d');
        ctx.clearRect(0, 0, layer.canvas.width, layer.canvas.height);
        DrawingEditor.redraw();
        DrawingEditor.saveState();
    },
    
    saveState: () => {
        // Remove future history if we're not at the end
        if(DrawingEditor.historyStep < DrawingEditor.history.length - 1) {
            DrawingEditor.history = DrawingEditor.history.slice(0, DrawingEditor.historyStep + 1);
        }
        
        // Save current state
        const state = DrawingEditor.layers.map(layer => {
            return {
                id: layer.id,
                visible: layer.visible,
                name: layer.name,
                imageData: layer.canvas.toDataURL()
            };
        });
        
        DrawingEditor.history.push(state);
        DrawingEditor.historyStep++;
        
        // Limit history to 50 steps
        if(DrawingEditor.history.length > 50) {
            DrawingEditor.history.shift();
            DrawingEditor.historyStep--;
        }
    },
    
    undo: () => {
        if(DrawingEditor.historyStep > 0) {
            DrawingEditor.historyStep--;
            DrawingEditor.restoreState(DrawingEditor.history[DrawingEditor.historyStep]);
        }
    },
    
    redo: () => {
        if(DrawingEditor.historyStep < DrawingEditor.history.length - 1) {
            DrawingEditor.historyStep++;
            DrawingEditor.restoreState(DrawingEditor.history[DrawingEditor.historyStep]);
        }
    },
    
    restoreState: (state) => {
        DrawingEditor.layers = state.map(layerState => {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.src = layerState.imageData;
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                DrawingEditor.redraw();
            };
            
            return {
                id: layerState.id,
                canvas: canvas,
                visible: layerState.visible,
                name: layerState.name
            };
        });
        
        DrawingEditor.renderLayers();
    },
    
    save: () => {
        if(!DrawingEditor.currentShotId) return;
        
        const shot = state.data.shots.find(s => s.id === DrawingEditor.currentShotId);
        if(!shot) return;
        
        // Convert layers to serializable format
        const drawingData = {
            layers: DrawingEditor.layers.map(layer => ({
                id: layer.id,
                visible: layer.visible,
                name: layer.name,
                imageData: layer.canvas.toDataURL()
            })),
            currentLayer: DrawingEditor.currentLayerIndex
        };
        
        shot.imageType = 'drawing';
        shot.drawingData = drawingData;
        shot.lastModified = Date.now();
        
        Store.save();
        Storyboard.renderShots();
        Utils.toast('Dessin sauvegard√© !', 'success');
    },
    
    saveVersion: () => {
        if(!DrawingEditor.currentShotId) return;
        
        const shot = state.data.shots.find(s => s.id === DrawingEditor.currentShotId);
        if(!shot) return;
        
        // Save current state as a version
        const drawingData = {
            layers: DrawingEditor.layers.map(layer => ({
                id: layer.id,
                visible: layer.visible,
                name: layer.name,
                imageData: layer.canvas.toDataURL()
            })),
            currentLayer: DrawingEditor.currentLayerIndex
        };
        
        if(!shot.versions) shot.versions = [];
        
        shot.versions.push({
            timestamp: Date.now(),
            data: drawingData
        });
        
        shot.imageType = 'drawing';
        shot.drawingData = drawingData;
        shot.lastModified = Date.now();
        
        Store.save();
        Storyboard.renderShots();
        Utils.toast('Version sauvegard√©e ! (' + shot.versions.length + ' versions au total)', 'success');
    },
    
    renderDrawingData: (ctx, drawingData) => {
        if(!drawingData || !drawingData.layers) return;
        
        drawingData.layers.forEach(layerData => {
            if(!layerData.visible) return;
            
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
            };
            img.src = layerData.imageData;
        });
    }
};


  // Module Import Sc√©nario (depuis l'onglet sc√©nario)
  const ScriptImport = {
      openModal: () => {
          // Cr√©er le modal d'import
          const existingModal = document.getElementById('script-import-modal');
          if(existingModal) existingModal.remove();
          
          const modal = document.createElement('div');
          modal.id = 'script-import-modal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:10002;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:12px; padding:30px; max-width:500px; width:90%;">
                  <h2 style="margin-bottom:20px;">üìÑ Importer un sc√©nario</h2>
                  <p style="color:var(--text-sec); margin-bottom:20px;">Importez un fichier PDF ou Final Draft (.fdx) pour ajouter des sc√®nes √† votre projet.</p>
                  <p style="color:orange; font-size:0.9rem; margin-bottom:20px;">‚ö†Ô∏è Attention : l'import remplacera les sc√®nes existantes.</p>
                  <div style="display:flex; flex-direction:column; gap:15px;">
                      <label style="display:flex; flex-direction:column; gap:8px; padding:20px; border:2px dashed var(--border); border-radius:8px; cursor:pointer; text-align:center; transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                          <span style="font-size:2rem;">üìÑ</span>
                          <span style="font-weight:600;">Choisir un fichier PDF ou FDX</span>
                          <span style="font-size:0.85rem; color:var(--text-sec);">Formats support√©s : .pdf, .fdx, .xml</span>
                          <input type="file" accept=".pdf,.fdx,.xml" onchange="app.ScriptImport.handleFile(event)" style="display:none;">
                      </label>
                  </div>
                  <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                      <button onclick="document.getElementById('script-import-modal').remove();" style="background:var(--border); color:var(--text-main); border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Annuler</button>
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
      },
      
      handleFile: (e) => {
          const file = e.target.files[0];
          if(!file) return;
          
          // Fermer le modal
          document.getElementById('script-import-modal')?.remove();
          
          // Utiliser le parseur existant
          if(file.name.toLowerCase().endsWith('.pdf')) {
              Importer.parsePDF(file);
          } else if(file.name.toLowerCase().endsWith('.fdx') || file.name.toLowerCase().endsWith('.xml')) {
              const reader = new FileReader();
              reader.onload = (ev) => Importer.parseFDX(ev.target.result);
              reader.readAsText(file);
          } else {
              Utils.toast("Format non support√©. Utilisez PDF ou FDX.", "error");
          }
      }
  };

  const ScriptEditor = {
      format: (sceneId, className, e) => { if(e) e.preventDefault(); const editor = document.getElementById(`editor-${sceneId}`); const sel = window.getSelection(); if (!editor.contains(sel.anchorNode)) return; const block = ScriptEditor.getBlockNode(sel.anchorNode); if(block) { if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, ''); if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, ''); block.className = className; if(className === 'sc-note') ScriptEditor.wrapNote(block); if(className === 'sc-paren') ScriptEditor.wrapParen(block); const s = state.data.scenes.find(x => x.id === sceneId); if(s) s.scriptContent = editor.innerHTML; Store.updateScene(sceneId, editor.innerHTML); ScriptEditor.updateToolbar(editor, document.getElementById(`toolbar-${sceneId}`)); } },
      handleKey: (e, editor, toolbar, sceneId) => { if(state.scriptAC.active) { if(e.key === 'ArrowDown') { e.preventDefault(); state.scriptAC.index++; ScriptEditor.highlightAC(); return; } if(e.key === 'ArrowUp') { e.preventDefault(); state.scriptAC.index--; ScriptEditor.highlightAC(); return; } if(e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); ScriptEditor.selectAC(editor); return; } if(e.key === 'Escape') { ScriptEditor.hideAC(); return; } } const sceneIndex = state.data.scenes.findIndex(s => s.id === sceneId); if(e.ctrlKey || e.metaKey) { const codeToType = { 'Digit1': 'sc-action', 'Digit2': 'sc-perso', 'Digit3': 'sc-dial', 'Digit4': 'sc-paren', 'Digit5': 'sc-trans', 'Digit6': 'sc-centered', 'Digit7': 'sc-note', 'Digit8': 'sc-note', 'Numpad1': 'sc-action', 'Numpad2': 'sc-perso', 'Numpad3': 'sc-dial', 'Numpad4': 'sc-paren', 'Numpad5': 'sc-trans', 'Numpad6': 'sc-centered', 'Numpad7': 'sc-note' }; if(codeToType[e.code]) { e.preventDefault(); e.stopPropagation(); ScriptEditor.setFormatDirect(editor, toolbar, codeToType[e.code]); return; } if(e.key === 'ArrowLeft') { e.preventDefault(); ScriptEditor.goToScene(sceneIndex - 1); return; } if(e.key === 'ArrowRight') { e.preventDefault(); ScriptEditor.goToScene(sceneIndex + 1); return; } if(e.key === 'Enter') { e.preventDefault(); ScriptEditor.insertSceneAfter(sceneIndex); return; } } if(e.key === 'Tab' && e.shiftKey) { e.preventDefault(); ScriptEditor.cycleFormatReverse(editor, toolbar); return; } if(e.key === 'Tab') { e.preventDefault(); ScriptEditor.cycleFormatSmart(editor, toolbar); return; } if(e.key === 'Enter') { e.preventDefault(); const sel = window.getSelection(); const currentBlock = ScriptEditor.getBlockNode(sel.anchorNode); if(currentBlock && (currentBlock.classList.contains('sc-note') || currentBlock.classList.contains('sc-paren'))) { let txt = currentBlock.innerText.trim(); if(currentBlock.classList.contains('sc-note')) { txt = txt.replace(/^\{\s*/, '').replace(/\s*\}$/, '').trim(); currentBlock.innerText = '{ ' + txt + ' }'; } else { txt = txt.replace(/^\(\s*/, '').replace(/\s*\)$/, '').trim(); currentBlock.innerText = '( ' + txt + ' )'; } const newBlock = document.createElement('div'); newBlock.className = currentBlock.classList.contains('sc-paren') ? 'sc-dial' : 'sc-action'; newBlock.innerHTML = '<br>'; currentBlock.after(newBlock); const range = document.createRange(); range.setStart(newBlock, 0); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); ScriptEditor.updateToolbar(editor, toolbar); return; } if(currentBlock && currentBlock.classList.contains('sc-perso')) { const name = currentBlock.innerText.trim().replace(/\(.*\)/, '').trim(); if(name.length > 1) ScriptEditor.syncCharMeta(name, sceneId); } document.execCommand('insertParagraph', false); const newSelection = window.getSelection(); const newBlock = ScriptEditor.getBlockNode(newSelection.anchorNode); const prevBlock = newBlock.previousElementSibling; if(prevBlock && newBlock) { let nextClass = 'sc-action'; if(prevBlock.classList.contains('sc-action')) nextClass = 'sc-perso'; else if(prevBlock.classList.contains('sc-perso')) nextClass = 'sc-dial'; else if(prevBlock.classList.contains('sc-dial')) nextClass = 'sc-perso'; else if(prevBlock.classList.contains('sc-paren')) nextClass = 'sc-dial'; else if(prevBlock.classList.contains('sc-trans')) nextClass = 'sc-action'; newBlock.className = nextClass; } ScriptEditor.updateToolbar(editor, toolbar); } },
      setFormatDirect: (editor, toolbar, className) => { const sel = window.getSelection(); let block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block && editor.children.length > 0) block = editor.firstElementChild; if(!block) return; if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, ''); if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, ''); block.className = className; if(className === 'sc-note') ScriptEditor.wrapNote(block); if(className === 'sc-paren') ScriptEditor.wrapParen(block); ScriptEditor.updateToolbar(editor, toolbar); const sceneId = editor.id.replace('editor-', ''); const s = state.data.scenes.find(x => x.id == sceneId); if(s) { s.scriptContent = editor.innerHTML; Store.save(); } },
      cycleFormatSmart: (editor, toolbar) => { const sel = window.getSelection(); let block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block && editor.children.length > 0) block = editor.firstElementChild; if(!block) return; if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, ''); if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, ''); const smartNext = { 'sc-action': 'sc-perso', 'sc-perso': 'sc-action', 'sc-dial': 'sc-paren', 'sc-paren': 'sc-dial', 'sc-trans': 'sc-action', 'sc-centered': 'sc-action', 'sc-note': 'sc-action', 'sc-general': 'sc-action' }; const currentType = block.className || 'sc-action'; block.className = smartNext[currentType] || 'sc-action'; if(block.className === 'sc-note') ScriptEditor.wrapNote(block); if(block.className === 'sc-paren') ScriptEditor.wrapParen(block); ScriptEditor.updateToolbar(editor, toolbar); },
      cycleFormatReverse: (editor, toolbar) => { const sel = window.getSelection(); let block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block && editor.children.length > 0) block = editor.firstElementChild; if(!block) return; if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, ''); if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, ''); const types = ['sc-action', 'sc-perso', 'sc-dial', 'sc-paren', 'sc-trans', 'sc-centered', 'sc-note']; let currentIdx = types.indexOf(block.className); if(currentIdx === -1) currentIdx = 0; let prevIdx = (currentIdx - 1 + types.length) % types.length; block.className = types[prevIdx]; if(block.className === 'sc-note') ScriptEditor.wrapNote(block); if(block.className === 'sc-paren') ScriptEditor.wrapParen(block); ScriptEditor.updateToolbar(editor, toolbar); },
      cycleFormat: (editor, toolbar) => { ScriptEditor.cycleFormatSmart(editor, toolbar); },
      wrapNote: (block) => { let txt = block.innerText.trim(); if(!txt.startsWith('{')) { block.innerText = '{ ' + txt + ' }'; ScriptEditor.placeCursorInside(block, '{', '}'); } },
      wrapParen: (block) => { let txt = block.innerText.trim(); if(!txt.startsWith('(')) { block.innerText = '( ' + txt + ' )'; ScriptEditor.placeCursorInside(block, '(', ')'); } },
      placeCursorInside: (block, openChar, closeChar) => { const text = block.innerText; const startPos = text.indexOf(openChar) + 2; const endPos = text.lastIndexOf(closeChar) - 1; if(block.firstChild) { const range = document.createRange(); const sel = window.getSelection(); try { const textNode = block.firstChild; const safeStart = Math.min(startPos, textNode.length); range.setStart(textNode, safeStart); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); } catch(e) { console.log('Cursor placement error', e); } } },
      getBlockNode: (node) => { if(!node) return null; if (node.nodeType === 1 && node.classList.contains('script-editor-box')) return node.firstElementChild || null; while (node && node.nodeName !== 'DIV' && !node.classList?.contains('script-editor-box')) node = node.parentNode; return (node && node.classList && !node.classList.contains('script-editor-box')) ? node : null; },
      updateToolbar: (editor, toolbar) => { const sel = window.getSelection(); if(!sel.rangeCount) return; let block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block && editor.children.length > 0) block = editor.firstElementChild; toolbar.querySelectorAll('.fmt-btn').forEach(b => b.classList.remove('active')); if(!block) return; const type = block.className || 'sc-action'; const btn = toolbar.querySelector(`[data-type="${type}"]`); if(btn) btn.classList.add('active'); },
      checkAC: (editor) => { const sel = window.getSelection(); const block = ScriptEditor.getBlockNode(sel.anchorNode); if(!block || !block.classList.contains('sc-perso')) { ScriptEditor.hideAC(); return; } const text = block.innerText.trim().toUpperCase(); if(text.length < 1) { ScriptEditor.hideAC(); return; } const matches = state.data.characters.filter(c => c.name.toUpperCase().startsWith(text) && c.name.toUpperCase() !== text); if(matches.length === 0) { ScriptEditor.hideAC(); return; } state.scriptAC.items = matches; state.scriptAC.active = true; state.scriptAC.index = 0; const range = sel.getRangeAt(0); const rect = range.getBoundingClientRect(); els.scriptACList.style.display = 'block'; els.scriptACList.style.top = (rect.bottom + 5) + 'px'; els.scriptACList.style.left = rect.left + 'px'; ScriptEditor.renderScriptACList(editor); },
      renderScriptACList: (editor) => { els.scriptACList.innerHTML = ''; state.scriptAC.items.forEach((m, i) => { const div = document.createElement('div'); if(i === state.scriptAC.index) div.className = 'active'; div.innerText = m.name; div.onmousedown = (e) => { e.preventDefault(); state.scriptAC.index = i; ScriptEditor.selectAC(editor); }; els.scriptACList.appendChild(div); }); },
      highlightAC: () => { if(state.scriptAC.index >= state.scriptAC.items.length) state.scriptAC.index = 0; if(state.scriptAC.index < 0) state.scriptAC.index = state.scriptAC.items.length - 1; const divs = els.scriptACList.querySelectorAll('div'); divs.forEach(d => d.classList.remove('active')); if(divs[state.scriptAC.index]) divs[state.scriptAC.index].classList.add('active'); },
      selectAC: (editor) => { if(state.scriptAC.index > -1 && state.scriptAC.items[state.scriptAC.index]) { const name = state.scriptAC.items[state.scriptAC.index].name.toUpperCase(); const sel = window.getSelection(); const block = ScriptEditor.getBlockNode(sel.anchorNode); if(block) { block.innerText = name; const range = document.createRange(); range.selectNodeContents(block); range.collapse(false); sel.removeAllRanges(); sel.addRange(range); } } ScriptEditor.hideAC(); },
      hideAC: () => { state.scriptAC.active = false; els.scriptACList.style.display = 'none'; },
      syncCharMeta: (name, sceneId) => { 
          const existsInDb = state.data.characters.find(c => c.name.toLowerCase() === name.toLowerCase()); 
          if (!existsInDb) return; 
          const scene = state.data.scenes.find(s => s.id === sceneId); 
          if(scene) { 
              const currentList = scene.perso ? scene.perso.split(';').map(s=>s.trim()) : []; 
              if(!currentList.find(n => n.toLowerCase() === name.toLowerCase())) { 
                  scene.perso = scene.perso && scene.perso.length > 0 ? scene.perso + "; " + name : name; 
                  // UPDATE VISUEL GAUCHE (Noir / Pas Gras)
                  const row = document.querySelector(`.script-row[data-id="${sceneId}"]`); 
                  if(row) { 
                      const infoCol = row.querySelector('.script-info-col');
                      if(infoCol && infoCol.children[2]) infoCol.children[2].innerText = scene.perso; 
                  } 
              } 
          } 
          Store.save(); 
      },
      
      // ========== NAVIGATION SC√àNES ==========
      goToScene: (index) => {
          if(index < 0 || index >= state.data.scenes.length) return;
          const scene = state.data.scenes[index];
          if(!scene) return;
          const row = document.querySelector(`.script-row[data-id="${scene.id}"]`);
          if(row) {
              row.scrollIntoView({ behavior: 'smooth', block: 'start' });
              // Focus sur l'√©diteur de cette sc√®ne
              setTimeout(() => {
                  const editor = document.getElementById(`editor-${scene.id}`);
                  if(editor) editor.focus();
              }, 300);
          }
      },
      
      insertSceneAfter: (index) => {
          if(state.currentRole === 'viewer') return;
          
          // Cr√©er une nouvelle sc√®ne
          const newScene = {
              id: Date.now(),
              title: 'INT. LIEU - JOUR',
              time: '1',
              resume: '',
              perso: '',
              color: '#808080',
              scriptContent: '<div class="sc-action">Description de l\'action...</div>'
          };
          
          // Ins√©rer apr√®s l'index sp√©cifi√©
          state.data.scenes.splice(index + 1, 0, newScene);
          
          // Log historique
          History.log('ADD', `Nouvelle sc√®ne ins√©r√©e apr√®s Sc.${index + 1}`);
          
          // Sauvegarder et rafra√Æchir
          Store.save();
          UI.renderScript();
          UI.renderBoard();
          
          // Scroll vers la nouvelle sc√®ne
          setTimeout(() => {
              ScriptEditor.goToScene(index + 1);
              Utils.toast(`Nouvelle sc√®ne ins√©r√©e (Sc.${index + 2})`, 'success');
          }, 100);
      },
      
      // ========== RECHERCHER / REMPLACER ==========
      searchResults: [],
      currentResultIndex: -1,
      
      openSearchReplace: () => {
          document.getElementById('search-replace-modal').style.display = 'block';
          document.getElementById('search-input').value = '';
          document.getElementById('replace-input').value = '';
          document.getElementById('search-results-info').textContent = 'Tapez pour rechercher...';
          ScriptEditor.searchResults = [];
          ScriptEditor.currentResultIndex = -1;
          ScriptEditor.clearHighlights();
          document.getElementById('search-input').focus();
      },
      
      closeSearchReplace: () => {
          document.getElementById('search-replace-modal').style.display = 'none';
          ScriptEditor.clearHighlights();
      },
      
      searchInScript: () => {
          const query = document.getElementById('search-input').value;
          const caseSensitive = document.getElementById('search-case-sensitive').checked;
          const wholeWord = document.getElementById('search-whole-word').checked;
          
          ScriptEditor.clearHighlights();
          ScriptEditor.searchResults = [];
          ScriptEditor.currentResultIndex = -1;
          
          if(query.length < 1) {
              document.getElementById('search-results-info').textContent = 'Tapez pour rechercher...';
              return;
          }
          
          // Chercher dans tous les √©diteurs de sc√®ne
          const editors = document.querySelectorAll('.script-editor-box');
          
          editors.forEach(editor => {
              const sceneId = editor.id.replace('editor-', '');
              ScriptEditor.findInElement(editor, query, caseSensitive, wholeWord, sceneId);
          });
          
          const count = ScriptEditor.searchResults.length;
          document.getElementById('search-results-info').textContent = count > 0 
              ? `${count} r√©sultat(s) trouv√©(s)` 
              : 'Aucun r√©sultat';
          
          if(count > 0) {
              ScriptEditor.currentResultIndex = 0;
              ScriptEditor.highlightCurrentResult();
          }
      },
      
      findInElement: (element, query, caseSensitive, wholeWord, sceneId) => {
          const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
          let node;
          
          while(node = walker.nextNode()) {
              let text = node.textContent;
              let searchText = caseSensitive ? text : text.toLowerCase();
              let searchQuery = caseSensitive ? query : query.toLowerCase();
              
              let index = 0;
              while((index = searchText.indexOf(searchQuery, index)) !== -1) {
                  // V√©rifier mot entier si n√©cessaire
                  if(wholeWord) {
                      const before = index > 0 ? searchText[index - 1] : ' ';
                      const after = index + searchQuery.length < searchText.length ? searchText[index + searchQuery.length] : ' ';
                      if(/\w/.test(before) || /\w/.test(after)) {
                          index++;
                          continue;
                      }
                  }
                  
                  ScriptEditor.searchResults.push({
                      node: node,
                      index: index,
                      length: query.length,
                      sceneId: sceneId
                  });
                  index++;
              }
          }
      },
      
      highlightCurrentResult: () => {
          ScriptEditor.clearHighlights();
          
          if(ScriptEditor.searchResults.length === 0) return;
          
          const result = ScriptEditor.searchResults[ScriptEditor.currentResultIndex];
          if(!result) return;
          
          // Cr√©er le highlight
          const range = document.createRange();
          range.setStart(result.node, result.index);
          range.setEnd(result.node, result.index + result.length);
          
          const highlight = document.createElement('span');
          highlight.className = 'search-highlight current';
          highlight.style.cssText = 'background: #fbbf24; color: #000; padding: 1px 2px; border-radius: 2px;';
          
          try {
              range.surroundContents(highlight);
              highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } catch(e) {
              console.log('Erreur highlight:', e);
          }
          
          // Mettre √† jour l'info
          document.getElementById('search-results-info').textContent = 
              `R√©sultat ${ScriptEditor.currentResultIndex + 1} / ${ScriptEditor.searchResults.length}`;
      },
      
      clearHighlights: () => {
          document.querySelectorAll('.search-highlight').forEach(el => {
              const parent = el.parentNode;
              while(el.firstChild) {
                  parent.insertBefore(el.firstChild, el);
              }
              parent.removeChild(el);
              parent.normalize();
          });
      },
      
      searchNext: () => {
          if(ScriptEditor.searchResults.length === 0) {
              ScriptEditor.searchInScript();
              if(ScriptEditor.searchResults.length === 0) return;
          }
          ScriptEditor.clearHighlights();
          const savedIndex = ScriptEditor.currentResultIndex;
          ScriptEditor.searchInScript();
          ScriptEditor.currentResultIndex = (savedIndex + 1) % ScriptEditor.searchResults.length;
          ScriptEditor.highlightCurrentResult();
      },
      
      searchPrev: () => {
          if(ScriptEditor.searchResults.length === 0) {
              ScriptEditor.searchInScript();
              if(ScriptEditor.searchResults.length === 0) return;
          }
          ScriptEditor.clearHighlights();
          const savedIndex = ScriptEditor.currentResultIndex;
          ScriptEditor.searchInScript();
          ScriptEditor.currentResultIndex = savedIndex - 1;
          if(ScriptEditor.currentResultIndex < 0) ScriptEditor.currentResultIndex = ScriptEditor.searchResults.length - 1;
          ScriptEditor.highlightCurrentResult();
      },
      
      replaceOne: () => {
          if(ScriptEditor.searchResults.length === 0) return;
          
          const replaceText = document.getElementById('replace-input').value;
          const highlight = document.querySelector('.search-highlight.current');
          
          if(highlight) {
              const sceneId = highlight.closest('.script-editor-box')?.id.replace('editor-', '');
              highlight.replaceWith(document.createTextNode(replaceText));
              
              // Sauvegarder la sc√®ne
              if(sceneId) {
                  const editor = document.getElementById('editor-' + sceneId);
                  const scene = state.data.scenes.find(s => String(s.id) === String(sceneId));
                  if(scene && editor) {
                      scene.scriptContent = editor.innerHTML;
                      Store.save();
                  }
              }
              
              // Passer au suivant
              ScriptEditor.searchInScript();
              if(ScriptEditor.searchResults.length > 0) {
                  ScriptEditor.highlightCurrentResult();
              }
          }
      },
      
      replaceAll: () => {
          const query = document.getElementById('search-input').value;
          const replaceText = document.getElementById('replace-input').value;
          const caseSensitive = document.getElementById('search-case-sensitive').checked;
          const wholeWord = document.getElementById('search-whole-word').checked;
          
          if(query.length < 1) return;
          
          // Sauvegarder avant remplacement
          ScriptEditor.saveBackup();
          
          let totalReplaced = 0;
          
          // Remplacer dans chaque sc√®ne
          state.data.scenes.forEach(scene => {
              if(!scene.scriptContent) return;
              
              let content = scene.scriptContent;
              let flags = caseSensitive ? 'g' : 'gi';
              let pattern = wholeWord ? `\\b${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b` : query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              
              const regex = new RegExp(pattern, flags);
              const matches = content.match(regex);
              
              if(matches) {
                  totalReplaced += matches.length;
                  scene.scriptContent = content.replace(regex, replaceText);
              }
          });
          
          Store.save();
          UI.renderScript();
          
          document.getElementById('search-results-info').textContent = `‚úÖ ${totalReplaced} remplacement(s) effectu√©(s)`;
          ScriptEditor.searchResults = [];
          ScriptEditor.currentResultIndex = -1;
          
          // Afficher le bouton annuler
          if(totalReplaced > 0) {
              document.getElementById('undo-replace-btn').style.display = 'block';
          }
          
          Utils.toast(`${totalReplaced} remplacement(s) effectu√©(s)`, 'success');
      },
      
      // Sauvegarde pour annulation
      backupScripts: null,
      
      saveBackup: () => {
          ScriptEditor.backupScripts = state.data.scenes.map(s => ({
              id: s.id,
              scriptContent: s.scriptContent
          }));
      },
      
      undoReplace: () => {
          if(!ScriptEditor.backupScripts) {
              Utils.toast('Aucun remplacement √† annuler', 'error');
              return;
          }
          
          // Restaurer le contenu
          ScriptEditor.backupScripts.forEach(backup => {
              const scene = state.data.scenes.find(s => String(s.id) === String(backup.id));
              if(scene) {
                  scene.scriptContent = backup.scriptContent;
              }
          });
          
          Store.save();
          UI.renderScript();
          
          ScriptEditor.backupScripts = null;
          document.getElementById('undo-replace-btn').style.display = 'none';
          document.getElementById('search-results-info').textContent = '‚Ü©Ô∏è Remplacement annul√©';
          
          Utils.toast('Remplacement annul√©', 'success');
      },
      
      // Drag de la fen√™tre
      initDrag: () => {
          const modal = document.getElementById('search-replace-modal');
          const header = document.getElementById('search-replace-header');
          let isDragging = false;
          let offsetX, offsetY;
          
          header.addEventListener('mousedown', (e) => {
              if(e.target.tagName === 'BUTTON') return;
              isDragging = true;
              offsetX = e.clientX - modal.offsetLeft;
              offsetY = e.clientY - modal.offsetTop;
              modal.style.transition = 'none';
          });
          
          document.addEventListener('mousemove', (e) => {
              if(!isDragging) return;
              let newX = e.clientX - offsetX;
              let newY = e.clientY - offsetY;
              
              // Limites de l'√©cran
              newX = Math.max(0, Math.min(newX, window.innerWidth - modal.offsetWidth));
              newY = Math.max(0, Math.min(newY, window.innerHeight - modal.offsetHeight));
              
              modal.style.left = newX + 'px';
              modal.style.top = newY + 'px';
              modal.style.right = 'auto';
          });
          
          document.addEventListener('mouseup', () => {
              isDragging = false;
              modal.style.transition = '';
          });
      },
      
      // ========== VUE SCRIPT CONTINU ==========
      viewMode: 'continuous', // 'scenes' ou 'continuous' - Vue Script par d√©faut
      activeSceneId: null,
      
      initViewMode: () => {
          // Charger la pr√©f√©rence sauvegard√©e ou utiliser 'continuous' par d√©faut
          try {
              const saved = localStorage.getItem('fmp_script_view_mode');
              if(saved) ScriptEditor.viewMode = saved;
          } catch(e) {}
          ScriptEditor.setViewMode(ScriptEditor.viewMode);
      },
      
      setViewMode: (mode) => {
          ScriptEditor.viewMode = mode;
          
          // Sauvegarder la pr√©f√©rence
          try { localStorage.setItem('fmp_script_view_mode', mode); } catch(e) {}
          
          // Update toggle buttons
          document.getElementById('script-view-scenes').classList.toggle('active', mode === 'scenes');
          document.getElementById('script-view-continuous').classList.toggle('active', mode === 'continuous');
          
          // Show/hide containers
          document.getElementById('scriptContainer').style.display = mode === 'scenes' ? 'block' : 'none';
          document.getElementById('scriptContinuousContainer').style.display = mode === 'continuous' ? 'flex' : 'none';
          
          if(mode === 'continuous') {
              ScriptEditor.renderContinuous();
          }
      },
      
      renderContinuous: () => {
          const editor = document.getElementById('scriptContinuousEditor');
          const sidebar = document.getElementById('scriptContinuousSidebar');
          if(!editor || !sidebar) return;
          
          editor.innerHTML = '';
          
          if(state.data.scenes.length === 0) {
              editor.innerHTML = '<div style="text-align:center;padding:50px;color:var(--text-sec)">Ajoutez des sc√®nes pour commencer.</div>';
              sidebar.innerHTML = '';
              return;
          }
          
          const isView = state.currentRole === 'viewer' || !Permissions.canEdit('scenario');
          
          // Cr√©er un conteneur pour chaque sc√®ne dans l'√©diteur continu
          state.data.scenes.forEach((scene, idx) => {
              const sceneDiv = document.createElement('div');
              sceneDiv.className = 'script-continuous-scene';
              sceneDiv.dataset.sceneId = scene.id;
              sceneDiv.dataset.sceneIndex = idx;
              
              // Heading de la sc√®ne (draggable + titre √©ditable)
              const heading = document.createElement('div');
              heading.className = 'script-continuous-heading';
              heading.draggable = true;
              heading.innerHTML = `<span class="script-continuous-scene-number">#${idx + 1}</span><span class="scene-title-text" data-scene-id="${scene.id}">${Utils.escape(scene.title)}</span>`;
              
              // Drag depuis le heading
              heading.addEventListener('dragstart', (e) => {
                  ScriptEditor.draggedSceneId = scene.id;
                  e.dataTransfer.effectAllowed = 'move';
                  heading.style.opacity = '0.5';
              });
              heading.addEventListener('dragend', () => {
                  heading.style.opacity = '1';
                  ScriptEditor.draggedSceneId = null;
                  document.querySelectorAll('.script-continuous-scene.drag-over').forEach(el => el.classList.remove('drag-over'));
              });
              
              // Clic sur le titre pour l'√©diter
              const titleSpan = heading.querySelector('.scene-title-text');
              titleSpan.addEventListener('click', (e) => {
                  e.stopPropagation();
                  ScriptEditor.editSceneTitle(scene.id, titleSpan);
              });
              
              sceneDiv.appendChild(heading);
              
              // Contenu de la sc√®ne
              const content = document.createElement('div');
              content.className = 'script-continuous-content';
              content.contentEditable = !isView;
              content.spellcheck = true;
              content.lang = 'fr';
              content.innerHTML = scene.scriptContent || "<div class='sc-action'><br></div>";
              
              // Events
              if(!isView) {
                  content.addEventListener('input', () => {
                      const s = state.data.scenes.find(x => x.id === scene.id);
                      if(s) s.scriptContent = content.innerHTML;
                      Store.updateScene(scene.id, content.innerHTML);
                  });
                  
                  content.addEventListener('focus', () => {
                      // Ne changer la sc√®ne active que si on clique vraiment dedans
                      if(ScriptEditor.activeSceneId !== scene.id) {
                          ScriptEditor.activeSceneId = scene.id;
                          ScriptEditor.updateContinuousSidebar(scene.id, idx);
                          document.querySelectorAll('.script-continuous-scene').forEach(s => {
                              s.classList.toggle('active', s.dataset.sceneId == scene.id);
                          });
                      }
                      Store.acquireLock(scene.id);
                  });
                  
                  content.addEventListener('blur', () => {
                      Store.releaseLock(scene.id);
                  });
                  
                  content.addEventListener('keydown', (e) => {
                      ScriptEditor.handleKeyContinuous(e, content, scene.id);
                  });
                  
                  content.addEventListener('click', () => {
                      ScriptEditor.updateToolbarContinuous();
                      ScriptEditor.saveSelection();
                  });
                  
                  content.addEventListener('mouseup', () => {
                      ScriptEditor.updateToolbarContinuous();
                  });
                  
                  content.addEventListener('keyup', (e) => {
                      if(e.key === 'Shift') {
                          content.focus();
                      }
                  });
              }
              
              // √âv√©nements drag & drop pour r√©ordonner
              sceneDiv.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  if(ScriptEditor.draggedSceneId && ScriptEditor.draggedSceneId !== scene.id) {
                      sceneDiv.classList.add('drag-over');
                  }
              });
              
              sceneDiv.addEventListener('dragleave', () => {
                  sceneDiv.classList.remove('drag-over');
              });
              
              sceneDiv.addEventListener('drop', (e) => {
                  e.preventDefault();
                  sceneDiv.classList.remove('drag-over');
                  if(ScriptEditor.draggedSceneId && ScriptEditor.draggedSceneId !== scene.id) {
                      ScriptEditor.reorderSceneContinuous(ScriptEditor.draggedSceneId, scene.id);
                  }
              });
              
              sceneDiv.appendChild(content);
              editor.appendChild(sceneDiv);
          });
          
          // Initialiser avec la premi√®re sc√®ne
          if(state.data.scenes.length > 0) {
              ScriptEditor.setActiveScene(state.data.scenes[0].id, 0);
          }
      },
      
      setActiveScene: (sceneId, index) => {
          if(ScriptEditor.activeSceneId === sceneId) return;
          ScriptEditor.activeSceneId = sceneId;
          
          // Highlight la sc√®ne active
          document.querySelectorAll('.script-continuous-scene').forEach(s => {
              s.classList.toggle('active', s.dataset.sceneId === sceneId);
          });
          
          // Mettre √† jour la sidebar
          ScriptEditor.updateContinuousSidebar(sceneId, index);
      },
      
      updateContinuousSidebar: (sceneId, index) => {
          const sidebar = document.getElementById('scriptContinuousSidebar');
          if(!sidebar) return;
          
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          
          const idx = index !== undefined ? index : state.data.scenes.findIndex(s => s.id === sceneId);
          const tag = state.data.tags.find(t => t.id === scene.tag_id) || {name:'', color: 'transparent'};
          const infoStyle = tag.color !== 'transparent' ? `border-left-color:${tag.color}` : '';
          const badge = tag.color !== 'transparent' ? `<span class="tag-badge" style="background:${tag.color}" title="${Utils.escape(tag.name)}"></span>` : '';
          
          const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
          const versionCount = scene.versions ? scene.versions.length : 0;
          const sceneStatus = scene.status || 'not-verified';
          const statusLabels = { 'not-verified': 'üî¥', 'to-work': 'üü°', 'verified': 'üü¢' };
          const statusBadge = `<span class="scene-status-badge ${sceneStatus}" onclick="app.UI.toggleSceneStatus('${scene.id}', event)">${statusLabels[sceneStatus]}</span>`;
          const isView = state.currentRole === 'viewer';
          const isFinal = scene.isFinal === true;
          const finalBadge = isFinal ? `<span class="scene-status-badge final">‚úÖ Finale</span>` : `<span class="scene-status-badge draft">üìù Brouillon</span>`;
          const finalizeBtn = isView ? '' : (isFinal 
              ? `<button class="unfinalize-btn" onclick="app.Actions.unfinalizeScene('${scene.id}')" style="width:100%;">üìù Repasser en brouillon</button>`
              : `<button class="finalize-btn" onclick="app.Actions.finalizeScene('${scene.id}')" style="width:100%;">‚úÖ Finaliser cette sc√®ne</button>`);
          
          sidebar.innerHTML = `
              <div class="script-info-col" style="${infoStyle}" draggable="true" 
                   ondragstart="app.ScriptEditor.handleSidebarDragStart(event, '${scene.id}')"
                   ondragend="app.ScriptEditor.handleSidebarDragEnd(event)">
                  <h3 style="cursor:move; display:flex; align-items:center; flex-wrap:wrap; gap:8px;">
                      ${badge}${Utils.escape(scene.title)}
                      <div style="margin-left:auto;">${statusBadge}</div>
                  </h3>
                  <div style="margin-bottom:10px;font-size:0.8em">#${idx+1} / ${state.data.scenes.length} ‚Ä¢ ${Utils.escape(scene.time)} min</div>
                  <div style="margin-bottom:10px; font-size:0.85rem; color:var(--text-main);">${Utils.escape(scene.perso) || '-'}</div>
                  <strong>R√©sum√©:</strong>
                  <p style="margin-top:5px;">${Utils.escape(scene.resume) || '-'}</p>
                  
                  <div class="script-sidebar-btns">
                      <button onclick="app.StoryboardPreview.open('${scene.id}')">üì∑ Storyboard (${shotCount})</button>
                      <button onclick="app.Comments.open('${scene.id}')">üí¨ Commentaires</button>
                      <hr style="border:none; border-top:1px solid var(--border); margin:8px 0;">
                      <button onclick="app.SceneVersions.save('${scene.id}')">üì∏ Sauvegarder version</button>
                      <button onclick="app.SceneVersions.openModal('${scene.id}')">üìú Historique${versionCount > 0 ? ' (' + versionCount + ')' : ''}</button>
                      <hr style="border:none; border-top:1px solid var(--border); margin:8px 0;">
                      <div style="text-align:center; margin-bottom:5px;">${finalBadge}</div>
                      ${finalizeBtn}
                      <hr style="border:none; border-top:1px solid var(--border); margin:8px 0;">
                      <button onclick="app.ScriptEditor.goToSceneContinuous(${idx - 1})">‚¨ÖÔ∏è Sc√®ne pr√©c√©dente</button>
                      <button onclick="app.ScriptEditor.goToSceneContinuous(${idx + 1})">‚û°Ô∏è Sc√®ne suivante</button>
                  </div>
              </div>
          `;
      },
      
      goToSceneContinuous: (index) => {
          if(index < 0 || index >= state.data.scenes.length) {
              Utils.toast(index < 0 ? 'Premi√®re sc√®ne atteinte' : 'Derni√®re sc√®ne atteinte', 'info');
              return;
          }
          const scene = state.data.scenes[index];
          ScriptEditor.scrollToSceneInContinuous(scene.id);
          // Mettre √† jour la sidebar avec la nouvelle sc√®ne
          ScriptEditor.setActiveScene(scene.id, index);
      },
      
      scrollToSceneInContinuous: (sceneId) => {
          const sceneDiv = document.querySelector(`.script-continuous-scene[data-scene-id="${sceneId}"]`);
          if(sceneDiv) {
              sceneDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
              const content = sceneDiv.querySelector('.script-continuous-content');
              if(content) {
                  setTimeout(() => content.focus(), 300);
              }
          }
      },
      
      // Timestamps pour d√©tecter double-tap
      lastEnterTime: 0,
      lastTabTime: 0,
      doubleTapDelay: 300,
      
      // V√©rifie si le bloc est vide (juste des espaces, <br>, ou rien)
      isBlockEmpty: (block) => {
          if(!block) return true;
          const text = block.innerText.replace(/[\s\u00A0]/g, '').replace(/[{}()]/g, '');
          return text.length === 0;
      },
      
      // Change le type du bloc actuel sans cr√©er de nouvelle ligne
      changeBlockType: (block, newType) => {
          if(!block) return;
          // Nettoyer les caract√®res sp√©ciaux des notes/parenth√®ses
          if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, '').trim();
          if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, '').trim();
          block.className = newType;
          if(newType === 'sc-note') ScriptEditor.wrapNote(block);
          if(newType === 'sc-paren') ScriptEditor.wrapParen(block);
      },
      
      handleKeyContinuous: (e, content, sceneId) => {
          const toolbar = document.getElementById('continuous-toolbar');
          const sel = window.getSelection();
          const currentBlock = ScriptEditor.getBlockNode(sel.anchorNode);
          const currentType = currentBlock?.className || 'sc-action';
          const isEmpty = ScriptEditor.isBlockEmpty(currentBlock);
          const now = Date.now();
          
          // Ignorer Shift seul (√©viter perte de focus)
          if(e.key === 'Shift') {
              e.preventDefault();
              e.stopPropagation();
              return;
          }
          
          // Raccourcis Ctrl+1-6 ou Alt+1-6 pour types directs
          if(e.ctrlKey || e.metaKey || e.altKey) {
              const codeToType = { 'Digit1': 'sc-action', 'Digit2': 'sc-perso', 'Digit3': 'sc-dial', 'Digit4': 'sc-paren', 'Digit5': 'sc-trans', 'Digit6': 'sc-centered', 'Digit7': 'sc-note', 'Numpad1': 'sc-action', 'Numpad2': 'sc-perso', 'Numpad3': 'sc-dial', 'Numpad4': 'sc-paren', 'Numpad5': 'sc-trans', 'Numpad6': 'sc-centered', 'Numpad7': 'sc-note' };
              if(codeToType[e.code]) { e.preventDefault(); e.stopPropagation(); ScriptEditor.setFormatDirectContinuous(content, codeToType[e.code]); return; }
          }
          
          // === SHIFT+TAB (cycle inverse) ===
          if(e.key === 'Tab' && e.shiftKey) {
              e.preventDefault();
              e.stopPropagation();
              let prevType = 'sc-action';
              if(currentType === 'sc-action') prevType = 'sc-note';
              else if(currentType === 'sc-perso') prevType = 'sc-action';
              else if(currentType === 'sc-dial') prevType = 'sc-perso';
              else if(currentType === 'sc-paren') prevType = 'sc-dial';
              else if(currentType === 'sc-trans') prevType = 'sc-paren';
              else if(currentType === 'sc-centered') prevType = 'sc-trans';
              else if(currentType === 'sc-note') prevType = 'sc-centered';
              ScriptEditor.changeBlockType(currentBlock, prevType);
              ScriptEditor.updateToolbarContinuous();
              return;
          }
          
          // === TAB ===
          if(e.key === 'Tab') {
              e.preventDefault();
              e.stopPropagation();
              
              // Double Tab ‚Üí Note
              if(now - ScriptEditor.lastTabTime < ScriptEditor.doubleTapDelay) {
                  ScriptEditor.changeBlockType(currentBlock, 'sc-note');
                  ScriptEditor.lastTabTime = 0;
                  ScriptEditor.updateToolbarContinuous();
                  return;
              }
              ScriptEditor.lastTabTime = now;
              
              // Tab simple : toggle selon le type (change le bloc actuel, jamais de nouvelle ligne)
              let nextType = 'sc-action';
              if(currentType === 'sc-action') nextType = 'sc-perso';
              else if(currentType === 'sc-perso') nextType = 'sc-paren';
              else if(currentType === 'sc-dial') nextType = 'sc-perso';
              else if(currentType === 'sc-paren') nextType = 'sc-dial';
              else if(currentType === 'sc-trans') nextType = 'sc-action';
              else if(currentType === 'sc-note') nextType = 'sc-action';
              else if(currentType === 'sc-centered') nextType = 'sc-action';
              
              ScriptEditor.changeBlockType(currentBlock, nextType);
              ScriptEditor.updateToolbarContinuous();
              return;
          }
          
          // === ENTER ===
          if(e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              e.stopPropagation();
              
              // Sync perso si besoin
              if(currentBlock && currentBlock.classList.contains('sc-perso')) {
                  const name = currentBlock.innerText.trim().replace(/\(.*\)/, '').trim();
                  if(name.length > 1) ScriptEditor.syncCharMeta(name, sceneId);
              }
              
              // Double Enter ?
              const isDoubleEnter = (now - ScriptEditor.lastEnterTime < ScriptEditor.doubleTapDelay);
              ScriptEditor.lastEnterTime = now;
              
              if(isDoubleEnter) {
                  // Double Enter : change le type du bloc actuel (pas de nouvelle ligne)
                  if(currentType === 'sc-action') {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-trans');
                      ScriptEditor.updateToolbarContinuous();
                      return;
                  } else if(currentType === 'sc-dial' || currentType === 'sc-paren') {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-action');
                      ScriptEditor.updateToolbarContinuous();
                      return;
                  }
              }
              
              // Enter simple - logique selon si la ligne est vide ou non
              
              if(currentType === 'sc-action') {
                  // Action + Enter = si vide: reste Action, si rempli: nouveau paragraphe Action
                  if(isEmpty) {
                      // Ligne vide : on ne fait rien (reste sur Action)
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-action';
                  }
              } else if(currentType === 'sc-perso') {
                  // Perso + Enter = si vide: change en Dialogue, si rempli: nouvelle ligne Dialogue
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-dial');
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-dial';
                  }
              } else if(currentType === 'sc-dial') {
                  // Dialogue + Enter = si vide: change en Perso, si rempli: nouvelle ligne Perso
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-perso');
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-perso';
                  }
              } else if(currentType === 'sc-paren') {
                  // Didas + Enter = si vide: change en Dial, si rempli: nouvelle ligne Dial
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-dial');
                  } else {
                      // Nettoyer le texte et fermer proprement les parenth√®ses
                      let txt = currentBlock.innerText.trim();
                      txt = txt.replace(/^\(\s*/, '').replace(/\s*\)$/, '').trim();
                      currentBlock.innerText = '( ' + txt + ' )';
                      // Cr√©er nouvelle ligne Dial
                      const newBlock = document.createElement('div');
                      newBlock.className = 'sc-dial';
                      newBlock.innerHTML = '<br>';
                      currentBlock.after(newBlock);
                      const range = document.createRange();
                      range.setStart(newBlock, 0);
                      range.collapse(true);
                      sel.removeAllRanges();
                      sel.addRange(range);
                  }
              } else if(currentType === 'sc-trans') {
                  // Trans + Enter = si vide: change en Action, si rempli: nouvelle ligne Action
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-action');
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-action';
                  }
              } else if(currentType === 'sc-note') {
                  // Note + Enter = si vide: change en Action, si rempli: nouvelle ligne Action
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-action');
                  } else {
                      let txt = currentBlock.innerText.trim();
                      txt = txt.replace(/^\{\s*/, '').replace(/\s*\}$/, '').trim();
                      currentBlock.innerText = '{ ' + txt + ' }';
                      const newBlock = document.createElement('div');
                      newBlock.className = 'sc-action';
                      newBlock.innerHTML = '<br>';
                      currentBlock.after(newBlock);
                      const range = document.createRange();
                      range.setStart(newBlock, 0);
                      range.collapse(true);
                      sel.removeAllRanges();
                      sel.addRange(range);
                  }
              } else if(currentType === 'sc-centered') {
                  // Centr√© + Enter = si vide: change en Action, si rempli: nouvelle ligne Action
                  if(isEmpty) {
                      ScriptEditor.changeBlockType(currentBlock, 'sc-action');
                  } else {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-action';
                  }
              } else {
                  // D√©faut
                  if(!isEmpty) {
                      document.execCommand('insertParagraph', false);
                      const newBlock = ScriptEditor.getBlockNode(window.getSelection().anchorNode);
                      if(newBlock) newBlock.className = 'sc-action';
                  }
              }
              
              ScriptEditor.updateToolbarContinuous();
          }
      },
      
      setFormatDirectContinuous: (content, className) => {
          const sel = window.getSelection();
          let block = ScriptEditor.getBlockNode(sel.anchorNode);
          if(!block && content.children.length > 0) block = content.firstElementChild;
          if(!block) return;
          if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, '');
          if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, '');
          block.className = className;
          if(className === 'sc-note') ScriptEditor.wrapNote(block);
          if(className === 'sc-paren') ScriptEditor.wrapParen(block);
          ScriptEditor.updateToolbarContinuous();
      },
      
      // Les fonctions cycleFormat ne sont plus utilis√©es - la logique est dans handleKeyContinuous
      cycleFormatSmartContinuous: (content) => { /* deprecated */ },
      
      cycleFormatReverseContinuous: (content) => {
          const sel = window.getSelection();
          let block = ScriptEditor.getBlockNode(sel.anchorNode);
          if(!block && content.children.length > 0) block = content.firstElementChild;
          if(!block) return;
          if(block.classList.contains('sc-note')) block.innerText = block.innerText.replace(/^\{\s*/, '').replace(/\s*\}$/, '');
          if(block.classList.contains('sc-paren')) block.innerText = block.innerText.replace(/^\(\s*/, '').replace(/\s*\)$/, '');
          const types = ['sc-action', 'sc-perso', 'sc-dial', 'sc-paren', 'sc-trans', 'sc-centered', 'sc-note'];
          let currentIdx = types.indexOf(block.className);
          if(currentIdx === -1) currentIdx = 0;
          block.className = types[(currentIdx - 1 + types.length) % types.length];
          if(block.className === 'sc-note') ScriptEditor.wrapNote(block);
          if(block.className === 'sc-paren') ScriptEditor.wrapParen(block);
          ScriptEditor.updateToolbarContinuous();
      },
      
      cycleFormatContinuous: (content) => {
          ScriptEditor.cycleFormatSmartContinuous(content);
      },
      
      // Sauvegarder la s√©lection pour les boutons
      savedSelection: null,
      
      saveSelection: () => {
          const sel = window.getSelection();
          if(sel.rangeCount > 0) {
              ScriptEditor.savedSelection = sel.getRangeAt(0).cloneRange();
          }
      },
      
      restoreSelection: () => {
          if(ScriptEditor.savedSelection) {
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(ScriptEditor.savedSelection);
          }
      },
      
      formatContinuous: (className, e) => {
          if(e) e.preventDefault();
          
          // Restaurer la s√©lection si elle a √©t√© perdue
          if(ScriptEditor.savedSelection) {
              ScriptEditor.restoreSelection();
          }
          
          const sel = window.getSelection();
          
          // D√©tecter si on est en Vue Sc√®nes ou Vue Script
          const isContinuousView = document.getElementById('scriptContinuousContainer')?.style.display !== 'none';
          
          if(isContinuousView) {
              // === VUE SCRIPT ===
              const activeScene = document.querySelector('.script-continuous-scene.active');
              if(!activeScene) {
                  Utils.toast('Cliquez d\'abord dans une sc√®ne', 'warning');
                  return;
              }
              
              const content = activeScene.querySelector('.script-continuous-content');
              if(!content) return;
              
              if(!sel.anchorNode || !content.contains(sel.anchorNode)) {
                  if(content.firstElementChild) {
                      const range = document.createRange();
                      range.selectNodeContents(content.firstElementChild);
                      range.collapse(true);
                      sel.removeAllRanges();
                      sel.addRange(range);
                  } else {
                      return;
                  }
              }
              
              const block = ScriptEditor.getBlockNode(sel.anchorNode);
              if(block) {
                  ScriptEditor.changeBlockType(block, className);
                  
                  const sceneId = activeScene.dataset.sceneId;
                  const scene = state.data.scenes.find(x => x.id === sceneId);
                  if(scene) {
                      scene.scriptContent = content.innerHTML;
                      Store.updateScene(sceneId, content.innerHTML);
                  }
                  
                  ScriptEditor.updateToolbarContinuous();
                  content.focus();
              }
          } else {
              // === VUE SC√àNES ===
              // Trouver l'√©diteur actif (celui qui a le focus ou la s√©lection)
              const editors = document.querySelectorAll('.script-editor-box');
              let activeEditor = null;
              let activeSceneId = null;
              
              for(const editor of editors) {
                  if(sel.anchorNode && editor.contains(sel.anchorNode)) {
                      activeEditor = editor;
                      activeSceneId = editor.id.replace('editor-', '');
                      break;
                  }
              }
              
              if(!activeEditor) {
                  Utils.toast('Cliquez d\'abord dans une sc√®ne', 'warning');
                  return;
              }
              
              const block = ScriptEditor.getBlockNode(sel.anchorNode);
              if(block) {
                  ScriptEditor.changeBlockType(block, className);
                  
                  const scene = state.data.scenes.find(x => x.id == activeSceneId);
                  if(scene) {
                      scene.scriptContent = activeEditor.innerHTML;
                      Store.updateScene(activeSceneId, activeEditor.innerHTML);
                  }
                  
                  ScriptEditor.updateToolbarContinuous();
                  activeEditor.focus();
              }
          }
      },
      
      updateToolbarContinuous: () => {
          const toolbar = document.getElementById('continuous-toolbar');
          if(!toolbar) return;
          
          const sel = window.getSelection();
          if(!sel.rangeCount) return;
          
          const block = ScriptEditor.getBlockNode(sel.anchorNode);
          toolbar.querySelectorAll('.fmt-btn').forEach(b => b.classList.remove('active'));
          
          if(!block) return;
          const type = block.className || 'sc-action';
          const btn = toolbar.querySelector(`[data-type="${type}"]`);
          if(btn) btn.classList.add('active');
      },
      
      // √âditer le titre d'une sc√®ne avec 3 champs s√©par√©s
      editSceneTitle: (sceneId, element) => {
          const scene = state.data.scenes.find(s => s.id === sceneId);
          if(!scene) return;
          
          const currentTitle = scene.title || 'INT. LIEU - JOUR';
          
          // Parser le titre existant : "INT. LIEU - JOUR" ou "EXT. LIEU - NUIT"
          const match = currentTitle.match(/^(INT\.|EXT\.)\s*(.+?)\s*-\s*(JOUR|NUIT|AUBE|CR√âPUSCULE|MATIN|SOIR)$/i);
          let intExt = 'INT.';
          let lieu = 'LIEU';
          let moment = 'JOUR';
          
          if(match) {
              intExt = match[1].toUpperCase();
              lieu = match[2].toUpperCase();
              moment = match[3].toUpperCase();
          } else {
              // Essayer de parser autrement
              const parts = currentTitle.split(/[-‚Äì]/);
              if(parts.length >= 2) {
                  const firstPart = parts[0].trim();
                  moment = parts[parts.length - 1].trim().toUpperCase();
                  if(firstPart.toUpperCase().startsWith('INT')) {
                      intExt = 'INT.';
                      lieu = firstPart.replace(/^INT\.?\s*/i, '').toUpperCase();
                  } else if(firstPart.toUpperCase().startsWith('EXT')) {
                      intExt = 'EXT.';
                      lieu = firstPart.replace(/^EXT\.?\s*/i, '').toUpperCase();
                  } else {
                      lieu = firstPart.toUpperCase();
                  }
              }
          }
          
          // Cr√©er le formulaire d'√©dition
          const form = document.createElement('div');
          form.style.cssText = 'display: flex; gap: 5px; align-items: center; flex-wrap: nowrap;';
          form.innerHTML = `
              <select id="edit-intext" style="padding: 3px 5px; border: 1px solid var(--primary); border-radius: 3px; font-family: inherit; font-size: inherit; font-weight: bold; background: var(--panel-bg); color: var(--text-main); text-transform: uppercase;">
                  <option value="INT." ${intExt === 'INT.' ? 'selected' : ''}>INT.</option>
                  <option value="EXT." ${intExt === 'EXT.' ? 'selected' : ''}>EXT.</option>
              </select>
              <input type="text" id="edit-lieu" value="${lieu}" style="flex: 1; min-width: 80px; padding: 3px 5px; border: 1px solid var(--primary); border-radius: 3px; font-family: inherit; font-size: inherit; font-weight: bold; background: var(--panel-bg); color: var(--text-main); text-transform: uppercase;" />
              <span style="font-weight: bold;">-</span>
              <select id="edit-moment" style="padding: 3px 5px; border: 1px solid var(--primary); border-radius: 3px; font-family: inherit; font-size: inherit; font-weight: bold; background: var(--panel-bg); color: var(--text-main); text-transform: uppercase;">
                  <option value="JOUR" ${moment === 'JOUR' ? 'selected' : ''}>JOUR</option>
                  <option value="NUIT" ${moment === 'NUIT' ? 'selected' : ''}>NUIT</option>
                  <option value="AUBE" ${moment === 'AUBE' ? 'selected' : ''}>AUBE</option>
                  <option value="MATIN" ${moment === 'MATIN' ? 'selected' : ''}>MATIN</option>
                  <option value="SOIR" ${moment === 'SOIR' ? 'selected' : ''}>SOIR</option>
                  <option value="CR√âPUSCULE" ${moment === 'CR√âPUSCULE' ? 'selected' : ''}>CR√âPUSCULE</option>
              </select>
              <button id="edit-save-btn" style="padding: 3px 8px; background: var(--primary); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85rem;">‚úì</button>
          `;
          
          const saveTitle = () => {
              const newIntExt = form.querySelector('#edit-intext').value;
              const newLieu = form.querySelector('#edit-lieu').value.trim().toUpperCase() || 'LIEU';
              const newMoment = form.querySelector('#edit-moment').value;
              const newTitle = `${newIntExt} ${newLieu} - ${newMoment}`;
              
              scene.title = newTitle;
              element.textContent = newTitle;
              Store.save();
              
              // Mettre √† jour partout
              UI.renderBoard();
              if(ScriptEditor.viewMode === 'continuous') {
                  ScriptEditor.updateContinuousSidebar(sceneId);
              }
              
              // Mettre √† jour le heading dans la vue continue
              const headingSpan = document.querySelector(`.scene-title-text[data-scene-id="${sceneId}"]`);
              if(headingSpan) headingSpan.textContent = newTitle;
              
              Utils.toast('Titre mis √† jour', 'success');
          };
          
          element.textContent = '';
          element.appendChild(form);
          
          // Events
          form.querySelector('#edit-save-btn').addEventListener('click', (e) => {
              e.stopPropagation();
              saveTitle();
          });
          
          form.querySelector('#edit-lieu').addEventListener('keydown', (e) => {
              if(e.key === 'Enter') {
                  e.preventDefault();
                  saveTitle();
              }
              if(e.key === 'Escape') {
                  element.textContent = currentTitle;
              }
          });
          
          // Focus sur le champ lieu
          setTimeout(() => {
              form.querySelector('#edit-lieu').focus();
              form.querySelector('#edit-lieu').select();
          }, 10);
      },
      
      // Drag & Drop pour r√©organiser depuis la sidebar
      draggedSceneId: null,
      
      handleSidebarDragStart: (e, sceneId) => {
          ScriptEditor.draggedSceneId = sceneId;
          e.dataTransfer.effectAllowed = 'move';
          e.target.style.opacity = '0.5';
      },
      
      handleSidebarDragEnd: (e) => {
          e.target.style.opacity = '1';
          ScriptEditor.draggedSceneId = null;
          // Retirer tous les indicateurs de drop
          document.querySelectorAll('.script-continuous-scene.drag-over').forEach(el => {
              el.classList.remove('drag-over');
          });
      },
      
      // R√©ordonner les sc√®nes en vue continue
      reorderSceneContinuous: (draggedId, targetId) => {
          const scenes = state.data.scenes;
          const draggedIndex = scenes.findIndex(s => s.id === draggedId);
          const targetIndex = scenes.findIndex(s => s.id === targetId);
          
          if(draggedIndex === -1 || targetIndex === -1) return;
          
          // Retirer la sc√®ne de sa position actuelle
          const [draggedScene] = scenes.splice(draggedIndex, 1);
          
          // Calculer la nouvelle position
          const newIndex = draggedIndex < targetIndex ? targetIndex : targetIndex;
          
          // Ins√©rer √† la nouvelle position
          scenes.splice(newIndex, 0, draggedScene);
          
          // Sauvegarder et rafra√Æchir
          Store.save();
          History.log('REORDER', `Sc√®ne "${draggedScene.title}" d√©plac√©e`);
          
          // Notification de propagation
          Utils.notifyImpact('sequencer', ['scenario', 'breakdown'], 'r√©ordonn√©');
          
          // Rafra√Æchir les vues
          UI.renderBoard();
          ScriptEditor.renderContinuous();
          
          // Remettre le focus sur la sc√®ne d√©plac√©e
          setTimeout(() => {
              ScriptEditor.setActiveScene(draggedId, newIndex);
              ScriptEditor.scrollToSceneInContinuous(draggedId);
          }, 100);
      }
  };
  
  // Initialiser le drag au chargement
  document.addEventListener('DOMContentLoaded', () => {
      ScriptEditor.initDrag();
  });
  
  // ==================== MODULE RESOURCES ====================
  const Resources = {
      currentFilter: 'all',
      
      init: () => {
          Resources.render();
      },
      
      render: () => {
          const container = document.getElementById('resourcesContainer');
          const emptyState = document.getElementById('resourcesEmpty');
          if(!container) return;
          
          const resources = state.data.resources || [];
          const filtered = Resources.currentFilter === 'all' 
              ? resources 
              : resources.filter(r => r.category === Resources.currentFilter);
          
          if(filtered.length === 0) {
              container.innerHTML = '';
              if(emptyState) emptyState.style.display = 'flex';
              return;
          }
          
          if(emptyState) emptyState.style.display = 'none';
          
          container.innerHTML = filtered.map(res => {
              const scenes = Resources.getLinkedScenes(res);
              const ownerText = Resources.getOwnerText(res);
              const categoryLabels = { accessoire: 'üé≠ Accessoire', costume: 'üëî Costume', vehicule: 'üöó V√©hicule' };
              
              return `
                  <div class="resource-card" data-id="${res.id}" data-category="${res.category}">
                      <div class="resource-card-photo">
                          ${res.photo ? `<img src="${res.photo}" alt="${Utils.escape(res.name)}">` : 'üì¶'}
                      </div>
                      <div class="resource-card-header">
                          <span class="resource-card-title">${Utils.escape(res.name)}</span>
                          <span class="resource-card-category ${res.category}">${categoryLabels[res.category] || res.category}</span>
                      </div>
                      <div class="resource-card-body">
                          ${res.description ? `<div class="resource-card-desc">${Utils.escape(res.description)}</div>` : ''}
                          ${ownerText ? `<div class="resource-card-info"><strong>Propri√©taire :</strong> ${ownerText}</div>` : ''}
                          ${res.note ? `<div class="resource-card-info"><strong>Note :</strong> ${Utils.escape(res.note)}</div>` : ''}
                          ${scenes.length > 0 ? `
                              <div class="resource-card-info"><strong>Sc√®nes li√©es :</strong></div>
                              <div class="resource-card-scenes">
                                  ${scenes.map(s => `<span class="resource-card-scene">${Utils.escape(s.title)}</span>`).join('')}
                              </div>
                          ` : ''}
                      </div>
                      <div class="resource-card-actions">
                          <button onclick="app.Resources.merge('${res.id}')" style="background:var(--locked);color:white;">üîÄ Fusionner</button>
                          <button onclick="app.Resources.edit('${res.id}')" style="background:var(--primary);color:white;">‚úèÔ∏è Modifier</button>
                          <button onclick="app.Resources.delete('${res.id}')" style="background:var(--danger);color:white;">üóëÔ∏è</button>
                      </div>
                  </div>
              `;
          }).join('');
      },
      
      filter: (category) => {
          Resources.currentFilter = category;
          document.querySelectorAll('.res-filter-btn').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.filter === category);
          });
          Resources.render();
      },
      
      getLinkedScenes: (resource) => {
          const scenes = [];
          const searchTerms = [resource.name.toLowerCase(), ...(resource.aliases || []).map(a => a.toLowerCase())];
          
          state.data.scenes.forEach(scene => {
              if(!scene.breakdown) return;
              const categories = ['ACCESSOIRES', 'COSTUMES', 'VEHICULES'];
              categories.forEach(cat => {
                  const items = scene.breakdown[cat] || [];
                  items.forEach(item => {
                      if(searchTerms.includes(item.toLowerCase())) {
                          if(!scenes.find(s => s.id === scene.id)) {
                              scenes.push(scene);
                          }
                      }
                  });
              });
          });
          return scenes;
      },
      
      getOwnerText: (resource) => {
          if(!resource.owner) return '';
          if(resource.owner.type === 'manual') {
              let text = resource.owner.name || '';
              if(resource.owner.address) text += ` (${resource.owner.address})`;
              return Utils.escape(text);
          } else if(resource.owner.type === 'actor') {
              const actor = state.data.actors.find(a => a.id === resource.owner.id);
              return actor ? `üé≠ ${Utils.escape(actor.name)}` : '';
          } else if(resource.owner.type === 'crew') {
              const member = state.data.crew.find(c => c.id === resource.owner.id);
              return member ? `üé¨ ${Utils.escape(member.name)}` : '';
          }
          return '';
      },
      
      add: async () => {
          if(state.currentRole === 'viewer') return;
          
          const modalHtml = Resources.getFormHtml();
          
          const result = await UI.showModal({
              title: '‚ûï Nouvelle Ressource',
              html: modalHtml,
              confirmText: 'Cr√©er',
              onConfirm: () => Resources.saveFromForm()
          });
      },
      
      edit: async (id) => {
          if(state.currentRole === 'viewer') return;
          const resource = (state.data.resources || []).find(r => r.id === id);
          if(!resource) return;
          
          const modalHtml = Resources.getFormHtml(resource);
          
          const result = await UI.showModal({
              title: '‚úèÔ∏è Modifier la Ressource',
              html: modalHtml,
              confirmText: 'Enregistrer',
              onConfirm: () => Resources.saveFromForm(id)
          });
      },
      
      getFormHtml: (resource = null) => {
          const actors = state.data.actors || [];
          const crew = state.data.crew || [];
          
          const ownerType = resource?.owner?.type || 'none';
          const ownerActorId = ownerType === 'actor' ? resource.owner.id : '';
          const ownerCrewId = ownerType === 'crew' ? resource.owner.id : '';
          const ownerManualName = ownerType === 'manual' ? resource.owner.name || '' : '';
          const ownerManualAddress = ownerType === 'manual' ? resource.owner.address || '' : '';
          
          return `
              <div style="display:grid; gap:15px;">
                  <div>
                      <label style="display:block; margin-bottom:5px; font-weight:600;">Nom *</label>
                      <input type="text" id="res-name" value="${resource ? Utils.escape(resource.name) : ''}" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);" placeholder="Ex: Robe rouge, T√©l√©phone vintage...">
                  </div>
                  <div>
                      <label style="display:block; margin-bottom:5px; font-weight:600;">Cat√©gorie *</label>
                      <select id="res-category" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                          <option value="accessoire" ${resource?.category === 'accessoire' ? 'selected' : ''}>üé≠ Accessoire</option>
                          <option value="costume" ${resource?.category === 'costume' ? 'selected' : ''}>üëî Costume</option>
                          <option value="vehicule" ${resource?.category === 'vehicule' ? 'selected' : ''}>üöó V√©hicule</option>
                      </select>
                  </div>
                  <div>
                      <label style="display:block; margin-bottom:5px; font-weight:600;">Photo</label>
                      <input type="file" id="res-photo-input" accept="image/*" onchange="app.Resources.previewPhoto(this)" style="margin-bottom:10px;">
                      <div id="res-photo-preview" style="width:100%; height:150px; background:var(--bg); border-radius:6px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                          ${resource?.photo ? `<img src="${resource.photo}" style="max-width:100%; max-height:100%; object-fit:contain;">` : '<span style="color:var(--text-sec);">Aper√ßu photo</span>'}
                      </div>
                      <input type="hidden" id="res-photo" value="${resource?.photo || ''}">
                  </div>
                  <div>
                      <label style="display:block; margin-bottom:5px; font-weight:600;">Description</label>
                      <textarea id="res-description" rows="3" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); resize:vertical;" placeholder="Description d√©taill√©e...">${resource?.description || ''}</textarea>
                  </div>
                  <div>
                      <label style="display:block; margin-bottom:5px; font-weight:600;">Propri√©taire</label>
                      <select id="res-owner-type" onchange="app.Resources.toggleOwnerFields()" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); margin-bottom:10px;">
                          <option value="none" ${ownerType === 'none' ? 'selected' : ''}>-- Aucun --</option>
                          <option value="actor" ${ownerType === 'actor' ? 'selected' : ''}>üé≠ Com√©dien du projet</option>
                          <option value="crew" ${ownerType === 'crew' ? 'selected' : ''}>üé¨ Technicien du projet</option>
                          <option value="manual" ${ownerType === 'manual' ? 'selected' : ''}>‚úèÔ∏è Saisie manuelle (location, etc.)</option>
                      </select>
                      <div id="res-owner-actor" style="display:${ownerType === 'actor' ? 'block' : 'none'};">
                          <select id="res-owner-actor-id" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                              <option value="">-- S√©lectionner --</option>
                              ${actors.map(a => `<option value="${a.id}" ${ownerActorId === a.id ? 'selected' : ''}>${Utils.escape(a.name)}</option>`).join('')}
                          </select>
                      </div>
                      <div id="res-owner-crew" style="display:${ownerType === 'crew' ? 'block' : 'none'};">
                          <select id="res-owner-crew-id" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                              <option value="">-- S√©lectionner --</option>
                              ${crew.map(c => `<option value="${c.id}" ${ownerCrewId === c.id ? 'selected' : ''}>${Utils.escape(c.name)} (${Utils.escape(c.role || 'Technicien')})</option>`).join('')}
                          </select>
                      </div>
                      <div id="res-owner-manual" style="display:${ownerType === 'manual' ? 'block' : 'none'};">
                          <input type="text" id="res-owner-name" value="${Utils.escape(ownerManualName)}" placeholder="Nom (ex: Studio Location Paris)" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); margin-bottom:10px;">
                          <input type="text" id="res-owner-address" value="${Utils.escape(ownerManualAddress)}" placeholder="Adresse" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                      </div>
                  </div>
                  <div>
                      <label style="display:block; margin-bottom:5px; font-weight:600;">Note</label>
                      <textarea id="res-note" rows="2" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); resize:vertical;" placeholder="Notes suppl√©mentaires...">${resource?.note || ''}</textarea>
                  </div>
              </div>
          `;
      },
      
      toggleOwnerFields: () => {
          const type = document.getElementById('res-owner-type').value;
          document.getElementById('res-owner-actor').style.display = type === 'actor' ? 'block' : 'none';
          document.getElementById('res-owner-crew').style.display = type === 'crew' ? 'block' : 'none';
          document.getElementById('res-owner-manual').style.display = type === 'manual' ? 'block' : 'none';
      },
      
      previewPhoto: (input) => {
          const preview = document.getElementById('res-photo-preview');
          const hiddenInput = document.getElementById('res-photo');
          
          if(input.files && input.files[0]) {
              const reader = new FileReader();
              reader.onload = (e) => {
                  preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
                  hiddenInput.value = e.target.result;
              };
              reader.readAsDataURL(input.files[0]);
          }
      },
      
      saveFromForm: (editId = null) => {
          const name = document.getElementById('res-name').value.trim();
          const category = document.getElementById('res-category').value;
          const photo = document.getElementById('res-photo').value;
          const description = document.getElementById('res-description').value.trim();
          const note = document.getElementById('res-note').value.trim();
          
          if(!name) {
              Utils.toast('Le nom est obligatoire', 'error');
              return false;
          }
          
          // Owner
          let owner = null;
          const ownerType = document.getElementById('res-owner-type').value;
          if(ownerType === 'actor') {
              const id = document.getElementById('res-owner-actor-id').value;
              if(id) owner = { type: 'actor', id };
          } else if(ownerType === 'crew') {
              const id = document.getElementById('res-owner-crew-id').value;
              if(id) owner = { type: 'crew', id };
          } else if(ownerType === 'manual') {
              const manualName = document.getElementById('res-owner-name').value.trim();
              const manualAddress = document.getElementById('res-owner-address').value.trim();
              if(manualName) owner = { type: 'manual', name: manualName, address: manualAddress };
          }
          
          if(!state.data.resources) state.data.resources = [];
          
          if(editId) {
              const idx = state.data.resources.findIndex(r => r.id === editId);
              if(idx > -1) {
                  state.data.resources[idx] = { ...state.data.resources[idx], name, category, photo, description, note, owner };
              }
              Utils.toast('Ressource modifi√©e', 'success');
          } else {
              const newResource = {
                  id: 'res_' + Date.now(),
                  name,
                  category,
                  photo,
                  description,
                  note,
                  owner,
                  aliases: []
              };
              state.data.resources.push(newResource);
              Utils.toast('Ressource cr√©√©e', 'success');
          }
          
          Store.save();
          Resources.render();
          return true;
      },
      
      delete: async (id) => {
          if(state.currentRole === 'viewer') return;
          
          const resource = (state.data.resources || []).find(r => r.id === id);
          if(!resource) return;
          
          // V√©rifier si la ressource est utilis√©e dans le d√©pouillement
          const categoryMap = { accessoire: 'ACCESSOIRES', costume: 'COSTUMES', vehicule: 'VEHICULES' };
          const bdCategory = categoryMap[resource.category];
          const searchTerms = [resource.name.toLowerCase(), ...(resource.aliases || []).map(a => a.toLowerCase())];
          
          let usedInScenes = [];
          state.data.scenes.forEach(scene => {
              if(!scene.breakdown || !scene.breakdown[bdCategory]) return;
              scene.breakdown[bdCategory].forEach(item => {
                  if(searchTerms.includes(item.toLowerCase())) {
                      if(!usedInScenes.find(s => s.id === scene.id)) {
                          usedInScenes.push(scene);
                      }
                  }
              });
          });
          
          let message = `√ätes-vous s√ªr de vouloir supprimer "${resource.name}" ?`;
          let deleteFromBreakdown = false;
          
          if(usedInScenes.length > 0) {
              const alsoDelete = await UI.confirmModal({
                  title: 'üóëÔ∏è Supprimer la ressource',
                  message: `"${resource.name}" est utilis√©e dans ${usedInScenes.length} sc√®ne(s). Voulez-vous aussi la supprimer du d√©pouillement ?`,
                  confirmText: 'Supprimer partout',
                  cancelText: 'Fiche uniquement',
                  type: 'danger'
              });
              deleteFromBreakdown = alsoDelete;
          } else {
              const confirmed = await UI.confirmModal({
                  title: 'üóëÔ∏è Supprimer la ressource',
                  message: message,
                  confirmText: 'Supprimer',
                  type: 'danger'
              });
              if(!confirmed) return;
          }
          
          // Supprimer du d√©pouillement si demand√©
          if(deleteFromBreakdown) {
              state.data.scenes.forEach(scene => {
                  if(!scene.breakdown || !scene.breakdown[bdCategory]) return;
                  scene.breakdown[bdCategory] = scene.breakdown[bdCategory].filter(item => 
                      !searchTerms.includes(item.toLowerCase())
                  );
              });
          }
          
          state.data.resources = state.data.resources.filter(r => r.id !== id);
          Store.save();
          Resources.render();
          Utils.toast('Ressource supprim√©e', 'success');
      },
      
      link: async (id) => {
          const resource = (state.data.resources || []).find(r => r.id === id);
          if(!resource) return;
          
          // Trouver les √©l√©ments du d√©pouillement qui pourraient correspondre
          const categoryMap = { accessoire: 'ACCESSOIRES', costume: 'COSTUMES', vehicule: 'VEHICULES' };
          const bdCategory = categoryMap[resource.category];
          
          const potentialMatches = [];
          state.data.scenes.forEach(scene => {
              if(!scene.breakdown || !scene.breakdown[bdCategory]) return;
              scene.breakdown[bdCategory].forEach(item => {
                  if(!potentialMatches.includes(item) && item.toLowerCase() !== resource.name.toLowerCase()) {
                      potentialMatches.push(item);
                  }
              });
          });
          
          if(potentialMatches.length === 0) {
              Utils.toast('Aucun √©l√©ment √† lier dans le d√©pouillement', 'info');
              return;
          }
          
          const checkboxes = potentialMatches.map(item => `
              <label style="display:flex; align-items:center; gap:10px; padding:8px; background:var(--bg); border-radius:6px; cursor:pointer; margin-bottom:5px;">
                  <input type="checkbox" value="${Utils.escape(item)}" ${(resource.aliases || []).includes(item) ? 'checked' : ''}>
                  <span>${Utils.escape(item)}</span>
              </label>
          `).join('');
          
          const result = await UI.showModal({
              title: `üîó Lier "${resource.name}" √† des √©l√©ments`,
              html: `
                  <p style="margin-bottom:15px; color:var(--text-sec);">S√©lectionnez les √©l√©ments du d√©pouillement qui correspondent √† cette ressource :</p>
                  <div style="max-height:300px; overflow-y:auto;">
                      ${checkboxes}
                  </div>
              `,
              confirmText: 'Lier',
              onConfirm: () => {
                  const checked = Array.from(document.querySelectorAll('#modal-content input[type="checkbox"]:checked')).map(cb => cb.value);
                  resource.aliases = checked;
                  Store.save();
                  Resources.render();
                  Utils.toast('Liaisons mises √† jour', 'success');
                  return true;
              }
          });
      },
      
      merge: async (id) => {
          const resource = (state.data.resources || []).find(r => r.id === id);
          if(!resource) return;
          
          // Trouver les autres ressources de la m√™me cat√©gorie
          const others = state.data.resources.filter(r => r.id !== id && r.category === resource.category);
          
          if(others.length === 0) {
              Utils.toast('Aucune autre ressource de cette cat√©gorie √† fusionner', 'info');
              return;
          }
          
          const radioButtons = others.map(r => {
              const scenes = Resources.getLinkedScenes(r);
              return `
                  <label style="display:flex; align-items:flex-start; gap:10px; padding:12px; background:var(--bg); border-radius:6px; cursor:pointer; margin-bottom:8px;">
                      <input type="radio" name="merge-target" value="${r.id}" style="margin-top:3px;">
                      <div style="flex:1;">
                          <div style="font-weight:600;">${Utils.escape(r.name)}</div>
                          ${r.description ? `<div style="font-size:0.85rem; color:var(--text-sec); margin-top:2px;">${Utils.escape(r.description.substring(0, 50))}${r.description.length > 50 ? '...' : ''}</div>` : ''}
                          ${scenes.length > 0 ? `<div style="font-size:0.8rem; color:var(--text-sec); margin-top:4px;">üìç ${scenes.length} sc√®ne(s)</div>` : ''}
                          ${r.photo ? '<div style="font-size:0.8rem; color:var(--success); margin-top:2px;">üì∑ Photo</div>' : ''}
                      </div>
                  </label>
              `;
          }).join('');
          
          const myScenes = Resources.getLinkedScenes(resource);
          
          await UI.showModal({
              title: `üîÄ Fusionner "${resource.name}"`,
              html: `
                  <div style="margin-bottom:15px; padding:10px; background:var(--bg); border-radius:6px;">
                      <strong>Fiche actuelle :</strong> ${Utils.escape(resource.name)}
                      ${myScenes.length > 0 ? `<div style="font-size:0.85rem; color:var(--text-sec);">üìç ${myScenes.length} sc√®ne(s) li√©e(s)</div>` : ''}
                  </div>
                  <p style="margin-bottom:15px; color:var(--text-sec);">S√©lectionnez la fiche avec laquelle fusionner. La fiche la plus compl√®te sera conserv√©e :</p>
                  <div style="max-height:300px; overflow-y:auto;">
                      ${radioButtons}
                  </div>
              `,
              confirmText: 'Fusionner',
              type: 'warning',
              onConfirm: () => {
                  const selected = document.querySelector('input[name="merge-target"]:checked');
                  if(!selected) {
                      Utils.toast('S√©lectionnez une fiche √† fusionner', 'error');
                      return false;
                  }
                  
                  const targetId = selected.value;
                  const target = state.data.resources.find(r => r.id === targetId);
                  if(!target) return false;
                  
                  // D√©cider quelle fiche garder (la plus compl√®te)
                  const scoreResource = (r) => {
                      let score = 0;
                      if(r.photo) score += 10;
                      if(r.description) score += 5;
                      if(r.owner) score += 3;
                      if(r.note) score += 2;
                      if(!r.autoCreated) score += 5;
                      return score;
                  };
                  
                  const keepResource = scoreResource(resource) >= scoreResource(target) ? resource : target;
                  const removeResource = keepResource === resource ? target : resource;
                  
                  // Fusionner les aliases (noms alternatifs)
                  const allAliases = new Set([
                      ...(keepResource.aliases || []),
                      ...(removeResource.aliases || []),
                      removeResource.name
                  ]);
                  allAliases.delete(keepResource.name);
                  keepResource.aliases = Array.from(allAliases);
                  
                  // Mettre √† jour le d√©pouillement pour renommer les occurrences
                  const categoryMap = { accessoire: 'ACCESSOIRES', costume: 'COSTUMES', vehicule: 'VEHICULES' };
                  const bdCategory = categoryMap[keepResource.category];
                  
                  state.data.scenes.forEach(scene => {
                      if(!scene.breakdown || !scene.breakdown[bdCategory]) return;
                      scene.breakdown[bdCategory] = scene.breakdown[bdCategory].map(item => {
                          if(item.toLowerCase() === removeResource.name.toLowerCase()) {
                              return keepResource.name;
                          }
                          return item;
                      });
                      // Supprimer les doublons
                      scene.breakdown[bdCategory] = [...new Set(scene.breakdown[bdCategory])];
                  });
                  
                  // Supprimer la fiche fusionn√©e
                  state.data.resources = state.data.resources.filter(r => r.id !== removeResource.id);
                  
                  Store.save();
                  Resources.render();
                  Utils.toast(`Fiches fusionn√©es en "${keepResource.name}"`, 'success');
                  return true;
              }
          });
      }
  };
  
  const Crew = {
    addMember: async () => {
        if(state.currentRole === 'viewer') return;
        if(state.currentRole !== 'owner' && !Permissions.canEdit('equipe')) {
            Utils.toast('Vous n\'avez pas la permission d\'ajouter des techniciens.', 'error');
            return;
        }
        
        const name = await ConfirmModal.prompt("Entrez le nom du technicien.", "Nouveau technicien", "Nom...");
        if(!name) return;
        
        const newMember = {
            id: Utils.generateUniqueId(),
            name: name,
            gender: '',
            role: '',
            email: '',
            phone: '',
            address: '',
            city: '',
            photo: '',
            hasVehicle: false,
            vehicleType: '',
            vehiclePlate: '',
            vehicleSeats: '',
            vehicleTrunk: false,
            vehicleNotes: '',
            availabilityText: '',
            availabilityDates: [],
            dailyRate: '',
            rateCurrency: '‚Ç¨',
            rateType: 'Jour',
            notes: '',
            group_id: '',
            demoreel: '',
            galleryPhotos: []
        };
        
        state.data.crew.push(newMember);
        Store.save();
        UI.renderCrewTab();
        
        // Afficher un message pour assigner un d√©partement
        Utils.toast('N\'oubliez pas d\'assigner un d√©partement au technicien !', 'info');
    },
    
    // Appel√©e quand on assigne un groupe √† un technicien (depuis updateMember ou ici)
    syncCrewMemberToScenes: (member) => {
        if(!member || !member.name) return;
        
        const essentialGroups = ['gc1', 'gc3', 'gc4']; // Image, R√©alisation, Son
        
        // Si le technicien est dans un groupe essentiel, l'ajouter √† toutes les sc√®nes
        if(essentialGroups.includes(member.group_id)) {
            state.data.scenes.forEach(scene => {
                if(!scene.breakdown) scene.breakdown = {};
                if(!scene.breakdown['TECHNICIENS']) scene.breakdown['TECHNICIENS'] = [];
                if(!scene.breakdown['TECHNICIENS'].includes(member.name)) {
                    scene.breakdown['TECHNICIENS'].push(member.name);
                }
            });
        }
        
        // Si le technicien est dans un groupe avec responsabilit√© cat√©gorie, 
        // l'ajouter aux sc√®nes qui ont des √©l√©ments de cette cat√©gorie
        const categories = CONFIG.crewToBreakdownMap[member.group_id];
        if(categories) {
            state.data.scenes.forEach(scene => {
                if(!scene.breakdown) return;
                
                // V√©rifier si la sc√®ne a des √©l√©ments dans une des cat√©gories g√©r√©es
                const hasItems = categories.some(cat => 
                    scene.breakdown[cat] && scene.breakdown[cat].length > 0
                );
                
                if(hasItems) {
                    if(!scene.breakdown['TECHNICIENS']) scene.breakdown['TECHNICIENS'] = [];
                    if(!scene.breakdown['TECHNICIENS'].includes(member.name)) {
                        scene.breakdown['TECHNICIENS'].push(member.name);
                    }
                }
            });
        }
    },
    
    // Synchroniser les techniciens essentiels vers toutes les sc√®nes
    syncEssentialCrewToScenes: () => {
        const essentialGroups = ['gc1', 'gc3', 'gc4']; // Image, R√©alisation, Son
        const essentialMembers = state.data.crew.filter(c => essentialGroups.includes(c.group_id));
        
        state.data.scenes.forEach(scene => {
            if(!scene.breakdown) scene.breakdown = {};
            if(!scene.breakdown['TECHNICIENS']) scene.breakdown['TECHNICIENS'] = [];
            
            essentialMembers.forEach(member => {
                if(!scene.breakdown['TECHNICIENS'].includes(member.name)) {
                    scene.breakdown['TECHNICIENS'].push(member.name);
                }
            });
        });
    },
    
    confirmDeleteMember: async (idx) => { if(await ConfirmModal.confirmDelete("Ce technicien sera retir√© du projet.")) { Crew.deleteMember(idx); } },
        
        deleteMember: async (idx) => {
        if(state.currentRole === 'viewer') return;
        // Confirmation d√©j√† faite dans confirmDeleteMember si appel√© depuis le bouton
        
        // R√©cup√©rer l'ID du membre avant suppression
        const memberId = state.data.crew[idx]?.id;
        
        // Retirer des feuilles de service (callSheet) de tous les jours de tournage
        if(memberId && state.data.shootingDays) {
            state.data.shootingDays.forEach(day => {
                if(day.callSheet) {
                    day.callSheet = day.callSheet.filter(
                        call => !(call.personId === memberId && call.type === 'crew')
                    );
                }
            });
        }
        
        // Supprimer les d√©penses de salaire associ√©es
        if(memberId && state.data.expenses) {
            state.data.expenses = state.data.expenses.filter(
                e => !(e.salaryPersonId === memberId && e.salaryPersonType === 'crew')
            );
        }
        
        state.data.crew.splice(idx, 1);
        Store.save();
        UI.renderCrewTab();
    },
    
    updateMember: (idx, field, value) => {
        if(state.currentRole === 'viewer') return;
        if(!state.data.crew[idx]) return;
        
        const oldVal = state.data.crew[idx][field];
        state.data.crew[idx][field] = value;
        Store.save();
        
        // Re-render role dropdown if group changed
        if(field === 'group_id') {
            UI.renderCrewTab();
            
            // Synchroniser le technicien vers les sc√®nes appropri√©es
            const member = state.data.crew[idx];
            if(member) {
                Crew.syncCrewMemberToScenes(member);
                Store.save();
            }
        }
        
        // Si on ajoute un email valide, v√©rifier si un profil public existe
        if(field === 'email' && value && value.includes('@') && value !== oldVal) {
            Actions.checkAndLinkPublicProfile(value, 'crew', idx).then(found => {
                if(!found) {
                    // Pas de profil existant, proposer de notifier pour cr√©er
                    const member = state.data.crew[idx];
                    setTimeout(async () => {
                        if(await ConfirmModal.show({ title: 'Envoyer une invitation ?', message: `Aucun profil technicien trouv√© pour ${value}.\n\nEnvoyer une invitation √† ${member.name} pour cr√©er son profil ?`, icon: 'üì®', confirmText: 'Inviter' })) {
                            Actions.notifyNewProfile(member, 'crew');
                        }
                    }, 300);
                }
            });
        }
    },
    
    toggleVehicle: (idx, hasVehicle) => {
        if(state.currentRole === 'viewer') return;
        if(!state.data.crew[idx]) return;
        
        state.data.crew[idx].hasVehicle = hasVehicle;
        Store.save();
        
        const vehicleDetails = document.getElementById(`crew-vehicle-${idx}`);
        if(vehicleDetails) {
            if(hasVehicle) {
                vehicleDetails.classList.add('visible');
            } else {
                vehicleDetails.classList.remove('visible');
            }
        }
    },
    
    addGalleryPhoto: (idx) => {
        if(state.currentRole === 'viewer') return;
        const input = document.getElementById(`crew-gallery-input-${idx}`);
        if(!input || !input.value.trim()) { Utils.toast('Veuillez entrer une URL de photo.', 'warning'); return; }
        if(!state.data.crew[idx].galleryPhotos) state.data.crew[idx].galleryPhotos = [];
        state.data.crew[idx].galleryPhotos.push(input.value.trim());
        Store.save();
        UI.renderCrewTab();
    },
    
    removeGalleryPhoto: (crewIdx, photoIdx) => {
        if(state.currentRole === 'viewer') return;
        if(state.data.crew[crewIdx] && state.data.crew[crewIdx].galleryPhotos) {
            state.data.crew[crewIdx].galleryPhotos.splice(photoIdx, 1);
            Store.save();
            UI.renderCrewTab();
        }
    },
    
    addAvailabilityDate: (idx) => {
        const dateFrom = document.getElementById(`crew-date-from-${idx}`).value;
        const dateTo = document.getElementById(`crew-date-to-${idx}`).value;
        
        if(!dateFrom) {
            Utils.toast('Veuillez s√©lectionner au moins une date de d√©but.', 'warning');
            return;
        }
        
        if(!state.data.crew[idx].availabilityDates) {
            state.data.crew[idx].availabilityDates = [];
        }
        
        state.data.crew[idx].availabilityDates.push({
            from: dateFrom,
            to: dateTo || dateFrom
        });
        
        Store.save();
        UI.renderCrewTab();
    },
    
    removeAvailabilityDate: (memberIdx, dateIdx) => {
        if(state.data.crew[memberIdx] && state.data.crew[memberIdx].availabilityDates) {
            state.data.crew[memberIdx].availabilityDates.splice(dateIdx, 1);
            Store.save();
            UI.renderCrewTab();
        }
    },
    
    addUnavailabilityDate: (memberIdx) => {
        const from = document.getElementById(`crew-unavail-from-${memberIdx}`)?.value;
        const to = document.getElementById(`crew-unavail-to-${memberIdx}`)?.value;
        const reason = document.getElementById(`crew-unavail-reason-${memberIdx}`)?.value || '';
        
        if(!from || !to) {
            Utils.toast('Veuillez s√©lectionner les dates de d√©but et fin', 'warning');
            return;
        }
        if(from > to) {
            Utils.toast('La date de fin doit √™tre apr√®s la date de d√©but', 'warning');
            return;
        }
        
        if(!state.data.crew[memberIdx].unavailabilityDates) {
            state.data.crew[memberIdx].unavailabilityDates = [];
        }
        
        state.data.crew[memberIdx].unavailabilityDates.push({ from, to, reason });
        Store.save();
        UI.renderCrewTab();
        Utils.toast('Indisponibilit√© ajout√©e', 'success');
    },
    
    removeUnavailabilityDate: (memberIdx, dateIdx) => {
        if(state.data.crew[memberIdx] && state.data.crew[memberIdx].unavailabilityDates) {
            state.data.crew[memberIdx].unavailabilityDates.splice(dateIdx, 1);
            Store.save();
            UI.renderCrewTab();
        }
    },
    
    addCustomRole: async (groupId) => {
        const newRole = await ConfirmModal.prompt("Entrez le nom de la nouvelle fonction.", "Nouvelle fonction", "Ex: Chef √©lectricien...");
        if(!newRole) return;
        
        if(!CONFIG.crewRoles[groupId]) {
            CONFIG.crewRoles[groupId] = [];
        }
        
        if(!CONFIG.crewRoles[groupId].includes(newRole)) {
            CONFIG.crewRoles[groupId].push(newRole);
        }
        
        return newRole;
    },
    
    getRolesForGroup: (groupId) => {
        return CONFIG.crewRoles[groupId] || [];
    },
    
    // ========== EXPORT PDF √âQUIPE ==========
    exportPDF: () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = margin;
        
        const projectTitle = state.data.title || 'Projet sans titre';
        const crew = state.data.crew || [];
        const actors = state.data.actors || [];
        
        if(crew.length === 0 && actors.length === 0) {
            Utils.toast('Aucun membre d\'√©quipe √† exporter', 'warning');
            return;
        }
        
        // ===== PAGE DE TITRE =====
        doc.setFillColor(43, 110, 246);
        doc.rect(0, 0, pageWidth, 50, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text('√âQUIPE DU FILM', pageWidth / 2, 25, { align: 'center' });
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'normal');
        doc.text(projectTitle, pageWidth / 2, 38, { align: 'center' });
        
        y = 60;
        
        // Statistiques
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`${actors.length} com√©dien(s) ‚Ä¢ ${crew.length} technicien(s)`, pageWidth / 2, y, { align: 'center' });
        y += 15;
        
        // ===== COM√âDIENS =====
        if(actors.length > 0) {
            doc.setFillColor(76, 175, 80);
            doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`üé≠ COM√âDIENS (${actors.length})`, margin + 5, y + 7);
            y += 15;
            
            // En-t√™tes du tableau
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
            doc.setTextColor(80, 80, 80);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.text('Com√©dien', margin + 3, y + 5.5);
            doc.text('R√¥le', margin + 55, y + 5.5);
            doc.text('T√©l√©phone', margin + 100, y + 5.5);
            doc.text('Email', margin + 135, y + 5.5);
            y += 10;
            
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50, 50, 50);
            
            actors.forEach((actor, idx) => {
                if(y > pageHeight - 20) {
                    doc.addPage();
                    y = margin;
                }
                
                if(idx % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(margin, y - 4, pageWidth - margin * 2, 8, 'F');
                }
                
                const character = state.data.characters?.find(c => c.id === actor.characterId);
                
                doc.setFontSize(8);
                doc.text((actor.name || '-').substring(0, 28), margin + 3, y);
                doc.text((character?.name || '-').substring(0, 22), margin + 55, y);
                doc.text((actor.phone || '-').substring(0, 18), margin + 100, y);
                doc.setTextColor(43, 110, 246);
                doc.text((actor.email || '-').substring(0, 28), margin + 135, y);
                doc.setTextColor(50, 50, 50);
                
                y += 7;
            });
            
            y += 10;
        }
        
        // ===== √âQUIPE TECHNIQUE =====
        if(crew.length > 0) {
            if(y > pageHeight - 50) {
                doc.addPage();
                y = margin;
            }
            
            // Grouper par d√©partement
            const byDepartment = {};
            crew.forEach(member => {
                const dept = member.department || 'Autre';
                if(!byDepartment[dept]) byDepartment[dept] = [];
                byDepartment[dept].push(member);
            });
            
            const deptColors = {
                'R√©alisation': [156, 39, 176],
                'Image': [33, 150, 243],
                'Son': [0, 188, 212],
                'Lumi√®re': [255, 193, 7],
                'D√©cor': [121, 85, 72],
                'HMC': [233, 30, 99],
                'R√©gie': [255, 152, 0],
                'Post-production': [96, 125, 139],
                'Production': [76, 175, 80]
            };
            
            Object.entries(byDepartment).forEach(([dept, members]) => {
                if(y > pageHeight - 40) {
                    doc.addPage();
                    y = margin;
                }
                
                const rgb = deptColors[dept] || [100, 100, 100];
                
                // En-t√™te d√©partement
                doc.setFillColor(rgb[0], rgb[1], rgb[2]);
                doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(`${dept.toUpperCase()} (${members.length})`, margin + 5, y + 7);
                y += 12;
                
                // En-t√™tes du tableau
                doc.setFillColor(245, 245, 245);
                doc.rect(margin, y, pageWidth - margin * 2, 7, 'F');
                doc.setTextColor(80, 80, 80);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('Nom', margin + 3, y + 5);
                doc.text('Fonction', margin + 50, y + 5);
                doc.text('T√©l√©phone', margin + 100, y + 5);
                doc.text('Email', margin + 135, y + 5);
                y += 9;
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(50, 50, 50);
                
                members.forEach((member, idx) => {
                    if(y > pageHeight - 15) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    if(idx % 2 === 0) {
                        doc.setFillColor(252, 252, 252);
                        doc.rect(margin, y - 3.5, pageWidth - margin * 2, 7, 'F');
                    }
                    
                    doc.setFontSize(8);
                    doc.text((member.name || '-').substring(0, 25), margin + 3, y);
                    doc.text((member.role || '-').substring(0, 25), margin + 50, y);
                    doc.text((member.phone || '-').substring(0, 18), margin + 100, y);
                    doc.setTextColor(43, 110, 246);
                    doc.text((member.email || '-').substring(0, 28), margin + 135, y);
                    doc.setTextColor(50, 50, 50);
                    
                    y += 7;
                });
                
                y += 8;
            });
        }
        
        // ===== PIED DE PAGE =====
        const totalPages = doc.internal.getNumberOfPages();
        for(let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`${projectTitle} - √âquipe`, margin, pageHeight - 8);
            doc.text(`Page ${i}/${totalPages}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
            doc.text(`G√©n√©r√© par Moteur - ${new Date().toLocaleDateString('fr-FR')}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
        }
        
        // T√©l√©charger
        const filename = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'equipe') + '_equipe.pdf';
        doc.save(filename);
        
        Utils.toast('√âquipe PDF export√©e !', 'success');
        History.log('EXPORT', '√âquipe PDF g√©n√©r√©e');
    }
};

const PublicProfile = {
    profiles: [], // Liste des profils de l'utilisateur
    currentProfileIndex: -1, // Index du profil actuellement affich√©
    equipment: { cameras: [], lenses: [], lights: [], sounds: [], grips: [], makeups: [], other: [] },
    profileProjects: {}, // Mapping profileId -> [{projectId, projectTitle, role}]
    
    // Charge les projets associ√©s √† chaque profil
    loadProfileProjects: async () => {
        PublicProfile.profileProjects = {};
        if(!state.currentUser || PublicProfile.profiles.length === 0) return;
        
        try {
            const projectsList = await Store.getProjectsList();
            
            for(const project of projectsList) {
                // Charger les donn√©es compl√®tes du projet (actors + crew)
                const dataSnap = await firebase.database().ref('all_projects/' + project.id + '/data').once('value');
                const data = dataSnap.val();
                if(!data) continue;
                
                const projectInfo = { projectId: project.id, projectTitle: project.title || 'Sans titre' };
                
                // V√©rifier les acteurs
                if(data.actors && Array.isArray(data.actors)) {
                    data.actors.forEach(actor => {
                        if(actor.publicProfileId) {
                            if(!PublicProfile.profileProjects[actor.publicProfileId]) {
                                PublicProfile.profileProjects[actor.publicProfileId] = [];
                            }
                            // √âviter les doublons
                            if(!PublicProfile.profileProjects[actor.publicProfileId].some(p => p.projectId === project.id)) {
                                PublicProfile.profileProjects[actor.publicProfileId].push({ ...projectInfo, role: 'actor' });
                            }
                        }
                    });
                }
                
                // V√©rifier les techniciens
                if(data.crew && Array.isArray(data.crew)) {
                    data.crew.forEach(member => {
                        if(member.publicProfileId) {
                            if(!PublicProfile.profileProjects[member.publicProfileId]) {
                                PublicProfile.profileProjects[member.publicProfileId] = [];
                            }
                            // √âviter les doublons
                            if(!PublicProfile.profileProjects[member.publicProfileId].some(p => p.projectId === project.id)) {
                                PublicProfile.profileProjects[member.publicProfileId].push({ ...projectInfo, role: 'crew' });
                            }
                        }
                    });
                }
            }
        } catch(e) {
            console.error('Erreur chargement projets profils:', e);
        }
    },
    
    // Gestion de la visibilit√© des sections
    toggleVisibility: (section, scope) => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) {
            Utils.toast('Veuillez d\'abord s√©lectionner un profil', 'warning');
            return;
        }
        
        // Initialiser les tableaux si n√©cessaire
        if(!profile.hiddenPublic) profile.hiddenPublic = [];
        if(!profile.hiddenProject) profile.hiddenProject = [];
        
        const hiddenArray = scope === 'public' ? profile.hiddenPublic : profile.hiddenProject;
        const index = hiddenArray.indexOf(section);
        
        if(index > -1) {
            // Section cach√©e -> la rendre visible
            hiddenArray.splice(index, 1);
        } else {
            // Section visible -> la cacher
            hiddenArray.push(section);
        }
        
        // Mettre √† jour l'affichage des boutons
        PublicProfile.updateVisibilityButtons();
        
        // Sauvegarder automatiquement
        PublicProfile.save();
    },
    
    updateVisibilityButtons: () => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        const hiddenPublic = profile.hiddenPublic || [];
        const hiddenProject = profile.hiddenProject || [];
        
        // Mettre √† jour tous les boutons
        document.querySelectorAll('.visibility-btn').forEach(btn => {
            const section = btn.dataset.section;
            const scope = btn.dataset.scope;
            
            const hiddenArray = scope === 'public' ? hiddenPublic : hiddenProject;
            const isHidden = hiddenArray.includes(section);
            
            btn.classList.toggle('hidden-section', isHidden);
            
            // Mettre √† jour l'ic√¥ne
            const icon = btn.querySelector('.vis-icon');
            if(icon) {
                icon.textContent = isHidden ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è';
            }
            
            // Mettre √† jour le title
            const scopeLabel = scope === 'public' ? 'public (Univers)' : 'projet (√©quipe)';
            btn.title = isHidden ? `Section cach√©e en ${scopeLabel} - Cliquer pour afficher` : `Section visible en ${scopeLabel} - Cliquer pour cacher`;
        });
    },
    
    open: async () => {
        els.dashboardView.style.display = 'none';
        els.publicProfileView.classList.add('active');
        
        // Charger les messages
        Messages.load();
        
        // Afficher l'onglet profil par d√©faut
        PublicProfile.showTab('profile');
        
        document.getElementById('profile-title').textContent = 'üé≠ Mes Profils Publics';
        
        // Charger les profils depuis Firebase
        await PublicProfile.loadProfiles();
        
        // Charger les projets li√©s aux profils
        await PublicProfile.loadProfileProjects();
        
        // Charger les profils √† revendiquer
        await PublicProfile.loadPendingClaims();
        
        // R√©initialiser les filtres de messages maintenant que les profils sont charg√©s
        Messages.initFilters();
        
        // Afficher les onglets de profils
        PublicProfile.renderProfileTabs();
        
        // Afficher le premier profil ou le message "nouveau profil"
        if(PublicProfile.profiles.length > 0) {
            PublicProfile.currentProfileIndex = 0;
            PublicProfile.loadProfileToForm(PublicProfile.profiles[0]);
            document.getElementById('no-profile-message').style.display = 'none';
            document.getElementById('profile-form-container').style.display = 'block';
        } else {
            PublicProfile.currentProfileIndex = -1;
            document.getElementById('no-profile-message').style.display = 'block';
            document.getElementById('profile-form-container').style.display = 'none';
        }
        // Afficher le conteneur maintenant que tout est charg√©
        document.getElementById('current-profile-content').style.display = 'block';
    },
    
    close: () => {
        els.publicProfileView.classList.remove('active');
        els.dashboardView.style.display = 'flex';
    },
    
	deleteAccount: async () => {
        const confirm1 = await ConfirmModal.show({ title: '‚ö†Ô∏è Supprimer votre compte ?', message: 'Vous allez supprimer d√©finitivement votre compte.\n\nTous vos projets dont vous √™tes propri√©taire seront supprim√©s.\n\nCette action est IRR√âVERSIBLE.', icon: '‚ò†Ô∏è', dangerous: true, confirmText: 'Continuer' });
        if(!confirm1) return;
        
        const confirm2 = await ConfirmModal.prompt('Pour confirmer, tapez "SUPPRIMER" :', "Confirmation finale", "SUPPRIMER");
        if(confirm2 !== 'SUPPRIMER') {
            Utils.toast('Suppression annul√©e.', 'info');
            return;
        }
        
        try {
            const email = state.currentUser.email;
            const emailKey = Utils.sanitizeEmail(email);
            const uid = state.currentUser.uid;
            
            // 1. R√©cup√©rer tous les projets de l'utilisateur
            const projectsSnap = await firebase.database().ref('user_projects/' + emailKey).once('value');
            const projects = projectsSnap.val() || {};
            
            const updates = {};
            
            // 2. Supprimer les projets dont l'utilisateur est propri√©taire
            for(const pid of Object.keys(projects)) {
                if(projects[pid] === 'owner') {
                    updates['all_projects/' + pid] = null;
                }
                // Supprimer de l'index utilisateur
                updates['user_projects/' + emailKey + '/' + pid] = null;
            }
            
            // 3. Supprimer le profil utilisateur
            updates['user_profiles/' + emailKey] = null;
            
            // 4. Supprimer les profils publics dont l'utilisateur est propri√©taire
            const dbPaths = ['public_actors', 'public_crew', 'public_associations', 'public_enterprises'];
            for(const dbPath of dbPaths) {
                const snap = await firebase.database().ref(dbPath).orderByChild('ownerId').equalTo(emailKey).once('value');
                const profiles = snap.val() || {};
                for(const profileId of Object.keys(profiles)) {
                    updates[`${dbPath}/${profileId}`] = null;
                }
            }
            
            // 5. Supprimer les projets publics dont l'utilisateur est propri√©taire
            const publicProjectsSnap = await firebase.database().ref('public_projects').orderByChild('ownerEmail').equalTo(email).once('value');
            const publicProjects = publicProjectsSnap.val() || {};
            for(const projectId of Object.keys(publicProjects)) {
                updates[`public_projects/${projectId}`] = null;
            }
            
            // 6. Supprimer les messages
            updates['user_messages/' + emailKey] = null;
            
            // 7. Supprimer les notifications
            updates['user_notifications/' + emailKey] = null;
            
            // 8. Supprimer les contacts
            updates['user_contacts/' + emailKey] = null;
            
            // 9. Supprimer les invitations en attente
            updates['pending_invitations/' + emailKey] = null;
            
            // Appliquer toutes les suppressions
            await firebase.database().ref().update(updates);
            
            // 8. Supprimer le compte Firebase Auth
            await state.currentUser.delete();
            
            Utils.toast('Votre compte a √©t√© supprim√©. Au revoir !', 'success');
            window.location.reload();
            
        } catch(e) {
            console.error('Erreur suppression compte:', e);
            if(e.code === 'auth/requires-recent-login') {
                Utils.toast('Pour des raisons de s√©curit√©, veuillez vous d√©connecter, vous reconnecter, puis r√©essayer.', 'warning');
            } else {
                Utils.toast('Erreur lors de la suppression : ' + e.message, 'error');
            }
        }
    },
	
	updateGallery: (index, url) => {
        const item = document.getElementById('gallery-item-' + index);
        if(!item) return;
        
        if(url && url.trim()) {
            item.innerHTML = `
                <img src="${url}" alt="Photo ${index + 1}" onerror="this.parentElement.innerHTML='<span class=\\'gallery-placeholder\\'>+</span>'">
                <button class="gallery-remove" onclick="event.stopPropagation(); app.PublicProfile.removeGalleryPhoto(${index})">‚úï</button>
            `;
        } else {
            item.innerHTML = '<span class="gallery-placeholder">+</span>';
        }
    },
    
    removeGalleryPhoto: (index) => {
        const input = document.getElementById('gallery-input-' + index);
        if(input) {
            input.value = '';
            PublicProfile.updateGallery(index, '');
        }
    },
    
    loadGallery: (photos) => {
        if(!photos) photos = [];
        for(let i = 0; i < 3; i++) {
            const input = document.getElementById('gallery-input-' + i);
            if(input) {
                input.value = photos[i] || '';
                PublicProfile.updateGallery(i, photos[i] || '');
            }
        }
    },
    
    // Galerie photos techniciens
    updateCrewGallery: (index, url) => {
        const item = document.getElementById('crew-gallery-item-' + index);
        if(!item) return;
        
        if(url && url.trim()) {
            item.innerHTML = `
                <img src="${url}" alt="Photo ${index + 1}" onerror="this.parentElement.innerHTML='<span class=\\'gallery-placeholder\\'>+</span>'">
                <button class="gallery-remove" onclick="event.stopPropagation(); app.PublicProfile.removeCrewGalleryPhoto(${index})">‚úï</button>
            `;
        } else {
            item.innerHTML = '<span class="gallery-placeholder">+</span>';
        }
    },
    
    removeCrewGalleryPhoto: (index) => {
        const input = document.getElementById('crew-gallery-input-' + index);
        if(input) {
            input.value = '';
            PublicProfile.updateCrewGallery(index, '');
        }
    },
    
    loadCrewGallery: (photos) => {
        if(!photos) photos = [];
        for(let i = 0; i < 3; i++) {
            const input = document.getElementById('crew-gallery-input-' + i);
            if(input) {
                input.value = photos[i] || '';
                PublicProfile.updateCrewGallery(i, photos[i] || '');
            }
        }
    },
	
	// Affiche/masque une section de mat√©riel
    toggleEquipmentSection: (section) => {
        const sectionEl = document.getElementById('equip-section-' + section);
        const checkbox = document.getElementById('show-equip-' + section);
        if(sectionEl && checkbox) {
            sectionEl.style.display = checkbox.checked ? 'block' : 'none';
        }
    },
    
	// Affiche les onglets de profils
    renderProfileTabs: () => {
        const container = document.getElementById('profile-tabs-container');
        if(!container) return;
        
        let html = '';
        
        PublicProfile.profiles.forEach((profile, idx) => {
            const isActive = idx === PublicProfile.currentProfileIndex;
            const icon = profile.type === 'actor' ? 'üé≠' : profile.type === 'crew' ? 'üé•' : profile.type === 'association' ? 'üèõÔ∏è' : profile.type === 'enterprise' ? 'üè¢' : '‚è≥';
            const label = profile.type === 'actor' ? (profile.name || 'Com√©dien') : 
                          profile.type === 'crew' ? (profile.role || profile.department || 'Technicien') : 
                          profile.type === 'association' ? (profile.assoName || 'Association') :
                          profile.type === 'enterprise' ? (profile.entName || 'Entreprise') : 'Profil en attente';
            
            // R√©cup√©rer les projets li√©s √† ce profil
            const linkedProjects = PublicProfile.profileProjects[profile.id] || [];
            let projectBadgesHtml = '';
            if(linkedProjects.length > 0) {
                projectBadgesHtml = '<div class="profile-project-badges">' + 
                    linkedProjects.map(p => `<span class="profile-project-badge" onclick="event.stopPropagation(); app.Store.loadProject('${p.projectId}')" title="Ouvrir ${Utils.escape(p.projectTitle)}">üé¨ ${Utils.escape(p.projectTitle)}</span>`).join('') + 
                '</div>';
            }
            
            html += `<div class="profile-tab-card ${isActive ? 'active' : ''}" onclick="app.PublicProfile.switchToProfile(${idx})">
                <div class="profile-tab-header">${icon} ${Utils.escape(label)}</div>
                ${projectBadgesHtml}
            </div>`;
        });
        
        // Bouton ajouter un profil
        html += `<div class="profile-tab-card add-profile" onclick="app.PublicProfile.createNewProfile()">
            <div class="profile-tab-header">‚ûï Nouveau profil</div>
        </div>`;
        
        container.innerHTML = html;
    },
    
    // Cr√©e un nouveau profil
    createNewProfile: () => {
        // G√©n√©rer les disponibilit√©s par d√©faut (lun-ven pour les 3 prochains mois)
        const defaultAvailability = PublicProfile.generateDefaultAvailability();
        
        const newProfile = {
            id: 'profile_' + Date.now(),
            type: '', // sera d√©fini par l'utilisateur
            name: '',
            photo: '',
            gender: '',
            phone: '',
            city: '',
            website: '',
            bio: '',
            // Champs com√©dien
            galleryPhotos: [],
            height: '',
            weight: '',
            age: '',
            eyeColor: '',
            hairColor: '',
            hairLength: '',
            ethnicity: '',
            corpulence: '',
            sports: '',
            languages: '',
            // Champs technicien
            department: '',
            role: '',
            cameras: [],
            lenses: [],
            lights: [],
            sounds: [],
            grips: [],
            makeups: [],
            otherEquipment: [],
            // Commun
            dailyRate: '',
            rateCurrency: '‚Ç¨',
            availabilityText: '',
            availabilityDates: defaultAvailability,
            unavailabilityDates: [],
            hasVehicle: false,
            vehicleType: '',
            vehicleSeats: '',
            vehicleTrunk: false,
            profileComplete: false,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        PublicProfile.profiles.push(newProfile);
        PublicProfile.currentProfileIndex = PublicProfile.profiles.length - 1;
        PublicProfile.renderProfileTabs();
        PublicProfile.loadProfileToForm(newProfile);
        
        // Afficher le formulaire
        document.getElementById('no-profile-message').style.display = 'none';
        document.getElementById('profile-form-container').style.display = 'block';
    },
    
    // G√©n√®re les disponibilit√©s par d√©faut (lun-ven pour les 3 prochains mois)
    generateDefaultAvailability: () => {
        const availability = [];
        const today = new Date();
        const endDate = new Date(today);
        endDate.setFullYear(endDate.getFullYear() + 1); // 1 an au lieu de 3 mois
        
        let currentWeekStart = null;
        let currentWeekEnd = null;
        
        const formatDate = (d) => d.toISOString().split('T')[0];
        
        // Parcourir chaque jour de la prochaine ann√©e
        const current = new Date(today);
        while(current <= endDate) {
            const dayOfWeek = current.getDay(); // 0=dim, 1=lun, ..., 5=ven, 6=sam
            
            if(dayOfWeek >= 1 && dayOfWeek <= 5) { // Lundi √† Vendredi
                if(currentWeekStart === null) {
                    currentWeekStart = new Date(current);
                }
                currentWeekEnd = new Date(current);
            } else {
                // Weekend : finaliser la p√©riode en cours
                if(currentWeekStart !== null) {
                    availability.push({
                        from: formatDate(currentWeekStart),
                        to: formatDate(currentWeekEnd)
                    });
                    currentWeekStart = null;
                    currentWeekEnd = null;
                }
            }
            
            current.setDate(current.getDate() + 1);
        }
        
        // Finaliser la derni√®re p√©riode si n√©cessaire
        if(currentWeekStart !== null) {
            availability.push({
                from: formatDate(currentWeekStart),
                to: formatDate(currentWeekEnd)
            });
        }
        
        return availability;
    },
    
    // ========== LANGUES ET SPORTS AVEC NIVEAUX ==========
    languageLevels: {
        'notions': 'üìò Notions',
        'intermediaire': 'üìó Interm√©diaire', 
        'courant': 'üìô Courant',
        'bilingue': 'üìï Bilingue',
        'maternelle': 'üè† Maternelle'
    },
    sportLevels: {
        'debutant': 'üå± D√©butant',
        'amateur': '‚≠ê Amateur',
        'confirme': '‚≠ê‚≠ê Confirm√©',
        'competition': 'üèÜ Comp√©tition',
        'professionnel': 'üëë Pro'
    },
    
    addLanguage: async () => {
        const select = document.getElementById('profile-language-select');
        const levelSelect = document.getElementById('profile-language-level');
        let name = select.value;
        const level = levelSelect.value;
        
        if(!name) return;
        
        // Si "Autre", demander le nom
        if(name === '__custom__') {
            name = await ConfirmModal.prompt('Nom de la langue :', 'Ajouter une langue', 'Ex: Mandarin...');
            if(!name || !name.trim()) { select.value = ''; return; }
            name = name.trim();
        }
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        if(!profile.languagesWithLevels) profile.languagesWithLevels = [];
        
        // V√©rifier si d√©j√† ajout√©
        if(profile.languagesWithLevels.some(l => l.name.toLowerCase() === name.toLowerCase())) {
            Utils.toast('Cette langue est d√©j√† ajout√©e', 'warning');
            select.value = '';
            return;
        }
        
        profile.languagesWithLevels.push({ name, level });
        PublicProfile.renderLanguagesList();
        select.value = '';
    },
    
    removeLanguage: (idx) => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile || !profile.languagesWithLevels) return;
        profile.languagesWithLevels.splice(idx, 1);
        PublicProfile.renderLanguagesList();
    },
    
    renderLanguagesList: () => {
        const container = document.getElementById('profile-languages-list');
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!container || !profile) return;
        
        const langs = profile.languagesWithLevels || [];
        container.innerHTML = langs.map((l, i) => `
            <span style="display:inline-flex; align-items:center; gap:5px; background:var(--panel-bg); border:1px solid var(--border); padding:5px 10px; border-radius:20px; font-size:0.85rem;">
                <strong>${Utils.escape(l.name)}</strong>
                <span style="color:var(--text-sec);">${PublicProfile.languageLevels[l.level] || l.level}</span>
                <span onclick="app.PublicProfile.removeLanguage(${i})" style="cursor:pointer; color:var(--danger); margin-left:3px;">‚úñ</span>
            </span>
        `).join('');
        
        // Mise √† jour du champ cach√© pour compatibilit√©
        document.getElementById('profile-languages').value = langs.map(l => `${l.name} (${l.level})`).join(', ');
    },
    
    addSport: async () => {
        const select = document.getElementById('profile-sport-select');
        const levelSelect = document.getElementById('profile-sport-level');
        let name = select.value;
        const level = levelSelect.value;
        
        if(!name) return;
        
        // Si "Autre", demander le nom
        if(name === '__custom__') {
            name = await ConfirmModal.prompt('Nom du sport ou comp√©tence :', 'Ajouter une comp√©tence', 'Ex: Escalade...');
            if(!name || !name.trim()) { select.value = ''; return; }
            name = name.trim();
        }
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        if(!profile.sportsWithLevels) profile.sportsWithLevels = [];
        
        // V√©rifier si d√©j√† ajout√©
        if(profile.sportsWithLevels.some(s => s.name.toLowerCase() === name.toLowerCase())) {
            Utils.toast('Ce sport est d√©j√† ajout√©', 'warning');
            select.value = '';
            return;
        }
        
        profile.sportsWithLevels.push({ name, level });
        PublicProfile.renderSportsList();
        select.value = '';
    },
    
    removeSport: (idx) => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile || !profile.sportsWithLevels) return;
        profile.sportsWithLevels.splice(idx, 1);
        PublicProfile.renderSportsList();
    },
    
    renderSportsList: () => {
        const container = document.getElementById('profile-sports-list');
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!container || !profile) return;
        
        const sports = profile.sportsWithLevels || [];
        container.innerHTML = sports.map((s, i) => `
            <span style="display:inline-flex; align-items:center; gap:5px; background:var(--panel-bg); border:1px solid var(--border); padding:5px 10px; border-radius:20px; font-size:0.85rem;">
                <strong>${Utils.escape(s.name)}</strong>
                <span style="color:var(--text-sec);">${PublicProfile.sportLevels[s.level] || s.level}</span>
                <span onclick="app.PublicProfile.removeSport(${i})" style="cursor:pointer; color:var(--danger); margin-left:3px;">‚úñ</span>
            </span>
        `).join('');
        
        // Mise √† jour du champ cach√© pour compatibilit√©
        document.getElementById('profile-sports').value = sports.map(s => `${s.name} (${s.level})`).join(', ');
    },
    
    // Migration des anciennes donn√©es texte vers le nouveau format
    migrateSkillsData: (profile) => {
        // Migrer les langues
        if(profile.languages && typeof profile.languages === 'string' && !profile.languagesWithLevels) {
            profile.languagesWithLevels = profile.languages.split(',').map(l => l.trim()).filter(l => l).map(l => ({
                name: l.replace(/\s*\([^)]*\)\s*$/, '').trim(),
                level: 'courant'
            }));
        }
        // Migrer les sports
        if(profile.sports && typeof profile.sports === 'string' && !profile.sportsWithLevels) {
            profile.sportsWithLevels = profile.sports.split(',').map(s => s.trim()).filter(s => s).map(s => ({
                name: s.replace(/\s*\([^)]*\)\s*$/, '').trim(),
                level: 'confirme'
            }));
        }
    },
    
    // Change de profil
    switchToProfile: (index) => {
        if(index < 0 || index >= PublicProfile.profiles.length) return;
        
        // Sauvegarder le profil actuel avant de changer
        if(PublicProfile.currentProfileIndex >= 0) {
            PublicProfile.saveFormToCurrentProfile();
        }
        
        PublicProfile.currentProfileIndex = index;
        PublicProfile.renderProfileTabs();
        PublicProfile.loadProfileToForm(PublicProfile.profiles[index]);
        
        document.getElementById('no-profile-message').style.display = 'none';
        document.getElementById('profile-form-container').style.display = 'block';
    },
    
    // Charge un profil dans le formulaire
    loadProfileToForm: (profile) => {
        // Type de profil
        document.getElementById('profile-type-actor').checked = profile.type === 'actor';
        document.getElementById('profile-type-crew').checked = profile.type === 'crew';
        document.getElementById('profile-type-association').checked = profile.type === 'association';
        document.getElementById('profile-type-enterprise').checked = profile.type === 'enterprise';
        PublicProfile.onProfileTypeChange();
        
        // Identit√©
        document.getElementById('profile-photo').value = profile.photo || '';
        document.getElementById('profile-name').value = profile.name || '';
        document.getElementById('profile-gender').value = profile.gender || '';
        document.getElementById('profile-email').value = state.currentUser?.email || '';
        document.getElementById('profile-phone').value = profile.phone || '';
        document.getElementById('profile-city').value = profile.city || '';
        document.getElementById('profile-address').value = profile.address || '';
        document.getElementById('profile-hide-address').checked = profile.hideAddress || false;
        document.getElementById('profile-hide-address-projects').checked = profile.hideAddressInProjects || false;
        document.getElementById('profile-website').value = profile.website || '';
        document.getElementById('profile-bio').value = profile.bio || '';
        
        // Mettre √† jour les options de confidentialit√©
        setTimeout(() => PublicProfile.updateAddressPrivacyOptions(), 100);
        
        // Com√©dien
        if(profile.type === 'actor') {
            PublicProfile.loadGallery(profile.galleryPhotos || []);
            document.getElementById('profile-height').value = profile.height || '';
            document.getElementById('profile-weight').value = profile.weight || '';
            document.getElementById('profile-age').value = profile.age || '';
            document.getElementById('profile-eyes').value = profile.eyeColor || '';
            document.getElementById('profile-hair-color').value = profile.hairColor || '';
            document.getElementById('profile-hair-length').value = profile.hairLength || '';
            document.getElementById('profile-ethnicity').value = profile.ethnicity || '';
            document.getElementById('profile-corpulence').value = profile.corpulence || '';
            // Migration et affichage des langues/sports avec niveaux
            PublicProfile.migrateSkillsData(profile);
            PublicProfile.renderLanguagesList();
            PublicProfile.renderSportsList();
            document.getElementById('profile-demoreel').value = profile.demoreel || '';
        }
        
        // Technicien
        if(profile.type === 'crew') {
            document.getElementById('profile-department').value = profile.department || '';
            PublicProfile.updateRoleOptions();
            
            const roleSelect = document.getElementById('profile-role');
            const roleCustom = document.getElementById('profile-role-custom');
            const savedRole = profile.role || '';
            
            let roleFound = false;
            for(let i = 0; i < roleSelect.options.length; i++) {
                if(roleSelect.options[i].value === savedRole) {
                    roleSelect.value = savedRole;
                    roleFound = true;
                    break;
                }
            }
            
            if(!roleFound && savedRole) {
                roleSelect.value = 'Autre';
                roleCustom.style.display = 'block';
                roleCustom.value = savedRole;
            }
            
            PublicProfile.equipment = {
                cameras: profile.cameras || [],
                lenses: profile.lenses || [],
                lights: profile.lights || [],
                sounds: profile.sounds || [],
                grips: profile.grips || [],
                makeups: profile.makeups || [],
                other: profile.otherEquipment || []
            };
            PublicProfile.renderEquipment();
            document.getElementById('profile-crew-demoreel').value = profile.demoreel || '';
            PublicProfile.loadCrewGallery(profile.crewGalleryPhotos || []);
        }
        
        // Association
        if(profile.type === 'association') {
            document.getElementById('profile-asso-name').value = profile.assoName || '';
            document.getElementById('profile-asso-type').value = profile.assoType || '';
            document.getElementById('profile-asso-siret').value = profile.assoSiret || '';
            document.getElementById('profile-asso-members').value = profile.assoMembers || '';
            document.getElementById('profile-asso-year').value = profile.assoYear || '';
            document.getElementById('profile-asso-president').value = profile.assoPresident || '';
            document.getElementById('profile-asso-mission').value = profile.assoMission || '';
            document.getElementById('profile-asso-activities').value = profile.assoActivities || '';
            const services = profile.assoServices || {};
            document.getElementById('asso-service-formation').checked = services.formation || false;
            document.getElementById('asso-service-ateliers').checked = services.ateliers || false;
            document.getElementById('asso-service-networking').checked = services.networking || false;
            document.getElementById('asso-service-casting').checked = services.casting || false;
            document.getElementById('asso-service-materiel').checked = services.materiel || false;
            document.getElementById('asso-service-production').checked = services.production || false;
            document.getElementById('asso-service-diffusion').checked = services.diffusion || false;
            document.getElementById('profile-asso-facebook').value = profile.assoFacebook || '';
            document.getElementById('profile-asso-instagram').value = profile.assoInstagram || '';
            document.getElementById('profile-asso-youtube').value = profile.assoYoutube || '';
            document.getElementById('profile-asso-linkedin').value = profile.assoLinkedin || '';
            document.getElementById('profile-asso-demoreel').value = profile.assoDemoreel || '';
        }
        
        // Entreprise
        if(profile.type === 'enterprise') {
            document.getElementById('profile-ent-name').value = profile.entName || '';
            document.getElementById('profile-ent-type').value = profile.entType || '';
            document.getElementById('profile-ent-siret').value = profile.entSiret || '';
            document.getElementById('profile-ent-legal').value = profile.entLegal || '';
            document.getElementById('profile-ent-year').value = profile.entYear || '';
            document.getElementById('profile-ent-employees').value = profile.entEmployees || '';
            document.getElementById('profile-ent-director').value = profile.entDirector || '';
            document.getElementById('profile-ent-contact').value = profile.entContact || '';
            document.getElementById('profile-ent-description').value = profile.entDescription || '';
            document.getElementById('profile-ent-services').value = profile.entServices || '';
            const specs = profile.entSpecialties || {};
            document.getElementById('ent-spec-fiction').checked = specs.fiction || false;
            document.getElementById('ent-spec-doc').checked = specs.doc || false;
            document.getElementById('ent-spec-pub').checked = specs.pub || false;
            document.getElementById('ent-spec-corporate').checked = specs.corporate || false;
            document.getElementById('ent-spec-clip').checked = specs.clip || false;
            document.getElementById('ent-spec-event').checked = specs.event || false;
            document.getElementById('ent-spec-web').checked = specs.web || false;
            document.getElementById('profile-ent-facebook').value = profile.entFacebook || '';
            document.getElementById('profile-ent-instagram').value = profile.entInstagram || '';
            document.getElementById('profile-ent-youtube').value = profile.entYoutube || '';
            document.getElementById('profile-ent-linkedin').value = profile.entLinkedin || '';
            document.getElementById('profile-ent-vimeo').value = profile.entVimeo || '';
            document.getElementById('profile-ent-imdb').value = profile.entImdb || '';
            document.getElementById('profile-ent-demoreel').value = profile.entDemoreel || '';
        }   
        // Tarif & Dispo
        document.getElementById('profile-rate').value = profile.dailyRate || '';
        document.getElementById('profile-currency').value = profile.rateCurrency || '‚Ç¨';
        document.getElementById('profile-rate-negotiable').checked = profile.rateNegotiable || false;
        document.getElementById('profile-availability').value = profile.availabilityText || '';
        
        // Calendrier disponibilit√©s
        PublicProfile.renderProfileCalendar();
        PublicProfile.renderProfileDatesList();
        
        // Types de collaboration
        PublicProfile.loadCollabTypes(profile);
        
        // V√©hicule
        document.getElementById('profile-has-vehicle').checked = profile.hasVehicle || false;
        document.getElementById('profile-vehicle-details').style.display = profile.hasVehicle ? 'block' : 'none';
        document.getElementById('profile-vehicle-type').value = profile.vehicleType || '';
        document.getElementById('profile-vehicle-plate').value = profile.vehiclePlate || '';
        document.getElementById('profile-vehicle-seats').value = profile.vehicleSeats || '';
        document.getElementById('profile-vehicle-trunk').checked = profile.vehicleTrunk || false;
        document.getElementById('profile-vehicle-notes').value = profile.vehicleNotes || '';
        
        PublicProfile.updatePhotoPreview();
        PublicProfile.updateStatus();
        PublicProfile.updateVisibilityButtons();
    },
    
    // Sauvegarde le formulaire dans le profil actuel
    saveFormToCurrentProfile: () => {
        if(PublicProfile.currentProfileIndex < 0) return;
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        
        // Type
        profile.type = document.getElementById('profile-type-actor').checked ? 'actor' : 
                       document.getElementById('profile-type-crew').checked ? 'crew' : 
                       document.getElementById('profile-type-association').checked ? 'association' :
                       document.getElementById('profile-type-enterprise').checked ? 'enterprise' : '';
        
        // Identit√©
        profile.photo = document.getElementById('profile-photo').value.trim();
        profile.name = document.getElementById('profile-name').value.trim();
        profile.gender = document.getElementById('profile-gender').value;
        profile.phone = document.getElementById('profile-phone').value.trim();
        profile.city = document.getElementById('profile-city').value.trim();
        profile.address = document.getElementById('profile-address')?.value.trim() || '';
        profile.hideAddress = document.getElementById('profile-hide-address')?.checked || false;
        profile.hideAddressInProjects = document.getElementById('profile-hide-address-projects')?.checked || false;
        profile.website = document.getElementById('profile-website').value.trim();
        profile.bio = document.getElementById('profile-bio').value.trim();
        
        // Com√©dien
        if(profile.type === 'actor') {
            profile.galleryPhotos = [
                document.getElementById('gallery-input-0')?.value.trim() || '',
                document.getElementById('gallery-input-1')?.value.trim() || '',
                document.getElementById('gallery-input-2')?.value.trim() || ''
            ].filter(url => url);
            profile.height = document.getElementById('profile-height')?.value || '';
            profile.weight = document.getElementById('profile-weight')?.value || '';
            profile.age = document.getElementById('profile-age')?.value || '';
            profile.eyeColor = document.getElementById('profile-eyes')?.value || '';
            profile.hairColor = document.getElementById('profile-hair-color')?.value || '';
            profile.hairLength = document.getElementById('profile-hair-length')?.value || '';
            profile.ethnicity = document.getElementById('profile-ethnicity')?.value || '';
            profile.corpulence = document.getElementById('profile-corpulence')?.value || '';
            // Sports et langues avec niveaux (le champ cach√© est mis √† jour automatiquement)
            profile.sports = document.getElementById('profile-sports')?.value.trim() || '';
            profile.languages = document.getElementById('profile-languages')?.value.trim() || '';
            // Note: languagesWithLevels et sportsWithLevels sont d√©j√† dans l'objet profile
            profile.demoreel = document.getElementById('profile-demoreel')?.value.trim() || '';
        }
        
        // Technicien
        if(profile.type === 'crew') {
            profile.department = document.getElementById('profile-department')?.value || '';
            const roleSelect = document.getElementById('profile-role')?.value || '';
            const roleCustom = document.getElementById('profile-role-custom')?.value.trim() || '';
            profile.role = (roleSelect === 'Autre' && roleCustom) ? roleCustom : roleSelect;
            profile.cameras = PublicProfile.equipment.cameras;
            profile.lenses = PublicProfile.equipment.lenses;
            profile.lights = PublicProfile.equipment.lights;
            profile.sounds = PublicProfile.equipment.sounds;
            profile.grips = PublicProfile.equipment.grips;
            profile.makeups = PublicProfile.equipment.makeups;
            profile.otherEquipment = PublicProfile.equipment.other;
            profile.demoreel = document.getElementById('profile-crew-demoreel')?.value.trim() || '';
            profile.crewGalleryPhotos = [
                document.getElementById('crew-gallery-input-0')?.value.trim() || '',
                document.getElementById('crew-gallery-input-1')?.value.trim() || '',
                document.getElementById('crew-gallery-input-2')?.value.trim() || ''
            ].filter(url => url);
        }
        
        // Association
        if(profile.type === 'association') {
            profile.assoName = document.getElementById('profile-asso-name')?.value.trim() || '';
            profile.assoType = document.getElementById('profile-asso-type')?.value || '';
            profile.assoSiret = document.getElementById('profile-asso-siret')?.value.trim() || '';
            profile.assoMembers = document.getElementById('profile-asso-members')?.value || '';
            profile.assoYear = document.getElementById('profile-asso-year')?.value || '';
            profile.assoPresident = document.getElementById('profile-asso-president')?.value.trim() || '';
            profile.assoMission = document.getElementById('profile-asso-mission')?.value.trim() || '';
            profile.assoActivities = document.getElementById('profile-asso-activities')?.value.trim() || '';
            profile.assoServices = {
                formation: document.getElementById('asso-service-formation')?.checked || false,
                ateliers: document.getElementById('asso-service-ateliers')?.checked || false,
                networking: document.getElementById('asso-service-networking')?.checked || false,
                casting: document.getElementById('asso-service-casting')?.checked || false,
                materiel: document.getElementById('asso-service-materiel')?.checked || false,
                production: document.getElementById('asso-service-production')?.checked || false,
                diffusion: document.getElementById('asso-service-diffusion')?.checked || false
            };
            profile.assoFacebook = document.getElementById('profile-asso-facebook')?.value.trim() || '';
            profile.assoInstagram = document.getElementById('profile-asso-instagram')?.value.trim() || '';
            profile.assoYoutube = document.getElementById('profile-asso-youtube')?.value.trim() || '';
            profile.assoLinkedin = document.getElementById('profile-asso-linkedin')?.value.trim() || '';
            profile.assoDemoreel = document.getElementById('profile-asso-demoreel')?.value.trim() || '';
            // Utiliser le nom de l'asso comme nom du profil
            profile.name = profile.assoName || profile.name;
        }
        
        // Entreprise
        if(profile.type === 'enterprise') {
            profile.entName = document.getElementById('profile-ent-name')?.value.trim() || '';
            profile.entType = document.getElementById('profile-ent-type')?.value || '';
            profile.entSiret = document.getElementById('profile-ent-siret')?.value.trim() || '';
            profile.entLegal = document.getElementById('profile-ent-legal')?.value || '';
            profile.entYear = document.getElementById('profile-ent-year')?.value || '';
            profile.entEmployees = document.getElementById('profile-ent-employees')?.value || '';
            profile.entDirector = document.getElementById('profile-ent-director')?.value.trim() || '';
            profile.entContact = document.getElementById('profile-ent-contact')?.value.trim() || '';
            profile.entDescription = document.getElementById('profile-ent-description')?.value.trim() || '';
            profile.entServices = document.getElementById('profile-ent-services')?.value.trim() || '';
            profile.entSpecialties = {
                fiction: document.getElementById('ent-spec-fiction')?.checked || false,
                doc: document.getElementById('ent-spec-doc')?.checked || false,
                pub: document.getElementById('ent-spec-pub')?.checked || false,
                corporate: document.getElementById('ent-spec-corporate')?.checked || false,
                clip: document.getElementById('ent-spec-clip')?.checked || false,
                event: document.getElementById('ent-spec-event')?.checked || false,
                web: document.getElementById('ent-spec-web')?.checked || false
            };
            profile.entFacebook = document.getElementById('profile-ent-facebook')?.value.trim() || '';
            profile.entInstagram = document.getElementById('profile-ent-instagram')?.value.trim() || '';
            profile.entYoutube = document.getElementById('profile-ent-youtube')?.value.trim() || '';
            profile.entLinkedin = document.getElementById('profile-ent-linkedin')?.value.trim() || '';
            profile.entVimeo = document.getElementById('profile-ent-vimeo')?.value.trim() || '';
            profile.entImdb = document.getElementById('profile-ent-imdb')?.value.trim() || '';
            profile.entDemoreel = document.getElementById('profile-ent-demoreel')?.value.trim() || '';
            // Utiliser le nom de l'entreprise comme nom du profil
            profile.name = profile.entName || profile.name;
        }     
        // Tarif & Dispo
        profile.dailyRate = document.getElementById('profile-rate')?.value || '';
        profile.rateCurrency = document.getElementById('profile-currency')?.value || '‚Ç¨';
        profile.rateNegotiable = document.getElementById('profile-rate-negotiable')?.checked || false;
        profile.availabilityText = document.getElementById('profile-availability')?.value.trim() || '';
        
        // Types de collaboration
        PublicProfile.saveCollabTypes(profile);
        
        // V√©hicule
        profile.hasVehicle = document.getElementById('profile-has-vehicle')?.checked || false;
        profile.vehicleType = document.getElementById('profile-vehicle-type')?.value.trim() || '';
        profile.vehiclePlate = document.getElementById('profile-vehicle-plate')?.value.trim() || '';
        profile.vehicleSeats = document.getElementById('profile-vehicle-seats')?.value || '';
        profile.vehicleTrunk = document.getElementById('profile-vehicle-trunk')?.checked || false;
        profile.vehicleNotes = document.getElementById('profile-vehicle-notes')?.value.trim() || '';
        
        // Statut
        profile.profileComplete = !!(profile.name && profile.phone && profile.city && profile.gender && profile.type);
        profile.updatedAt = new Date().toISOString();
    },
    
    // Change le type de profil (com√©dien/technicien)
    onProfileTypeChange: () => {
        const isActor = document.getElementById('profile-type-actor')?.checked || false;
        const isCrew = document.getElementById('profile-type-crew')?.checked || false;
        const isAssociation = document.getElementById('profile-type-association')?.checked || false;
        const isEnterprise = document.getElementById('profile-type-enterprise')?.checked || false;
        
        // Mettre en surbrillance la s√©lection
        document.getElementById('profile-type-actor-label').style.borderColor = isActor ? 'var(--primary)' : 'var(--border)';
        document.getElementById('profile-type-crew-label').style.borderColor = isCrew ? 'var(--primary)' : 'var(--border)';
        document.getElementById('profile-type-association-label').style.borderColor = isAssociation ? 'var(--primary)' : 'var(--border)';
        document.getElementById('profile-type-enterprise-label').style.borderColor = isEnterprise ? 'var(--primary)' : 'var(--border)';
        
        // Afficher/masquer les sections
        document.getElementById('profile-actor-section').style.display = isActor ? 'block' : 'none';
        document.getElementById('profile-actor-physical-section').style.display = isActor ? 'block' : 'none';
        document.getElementById('profile-actor-demoreel-section').style.display = isActor ? 'block' : 'none';
        document.getElementById('profile-crew-section').style.display = isCrew ? 'block' : 'none';
        document.getElementById('profile-crew-gallery-section').style.display = isCrew ? 'block' : 'none';
        document.getElementById('profile-crew-demoreel-section').style.display = isCrew ? 'block' : 'none';
        document.getElementById('profile-association-section').style.display = isAssociation ? 'block' : 'none';
        document.getElementById('profile-enterprise-section').style.display = isEnterprise ? 'block' : 'none';
        
        // Mettre √† jour le mat√©riel si technicien
        if(isCrew) {
            const dept = document.getElementById('profile-department')?.value || '';
            PublicProfile.updateEquipmentForDepartment(dept);
        }
        
        // Peupler les selects pour association/entreprise
        if(isAssociation) {
            PublicProfile.populateAssoTypes();
        }
        if(isEnterprise) {
            PublicProfile.populateEntTypes();
        }
        
        // Mettre √† jour les options de confidentialit√© d'adresse
        PublicProfile.updateAddressPrivacyOptions();
    },
    
    // Recherche d'adresse avec autocompl√©tion (API adresse.data.gouv.fr)
    searchAddress: async (query) => {
        const suggestions = document.getElementById('profile-address-suggestions');
        if(!suggestions) return;
        
        if(!query || query.length < 3) {
            suggestions.classList.remove('visible');
            return;
        }
        
        try {
            const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
            const data = await response.json();
            
            if(data.features && data.features.length > 0) {
                suggestions.innerHTML = data.features.map(f => {
                    const props = f.properties;
                    const label = props.label || '';
                    const context = props.context || '';
                    return `<div class="address-suggestion" onclick="app.PublicProfile.selectAddress('${Utils.escape(label).replace(/'/g, "\\'")}', '${props.city || ''}')">
                        <div class="address-suggestion-main">${Utils.escape(props.name || label.split(',')[0])}</div>
                        <div class="address-suggestion-secondary">${Utils.escape(context)}</div>
                    </div>`;
                }).join('');
                suggestions.classList.add('visible');
            } else {
                suggestions.innerHTML = '<div class="address-suggestion" style="color:var(--text-sec); cursor:default;">Aucun r√©sultat</div>';
                suggestions.classList.add('visible');
            }
        } catch(e) {
            console.error('Erreur recherche adresse:', e);
            suggestions.classList.remove('visible');
        }
    },
    
    // S√©lectionner une adresse
    selectAddress: (address, city) => {
        document.getElementById('profile-address').value = address;
        if(city && !document.getElementById('profile-city').value) {
            document.getElementById('profile-city').value = city;
        }
        document.getElementById('profile-address-suggestions').classList.remove('visible');
    },
    
    // Met √† jour les options de confidentialit√© selon le type de profil
    updateAddressPrivacyOptions: () => {
        const isActor = document.getElementById('profile-type-actor')?.checked || false;
        const isCrew = document.getElementById('profile-type-crew')?.checked || false;
        const isAssociation = document.getElementById('profile-type-association')?.checked || false;
        const isEnterprise = document.getElementById('profile-type-enterprise')?.checked || false;
        
        const privacyDiv = document.getElementById('profile-address-privacy');
        const hideAddressLabel = document.getElementById('profile-hide-address-label');
        const hideAddressProjectsLabel = document.getElementById('profile-hide-address-projects-label');
        const addressInfo = document.getElementById('profile-address-info');
        
        if(!privacyDiv) return;
        
        // Afficher le bloc de confidentialit√©
        privacyDiv.style.display = 'flex';
        
        if(isActor || isCrew) {
            // Com√©diens/Techniciens : adresse toujours masqu√©e dans l'Univers, option pour projets
            hideAddressLabel.style.display = 'none';
            hideAddressProjectsLabel.style.display = 'flex';
            addressInfo.style.display = 'block';
        } else if(isAssociation || isEnterprise) {
            // Associations/Entreprises : choix de masquer ou non
            hideAddressLabel.style.display = 'flex';
            hideAddressProjectsLabel.style.display = 'none';
            addressInfo.style.display = 'none';
        } else {
            privacyDiv.style.display = 'none';
        }
    },
    
    // Peuple les types d'association
    populateAssoTypes: () => {
        const select = document.getElementById('profile-asso-type');
        if(!select || select.options.length > 1) return;
        
        CONFIG.associationTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type.id;
            opt.textContent = type.name;
            select.appendChild(opt);
        });
    },
    
    // Peuple les types d'entreprise
    populateEntTypes: () => {
        const select = document.getElementById('profile-ent-type');
        if(!select || select.options.length > 1) return;
        
        CONFIG.enterpriseTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type.id;
            opt.textContent = type.name;
            select.appendChild(opt);
        });
    },
	
    // Met √† jour les checkboxes de mat√©riel selon le d√©partement
    updateEquipmentForDepartment: (dept) => {
        // Ne rien cocher automatiquement - l'utilisateur choisit lui-m√™me
    },
	
	updateRoleOptions: () => {
        const deptSelect = document.getElementById('profile-department');
        const roleSelect = document.getElementById('profile-role');
        const roleCustom = document.getElementById('profile-role-custom');
        
        const deptId = deptSelect.value;
        roleSelect.innerHTML = '<option value="">-- Fonction * --</option>';
        roleCustom.style.display = 'none';
        roleCustom.value = '';
        
        if(deptId && CONFIG.crewRoles[deptId]) {
            CONFIG.crewRoles[deptId].forEach(role => {
                const opt = document.createElement('option');
                opt.value = role;
                opt.textContent = role;
                roleSelect.appendChild(opt);
            });
        }
        
        // Mettre √† jour les sections de mat√©riel selon le d√©partement
        PublicProfile.updateEquipmentForDepartment(deptId);
    },
    
    onRoleChange: () => {
        const roleSelect = document.getElementById('profile-role');
        const roleCustom = document.getElementById('profile-role-custom');
        
        if(roleSelect.value === 'Autre') {
            roleCustom.style.display = 'block';
            roleCustom.focus();
        } else {
            roleCustom.style.display = 'none';
            roleCustom.value = '';
        }
    },
	
    showTab: (tab) => {
        const profileContent = document.getElementById('profile-content');
        const messagesContent = document.getElementById('messages-content');
        const profileTabBtn = document.getElementById('profile-tab-btn');
        const messagesTabBtn = document.getElementById('messages-tab-btn');
        
        if(tab === 'profile') {
            profileContent.style.display = 'block';
            messagesContent.style.display = 'none';
            profileTabBtn.classList.add('active');
            messagesTabBtn.classList.remove('active');
        } else {
            profileContent.style.display = 'none';
            messagesContent.style.display = 'block';
            profileTabBtn.classList.remove('active');
            messagesTabBtn.classList.add('active');
            Messages.render();
        }
    },
    
    // Charge tous les profils de l'utilisateur depuis Firebase
    pendingClaims: [],
    
    // Charge les profils en attente de revendication
    loadPendingClaims: async () => {
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        try {
            const snap = await firebase.database().ref(`pending_profile_claims/${emailKey}`).once('value');
            const claims = snap.val();
            
            if(claims) {
                PublicProfile.pendingClaims = Object.values(claims);
            } else {
                PublicProfile.pendingClaims = [];
            }
            
            PublicProfile.renderPendingClaims();
        } catch(e) {
            console.error('Erreur chargement claims:', e);
            PublicProfile.pendingClaims = [];
        }
    },
    
    // Affiche les profils √† revendiquer
    renderPendingClaims: () => {
        const section = document.getElementById('pending-claims-section');
        const list = document.getElementById('pending-claims-list');
        
        if(!section || !list) return;
        
        if(PublicProfile.pendingClaims.length === 0) {
            section.style.display = 'none';
            return;
        }
        
        section.style.display = 'block';
        
        list.innerHTML = PublicProfile.pendingClaims.map(claim => {
            const typeIcon = claim.type === 'actor' ? 'üé≠' : 'üé•';
            const typeLabel = claim.type === 'actor' ? 'Com√©dien¬∑ne' : 'Technicien¬∑ne';
            
            return `
                <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 15px;">
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden;">
                        ${claim.photo ? `<img src="${claim.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : typeIcon}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold;">${Utils.escape(claim.name)}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">${typeLabel} ‚Ä¢ Cr√©√© par ${Utils.escape(claim.createdByName)} pour "${Utils.escape(claim.projectTitle)}"</div>
                    </div>
                    <button onclick="app.PublicProfile.claimProfile('${claim.id}')" style="padding: 10px 20px; background: white; color: #764ba2; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                        ‚ú® Revendiquer
                    </button>
                    <button onclick="app.PublicProfile.rejectClaim('${claim.id}')" style="padding: 10px 15px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer;" title="Ignorer">
                        ‚úñ
                    </button>
                </div>
            `;
        }).join('');
    },
    
    // Revendique un profil et le transforme en profil propre
    claimProfile: async (claimId) => {
        const claim = PublicProfile.pendingClaims.find(c => c.id === claimId);
        if(!claim) return;
        
        if(!await ConfirmModal.show({ title: 'Revendiquer ce profil ?', message: `Le profil "${claim.name}" deviendra votre profil public que vous pourrez compl√©ter.`, icon: '‚úã', confirmText: 'Revendiquer' })) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        try {
            // Cr√©er un nouveau profil √† partir du claim
            const newProfile = {
                id: 'profile_' + Date.now(),
                type: claim.type,
                name: claim.name,
                email: state.currentUser.email,
                phone: claim.phone || '',
                photo: claim.photo || '',
                bio: claim.bio || '',
                gender: claim.gender || '',
                city: '',
                // Donn√©es acteur
                height: claim.height || '',
                age: claim.age || '',
                eyeColor: claim.eyeColor || '',
                hairColor: claim.hairColor || '',
                ethnicity: claim.ethnicity || '',
                languages: claim.languages || '',
                sports: claim.sports || '',
                // Donn√©es technicien
                role: claim.role || '',
                department: claim.department || '',
                dailyRate: claim.dailyRate || '',
                rateCurrency: claim.rateCurrency || '‚Ç¨',
                // M√©tadonn√©es
                claimedFrom: claimId,
                claimedAt: new Date().toISOString(),
                originalCreator: claim.createdBy,
                profileComplete: false
            };
            
            // Ajouter aux profils
            PublicProfile.profiles.push(newProfile);
            
            // Sauvegarder dans user_profiles
            await firebase.database().ref(`user_profiles/${emailKey}/profiles`).set(PublicProfile.profiles);
            
            // Publier dans l'annuaire public
            const dbPath = claim.type === 'actor' ? 'public_actors' : 'public_crew';
            await firebase.database().ref(`${dbPath}/${newProfile.id}`).set({
                ...newProfile,
                ownerId: emailKey
            });
            
            // Mettre √† jour l'acteur/technicien dans le projet d'origine avec le lien vers le profil public
            if(claim.projectId && claim.localId) {
                const updatePath = claim.type === 'actor' 
                    ? `all_projects/${claim.projectId}/data/actors`
                    : `all_projects/${claim.projectId}/data/crew`;
                
                const projectDataSnap = await firebase.database().ref(updatePath).once('value');
                const projectData = projectDataSnap.val() || [];
                
                // Trouver l'index de l'acteur/technicien par son ID local
                const idx = projectData.findIndex(p => p.id === claim.localId);
                if(idx !== -1) {
                    await firebase.database().ref(`${updatePath}/${idx}/publicProfileId`).set(newProfile.id);
                }
            }
            
            // Supprimer le claim
            await firebase.database().ref(`pending_profile_claims/${emailKey}/${claimId}`).remove();
            PublicProfile.pendingClaims = PublicProfile.pendingClaims.filter(c => c.id !== claimId);
            
            // Rafra√Æchir l'affichage
            PublicProfile.renderPendingClaims();
            PublicProfile.renderProfileTabs();
            PublicProfile.currentProfileIndex = PublicProfile.profiles.length - 1;
            PublicProfile.loadProfileToForm(newProfile);
            document.getElementById('no-profile-message').style.display = 'none';
            document.getElementById('profile-form-container').style.display = 'block';
            
            Utils.toast(`Profil "${claim.name}" revendiqu√© ! Compl√©tez-le pour appara√Ætre dans l'Univers.`, 'success');
        } catch(e) {
            console.error('Erreur revendication:', e);
            Utils.toast('Erreur lors de la revendication', 'error');
        }
    },
    
    // Rejette/ignore un claim
    rejectClaim: async (claimId) => {
        if(!await ConfirmModal.show({ title: 'Ignorer ce profil ?', message: 'Ce profil ne vous sera plus propos√©.', icon: 'üö´', confirmText: 'Ignorer' })) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        try {
            await firebase.database().ref(`pending_profile_claims/${emailKey}/${claimId}`).remove();
            PublicProfile.pendingClaims = PublicProfile.pendingClaims.filter(c => c.id !== claimId);
            PublicProfile.renderPendingClaims();
            Utils.toast('Profil ignor√©.', 'info');
        } catch(e) {
            console.error('Erreur:', e);
        }
    },
    
    loadProfiles: async () => {
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        try {
            // Charger la liste des profils depuis user_profiles
            const profilesSnap = await firebase.database().ref(`user_profiles/${emailKey}/profiles`).once('value');
            const savedProfiles = profilesSnap.val();
            
            if(savedProfiles && Array.isArray(savedProfiles) && savedProfiles.length > 0) {
                PublicProfile.profiles = savedProfiles;
            } else {
                // Migration : essayer de charger les anciens profils
                PublicProfile.profiles = [];
                
                // V√©rifier s'il y a un ancien profil acteur
                const actorSnap = await firebase.database().ref(`public_actors/${emailKey}`).once('value');
                const actorData = actorSnap.val();
                if(actorData && actorData.name) {
                    actorData.id = actorData.id || 'profile_actor_' + Date.now();
                    actorData.type = 'actor';
                    PublicProfile.profiles.push(actorData);
                }
                
                // V√©rifier s'il y a un ancien profil technicien
                const crewSnap = await firebase.database().ref(`public_crew/${emailKey}`).once('value');
                const crewData = crewSnap.val();
                if(crewData && crewData.name) {
                    crewData.id = crewData.id || 'profile_crew_' + Date.now();
                    crewData.type = 'crew';
                    PublicProfile.profiles.push(crewData);
                }
            }
        } catch(e) {
            console.error('Erreur chargement profils:', e);
            PublicProfile.profiles = [];
        }
    },
    
    // Ancienne fonction load pour compatibilit√©
    load: async () => {
        await PublicProfile.loadProfiles();
    },
    
    // Sauvegarde le profil actuel
    saveCurrentProfile: async () => {
        if(PublicProfile.currentProfileIndex < 0) {
            Utils.toast('Aucun profil √† sauvegarder. Cr√©ez d\'abord un profil.', 'warning');
            return;
        }
        
        // Sauvegarder le formulaire dans l'objet profil
        PublicProfile.saveFormToCurrentProfile();
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        
        if(!profile.type) {
            Utils.toast('Veuillez choisir un type de profil.', 'warning');
            return;
        }
        
        // Validation selon le type
        if(profile.type === 'actor' || profile.type === 'crew') {
            if(!profile.name || !profile.phone || !profile.city || !profile.gender) {
                Utils.toast('Veuillez remplir les champs obligatoires (Nom, Sexe, T√©l√©phone, Ville).', 'warning');
                return;
            }
        } else if(profile.type === 'association') {
            if(!profile.assoName || !profile.assoType || !profile.assoMission || !profile.city || !profile.phone) {
                Utils.toast('Veuillez remplir les champs obligatoires (Nom, Type, Mission, Ville, T√©l√©phone).', 'warning');
                return;
            }
        } else if(profile.type === 'enterprise') {
            if(!profile.entName || !profile.entType || !profile.entDescription || !profile.city || !profile.phone) {
                Utils.toast('Veuillez remplir les champs obligatoires (Nom, Type, Description, Ville, T√©l√©phone).', 'warning');
                return;
            }
        }
        
        const btn = document.querySelector('button[onclick="app.PublicProfile.saveCurrentProfile()"]');
        const originalText = btn ? btn.innerHTML : '';
        if(btn) { btn.innerHTML = '<span class="spinner"></span>Sauvegarde...'; btn.classList.add('btn-loading'); }
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        try {
            // Sauvegarder dans la base appropri√©e selon le type
            const dbPathMap = {
                'actor': 'public_actors',
                'crew': 'public_crew',
                'association': 'public_associations',
                'enterprise': 'public_enterprises'
            };
            const dbPath = dbPathMap[profile.type] || 'public_crew';
            
            const dataToSave = {
                ...profile,
                id: profile.id,
                ownerId: emailKey,
                email: state.currentUser.email,
                type: profile.type,
                profileComplete: profile.profileComplete
            };
            
            await firebase.database().ref(`${dbPath}/${profile.id}`).set(dataToSave);
            
            // Sauvegarder la liste des profils dans user_profiles
            await firebase.database().ref(`user_profiles/${emailKey}/profiles`).set(PublicProfile.profiles);
            
            // Mettre √† jour state.userProfile pour le bouton du dashboard
            if(profile.profileComplete) {
                state.userProfile = state.userProfile || {};
                state.userProfile.profileComplete = true;
                // Sauvegarder dans Firebase pour persister
                await firebase.database().ref(`user_profiles/${emailKey}/profileComplete`).set(true);
            }
            
            PublicProfile.renderProfileTabs();
            PublicProfile.updateStatus();
            if(btn) { btn.innerHTML = originalText; btn.classList.remove('btn-loading'); }
            Utils.toast('Profil sauvegard√© !', 'success');
        } catch(e) {
            if(btn) { btn.innerHTML = originalText; btn.classList.remove('btn-loading'); }
            Utils.toast('Erreur lors de la sauvegarde', 'error');
        }
    },
    
    // Supprime le profil actuel
    deleteCurrentProfile: async () => {
        if(PublicProfile.currentProfileIndex < 0) return;
        
        if(!await ConfirmModal.confirmDelete("Cette action est irr√©versible.", "Supprimer ce profil ?")) return;
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        try {
            // Supprimer de Firebase
            const dbPathMap = {
                'actor': 'public_actors',
                'crew': 'public_crew',
                'association': 'public_associations',
                'enterprise': 'public_enterprises'
            };
            const dbPath = dbPathMap[profile.type];
            if(dbPath) {
                await firebase.database().ref(`${dbPath}/${profile.id}`).remove();
            }
            
            // Supprimer du tableau local
            PublicProfile.profiles.splice(PublicProfile.currentProfileIndex, 1);
            
            // Sauvegarder la liste mise √† jour
            await firebase.database().ref(`user_profiles/${emailKey}/profiles`).set(PublicProfile.profiles);
            
            // Afficher un autre profil ou le message vide
            if(PublicProfile.profiles.length > 0) {
                PublicProfile.currentProfileIndex = 0;
                PublicProfile.renderProfileTabs();
                PublicProfile.loadProfileToForm(PublicProfile.profiles[0]);
            } else {
                PublicProfile.currentProfileIndex = -1;
                PublicProfile.renderProfileTabs();
                document.getElementById('no-profile-message').style.display = 'block';
                document.getElementById('profile-form-container').style.display = 'none';
            }
            
            Utils.toast('Profil supprim√©.', 'success');
        } catch(e) {
            console.error('Erreur suppression profil:', e);
            Utils.toast('Erreur lors de la suppression', 'error');
        }
    },
    
    // Ancienne fonction save conserv√©e pour compatibilit√©
    save: async () => {
        await PublicProfile.saveCurrentProfile();
    },
    
    updatePhotoPreview: () => {
        const url = document.getElementById('profile-photo').value.trim();
        const preview = document.getElementById('profile-photo-preview');
        if(url) {
            preview.innerHTML = `<img src="${url}" alt="Photo" onerror="this.parentElement.innerHTML='üë§'">`;
        } else {
            preview.innerHTML = 'üë§';
        }
    },
    
    updateStatus: () => {
        const name = document.getElementById('profile-name').value.trim();
        const phone = document.getElementById('profile-phone').value.trim();
        const city = document.getElementById('profile-city').value.trim();
        const gender = document.getElementById('profile-gender').value;
        
        const isComplete = name && phone && city && gender;
        const statusDiv = document.getElementById('profile-status');
        
        if(isComplete) {
            statusDiv.className = 'profile-status complete';
            statusDiv.innerHTML = '‚úÖ Votre profil est complet et visible dans les recherches !';
        } else {
            statusDiv.className = 'profile-status incomplete';
            const missing = [];
            if(!name) missing.push('nom');
            if(!gender) missing.push('sexe');
            if(!phone) missing.push('t√©l√©phone');
            if(!city) missing.push('ville');
            statusDiv.innerHTML = `‚ö†Ô∏è Profil incomplet. Champs manquants : ${missing.join(', ')}`;
        }
    },
    
    addEquipment: (type) => {
        let value = '';
        let list = [];
        let listId = '';
        
        if(type === 'camera') {
            value = document.getElementById('profile-camera-select').value;
            list = PublicProfile.equipment.cameras;
            listId = 'camera-list';
            document.getElementById('profile-camera-select').value = '';
        } else if(type === 'lens') {
            value = document.getElementById('profile-lens-select').value;
            list = PublicProfile.equipment.lenses;
            listId = 'lens-list';
            document.getElementById('profile-lens-select').value = '';
        } else if(type === 'light') {
            value = document.getElementById('profile-light-select').value;
            list = PublicProfile.equipment.lights;
            listId = 'light-list';
            document.getElementById('profile-light-select').value = '';
        } else if(type === 'sound') {
            value = document.getElementById('profile-sound-select').value;
            list = PublicProfile.equipment.sounds;
            listId = 'sound-list';
            document.getElementById('profile-sound-select').value = '';
        } else if(type === 'grip') {
            value = document.getElementById('profile-grip-select').value;
            list = PublicProfile.equipment.grips;
            listId = 'grip-list';
            document.getElementById('profile-grip-select').value = '';
        } else if(type === 'makeup') {
            value = document.getElementById('profile-makeup-select').value;
            list = PublicProfile.equipment.makeups;
            listId = 'makeup-list';
            document.getElementById('profile-makeup-select').value = '';
        } else if(type === 'other') {
            value = document.getElementById('profile-other-equipment').value.trim();
            list = PublicProfile.equipment.other;
            listId = 'other-equipment-list';
            document.getElementById('profile-other-equipment').value = '';
        }
        
        if(value && !list.includes(value)) {
            list.push(value);
            PublicProfile.renderEquipment();
        }
    },
    
    removeEquipment: (type, index) => {
        if(type === 'camera') {
            PublicProfile.equipment.cameras.splice(index, 1);
        } else if(type === 'lens') {
            PublicProfile.equipment.lenses.splice(index, 1);
        } else if(type === 'light') {
            PublicProfile.equipment.lights.splice(index, 1);
        } else if(type === 'sound') {
            PublicProfile.equipment.sounds.splice(index, 1);
        } else if(type === 'grip') {
            PublicProfile.equipment.grips.splice(index, 1);
        } else if(type === 'makeup') {
            PublicProfile.equipment.makeups.splice(index, 1);
        } else if(type === 'other') {
            PublicProfile.equipment.other.splice(index, 1);
        }
        PublicProfile.renderEquipment();
    },
    
    renderEquipment: () => {
        // Cam√©ras
        const cameraList = document.getElementById('camera-list');
        if(cameraList) {
            cameraList.innerHTML = PublicProfile.equipment.cameras.map((c, i) => 
                `<div class="equipment-tag">üì∑ ${c} <span class="remove" onclick="app.PublicProfile.removeEquipment('camera', ${i})">‚úñ</span></div>`
            ).join('');
        }
        
        // Objectifs
        const lensList = document.getElementById('lens-list');
        if(lensList) {
            lensList.innerHTML = PublicProfile.equipment.lenses.map((l, i) => 
                `<div class="equipment-tag">üî≠ ${l} <span class="remove" onclick="app.PublicProfile.removeEquipment('lens', ${i})">‚úñ</span></div>`
            ).join('');
        }
        
        // Lumi√®re
        const lightList = document.getElementById('light-list');
        if(lightList) {
            lightList.innerHTML = PublicProfile.equipment.lights.map((l, i) => 
                `<div class="equipment-tag">üí° ${l} <span class="remove" onclick="app.PublicProfile.removeEquipment('light', ${i})">‚úñ</span></div>`
            ).join('');
        }
        
        // Son
        const soundList = document.getElementById('sound-list');
        if(soundList) {
            soundList.innerHTML = PublicProfile.equipment.sounds.map((s, i) => 
                `<div class="equipment-tag">üé§ ${s} <span class="remove" onclick="app.PublicProfile.removeEquipment('sound', ${i})">‚úñ</span></div>`
            ).join('');
        }
        
        // Machinerie
        const gripList = document.getElementById('grip-list');
        if(gripList) {
            gripList.innerHTML = PublicProfile.equipment.grips.map((g, i) => 
                `<div class="equipment-tag">üé¨ ${g} <span class="remove" onclick="app.PublicProfile.removeEquipment('grip', ${i})">‚úñ</span></div>`
            ).join('');
        }
        
        // Maquillage
        const makeupList = document.getElementById('makeup-list');
        if(makeupList) {
            makeupList.innerHTML = PublicProfile.equipment.makeups.map((m, i) => 
                `<div class="equipment-tag">üíÑ ${m} <span class="remove" onclick="app.PublicProfile.removeEquipment('makeup', ${i})">‚úñ</span></div>`
            ).join('');
        }
        
        // Autre
        const otherList = document.getElementById('other-equipment-list');
        if(otherList) {
            otherList.innerHTML = PublicProfile.equipment.other.map((o, i) => 
                `<div class="equipment-tag">üîß ${o} <span class="remove" onclick="app.PublicProfile.removeEquipment('other', ${i})">‚úñ</span></div>`
            ).join('');
        }
    },
    
    // ========== CALENDRIER DISPONIBILIT√âS PROFIL ==========
    _profileCalMonth: new Date().getMonth(),
    _profileCalYear: new Date().getFullYear(),
    _profileCalDrag: { active: false, dates: [], isRightClick: false },
    
    renderProfileCalendar: () => {
        const container = document.getElementById('profile-availability-calendar');
        if(!container) return;
        
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        const year = PublicProfile._profileCalYear;
        const month = PublicProfile._profileCalMonth;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        
        const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        
        const availDates = profile.availabilityDates || [];
        const unavailDates = profile.unavailabilityDates || [];
        
        const isDateInRange = (dateStr, ranges) => {
            return ranges.some(range => {
                if(!range.from || !range.to) return false;
                return dateStr >= range.from && dateStr <= range.to;
            });
        };
        
        let html = `<div class="availability-calendar">
            <div class="availability-calendar-header">
                <button onclick="app.PublicProfile.changeProfileCalMonth(-1)">‚óÄ</button>
                <strong>${monthNames[month]} ${year}</strong>
                <button onclick="app.PublicProfile.changeProfileCalMonth(1)">‚ñ∂</button>
            </div>
            <div class="availability-calendar-grid">`;
        
        dayNames.forEach(d => {
            html += `<div class="availability-calendar-day-header">${d}</div>`;
        });
        
        for(let i = 0; i < startDay; i++) {
            html += `<div class="availability-calendar-day empty"></div>`;
        }
        
        const today = new Date();
        for(let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
            const isAvail = isDateInRange(dateStr, availDates);
            const isUnavail = isDateInRange(dateStr, unavailDates);
            
            let dayClass = 'availability-calendar-day';
            if(isToday) dayClass += ' today';
            if(isAvail) dayClass += ' available';
            if(isUnavail) dayClass += ' unavailable';
            
            html += `<div class="${dayClass}" 
                data-date="${dateStr}"
                onmousedown="app.PublicProfile.startProfileCalDrag('${dateStr}', event)"
                onmouseenter="app.PublicProfile.continueProfileCalDrag('${dateStr}')"
                onmouseup="app.PublicProfile.endProfileCalDrag()"
                oncontextmenu="return false;">${day}</div>`;
        }
        
        html += `</div></div>`;
        container.innerHTML = html;
    },
    
    changeProfileCalMonth: (delta) => {
        PublicProfile._profileCalMonth += delta;
        if(PublicProfile._profileCalMonth > 11) {
            PublicProfile._profileCalMonth = 0;
            PublicProfile._profileCalYear++;
        }
        if(PublicProfile._profileCalMonth < 0) {
            PublicProfile._profileCalMonth = 11;
            PublicProfile._profileCalYear--;
        }
        PublicProfile.renderProfileCalendar();
    },
    
    startProfileCalDrag: (dateStr, event) => {
        event.preventDefault();
        const isRightClick = event.button === 2;
        PublicProfile._profileCalDrag = { active: true, dates: [dateStr], isRightClick };
        document.addEventListener('mouseup', PublicProfile.endProfileCalDrag);
    },
    
    continueProfileCalDrag: (dateStr) => {
        if(!PublicProfile._profileCalDrag.active) return;
        if(!PublicProfile._profileCalDrag.dates.includes(dateStr)) {
            PublicProfile._profileCalDrag.dates.push(dateStr);
        }
        const container = document.getElementById('profile-availability-calendar');
        if(container) {
            const color = PublicProfile._profileCalDrag.isRightClick ? '#f44336' : '#4CAF50';
            container.querySelectorAll('.availability-calendar-day').forEach(el => {
                if(PublicProfile._profileCalDrag.dates.includes(el.dataset.date)) {
                    el.style.background = color;
                    el.style.color = 'white';
                }
            });
        }
    },
    
    endProfileCalDrag: () => {
        if(!PublicProfile._profileCalDrag.active) return;
        
        const { dates, isRightClick } = PublicProfile._profileCalDrag;
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        
        if(dates.length > 0 && profile) {
            dates.sort();
            const from = dates[0];
            const to = dates[dates.length - 1];
            
            if(!profile.availabilityDates) profile.availabilityDates = [];
            if(!profile.unavailabilityDates) profile.unavailabilityDates = [];
            
            const targetArray = isRightClick ? profile.unavailabilityDates : profile.availabilityDates;
            const otherArray = isRightClick ? profile.availabilityDates : profile.unavailabilityDates;
            
            if(dates.length === 1) {
                const existingIdx = targetArray.findIndex(range => {
                    const checkDate = new Date(dates[0]);
                    return checkDate >= new Date(range.from) && checkDate <= new Date(range.to);
                });
                if(existingIdx > -1) {
                    targetArray.splice(existingIdx, 1);
                } else {
                    const otherIdx = otherArray.findIndex(range => {
                        const checkDate = new Date(dates[0]);
                        return checkDate >= new Date(range.from) && checkDate <= new Date(range.to);
                    });
                    if(otherIdx > -1) {
                        otherArray.splice(otherIdx, 1);
                    }
                    targetArray.push({ from, to });
                }
            } else {
                targetArray.push({ from, to });
            }
            
            PublicProfile.renderProfileCalendar();
            PublicProfile.renderProfileDatesList();
        }
        
        PublicProfile._profileCalDrag = { active: false, dates: [], isRightClick: false };
        document.removeEventListener('mouseup', PublicProfile.endProfileCalDrag);
    },
    
    renderProfileDatesList: () => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        const availList = document.getElementById('profile-avail-dates-list');
        const unavailList = document.getElementById('profile-unavail-dates-list');
        
        if(availList) {
            const availDates = profile.availabilityDates || [];
            if(availDates.length > 0) {
                availList.innerHTML = availDates.map((d, i) => 
                    `<span style="display:inline-flex; align-items:center; background:#E8F5E9; border:1px solid #4CAF50; color:#2E7D32; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">‚úì ${d.from} ‚Üí ${d.to} <span onclick="app.PublicProfile.removeProfileDate('avail', ${i})" style="cursor:pointer; color:var(--danger); margin-left:5px;">‚úñ</span></span>`
                ).join('');
            } else {
                availList.innerHTML = '<span style="color:var(--text-sec); font-size:0.8rem;">Aucune p√©riode renseign√©e</span>';
            }
        }
        
        if(unavailList) {
            const unavailDates = profile.unavailabilityDates || [];
            if(unavailDates.length > 0) {
                unavailList.innerHTML = unavailDates.map((d, i) => 
                    `<span style="display:inline-flex; align-items:center; background:#FFEBEE; border:1px solid #f44336; color:#C62828; padding:3px 8px; border-radius:4px; margin:2px; font-size:0.8rem;">‚úó ${d.from} ‚Üí ${d.to} <span onclick="app.PublicProfile.removeProfileDate('unavail', ${i})" style="cursor:pointer; color:var(--danger); margin-left:5px;">‚úñ</span></span>`
                ).join('');
            } else {
                unavailList.innerHTML = '<span style="color:var(--text-sec); font-size:0.8rem;">Aucune p√©riode renseign√©e</span>';
            }
        }
    },
    
    removeProfileDate: (type, idx) => {
        const profile = PublicProfile.profiles[PublicProfile.currentProfileIndex];
        if(!profile) return;
        
        if(type === 'avail' && profile.availabilityDates) {
            profile.availabilityDates.splice(idx, 1);
        } else if(type === 'unavail' && profile.unavailabilityDates) {
            profile.unavailabilityDates.splice(idx, 1);
        }
        
        PublicProfile.renderProfileCalendar();
        PublicProfile.renderProfileDatesList();
    },
    
    // Met √† jour le style des labels de collaboration
    updateCollabLabel: (type) => {
        const labels = {
            'pro': { id: 'label-collab-pro', checkId: 'profile-collab-pro', color: '#4CAF50' },
            'semi': { id: 'label-collab-semi', checkId: 'profile-collab-semi', color: '#FF9800' },
            'benevole': { id: 'label-collab-benevole', checkId: 'profile-collab-benevole', color: '#E91E63' }
        };
        
        const info = labels[type];
        if(!info) return;
        
        const label = document.getElementById(info.id);
        const checkbox = document.getElementById(info.checkId);
        
        if(label && checkbox) {
            if(checkbox.checked) {
                label.style.background = info.color;
                label.style.color = 'white';
            } else {
                label.style.background = 'var(--bg)';
                label.style.color = 'var(--text-main)';
            }
        }
    },
    
    // Charge les checkboxes de collaboration depuis le profil
    loadCollabTypes: (profile) => {
        const collabTypes = profile.collabTypes || [];
        
        const proCheck = document.getElementById('profile-collab-pro');
        const semiCheck = document.getElementById('profile-collab-semi');
        const benevoleCheck = document.getElementById('profile-collab-benevole');
        
        if(proCheck) proCheck.checked = collabTypes.includes('pro');
        if(semiCheck) semiCheck.checked = collabTypes.includes('semi-pro');
        if(benevoleCheck) benevoleCheck.checked = collabTypes.includes('benevole');
        
        PublicProfile.updateCollabLabel('pro');
        PublicProfile.updateCollabLabel('semi');
        PublicProfile.updateCollabLabel('benevole');
    },
    
    // Sauvegarde les checkboxes de collaboration dans le profil
    saveCollabTypes: (profile) => {
        const collabTypes = [];
        
        if(document.getElementById('profile-collab-pro')?.checked) collabTypes.push('pro');
        if(document.getElementById('profile-collab-semi')?.checked) collabTypes.push('semi-pro');
        if(document.getElementById('profile-collab-benevole')?.checked) collabTypes.push('benevole');
        
        profile.collabTypes = collabTypes;
    }
};

const Chat = {
    currentChannel: null,
    channels: [
        { id: 'general', name: 'üì¢ G√©n√©ral', icon: 'üì¢', type: 'system', description: 'Tout le monde' },
        { id: 'chefs', name: 'üíº Chefs de poste', icon: 'üíº', type: 'system', description: 'R√©al, Chefs de d√©partement' },
        { id: 'technique', name: 'üîß Technique', icon: 'üîß', type: 'system', description: '√âquipe technique' },
        { id: 'comediens', name: 'üé≠ Com√©diens', icon: 'üé≠', type: 'system', description: 'Com√©diens du projet' }
    ],
    messagesListener: null,
    
    init: () => {
        Chat.loadCustomChannels();
        Chat.renderChannelsList();
        
        // S√©lectionner le canal g√©n√©ral par d√©faut
        if(!Chat.currentChannel) {
            Chat.selectChannel('general');
        }
    },
    
    loadCustomChannels: () => {
        // Charger les canaux personnalis√©s depuis les donn√©es du projet
        if(state.data.chatChannels) {
            state.data.chatChannels.forEach(ch => {
                if(!Chat.channels.find(c => c.id === ch.id)) {
                    Chat.channels.push(ch);
                }
            });
        }
    },
    
    renderChannelsList: () => {
        const container = document.getElementById('chat-channels-list');
        if(!container) return;
        
        const userEmail = state.currentUser?.email;
        const userPerms = Permissions.getCurrentUserPermissions();
        
        let html = '<div style="margin-bottom: 15px;"><div style="font-size: 0.75rem; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase;">Canaux principaux</div>';
        
        // Canaux syst√®me
        Chat.channels.filter(c => c.type === 'system').forEach(channel => {
            // V√©rifier acc√®s
            const hasAccess = Chat.canAccessChannel(channel.id);
            if(!hasAccess && state.currentRole !== 'owner') return;
            
            const isActive = Chat.currentChannel === channel.id;
            html += `
                <div class="chat-channel-item ${isActive ? 'active' : ''}" onclick="app.Chat.selectChannel('${channel.id}')" style="padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; background: ${isActive ? 'var(--primary)' : 'var(--bg)'}; color: ${isActive ? 'white' : 'var(--text-main)'};">
                    <div style="font-weight: 600;">${channel.icon} ${channel.name.replace(channel.icon + ' ', '')}</div>
                    <div style="font-size: 0.75rem; opacity: 0.7;">${channel.description}</div>
                </div>
            `;
        });
        html += '</div>';
        
        // Canaux personnalis√©s
        const customChannels = Chat.channels.filter(c => c.type === 'custom');
        if(customChannels.length > 0 || state.currentRole === 'owner') {
            html += '<div><div style="font-size: 0.75rem; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase;">Groupes personnalis√©s</div>';
            
            customChannels.forEach(channel => {
                // V√©rifier si l'utilisateur est membre
                const isMember = channel.members?.includes(Utils.sanitizeEmail(userEmail)) || state.currentRole === 'owner';
                if(!isMember) return;
                
                const isActive = Chat.currentChannel === channel.id;
                html += `
                    <div class="chat-channel-item ${isActive ? 'active' : ''}" onclick="app.Chat.selectChannel('${channel.id}')" style="padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; background: ${isActive ? 'var(--primary)' : 'var(--bg)'}; color: ${isActive ? 'white' : 'var(--text-main)'}; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">${channel.icon || 'üí¨'} ${Utils.escape(channel.name)}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">${channel.members?.length || 0} membre(s)</div>
                        </div>
                        ${state.currentRole === 'owner' ? `<button onclick="event.stopPropagation(); app.Chat.deleteChannel('${channel.id}')" style="background: none; border: none; cursor: pointer; opacity: 0.6;">üóëÔ∏è</button>` : ''}
                    </div>
                `;
            });
            html += '</div>';
        }
        
        container.innerHTML = html;
    },
    
    canAccessChannel: (channelId) => {
        if(state.currentRole === 'owner') return true;
        
        const userPerms = Permissions.getCurrentUserPermissions();
        
        switch(channelId) {
            case 'general':
                return userPerms.chat_general === 'write';
            case 'chefs':
                return userPerms.chat_chefs === 'write';
            case 'technique':
                return userPerms.chat_technique === 'write';
            case 'comediens':
                return userPerms.chat_comediens === 'write';
            default:
                // Canal personnalis√© - v√©rifier si membre
                const channel = Chat.channels.find(c => c.id === channelId);
                if(channel && channel.members) {
                    return channel.members.includes(Utils.sanitizeEmail(state.currentUser?.email));
                }
                return false;
        }
    },
    
    selectChannel: (channelId) => {
        Chat.currentChannel = channelId;
        Chat.renderChannelsList();
        
        const channel = Chat.channels.find(c => c.id === channelId);
        if(!channel) return;
        
        // Mettre √† jour le header
        document.getElementById('chat-channel-title').textContent = `${channel.icon || 'üí¨'} ${channel.name.replace(channel.icon + ' ', '')}`;
        document.getElementById('chat-members-btn').style.display = 'inline-block';
        document.getElementById('chat-input-container').style.display = 'block';
        
        // Charger les messages
        Chat.loadMessages(channelId);
        
        // Charger les membres
        Chat.loadMembers(channelId);
    },
    
    loadMessages: (channelId) => {
        const container = document.getElementById('chat-messages-container');
        container.innerHTML = '<div class="chat-empty">üîÑ Chargement...</div>';
        
        // D√©tacher l'ancien listener
        if(Chat.messagesListener) {
            Chat.messagesListener();
            Chat.messagesListener = null;
        }
        
        // √âcouter les messages en temps r√©el
        const messagesRef = firebase.database().ref(`all_projects/${state.currentProjectId}/chat/${channelId}/messages`).orderByChild('timestamp').limitToLast(100);
        
        Chat.messagesListener = messagesRef.on('value', (snapshot) => {
            const messages = [];
            if(snapshot && snapshot.exists()) {
                snapshot.forEach(child => {
                    messages.push({ id: child.key, ...child.val() });
                });
            }
            Chat.renderMessages(messages);
        }, (error) => {
            console.error('Erreur chargement messages:', error);
            Chat.renderMessages([]);
        });
    },
    
    renderMessages: (messages) => {
        const container = document.getElementById('chat-messages-container');
        const userEmail = state.currentUser?.email;
        
        if(messages.length === 0) {
            container.innerHTML = `
                <div class="chat-empty">
                    <p style="font-size: 2rem; margin-bottom: 10px;">üí¨</p>
                    <p>Aucun message dans ce canal</p>
                    <p style="font-size: 0.85rem; opacity: 0.7;">Soyez le premier √† √©crire !</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        let lastDate = null;
        
        messages.forEach(msg => {
            const msgDate = new Date(msg.timestamp).toLocaleDateString('fr-FR');
            const msgTime = new Date(msg.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const isOwn = msg.senderEmail === userEmail;
            
            // S√©parateur de date
            if(msgDate !== lastDate) {
                html += `<div class="chat-date-separator">${msgDate}</div>`;
                lastDate = msgDate;
            }
            
            html += `
                <div class="chat-message ${isOwn ? 'own' : 'other'}">
                    ${!isOwn ? `<div class="chat-message-sender">${Utils.escape(msg.senderName)}</div>` : ''}
                    <div>${Utils.escape(msg.text)}</div>
                    <div class="chat-message-time">${msgTime}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Scroll en bas
        container.scrollTop = container.scrollHeight;
    },
    
    sendMessage: async () => {
        const input = document.getElementById('chat-message-input');
        const text = input.value.trim();
        
        if(!text || !Chat.currentChannel) return;
        
        const message = {
            text: text,
            senderEmail: state.currentUser.email,
            senderName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        
        try {
            await firebase.database().ref(`all_projects/${state.currentProjectId}/chat/${Chat.currentChannel}/messages`).push(message);
            input.value = '';
        } catch(e) {
            console.error('Erreur envoi message:', e);
            Utils.toast('Erreur lors de l\'envoi du message', 'error');
        }
    },
    
    loadMembers: (channelId) => {
        const container = document.getElementById('chat-members-list');
        const addSection = document.getElementById('chat-add-member-section');
        if(!container) return;
        
        const channel = Chat.channels.find(c => c.id === channelId);
        let members = [];
        
        if(channel.type === 'system') {
            // Membres bas√©s sur les permissions + membres ajout√©s manuellement
            members = Chat.getSystemChannelMembers(channelId);
            addSection.style.display = state.currentRole === 'owner' ? 'block' : 'none';
        } else {
            // Membres du canal personnalis√©
            members = Chat.getCustomChannelMembers(channel);
            addSection.style.display = state.currentRole === 'owner' ? 'block' : 'none';
        }
        
        if(members.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-sec);">Aucun membre</div>';
            return;
        }
        
        let html = '';
        members.forEach(member => {
            const photoHTML = member.photo ? `<img src="${member.photo}">` : 'üë§';
            html += `
                <div class="chat-member-item">
                    <div class="chat-member-photo">${photoHTML}</div>
                    <div>
                        <div style="font-weight: 500; font-size: 0.9rem;">${Utils.escape(member.name)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-sec);">${Utils.escape(member.role || 'Membre')}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    getSystemChannelMembers: (channelId) => {
        const members = [];
        const ownerEmail = state.data.meta?.owner || state.currentUser?.email;
        
        // Ajouter le propri√©taire
        members.push({
            name: ownerEmail.split('@')[0],
            email: ownerEmail,
            role: 'Propri√©taire',
            photo: null
        });
        
        // Ajouter les membres ajout√©s manuellement
        const extraMembers = state.data.chatExtraMembers?.[channelId] || [];
        extraMembers.forEach(emailKey => {
            const actor = state.data.actors?.find(a => Utils.sanitizeEmail(a.email) === emailKey);
            if(actor && !members.find(m => m.email === actor.email)) {
                members.push({ name: actor.name, email: actor.email, role: 'Com√©dien.ne (ajout√©)', photo: actor.photo });
                return;
            }
            const crew = state.data.crew?.find(c => Utils.sanitizeEmail(c.email) === emailKey);
            if(crew && !members.find(m => m.email === crew.email)) {
                members.push({ name: crew.name, email: crew.email, role: (crew.role || 'Technicien') + ' (ajout√©)', photo: crew.photo });
            }
        });
        
        // Selon le canal
        if(channelId === 'general') {
            // Tout le monde
            state.data.actors?.forEach(a => {
                if(a.email && !members.find(m => m.email === a.email)) {
                    members.push({ name: a.name, email: a.email, role: 'Com√©dien.ne', photo: a.photo });
                }
            });
            state.data.crew?.forEach(c => {
                if(c.email && !members.find(m => m.email === c.email)) {
                    members.push({ name: c.name, email: c.email, role: c.role || 'Technicien', photo: c.photo });
                }
            });
        } else if(channelId === 'chefs') {
            // Chefs de poste
            state.data.crew?.forEach(c => {
                if(c.email && (c.role?.includes('Chef') || c.role?.includes('Directeur') || c.role?.includes('R√©alisateur'))) {
                    if(!members.find(m => m.email === c.email)) {
                        members.push({ name: c.name, email: c.email, role: c.role, photo: c.photo });
                    }
                }
            });
        } else if(channelId === 'technique') {
            // √âquipe technique
            state.data.crew?.forEach(c => {
                if(c.email && !members.find(m => m.email === c.email)) {
                    members.push({ name: c.name, email: c.email, role: c.role || 'Technicien', photo: c.photo });
                }
            });
        } else if(channelId === 'comediens') {
            // Com√©diens
            state.data.actors?.forEach(a => {
                if(a.email && !members.find(m => m.email === a.email)) {
                    members.push({ name: a.name, email: a.email, role: 'Com√©dien.ne', photo: a.photo });
                }
            });
        }
        
        return members;
    },
    
    getCustomChannelMembers: (channel) => {
        const members = [];
        if(!channel.members) return members;
        
        channel.members.forEach(emailKey => {
            // Chercher dans actors
            const actor = state.data.actors?.find(a => Utils.sanitizeEmail(a.email) === emailKey);
            if(actor) {
                members.push({ name: actor.name, email: actor.email, role: 'Com√©dien.ne', photo: actor.photo });
                return;
            }
            
            // Chercher dans crew
            const crew = state.data.crew?.find(c => Utils.sanitizeEmail(c.email) === emailKey);
            if(crew) {
                members.push({ name: crew.name, email: crew.email, role: crew.role || 'Technicien', photo: crew.photo });
                return;
            }
            
            // Sinon juste l'email
            members.push({ name: emailKey.replace(/,/g, '.'), email: emailKey, role: 'Membre', photo: null });
        });
        
        return members;
    },
    
    toggleMembersPanel: () => {
        const panel = document.getElementById('chat-members-panel');
        if(panel.style.display === 'none' || panel.style.display === '') {
            panel.style.display = 'flex';
        } else {
            panel.style.display = 'none';
        }
    },
    
    createCustomChannel: () => {
        if(state.currentRole !== 'owner') {
            Utils.toast('Seul le propri√©taire peut cr√©er des groupes.', 'error');
            return;
        }
        
        // Modal de cr√©ation avec nom + ic√¥ne
        const modal = document.createElement('div');
        modal.id = 'create-channel-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10001;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:400px;width:90%;">
                <h3 style="margin-top:0;">‚ûï Nouveau groupe de discussion</h3>
                <div style="margin-bottom:15px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Ic√¥ne</label>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div id="new-channel-icon" style="width:50px;height:50px;background:var(--bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:pointer;border:2px solid var(--border);">üí¨</div>
                        <button onclick="app.Utils.showIconPicker((icon) => document.getElementById('new-channel-icon').textContent = icon)" style="padding:8px 15px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Changer</button>
                    </div>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block;margin-bottom:5px;font-weight:600;">Nom du groupe</label>
                    <input type="text" id="new-channel-name" placeholder="Ex: √âquipe nuit, Cascadeurs..." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;background:var(--input-bg);color:var(--text-main);">
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:10px 20px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Annuler</button>
                    <button onclick="app.Chat.confirmCreateChannel()" style="padding:10px 20px;background:var(--success);color:white;border:none;border-radius:6px;cursor:pointer;">Cr√©er</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('new-channel-name').focus();
    },
    
    confirmCreateChannel: () => {
        const name = document.getElementById('new-channel-name').value.trim();
        const icon = document.getElementById('new-channel-icon').textContent;
        
        if(!name) {
            Utils.toast('Veuillez entrer un nom pour le groupe.', 'warning');
            return;
        }
        
        const newChannel = {
            id: 'custom_' + Date.now(),
            name: name,
            icon: icon,
            type: 'custom',
            description: 'Groupe personnalis√©',
            members: [Utils.sanitizeEmail(state.currentUser.email)],
            createdBy: state.currentUser.email,
            createdAt: new Date().toISOString()
        };
        
        // Ajouter √† la liste
        Chat.channels.push(newChannel);
        
        // Sauvegarder dans les donn√©es du projet
        if(!state.data.chatChannels) state.data.chatChannels = [];
        state.data.chatChannels.push(newChannel);
        Store.save();
        
        // Fermer le modal
        const modal = document.getElementById('create-channel-modal');
        if(modal) modal.remove();
        
        Chat.renderChannelsList();
        Chat.selectChannel(newChannel.id);
        
        // Ouvrir le panel des membres (l'utilisateur pourra cliquer sur Ajouter)
        document.getElementById('chat-members-panel').style.display = 'flex';
    },
    
    deleteChannel: async (channelId) => {
        if(!await ConfirmModal.confirmDelete("Le groupe et tous ses messages seront supprim√©s.")) return;
        
        // Retirer de la liste locale
        Chat.channels = Chat.channels.filter(c => c.id !== channelId);
        
        // Retirer des donn√©es du projet
        if(state.data.chatChannels) {
            state.data.chatChannels = state.data.chatChannels.filter(c => c.id !== channelId);
        }
        
        // Supprimer les messages
        firebase.database().ref(`all_projects/${state.currentProjectId}/chat/${channelId}`).remove();
        
        Store.save();
        
        if(Chat.currentChannel === channelId) {
            Chat.currentChannel = 'general';
        }
        
        Chat.renderChannelsList();
        Chat.selectChannel(Chat.currentChannel);
    },
    
    showAddMemberModal: () => {
        // R√©cup√©rer tous les membres du projet
        const allMembers = [];
        
        state.data.actors?.forEach(a => {
            if(a.email) allMembers.push({ name: a.name, email: a.email, type: 'actor', photo: a.photo });
        });
        
        state.data.crew?.forEach(c => {
            if(c.email) allMembers.push({ name: c.name, email: c.email, type: 'crew', role: c.role, photo: c.photo });
        });
        
        const channel = Chat.channels.find(c => c.id === Chat.currentChannel);
        if(!channel || channel.type !== 'custom') return;
        
        const currentMembers = channel.members || [];
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10001;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        let membersHtml = '';
        allMembers.forEach((m, idx) => {
            const isSelected = currentMembers.includes(Utils.sanitizeEmail(m.email));
            const photoHTML = m.photo ? `<img src="${m.photo}" style="width:100%;height:100%;object-fit:cover;">` : 'üë§';
            membersHtml += `
                <label class="chat-member-item ${isSelected ? 'selected' : ''}" style="cursor:pointer;">
                    <input type="checkbox" value="${Utils.sanitizeEmail(m.email)}" ${isSelected ? 'checked' : ''} style="margin-right: 10px;">
                    <div class="chat-member-photo">${photoHTML}</div>
                    <div>
                        <div style="font-weight: 500;">${Utils.escape(m.name)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-sec);">${m.type === 'actor' ? 'Com√©dien.ne' : (m.role || 'Technicien')}</div>
                    </div>
                </label>
            `;
        });
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto;">
                <h3 style="margin-top:0;">üë• G√©rer les membres</h3>
                <p style="color:var(--text-sec); font-size:0.9rem;">S√©lectionnez les personnes √† ajouter au groupe "${channel.name}"</p>
                <div style="margin: 20px 0; max-height: 300px; overflow-y: auto;">
                    ${membersHtml || '<p style="color:var(--text-sec);">Aucun membre disponible</p>'}
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:10px 20px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Annuler</button>
                    <button onclick="app.Chat.saveChannelMembers(this.closest('div[style*=fixed]'))" style="padding:10px 20px;background:var(--success);color:white;border:none;border-radius:6px;cursor:pointer;">‚úì Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    saveChannelMembers: (modal) => {
        const channel = Chat.channels.find(c => c.id === Chat.currentChannel);
        if(!channel) return;
        
        const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
        const members = [Utils.sanitizeEmail(state.currentUser.email)]; // Toujours inclure le propri√©taire
        
        checkboxes.forEach(cb => {
            if(!members.includes(cb.value)) {
                members.push(cb.value);
            }
        });
        
        if(channel.type === 'custom') {
            channel.members = members;
            
            // Mettre √† jour dans state.data
            const dataChannel = state.data.chatChannels?.find(c => c.id === channel.id);
            if(dataChannel) {
                dataChannel.members = members;
            }
        } else {
            // Pour les canaux syst√®me, stocker les membres extra
            if(!state.data.chatExtraMembers) state.data.chatExtraMembers = {};
            state.data.chatExtraMembers[channel.id] = members;
        }
        
        Store.save();
        
        modal.remove();
        Chat.loadMembers(Chat.currentChannel);
        Chat.renderChannelsList();
    },
    
    cleanup: () => {
        // D√©tacher le listener quand on quitte le projet
        if(Chat.messagesListener) {
            Chat.messagesListener();
            Chat.messagesListener = null;
        }
        Chat.currentChannel = null;
    }
};

const Permissions = {
    // Obtenir les permissions d'un membre du projet
    getForMember: (member, type) => {
        // type = 'actor' ou 'crew'
        if(type === 'actor') {
            return CONFIG.defaultPermissions['comedien'];
        }
        
        // Pour les techniciens, chercher par r√¥le
        const role = member.role || '';
        
        // Chercher une correspondance exacte
        if(CONFIG.defaultPermissions[role]) {
            return CONFIG.defaultPermissions[role];
        }
        
        // V√©rifier si c'est un chef de poste (contient "Chef" ou "Directeur")
        if(role.includes('Chef') || role.includes('Directeur') || role.includes('R√©alisateur')) {
            return CONFIG.defaultPermissions['chef_de_poste'];
        }
        
        // Par d√©faut, technicien standard
        return CONFIG.defaultPermissions['technicien'];
    },
    
    // Obtenir les permissions actuelles d'un utilisateur sur le projet
    getCurrentUserPermissions: () => {
        if(state.currentRole === 'owner') {
            return CONFIG.defaultPermissions['owner'];
        }
        
        // Chercher l'utilisateur dans les membres du projet
        const userEmail = state.currentUser?.email;
        if(!userEmail) return CONFIG.defaultPermissions['technicien'];
        
        // V√©rifier dans les permissions personnalis√©es du projet
        if(state.data?.memberPermissions?.[Utils.sanitizeEmail(userEmail)]) {
            return state.data.memberPermissions[Utils.sanitizeEmail(userEmail)];
        }
        
        // Chercher dans les com√©diens
        const actor = state.data?.actors?.find(a => a.email === userEmail);
        if(actor) return Permissions.getForMember(actor, 'actor');
        
        // Chercher dans l'√©quipe
        const crew = state.data?.crew?.find(c => c.email === userEmail);
        if(crew) return Permissions.getForMember(crew, 'crew');
        
        // Par d√©faut selon le r√¥le ACL
        if(state.currentRole === 'editor') {
            return CONFIG.defaultPermissions['chef_de_poste'];
        }
        
        return CONFIG.defaultPermissions['technicien'];
    },
    
    // V√©rifier si l'utilisateur peut acc√©der √† une section
    canAccess: (section) => {
        if(state.currentRole === 'owner') return true;
        const perms = Permissions.getCurrentUserPermissions();
        return perms[section] && perms[section] !== 'none';
    },
    
    // V√©rifier si l'utilisateur peut modifier une section
    canEdit: (section) => {
        if(state.currentRole === 'owner') return true;
        const perms = Permissions.getCurrentUserPermissions();
        return perms[section] === 'write';
    },
    
    // Ouvrir le modal de gestion des permissions
    openModal: () => {
        if(state.currentRole !== 'owner') {
            Utils.toast('Seul le propri√©taire peut g√©rer les acc√®s.', 'error');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'permissions-modal';
        modal.id = 'permissions-modal';
        modal.onclick = (e) => { if(e.target === modal) Permissions.closeModal(); };
        
        modal.innerHTML = `
            <div class="permissions-container">
                <div class="permissions-header">
                    <h2>üîê G√©rer les acc√®s au projet</h2>
                    <button onclick="app.Permissions.closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">‚úñ</button>
                </div>
                <div class="permissions-body">
                    <p style="color:var(--text-sec); margin-bottom:20px;">
                        D√©finissez les permissions pour chaque membre du projet. Les permissions par d√©faut sont bas√©es sur le r√¥le de chacun.
                    </p>
                    
                    <div class="permissions-section">
                        <h3>üé≠ Com√©dien.nes</h3>
                        <div id="perm-actors-table"></div>
                    </div>
                    
                    <div class="permissions-section">
                        <h3>üé• √âquipe technique</h3>
                        <div id="perm-crew-table"></div>
                    </div>
                    
                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px;">
                        <button onclick="app.Permissions.closeModal()" style="padding:10px 20px; background:var(--bg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Fermer</button>
                        <button onclick="app.Permissions.saveAll()" style="padding:10px 20px; background:var(--success); color:white; border:none; border-radius:6px; cursor:pointer;">üíæ Sauvegarder</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        Permissions.renderTables();
    },
    
    closeModal: () => {
        const modal = document.getElementById('permissions-modal');
        if(modal) modal.remove();
    },
    
    renderTables: () => {
        // Table des com√©diens
        const actorsDiv = document.getElementById('perm-actors-table');
        if(actorsDiv) {
            if(!state.data.actors || state.data.actors.length === 0) {
                actorsDiv.innerHTML = '<p style="color:var(--text-sec); font-style:italic;">Aucun com√©dien dans le projet</p>';
            } else {
                actorsDiv.innerHTML = Permissions.buildTable(state.data.actors, 'actor');
            }
        }
        
        // Table de l'√©quipe
        const crewDiv = document.getElementById('perm-crew-table');
        if(crewDiv) {
            if(!state.data.crew || state.data.crew.length === 0) {
                crewDiv.innerHTML = '<p style="color:var(--text-sec); font-style:italic;">Aucun technicien dans le projet</p>';
            } else {
                crewDiv.innerHTML = Permissions.buildTable(state.data.crew, 'crew');
            }
        }
    },
    
    buildTable: (members, type) => {
        const sections = CONFIG.permissionSections;
        
        let html = `<div style="overflow-x:auto;"><table class="permissions-table">
            <thead>
                <tr>
                    <th style="min-width:180px;">Membre</th>
                    <th>Preset</th>
                    ${sections.map(s => `<th style="font-size:0.7rem; min-width:60px;">${s.label.split(' ')[0]}</th>`).join('')}
                </tr>
            </thead>
            <tbody>`;
        
        members.forEach((member, idx) => {
            const emailKey = member.email ? Utils.sanitizeEmail(member.email) : `${type}_${idx}`;
            const currentPerms = state.data.memberPermissions?.[emailKey] || Permissions.getForMember(member, type);
            const photoHTML = member.photo ? `<img src="${member.photo}">` : 'üë§';
            const roleLabel = type === 'actor' ? 'Com√©dien.ne' : (member.role || 'Technicien');
            
            html += `<tr>
                <td>
                    <div class="permissions-user-info">
                        <div class="permissions-user-photo">${photoHTML}</div>
                        <div>
                            <div class="permissions-user-name">${Utils.escape(member.name)}</div>
                            <div class="permissions-user-role">${Utils.escape(roleLabel)}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <select class="perm-select" onchange="app.Permissions.applyPreset('${emailKey}', '${type}', ${idx}, this.value)">
                        <option value="">Personnalis√©</option>
                        <option value="comedien" ${type === 'actor' ? 'selected' : ''}>Com√©dien</option>
                        <option value="technicien">Technicien</option>
                        <option value="chef_de_poste">Chef de poste</option>
                        <option value="Scripte">Scripte</option>
                        <option value="1er¬∑√®re assistant¬∑e r√©alisateur¬∑rice">1er Assistant R√©al</option>
                        <option value="Directeur¬∑rice de casting">Dir. Casting</option>
                        <option value="R√©alisateur¬∑rice">R√©alisateur</option>
                        <option value="Producteur¬∑rice">Producteur</option>
                    </select>
                </td>
                ${sections.map(s => `
                    <td>
                        <select class="perm-select" id="perm-${emailKey}-${s.id}" data-email="${emailKey}" data-section="${s.id}">
                            <option value="none" ${currentPerms[s.id] === 'none' ? 'selected' : ''}>‚ùå</option>
                            <option value="read" ${currentPerms[s.id] === 'read' ? 'selected' : ''}>üëÅÔ∏è</option>
                            <option value="write" ${currentPerms[s.id] === 'write' ? 'selected' : ''}>‚úèÔ∏è</option>
                        </select>
                    </td>
                `).join('')}
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        // L√©gende
        html += `<div style="margin-top:10px; font-size:0.8rem; color:var(--text-sec);">
            <span style="margin-right:15px;">‚ùå Aucun acc√®s</span>
            <span style="margin-right:15px;">üëÅÔ∏è Lecture seule</span>
            <span>‚úèÔ∏è Modification</span>
        </div>`;
        
        return html;
    },
    
    applyPreset: (emailKey, type, idx, preset) => {
        if(!preset) return;
        
        const perms = CONFIG.defaultPermissions[preset];
        if(!perms) return;
        
        CONFIG.permissionSections.forEach(s => {
            const select = document.getElementById(`perm-${emailKey}-${s.id}`);
            if(select) {
                select.value = perms[s.id] || 'none';
            }
        });
    },
    
    saveAll: async () => {
        if(!state.data.memberPermissions) {
            state.data.memberPermissions = {};
        }
        
        // R√©cup√©rer toutes les permissions depuis les selects
        const allSelects = document.querySelectorAll('.permissions-table select[data-email]');
        const permsByEmail = {};
        
        allSelects.forEach(select => {
            const email = select.dataset.email;
            const section = select.dataset.section;
            if(!permsByEmail[email]) permsByEmail[email] = {};
            permsByEmail[email][section] = select.value;
        });
        
        // Ajouter les permissions de chat par d√©faut
        Object.keys(permsByEmail).forEach(email => {
            permsByEmail[email].chat_general = 'write';
            permsByEmail[email].chat_chefs = permsByEmail[email].scenario === 'write' ? 'write' : 'none';
            permsByEmail[email].chat_technique = permsByEmail[email].depouillement !== 'none' ? 'write' : 'none';
            permsByEmail[email].chat_comediens = permsByEmail[email].comediens !== 'none' ? 'write' : 'none';
        });
        
        state.data.memberPermissions = permsByEmail;
        
        try {
            await Store.save();
            Utils.toast('Permissions sauvegard√©es !', 'success');
            Permissions.closeModal();
        } catch(e) {
            console.error('Erreur sauvegarde permissions:', e);
            Utils.toast('Erreur lors de la sauvegarde', 'error');
        }
    },
    
    // Initialiser les permissions pour un nouveau membre
    initForNewMember: (member, type) => {
        if(!member.email) return;
        
        const emailKey = Utils.sanitizeEmail(member.email);
        if(!state.data.memberPermissions) state.data.memberPermissions = {};
        
        if(!state.data.memberPermissions[emailKey]) {
            state.data.memberPermissions[emailKey] = { ...Permissions.getForMember(member, type) };
        }
    }
};

const GlobalSearch = {
    currentType: 'actors',
    results: [],
    
    openActors: () => {
        GlobalSearch.currentType = 'actors';
        GlobalSearch.open();
    },
    
    openCrew: () => {
        GlobalSearch.currentType = 'crew';
        GlobalSearch.open();
    },
    
    open: () => {
        const isActors = GlobalSearch.currentType === 'actors';
        
        const modal = document.createElement('div');
        modal.className = 'global-search-modal';
        modal.id = 'global-search-modal';
        modal.onclick = (e) => { if(e.target === modal) GlobalSearch.close(); };
        
        modal.innerHTML = `
            <div class="global-search-container">
                <div class="global-search-header">
                    <h2>${isActors ? 'üé≠ Rechercher un.e com√©dien.ne' : 'üé• Rechercher un.e technicien.ne'}</h2>
                    <button onclick="app.GlobalSearch.close()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">‚úñ</button>
                </div>
                <div class="global-search-filters">
                    ${isActors ? GlobalSearch.getActorFiltersHTML() : GlobalSearch.getCrewFiltersHTML()}
                </div>
                <div class="global-search-results" id="global-search-results">
                    <div class="global-search-loading">üîÑ Chargement...</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        GlobalSearch.search();
    },
    
    close: () => {
        const modal = document.getElementById('global-search-modal');
        if(modal) modal.remove();
    },
    
    getActorFiltersHTML: () => {
        return `
            <div class="global-search-filters-row">
                <input type="text" class="global-search-input" id="gs-name" placeholder="üîç Nom..." style="min-width:200px;" oninput="app.GlobalSearch.search()">
                <select class="global-search-input" id="gs-gender" onchange="app.GlobalSearch.search()">
                    <option value="">Tous sexes</option>
                    <option value="homme">Homme</option>
                    <option value="femme">Femme</option>
                    <option value="non-binaire">Non-binaire</option>
                </select>
                <select class="global-search-input" id="gs-ethnicity" onchange="app.GlobalSearch.search()">
                    <option value="">Toutes origines</option>
                    <option value="caucasien">Caucasien</option>
                    <option value="africain">Africain</option>
                    <option value="asiatique">Asiatique</option>
                    <option value="latino">Latino</option>
                    <option value="maghrebin">Maghr√©bin</option>
                    <option value="moyenorient">Moyen-Orient</option>
                    <option value="indien">Indien</option>
                    <option value="metis">M√©tis</option>
                </select>
                <select class="global-search-input" id="gs-hair" onchange="app.GlobalSearch.search()">
                    <option value="">Tous cheveux</option>
                    <option value="noir">Noir</option>
                    <option value="brun">Brun</option>
                    <option value="chatain">Ch√¢tain</option>
                    <option value="blond">Blond</option>
                    <option value="roux">Roux</option>
                    <option value="chauve">Chauve</option>
                </select>
                <select class="global-search-input" id="gs-eyes" onchange="app.GlobalSearch.search()">
                    <option value="">Tous yeux</option>
                    <option value="marron">Marron</option>
                    <option value="bleu">Bleu</option>
                    <option value="vert">Vert</option>
                    <option value="gris">Gris</option>
                    <option value="noir">Noir</option>
                </select>
            </div>
            <div class="global-search-filters-row">
                <input type="text" class="global-search-input" id="gs-city" placeholder="üìç Ville / R√©gion..." oninput="app.GlobalSearch.search()">
                <input type="number" class="global-search-input" id="gs-age-min" placeholder="√Çge min" style="width:80px;" oninput="app.GlobalSearch.search()">
                <input type="number" class="global-search-input" id="gs-age-max" placeholder="√Çge max" style="width:80px;" oninput="app.GlobalSearch.search()">
                <input type="number" class="global-search-input" id="gs-height-min" placeholder="Taille min (cm)" style="width:110px;" oninput="app.GlobalSearch.search()">
                <input type="number" class="global-search-input" id="gs-height-max" placeholder="Taille max (cm)" style="width:110px;" oninput="app.GlobalSearch.search()">
                <input type="text" class="global-search-input" id="gs-sports" placeholder="üèá Sport (√©quitation...)" oninput="app.GlobalSearch.search()">
                <input type="text" class="global-search-input" id="gs-languages" placeholder="üó£Ô∏è Langue (anglais...)" oninput="app.GlobalSearch.search()">
                <select class="global-search-input" id="gs-collab" onchange="app.GlobalSearch.search()">
                    <option value="">Tous types collab</option>
                    <option value="pro">üé¨ Pro</option>
                    <option value="semi-pro">‚ö° Semi-pro</option>
                    <option value="benevole">‚ù§Ô∏è B√©n√©vole</option>
                </select>
            </div>
        `;
    },
    
    getCrewFiltersHTML: () => {
        return `
            <div class="global-search-filters-row">
                <input type="text" class="global-search-input" id="gs-name" placeholder="üîç Nom..." style="min-width:200px;" oninput="app.GlobalSearch.search()">
                <select class="global-search-input" id="gs-department" onchange="app.GlobalSearch.search()">
                    <option value="">Tous d√©partements</option>
                    <option value="image">üìπ Image</option>
                    <option value="lumiere">üí° Lumi√®re</option>
                    <option value="realisation">üé¨ R√©alisation</option>
                    <option value="son">üé§ Son</option>
                    <option value="decoration">üé® D√©coration</option>
                    <option value="costumes">üëó Costumes</option>
                    <option value="maquillage">üíÑ Maquillage/Coiffure</option>
                    <option value="regie">üé≠ R√©gie</option>
                    <option value="production">üíº Production</option>
                    <option value="postprod">üéûÔ∏è Post-production</option>
                </select>
                <input type="text" class="global-search-input" id="gs-role" placeholder="Fonction (Chef op, Cadreur...)" oninput="app.GlobalSearch.search()">
                <input type="text" class="global-search-input" id="gs-city" placeholder="üìç Ville / R√©gion..." oninput="app.GlobalSearch.search()">
            </div>
            <div class="global-search-filters-row">
                <input type="text" class="global-search-input" id="gs-camera" placeholder="üì∑ Cam√©ra (RED, ARRI, Sony...)" style="min-width:200px;" oninput="app.GlobalSearch.search()">
                <input type="text" class="global-search-input" id="gs-equipment" placeholder="üîß Mat√©riel (stabilisateur, drone...)" style="min-width:200px;" oninput="app.GlobalSearch.search()">
                <label style="display:flex; align-items:center; gap:5px; padding:8px; background:var(--input-bg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    <input type="checkbox" id="gs-vehicle" onchange="app.GlobalSearch.search()"> üöó V√©hicule
                </label>
                <select class="global-search-input" id="gs-collab" onchange="app.GlobalSearch.search()">
                    <option value="">Tous types collab</option>
                    <option value="pro">üé¨ Pro</option>
                    <option value="semi-pro">‚ö° Semi-pro</option>
                    <option value="benevole">‚ù§Ô∏è B√©n√©vole</option>
                </select>
            </div>
        `;
    },
    
    search: async () => {
        const resultsDiv = document.getElementById('global-search-results');
        if(!resultsDiv) return;
        
        resultsDiv.innerHTML = '<div class="global-search-loading">üîÑ Recherche en cours...</div>';
        
        const isActors = GlobalSearch.currentType === 'actors';
        const dbPath = isActors ? 'public_actors' : 'public_crew';
        
        try {
            const snap = await firebase.database().ref(dbPath).once('value');
            let results = snap.val() ? Object.values(snap.val()) : [];
            
            // Filtrer uniquement les profils complets
            results = results.filter(r => r.profileComplete);
            
            // Appliquer les filtres
            const name = (document.getElementById('gs-name')?.value || '').toLowerCase();
            const city = (document.getElementById('gs-city')?.value || '').toLowerCase();
            
            if(name) results = results.filter(r => (r.name || '').toLowerCase().includes(name));
            if(city) results = results.filter(r => (r.city || '').toLowerCase().includes(city));
            
            const collab = document.getElementById('gs-collab')?.value;
            if(collab) results = results.filter(r => r.collabType === collab);
            
            if(isActors) {
                const gender = document.getElementById('gs-gender')?.value;
                const ethnicity = document.getElementById('gs-ethnicity')?.value;
                const hair = document.getElementById('gs-hair')?.value;
                const eyes = document.getElementById('gs-eyes')?.value;
                const ageMin = parseInt(document.getElementById('gs-age-min')?.value) || 0;
                const ageMax = parseInt(document.getElementById('gs-age-max')?.value) || 999;
                const heightMin = parseInt(document.getElementById('gs-height-min')?.value) || 0;
                const heightMax = parseInt(document.getElementById('gs-height-max')?.value) || 999;
                const sports = (document.getElementById('gs-sports')?.value || '').toLowerCase();
                const languages = (document.getElementById('gs-languages')?.value || '').toLowerCase();
                
                if(gender) results = results.filter(r => r.gender === gender);
                if(ethnicity) results = results.filter(r => r.ethnicity === ethnicity);
                if(hair) results = results.filter(r => r.hairColor === hair);
                if(eyes) results = results.filter(r => r.eyeColor === eyes);
                if(ageMin > 0) results = results.filter(r => parseInt(r.age) >= ageMin);
                if(ageMax < 999) results = results.filter(r => parseInt(r.age) <= ageMax);
                if(heightMin > 0) results = results.filter(r => parseInt(r.height) >= heightMin);
                if(heightMax < 999) results = results.filter(r => parseInt(r.height) <= heightMax);
                if(sports) results = results.filter(r => (r.sports || '').toLowerCase().includes(sports));
                if(languages) results = results.filter(r => (r.languages || '').toLowerCase().includes(languages));
            } else {
                const department = document.getElementById('gs-department')?.value;
                const role = (document.getElementById('gs-role')?.value || '').toLowerCase();
                const camera = (document.getElementById('gs-camera')?.value || '').toLowerCase();
                const equipment = (document.getElementById('gs-equipment')?.value || '').toLowerCase();
                const hasVehicle = document.getElementById('gs-vehicle')?.checked;
                
                if(department) results = results.filter(r => r.department === department);
                if(role) results = results.filter(r => (r.role || '').toLowerCase().includes(role));
                if(camera) results = results.filter(r => (r.cameras || []).some(c => c.toLowerCase().includes(camera)));
                if(equipment) {
                    results = results.filter(r => {
                        const allEquip = [...(r.cameras || []), ...(r.lenses || []), ...(r.otherEquipment || [])].join(' ').toLowerCase();
                        return allEquip.includes(equipment);
                    });
                }
                if(hasVehicle) results = results.filter(r => r.hasVehicle);
            }
            
            GlobalSearch.results = results;
            GlobalSearch.renderResults();
            
        } catch(e) {
            console.error('Erreur recherche:', e);
            resultsDiv.innerHTML = '<div class="global-search-empty">‚ùå Erreur lors de la recherche</div>';
        }
    },
    
    renderResults: () => {
        const resultsDiv = document.getElementById('global-search-results');
        if(!resultsDiv) return;
        
        const isActors = GlobalSearch.currentType === 'actors';
        const results = GlobalSearch.results;
        
        if(results.length === 0) {
            resultsDiv.innerHTML = `<div class="global-search-empty">
                <p style="font-size:1.2rem; margin-bottom:10px;">Aucun r√©sultat trouv√©</p>
                <p style="font-size:0.9rem;">Essayez d'√©largir vos crit√®res de recherche</p>
            </div>`;
            return;
        }
        
        let html = `<p style="margin-bottom:15px; color:var(--text-sec);">${results.length} r√©sultat${results.length > 1 ? 's' : ''}</p>`;
        html += '<div class="global-search-results-grid">';
        
        results.forEach((person, idx) => {
            const photoHTML = person.photo 
                ? `<img src="${person.photo}" alt="${person.name || person.title}">`
                : defaultIcon;
            
            let metaHTML = '';
            let tagsHTML = '';
            
            if(isActors) {
                const details = [];
                if(person.age) details.push(person.age + ' ans');
                if(person.height) details.push(person.height + ' cm');
                if(person.city) details.push('üìç ' + person.city);
                metaHTML = details.join(' ‚Ä¢ ');
                
                if(person.collabType === 'pro') tagsHTML += `<span class="global-search-card-tag" style="background:#4CAF50;color:white;">üé¨ Pro</span>`;
                if(person.collabType === 'semi-pro') tagsHTML += `<span class="global-search-card-tag" style="background:#FF9800;color:white;">‚ö° Semi-pro</span>`;
                if(person.collabType === 'benevole') tagsHTML += `<span class="global-search-card-tag" style="background:#E91E63;color:white;">‚ù§Ô∏è B√©n√©vole</span>`;
                if(person.dailyRate) tagsHTML += `<span class="global-search-card-tag">üí∞ ${person.dailyRate}${person.rateCurrency || '‚Ç¨'}</span>`;
                if(person.sports) tagsHTML += `<span class="global-search-card-tag">üèÉ ${person.sports}</span>`;
                if(person.languages) tagsHTML += `<span class="global-search-card-tag">üó£Ô∏è ${person.languages}</span>`;
                if(person.hasVehicle) tagsHTML += `<span class="global-search-card-tag">üöó V√©hicule</span>`;
                if(person.demoreel) tagsHTML += `<span class="global-search-card-tag">üé¨ D√©mo</span>`;
                if(person.galleryPhotos && person.galleryPhotos.length > 0) tagsHTML += `<span class="global-search-card-tag">üì∏ ${person.galleryPhotos.length} photos</span>`;
            } else {
                const deptLabels = { image: 'üìπ Image', lumiere: 'üí° Lumi√®re', realisation: 'üé¨ R√©alisation', son: 'üé§ Son', decoration: 'üé® D√©coration', costumes: 'üëó Costumes', maquillage: 'üíÑ Maquillage', regie: 'üé≠ R√©gie', production: 'üíº Production', postprod: 'üéûÔ∏è Post-prod' };
                metaHTML = (person.role || '') + (person.department ? ' ‚Ä¢ ' + (deptLabels[person.department] || person.department) : '');
                if(person.city) metaHTML += ' ‚Ä¢ üìç ' + person.city;
                
                if(person.collabType === 'pro') tagsHTML += `<span class="global-search-card-tag" style="background:#4CAF50;color:white;">üé¨ Pro</span>`;
                if(person.collabType === 'semi-pro') tagsHTML += `<span class="global-search-card-tag" style="background:#FF9800;color:white;">‚ö° Semi-pro</span>`;
                if(person.collabType === 'benevole') tagsHTML += `<span class="global-search-card-tag" style="background:#E91E63;color:white;">‚ù§Ô∏è B√©n√©vole</span>`;
                if(person.dailyRate) tagsHTML += `<span class="global-search-card-tag">üí∞ ${person.dailyRate}${person.rateCurrency || '‚Ç¨'}</span>`;
                if(person.cameras && person.cameras.length > 0) {
                    person.cameras.slice(0, 3).forEach(c => tagsHTML += `<span class="global-search-card-tag">üì∑ ${c}</span>`);
                    if(person.cameras.length > 3) tagsHTML += `<span class="global-search-card-tag">+${person.cameras.length - 3}</span>`;
                }
                if(person.hasVehicle) tagsHTML += `<span class="global-search-card-tag">üöó V√©hicule</span>`;
                if(person.demoreel) tagsHTML += `<span class="global-search-card-tag">üé¨ D√©mo</span>`;
                if((person.crewGalleryPhotos && person.crewGalleryPhotos.length > 0) || (person.galleryPhotos && person.galleryPhotos.length > 0)) tagsHTML += `<span class="global-search-card-tag">üì∏ Photos</span>`;
            }
            
            html += `
                <div class="global-search-card">
                    <div class="global-search-card-header">
                        <div class="global-search-card-photo">${photoHTML}</div>
                        <div>
                            <div class="global-search-card-name">${Utils.escape(person.name)}</div>
                            <div class="global-search-card-meta">${metaHTML}</div>
                        </div>
                    </div>
                    ${tagsHTML ? `<div class="global-search-card-tags">${tagsHTML}</div>` : ''}
                    <div class="global-search-card-actions">
                        <button onclick="app.GlobalSearch.viewProfile(${idx})" style="background:var(--bg); border:1px solid var(--border); color:var(--text-main);">üëÅÔ∏è Voir profil</button>
                        <button onclick="app.GlobalSearch.addToProject(${idx})" style="background:var(--primary); border:none; color:white;">‚ûï Ajouter au projet</button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        resultsDiv.innerHTML = html;
    },
    
    viewProfile: (idx) => {
        const person = GlobalSearch.results[idx];
        if(!person) return;
        
        const isActors = GlobalSearch.currentType === 'actors';
        
        let detailsHTML = '';
        if(isActors) {
            detailsHTML = `
                <p><strong>√Çge:</strong> ${person.age || 'N/A'} ans</p>
                <p><strong>Taille:</strong> ${person.height || 'N/A'} cm</p>
                <p><strong>Yeux:</strong> ${person.eyeColor || 'N/A'}</p>
                <p><strong>Cheveux:</strong> ${person.hairColor || 'N/A'} (${person.hairLength || 'N/A'})</p>
                <p><strong>Origine:</strong> ${person.ethnicity || 'N/A'}</p>
                ${person.sports ? `<p><strong>Sports:</strong> ${person.sports}</p>` : ''}
                ${person.languages ? `<p><strong>Langues:</strong> ${person.languages}</p>` : ''}
            `;
        } else {
            detailsHTML = `
                <p><strong>D√©partement:</strong> ${person.department || 'N/A'}</p>
                <p><strong>Fonction:</strong> ${person.role || 'N/A'}</p>
                ${person.cameras && person.cameras.length > 0 ? `<p><strong>Cam√©ras:</strong> ${person.cameras.join(', ')}</p>` : ''}
                ${person.lenses && person.lenses.length > 0 ? `<p><strong>Objectifs:</strong> ${person.lenses.join(', ')}</p>` : ''}
                ${person.otherEquipment && person.otherEquipment.length > 0 ? `<p><strong>Autre mat√©riel:</strong> ${person.otherEquipment.join(', ')}</p>` : ''}
            `;
        }
        
        const profileModal = document.createElement('div');
        profileModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:10001;';
        profileModal.onclick = (e) => { if(e.target === profileModal) profileModal.remove(); };
        
        profileModal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                    <div style="width:80px;height:80px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:2.5rem;overflow:hidden;">
                        ${person.photo ? `<img src="${person.photo}" style="width:100%;height:100%;object-fit:cover;">` : 'üë§'}
                    </div>
                    <div>
                        <h2 style="margin:0;">${Utils.escape(person.name)}</h2>
                        <p style="margin:5px 0 0;color:var(--text-sec);">üìç ${person.city || 'Non pr√©cis√©'}</p>
                    </div>
                </div>
                ${person.bio ? `<p style="margin-bottom:15px;">${Utils.escape(person.bio)}</p>` : ''}
                <div style="background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px;">
                    ${detailsHTML}
                </div>
                <div style="background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px;">
                    <p><strong>üí∞ Tarif:</strong> ${person.dailyRate || 'N/A'} ${person.rateCurrency || '‚Ç¨'}/${person.rateType || 'jour'}</p>
                    ${person.hasVehicle ? `<p><strong>üöó V√©hicule:</strong> ${person.vehicleType || 'Oui'} (${person.vehicleSeats || '?'} places)</p>` : ''}
                    ${person.availabilityText ? `<p><strong>üìÖ Disponibilit√©s:</strong> ${person.availabilityText}</p>` : ''}
                </div>
                ${(person.galleryPhotos && person.galleryPhotos.length > 0) || (person.crewGalleryPhotos && person.crewGalleryPhotos.length > 0) ? `
                <div style="background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px;">
                    <p style="margin-bottom:10px;"><strong>üì∏ Galerie Photos</strong></p>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        ${(person.galleryPhotos || person.crewGalleryPhotos || []).map(url => url ? `<img src="${url}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="window.open('${url}','_blank')">` : '').join('')}
                    </div>
                </div>` : ''}
                ${person.demoreel ? `
                <div style="background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px;">
                    <p style="margin-bottom:10px;"><strong>üé¨ Bande D√©mo</strong></p>
                    <iframe src="${ProfileRenderer.getEmbedUrl(person.demoreel)}" width="100%" height="200" frameborder="0" allowfullscreen style="border-radius:8px;"></iframe>
                </div>` : ''}
                <div style="display:flex;gap:10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Fermer</button>
                    <button onclick="app.GlobalSearch.addToProject(${idx}); this.closest('div[style*=fixed]').remove();" style="flex:1;padding:12px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">‚ûï Ajouter au projet</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(profileModal);
    },
    
    addToProject: (idx) => {
        const person = GlobalSearch.results[idx];
        if(!person) return;
        
        const isActors = GlobalSearch.currentType === 'actors';
        
        // Cr√©er une copie pour le projet
        const newEntry = { ...person };
        newEntry.id = (isActors ? 'act_' : 'crew_') + Date.now();
        newEntry.availabilityDates = [];
        delete newEntry.profileComplete;
        delete newEntry.updatedAt;
        
        // V√©rifier si d√©j√† dans le projet
        const existingList = isActors ? state.data.actors : state.data.crew;
        const alreadyExists = existingList.some(e => e.email === person.email);
        
        if(alreadyExists) {
            Utils.toast('Cette personne est d√©j√† dans le projet !', 'warning');
            return;
        }
        
if(isActors) {
            state.data.actors.push(newEntry);
            Store.save();
            UI.renderDataTab('actors', els.actorContainer);
        } else {
            state.data.crew.push(newEntry);
            Store.save();
            UI.renderCrewTab();
        }
        
        Utils.toast(`${person.name} ajout√©(e) au projet !`, 'success');
        
        // Proposer d'avertir la personne si elle a un email
        if(person.email) {
            setTimeout(async () => {
                if(await ConfirmModal.show({ title: 'Pr√©venir cette personne ?', message: `Envoyer une notification √† ${person.name} pour l'informer qu'il/elle a √©t√© ajout√©(e) au projet ?`, icon: 'üìß', confirmText: 'Envoyer' })) {
                    GlobalSearch.notifyPerson(person);
                }
            }, 300);
        }
    },
    
    notifyPerson: async (person) => {
        try {
            const projectTitle = document.getElementById('projectTitle')?.value || 'Un projet';
            const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'Quelqu\'un';
            
            await Messages.send(person.email, {
                type: 'info',
                title: `Vous avez √©t√© ajout√©(e) au projet "${projectTitle}"`,
                content: `${senderName} vous a ajout√©(e) au projet "${projectTitle}" sur Moteur.\n\nVous pouvez maintenant collaborer sur ce projet.`,
                projectId: state.currentProjectId,
                projectTitle: projectTitle
            });
            
            // Envoyer aussi un ping email
            await Messages.sendEmailPing(person.email, person.name, 'claim', {
                senderName: senderName,
                projectTitle: projectTitle,
                typeLabel: typeLabel
            });
            
            Utils.toast(`${person.name} a √©t√© notifi√©(e) !`, 'success');
        } catch(e) {
            console.error('Erreur notification:', e);
            Utils.toast('Erreur lors de l\'envoi de la notification', 'error');
        }
    }
};
  
  const ActorSearch = {
    filtersVisible: false,
    
    toggleFilters: () => {
        ActorSearch.filtersVisible = !ActorSearch.filtersVisible;
        const filtersDiv = document.getElementById('actor-filters');
        if(filtersDiv) {
            filtersDiv.style.display = ActorSearch.filtersVisible ? 'block' : 'none';
        }
    },
    
    applyFilters: () => {
        const name = (document.getElementById('filter-name')?.value || '').toLowerCase();
        const gender = document.getElementById('filter-gender')?.value || '';
        const ethnicity = document.getElementById('filter-ethnicity')?.value || '';
        const hair = document.getElementById('filter-hair')?.value || '';
        const eyes = document.getElementById('filter-eyes')?.value || '';
        const ageMin = parseInt(document.getElementById('filter-age-min')?.value) || 0;
        const ageMax = parseInt(document.getElementById('filter-age-max')?.value) || 999;
        const heightMin = parseInt(document.getElementById('filter-height-min')?.value) || 0;
        const heightMax = parseInt(document.getElementById('filter-height-max')?.value) || 999;
        const sports = (document.getElementById('filter-sports')?.value || '').toLowerCase();
        const languages = (document.getElementById('filter-languages')?.value || '').toLowerCase();
        const hasVehicle = document.getElementById('filter-vehicle')?.checked || false;
        
        const cards = document.querySelectorAll('#actorContainer .data-card');
        let visibleCount = 0;
        
        cards.forEach((card, idx) => {
            const actor = state.data.actors[idx];
            if(!actor) return;
            
            let visible = true;
            
            // Filtre par nom
            if(name && !actor.name.toLowerCase().includes(name)) visible = false;
            
            // Filtre par sexe
            if(gender && actor.gender !== gender) visible = false;
            
            // Filtre par origine
            if(ethnicity && actor.ethnicity !== ethnicity) visible = false;
            
            // Filtre par cheveux
            if(hair && actor.hairColor !== hair) visible = false;
            
            // Filtre par yeux
            if(eyes && actor.eyeColor !== eyes) visible = false;
            
            // Filtre par √¢ge
            const actorAge = parseInt(actor.age) || 0;
            if(ageMin > 0 && actorAge < ageMin) visible = false;
            if(ageMax < 999 && actorAge > ageMax) visible = false;
            
            // Filtre par taille
            const actorHeight = parseInt(actor.height) || 0;
            if(heightMin > 0 && actorHeight < heightMin) visible = false;
            if(heightMax < 999 && actorHeight > heightMax) visible = false;
            
            // Filtre par sport
            if(sports && !(actor.sports || '').toLowerCase().includes(sports)) visible = false;
            
            // Filtre par langue
            if(languages && !(actor.languages || '').toLowerCase().includes(languages)) visible = false;
            
            // Filtre par v√©hicule
            if(hasVehicle && !actor.hasVehicle) visible = false;
            
            card.style.display = visible ? '' : 'none';
            if(visible) visibleCount++;
        });
        
        const countDiv = document.getElementById('filter-results-count');
        if(countDiv) {
            const total = state.data.actors?.length || 0;
            countDiv.textContent = `${visibleCount} / ${total} com√©dien${visibleCount > 1 ? 's' : ''} affich√©${visibleCount > 1 ? 's' : ''}`;
        }
    },
    
    resetFilters: () => {
        document.getElementById('filter-name').value = '';
        document.getElementById('filter-gender').value = '';
        document.getElementById('filter-ethnicity').value = '';
        document.getElementById('filter-hair').value = '';
        document.getElementById('filter-eyes').value = '';
        document.getElementById('filter-age-min').value = '';
        document.getElementById('filter-age-max').value = '';
        document.getElementById('filter-height-min').value = '';
        document.getElementById('filter-height-max').value = '';
        document.getElementById('filter-sports').value = '';
        document.getElementById('filter-languages').value = '';
        document.getElementById('filter-vehicle').checked = false;
        
        const cards = document.querySelectorAll('#actorContainer .data-card');
        cards.forEach(card => card.style.display = '');
        
        const countDiv = document.getElementById('filter-results-count');
        if(countDiv) countDiv.textContent = '';
    }
};
  
  const Contacts = {
    currentTab: 'actors',
    currentMode: 'favorites',
    directoryResults: [],
    
    open: () => {
        els.dashboardView.style.display = 'none';
        els.contactsView.classList.add('active');
        Contacts.currentMode = 'favorites';
        Contacts.currentTab = 'actors';
        Contacts.updateUI();
        Contacts.loadAndRender();
    },
    
    close: () => {
        els.contactsView.classList.remove('active');
        els.dashboardView.style.display = 'flex';
    },
    
    switchMode: (mode) => {
        Contacts.currentMode = mode;
        Contacts.updateUI();
        if(mode === 'favorites') {
            Contacts.render();
        } else {
            Contacts.searchDirectory();
        }
    },
    
    switchTab: (tab) => {
        Contacts.currentTab = tab;
        // Mettre √† jour les sous-onglets
        document.querySelectorAll('#contacts-sub-tabs .contacts-tab').forEach(t => t.classList.remove('active'));
        const activeTab = document.querySelector(`#contacts-sub-tabs .contacts-tab[onclick*="${tab}"]`);
        if(activeTab) activeTab.classList.add('active');
        
        if(Contacts.currentMode === 'favorites') {
            Contacts.render();
        } else {
            Contacts.updateFilters();
            Contacts.searchDirectory();
        }
    },
    
    updateUI: () => {
        const isFavorites = Contacts.currentMode === 'favorites';
        
        // Titre
        document.getElementById('contacts-title').textContent = isFavorites ? '‚≠ê Mes Favoris' : 'üåê Annuaire';
        
        // Onglets principaux
        document.querySelectorAll('.contacts-body > .contacts-tabs:first-child .contacts-tab').forEach(t => t.classList.remove('active'));
        const modeTab = document.querySelector(`.contacts-body > .contacts-tabs:first-child .contacts-tab[onclick*="${Contacts.currentMode}"]`);
        if(modeTab) modeTab.classList.add('active');
        
        // Filtres
        const filtersDiv = document.getElementById('contacts-filters');
        if(isFavorites) {
            filtersDiv.style.display = 'none';
        } else {
            filtersDiv.style.display = 'block';
            Contacts.updateFilters();
        }
    },
    
    updateFilters: () => {
        const filtersDiv = document.getElementById('contacts-filters');
        const tab = Contacts.currentTab;
        
        if(tab === 'actors') {
            filtersDiv.innerHTML = `
                <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                    <input type="text" class="global-search-input" id="contact-filter-name" placeholder="üîç Nom..." style="min-width:150px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city" placeholder="üìç Ville..." oninput="app.Contacts.searchDirectory()">
                    <select class="global-search-input" id="contact-filter-gender" onchange="app.Contacts.searchDirectory()">
                        <option value="">Tous sexes</option>
                        <option value="homme">Homme</option>
                        <option value="femme">Femme</option>
                        <option value="non-binaire">Non-binaire</option>
                    </select>
                    <select class="global-search-input" id="contact-filter-ethnicity" onchange="app.Contacts.searchDirectory()">
                        <option value="">Toutes origines</option>
                        <option value="caucasien">Caucasien</option>
                        <option value="africain">Africain</option>
                        <option value="asiatique">Asiatique</option>
                        <option value="latino">Latino</option>
                        <option value="maghrebin">Maghr√©bin</option>
                        <option value="metis">M√©tis</option>
                    </select>
                    <input type="text" class="global-search-input" id="contact-filter-sports" placeholder="üèá Sport..." style="width:120px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-languages" placeholder="üó£Ô∏è Langue..." style="width:120px;" oninput="app.Contacts.searchDirectory()">
                </div>
            `;
        } else if(tab === 'crew') {
            filtersDiv.innerHTML = `
                <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                    <input type="text" class="global-search-input" id="contact-filter-name" placeholder="üîç Nom..." style="min-width:150px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city" placeholder="üìç Ville..." oninput="app.Contacts.searchDirectory()">
                    <select class="global-search-input" id="contact-filter-department" onchange="app.Contacts.searchDirectory()">
                        <option value="">Tous d√©partements</option>
                        <option value="image">üìπ Image</option>
                        <option value="lumiere">üí° Lumi√®re</option>
                        <option value="realisation">üé¨ R√©alisation</option>
                        <option value="son">üé§ Son</option>
                        <option value="decoration">üé® D√©coration</option>
                        <option value="costumes">üëó Costumes</option>
                        <option value="maquillage">üíÑ Maquillage</option>
                        <option value="regie">üé≠ R√©gie</option>
                        <option value="production">üíº Production</option>
                        <option value="postprod">üéûÔ∏è Post-prod</option>
                    </select>
                    <input type="text" class="global-search-input" id="contact-filter-role" placeholder="Fonction..." style="width:130px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-camera" placeholder="üì∑ Cam√©ra..." style="width:130px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-equipment" placeholder="üîß Mat√©riel..." style="width:130px;" oninput="app.Contacts.searchDirectory()">
                </div>
            `;
        } else if(tab === 'projects') {
            filtersDiv.innerHTML = `
                <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                    <input type="text" class="global-search-input" id="contact-filter-name" placeholder="üîç Titre..." style="min-width:150px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city" placeholder="üìç Lieu..." oninput="app.Contacts.searchDirectory()">
                    <select class="global-search-input" id="contact-filter-projectType" onchange="app.Contacts.searchDirectory()">
                        <option value="">Tous types</option>
                        <option value="court-metrage">Court-m√©trage</option>
                        <option value="long-metrage">Long-m√©trage</option>
                        <option value="serie">S√©rie</option>
                        <option value="documentaire">Documentaire</option>
                        <option value="clip">Clip</option>
                        <option value="pub">Publicit√©</option>
                    </select>
                    <select class="global-search-input" id="contact-filter-genre" onchange="app.Contacts.searchDirectory()">
                        <option value="">Tous genres</option>
                        <option value="drame">Drame</option>
                        <option value="comedie">Com√©die</option>
                        <option value="thriller">Thriller</option>
                        <option value="horreur">Horreur</option>
                        <option value="sf">Science-Fiction</option>
                        <option value="fantastique">Fantastique</option>
                    </select>
                </div>
            `;
        } else if(tab === 'associations') {
            filtersDiv.innerHTML = `
                <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                    <input type="text" class="global-search-input" id="contact-filter-name" placeholder="üîç Nom..." style="min-width:150px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city" placeholder="üìç Ville..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-activity" placeholder="üéØ Activit√©..." style="width:150px;" oninput="app.Contacts.searchDirectory()">
                </div>
            `;
        } else if(tab === 'enterprises') {
            filtersDiv.innerHTML = `
                <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                    <input type="text" class="global-search-input" id="contact-filter-name" placeholder="üîç Nom..." style="min-width:150px;" oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-city" placeholder="üìç Ville..." oninput="app.Contacts.searchDirectory()">
                    <input type="text" class="global-search-input" id="contact-filter-activity" placeholder="üéØ Activit√©..." style="width:150px;" oninput="app.Contacts.searchDirectory()">
                </div>
            `;
        }
    },
    
    searchDirectory: async () => {
        const tab = Contacts.currentTab;
        const dbPaths = {
            actors: 'public_actors',
            crew: 'public_crew',
            projects: 'public_projects',
            associations: 'public_associations',
            enterprises: 'public_enterprises'
        };
        const dbPath = dbPaths[tab] || 'public_actors';
        
        els.contactsList.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);">üîÑ Recherche...</div>';
        
        try {
            const snap = await firebase.database().ref(dbPath).once('value');
            let results = snap.val() ? Object.values(snap.val()) : [];
            
            // Filtrer profils complets uniquement
            results = results.filter(r => r.profileComplete);
            
            // Appliquer filtres
            const name = (document.getElementById('contact-filter-name')?.value || '').toLowerCase();
            const city = (document.getElementById('contact-filter-city')?.value || '').toLowerCase();
            
            if(name) results = results.filter(r => (r.name || '').toLowerCase().includes(name));
            if(city) results = results.filter(r => (r.city || '').toLowerCase().includes(city));
            
            if(tab === 'actors') {
                const gender = document.getElementById('contact-filter-gender')?.value;
                const ethnicity = document.getElementById('contact-filter-ethnicity')?.value;
                const sports = (document.getElementById('contact-filter-sports')?.value || '').toLowerCase();
                const languages = (document.getElementById('contact-filter-languages')?.value || '').toLowerCase();
                
                if(gender) results = results.filter(r => r.gender === gender);
                if(ethnicity) results = results.filter(r => r.ethnicity === ethnicity);
                if(sports) results = results.filter(r => (r.sports || '').toLowerCase().includes(sports));
                if(languages) results = results.filter(r => (r.languages || '').toLowerCase().includes(languages));
            } else if(tab === 'crew') {
                const department = document.getElementById('contact-filter-department')?.value;
                const role = (document.getElementById('contact-filter-role')?.value || '').toLowerCase();
                const camera = (document.getElementById('contact-filter-camera')?.value || '').toLowerCase();
                const equipment = (document.getElementById('contact-filter-equipment')?.value || '').toLowerCase();
                
                if(department) results = results.filter(r => r.department === department);
                if(role) results = results.filter(r => (r.role || '').toLowerCase().includes(role));
                if(camera) results = results.filter(r => (r.cameras || []).some(c => c.toLowerCase().includes(camera)));
                if(equipment) {
                    results = results.filter(r => {
                        const allEquip = [...(r.cameras || []), ...(r.lenses || []), ...(r.otherEquipment || [])].join(' ').toLowerCase();
                        return allEquip.includes(equipment);
                    });
                }
            } else if(tab === 'projects') {
                const projectType = document.getElementById('contact-filter-projectType')?.value;
                const genre = document.getElementById('contact-filter-genre')?.value;
                
                if(projectType) results = results.filter(r => r.projectType === projectType);
                if(genre) results = results.filter(r => r.genre === genre);
            } else if(tab === 'associations' || tab === 'enterprises') {
                const activity = (document.getElementById('contact-filter-activity')?.value || '').toLowerCase();
                
                if(activity) results = results.filter(r => (r.activity || r.description || '').toLowerCase().includes(activity));
            }
            
            Contacts.directoryResults = results;
            Contacts.renderDirectory();
            
        } catch(e) {
            console.error('Erreur recherche annuaire:', e);
            els.contactsList.innerHTML = '<div style="text-align:center; padding:40px; color:var(--danger);">‚ùå Erreur de recherche</div>';
        }
    },
    
    renderDirectory: () => {
        const results = Contacts.directoryResults;
        const tab = Contacts.currentTab;
        
        if(results.length === 0) {
            els.contactsList.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-sec);">
                <p style="font-size: 1.2rem; margin-bottom: 10px;">Aucun profil trouv√©</p>
                <p style="font-size: 0.9rem;">Essayez d'√©largir vos crit√®res de recherche</p>
            </div>`;
            return;
        }
        
        let html = `<div style="grid-column: 1/-1; margin-bottom:10px; color:var(--text-sec);">${results.length} profil${results.length > 1 ? 's' : ''} trouv√©${results.length > 1 ? 's' : ''}</div>`;
        
        results.forEach((person, idx) => {
            const photoHTML = person.photo 
                ? `<img src="${person.photo}" alt="${person.name}">`
                : 'üë§';
            
            let metaHTML = '';
            let defaultIcon = 'üë§';
            if(tab === 'actors') {
                const details = [];
                if(person.age) details.push(person.age + ' ans');
                if(person.city) details.push('üìç ' + person.city);
                metaHTML = details.join(' ‚Ä¢ ');
                defaultIcon = 'üé≠';
            } else if(tab === 'crew') {
                metaHTML = person.role || '';
                if(person.city) metaHTML += ' ‚Ä¢ üìç ' + person.city;
                defaultIcon = 'üé•';
            } else if(tab === 'projects') {
                metaHTML = person.projectType || '';
                if(person.genre) metaHTML += ' ‚Ä¢ ' + person.genre;
                if(person.city) metaHTML += ' ‚Ä¢ üìç ' + person.city;
                defaultIcon = 'üé¨';
            } else if(tab === 'associations') {
                metaHTML = person.activity || '';
                if(person.city) metaHTML += ' ‚Ä¢ üìç ' + person.city;
                defaultIcon = 'üèõÔ∏è';
            } else if(tab === 'enterprises') {
                metaHTML = person.activity || '';
                if(person.city) metaHTML += ' ‚Ä¢ üìç ' + person.city;
                defaultIcon = 'üè¢';
            }
            
            // V√©rifier si d√©j√† dans favoris
            const isInFavorites = state.contacts && state.contacts[Contacts.currentTab] && 
                state.contacts[Contacts.currentTab].some(c => c.email === person.email);
            
            html += `<div class="contact-card">
                <div class="contact-card-header">
                    <div class="contact-card-photo">${photoHTML}</div>
                    <div>
                        <div class="contact-card-name">${Utils.escape(person.name || person.title || person.assoName || person.entName || 'Sans nom')}</div>
                        <div class="contact-card-role">${metaHTML}</div>
                    </div>
                </div>
                <div class="contact-card-info">
                    ${person.email ? `üìß ${person.email}<br>` : ''}
                    ${person.phone ? `üì± ${person.phone}<br>` : ''}
                    ${person.hasVehicle ? 'üöó V√©hicule disponible' : ''}
                </div>
                <div class="contact-card-actions">
                    <button onclick="app.Contacts.viewDirectoryProfile(${idx})">üëÅÔ∏è Voir</button>
                    <button onclick="app.Contacts.addToFavorites(${idx})" style="${isInFavorites ? 'opacity:0.5; cursor:not-allowed;' : ''}" ${isInFavorites ? 'disabled' : ''}>${isInFavorites ? '‚≠ê D√©j√† favori' : '‚≠ê Ajouter aux favoris'}</button>
                </div>
            </div>`;
        });
        
        els.contactsList.innerHTML = html;
    },
    
    viewDirectoryProfile: (idx) => {
        const person = Contacts.directoryResults[idx];
        if(!person) return;
        
        const tab = Contacts.currentTab;
        const displayName = person.name || person.title || person.assoName || person.entName || 'Sans nom';
        let defaultIcon = 'üë§';
        
        let detailsHTML = '';
        if(tab === 'actors') {
            defaultIcon = 'üé≠';
            detailsHTML = `
                <p><strong>√Çge:</strong> ${person.age || 'N/A'} ans</p>
                <p><strong>Taille:</strong> ${person.height || 'N/A'} cm</p>
                <p><strong>Yeux:</strong> ${person.eyeColor || 'N/A'}</p>
                <p><strong>Cheveux:</strong> ${person.hairColor || 'N/A'}</p>
                <p><strong>Origine:</strong> ${person.ethnicity || 'N/A'}</p>
                ${person.sports ? `<p><strong>Sports:</strong> ${person.sports}</p>` : ''}
                ${person.languages ? `<p><strong>Langues:</strong> ${person.languages}</p>` : ''}
            `;
        } else if(tab === 'crew') {
            defaultIcon = 'üé•';
            detailsHTML = `
                <p><strong>D√©partement:</strong> ${person.department || 'N/A'}</p>
                <p><strong>Fonction:</strong> ${person.role || 'N/A'}</p>
                ${person.cameras && person.cameras.length > 0 ? `<p><strong>Cam√©ras:</strong> ${person.cameras.join(', ')}</p>` : ''}
                ${person.lenses && person.lenses.length > 0 ? `<p><strong>Objectifs:</strong> ${person.lenses.join(', ')}</p>` : ''}
                ${person.otherEquipment && person.otherEquipment.length > 0 ? `<p><strong>Mat√©riel:</strong> ${person.otherEquipment.join(', ')}</p>` : ''}
            `;
        } else if(tab === 'projects') {
            defaultIcon = 'üé¨';
            detailsHTML = `
                <p><strong>Type:</strong> ${person.projectType || 'N/A'}</p>
                <p><strong>Genre:</strong> ${person.genre || 'N/A'}</p>
                ${person.director ? `<p><strong>R√©alisateur:</strong> ${person.director}</p>` : ''}
                ${person.producer ? `<p><strong>Producteur:</strong> ${person.producer}</p>` : ''}
                ${person.status ? `<p><strong>Statut:</strong> ${person.status}</p>` : ''}
            `;
        } else if(tab === 'associations') {
            defaultIcon = 'üèõÔ∏è';
            detailsHTML = `
                <p><strong>Activit√©:</strong> ${person.activity || 'N/A'}</p>
                ${person.members ? `<p><strong>Membres:</strong> ${person.members}</p>` : ''}
                ${person.website ? `<p><strong>Site web:</strong> <a href="${person.website}" target="_blank">${person.website}</a></p>` : ''}
            `;
        } else if(tab === 'enterprises') {
            defaultIcon = 'üè¢';
            detailsHTML = `
                <p><strong>Activit√©:</strong> ${person.activity || 'N/A'}</p>
                ${person.siret ? `<p><strong>SIRET:</strong> ${person.siret}</p>` : ''}
                ${person.website ? `<p><strong>Site web:</strong> <a href="${person.website}" target="_blank">${person.website}</a></p>` : ''}
            `;
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10001;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        const isInFavorites = state.contacts && state.contacts[Contacts.currentTab] && 
            state.contacts[Contacts.currentTab].some(c => c.email === person.email);
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
                <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                    <div style="width:80px;height:80px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:2.5rem;overflow:hidden;">
                        ${person.photo ? `<img src="${person.photo}" style="width:100%;height:100%;object-fit:cover;">` : defaultIcon}
                    </div>
                    <div>
                        <h2 style="margin:0;">${Utils.escape(displayName)}</h2>
                        <p style="margin:5px 0 0;color:var(--text-sec);">üìç ${person.city || 'Non pr√©cis√©'}</p>
                    </div>
                </div>
                ${person.bio || person.description ? `<p style="margin-bottom:15px;">${Utils.escape(person.bio || person.description)}</p>` : ''}
                <div style="background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px;">
                    ${detailsHTML}
                </div>
                <div style="background:var(--bg);padding:15px;border-radius:8px;margin-bottom:15px;">
                    <p><strong>üìß Email:</strong> ${person.email || 'N/A'}</p>
                    <p><strong>üì± T√©l√©phone:</strong> ${person.phone || 'N/A'}</p>
                    <p><strong>üí∞ Tarif:</strong> ${person.dailyRate || 'N/A'} ${person.rateCurrency || '‚Ç¨'} / jour</p>
                    ${person.hasVehicle ? `<p><strong>üöó V√©hicule:</strong> ${person.vehicleType || 'Oui'}</p>` : ''}
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;cursor:pointer;">Fermer</button>
                    <button onclick="app.Contacts.addToFavorites(${idx}); this.closest('div[style*=fixed]').remove();" style="flex:1;padding:12px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;" ${isInFavorites ? 'disabled style="flex:1;padding:12px;background:var(--text-sec);color:white;border:none;border-radius:6px;cursor:not-allowed;"' : ''}>${isInFavorites ? '‚≠ê D√©j√† dans favoris' : '‚≠ê Ajouter aux favoris'}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    addToFavorites: async (idx) => {
        const person = Contacts.directoryResults[idx];
        if(!person) return;
        
        const type = Contacts.currentTab;
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        // Cr√©er l'entr√©e contact
        const contactData = { ...person };
        contactData.id = person.id || ('contact_' + Date.now());
        contactData.savedAt = new Date().toISOString();
        
        try {
            await firebase.database().ref(`user_contacts/${emailKey}/${type}/${contactData.id}`).set(contactData);
            
            // Mettre √† jour en local
            if(!state.contacts) state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
            if(!state.contacts[type]) state.contacts[type] = [];
            state.contacts[type].push(contactData);
            
            Utils.toast(`${person.name} ajout√©(e) √† vos favoris !`, 'success');
            Contacts.renderDirectory();
        } catch(e) {
            console.error('Erreur ajout favoris:', e);
            Utils.toast('Erreur lors de l\'ajout', 'error');
        }
    },
    
    loadAndRender: async () => {
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        try {
            const actorsSnap = await firebase.database().ref(`user_contacts/${emailKey}/actors`).once('value');
            const crewSnap = await firebase.database().ref(`user_contacts/${emailKey}/crew`).once('value');
            const projectsSnap = await firebase.database().ref(`user_contacts/${emailKey}/projects`).once('value');
            const assocSnap = await firebase.database().ref(`user_contacts/${emailKey}/associations`).once('value');
            const enterSnap = await firebase.database().ref(`user_contacts/${emailKey}/enterprises`).once('value');
            state.contacts = {
                actors: actorsSnap.val() ? Object.values(actorsSnap.val()) : [],
                crew: crewSnap.val() ? Object.values(crewSnap.val()) : [],
                projects: projectsSnap.val() ? Object.values(projectsSnap.val()) : [],
                associations: assocSnap.val() ? Object.values(assocSnap.val()) : [],
                enterprises: enterSnap.val() ? Object.values(enterSnap.val()) : []
            };
        } catch(e) {
            console.error('Erreur chargement contacts:', e);
            state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
        }
        Contacts.render();
    },
    
    render: () => {
        const tab = Contacts.currentTab;
        const list = state.contacts[tab] || [];
        
        const tabLabels = {
            actors: 'com√©dien.ne',
            crew: 'technicien.ne',
            projects: 'projet',
            associations: 'association',
            enterprises: 'entreprise'
        };
        const tabIcons = {
            actors: 'üé≠',
            crew: 'üé•',
            projects: 'üé¨',
            associations: 'üèõÔ∏è',
            enterprises: 'üè¢'
        };
        
        if(!list || list.length === 0) {
            els.contactsList.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-sec);">
                <p style="font-size: 1.2rem; margin-bottom: 10px;">Aucun ${tabLabels[tab] || 'contact'} en favoris</p>
                <p style="font-size: 0.9rem;">Ajoutez des favoris depuis l'Annuaire ou l'Univers en cliquant sur ‚≠ê</p>
            </div>`;
            return;
        }
        
        let html = '';
        list.forEach((contact, idx) => {
            const displayName = contact.name || contact.title || contact.assoName || contact.entName || 'Sans nom';
            const photoHTML = contact.photo 
                ? `<img src="${contact.photo}" alt="${displayName}">`
                : tabIcons[tab] || 'üë§';
            
            let roleOrDept = '';
            if(tab === 'actors') {
                roleOrDept = contact.linkedCharacter || contact.city || '';
            } else if(tab === 'crew') {
                roleOrDept = contact.role || contact.department || '';
            } else if(tab === 'projects') {
                roleOrDept = contact.projectType || contact.genre || '';
            } else if(tab === 'associations' || tab === 'enterprises') {
                roleOrDept = contact.activity || contact.city || '';
            }
            
            html += `<div class="contact-card">
                <div class="contact-card-header">
                    <div class="contact-card-photo">${photoHTML}</div>
                    <div>
                        <div class="contact-card-name">${Utils.escape(displayName)}</div>
                        <div class="contact-card-role">${Utils.escape(roleOrDept)}</div>
                    </div>
                </div>
                <div class="contact-card-info">
                    ${contact.email ? `üìß ${contact.email}<br>` : ''}
                    ${contact.phone ? `üì± ${contact.phone}<br>` : ''}
                    ${contact.website ? `üåê ${contact.website}<br>` : ''}
                    ${contact.hasVehicle ? 'üöó V√©hicule disponible' : ''}
                </div>
                <div class="contact-card-actions">
                    <button onclick="app.Contacts.edit('${tab}', ${idx})">‚úèÔ∏è Modifier</button>
                    <button onclick="app.Contacts.delete('${tab}', ${idx})" style="color: var(--danger);">üóëÔ∏è Supprimer</button>
                </div>
            </div>`;
        });
        
        els.contactsList.innerHTML = html;
    },
    
    saveActorToContacts: async (idx) => {
        const data = state.data.actors[idx];
        if(!data) return;
        await Contacts.saveToContacts('actors', data);
        UI.renderDataTab('actors', els.actorContainer);
    },
    
    saveCrewToContacts: async (idx) => {
        const data = state.data.crew[idx];
        if(!data) return;
        await Contacts.saveToContacts('crew', data);
        UI.renderCrewTab();
    },
    
    saveToContacts: async (type, data) => {
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        const contactData = {
            id: data.id || ('contact_' + Date.now()),
            name: data.name,
            gender: data.gender || '',
            photo: data.photo || '',
            email: data.email || '',
            phone: data.phone || '',
            address: data.address || '',
            website: data.website || '',
            bio: data.bio || '',
            hasVehicle: data.hasVehicle || false,
            vehicleType: data.vehicleType || '',
            vehiclePlate: data.vehiclePlate || '',
            vehicleSeats: data.vehicleSeats || '',
            vehicleTrunk: data.vehicleTrunk || false,
            vehicleNotes: data.vehicleNotes || '',
            dailyRate: data.dailyRate || '',
            rateCurrency: data.rateCurrency || '‚Ç¨',
            rateType: data.rateType || 'Jour',
            availabilityText: data.availabilityText || '',
            availabilityDates: data.availabilityDates || [],
            height: data.height || '',
            weight: data.weight || '',
            age: data.age || '',
            eyeColor: data.eyeColor || '',
            hairColor: data.hairColor || '',
            hairLength: data.hairLength || '',
            ethnicity: data.ethnicity || '',
            bustSize: data.bustSize || '',
            bustType: data.bustType || '',
            corpulence: data.corpulence || '',
            sports: data.sports || '',
            languages: data.languages || '',
            savedAt: new Date().toISOString()
        };
        
        if(type === 'crew') {
            contactData.role = data.role || '';
            contactData.department = data.group_id || '';
        }
        
        try {
            await firebase.database().ref(`user_contacts/${emailKey}/${type}/${contactData.id}`).set(contactData);
            // Recharger les contacts en m√©moire
            if(!state.contacts) state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
            if(!state.contacts[type]) state.contacts[type] = [];
            const list = state.contacts[type];
            const existingIdx = list.findIndex(c => c.id === contactData.id);
            if(existingIdx > -1) {
                list[existingIdx] = contactData;
            } else {
                list.push(contactData);
            }
            Utils.toast('Contact sauvegard√© !', 'success');
            return true;
        } catch(e) {
            console.error('Erreur sauvegarde contact:', e);
            Utils.toast('Erreur lors de la sauvegarde', 'error');
            return false;
        }
    },
    
    delete: async (type, idx) => {
        if(!await ConfirmModal.confirmDelete("Ce contact sera supprim√©.")) return;
        
        const list = type === 'actors' ? state.contacts.actors : state.contacts.crew;
        const contact = list[idx];
        if(!contact) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        try {
            await firebase.database().ref(`user_contacts/${emailKey}/${type}/${contact.id}`).remove();
            list.splice(idx, 1);
            Contacts.render();
        } catch(e) {
            console.error('Erreur suppression contact:', e);
            Utils.toast('Erreur lors de la suppression', 'error');
        }
    },
    
    edit: (type, idx) => {
        Utils.toast('Fonctionnalit√© d\'√©dition √† venir !', 'info');
    },
    
    isInContacts: (type, id) => {
        if(!state.contacts) return false;
        const list = type === 'actors' ? state.contacts.actors : state.contacts.crew;
        return list && list.some(c => c.id === id);
    },
    
    importToProject: async (type) => {
        if(!state.contacts) await Contacts.loadAndRender();
        
        const list = type === 'actors' ? state.contacts.actors : state.contacts.crew;
        if(!list || list.length === 0) {
            Utils.toast('Aucun contact √† importer. Ajoutez d\'abord des contacts depuis vos projets.', 'warning');
            return;
        }
        
        let html = `<div style="max-height: 400px; overflow-y: auto;">`;
        list.forEach((contact, idx) => {
            const alreadyInProject = type === 'actors' 
                ? state.data.actors.some(a => a.id === contact.id)
                : state.data.crew.some(c => c.id === contact.id);
            
            html += `<label style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); cursor: ${alreadyInProject ? 'not-allowed' : 'pointer'}; opacity: ${alreadyInProject ? '0.5' : '1'};">
                <input type="checkbox" ${alreadyInProject ? 'disabled checked' : ''} data-idx="${idx}">
                <span>${Utils.escape(contact.name)}</span>
                ${alreadyInProject ? '<span style="font-size: 0.8rem; color: var(--text-sec);">(d√©j√† ajout√©)</span>' : ''}
            </label>`;
        });
        html += `</div>`;
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10000;';
        modal.innerHTML = `<div style="background:var(--panel-bg);border-radius:12px;padding:20px;max-width:500px;width:90%;">
            <h3 style="margin:0 0 15px 0;">üìá Importer des contacts</h3>
            ${html}
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:15px;">
                <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:10px 20px;border:1px solid var(--border);background:var(--bg);border-radius:6px;cursor:pointer;">Annuler</button>
                <button onclick="app.Contacts.doImport('${type}', this.closest('div[style*=fixed]'))" style="padding:10px 20px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">Importer</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    },
    
    doImport: (type, modal) => {
        const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked:not([disabled])');
        const list = type === 'actors' ? state.contacts.actors : state.contacts.crew;
        
        checkboxes.forEach(cb => {
            const idx = parseInt(cb.dataset.idx);
            const contact = list[idx];
            if(!contact) return;
            
            const newEntry = { ...contact };
            newEntry.availabilityDates = [];
            newEntry.availabilityText = '';
            delete newEntry.savedAt;
            
            if(type === 'actors') {
                state.data.actors.push(newEntry);
            } else {
                state.data.crew.push(newEntry);
            }
        });
        
        Store.save();
        modal.remove();
        
        if(type === 'actors') {
            UI.renderDataTab('actors', els.actorContainer);
        } else {
            UI.renderCrewTab();
        }
        
        Utils.toast(`${checkboxes.length} contact(s) import√©(s) !`, 'success');
    }
};
  
  const Planning = {
    currentView: 'month',
    currentMode: 'calendar',
    currentDate: new Date(),
    editingDayId: null,
    weatherCache: {},
    
    // Types de journ√©es avec leurs couleurs et ic√¥nes
    dayTypes: {
        'tournage': { icon: 'üé¨', color: '#FF9800', label: 'Tournage' },
        'repetition': { icon: 'üé≠', color: '#9C27B0', label: 'R√©p√©tition' },
        'reperage': { icon: 'üîç', color: '#00BCD4', label: 'Rep√©rage' },
        'essai-costume': { icon: 'üëó', color: '#E91E63', label: 'Essai costume' },
        'essai-maquillage': { icon: 'üíÑ', color: '#F06292', label: 'Essai maquillage' },
        'formation': { icon: 'üìö', color: '#3F51B5', label: 'Formation' },
        'reunion': { icon: 'üìã', color: '#607D8B', label: 'R√©union' },
        'autre': { icon: 'üìå', color: '#795548', label: 'Autre' }
    },
    
    getDayTypeInfo: (dayType) => {
        return Planning.dayTypes[dayType] || Planning.dayTypes['tournage'];
    },
    
    init: () => {
        Planning.render();
    },
    
    // Basculer entre Calendrier et Kanban
    setMode: (mode) => {
        Planning.currentMode = mode;
        
        // Mettre √† jour les boutons
        document.getElementById('planning-mode-calendar').classList.toggle('active', mode === 'calendar');
        document.getElementById('planning-mode-kanban').classList.toggle('active', mode === 'kanban');
        document.getElementById('planning-mode-workplan').classList.toggle('active', mode === 'workplan');
        
        // Afficher/masquer les vues
        document.getElementById('planningContainer').style.display = mode === 'calendar' ? 'block' : 'none';
        document.getElementById('kanbanContainer').style.display = mode === 'kanban' ? 'block' : 'none';
        document.getElementById('workplanContainer').style.display = mode === 'workplan' ? 'block' : 'none';
        document.getElementById('calendar-view-toggle').style.display = mode === 'calendar' ? 'flex' : 'none';
        
        // Masquer navigation et actions en mode plan de travail (visibility pour garder l'espace)
        document.querySelector('.planning-nav').style.visibility = mode === 'workplan' ? 'hidden' : 'visible';
        document.querySelector('.planning-actions').style.display = mode === 'workplan' ? 'none' : 'flex';
        
        if(mode === 'kanban') {
            Planning.renderKanban();
        } else if(mode === 'workplan') {
            Planning.renderWorkPlan();
        }
    },
    
    // Afficher le Plan de Travail
    // Afficher le Plan de Travail (DOOD)
    renderWorkPlan: () => {
        const shootDays = (state.data.shootingDays || []).slice().sort((a, b) => {
            const dateA = new Date(a.startDate || a.date);
            const dateB = new Date(b.startDate || b.date);
            return dateA - dateB;
        });
        
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const characters = state.data.characters || [];
        
        // √âtat vide
        if(shootDays.length === 0) {
            document.getElementById('workplanContent').innerHTML = `
                <div class="workplan-empty">
                    <div class="workplan-empty-icon">üìã</div>
                    <h3 style="margin-bottom: 10px;">Aucun jour de tournage planifi√©</h3>
                    <p style="color: #666; margin-bottom: 20px;">Ajoutez des jours de tournage dans le calendrier pour g√©n√©rer le plan de travail.</p>
                    <button onclick="app.Planning.setMode('calendar')" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">üìÖ Aller au calendrier</button>
                </div>`;
            return;
        }
        
        // Cr√©er mapping pr√©sences : qui travaille quel jour
        const buildPresenceMap = () => {
            const map = {};
            
            // Init pour chaque acteur
            actors.forEach(actor => {
                map[`actor_${actor.id}`] = { type: 'actor', person: actor, days: {} };
            });
            
            // Init pour chaque technicien
            crew.forEach(member => {
                map[`crew_${member.id}`] = { type: 'crew', person: member, days: {} };
            });
            
            // Parcourir les jours et leurs callSheets
            shootDays.forEach((day, dayIdx) => {
                (day.callSheet || []).forEach(call => {
                    const key = `${call.type}_${call.personId}`;
                    if(map[key]) {
                        map[key].days[dayIdx] = { callTime: call.callTime, notes: call.notes };
                    }
                });
            });
            
            return map;
        };
        
        const presenceMap = buildPresenceMap();
        
        // D√©terminer le code pour chaque cellule (SW, W, WF, H, etc.)
        const getCellCode = (personKey, dayIdx) => {
            const data = presenceMap[personKey];
            
            // V√©rifier s'il y a un override manuel (V, R, H ajout√©s manuellement)
            const overrideKey = `${personKey}_${dayIdx}`;
            const override = (state.data.workplanOverrides || {})[overrideKey];
            if(override) return override;
            
            if(!data) return '';
            
            const days = Object.keys(data.days).map(Number).sort((a,b) => a - b);
            if(days.length === 0) return '';
            
            const firstDay = days[0];
            const lastDay = days[days.length - 1];
            const isWorkingThisDay = data.days[dayIdx] !== undefined;
            
            // Hors p√©riode de contrat
            if(dayIdx < firstDay || dayIdx > lastDay) return '';
            
            // Un seul jour de travail total
            if(days.length === 1 && isWorkingThisDay) return 'T';
            
            // Premier jour
            if(dayIdx === firstDay) return 'SW';
            
            // Dernier jour
            if(dayIdx === lastDay) return 'WF';
            
            // Entre premier et dernier jour
            if(isWorkingThisDay) return 'W'; // Travaille
            return 'H'; // Hold (pas convoqu√© mais sous contrat)
        };
        
        // Trouver le personnage associ√© √† un acteur
        const getCharacterForActor = (actorId) => {
            const char = characters.find(c => c.actorId === actorId);
            return char ? char.name : '';
        };
        
        // Compter les jours de travail
        const countWorkDays = (personKey) => {
            const data = presenceMap[personKey];
            if(!data) return 0;
            return Object.keys(data.days).length;
        };
        
        // Dates du tournage
        const firstDate = new Date(shootDays[0].startDate || shootDays[0].date);
        const lastDate = new Date(shootDays[shootDays.length - 1].startDate || shootDays[shootDays.length - 1].date);
        const formatDate = (d) => d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        // Construction HTML
        let html = '<div class="workplan-wrapper">';
        
        // En-t√™te avec infos film
        html += `
            <div class="workplan-header-box">
                <div>
                    <div class="workplan-header-title">${Utils.escape(state.data.title || 'Sans titre')}</div>
                    <div class="workplan-header-subtitle">Plan de travail</div>
                </div>
                <div class="workplan-header-info">
                    <strong>Tournage :</strong> Du ${formatDate(firstDate)} au ${formatDate(lastDate)}<br>
                    <strong>Jours :</strong> ${shootDays.length} jour${shootDays.length > 1 ? 's' : ''} de tournage<br>
                    <strong>Com√©diens :</strong> ${actors.length}
                </div>
                <div class="workplan-header-version">
                    <strong>Version n¬∞1</strong><br>
                    G√©n√©r√© le ${formatDate(new Date())}
                </div>
            </div>`;
        
        // Tableau principal
        html += '<table class="workplan-table"><thead><tr>';
        html += '<th class="workplan-col-num">N¬∞</th>';
        html += '<th class="workplan-col-role">R√îLE</th>';
        html += '<th class="workplan-col-actor">COM√âDIEN.NE</th>';
        
        // En-t√™tes des jours
        shootDays.forEach((day, idx) => {
            const date = new Date(day.startDate || day.date);
            const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' }).substring(0, 2);
            const dayNum = date.getDate();
            const month = date.toLocaleDateString('fr-FR', { month: 'short' }).substring(0, 3);
            html += `<th class="workplan-col-day" title="J${idx + 1} - ${date.toLocaleDateString('fr-FR')}">${dayName}<br>${dayNum}<br>${month}</th>`;
        });
        
        html += '<th class="workplan-col-total">TOTAL</th>';
        html += '</tr></thead><tbody>';
        
        // Section Com√©diens
        if(actors.length > 0) {
            html += `<tr class="workplan-section-row"><td colspan="${shootDays.length + 4}">üé≠ COM√âDIEN.NES</td></tr>`;
            
            actors.forEach((actor, idx) => {
                const personKey = `actor_${actor.id}`;
                const character = getCharacterForActor(actor.id);
                const totalDays = countWorkDays(personKey);
                
                html += '<tr>';
                html += `<td class="workplan-cell-num">${idx + 1}</td>`;
                html += `<td class="workplan-cell-role">${Utils.escape(character || '‚Äî')}</td>`;
                html += `<td class="workplan-cell-actor">${Utils.escape(actor.name || 'Sans nom')}</td>`;
                
                // Cellules des jours
                shootDays.forEach((day, dayIdx) => {
                    const code = getCellCode(personKey, dayIdx);
                    const cellClass = code ? `workplan-bar-${code}` : 'workplan-bar-empty';
                    const isEditable = !['T', 'SW', 'W', 'WF'].includes(code);
                    const clickAttr = isEditable ? `onclick="app.Planning.openWorkplanMenu(event, '${personKey}', ${dayIdx})"` : '';
                    const cursorStyle = isEditable ? 'cursor: pointer;' : '';
                    html += `<td class="${cellClass}" style="${cursorStyle}" ${clickAttr}>${code}</td>`;
                });
                
                html += `<td class="workplan-cell-total">${totalDays}</td>`;
                html += '</tr>';
            });
        }
        
        // Section Techniciens
        if(crew.length > 0) {
            html += `<tr class="workplan-section-row"><td colspan="${shootDays.length + 4}">üé• TECHNICIEN.NES</td></tr>`;
            
            crew.forEach((member, idx) => {
                const personKey = `crew_${member.id}`;
                const totalDays = countWorkDays(personKey);
                
                html += '<tr>';
                html += `<td class="workplan-cell-num">${idx + 1}</td>`;
                html += `<td class="workplan-cell-role">${Utils.escape(member.role || '‚Äî')}</td>`;
                html += `<td class="workplan-cell-actor">${Utils.escape(member.name || 'Sans nom')}</td>`;
                
                // Cellules des jours
                shootDays.forEach((day, dayIdx) => {
                    const code = getCellCode(personKey, dayIdx);
                    const cellClass = code ? `workplan-bar-${code}` : 'workplan-bar-empty';
                    const isEditable = !['T', 'SW', 'W', 'WF'].includes(code);
                    const clickAttr = isEditable ? `onclick="app.Planning.openWorkplanMenu(event, '${personKey}', ${dayIdx})"` : '';
                    const cursorStyle = isEditable ? 'cursor: pointer;' : '';
                    html += `<td class="${cellClass}" style="${cursorStyle}" ${clickAttr}>${code}</td>`;
                });
                
                html += `<td class="workplan-cell-total">${totalDays}</td>`;
                html += '</tr>';
            });
        }
        
        html += '</tbody></table>';
        
        // Footer avec l√©gende et actions
        html += `
            <div class="workplan-footer">
                <div class="workplan-legend">
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-SW">SW</div> D√©but</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-W">W</div> Travaille</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-WF">WF</div> Fin</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-T">T</div> Travaille (1 jour)</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-H">H</div> Hold/Retenue</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-R">R</div> Repos</div>
                    <div class="workplan-legend-item"><div class="workplan-legend-box workplan-bar-V">V</div> Voyage</div>
                </div>
                <div class="workplan-actions">
                    <button onclick="app.Planning.printWorkPlan()">üñ®Ô∏è Imprimer</button>
                    <button onclick="app.Planning.renderWorkPlan()">üîÑ Actualiser</button>
                </div>
            </div>`;
        
        html += '</div>';
        
        document.getElementById('workplanContent').innerHTML = html;
    },
    
    // Ouvrir le menu pour modifier une cellule du plan de travail
    openWorkplanMenu: (event, personKey, dayIdx) => {
        event.stopPropagation();
        
        // Fermer un menu existant
        const existingMenu = document.getElementById('workplan-cell-menu');
        if(existingMenu) existingMenu.remove();
        
        // Cr√©er le menu
        const menu = document.createElement('div');
        menu.id = 'workplan-cell-menu';
        menu.className = 'workplan-cell-menu';
        menu.innerHTML = `
            <div class="workplan-menu-item" onclick="app.Planning.setWorkplanOverride('${personKey}', ${dayIdx}, 'H')"><span class="workplan-bar-H" style="padding: 2px 6px; border-radius: 3px;">H</span> Hold</div>
            <div class="workplan-menu-item" onclick="app.Planning.setWorkplanOverride('${personKey}', ${dayIdx}, 'V')"><span class="workplan-bar-V" style="padding: 2px 6px; border-radius: 3px;">V</span> Voyage</div>
            <div class="workplan-menu-item" onclick="app.Planning.setWorkplanOverride('${personKey}', ${dayIdx}, 'R')"><span class="workplan-bar-R" style="padding: 2px 6px; border-radius: 3px;">R</span> Repos</div>
            <div class="workplan-menu-divider"></div>
            <div class="workplan-menu-item" onclick="app.Planning.setWorkplanOverride('${personKey}', ${dayIdx}, null)">‚úï Effacer</div>
        `;
        
        // Positionner le menu
        menu.style.position = 'absolute';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        document.body.appendChild(menu);
        
        // Fermer au clic ailleurs
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            });
        }, 10);
    },
    
    // D√©finir une valeur manuelle dans le plan de travail
    setWorkplanOverride: (personKey, dayIdx, value) => {
        if(!state.data.workplanOverrides) state.data.workplanOverrides = {};
        
        const overrideKey = `${personKey}_${dayIdx}`;
        
        if(value === null) {
            delete state.data.workplanOverrides[overrideKey];
        } else {
            state.data.workplanOverrides[overrideKey] = value;
        }
        
        // Fermer le menu
        const menu = document.getElementById('workplan-cell-menu');
        if(menu) menu.remove();
        
        // Sauvegarder et rafra√Æchir
        Store.save();
        Planning.renderWorkPlan();
        
        Utils.toast(`Statut mis √† jour : ${value || 'effac√©'}`, 'success');
    },
    
    // R√©cup√©rer les √©l√©ments du d√©pouillement pour une personne selon son d√©partement
    getBreakdownItemsForPerson: (member, scenesIds) => {
        if(!member.group_id) return [];
        
        const categories = CONFIG.crewToBreakdownMap[member.group_id];
        if(!categories || categories.length === 0) return [];
        
        const items = [];
        
        scenesIds.forEach(sceneId => {
            const scene = state.data.scenes.find(s => s.id === sceneId);
            if(!scene || !scene.breakdown) return;
            
            const sceneIdx = state.data.scenes.indexOf(scene) + 1;
            
            categories.forEach(cat => {
                const catItems = scene.breakdown[cat] || [];
                catItems.forEach(item => {
                    items.push({
                        item: item,
                        category: cat,
                        sceneNum: sceneIdx,
                        sceneTitle: scene.title
                    });
                });
            });
        });
        
        return items;
    },
    
    // Imprimer le Plan de Travail
    printWorkPlan: () => {
        const content = document.getElementById('workplanContent').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Plan de Travail - ${state.data.title || 'Film'}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .workplan-wrapper { background: white; }
                    .workplan-header-box { border: 2px solid #333; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }
                    .workplan-header-title { font-size: 1.4rem; font-weight: bold; }
                    .workplan-header-subtitle { font-size: 0.9rem; color: #666; }
                    .workplan-header-info { font-size: 0.85rem; }
                    .workplan-header-version { text-align: right; font-size: 0.85rem; }
                    .workplan-table { width: 100%; border-collapse: collapse; font-size: 9px; }
                    .workplan-table th, .workplan-table td { border: 1px solid #999; padding: 3px 4px; text-align: center; }
                    .workplan-table thead th { background: #f0f0f0; font-weight: 600; }
                    .workplan-cell-num, .workplan-col-num { background: #f5f5f5; }
                    .workplan-cell-role, .workplan-col-role { text-align: left; width: 100px; }
                    .workplan-cell-actor, .workplan-col-actor { text-align: left; width: 110px; font-size: 8px; }
                    .workplan-cell-total, .workplan-col-total { background: #f5f5f5; font-weight: 600; }
                    .workplan-bar-T, .workplan-bar-SW, .workplan-bar-W, .workplan-bar-WF { background: #c0392b !important; color: white; font-weight: bold; }
                    .workplan-bar-H { background: #f39c12 !important; color: white; }
                    .workplan-bar-R { background: #3498db !important; color: white; }
                    .workplan-bar-V { background: #9b59b6 !important; color: white; }
                    .workplan-section-row td { background: #d5d5d5 !important; font-weight: 600; text-align: left; }
                    .workplan-footer { margin-top: 15px; }
                    .workplan-legend { display: flex; gap: 15px; flex-wrap: wrap; font-size: 10px; }
                    .workplan-legend-item { display: flex; align-items: center; gap: 4px; }
                    .workplan-legend-box { width: 20px; height: 14px; border: 1px solid #999; font-size: 8px; display: flex; align-items: center; justify-content: center; color: white; }
                    .workplan-actions { display: none; }
                    @page { size: landscape; margin: 10mm; }
                </style>
            </head>
            <body>${content}</body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    },
    
    // Afficher le Kanban
    renderKanban: () => {
        const scenes = state.data.scenes || [];
        const shootDays = state.data.shootingDays || [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // R√©cup√©rer le filtre de type
        const typeFilter = document.getElementById('kanban-type-filter')?.value || 'all';
        
        // Filtrer les jours par type si n√©cessaire
        const filteredDays = typeFilter === 'all' 
            ? shootDays 
            : shootDays.filter(day => (day.dayType || 'tournage') === typeFilter);
        
        // Cr√©er un mapping sc√®ne -> date de tournage (uniquement pour les jours filtr√©s)
        const sceneToDate = {};
        const sceneToDay = {}; // Pour r√©cup√©rer les infos du jour
        filteredDays.forEach(day => {
            const dateStr = day.startDate || day.date;
            if(dateStr && day.scenes) {
                day.scenes.forEach(sceneRef => {
                    const sceneId = sceneRef.sceneId || sceneRef;
                    sceneToDate[sceneId] = new Date(dateStr);
                    sceneToDay[sceneId] = day;
                });
            }
        });
        
        // Cat√©goriser les sc√®nes
        const todo = [];
        const planned = [];
        const shooting = [];
        const done = [];
        
        scenes.forEach(scene => {
            const sceneDate = sceneToDate[scene.id];
            
            if(!sceneDate) {
                // Pas dans le calendrier
                todo.push({ scene, date: null });
            } else {
                sceneDate.setHours(0, 0, 0, 0);
                if(sceneDate.getTime() === today.getTime()) {
                    // Aujourd'hui
                    shooting.push({ scene, date: sceneDate });
                } else if(sceneDate > today) {
                    // Futur
                    planned.push({ scene, date: sceneDate });
                } else {
                    // Pass√©
                    done.push({ scene, date: sceneDate });
                }
            }
        });
        
        // Fonction pour cr√©er une carte
        const createCard = (item) => {
            const scene = item.scene;
            const sceneIndex = scenes.findIndex(s => s.id === scene.id) + 1;
            const dateStr = item.date ? item.date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '';
            const intExt = scene.intExt || '';
            const dayNight = scene.dayNight || '';
            
            // R√©cup√©rer le type de journ√©e
            const day = sceneToDay[scene.id];
            const dayTypeInfo = day ? Planning.getDayTypeInfo(day.dayType) : null;
            const typeTag = dayTypeInfo ? `<span style="background:${dayTypeInfo.color}; color:white; padding:2px 6px; border-radius:4px; font-size:0.7rem;">${dayTypeInfo.icon} ${dayTypeInfo.label}</span>` : '';
            
            return `
                <div class="kanban-card" onclick="app.UI.switchTab('board')">
                    <div class="kanban-card-title">Sc. ${sceneIndex} - ${Utils.escape(scene.title || 'Sans titre')}</div>
                    <div class="kanban-card-info">
                        ${intExt ? `<span class="kanban-card-tag ${intExt.toLowerCase()}">${intExt}</span>` : ''}
                        ${dayNight ? `<span class="kanban-card-tag ${dayNight.toLowerCase()}">${dayNight}</span>` : ''}
                        ${typeTag}
                    </div>
                    ${scene.location ? `<div style="font-size: 0.75rem; color: var(--text-sec); margin-top: 4px;">üìç ${Utils.escape(scene.location)}</div>` : ''}
                    ${dateStr ? `<div class="kanban-card-date">üìÖ ${dateStr}</div>` : ''}
                </div>
            `;
        };
        
        // Remplir les colonnes
        document.getElementById('kanban-body-todo').innerHTML = todo.length ? todo.map(createCard).join('') : '<div style="color: var(--text-sec); text-align: center; padding: 20px;">Aucune sc√®ne</div>';
        document.getElementById('kanban-body-planned').innerHTML = planned.length ? planned.map(createCard).join('') : '<div style="color: var(--text-sec); text-align: center; padding: 20px;">Aucune sc√®ne</div>';
        document.getElementById('kanban-body-shooting').innerHTML = shooting.length ? shooting.map(createCard).join('') : '<div style="color: var(--text-sec); text-align: center; padding: 20px;">Aucune sc√®ne</div>';
        document.getElementById('kanban-body-done').innerHTML = done.length ? done.map(createCard).join('') : '<div style="color: var(--text-sec); text-align: center; padding: 20px;">Aucune sc√®ne</div>';
        
        // Mettre √† jour les compteurs
        document.getElementById('kanban-count-todo').textContent = todo.length;
        document.getElementById('kanban-count-planned').textContent = planned.length;
        document.getElementById('kanban-count-shooting').textContent = shooting.length;
        document.getElementById('kanban-count-done').textContent = done.length;
    },
    
    applyPermissions: () => {
        const canEdit = state.currentRole === 'owner' || Permissions.canEdit('planning');
        
        // D√©sactiver les boutons d'ajout si pas de permission
        const addButtons = document.querySelectorAll('#tab-planning button[onclick*="addShootingDay"], #tab-planning button[onclick*="editDay"]');
        addButtons.forEach(btn => {
            if(!canEdit) {
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
                btn.title = 'üîí Lecture seule';
            }
        });
        
        // D√©sactiver les clics sur les jours
        if(!canEdit) {
            const dayCells = document.querySelectorAll('.planning-day');
            dayCells.forEach(cell => {
                cell.style.cursor = 'default';
                const originalOnclick = cell.onclick;
                cell.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                };
            });
        }
    },
    
    setView: (view) => {
        Planning.currentView = view;
        document.querySelectorAll('.planning-view-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        Planning.render();
    },
    
    prev: () => {
        if(Planning.currentView === 'month') {
            Planning.currentDate.setMonth(Planning.currentDate.getMonth() - 1);
        } else if(Planning.currentView === 'week') {
            Planning.currentDate.setDate(Planning.currentDate.getDate() - 7);
        } else {
            Planning.currentDate.setDate(Planning.currentDate.getDate() - 1);
        }
        Planning.render();
    },
    
    next: () => {
        if(Planning.currentView === 'month') {
            Planning.currentDate.setMonth(Planning.currentDate.getMonth() + 1);
        } else if(Planning.currentView === 'week') {
            Planning.currentDate.setDate(Planning.currentDate.getDate() + 7);
        } else {
            Planning.currentDate.setDate(Planning.currentDate.getDate() + 1);
        }
        Planning.render();
    },
    
    goToday: () => {
        Planning.currentDate = new Date();
        Planning.render();
    },
    
    render: () => {
        Planning.renderAvailabilitySelectors();
        const container = document.getElementById('planningContainer');
        const titleEl = document.getElementById('planningTitle');
        
        const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        
        if(Planning.currentView === 'month') {
            titleEl.innerText = months[Planning.currentDate.getMonth()] + ' ' + Planning.currentDate.getFullYear();
            container.innerHTML = Planning.renderMonthView();
        } else if(Planning.currentView === 'week') {
            const weekStart = Planning.getWeekStart(Planning.currentDate);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            titleEl.innerText = `${weekStart.getDate()} - ${weekEnd.getDate()} ${months[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;
            container.innerHTML = Planning.renderWeekView();
        } else {
            titleEl.innerText = `${days[Planning.currentDate.getDay()]} ${Planning.currentDate.getDate()} ${months[Planning.currentDate.getMonth()]} ${Planning.currentDate.getFullYear()}`;
            container.innerHTML = Planning.renderDayView();
        }
    },
    
    getWeekStart: (date) => {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    },
    
    formatDate: (date) => {
        const d = new Date(date);
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    },
    
    getShootDay: (dateStr) => {
        if(!state.data.shootingDays) return null;
        return state.data.shootingDays.find(sd => {
            const start = sd.startDate || sd.date;
            const end = sd.endDate || sd.startDate || sd.date;
            return dateStr >= start && dateStr <= end;
        });
    },
    
    getShootDayByStartDate: (dateStr) => {
        if(!state.data.shootingDays) return null;
        return state.data.shootingDays.find(sd => (sd.startDate || sd.date) === dateStr);
    },
    
    renderMonthView: () => {
        const year = Planning.currentDate.getFullYear();
        const month = Planning.currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        const today = Planning.formatDate(new Date());
        
        let html = '<div class="planning-calendar">';
        html += '<div class="planning-weekdays">';
        ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(d => {
            html += `<div class="planning-weekday">${d}</div>`;
        });
        html += '</div>';
        html += '<div class="planning-days">';
        
        // Previous month days
        const prevMonth = new Date(year, month, 0);
        for(let i = startDay - 1; i >= 0; i--) {
            const day = prevMonth.getDate() - i;
            const dateStr = Planning.formatDate(new Date(year, month - 1, day));
            const shootDay = Planning.getShootDay(dateStr);
            html += `<div class="planning-day other-month" data-date="${dateStr}" onclick="app.Planning.openDay('${dateStr}')" ondragover="app.Planning.onDragOver(event)" ondrop="app.Planning.onDrop(event, '${dateStr}')">
                <div class="planning-day-number">${day}</div>
                ${shootDay ? (() => { const typeInfo = Planning.getDayTypeInfo(shootDay.dayType); return `<div class="planning-day-shoot" style="background: ${typeInfo.color};" draggable="true" ondragstart="app.Planning.onDragStart(event, '${shootDay.id}')" onclick="event.stopPropagation(); app.Planning.editShootDay('${shootDay.id}')" oncontextmenu="event.preventDefault(); event.stopPropagation(); app.Planning.showDayContextMenu(event, '${shootDay.id}')" title="${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label)}"><span class="month-resize-handle left" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'left')"></span>${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label).substring(0, 10)}<span class="month-resize-handle right" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'right')"></span></div>`; })() : ''}
            </div>`;
        }
        
        // Current month days
        for(let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = Planning.formatDate(new Date(year, month, day));
            const isToday = dateStr === today;
            const shootDay = Planning.getShootDay(dateStr);
            const hasShoot = shootDay !== null;
            
            // R√©cup√©rer les disponibilit√©s
            const availBars = Planning.getAvailabilityBarsForDate(dateStr);
            let availHTML = '';
            if(availBars.length > 0) {
                availHTML = '<div class="planning-day-availability">';
                availBars.forEach(bar => {
                    let vehicleIcon = '';
                    if(bar.hasVehicle) {
                        let vehicleInfo = bar.vehicleSeats ? bar.vehicleSeats + ' place(s)' : '';
                        if(bar.vehicleTrunk) vehicleInfo += vehicleInfo ? ' + coffre dispo' : 'Coffre dispo';
                        vehicleIcon = `<span style="margin-left: auto; cursor: help;" title="${vehicleInfo || 'V√©hicule disponible'}">üöó</span>`;
                    }
                    availHTML += `<div class="availability-bar" style="background: ${bar.color};">${bar.name}${vehicleIcon}</div>`;
                });
                availHTML += '</div>';
            }
            
            let classes = 'planning-day';
            if(isToday) classes += ' today';
            if(hasShoot) classes += ' has-shoot';
            
            html += `<div class="${classes}" data-date="${dateStr}" onclick="app.Planning.openDay('${dateStr}')" ondragover="app.Planning.onDragOver(event)" ondrop="app.Planning.onDrop(event, '${dateStr}')">
                <div class="planning-day-number">${day}</div>
                ${availHTML}
                ${shootDay ? (() => { const typeInfo = Planning.getDayTypeInfo(shootDay.dayType); return `<div class="planning-day-shoot" style="background: ${typeInfo.color};" draggable="true" ondragstart="app.Planning.onDragStart(event, '${shootDay.id}')" onclick="event.stopPropagation(); app.Planning.editShootDay('${shootDay.id}')" oncontextmenu="event.preventDefault(); event.stopPropagation(); app.Planning.showDayContextMenu(event, '${shootDay.id}')" title="${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label)}"><span class="month-resize-handle left" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'left')"></span>${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label).substring(0, 10)}<span class="month-resize-handle right" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'right')"></span></div>`; })() : ''}
            </div>`;
        }
        
        // Next month days
        const totalCells = startDay + lastDay.getDate();
        const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for(let day = 1; day <= remaining; day++) {
            const dateStr = Planning.formatDate(new Date(year, month + 1, day));
            const shootDay = Planning.getShootDay(dateStr);
            html += `<div class="planning-day other-month" data-date="${dateStr}" onclick="app.Planning.openDay('${dateStr}')" ondragover="app.Planning.onDragOver(event)" ondrop="app.Planning.onDrop(event, '${dateStr}')">
                <div class="planning-day-number">${day}</div>
                ${shootDay ? (() => { const typeInfo = Planning.getDayTypeInfo(shootDay.dayType); return `<div class="planning-day-shoot" style="background: ${typeInfo.color};" draggable="true" ondragstart="app.Planning.onDragStart(event, '${shootDay.id}')" onclick="event.stopPropagation(); app.Planning.editShootDay('${shootDay.id}')" oncontextmenu="event.preventDefault(); event.stopPropagation(); app.Planning.showDayContextMenu(event, '${shootDay.id}')" title="${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label)}"><span class="month-resize-handle left" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'left')"></span>${typeInfo.icon} ${Utils.escape(shootDay.name || typeInfo.label).substring(0, 10)}<span class="month-resize-handle right" onmousedown="event.stopPropagation(); app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'right')"></span></div>`; })() : ''}
            </div>`;
        }
        
        html += '</div></div>';
        return html;
    },
    
    renderWeekView: () => {
        const weekStart = Planning.getWeekStart(Planning.currentDate);
        const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        const today = Planning.formatDate(new Date());
        
        // Collecter les jours de tournage de la semaine
        const weekShootDays = [];
        
        // Cr√©er un tableau des 7 dates de la semaine (format YYYY-MM-DD)
        const weekDates = [];
        for(let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + i);
            weekDates.push(Planning.formatDate(d));
        }
        
        // Parcourir tous les jours de tournage et voir lesquels sont dans cette semaine
        (state.data.shootingDays || []).forEach(shootDay => {
            const startDate = shootDay.startDate || shootDay.date;
            const endDate = shootDay.endDate || shootDay.startDate || shootDay.date;
            if(!startDate) return;
            
            const weekStartStr = weekDates[0];
            const weekEndStr = weekDates[6];
            
            // V√©rifier si le tournage chevauche cette semaine
            // Le tournage chevauche si : startDate <= weekEnd ET endDate >= weekStart
            if(startDate > weekEndStr || endDate < weekStartStr) {
                // Pas de chevauchement, ignorer
                return;
            }
            
            // Calculer les indices de d√©but et fin dans la semaine
            let startDayIndex = weekDates.indexOf(startDate);
            let endDayIndex = weekDates.indexOf(endDate);
            
            // Si le d√©but est avant cette semaine, commencer au jour 0
            if(startDayIndex < 0 && startDate < weekStartStr) {
                startDayIndex = 0;
            }
            // Si la fin est apr√®s cette semaine, finir au jour 6
            if(endDayIndex < 0 && endDate > weekEndStr) {
                endDayIndex = 6;
            }
            
            // Si toujours -1, c'est que la date n'est pas dans la semaine (ne devrait pas arriver apr√®s le check ci-dessus)
            if(startDayIndex < 0 || endDayIndex < 0) return;
            
            const spanDays = endDayIndex - startDayIndex + 1;
            const startHour = shootDay.crewCall ? parseInt(shootDay.crewCall.split(':')[0]) : 7;
            const endHour = shootDay.estimatedWrap ? parseInt(shootDay.estimatedWrap.split(':')[0]) : 19;
            
            weekShootDays.push({ 
                ...shootDay, 
                dayIndex: startDayIndex, 
                spanDays: spanDays,
                startHour, 
                endHour, 
                dateStr: startDate 
            });
        });
        
        let html = '<div class="planning-week-view">';
        
        // Header
        html += '<div class="planning-week-header">';
        html += '<div class="planning-week-header-cell"></div>';
        for(let i = 0; i < 7; i++) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + i);
            const dateStr = Planning.formatDate(d);
            const isToday = dateStr === today;
            html += `<div class="planning-week-header-cell" style="${isToday ? 'background: var(--primary); color: white;' : ''}">${days[i]} ${d.getDate()}</div>`;
        }
        html += '</div>';
        
        // Body - Time slots avec position relative pour les √©v√©nements
        html += '<div class="planning-week-body" style="position: relative;">';
        
        // Grille des heures
        for(let hour = 6; hour <= 22; hour++) {
            html += '<div class="planning-week-row">';
            html += `<div class="planning-week-time">${String(hour).padStart(2, '0')}:00</div>`;
            
            for(let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                const dateStr = Planning.formatDate(d);
                
                html += `<div class="planning-week-cell" data-hour="${hour}" data-day="${i}" data-date="${dateStr}" onclick="app.Planning.openDay('${dateStr}')" ondragover="app.Planning.onDragOverWeek(event, ${hour})" ondragleave="app.Planning.onDragLeave(event)" ondrop="app.Planning.onDropWeek(event, '${dateStr}', ${hour})"></div>`;
            }
            html += '</div>';
        }
        
        // Overlay des √©v√©nements (positionn√©s absolument dans le body)
        html += '<div class="planning-week-events-overlay">';
        weekShootDays.forEach(shootDay => {
            const totalHours = 17; // de 6h √† 22h + 1
            const topPercent = ((shootDay.startHour - 6) / totalHours) * 100;
            const heightPercent = Math.max(((shootDay.endHour - shootDay.startHour) / totalHours) * 100, 5);
            
            const spanDays = shootDay.spanDays || 1;
            const widthCalc = `calc((100% / 7) * ${spanDays} - 6px)`;
            
            // Pour les jours multi-jours, le bloc prend toute la hauteur
            let blockTop, blockHeight;
            if(spanDays > 1) {
                // Multi-jours : de l'heure de d√©but du premier jour jusqu'√† la fin de journ√©e, puis journ√©es compl√®tes
                blockTop = ((shootDay.startHour - 6) / 17) * 100;
                blockHeight = 100 - blockTop; // Jusqu'en bas
            } else {
                blockTop = topPercent;
                blockHeight = heightPercent;
            }
            
            // Nom du tournage (bas√© sur les sc√®nes ou le nom personnalis√©)
            const displayName = shootDay.name || `Tournage`;
            
            html += `<div class="planning-week-event-block ${spanDays > 1 ? 'multi-day' : ''}" 
                style="top: ${blockTop}%; height: ${blockHeight}%; left: calc((100% / 7) * ${shootDay.dayIndex} + 3px); width: ${widthCalc};"
                draggable="true" 
                ondragstart="app.Planning.onDragStart(event, '${shootDay.id}')"
                onclick="event.stopPropagation(); app.Planning.editShootDay('${shootDay.id}')" 
                oncontextmenu="event.preventDefault(); event.stopPropagation(); app.Planning.showDayContextMenu(event, '${shootDay.id}')"
                title="${Utils.escape(displayName)} | ${shootDay.crewCall || '07:00'} - ${shootDay.estimatedWrap || '19:00'} | ${(shootDay.scenes || []).length} sc√®ne(s)">
                <div class="event-block-content">
                    <strong>${Utils.escape(displayName)}</strong>
                    <span>${shootDay.crewCall || '07:00'} - ${shootDay.estimatedWrap || '19:00'}</span>
                    <span>${(shootDay.scenes || []).length} sc√®ne(s)${spanDays > 1 ? ' ‚Ä¢ ' + spanDays + 'j' : ''}</span>
                </div>
                <div class="event-resize-handle-top" onmousedown="app.Planning.startResize(event, '${shootDay.id}', 'top')"></div>
                <div class="event-resize-handle-bottom" onmousedown="app.Planning.startResize(event, '${shootDay.id}', 'bottom')"></div>
                <div class="event-resize-handle-right" onmousedown="app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'right')"></div>
                <div class="event-resize-handle-left" onmousedown="app.Planning.startResizeHorizontal(event, '${shootDay.id}', 'left')"></div>
            </div>`;
        });
        html += '</div>'; // Ferme overlay
        
        html += '</div>'; // Ferme week-body
        
        html += '</div>'; // Ferme week-view
        return html;
    },
    
    renderDayView: () => {
        const dateStr = Planning.formatDate(Planning.currentDate);
        const shootDay = Planning.getShootDay(dateStr);
        const availBars = Planning.getAvailabilityBarsForDate(dateStr);
        
        let html = '<div class="planning-day-view">';
        
        // En-t√™te du jour
        html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid var(--border);">
            <div>
                <div style="font-size:1.5rem; font-weight:bold;">üìÖ ${new Date(dateStr).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
            </div>
            <div style="display:flex; gap:10px;">
                ${shootDay ? `<button onclick="app.Planning.editShootDay('${shootDay.id}')" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">‚úèÔ∏è Modifier : ${Utils.escape(shootDay.name || 'Tournage')}</button>` : `<button onclick="app.Planning.addShootDay('${dateStr}')" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">‚ûï Planifier un tournage</button>`}
            </div>
        </div>`;
        
        // Section Jour de Tournage
        if(shootDay) {
            html += `<div style="background:rgba(40,167,69,0.1); border:2px solid var(--success); border-radius:8px; padding:15px; margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <span style="font-size:1.5rem;">üé¨</span>
                    <span style="font-weight:bold; font-size:1.1rem;">${Utils.escape(shootDay.name || 'Tournage')}</span>
                </div>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px; font-size:0.9rem;">
                    <div>üìç <strong>Lieu:</strong> ${shootDay.location || 'Non d√©fini'}</div>
                    <div>‚è∞ <strong>Convocation:</strong> ${shootDay.crewCall || '--:--'}</div>
                    <div>üé¨ <strong>Pr√™t √† tourner:</strong> ${shootDay.readyToShoot || '--:--'}</div>
                    <div>üèÅ <strong>Fin estim√©e:</strong> ${shootDay.estimatedWrap || '--:--'}</div>
                </div>
                <div style="margin-top:10px; font-size:0.9rem;">
                    <strong>Sc√®nes:</strong> ${shootDay.scenes?.length || 0} ‚Ä¢ 
                    <strong>Convoqu√©s:</strong> ${shootDay.callSheet?.length || 0}
                </div>
            </div>`;
        } else {
            html += `<div style="background:var(--bg); border:1px dashed var(--border); border-radius:8px; padding:20px; margin-bottom:20px; text-align:center; color:var(--text-sec);">
                <span style="font-size:1.5rem;">üì≠</span>
                <p style="margin:10px 0 0;">Aucun tournage planifi√© ce jour</p>
            </div>`;
        }
        
        // Section Disponibilit√©s Com√©diens
        html += `<div style="margin-bottom:20px;">
            <h3 style="margin:0 0 10px; font-size:1rem; color:var(--primary);">üé≠ Disponibilit√©s Com√©dien.nes</h3>`;
        
        const actorBars = availBars.filter(b => b.type === 'actor');
        if(actorBars.length > 0) {
            html += '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
            actorBars.forEach(bar => {
                const bgColor = bar.color || '#4CAF50';
                html += `<div style="background:${bgColor}; color:#fff; padding:6px 12px; border-radius:20px; font-size:0.85rem; display:flex; align-items:center; gap:5px;">
                    ${bar.name}
                    ${bar.hasVehicle ? '<span title="V√©hicule disponible">üöó</span>' : ''}
                </div>`;
            });
            html += '</div>';
        } else {
            html += '<div style="color:var(--text-sec); font-size:0.9rem; padding:10px; background:var(--bg); border-radius:6px;">Aucune disponibilit√© affich√©e. S√©lectionnez des com√©dien.nes dans le panneau ci-dessus.</div>';
        }
        html += '</div>';
        
        // Section Disponibilit√©s Techniciens
        html += `<div style="margin-bottom:20px;">
            <h3 style="margin:0 0 10px; font-size:1rem; color:var(--primary);">üé¨ Disponibilit√©s √âquipe Technique</h3>`;
        
        const crewBars = availBars.filter(b => b.type === 'crew');
        if(crewBars.length > 0) {
            html += '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
            crewBars.forEach(bar => {
                const bgColor = bar.color || '#2196F3';
                html += `<div style="background:${bgColor}; color:#fff; padding:6px 12px; border-radius:20px; font-size:0.85rem; display:flex; align-items:center; gap:5px;">
                    ${bar.name}
                    ${bar.hasVehicle ? '<span title="V√©hicule disponible">üöó</span>' : ''}
                </div>`;
            });
            html += '</div>';
        } else {
            html += '<div style="color:var(--text-sec); font-size:0.9rem; padding:10px; background:var(--bg); border-radius:6px;">Aucune disponibilit√© affich√©e. S√©lectionnez des technicien.nes dans le panneau ci-dessus.</div>';
        }
        html += '</div>';
        
        // R√©sum√© des v√©hicules disponibles
        const vehicleBars = availBars.filter(b => b.hasVehicle);
        if(vehicleBars.length > 0) {
            html += `<div style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:15px;">
                <h3 style="margin:0 0 10px; font-size:1rem; color:var(--primary);">üöó V√©hicules Disponibles</h3>
                <div style="display:flex; flex-wrap:wrap; gap:10px;">`;
            vehicleBars.forEach(bar => {
                let vehicleInfo = bar.vehicleSeats ? `${bar.vehicleSeats} places` : '';
                if(bar.vehicleTrunk) vehicleInfo += vehicleInfo ? ' + coffre' : 'Coffre dispo';
                html += `<div style="background:var(--panel-bg); border:1px solid var(--border); padding:8px 12px; border-radius:6px; font-size:0.85rem;">
                    <strong>${bar.name}</strong> ${vehicleInfo ? `<span style="color:var(--text-sec);">‚Ä¢ ${vehicleInfo}</span>` : ''}
                </div>`;
            });
            html += '</div></div>';
        }
        
        html += '</div>';
        return html;
    },
    
    renderShootDayCard: (shootDay) => {
        let html = `<div class="shoot-day-card">`;
        const startDateObj = new Date(shootDay.startDate || shootDay.date);
        const endDateObj = new Date(shootDay.endDate || shootDay.startDate || shootDay.date);
        const dateDisplay = shootDay.startDate === shootDay.endDate || !shootDay.endDate
            ? startDateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })
            : startDateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) + ' ‚Üí ' + endDateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
        
        html += `<h3>${Utils.escape(shootDay.name || 'Tournage')} - ${dateDisplay}
            <button onclick="app.Planning.editShootDay('${shootDay.id}')" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">‚úèÔ∏è Modifier</button>
        </h3>`;
        
        // Weather
        html += `<div class="weather-widget" id="weather-${shootDay.id}">
            <div class="weather-icon">üå§Ô∏è</div>
            <div class="weather-info">
                <div class="weather-temp">--¬∞C</div>
                <div class="weather-desc">Chargement m√©t√©o...</div>
            </div>
        </div>`;
        
        // Location
        if(shootDay.location) {
            html += `<div class="shoot-section" style="margin-top: 15px;">
                <div class="shoot-section-title">üìç Lieu de tournage</div>
                <div style="padding: 10px; background: var(--panel-bg); border-radius: 6px;">
                    <strong>${Utils.escape(shootDay.location)}</strong><br>
                    ${shootDay.locationAddress ? Utils.escape(shootDay.locationAddress) : ''}
                </div>
            </div>`;
        }
        
        // Horaires
        html += `<div class="shoot-section">
            <div class="shoot-section-title">‚è∞ Horaires</div>
            <div class="shoot-time-grid">
                <div><strong>Convocation √©quipe:</strong> ${shootDay.crewCall || '--:--'}</div>
                <div><strong>Pr√™t √† tourner:</strong> ${shootDay.readyToShoot || '--:--'}</div>
                <div><strong>Pause d√©jeuner:</strong> ${shootDay.lunchStart || '--:--'} - ${shootDay.lunchEnd || '--:--'}</div>
                <div><strong>Fin estim√©e:</strong> ${shootDay.estimatedWrap || '--:--'}</div>
            </div>
        </div>`;
        
        // Sc√®nes
        if(shootDay.scenes && shootDay.scenes.length > 0) {
            html += `<div class="shoot-section">
                <div class="shoot-section-title">üé¨ Sc√®nes du jour (${shootDay.scenes.length})</div>
                <div class="shoot-scene-list">`;
            
            shootDay.scenes.forEach(sceneRef => {
                const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId);
                if(scene) {
                    html += `<div class="shoot-scene-item">
                        <input type="time" class="shoot-scene-time" value="${sceneRef.startTime || ''}" disabled>
                        <div class="shoot-scene-info">
                            <div class="shoot-scene-title">${Utils.escape(scene.title)}</div>
                            <div class="shoot-scene-meta">${Utils.escape(scene.perso || 'Pas de personnages d√©finis')}</div>
                        </div>
                    </div>`;
                }
            });
            
            html += `</div></div>`;
        }
        
        // Convocations
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            html += `<div class="shoot-section">
                <div class="shoot-section-title">üìã Convocations (${shootDay.callSheet.length})</div>
                <table class="callsheet-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Fonction</th>
                            <th>Convocation</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            // S√©parer com√©diens et techniciens
            const actorCalls = shootDay.callSheet.filter(c => c.type === 'actor');
            const crewCalls = shootDay.callSheet.filter(c => c.type === 'crew');
            
            // Afficher les com√©diens group√©s par cat√©gorie
            if(actorCalls.length > 0) {
                const actorGroups = state.data.groups.filter(g => g.type === 'actor');
                
                actorGroups.forEach(grp => {
                    const groupCalls = actorCalls.filter(call => {
                        const actor = state.data.actors.find(a => a.id === call.personId);
                        return actor && actor.group_id === grp.id;
                    });
                    
                    if(groupCalls.length > 0) {
                        html += `<tr style="background: var(--bg);"><td colspan="4" style="font-weight: bold; padding: 8px; color: var(--primary);">üé≠ ${grp.name}</td></tr>`;
                        groupCalls.forEach(call => {
                            const person = state.data.actors.find(a => a.id === call.personId);
                            if(person) {
                                const character = state.data.characters.find(c => c.actor_id === person.id);
                                const role = character ? character.name : 'Com√©dien(ne)';
                                html += `<tr>
                                    <td>${Utils.escape(person.name)}</td>
                                    <td>${Utils.escape(role)}</td>
                                    <td><strong>${call.callTime || '--:--'}</strong></td>
                                    <td>${Utils.escape(call.notes || '')}</td>
                                </tr>`;
                            }
                        });
                    }
                });
                
                // Com√©diens sans groupe
                const noGroupCalls = actorCalls.filter(call => {
                    const actor = state.data.actors.find(a => a.id === call.personId);
                    return actor && (!actor.group_id || !actorGroups.find(g => g.id === actor.group_id));
                });
                
                if(noGroupCalls.length > 0) {
                    html += `<tr style="background: var(--bg);"><td colspan="4" style="font-weight: bold; padding: 8px; color: var(--primary);">üé≠ Com√©diens</td></tr>`;
                    noGroupCalls.forEach(call => {
                        const person = state.data.actors.find(a => a.id === call.personId);
                        if(person) {
                            const character = state.data.characters.find(c => c.actor_id === person.id);
                            const role = character ? character.name : 'Com√©dien(ne)';
                            html += `<tr>
                                <td>${Utils.escape(person.name)}</td>
                                <td>${Utils.escape(role)}</td>
                                <td><strong>${call.callTime || '--:--'}</strong></td>
                                <td>${Utils.escape(call.notes || '')}</td>
                            </tr>`;
                        }
                    });
                }
            }
            
            // Afficher les techniciens group√©s par d√©partement
            if(crewCalls.length > 0) {
                const crewGroups = state.data.groups.filter(g => g.type === 'crew');
                
                crewGroups.forEach(grp => {
                    const groupCalls = crewCalls.filter(call => {
                        const member = state.data.crew.find(c => c.id === call.personId);
                        return member && member.group_id === grp.id;
                    });
                    
                    if(groupCalls.length > 0) {
                        html += `<tr style="background: var(--bg);"><td colspan="4" style="font-weight: bold; padding: 8px; color: var(--primary);">${grp.name}</td></tr>`;
                        groupCalls.forEach(call => {
                            const person = state.data.crew.find(c => c.id === call.personId);
                            if(person) {
                                html += `<tr>
                                    <td>${Utils.escape(person.name)}</td>
                                    <td>${Utils.escape(person.role || 'Technicien')}</td>
                                    <td><strong>${call.callTime || '--:--'}</strong></td>
                                    <td>${Utils.escape(call.notes || '')}</td>
                                </tr>`;
                            }
                        });
                    }
                });
                
                // Techniciens sans groupe
                const noGroupCalls = crewCalls.filter(call => {
                    const member = state.data.crew.find(c => c.id === call.personId);
                    return member && (!member.group_id || !crewGroups.find(g => g.id === member.group_id));
                });
                
                if(noGroupCalls.length > 0) {
                    html += `<tr style="background: var(--bg);"><td colspan="4" style="font-weight: bold; padding: 8px; color: var(--text-sec);">Autres techniciens</td></tr>`;
                    noGroupCalls.forEach(call => {
                        const person = state.data.crew.find(c => c.id === call.personId);
                        if(person) {
                            html += `<tr>
                                <td>${Utils.escape(person.name)}</td>
                                <td>${Utils.escape(person.role || 'Technicien')}</td>
                                <td><strong>${call.callTime || '--:--'}</strong></td>
                                <td>${Utils.escape(call.notes || '')}</td>
                            </tr>`;
                        }
                    });
                }
            }
            
            html += `</tbody></table></div>`;
        }
        
        // Notes
        if(shootDay.notes) {
            html += `<div class="shoot-section">
                <div class="shoot-section-title">üìù Notes</div>
                <div style="padding: 10px; background: var(--panel-bg); border-radius: 6px; white-space: pre-wrap;">${Utils.escape(shootDay.notes)}</div>
            </div>`;
        }
        
        // Bouton Email
        html += `<div class="shoot-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
            <button onclick="app.Planning.sendCallSheetEmail('${shootDay.id}')" style="padding: 12px 24px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                üìß Envoyer la feuille de service par email
            </button>
        </div>`;
        
        html += `</div>`;
        
        // Load weather
        setTimeout(() => Planning.loadWeather(shootDay), 100);
        
        return html;
    },
    
    openDay: (dateStr) => {
        const shootDay = Planning.getShootDay(dateStr);
        if(shootDay) {
            Planning.editShootDay(shootDay.id);
        } else {
            Planning.addShootDay(dateStr);
        }
    },
    
    addShootDay: (dateStr) => {
        if(state.currentRole === 'viewer') return;
        
        const date = dateStr || Planning.formatDate(Planning.currentDate);
        
        // Calculate day number
        const existingDays = state.data.shootingDays || [];
        const dayNumber = existingDays.length + 1;
        
        const newDay = {
            id: Utils.generateUniqueId(),
            date: date,
            dayNumber: dayNumber,
            dayType: 'tournage', // tournage, repetition, reperage, essai_costume, formation, reunion
            location: '',
            locationAddress: '',
            crewCall: '07:00',
            readyToShoot: '08:30',
            lunchStart: '13:00',
            lunchEnd: '14:00',
            estimatedWrap: '19:00',
            scenes: [],
            callSheet: [],
            notes: '',
            weather: null,
            customWeather: ''
        };
        
        Planning.editingDayId = 'new';
        Planning.showEditModal(newDay);
    },
    
    editShootDay: (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        // S'assurer que scenes et callSheet sont des tableaux
        if(!shootDay.scenes) shootDay.scenes = [];
        if(!shootDay.callSheet) shootDay.callSheet = [];
        
        Planning.editingDayId = dayId;
        Planning.showEditModal(shootDay);
    },
    
    showEditModal: (shootDay) => {
        // Store temp copy for editing
        Planning.tempShootDay = JSON.parse(JSON.stringify(shootDay));
        
        const modal = document.getElementById('planning-modal');
        const title = document.getElementById('planningModalTitle');
        const body = document.getElementById('planningModalBody');
        
        title.innerText = Planning.editingDayId === 'new' ? 'Nouveau Tournage' : `Modifier : ${shootDay.name || 'Tournage'}`;
        
        // Get all scenes
        const allScenes = state.data.scenes;
        
        // Build dropdown options
        let sceneOptions = '<option value="">-- S√©lectionner une sc√®ne --</option>';
        allScenes.forEach((scene, idx) => {
            const alreadyInThisDay = (shootDay.scenes || []).some(ref => ref.sceneId === scene.id);
            if(!alreadyInThisDay) {
                const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
const shotLabel = shotCount > 0 ? ` üì∑${shotCount}` : '';
sceneOptions += `<option value="${scene.id}">#${idx + 1} - ${Utils.escape(scene.title)}${shotLabel}</option>`;
            }
        });
        
        // Build selected scenes list
        let selectedScenesHTML = '';
        (shootDay.scenes || []).forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId);
            if(scene) {
                const sceneIdx = state.data.scenes.indexOf(scene) + 1;
                const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
const shotBadge = shotCount > 0 ? `<span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">üì∑ ${shotCount} plan${shotCount > 1 ? 's' : ''}</span>` : '<span style="background: var(--border); color: var(--text-sec); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">üì∑ 0</span>';
// R√©cup√©rer les plans de cette sc√®ne
                const sceneShots = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id) : [];
                const selectedShots = sceneRef.selectedShots || [];
                
                let shotsHTML = '';
                if(sceneShots.length > 0) {
                    shotsHTML = `<div class="scene-shots-list" style="margin-top: 8px; padding: 8px; background: var(--panel-bg); border-radius: 4px;">
                        <div style="font-size: 0.8rem; color: var(--text-sec); margin-bottom: 5px;">üì∑ Plans √† tourner :</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${sceneShots.map(shot => {
                                const isSelected = selectedShots.includes(shot.id);
                                return `<label style="display: flex; align-items: center; gap: 3px; padding: 3px 8px; background: ${isSelected ? 'var(--primary)' : 'var(--bg)'}; color: ${isSelected ? 'white' : 'var(--text-main)'}; border-radius: 4px; cursor: pointer; font-size: 0.8rem; border: 1px solid var(--border);">
                                    <input type="checkbox" data-scene-id="${scene.id}" data-shot-id="${shot.id}" ${isSelected ? 'checked' : ''} onchange="app.Planning.toggleShotSelection('${scene.id}', '${shot.id}')" style="display: none;">
                                    ${Utils.escape(shot.shotNumber || shot.name || 'Plan ' + shot.id)}
                                </label>`;
                            }).join('')}
                        </div>
                        <div style="margin-top: 5px;">
                            <button onclick="app.Planning.selectAllShots('${scene.id}')" style="font-size: 0.75rem; padding: 2px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 3px; cursor: pointer; margin-right: 5px;">Tout</button>
                            <button onclick="app.Planning.deselectAllShots('${scene.id}')" style="font-size: 0.75rem; padding: 2px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 3px; cursor: pointer;">Aucun</button>
                        </div>
                    </div>`;
                }
                
                selectedScenesHTML += `<div class="selected-scene-item" style="margin-bottom: 10px; padding: 10px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="time" id="scene-time-${scene.id}" value="${sceneRef.startTime || ''}" style="width: 90px;">
                        <span style="flex: 1; font-weight: bold;">#${sceneIdx} - ${Utils.escape(scene.title)}${shotBadge}</span>
                        <span style="color: var(--text-sec); font-size: 0.85rem;">${Utils.escape(scene.perso || '')}</span>
                        <button onclick="app.Planning.removeSceneFromDay('${scene.id}')" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚úñ</button>
                    </div>
                    ${shotsHTML}
                </div>`;
            }
        });
        
        if(!shootDay.scenes || shootDay.scenes.length === 0) {
            selectedScenesHTML = '<div style="color: var(--text-sec); font-style: italic; padding: 15px; text-align: center;">Aucune sc√®ne s√©lectionn√©e</div>';
        }
        
        const scenesSelectionHTML = `
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <select id="scene-dropdown" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); font-size: 1rem;">
                    ${sceneOptions}
                </select>
                <button onclick="app.Planning.addSceneToDay()" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚ûï Ajouter</button>
            </div>
            <div id="selected-scenes-list">${selectedScenesHTML}</div>
        `;
        
        // Get all people for callsheet
        let callsheetRows = '';
        
        // Actors
        if(state.data.actors && state.data.actors.length > 0) {
            state.data.actors.forEach(actor => {
                const call = shootDay.callSheet.find(c => c.personId === actor.id && c.type === 'actor');
                callsheetRows += `<tr>
                    <td><input type="checkbox" id="call-actor-${actor.id}" data-type="actor" data-id="${actor.id}" ${call ? 'checked' : ''}></td>
                    <td>${Utils.escape(actor.name)}</td>
                    <td>Com√©dien(ne)</td>
                    <td><input type="time" id="call-time-actor-${actor.id}" value="${call ? call.callTime : ''}" style="width: 85px;"></td>
                    <td>
                        <select id="call-transport-actor-${actor.id}" onchange="app.Planning.onTransportChange('actor', '${actor.id}')" style="width: 100%; padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.85rem;">
                            <option value="" ${!call?.transport ? 'selected' : ''}>-- Transport --</option>
                            <option value="own" ${call?.transport === 'own' ? 'selected' : ''}>üöó Propres moyens</option>
                            <option value="own-brings" ${call?.transport === 'own-brings' ? 'selected' : ''}>üöóüë• Am√®ne...</option>
                            <option value="taxi" ${call?.transport === 'taxi' ? 'selected' : ''}>üöï Taxi</option>
                            <option value="public" ${call?.transport === 'public' ? 'selected' : ''}>üöá Transports</option>
                            <option value="with" ${call?.transport === 'with' ? 'selected' : ''}>üöó‚û°Ô∏è Part avec...</option>
                        </select>
                    </td>
                    <td>
                        <div id="call-withwho-actor-${actor.id}" class="withwho-dropdown" style="display: ${call?.transport === 'own-brings' || call?.transport === 'with' ? 'block' : 'none'};">
                            <button type="button" class="withwho-btn" onclick="app.Planning.toggleWithWhoDropdown('actor', '${actor.id}')">
                                <span class="withwho-label">-- Choisir --</span>
                            </button>
                            <div class="withwho-list" id="call-withwho-list-actor-${actor.id}"></div>
                        </div>
                    </td>
                    <td><input type="text" id="call-notes-actor-${actor.id}" value="${call?.notes || ''}" placeholder="Notes..." style="width: 100%;"></td>
                </tr>`;
            });
        }
        
        // Crew - Group√© par d√©partement
        if(state.data.crew && state.data.crew.length > 0) {
            const crewGroups = state.data.groups.filter(g => g.type === 'crew');
            
            // D'abord les techniciens group√©s par d√©partement
            crewGroups.forEach(grp => {
                const membersInGroup = state.data.crew.filter(m => m.group_id === grp.id);
                if(membersInGroup.length > 0) {
                    callsheetRows += `<tr style="background: var(--bg);"><td colspan="5" style="font-weight: bold; padding: 10px; color: var(--primary);">${grp.name}</td></tr>`;
                    membersInGroup.forEach(member => {
                        const call = shootDay.callSheet.find(c => c.personId === member.id && c.type === 'crew');
                        callsheetRows += `<tr>
                            <td><input type="checkbox" id="call-crew-${member.id}" data-type="crew" data-id="${member.id}" ${call ? 'checked' : ''}></td>
                            <td>${Utils.escape(member.name)}</td>
                            <td>${Utils.escape(member.role || 'Technicien')}</td>
                            <td><input type="time" id="call-time-crew-${member.id}" value="${call ? call.callTime : ''}" style="width: 85px;"></td>
                            <td>
                                <select id="call-transport-crew-${member.id}" onchange="app.Planning.onTransportChange('crew', '${member.id}')" style="width: 100%; padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.85rem;">
                                    <option value="" ${!call?.transport ? 'selected' : ''}>-- Transport --</option>
                                    <option value="own" ${call?.transport === 'own' ? 'selected' : ''}>üöó Propres moyens</option>
                                    <option value="own-brings" ${call?.transport === 'own-brings' ? 'selected' : ''}>üöóüë• Am√®ne...</option>
                                    <option value="taxi" ${call?.transport === 'taxi' ? 'selected' : ''}>üöï Taxi</option>
                                    <option value="public" ${call?.transport === 'public' ? 'selected' : ''}>üöá Transports</option>
                                    <option value="with" ${call?.transport === 'with' ? 'selected' : ''}>üöó‚û°Ô∏è Part avec...</option>
                                </select>
                            </td>
                            <td>
                                <div id="call-withwho-crew-${member.id}" class="withwho-dropdown" style="display: ${call?.transport === 'own-brings' || call?.transport === 'with' ? 'block' : 'none'};">
                                    <button type="button" class="withwho-btn" onclick="app.Planning.toggleWithWhoDropdown('crew', '${member.id}')">
                                        <span class="withwho-label">-- Choisir --</span>
                                    </button>
                                    <div class="withwho-list" id="call-withwho-list-crew-${member.id}"></div>
                                </div>
                            </td>
                            <td><input type="text" id="call-notes-crew-${member.id}" value="${call?.notes || ''}" placeholder="Notes..." style="width: 100%;"></td>
                        </tr>`;
                    });
                }
            });
            
            // Techniciens sans d√©partement
            const noGroupCrew = state.data.crew.filter(m => !m.group_id || !crewGroups.find(g => g.id === m.group_id));
            if(noGroupCrew.length > 0) {
                callsheetRows += `<tr style="background: var(--bg);"><td colspan="5" style="font-weight: bold; padding: 10px; color: var(--text-sec);">Non class√©</td></tr>`;
                noGroupCrew.forEach(member => {
                    const call = shootDay.callSheet.find(c => c.personId === member.id && c.type === 'crew');
                    callsheetRows += `<tr>
                        <td><input type="checkbox" id="call-crew-${member.id}" data-type="crew" data-id="${member.id}" ${call ? 'checked' : ''}></td>
                        <td>${Utils.escape(member.name)}</td>
                        <td>${Utils.escape(member.role || 'Technicien')}</td>
                        <td><input type="time" id="call-time-crew-${member.id}" value="${call ? call.callTime : ''}" style="width: 85px;"></td>
                        <td>
                            <select id="call-transport-crew-${member.id}" onchange="app.Planning.onTransportChange('crew', '${member.id}')" style="width: 100%; padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); font-size: 0.85rem;">
                                <option value="" ${!call?.transport ? 'selected' : ''}>-- Transport --</option>
                                <option value="own" ${call?.transport === 'own' ? 'selected' : ''}>üöó Propres moyens</option>
                                <option value="own-brings" ${call?.transport === 'own-brings' ? 'selected' : ''}>üöóüë• Am√®ne...</option>
                                <option value="taxi" ${call?.transport === 'taxi' ? 'selected' : ''}>üöï Taxi</option>
                                <option value="public" ${call?.transport === 'public' ? 'selected' : ''}>üöá Transports</option>
                                <option value="with" ${call?.transport === 'with' ? 'selected' : ''}>üöó‚û°Ô∏è Part avec...</option>
                            </select>
                        </td>
                        <td>
                            <div id="call-withwho-crew-${member.id}" class="withwho-dropdown" style="display: ${call?.transport === 'own-brings' || call?.transport === 'with' ? 'block' : 'none'};">
                                <button type="button" class="withwho-btn" onclick="app.Planning.toggleWithWhoDropdown('crew', '${member.id}')">
                                    <span class="withwho-label">-- Choisir --</span>
                                </button>
                                <div class="withwho-list" id="call-withwho-list-crew-${member.id}"></div>
                            </div>
                        </td>
                        <td><input type="text" id="call-notes-crew-${member.id}" value="${call?.notes || ''}" placeholder="Notes..." style="width: 100%;"></td>
                    </tr>`;
                });
            }
        }
        
        body.innerHTML = `
            <div class="shoot-section">
                <div class="shoot-section-title">üìÖ Type, Dates et Nom</div>
                <div class="shoot-time-grid">
                    <div class="shoot-time-item">
                        <label>Type de journ√©e</label>
                        <select id="edit-dayType" style="padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);">
                            <option value="tournage" ${(shootDay.dayType || 'tournage') === 'tournage' ? 'selected' : ''}>üé¨ Tournage</option>
                            <option value="repetition" ${shootDay.dayType === 'repetition' ? 'selected' : ''}>üé≠ R√©p√©tition</option>
                            <option value="reperage" ${shootDay.dayType === 'reperage' ? 'selected' : ''}>üîç Rep√©rage</option>
                            <option value="essai-costume" ${shootDay.dayType === 'essai-costume' ? 'selected' : ''}>üëó Essai costume</option>
                            <option value="essai-maquillage" ${shootDay.dayType === 'essai-maquillage' ? 'selected' : ''}>üíÑ Essai maquillage</option>
                            <option value="formation" ${shootDay.dayType === 'formation' ? 'selected' : ''}>üìö Formation</option>
                            <option value="reunion" ${shootDay.dayType === 'reunion' ? 'selected' : ''}>üìã R√©union</option>
                            <option value="autre" ${shootDay.dayType === 'autre' ? 'selected' : ''}>üìå Autre</option>
                        </select>
                    </div>
                    <div class="shoot-time-item">
                        <label>Nom</label>
                        <input type="text" id="edit-name" value="${shootDay.name || ''}" placeholder="Ex: Sc.5 - Bureau (sera auto-g√©n√©r√© si vide)">
                    </div>
                </div>
                <div class="shoot-time-grid" style="margin-top: 10px;">
                    <div class="shoot-time-item">
                        <label>Date de d√©but</label>
                        <input type="date" id="edit-startDate" value="${shootDay.startDate || shootDay.date || ''}">
                    </div>
                    <div class="shoot-time-item">
                        <label>Date de fin</label>
                        <input type="date" id="edit-endDate" value="${shootDay.endDate || shootDay.startDate || shootDay.date || ''}">
                    </div>
                </div>
            </div>
            
            <div class="shoot-section" style="background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05), rgba(var(--primary-rgb), 0.1)); border: 2px solid var(--primary); border-radius: 8px; padding: 15px;">
                <div class="shoot-section-title">üé¨ Sc√®nes √† tourner (s√©lectionnez d'abord pour auto-remplir)</div>
                <div id="scenes-selection">${scenesSelectionHTML}</div>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">üìç LIEU</div>
                <div class="shoot-time-grid">
                    <div class="shoot-time-item">
                        <label>D√©cor (sc√©nario)</label>
                        <select id="edit-location-select" onchange="app.Planning.onLocationSelect(this.value)" style="padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);">
                            <option value="">-- S√©lectionner un d√©cor --</option>
                            ${state.data.locations.map(loc => `<option value="${Utils.escape(loc.name)}" ${shootDay.location === loc.name ? 'selected' : ''}>${Utils.escape(loc.name)}</option>`).join('')}
                            <option value="__custom__">‚ûï Autre...</option>
                        </select>
                    </div>
                    <div class="shoot-time-item">
                        <label>Lieu r√©el de tournage</label>
                        <input type="text" id="edit-location" value="${shootDay.locationRealName || ''}" placeholder="Ex: Mus√©e d'Histoire Naturelle">
                    </div>
                    <div class="shoot-time-item" style="flex: 2;">
                        <label>Adresse</label>
                        <div class="address-autocomplete-container">
                            <input type="text" id="edit-locationAddress" value="${shootDay.locationAddress || ''}" placeholder="Tapez une adresse..." oninput="app.Planning.searchAddress(this.value)" autocomplete="off">
                            <div id="address-suggestions" class="address-suggestions"></div>
                        </div>
                        <input type="hidden" id="edit-locationLat" value="${shootDay.locationLat || ''}">
                        <input type="hidden" id="edit-locationLng" value="${shootDay.locationLng || ''}">
                        <div id="location-minimap" class="address-minimap" style="display: ${shootDay.locationLat ? 'block' : 'none'};"></div>
                    </div>
                </div>
                <div class="shoot-time-grid" style="margin-top: 15px;">
                    <div class="shoot-time-item">
                        <label>üë§ Contact sur place (nom)</label>
                        <input type="text" id="edit-contactName" value="${shootDay.contactName || ''}" placeholder="Ex: Jean Dupont">
                    </div>
                    <div class="shoot-time-item">
                        <label>üìû T√©l√©phone contact</label>
                        <input type="tel" id="edit-contactPhone" value="${shootDay.contactPhone || ''}" placeholder="Ex: 06 12 34 56 78">
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">üìù Notes d'acc√®s / Infos pratiques</label>
                    <textarea id="edit-locationNotes" placeholder="Ex: Code porte 1234, parking gratuit derri√®re le b√¢timent, sonner √† l'interphone..." style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);">${shootDay.locationNotes || ''}</textarea>
                </div>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">‚è∞ Horaires</div>
                <div class="shoot-time-grid">
                    <div class="shoot-time-item">
                        <label>Convocation √©quipe</label>
                        <input type="time" id="edit-crewCall" value="${shootDay.crewCall || '07:00'}">
                    </div>
                    <div class="shoot-time-item">
                        <label>Pr√™t √† tourner</label>
                        <input type="time" id="edit-readyToShoot" value="${shootDay.readyToShoot || '08:30'}">
                    </div>
                    <div class="shoot-time-item">
                        <label>D√©but pause d√©jeuner</label>
                        <input type="time" id="edit-lunchStart" value="${shootDay.lunchStart || '13:00'}">
                    </div>
                    <div class="shoot-time-item">
                        <label>Fin pause d√©jeuner</label>
                        <input type="time" id="edit-lunchEnd" value="${shootDay.lunchEnd || '14:00'}">
                    </div>
                    <div class="shoot-time-item">
                        <label>Fin estim√©e</label>
                        <input type="time" id="edit-estimatedWrap" value="${shootDay.estimatedWrap || '19:00'}">
                    </div>
                </div>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">üìã Convocations</div>
                <table class="callsheet-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">‚úì</th>
                            <th>Nom</th>
                            <th>Fonction</th>
                            <th style="width: 90px;">Heure</th>
                            <th style="width: 160px;">Transport</th>
                            <th style="width: 150px;">Avec qui</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>${callsheetRows || '<tr><td colspan="5" style="text-align: center; color: var(--text-sec);">Aucun com√©dien ou technicien enregistr√©</td></tr>'}</tbody>
                </table>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">üå§Ô∏è M√©t√©o personnalis√©e (optionnel)</div>
                <textarea id="edit-customWeather" placeholder="Ex: Pr√©voir parapluies, tournage ext√©rieur annul√© si pluie..." style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);">${shootDay.customWeather || ''}</textarea>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">üìù Notes g√©n√©rales</div>
                <textarea id="edit-notes" placeholder="Notes pour l'√©quipe..." style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);">${shootDay.notes || ''}</textarea>
            </div>
            
            <div class="shoot-section">
                <div class="shoot-section-title">üì¶ Besoins (D√©pouillement automatique)</div>
                <div id="auto-breakdown-needs" style="background: var(--bg); padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                    <em style="color: var(--text-sec);">S√©lectionnez des sc√®nes pour voir les besoins...</em>
                </div>
            </div>
            
            ${Planning.editingDayId !== 'new' ? `
            <div class="shoot-section" style="border-top: 2px solid var(--danger); padding-top: 15px; margin-top: 20px;">
                <button onclick="app.Planning.deleteShootDay('${shootDay.id}')" style="padding: 10px 20px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer;">üóëÔ∏è Supprimer ce jour de tournage</button>
            </div>
            ` : ''}
        `;
        
        modal.classList.add('active');
        
        // Auto-s√©lectionner les acteurs des sc√®nes d√©j√† pr√©sentes
        setTimeout(() => {
            Planning.autoSelectActorsForScenes();
            
            // Initialiser les dropdowns "Avec qui" pour le transport
            Planning.initWithWhoDropdowns();
            
            // Afficher la mini-carte si des coordonn√©es existent
            if(shootDay.locationLat && shootDay.locationLng) {
                Planning.showMiniMap(shootDay.locationLat, shootDay.locationLng);
            }
            
            // Mettre √† jour les besoins du d√©pouillement
            Planning.updateBreakdownNeeds();
            
            // Auto-cocher les techniciens selon le d√©pouillement
            Planning.autoSelectCrewForBreakdown();
        }, 100);
    },
    
closeModal: () => {
        document.getElementById('planning-modal').classList.remove('active');
        Planning.editingDayId = null;
        Planning.tempShootDay = null;
    },
    
    // G√®re le changement de transport pour afficher/masquer "Avec qui"
    onTransportChange: (type, personId) => {
        const transportSelect = document.getElementById(`call-transport-${type}-${personId}`);
        const withWhoDropdown = document.getElementById(`call-withwho-${type}-${personId}`);
        
        if(!transportSelect || !withWhoDropdown) return;
        
        const transport = transportSelect.value;
        
        if(transport === 'own-brings' || transport === 'with') {
            withWhoDropdown.style.display = 'block';
            Planning.populateWithWhoDropdown(type, personId, transport);
        } else {
            withWhoDropdown.style.display = 'none';
        }
    },
    
    // Ouvre/ferme le dropdown "Avec qui"
    toggleWithWhoDropdown: (type, personId) => {
        const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
        const btn = list?.previousElementSibling;
        
        // Fermer tous les autres dropdowns ouverts
        document.querySelectorAll('.withwho-list.open').forEach(el => {
            if(el.id !== `call-withwho-list-${type}-${personId}`) {
                el.classList.remove('open');
                el.previousElementSibling?.classList.remove('open');
            }
        });
        
        if(list) {
            list.classList.toggle('open');
            btn?.classList.toggle('open');
        }
    },
    
    // G√®re le clic sur une option du dropdown
    onWithWhoItemClick: (type, personId, value, checkbox) => {
        const transportSelect = document.getElementById(`call-transport-${type}-${personId}`);
        const transport = transportSelect?.value;
        
        // Si "Part avec" ‚Üí s√©lection unique (d√©cocher les autres)
        if(transport === 'with') {
            const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
            list?.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                if(cb !== checkbox) cb.checked = false;
            });
        }
        
        Planning.updateWithWhoLabel(type, personId);
        
        // Synchronisation bidirectionnelle du transport
        if(checkbox.checked) {
            Planning.syncTransport(type, personId, value, transport);
        } else {
            Planning.unsyncTransport(type, personId, value);
        }
    },
    
    // Met √† jour le label du bouton dropdown
    // Synchronise le transport : si A am√®ne B, B passe en "Part avec A"
    syncTransport: (driverType, driverId, passengerId, transport) => {
        // Extraire le type et l'ID du passager (format: "actor_act_xxx" ou "crew_crew_xxx")
        const firstUnderscore = passengerId.indexOf('_');
        if(firstUnderscore === -1) return;
        const passengerType = passengerId.substring(0, firstUnderscore);
        const passId = passengerId.substring(firstUnderscore + 1);
        if(!passengerType || !passId) return;
        
        // Si le conducteur "am√®ne" quelqu'un
        if(transport === 'own-brings') {
            // Cocher la checkbox du passager s'il ne l'est pas d√©j√†
            const passengerCheckbox = document.querySelector(`input[data-type="${passengerType}"][data-id="${passId}"]`);
            if(passengerCheckbox && !passengerCheckbox.checked) {
                passengerCheckbox.checked = true;
            }
            
            // Mettre le passager en "Part avec..."
            const passengerTransport = document.getElementById(`call-transport-${passengerType}-${passId}`);
            if(passengerTransport && passengerTransport.value !== 'with') {
                passengerTransport.value = 'with';
                Planning.onTransportChange(passengerType, passId);
            }
            
            // Cocher le conducteur dans la liste "avec qui" du passager
            setTimeout(() => {
                const passengerWithWhoList = document.getElementById(`call-withwho-list-${passengerType}-${passId}`);
                if(passengerWithWhoList) {
                    const driverCheckbox = passengerWithWhoList.querySelector(`input[value="${driverType}_${driverId}"]`);
                    if(driverCheckbox && !driverCheckbox.checked) {
                        driverCheckbox.checked = true;
                        Planning.updateWithWhoLabel(passengerType, passId);
                    }
                }
            }, 50);
        }
        
        // Si le passager "part avec" quelqu'un (synchronisation inverse)
        if(transport === 'with') {
            const driverTransport = document.getElementById(`call-transport-${passengerType}-${passId}`);
            // V√©rifier si le conducteur n'est pas d√©j√† en mode "am√®ne"
            if(driverTransport && driverTransport.value !== 'own-brings') {
                // Le mettre en "Am√®ne..."
                driverTransport.value = 'own-brings';
                Planning.onTransportChange(passengerType, passId);
            }
            
            // Cocher le passager actuel dans la liste du conducteur
            setTimeout(() => {
                const driverWithWhoList = document.getElementById(`call-withwho-list-${passengerType}-${passId}`);
                if(driverWithWhoList) {
                    const currentPersonCheckbox = driverWithWhoList.querySelector(`input[value="${driverType}_${driverId}"]`);
                    if(currentPersonCheckbox && !currentPersonCheckbox.checked) {
                        currentPersonCheckbox.checked = true;
                        Planning.updateWithWhoLabel(passengerType, passId);
                    }
                }
            }, 50);
        }
    },
    
    // D√©synchronise quand on d√©coche quelqu'un
    unsyncTransport: (type, personId, otherId) => {
        const firstUnderscore = otherId.indexOf('_');
        if(firstUnderscore === -1) return;
        const otherType = otherId.substring(0, firstUnderscore);
        const otherPersonId = otherId.substring(firstUnderscore + 1);
        if(!otherType || !otherPersonId) return;
        
        // D√©cocher la personne actuelle dans la liste de l'autre
        const otherWithWhoList = document.getElementById(`call-withwho-list-${otherType}-${otherPersonId}`);
        if(otherWithWhoList) {
            const checkbox = otherWithWhoList.querySelector(`input[value="${type}_${personId}"]`);
            if(checkbox && checkbox.checked) {
                checkbox.checked = false;
                Planning.updateWithWhoLabel(otherType, otherPersonId);
            }
        }
        
        // Si l'autre n'a plus personne dans sa liste, remettre son transport √† vide
        setTimeout(() => {
            const otherList = document.getElementById(`call-withwho-list-${otherType}-${otherPersonId}`);
            if(otherList) {
                const stillChecked = otherList.querySelectorAll('input[type="checkbox"]:checked').length;
                if(stillChecked === 0) {
                    const otherTransport = document.getElementById(`call-transport-${otherType}-${otherPersonId}`);
                    if(otherTransport && (otherTransport.value === 'with' || otherTransport.value === 'own-brings')) {
                        otherTransport.value = '';
                        Planning.onTransportChange(otherType, otherPersonId);
                    }
                }
            }
        }, 100);
    },
    
    updateWithWhoLabel: (type, personId) => {
        const dropdown = document.getElementById(`call-withwho-${type}-${personId}`);
        const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
        const label = dropdown?.querySelector('.withwho-label');
        
        if(!list || !label) return;
        
        const checked = list.querySelectorAll('input[type="checkbox"]:checked');
        
        if(checked.length === 0) {
            label.textContent = '-- Choisir --';
        } else if(checked.length === 1) {
            label.textContent = checked[0].nextElementSibling.textContent;
        } else {
            label.textContent = `${checked.length} personnes`;
        }
    },
    
    // Remplit le dropdown "Avec qui" avec les personnes du projet
    populateWithWhoDropdown: (type, personId, transport) => {getElementById(`call-withwho-${type}-${personId}`);
        const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
        const label = dropdown?.querySelector('.withwho-label');
        
        if(!list || !label) return;
        
        const checked = list.querySelectorAll('input[type="checkbox"]:checked');
        
        if(checked.length === 0) {
            label.textContent = '-- Choisir --';
        } else if(checked.length === 1) {
            label.textContent = checked[0].nextElementSibling.textContent;
        } else {
            label.textContent = `${checked.length} personnes`;
        }
    },
    
    // Remplit le dropdown "Avec qui" avec les personnes du projet
    populateWithWhoDropdown: (type, personId, transport) => {
        const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
        if(!list) return;
        
        // R√©cup√©rer les donn√©es sauvegard√©es
        const shootDay = Planning.tempShootDay || {};
        const call = shootDay.callSheet?.find(c => c.personId === personId && c.type === type);
        const savedWithWho = call?.withWho || [];
        
        let html = '';
        
        // Ajouter les com√©diens
        (state.data.actors || []).forEach(actor => {
            if(type === 'actor' && actor.id === personId) return; // Exclure soi-m√™me
            const checked = savedWithWho.includes(`actor_${actor.id}`) ? 'checked' : '';
            html += `<div class="withwho-item ${checked ? 'selected' : ''}">
                <input type="checkbox" id="withwho-actor-${actor.id}-for-${type}-${personId}" value="actor_${actor.id}" ${checked} onchange="app.Planning.onWithWhoItemClick('${type}', '${personId}', 'actor_${actor.id}', this)">
                <label for="withwho-actor-${actor.id}-for-${type}-${personId}">üé≠ ${Utils.escape(actor.name)}</label>
            </div>`;
        });
        
        // Ajouter les techniciens
        (state.data.crew || []).forEach(member => {
            if(type === 'crew' && member.id === personId) return; // Exclure soi-m√™me
            const checked = savedWithWho.includes(`crew_${member.id}`) ? 'checked' : '';
            html += `<div class="withwho-item ${checked ? 'selected' : ''}">
                <input type="checkbox" id="withwho-crew-${member.id}-for-${type}-${personId}" value="crew_${member.id}" ${checked} onchange="app.Planning.onWithWhoItemClick('${type}', '${personId}', 'crew_${member.id}', this)">
                <label for="withwho-crew-${member.id}-for-${type}-${personId}">üé¨ ${Utils.escape(member.name)}</label>
            </div>`;
        });
        
        list.innerHTML = html || '<div class="withwho-item" style="color: var(--text-sec);">Aucune personne disponible</div>';
        
        // Mettre √† jour le label
        Planning.updateWithWhoLabel(type, personId);
    },
    
    // Initialise tous les dropdowns "Avec qui" apr√®s le rendu du formulaire
    initWithWhoDropdowns: () => {
        const shootDay = Planning.tempShootDay || {};
        
        // Pour chaque personne dans la callSheet
        (shootDay.callSheet || []).forEach(call => {
            if(call.transport === 'own-brings' || call.transport === 'with') {
                Planning.populateWithWhoDropdown(call.type, call.personId, call.transport);
            }
        });
        
        // Fermer les dropdowns quand on clique ailleurs
        document.addEventListener('click', Planning.closeAllWithWhoDropdowns);
    },
    
    // Ferme tous les dropdowns si on clique en dehors
    closeAllWithWhoDropdowns: (e) => {
        if(!e.target.closest('.withwho-dropdown')) {
            document.querySelectorAll('.withwho-list.open').forEach(el => {
                el.classList.remove('open');
                el.previousElementSibling?.classList.remove('open');
            });
        }
    },
    
    notifyCallSheet: async (shootDay) => {
        if(!shootDay.callSheet || shootDay.callSheet.length === 0) return;
        
        const projectName = state.data.title || 'Projet';
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'La production';
        
        for(const call of shootDay.callSheet) {
            let person = null;
            let personType = '';
            
            if(call.type === 'actor') {
                person = state.data.actors.find(a => a.id === call.personId);
                personType = 'com√©dien¬∑ne';
            } else if(call.type === 'crew') {
                person = state.data.crew.find(c => c.id === call.personId);
                personType = 'technicien¬∑ne';
            }
            
            if(person && person.email) {
                const subject = `üé¨ Convocation J${shootDay.dayNumber} - ${projectName}`;
                const content = `Bonjour ${person.name || ''},

Vous √™tes convoqu√©¬∑e pour le tournage de "${projectName}" :

üìÖ Date : ${dateFormatted}
üìç Lieu : ${shootDay.location || '√Ä confirmer'}${shootDay.locationAddress ? '\nüìå Adresse : ' + shootDay.locationAddress : ''}
‚è∞ Convocation : ${call.callTime || shootDay.crewCall || '√Ä confirmer'}
üé¨ Pr√™t √† tourner : ${shootDay.readyToShoot || '√Ä confirmer'}
${call.notes ? '\nüìù Notes : ' + call.notes : ''}
${shootDay.notes ? '\nüìã Notes g√©n√©rales : ' + shootDay.notes : ''}

Merci de confirmer votre pr√©sence.

${senderName}
${projectName}`;

                try {
                    // Envoyer message interne
                    await Messages.send(person.email, {
                        subject: subject,
                        content: content,
                        type: 'callsheet',
                        projectId: state.currentProjectId,
                        projectName: projectName,
                        shootDayId: shootDay.id,
                        date: shootDay.date
                    });
                    
                    // Envoyer email
                    await Messages.sendEmailPing(person.email, person.name, 'callsheet', {
                        projectName: projectName,
                        shootDate: dateFormatted,
                        location: shootDay.location || '√Ä confirmer',
                        callTime: call.callTime || shootDay.crewCall || '√Ä confirmer'
                    });
                } catch(e) {
                    console.warn(`Erreur notification ${person.name}:`, e);
                }
            }
        }
    },
    
    syncShootingDatesToProfiles: () => {
        // Collecter tous les jours de tournage avec leurs callsheets
        const shootingDays = state.data.shootingDays || [];
        const projectName = state.data.title || 'Projet';
        const projectId = state.currentProjectId;
        
        // R√©initialiser les shootingDates de tous les acteurs et techniciens pour ce projet
        (state.data.actors || []).forEach(actor => {
            if(!actor.shootingDates) actor.shootingDates = [];
            actor.shootingDates = actor.shootingDates.filter(sd => sd.projectId !== projectId);
        });
        (state.data.crew || []).forEach(member => {
            if(!member.shootingDates) member.shootingDates = [];
            member.shootingDates = member.shootingDates.filter(sd => sd.projectId !== projectId);
        });
        
        // Ajouter les nouvelles dates de tournage
        shootingDays.forEach(day => {
            if(!day.callSheet || !day.date) return;
            
            day.callSheet.forEach(call => {
                if(call.type === 'actor') {
                    const actor = state.data.actors.find(a => a.id === call.personId);
                    if(actor) {
                        if(!actor.shootingDates) actor.shootingDates = [];
                        actor.shootingDates.push({
                            date: day.date,
                            projectId: projectId,
                            projectName: projectName,
                            dayNumber: day.dayNumber,
                            callTime: call.callTime,
                            location: day.location
                        });
                    }
                } else if(call.type === 'crew') {
                    const member = state.data.crew.find(c => c.id === call.personId);
                    if(member) {
                        if(!member.shootingDates) member.shootingDates = [];
                        member.shootingDates.push({
                            date: day.date,
                            projectId: projectId,
                            projectName: projectName,
                            dayNumber: day.dayNumber,
                            callTime: call.callTime,
                            location: day.location
                        });
                    }
                }
            });
        });
        
        // Synchroniser vers les profils publics sur Firebase
        Planning.syncShootingDatesToPublicProfiles();
    },
    
    // Pousse les dates de tournage vers les profils publics Firebase
    syncShootingDatesToPublicProfiles: async () => {
        const projectId = state.currentProjectId;
        const projectName = state.data.title || 'Projet';
        
        // Sync acteurs avec profil public
        for(const actor of (state.data.actors || [])) {
            if(actor.publicProfileId) {
                try {
                    const shootingDates = actor.shootingDates || [];
                    await firebase.database().ref('public_actors/' + actor.publicProfileId + '/shootingDates').transaction(currentDates => {
                        let dates = currentDates || [];
                        // Retirer les anciennes dates de ce projet
                        dates = dates.filter(d => d.projectId !== projectId);
                        // Ajouter les nouvelles dates
                        shootingDates.filter(d => d.projectId === projectId).forEach(d => dates.push(d));
                        return dates;
                    });
                } catch(e) {
                    console.warn('Erreur sync shooting dates actor:', e);
                }
            }
        }
        
        // Sync techniciens avec profil public
        for(const member of (state.data.crew || [])) {
            if(member.publicProfileId) {
                try {
                    const shootingDates = member.shootingDates || [];
                    await firebase.database().ref('public_crew/' + member.publicProfileId + '/shootingDates').transaction(currentDates => {
                        let dates = currentDates || [];
                        // Retirer les anciennes dates de ce projet
                        dates = dates.filter(d => d.projectId !== projectId);
                        // Ajouter les nouvelles dates
                        shootingDates.filter(d => d.projectId === projectId).forEach(d => dates.push(d));
                        return dates;
                    });
                } catch(e) {
                    console.warn('Erreur sync shooting dates crew:', e);
                }
            }
        }
        
        console.log('‚úÖ Dates de tournage synchronis√©es vers profils publics');
    },
    
    saveShootDay: () => {
        if(state.currentRole === 'viewer') return;
        
        const startDate = document.getElementById('edit-startDate').value;
        const endDate = document.getElementById('edit-endDate').value || startDate;
        
        // G√©n√©rer le nom automatiquement si vide
        let name = document.getElementById('edit-name').value.trim();
        if(!name && Planning.tempShootDay && Planning.tempShootDay.scenes && Planning.tempShootDay.scenes.length > 0 && state.data.scenes) {
            const sceneInfos = Planning.tempShootDay.scenes.map(ref => {
                const sceneIndex = state.data.scenes.findIndex(s => s.id === ref.sceneId);
                const selectedShots = ref.selectedShots || [];
                const shotCount = selectedShots.length;
                return sceneIndex >= 0 ? { num: sceneIndex + 1, shots: shotCount } : null;
            }).filter(Boolean);
            
            if(sceneInfos.length === 1) {
                // Une seule sc√®ne : Sc.3 (5 pl.)
                const info = sceneInfos[0];
                name = `Sc.${info.num}` + (info.shots > 0 ? ` (${info.shots} pl.)` : '');
            } else if(sceneInfos.length > 1) {
                // Plusieurs sc√®nes : Sc.3(3pl);5(5pl)
                name = 'Sc.' + sceneInfos.map(info => 
                    info.shots > 0 ? `${info.num}(${info.shots}pl)` : `${info.num}`
                ).join(';');
            }
        }
        if(!name) {
            name = `Tournage ${startDate}`;
        }
        
        const shootDay = {
            id: Planning.editingDayId === 'new' ? Utils.generateUniqueId() : Planning.editingDayId,
            dayType: document.getElementById('edit-dayType').value || 'tournage',
            startDate: startDate,
            endDate: endDate,
            name: name,
            location: document.getElementById('edit-location').value,
            locationRealName: document.getElementById('edit-location').value,
            locationAddress: document.getElementById('edit-locationAddress').value,
            locationLat: document.getElementById('edit-locationLat').value || null,
            locationLng: document.getElementById('edit-locationLng').value || null,
            contactName: document.getElementById('edit-contactName').value,
            contactPhone: document.getElementById('edit-contactPhone').value,
            locationNotes: document.getElementById('edit-locationNotes').value,
            crewCall: document.getElementById('edit-crewCall').value,
            readyToShoot: document.getElementById('edit-readyToShoot').value,
            lunchStart: document.getElementById('edit-lunchStart').value,
            lunchEnd: document.getElementById('edit-lunchEnd').value,
            estimatedWrap: document.getElementById('edit-estimatedWrap').value,
            scenes: [],
            callSheet: [],
            notes: document.getElementById('edit-notes').value,
            customWeather: document.getElementById('edit-customWeather').value
        };
        
        // Collect scenes from tempShootDay
        if(Planning.tempShootDay && Planning.tempShootDay.scenes) {
            Planning.tempShootDay.scenes.forEach(ref => {
                const timeInput = document.getElementById(`scene-time-${ref.sceneId}`);
                shootDay.scenes.push({ 
                    sceneId: ref.sceneId, 
                    startTime: timeInput ? timeInput.value : ref.startTime,
                    selectedShots: ref.selectedShots || []
                });
            });
        }
        
        // Collect callsheet
        document.querySelectorAll('.callsheet-table input[type="checkbox"]:checked').forEach(cb => {
            const type = cb.dataset.type;
            const personId = cb.dataset.id;
            
            // V√©rifier que les √©l√©ments existent avant d'acc√©der √† leur valeur
            const callTimeEl = document.getElementById(`call-time-${type}-${personId}`);
            const notesEl = document.getElementById(`call-notes-${type}-${personId}`);
            const transportEl = document.getElementById(`call-transport-${type}-${personId}`);
            
            // Si les √©l√©ments n'existent pas, ignorer cette entr√©e
            if(!callTimeEl || !notesEl || !transportEl) return;
            
            const callTime = callTimeEl.value;
            const notes = notesEl.value;
            const transport = transportEl.value;
            
            // R√©cup√©rer les personnes s√©lectionn√©es dans "Avec qui" (nouveau dropdown avec checkboxes)
            let withWho = [];
            if(transport === 'own-brings' || transport === 'with') {
                const list = document.getElementById(`call-withwho-list-${type}-${personId}`);
                if(list) {
                    list.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                        withWho.push(checkbox.value);
                    });
                }
            }
            
            shootDay.callSheet.push({ type, personId, callTime, notes, transport, withWho });
        });
        
        // Save
        if(Planning.editingDayId === 'new') {
            if(!state.data.shootingDays) state.data.shootingDays = [];
            state.data.shootingDays.push(shootDay);
        } else {
            const idx = state.data.shootingDays.findIndex(sd => sd.id === shootDay.id);
            if(idx > -1) {
                state.data.shootingDays[idx] = shootDay;
            }
        }
        
        // Log historique
        const isNew = Planning.editingDayId === 'new';
        History.log(isNew ? 'ADD' : 'EDIT', `${isNew ? 'Ajout' : 'Modification'} tournage "${shootDay.name}" (${shootDay.startDate}${shootDay.endDate !== shootDay.startDate ? ' ‚Üí ' + shootDay.endDate : ''})`);
        
        // Synchroniser les calendriers des profils
        Planning.syncShootingDatesToProfiles();
        
        Store.save();
        Planning.closeModal();
        Planning.render();
        
        Utils.toast('Jour de tournage sauvegard√© !', 'success');
    },
    
    deleteShootDay: async (dayId) => {
        if(!await ConfirmModal.confirmDelete("Ce jour de tournage sera supprim√©.")) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        History.log('DELETE', `Suppression jour de tournage #${shootDay?.dayNumber || '?'} (${shootDay?.date || '?'})`);
        state.data.shootingDays = state.data.shootingDays.filter(sd => sd.id !== dayId);
        
        // Synchroniser les calendriers des profils
        Planning.syncShootingDatesToProfiles();
        
        Store.save();
        Planning.closeModal();
        Planning.render();
    },
    
    deleteShootDayFromList: async (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!await ConfirmModal.confirmDelete(`Le tournage "${shootDay?.name || 'Tournage'}" (${shootDay?.startDate || shootDay?.date || '?'}) sera supprim√©.`)) return;
        
        History.log('DELETE', `Suppression tournage "${shootDay?.name || '?'}" (${shootDay?.startDate || shootDay?.date || '?'})`);
        state.data.shootingDays = state.data.shootingDays.filter(sd => sd.id !== dayId);
        
        // Synchroniser les calendriers des profils
        Planning.syncShootingDatesToProfiles();
        
        Store.save();
        Planning.openCallSheets(); // Rafra√Æchir la liste
        Planning.render();
        Utils.toast('Jour de tournage supprim√©', 'success');
    },
    
    showDayContextMenu: (event, dayId) => {
        // Supprimer un ancien menu s'il existe
        const oldMenu = document.getElementById('planning-context-menu');
        if(oldMenu) oldMenu.remove();
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        const menu = document.createElement('div');
        menu.id = 'planning-context-menu';
        let menuTop = event.clientY;
        let menuLeft = event.clientX;
        if(menuLeft + 200 > window.innerWidth) menuLeft = window.innerWidth - 210;
        if(menuTop + 180 > window.innerHeight) menuTop = window.innerHeight - 190;
        if(menuLeft < 10) menuLeft = 10;
        if(menuTop < 10) menuTop = 10;
        menu.style.cssText = `
            position: fixed;
            top: ${menuTop}px;
            left: ${menuLeft}px;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 99999;
            min-width: 180px;
            overflow: hidden;
        `;
        
        menu.innerHTML = `
            <div style="padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-sec); font-size: 0.85rem;">
                üìÖ ${Utils.escape(shootDay.name || 'Tournage').substring(0, 20)} - ${new Date(shootDay.startDate || shootDay.date).toLocaleDateString('fr-FR')}
            </div>
            <div class="context-menu-item" onclick="event.stopPropagation(); app.Planning.hideContextMenu(); app.Planning.editShootDay('${dayId}');" style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                <span>‚úèÔ∏è</span> Modifier
            </div>
            <div class="context-menu-item" onclick="event.stopPropagation(); app.Planning.hideContextMenu(); app.Planning.duplicateShootDay('${dayId}');" style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                <span>üìã</span> Dupliquer
            </div>
            <div class="context-menu-item" onclick="event.stopPropagation(); app.Planning.hideContextMenu(); app.Planning.deleteShootDayFromCalendar('${dayId}');" style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--danger);">
                <span>üóëÔ∏è</span> Supprimer
            </div>
        `;
        
        document.body.appendChild(menu);
        
        // Fermer le menu en cliquant ailleurs
        setTimeout(() => {
            document.addEventListener('click', Planning.hideContextMenu, { once: true });
        }, 10);
    },
    
    hideContextMenu: () => {
        const menu = document.getElementById('planning-context-menu');
        if(menu) menu.remove();
    },
    
    deleteShootDayFromCalendar: async (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!await ConfirmModal.confirmDelete(`Le tournage "${shootDay?.name || 'Tournage'}" (${shootDay?.startDate || shootDay?.date || '?'}) sera supprim√©.`)) return;
        
        History.log('DELETE', `Suppression tournage "${shootDay?.name || '?'}" (${shootDay?.startDate || shootDay?.date || '?'})`);
        state.data.shootingDays = state.data.shootingDays.filter(sd => sd.id !== dayId);
        
        Planning.syncShootingDatesToProfiles();
        Store.save();
        Planning.render();
        Utils.toast('Jour de tournage supprim√©', 'success');
    },
    
    duplicateShootDay: (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        const newDay = JSON.parse(JSON.stringify(shootDay));
        newDay.id = Utils.generateUniqueId();
        newDay.dayNumber = (state.data.shootingDays.length || 0) + 1;
        newDay.date = ''; // √Ä d√©finir
        newDay.validated = false;
        
        state.data.shootingDays.push(newDay);
        Store.save();
        
        // Ouvrir la modale pour d√©finir la nouvelle date
        Planning.editShootDay(newDay.id);
        Utils.toast('Jour dupliqu√© - D√©finissez la nouvelle date', 'info');
    },
    
    draggedDayId: null,
    
    onDragStart: (event, dayId) => {
        Planning.draggedDayId = dayId;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', dayId);
        event.target.style.opacity = '0.5';
    },
    
    onDragOver: (event) => {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        event.currentTarget.style.background = 'rgba(43, 110, 246, 0.2)';
    },
    
    onDrop: async (event, targetDate) => {
        event.preventDefault();
        event.currentTarget.style.background = '';
        
        if(!Planning.draggedDayId) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.draggedDayId);
        if(!shootDay) return;
        
        // Calculer la dur√©e du tournage
        const oldStartDate = shootDay.startDate || shootDay.date;
        const oldEndDate = shootDay.endDate || oldStartDate;
        const startDateObj = new Date(oldStartDate);
        const endDateObj = new Date(oldEndDate);
        const duration = Math.round((endDateObj - startDateObj) / (1000 * 60 * 60 * 24));
        
        // Calculer les nouvelles dates
        const newStartDate = targetDate;
        const newStartDateObj = new Date(newStartDate);
        const newEndDateObj = new Date(newStartDateObj);
        newEndDateObj.setDate(newEndDateObj.getDate() + duration);
        const newEndDate = Planning.formatDate(newEndDateObj);
        
        // V√©rifier si un jour existe d√©j√† √† cette date
        const existingDay = state.data.shootingDays.find(sd => {
            if(sd.id === Planning.draggedDayId) return false;
            const start = sd.startDate || sd.date;
            const end = sd.endDate || start;
            return (newStartDate >= start && newStartDate <= end) || (newEndDate >= start && newEndDate <= end);
        });
        
        if(existingDay) {
            if(!await ConfirmModal.show({ title: 'Jour existant', message: 'Un jour de tournage existe d√©j√† sur cette p√©riode.\n\nVoulez-vous continuer ?', icon: 'üìÖ', confirmText: 'Continuer' })) {
                Planning.draggedDayId = null;
                Planning.render();
                return;
            }
        }
        
        shootDay.startDate = newStartDate;
        shootDay.endDate = newEndDate;
        // Supprimer l'ancien format si pr√©sent
        delete shootDay.date;
        
        History.log('EDIT', `D√©placement tournage "${shootDay.name}" : ${oldStartDate} ‚Üí ${newStartDate}`);
        Planning.syncShootingDatesToProfiles();
        Store.save();
        Planning.render();
        Utils.toast('Tournage d√©plac√©', 'success');
        
        Planning.draggedDayId = null;
    },
    
    onDragOverWeek: (event, hour) => {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
        event.currentTarget.style.background = 'rgba(43, 110, 246, 0.3)';
    },
    
    onDragLeave: (event) => {
        event.currentTarget.style.background = '';
    },
    
    onDropWeek: async (event, targetDate, hour) => {
        event.preventDefault();
        event.currentTarget.style.background = '';
        
        if(!Planning.draggedDayId) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.draggedDayId);
        if(!shootDay) return;
        
        // Calculer la dur√©e en jours
        const oldStartDate = shootDay.startDate || shootDay.date;
        const oldEndDate = shootDay.endDate || oldStartDate;
        const startDateObj = new Date(oldStartDate);
        const endDateObj = new Date(oldEndDate);
        const durationDays = Math.round((endDateObj - startDateObj) / (1000 * 60 * 60 * 24));
        
        // Calculer la dur√©e en heures
        const oldStartHour = shootDay.crewCall ? parseInt(shootDay.crewCall.split(':')[0]) : 7;
        const oldEndHour = shootDay.estimatedWrap ? parseInt(shootDay.estimatedWrap.split(':')[0]) : 19;
        const durationHours = oldEndHour - oldStartHour;
        
        // Nouvelles dates
        const newStartDate = targetDate;
        const newStartDateObj = new Date(newStartDate);
        const newEndDateObj = new Date(newStartDateObj);
        newEndDateObj.setDate(newEndDateObj.getDate() + durationDays);
        const newEndDate = Planning.formatDate(newEndDateObj);
        
        // Nouvelle heure de d√©but et fin
        const newStartHour = hour;
        const newEndHour = Math.min(hour + durationHours, 22);
        
        // V√©rifier si un jour existe d√©j√† √† cette date
        const existingDay = state.data.shootingDays.find(sd => {
            if(sd.id === Planning.draggedDayId) return false;
            const start = sd.startDate || sd.date;
            const end = sd.endDate || start;
            return (newStartDate >= start && newStartDate <= end) || (newEndDate >= start && newEndDate <= end);
        });
        
        if(existingDay) {
            if(!await ConfirmModal.show({ title: 'Tournage existant', message: 'Un tournage existe d√©j√† sur cette p√©riode.\n\nVoulez-vous continuer ?', icon: 'üìÖ', confirmText: 'Continuer' })) {
                Planning.draggedDayId = null;
                Planning.render();
                return;
            }
        }
        
        shootDay.startDate = newStartDate;
        shootDay.endDate = newEndDate;
        delete shootDay.date;
        shootDay.crewCall = String(newStartHour).padStart(2, '0') + ':00';
        shootDay.estimatedWrap = String(newEndHour).padStart(2, '0') + ':00';
        
        // Mettre √† jour readyToShoot (30 min apr√®s crewCall)
        shootDay.readyToShoot = String(newStartHour).padStart(2, '0') + ':30';
        
        History.log('EDIT', `D√©placement tournage "${shootDay.name}" : ${oldStartDate} ‚Üí ${newStartDate} (${shootDay.crewCall} - ${shootDay.estimatedWrap})`);
        Planning.syncShootingDatesToProfiles();
        Store.save();
        Planning.render();
        Utils.toast(`Tournage d√©plac√© au ${newStartDate} (${shootDay.crewCall} - ${shootDay.estimatedWrap})`, 'success');
        
        Planning.draggedDayId = null;
    },
    
    // Resize des √©v√©nements
    resizingDayId: null,
    resizeDirection: null,
    resizeStartY: 0,
    resizeStartHour: 0,
    
    startResize: (event, dayId, direction) => {
        event.preventDefault();
        event.stopPropagation();
        
        Planning.resizingDayId = dayId;
        Planning.resizeDirection = direction;
        Planning.resizeStartY = event.clientY;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(shootDay) {
            if(direction === 'top') {
                Planning.resizeStartHour = shootDay.crewCall ? parseInt(shootDay.crewCall.split(':')[0]) : 7;
            } else {
                Planning.resizeStartHour = shootDay.estimatedWrap ? parseInt(shootDay.estimatedWrap.split(':')[0]) : 19;
            }
        }
        
        document.addEventListener('mousemove', Planning.onResizeMove);
        document.addEventListener('mouseup', Planning.onResizeEnd);
    },
    
    onResizeMove: (event) => {
        if(!Planning.resizingDayId) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.resizingDayId);
        if(!shootDay) return;
        
        // Calculer le delta en heures (30px = 1 heure approximativement)
        const deltaY = event.clientY - Planning.resizeStartY;
        const deltaHours = Math.round(deltaY / 30);
        
        let newHour = Planning.resizeStartHour + deltaHours;
        newHour = Math.max(6, Math.min(22, newHour));
        
        if(Planning.resizeDirection === 'top') {
            const endHour = shootDay.estimatedWrap ? parseInt(shootDay.estimatedWrap.split(':')[0]) : 19;
            if(newHour < endHour) {
                shootDay.crewCall = String(newHour).padStart(2, '0') + ':00';
                shootDay.readyToShoot = String(newHour).padStart(2, '0') + ':30';
            }
        } else {
            const startHour = shootDay.crewCall ? parseInt(shootDay.crewCall.split(':')[0]) : 7;
            if(newHour > startHour) {
                shootDay.estimatedWrap = String(newHour).padStart(2, '0') + ':00';
            }
        }
        
        Planning.render();
    },
    
    onResizeEnd: () => {
        if(Planning.resizingDayId) {
            const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.resizingDayId);
            if(shootDay) {
                History.log('EDIT', `Modification horaires jour #${shootDay.dayNumber} : ${shootDay.crewCall} - ${shootDay.estimatedWrap}`);
                Planning.syncShootingDatesToProfiles();
                Store.save();
                Utils.toast(`Horaires modifi√©s : ${shootDay.crewCall} - ${shootDay.estimatedWrap}`, 'success');
            }
        }
        
        Planning.resizingDayId = null;
        Planning.resizeDirection = null;
        document.removeEventListener('mousemove', Planning.onResizeMove);
        document.removeEventListener('mouseup', Planning.onResizeEnd);
    },
    
    // Resize horizontal (√©tendre sur plusieurs jours)
    resizeHorizontalDayId: null,
    resizeHorizontalStartX: 0,
    resizeHorizontalDirection: null,
    resizeHorizontalOriginalStartDate: null,
    resizeHorizontalOriginalEndDate: null,
    
    startResizeHorizontal: (event, dayId, direction) => {
        event.preventDefault();
        event.stopPropagation();
        
        Planning.resizeHorizontalDayId = dayId;
        Planning.resizeHorizontalStartX = event.clientX;
        Planning.resizeHorizontalDirection = direction;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(shootDay) {
            Planning.resizeHorizontalOriginalStartDate = shootDay.startDate || shootDay.date;
            Planning.resizeHorizontalOriginalEndDate = shootDay.endDate || shootDay.startDate || shootDay.date;
        }
        
        document.addEventListener('mousemove', Planning.onResizeHorizontalMove);
        document.addEventListener('mouseup', Planning.onResizeHorizontalEnd);
    },
    
    onResizeHorizontalMove: (event) => {
        if(!Planning.resizeHorizontalDayId) return;
        
        const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.resizeHorizontalDayId);
        if(!shootDay) return;
        
        // Trouver la cellule sous le curseur
        const elementUnderCursor = document.elementFromPoint(event.clientX, event.clientY);
        const dayCell = elementUnderCursor?.closest('.planning-day, .planning-week-cell');
        
        if(dayCell) {
            const targetDate = dayCell.dataset?.date || dayCell.getAttribute('onclick')?.match(/'(\d{4}-\d{2}-\d{2})'/)?.[1];
            
            if(targetDate) {
                const startDate = new Date(shootDay.startDate || shootDay.date);
                const targetDateObj = new Date(targetDate);
                
                if(Planning.resizeHorizontalDirection === 'right') {
                    // Ne pas permettre endDate < startDate
                    if(targetDateObj >= startDate) {
                        if(shootDay.endDate !== targetDate) {
                            shootDay.endDate = targetDate;
                            Planning.render();
                        }
                    }
                } else if(Planning.resizeHorizontalDirection === 'left') {
                    const endDate = new Date(shootDay.endDate || shootDay.startDate || shootDay.date);
                    // Ne pas permettre startDate > endDate
                    if(targetDateObj <= endDate) {
                        if(shootDay.startDate !== targetDate) {
                            shootDay.startDate = targetDate;
                            Planning.render();
                        }
                    }
                }
            }
        }
    },
    
    onResizeHorizontalEnd: () => {
        if(Planning.resizeHorizontalDayId) {
            const shootDay = state.data.shootingDays.find(sd => sd.id === Planning.resizeHorizontalDayId);
            if(shootDay) {
                const startDate = shootDay.startDate || shootDay.date;
                const endDate = shootDay.endDate || startDate;
                
                History.log('EDIT', `Modification dur√©e tournage "${shootDay.name || 'Sans nom'}" : ${startDate} ‚Üí ${endDate}`);
                Planning.syncShootingDatesToProfiles();
                Store.save();
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                Utils.toast(`Tournage √©tendu sur ${days} jour(s)`, 'success');
            }
        }
        
        Planning.resizeHorizontalDayId = null;
        Planning.resizeHorizontalDirection = null;
        document.removeEventListener('mousemove', Planning.onResizeHorizontalMove);
        document.removeEventListener('mouseup', Planning.onResizeHorizontalEnd);
    },
    
    // Autocompl√©tion d'adresse via Nominatim (OpenStreetMap)
    addressSearchTimeout: null,
    searchAddress: (query) => {
        clearTimeout(Planning.addressSearchTimeout);
        const suggestions = document.getElementById('address-suggestions');
        
        if(!query || query.length < 3) {
            suggestions.classList.remove('visible');
            return;
        }
        
        Planning.addressSearchTimeout = setTimeout(async () => {
            try {
                // Utiliser l'API Adresse du gouvernement fran√ßais (plus pr√©cise)
                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
                const data = await response.json();
                
                if(data.features && data.features.length > 0) {
                    suggestions.innerHTML = data.features.map(f => {
                        const props = f.properties;
                        const coords = f.geometry.coordinates;
                        const label = props.label || '';
                        const context = props.context || '';
                        return `<div class="address-suggestion" onclick="app.Planning.selectAddress('${Utils.escape(label).replace(/'/g, "\\'")}', ${coords[1]}, ${coords[0]})">
                            <div class="address-suggestion-main">${Utils.escape(props.name || label.split(',')[0])}</div>
                            <div class="address-suggestion-secondary">${Utils.escape(context)}</div>
                        </div>`;
                    }).join('');
                    suggestions.classList.add('visible');
                } else {
                    suggestions.innerHTML = '<div class="address-suggestion" style="color:var(--text-sec); cursor:default;">Aucun r√©sultat</div>';
                    suggestions.classList.add('visible');
                }
            } catch(e) {
                console.error('Erreur recherche adresse:', e);
                suggestions.classList.remove('visible');
            }
        }, 300);
    },
    
    selectAddress: (address, lat, lng) => {
        document.getElementById('edit-locationAddress').value = address;
        document.getElementById('edit-locationLat').value = lat;
        document.getElementById('edit-locationLng').value = lng;
        document.getElementById('address-suggestions').classList.remove('visible');
        
        // Afficher la mini-carte
        Planning.showMiniMap(lat, lng);
    },
    
    showMiniMap: (lat, lng) => {
        const mapContainer = document.getElementById('location-minimap');
        if(!mapContainer) return;
        
        mapContainer.style.display = 'block';
        mapContainer.innerHTML = '';
        
        // Utiliser Leaflet si disponible (d√©j√† charg√© pour l'Univers)
        if(typeof L !== 'undefined') {
            const miniMap = L.map(mapContainer, { 
                zoomControl: false, 
                attributionControl: false,
                dragging: false,
                scrollWheelZoom: false
            }).setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
            L.marker([lat, lng]).addTo(miniMap);
            
            // Stocker la r√©f√©rence pour nettoyage
            Planning.currentMiniMap = miniMap;
        } else {
            // Fallback: image statique
            mapContainer.innerHTML = `<img src="https://staticmap.openstreetmap.de/staticmap.php?center=${lat},${lng}&zoom=15&size=400x150&markers=${lat},${lng},red-pushpin" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
        }
    },
    
    updateSceneSelection: () => {
        // Auto-add actors from selected scenes to callsheet
        document.querySelectorAll('#scenes-selection input[type="checkbox"]').forEach(cb => {
            const sceneId = cb.value;
            const scene = state.data.scenes.find(s => s.id === sceneId);
            
            if(cb.checked && scene && scene.perso) {
                const characterNames = scene.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
                
                characterNames.forEach(charName => {
                    const character = state.data.characters.find(c => c.name.toUpperCase() === charName);
                    if(character && character.actor_id) {
                        const actorCheckbox = document.getElementById(`call-actor-${character.actor_id}`);
                        if(actorCheckbox && !actorCheckbox.checked) {
                            actorCheckbox.checked = true;
                        }
                    }
                });
            }
        });
    },
    
	tempShootDay: null,
    
addSceneToDay: () => {
        const dropdown = document.getElementById('scene-dropdown');
        const sceneIdRaw = dropdown ? dropdown.value : null;
        
        if(!sceneIdRaw) {
            Utils.toast('Veuillez s√©lectionner une sc√®ne', 'warning');
            return;
        }
        
        // Essayer de trouver la sc√®ne avec string OU number
        let scene = state.data.scenes.find(s => s.id === sceneIdRaw);
        if(!scene) {
            scene = state.data.scenes.find(s => s.id === parseInt(sceneIdRaw));
        }
        if(!scene) {
            scene = state.data.scenes.find(s => String(s.id) === sceneIdRaw);
        }
        
        if(!scene) {
            Utils.toast('Sc√®ne introuvable !', 'error');
            return;
        }
        
        const sceneId = scene.id; // Utiliser l'ID exact de la sc√®ne trouv√©e
        
        // Initialize tempShootDay if needed
        if(!Planning.tempShootDay) {
            Planning.tempShootDay = { 
                scenes: [], 
                callSheet: [] 
            };
        }
        
        if(!Planning.tempShootDay.scenes) {
            Planning.tempShootDay.scenes = [];
        }
        
        if(!Planning.tempShootDay.callSheet) {
            Planning.tempShootDay.callSheet = [];
        }
        
        // Check if already added
        if(Planning.tempShootDay.scenes.some(ref => ref.sceneId === sceneId)) {
            Utils.toast('Cette sc√®ne est d√©j√† ajout√©e', 'warning');
            return;
        }
        
        // Add scene
        Planning.tempShootDay.scenes.push({ sceneId: sceneId, startTime: '' });
        
        // Auto-add actors from this scene
        if(scene.perso) {
            const characterNames = scene.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
            
            characterNames.forEach(charName => {
                const character = state.data.characters.find(c => c.name.toUpperCase() === charName);
                if(character && character.actor_id) {
                    // Check if already in callsheet
                    const alreadyAdded = Planning.tempShootDay.callSheet.some(c => c.personId === character.actor_id && c.type === 'actor');
                    if(!alreadyAdded) {
                        Planning.tempShootDay.callSheet.push({
                            type: 'actor',
                            personId: character.actor_id,
                            callTime: '',
                            notes: ''
                        });
                        
                        // Check the checkbox
                        const actorCheckbox = document.getElementById(`call-actor-${character.actor_id}`);
                        if(actorCheckbox) {
                            actorCheckbox.checked = true;
                        }
                    }
                }
            });
        }
        
        // Refresh the list
        Planning.refreshScenesList();
        
        // Auto-s√©lectionner les acteurs des sc√®nes
        Planning.autoSelectActorsForScenes();
        
        // Auto-s√©lectionner les techniciens selon le d√©pouillement
        Planning.autoSelectCrewForBreakdown();
        
        // Auto-remplir le lieu depuis la sc√®ne (premi√®re sc√®ne ajout√©e uniquement)
        if(Planning.tempShootDay.scenes.length === 1) {
            // Extraire le lieu du titre de la sc√®ne (format: "INT. LIEU - JOUR")
            const locMatch = scene.title.match(/^(?:INT\.|EXT\.|I\/E)\s*([^\-]+)/i);
            if(locMatch && locMatch[1]) {
                const locName = locMatch[1].trim().toUpperCase();
                const loc = state.data.locations.find(l => l.name.toUpperCase() === locName);
                
                if(loc) {
                    // Remplir le s√©lecteur de lieu
                    const locSelect = document.getElementById('edit-location-select');
                    const locInput = document.getElementById('edit-location');
                    if(locSelect) {
                        locSelect.value = loc.name;
                    }
                    if(locInput) {
                        locInput.value = loc.realName || '';
                    }
                    
                    // Remplir les infos du d√©cor
                    if(loc.address) {
                        const addrInput = document.getElementById('edit-locationAddress');
                        if(addrInput && !addrInput.value) addrInput.value = loc.address;
                    }
                    if(loc.contactName) {
                        const contactInput = document.getElementById('edit-contactName');
                        if(contactInput && !contactInput.value) contactInput.value = loc.contactName;
                    }
                    if(loc.contactPhone) {
                        const phoneInput = document.getElementById('edit-contactPhone');
                        if(phoneInput && !phoneInput.value) phoneInput.value = loc.contactPhone;
                    }
                    if(loc.accessNotes) {
                        const notesInput = document.getElementById('edit-locationNotes');
                        if(notesInput && !notesInput.value) notesInput.value = loc.accessNotes;
                    }
                    
                    Utils.toast(`üìç Lieu "${loc.name}" auto-rempli depuis la sc√®ne`, 'success');
                }
            }
        }
    },
    
    removeSceneFromDay: (sceneId) => {
        if(!Planning.tempShootDay) return;
        
        Planning.tempShootDay.scenes = Planning.tempShootDay.scenes.filter(ref => String(ref.sceneId) !== String(sceneId));
        
        // R√©initialiser l'√©quipe selon les sc√®nes restantes
        Planning.recalculateCallSheetForScenes();
        
        Planning.refreshScenesList();
    },
    
    // Recalculer la callsheet en fonction des sc√®nes actuelles
    recalculateCallSheetForScenes: () => {
        if(!Planning.tempShootDay) return;
        
        // Collecter les acteurs et techniciens n√©cessaires pour les sc√®nes restantes
        const neededActorIds = new Set();
        const neededCrewIds = new Set();
        
        (Planning.tempShootDay.scenes || []).forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
            if(!scene) return;
            
            // Acteurs via perso
            if(scene.perso) {
                const characterNames = scene.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
                characterNames.forEach(charName => {
                    const character = state.data.characters?.find(c => c.name.toUpperCase() === charName);
                    if(character && character.actor_id) neededActorIds.add(character.actor_id);
                    const actor = state.data.actors?.find(a => a.name.toUpperCase() === charName);
                    if(actor) neededActorIds.add(actor.id);
                });
            }
            
            // Acteurs via d√©pouillement COMEDIENS
            if(scene.breakdown && scene.breakdown['COMEDIENS']) {
                scene.breakdown['COMEDIENS'].forEach(actorName => {
                    const actor = state.data.actors?.find(a => a.name.toUpperCase() === actorName.toUpperCase());
                    if(actor) neededActorIds.add(actor.id);
                });
            }
            
            // Acteurs via d√©pouillement PERSONNAGES
            if(scene.breakdown && scene.breakdown['PERSONNAGES']) {
                scene.breakdown['PERSONNAGES'].forEach(charName => {
                    const character = state.data.characters?.find(c => c.name.toUpperCase() === charName.toUpperCase());
                    if(character && character.actor_id) neededActorIds.add(character.actor_id);
                });
            }
            
            // Techniciens via d√©pouillement TECHNICIENS
            if(scene.breakdown && scene.breakdown['TECHNICIENS']) {
                scene.breakdown['TECHNICIENS'].forEach(name => {
                    const crew = state.data.crew?.find(c => c.name.toUpperCase() === name.toUpperCase());
                    if(crew) neededCrewIds.add(crew.id);
                });
            }
        });
        
        // Collecter les personnes √† retirer
        const actorsToRemove = [];
        const crewToRemove = [];
        
        // D√©cocher et retirer les acteurs qui ne sont plus n√©cessaires
        (Planning.tempShootDay.callSheet || []).forEach(call => {
            if(call.type === 'actor' && !neededActorIds.has(call.personId)) {
                actorsToRemove.push(call.personId);
                const checkbox = document.getElementById(`call-actor-${call.personId}`);
                if(checkbox) checkbox.checked = false;
                // R√©initialiser le transport
                const transportSelect = document.getElementById(`call-transport-actor-${call.personId}`);
                if(transportSelect) transportSelect.value = '';
                // Cacher le dropdown "avec qui"
                const withWhoDropdown = document.getElementById(`call-withwho-actor-${call.personId}`);
                if(withWhoDropdown) withWhoDropdown.style.display = 'none';
            }
        });
        
        // D√©cocher et retirer les techniciens qui ne sont plus n√©cessaires
        (Planning.tempShootDay.callSheet || []).forEach(call => {
            if(call.type === 'crew' && !neededCrewIds.has(call.personId)) {
                crewToRemove.push(call.personId);
                const checkbox = document.getElementById(`call-crew-${call.personId}`);
                if(checkbox) checkbox.checked = false;
                // R√©initialiser le transport
                const transportSelect = document.getElementById(`call-transport-crew-${call.personId}`);
                if(transportSelect) transportSelect.value = '';
                // Cacher le dropdown "avec qui"
                const withWhoDropdown = document.getElementById(`call-withwho-crew-${call.personId}`);
                if(withWhoDropdown) withWhoDropdown.style.display = 'none';
            }
        });
        
        // Retirer du callSheet
        Planning.tempShootDay.callSheet = Planning.tempShootDay.callSheet.filter(call => {
            if(call.type === 'actor' && actorsToRemove.includes(call.personId)) return false;
            if(call.type === 'crew' && crewToRemove.includes(call.personId)) return false;
            return true;
        });
        
        // Nettoyer les transports "avec qui" pour les personnes retir√©es
        const allRemovedIds = [
            ...actorsToRemove.map(id => `actor_${id}`),
            ...crewToRemove.map(id => `crew_${id}`)
        ];
        
        Planning.tempShootDay.callSheet.forEach(call => {
            if(call.withWho && call.withWho.length > 0) {
                const originalLength = call.withWho.length;
                call.withWho = call.withWho.filter(id => !allRemovedIds.includes(id));
                
                // Si plus personne dans "avec qui", r√©initialiser le transport
                if(call.withWho.length === 0 && (call.transport === 'own-brings' || call.transport === 'with')) {
                    call.transport = '';
                    const transportSelect = document.getElementById(`call-transport-${call.type}-${call.personId}`);
                    if(transportSelect) transportSelect.value = '';
                    const withWhoDropdown = document.getElementById(`call-withwho-${call.type}-${call.personId}`);
                    if(withWhoDropdown) withWhoDropdown.style.display = 'none';
                }
                
                // Mettre √† jour le label si changement
                if(call.withWho.length !== originalLength) {
                    Planning.updateWithWhoLabel(call.type, call.personId);
                    
                    // D√©cocher les checkboxes des personnes retir√©es dans la liste "avec qui"
                    allRemovedIds.forEach(removedId => {
                        const checkbox = document.querySelector(`#call-withwho-list-${call.type}-${call.personId} input[value="${removedId}"]`);
                        if(checkbox) checkbox.checked = false;
                    });
                }
            }
        });
        
        // Mettre √† jour toutes les listes "avec qui" pour retirer les personnes supprim√©es
        Planning.tempShootDay.callSheet.forEach(call => {
            const listContainer = document.getElementById(`call-withwho-list-${call.type}-${call.personId}`);
            if(listContainer) {
                // D√©cocher toutes les checkboxes des personnes retir√©es
                allRemovedIds.forEach(removedId => {
                    const checkbox = listContainer.querySelector(`input[value="${removedId}"]`);
                    if(checkbox) checkbox.checked = false;
                });
            }
        });
        
        // Rafra√Æchir l'affichage de la section besoins/d√©pouillement
        Planning.refreshBreakdownPreview();
    },
    
    // Rafra√Æchir l'aper√ßu du d√©pouillement dans la modal
    refreshBreakdownPreview: () => {
        const container = document.getElementById('breakdown-preview');
        if(!container) return;
        
        // Collecter tous les √©l√©ments de d√©pouillement des sc√®nes s√©lectionn√©es
        const allCategories = {};
        (Planning.tempShootDay?.scenes || []).forEach(ref => {
            const scene = state.data.scenes.find(s => s.id === ref.sceneId || String(s.id) === String(ref.sceneId));
            if(scene && scene.breakdown) {
                Object.entries(scene.breakdown).forEach(([category, items]) => {
                    if(Array.isArray(items) && items.length > 0) {
                        if(!allCategories[category]) allCategories[category] = [];
                        items.forEach(item => {
                            if(!allCategories[category].includes(item)) {
                                allCategories[category].push(item);
                            }
                        });
                    }
                });
            }
        });
        
        if(Object.keys(allCategories).length === 0) {
            container.innerHTML = '<p style="color: var(--text-sec); font-style: italic;">S√©lectionnez des sc√®nes pour voir les besoins</p>';
            return;
        }
        
        container.innerHTML = Object.entries(allCategories).map(([cat, items]) => `
            <div style="display: inline-block; margin: 5px; padding: 8px 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                <strong>${Utils.escape(cat)}</strong>: ${items.map(i => Utils.escape(i)).join(', ')}
            </div>
        `).join('');
    },
    
    toggleShotSelection: (sceneId, shotId) => {
        if(!Planning.tempShootDay) return;
        
        const sceneRef = Planning.tempShootDay.scenes.find(ref => ref.sceneId === sceneId || String(ref.sceneId) === String(sceneId));
        if(!sceneRef) return;
        
        if(!sceneRef.selectedShots) {
            sceneRef.selectedShots = [];
        }
        
        const idx = sceneRef.selectedShots.indexOf(shotId);
        if(idx >= 0) {
            sceneRef.selectedShots.splice(idx, 1);
        } else {
            sceneRef.selectedShots.push(shotId);
        }
        
        Planning.refreshScenesList();
    },
    
    selectAllShots: (sceneId) => {
        if(!Planning.tempShootDay) return;
        
        const sceneRef = Planning.tempShootDay.scenes.find(ref => ref.sceneId === sceneId || String(ref.sceneId) === String(sceneId));
        if(!sceneRef) return;
        
        const sceneShots = state.data.shots ? state.data.shots.filter(s => s.sceneId === sceneId || String(s.sceneId) === String(sceneId)) : [];
        sceneRef.selectedShots = sceneShots.map(s => s.id);
        
        Planning.refreshScenesList();
    },
    
    deselectAllShots: (sceneId) => {
        if(!Planning.tempShootDay) return;
        
        const sceneRef = Planning.tempShootDay.scenes.find(ref => ref.sceneId === sceneId || String(ref.sceneId) === String(sceneId));
        if(!sceneRef) return;
        
        sceneRef.selectedShots = [];
        
        Planning.refreshScenesList();
    },
    
   autoSelectActorsForScenes: () => {
        if(!Planning.tempShootDay || !Planning.tempShootDay.scenes) return;
        if(!Planning.tempShootDay.callSheet) Planning.tempShootDay.callSheet = [];
        
        // Fonction helper pour ajouter un acteur
        const addActorToCallSheet = (actorId) => {
            if(!actorId) return;
            
            // Cocher la checkbox
            const actorCheckbox = document.getElementById(`call-actor-${actorId}`);
            if(actorCheckbox && !actorCheckbox.checked) {
                actorCheckbox.checked = true;
            }
            
            // Ajouter au callSheet si pas d√©j√† pr√©sent
            const alreadyInCallSheet = Planning.tempShootDay.callSheet.some(
                c => c.personId === actorId && c.type === 'actor'
            );
            if(!alreadyInCallSheet) {
                Planning.tempShootDay.callSheet.push({
                    type: 'actor',
                    personId: actorId,
                    callTime: '',
                    notes: ''
                });
            }
        };
        
        Planning.tempShootDay.scenes.forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
            if(!scene) return;
            
            // 1. Chercher via le champ "perso" de la sc√®ne
            if(scene.perso) {
                const characterNames = scene.perso.split(/[,;]/).map(n => n.trim().toUpperCase());
                
                characterNames.forEach(charName => {
                    // Chercher par personnage li√©
                    const character = state.data.characters?.find(c => c.name.toUpperCase() === charName);
                    if(character && character.actor_id) {
                        addActorToCallSheet(character.actor_id);
                    }
                    
                    // Chercher aussi par nom d'acteur directement
                    const actor = state.data.actors?.find(a => a.name.toUpperCase() === charName);
                    if(actor) {
                        addActorToCallSheet(actor.id);
                    }
                });
            }
            
            // 2. Chercher via le d√©pouillement cat√©gorie COMEDIENS
            if(scene.breakdown && scene.breakdown['COMEDIENS']) {
                scene.breakdown['COMEDIENS'].forEach(actorName => {
                    const actor = state.data.actors?.find(a => a.name.toUpperCase() === actorName.toUpperCase());
                    if(actor) {
                        addActorToCallSheet(actor.id);
                    }
                });
            }
            
            // 3. Chercher via le d√©pouillement cat√©gorie PERSONNAGES (si li√©s √† des acteurs)
            if(scene.breakdown && scene.breakdown['PERSONNAGES']) {
                scene.breakdown['PERSONNAGES'].forEach(charName => {
                    const character = state.data.characters?.find(c => c.name.toUpperCase() === charName.toUpperCase());
                    if(character && character.actor_id) {
                        addActorToCallSheet(character.actor_id);
                    }
                });
            }
        });
    },
    
    // Auto-cocher les techniciens selon le d√©pouillement des sc√®nes
    autoSelectCrewForBreakdown: () => {
        if(!Planning.tempShootDay || !Planning.tempShootDay.scenes) return;
        if(!Planning.tempShootDay.callSheet) Planning.tempShootDay.callSheet = [];
        
        // Collecter tous les noms de techniciens dans la cat√©gorie TECHNICIENS du d√©pouillement
        const neededCrewNames = new Set();
        
        Planning.tempShootDay.scenes.forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
            if(scene && scene.breakdown && scene.breakdown['TECHNICIENS']) {
                scene.breakdown['TECHNICIENS'].forEach(name => {
                    neededCrewNames.add(name.toUpperCase());
                });
            }
        });
        
        // Cocher les techniciens dont le nom est dans la liste ET les ajouter au callSheet
        state.data.crew.forEach(member => {
            if(neededCrewNames.has(member.name.toUpperCase())) {
                // Cocher la checkbox
                const crewCheckbox = document.getElementById(`call-crew-${member.id}`);
                if(crewCheckbox && !crewCheckbox.checked) {
                    crewCheckbox.checked = true;
                }
                
                // Ajouter au callSheet si pas d√©j√† pr√©sent
                const alreadyInCallSheet = Planning.tempShootDay.callSheet.some(
                    c => c.personId === member.id && c.type === 'crew'
                );
                if(!alreadyInCallSheet) {
                    Planning.tempShootDay.callSheet.push({
                        type: 'crew',
                        personId: member.id,
                        callTime: '',
                        notes: ''
                    });
                }
            }
        });
    },
    
    refreshScenesList: () => {
        const container = document.getElementById('selected-scenes-list');
        const dropdown = document.getElementById('scene-dropdown');
        
        if(!Planning.tempShootDay || Planning.tempShootDay.scenes.length === 0) {
            container.innerHTML = '<div style="color: var(--text-sec); font-style: italic; padding: 15px; text-align: center;">Aucune sc√®ne s√©lectionn√©e</div>';
        } else {
            let html = '';
            Planning.tempShootDay.scenes.forEach(sceneRef => {
                const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
                if(scene) {
                    const sceneIdx = state.data.scenes.indexOf(scene) + 1;
                    const sceneShots = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id) : [];
                    const shotCount = sceneShots.length;
                    const selectedShots = sceneRef.selectedShots || [];
                    const selectedCount = selectedShots.length;
                    const shotBadge = shotCount > 0 
                        ? `<span style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">üì∑ ${selectedCount}/${shotCount} plan${shotCount > 1 ? 's' : ''}</span>` 
                        : '<span style="background: var(--border); color: var(--text-sec); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px;">üì∑ 0</span>';
                    
                    let shotsHTML = '';
                    if(sceneShots.length > 0) {
                        shotsHTML = `<div class="scene-shots-list" style="margin-top: 8px; padding: 8px; background: var(--panel-bg); border-radius: 4px;">
                            <div style="font-size: 0.8rem; color: var(--text-sec); margin-bottom: 5px;">üì∑ Plans √† tourner :</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${sceneShots.map(shot => {
                                    const isSelected = selectedShots.includes(shot.id);
                                    return `<label style="display: flex; align-items: center; gap: 3px; padding: 3px 8px; background: ${isSelected ? 'var(--primary)' : 'var(--bg)'}; color: ${isSelected ? 'white' : 'var(--text-main)'}; border-radius: 4px; cursor: pointer; font-size: 0.8rem; border: 1px solid var(--border);">
                                        <input type="checkbox" data-scene-id="${scene.id}" data-shot-id="${shot.id}" ${isSelected ? 'checked' : ''} onchange="app.Planning.toggleShotSelection('${scene.id}', '${shot.id}')" style="display: none;">
                                        ${Utils.escape(shot.shotNumber || shot.name || 'Plan ' + shot.id)}
                                    </label>`;
                                }).join('')}
                            </div>
                            <div style="margin-top: 5px;">
                                <button onclick="app.Planning.selectAllShots('${scene.id}')" style="font-size: 0.75rem; padding: 2px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 3px; cursor: pointer; margin-right: 5px;">Tout</button>
                                <button onclick="app.Planning.deselectAllShots('${scene.id}')" style="font-size: 0.75rem; padding: 2px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 3px; cursor: pointer;">Aucun</button>
                            </div>
                        </div>`;
                    }
                    
                    html += `<div class="selected-scene-item" style="margin-bottom: 10px; padding: 10px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="time" id="scene-time-${scene.id}" value="${sceneRef.startTime || ''}" style="width: 90px;">
                            <span style="flex: 1; font-weight: bold;">#${sceneIdx} - ${Utils.escape(scene.title)}${shotBadge}</span>
                            <span style="color: var(--text-sec); font-size: 0.85rem;">${Utils.escape(scene.perso || '')}</span>
                            <button onclick="app.Planning.removeSceneFromDay('${scene.id}')" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚úñ</button>
                        </div>
                        ${shotsHTML}
                    </div>`;
                }
            });
            container.innerHTML = html;
        }
        
        // Refresh dropdown
        let options = '<option value="">-- S√©lectionner une sc√®ne --</option>';
        state.data.scenes.forEach((scene, idx) => {
            const alreadySelected = Planning.tempShootDay && Planning.tempShootDay.scenes.some(ref => ref.sceneId === scene.id || String(ref.sceneId) === String(scene.id));
            if(!alreadySelected) {
                const shotCount = state.data.shots ? state.data.shots.filter(s => s.sceneId === scene.id).length : 0;
const shotLabel = shotCount > 0 ? ` üì∑${shotCount}` : '';
options += `<option value="${scene.id}">#${idx + 1} - ${Utils.escape(scene.title)}${shotLabel}</option>`;
            }
        });
        dropdown.innerHTML = options;
        
        // Auto-fill breakdown needs
        Planning.updateBreakdownNeeds();
    },
    
    updateBreakdownNeeds: () => {
        const container = document.getElementById('auto-breakdown-needs');
        if(!container) return;
        
        if(!Planning.tempShootDay || Planning.tempShootDay.scenes.length === 0) {
            container.innerHTML = '<em style="color: var(--text-sec);">S√©lectionnez des sc√®nes pour voir les besoins...</em>';
            return;
        }
        
        // Collecter tous les besoins des sc√®nes s√©lectionn√©es
        const allNeeds = {};
        
        Planning.tempShootDay.scenes.forEach(sceneRef => {
            const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId || String(s.id) === String(sceneRef.sceneId));
            if(scene && scene.breakdown) {
                Object.keys(scene.breakdown).forEach(category => {
                    if(!allNeeds[category]) {
                        allNeeds[category] = new Set();
                    }
                    scene.breakdown[category].forEach(item => {
                        allNeeds[category].add(item);
                    });
                });
            }
        });
        
        // Afficher les besoins
        if(Object.keys(allNeeds).length === 0) {
            container.innerHTML = '<em style="color: var(--text-sec);">Aucun d√©pouillement pour ces sc√®nes. Allez dans l\'onglet D√©pouillement pour ajouter des √©l√©ments.</em>';
            return;
        }
        
        // Trouver les techniciens responsables par cat√©gorie
        const getResponsiblesForCategory = (category) => {
            const responsibles = [];
            const crewGroups = state.data.groups.filter(g => g.type === 'crew');
            
            // Chercher quel groupe g√®re cette cat√©gorie
            Object.keys(CONFIG.crewToBreakdownMap).forEach(groupId => {
                if(CONFIG.crewToBreakdownMap[groupId].includes(category)) {
                    // Trouver les techniciens de ce groupe
                    const members = state.data.crew.filter(c => c.group_id === groupId);
                    members.forEach(m => responsibles.push(m.name));
                }
            });
            
            return responsibles;
        };
        
        let html = '';
        
        // Fonction pour obtenir le com√©dien li√© √† un personnage
        const getActorForCharacter = (charName) => {
            const character = state.data.characters?.find(c => c.name.toUpperCase() === charName.toUpperCase());
            if(character && character.actor_id) {
                const actor = state.data.actors?.find(a => a.id === character.actor_id);
                return actor ? actor.name : null;
            }
            return null;
        };
        
        // Ordre personnalis√© des cat√©gories (PERSONNAGES en premier)
        const categoryOrder = ['PERSONNAGES', 'COMEDIENS', 'TECHNICIENS', 'COSTUMES', 'MAQUILLAGE-COIFFURE', 'ACCESSOIRES', 'DECORS-LIEUX', 'VEHICULES', 'FIGURATION', 'ANIMAUX', 'SON-MUSIQUE', 'EFFETS SPECIAUX (SFX)', 'EFFETS VISUELS (VFX)', 'LUMIERE', 'MACHINERIE', 'LOGISTIQUE'];
        
        const sortedCategories = Object.keys(allNeeds).sort((a, b) => {
            const idxA = categoryOrder.indexOf(a);
            const idxB = categoryOrder.indexOf(b);
            return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
        });
        
        sortedCategories.forEach(category => {
            if(allNeeds[category].size > 0) {
                const items = Array.from(allNeeds[category]);
                const responsibles = getResponsiblesForCategory(category);
                const responsiblesStr = responsibles.length > 0 
                    ? `<span style="color: var(--text-sec); font-size: 0.8rem; margin-left: 10px;">(${responsibles.join(', ')})</span>` 
                    : '';
                
                // Affichage sp√©cial pour PERSONNAGES : montrer personnage / com√©dien
                let itemsHtml = '';
                if(category === 'PERSONNAGES') {
                    itemsHtml = items.map(charName => {
                        const actorName = getActorForCharacter(charName);
                        if(actorName) {
                            return `<span style="background: var(--panel-bg); border: 1px solid var(--border); padding: 3px 8px; border-radius: 4px; font-size: 0.85rem;">
                                <strong>${Utils.escape(charName)}</strong> <span style="color: var(--text-sec);">/</span> <span style="color: var(--primary);">${Utils.escape(actorName)}</span>
                            </span>`;
                        } else {
                            return `<span style="background: var(--panel-bg); border: 1px solid var(--border); padding: 3px 8px; border-radius: 4px; font-size: 0.85rem;">
                                ${Utils.escape(charName)} <span style="color: var(--warning); font-size: 0.75rem;">‚ö†Ô∏è Non cast√©</span>
                            </span>`;
                        }
                    }).join('');
                } else if(category === 'COMEDIENS') {
                    // Ne pas afficher COMEDIENS s√©par√©ment si d√©j√† affich√© avec PERSONNAGES
                    // Sauf si le com√©dien n'est pas li√© √† un personnage
                    const actorsAlreadyShown = new Set();
                    if(allNeeds['PERSONNAGES']) {
                        allNeeds['PERSONNAGES'].forEach(charName => {
                            const actorName = getActorForCharacter(charName);
                            if(actorName) actorsAlreadyShown.add(actorName.toUpperCase());
                        });
                    }
                    const actorsNotLinked = items.filter(name => !actorsAlreadyShown.has(name.toUpperCase()));
                    if(actorsNotLinked.length === 0) return; // Skip si tous les com√©diens sont d√©j√† affich√©s
                    itemsHtml = actorsNotLinked.map(item => `<span style="background: var(--panel-bg); border: 1px solid var(--border); padding: 3px 8px; border-radius: 4px; font-size: 0.85rem;">${Utils.escape(item)}</span>`).join('');
                } else {
                    itemsHtml = items.map(item => `<span style="background: var(--panel-bg); border: 1px solid var(--border); padding: 3px 8px; border-radius: 4px; font-size: 0.85rem;">${Utils.escape(item)}</span>`).join('');
                }
                
                if(itemsHtml) {
                    html += `<div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary); font-size: 0.85rem;">${category}</strong>${responsiblesStr}
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                            ${itemsHtml}
                        </div>
                    </div>`;
                }
            }
        });
        
        container.innerHTML = html;
    },
	
	onLocationSelect: (value) => {
        const locationInput = document.getElementById('edit-location');
        const addressInput = document.getElementById('edit-locationAddress');
        
        if(value === '__custom__') {
            locationInput.value = '';
            locationInput.focus();
            return;
        }
        
        if(value) {
            // Le champ edit-location contient maintenant le nom r√©el, pas le d√©cor
            const loc = state.data.locations.find(l => l.name === value);
            locationInput.value = loc?.realName || '';
            
            // Auto-remplir depuis la fiche d√©cor si disponible
            if(loc) {
                if(loc.address && !document.getElementById('edit-locationAddress').value) {
                    document.getElementById('edit-locationAddress').value = loc.address;
                }
                if(loc.contactName && !document.getElementById('edit-contactName').value) {
                    document.getElementById('edit-contactName').value = loc.contactName;
                }
                if(loc.contactPhone && !document.getElementById('edit-contactPhone').value) {
                    document.getElementById('edit-contactPhone').value = loc.contactPhone;
                }
                if(loc.accessNotes && !document.getElementById('edit-locationNotes').value) {
                    document.getElementById('edit-locationNotes').value = loc.accessNotes;
                }
                if(loc.lat && loc.lng) {
                    document.getElementById('edit-locationLat').value = loc.lat;
                    document.getElementById('edit-locationLng').value = loc.lng;
                    Planning.showMiniMap(loc.lat, loc.lng);
                }
            }
            if(loc && loc.desc) {
                addressInput.value = loc.desc;
            }
        }
    },
	
    loadWeather: async (shootDay) => {
        const weatherEl = document.getElementById(`weather-${shootDay.id}`);
        if(!weatherEl) return;
        
        // Use cached weather if available
        if(Planning.weatherCache[shootDay.date]) {
            Planning.displayWeather(weatherEl, Planning.weatherCache[shootDay.date], shootDay);
            return;
        }
        
        try {
            // Using Open-Meteo API (free, no key required)
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=48.8566&longitude=2.3522&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode&timezone=Europe/Paris&start_date=${shootDay.date}&end_date=${shootDay.date}`);
            const data = await response.json();
            
            if(data.daily) {
                const weather = {
                    tempMax: Math.round(data.daily.temperature_2m_max[0]),
                    tempMin: Math.round(data.daily.temperature_2m_min[0]),
                    precipitation: data.daily.precipitation_probability_max[0],
                    code: data.daily.weathercode[0]
                };
                
                Planning.weatherCache[shootDay.date] = weather;
                Planning.displayWeather(weatherEl, weather, shootDay);
            }
        } catch(err) {
            console.error('Weather error:', err);
            weatherEl.innerHTML = `
                <div class="weather-icon">‚ùì</div>
                <div class="weather-info">
                    <div class="weather-temp">--¬∞C</div>
                    <div class="weather-desc">M√©t√©o indisponible</div>
                </div>
            `;
        }
    },
    
	selectedAvailability: { actors: [], crew: [] },
    
    renderAvailabilitySelectors: () => {
        Planning.renderAvailabilityTags('actors');
        Planning.renderAvailabilityTags('crew');
        
        // Ajouter les event listeners pour focus/blur
        const actorsSearch = document.getElementById('planning-actors-search');
        const crewSearch = document.getElementById('planning-crew-search');
        
        if(actorsSearch && !actorsSearch.dataset.init) {
            actorsSearch.dataset.init = 'true';
            actorsSearch.addEventListener('focus', () => Planning.showDropdown('actors'));
            actorsSearch.addEventListener('blur', () => setTimeout(() => Planning.hideDropdown('actors'), 200));
        }
        if(crewSearch && !crewSearch.dataset.init) {
            crewSearch.dataset.init = 'true';
            crewSearch.addEventListener('focus', () => Planning.showDropdown('crew'));
            crewSearch.addEventListener('blur', () => setTimeout(() => Planning.hideDropdown('crew'), 200));
        }
    },
    
    renderAvailabilityTags: (type) => {
        const tagsContainer = document.getElementById(`planning-${type}-tags`);
        if(!tagsContainer) return;
        
        const selectedIds = type === 'actors' ? Planning.selectedAvailability.actors : Planning.selectedAvailability.crew;
        const dataArray = type === 'actors' ? state.data.actors : state.data.crew;
        
        if(selectedIds.length === 0) {
            tagsContainer.innerHTML = '<span style="color: var(--text-sec); font-size: 0.85rem;">Aucune s√©lection</span>';
            return;
        }
        
        let html = '';
        selectedIds.forEach(id => {
            const person = dataArray?.find(p => p.id === id);
            if(person) {
                if(!person.color) person.color = CONFIG.availabilityColors[dataArray.indexOf(person) % CONFIG.availabilityColors.length];
                html += `<span style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: linear-gradient(135deg, ${person.color}22, ${person.color}11); border: 1px solid ${person.color}; border-radius: 20px; font-size: 0.85rem;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: ${person.color};"></span>
                    ${Utils.escape(person.name)}
                    <button onclick="app.Planning.toggleAvailabilityPerson('${type === 'actors' ? 'actor' : 'crew'}', '${id}')" style="background: none; border: none; cursor: pointer; padding: 0; margin-left: 2px; color: var(--text-sec); font-size: 1rem; line-height: 1;">&times;</button>
                </span>`;
            }
        });
        tagsContainer.innerHTML = html;
    },
    
    showDropdown: (type) => {
        const dropdown = document.getElementById(`planning-${type}-dropdown`);
        if(dropdown) {
            dropdown.style.display = 'block';
            Planning.filterAvailabilityList(type);
        }
    },
    
    hideDropdown: (type) => {
        const dropdown = document.getElementById(`planning-${type}-dropdown`);
        if(dropdown) dropdown.style.display = 'none';
    },
    
    filterAvailabilityList: (type) => {
        const searchInput = document.getElementById(`planning-${type}-search`);
        const dropdown = document.getElementById(`planning-${type}-dropdown`);
        if(!searchInput || !dropdown) return;
        
        const query = searchInput.value.toLowerCase().trim();
        const dataArray = type === 'actors' ? state.data.actors : state.data.crew;
        const selectedIds = type === 'actors' ? Planning.selectedAvailability.actors : Planning.selectedAvailability.crew;
        
        if(!dataArray || dataArray.length === 0) {
            dropdown.innerHTML = '<div style="padding: 10px; color: var(--text-sec); text-align: center;">Aucun ' + (type === 'actors' ? 'com√©dien' : 'technicien') + '</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        const filtered = dataArray.filter(person => {
            const matchesQuery = !query || person.name.toLowerCase().includes(query);
            const notSelected = !selectedIds.includes(person.id);
            return matchesQuery && notSelected;
        });
        
        if(filtered.length === 0) {
            dropdown.innerHTML = '<div style="padding: 10px; color: var(--text-sec); text-align: center;">' + (query ? 'Aucun r√©sultat' : 'Tous s√©lectionn√©s') + '</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        let html = '';
        filtered.forEach((person, idx) => {
            if(!person.color) person.color = CONFIG.availabilityColors[dataArray.indexOf(person) % CONFIG.availabilityColors.length];
            const role = type === 'actors' ? '' : (person.role ? ` - ${person.role}` : '');
            html += `<div onclick="app.Planning.selectFromDropdown('${type}', '${person.id}')" 
                         style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s;"
                         onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
                <span style="width: 10px; height: 10px; border-radius: 50%; background: ${person.color};"></span>
                <span style="flex: 1;">${Utils.escape(person.name)}${role}</span>
                <span style="color: var(--text-sec); font-size: 0.8rem;">+ Ajouter</span>
            </div>`;
        });
        dropdown.innerHTML = html;
        dropdown.style.display = 'block';
    },
    
    selectFromDropdown: (type, id) => {
        const personType = type === 'actors' ? 'actor' : 'crew';
        Planning.toggleAvailabilityPerson(personType, id);
        
        // Vider la recherche et mettre √† jour
        const searchInput = document.getElementById(`planning-${type}-search`);
        if(searchInput) searchInput.value = '';
        Planning.filterAvailabilityList(type);
    },
    
    toggleAvailabilityPerson: (type, id) => {
        const list = type === 'actor' ? Planning.selectedAvailability.actors : Planning.selectedAvailability.crew;
        const idx = list.indexOf(id);
        if(idx > -1) {
            list.splice(idx, 1);
        } else {
            list.push(id);
        }
        Planning.renderAvailabilitySelectors();
        Planning.render();
    },
    
    getAvailabilityBarsForDate: (dateStr) => {
        let bars = [];
        
        // V√©rifier les acteurs s√©lectionn√©s
        Planning.selectedAvailability.actors.forEach(actorId => {
            const actor = state.data.actors.find(a => a.id === actorId);
            if(actor && actor.availabilityDates) {
                const isAvailable = actor.availabilityDates.some(range => {
                    const from = new Date(range.from);
                    const to = new Date(range.to);
                    const check = new Date(dateStr);
                    return check >= from && check <= to;
                });
                if(isAvailable) {
                    bars.push({ name: actor.name, color: actor.color, type: 'actor', hasVehicle: actor.hasVehicle, vehicleSeats: actor.vehicleSeats, vehicleTrunk: actor.vehicleTrunk });
                }
            }
        });
        
        // V√©rifier les techniciens s√©lectionn√©s
        Planning.selectedAvailability.crew.forEach(crewId => {
            const member = state.data.crew.find(c => c.id === crewId);
            if(member && member.availabilityDates) {
                const isAvailable = member.availabilityDates.some(range => {
                    const from = new Date(range.from);
                    const to = new Date(range.to);
                    const check = new Date(dateStr);
                    return check >= from && check <= to;
                });
                if(isAvailable) {
                    bars.push({ name: member.name, color: member.color, type: 'crew', hasVehicle: member.hasVehicle, vehicleSeats: member.vehicleSeats, vehicleTrunk: member.vehicleTrunk });
                }
            }
        });
        
        return bars;
    },
	
	openCallSheets: () => {
        const modal = document.getElementById('callsheets-modal');
        const list = document.getElementById('callsheets-list');
        
        if(!state.data.shootingDays || state.data.shootingDays.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);"><p>Aucun jour de tournage planifi√©.</p><p>Cr√©ez un jour de tournage depuis le calendrier.</p></div>';
        } else {
            // Trier par date
            const sortedDays = [...state.data.shootingDays].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let html = '<div style="display:flex; flex-direction:column; gap:15px;">';
            
            sortedDays.forEach(day => {
                const startDate = day.startDate || day.date;
                const endDate = day.endDate || startDate;
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                const dateFormatted = startDate === endDate 
                    ? startDateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })
                    : startDateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) + ' ‚Üí ' + endDateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
                const isPast = endDateObj < new Date();
                const isToday = Planning.formatDate(startDateObj) === Planning.formatDate(new Date()) || Planning.formatDate(endDateObj) === Planning.formatDate(new Date());
                const status = day.validated ? '‚úÖ Valid√©e' : (isPast ? '‚ö†Ô∏è Pass√©e' : (isToday ? 'üé¨ Aujourd\'hui' : 'üìù En pr√©paration'));
                const statusColor = day.validated ? 'var(--success)' : (isPast ? 'var(--danger)' : (isToday ? 'var(--primary)' : 'var(--text-sec)'));
                
                html += `<div style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; font-size:1.1rem;">${Utils.escape(day.name || 'Tournage')} - ${dateFormatted}</div>
                        <div style="color:var(--text-sec); font-size:0.9rem; margin-top:5px;">
                            üìç ${day.location || 'Lieu non d√©fini'} ‚Ä¢ 
                            üé¨ ${day.scenes?.length || 0} sc√®ne(s) ‚Ä¢ 
                            üë• ${day.callSheet?.length || 0} convoqu√©(s)
                        </div>
                        <div style="margin-top:8px; font-size:0.85rem; color:${statusColor}; font-weight:500;">${status}</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button onclick="app.Planning.editShootDay('${day.id}')" style="padding:8px 15px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">‚úèÔ∏è Modifier</button>
                        <button onclick="app.Planning.printCallSheet('${day.id}')" style="padding:8px 15px; background:var(--panel-bg); border:1px solid var(--border); border-radius:6px; cursor:pointer;">üñ®Ô∏è Imprimer</button>
                        <button onclick="app.Planning.sendCallSheet('${day.id}')" style="padding:8px 15px; background:var(--warning, #FF9800); color:white; border:none; border-radius:6px; cursor:pointer;">üìß Envoyer</button>
                        <button onclick="app.Planning.validateCallSheet('${day.id}')" style="padding:8px 15px; background:${day.validated ? 'var(--text-sec)' : 'var(--success)'}; color:white; border:none; border-radius:6px; cursor:pointer;">${day.validated ? 'üîì D√©-valider' : '‚úÖ Valider'}</button>
                        <button onclick="app.Planning.deleteShootDayFromList('${day.id}')" style="padding:8px 15px; background:var(--danger); color:white; border:none; border-radius:6px; cursor:pointer;">üóëÔ∏è Supprimer</button>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            list.innerHTML = html;
        }
        
        modal.style.display = 'flex';
    },
    
    closeCallSheets: () => {
        document.getElementById('callsheets-modal').style.display = 'none';
    },
    
    validateCallSheet: (dayId) => {
        const day = state.data.shootingDays.find(d => d.id === dayId);
        if(!day) return;
        
        day.validated = !day.validated;
        Store.save();
        Planning.openCallSheets(); // Rafra√Æchir la liste
    },
    
    publishCallSheet: async (shootDay) => {
        // G√©n√©rer un token unique pour cette feuille
        const token = 'fds_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);
        
        const projectName = state.data.title || 'Projet';
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        
        // Construire les donn√©es des sc√®nes
        const scenesData = (shootDay.scenes || []).map(ref => {
            const scene = state.data.scenes.find(s => s.id === ref.sceneId);
            return scene ? {
                startTime: ref.startTime || '--:--',
                title: scene.title || 'Sc√®ne sans titre',
                perso: scene.perso || '',
                decor: scene.decor || '',
                time: scene.time || ''
            } : null;
        }).filter(s => s);
        
        // Construire les donn√©es des convoqu√©s
        const callSheetData = (shootDay.callSheet || []).map(call => {
            let person = null;
            if(call.type === 'actor') {
                person = state.data.actors.find(a => a.id === call.personId);
            } else if(call.type === 'crew') {
                person = state.data.crew.find(c => c.id === call.personId);
            }
            return person ? {
                name: person.name || 'Inconnu',
                role: person.role || person.department || (call.type === 'actor' ? 'Com√©dien¬∑ne' : 'Technicien¬∑ne'),
                callTime: call.callTime || shootDay.crewCall || '',
                notes: call.notes || ''
            } : null;
        }).filter(c => c);
        
        // Donn√©es publiques de la feuille de service
        const publicData = {
            token: token,
            projectName: projectName,
            dayNumber: shootDay.dayNumber,
            date: shootDay.date,
            dateFormatted: dateFormatted,
            location: shootDay.location || '',
            locationAddress: shootDay.locationAddress || '',
            contactName: shootDay.contactName || '',
            contactPhone: shootDay.contactPhone || '',
            locationNotes: shootDay.locationNotes || '',
            crewCall: shootDay.crewCall || '',
            readyToShoot: shootDay.readyToShoot || '',
            lunchStart: shootDay.lunchStart || '',
            lunchEnd: shootDay.lunchEnd || '',
            estimatedWrap: shootDay.estimatedWrap || '',
            notes: shootDay.notes || '',
            customWeather: shootDay.customWeather || '',
            scenes: scenesData,
            callSheet: callSheetData,
            createdAt: Date.now(),
            createdBy: state.currentUser?.email || ''
        };
        
        // Sauvegarder dans Firebase (public)
        try {
            await firebase.database().ref('public_callsheets/' + token).set(publicData);
            console.log('‚úÖ Feuille de service publi√©e:', token);
            return token;
        } catch(e) {
            console.error('‚ùå Erreur publication feuille:', e);
            return null;
        }
    },
    
    loadPublicCallSheet: async (token) => {
        try {
            const snap = await firebase.database().ref('public_callsheets/' + token).once('value');
            const data = snap.val();
            if(!data) {
                document.getElementById('public-callsheet-content').innerHTML = '<p style="text-align:center; color:#c00;">‚ùå Feuille de service introuvable ou expir√©e.</p>';
                return;
            }
            
            // G√©n√©rer le HTML de la feuille
            let html = `
                <div style="text-align:center; border-bottom:3px solid #333; padding-bottom:20px; margin-bottom:20px;">
                    <h2 style="margin:0; font-size:1.8rem;">${Utils.escape(data.projectName)}</h2>
                    <p style="font-size:1.3rem; margin:10px 0;">FEUILLE DE SERVICE - JOUR ${data.dayNumber}</p>
                    <p style="font-size:1.1rem; color:#666;">${Utils.escape(data.dateFormatted)}</p>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div style="background:#f5f5f5; padding:15px; border-radius:8px;">
                        <h3 style="margin:0 0 10px; color:#333;">üìç Lieu</h3>
                        <p style="margin:0; font-size:1.1rem; font-weight:bold;">${Utils.escape(data.location) || '√Ä confirmer'}</p>
                        ${data.locationAddress ? `<p style="margin:5px 0 0; color:#666;">${Utils.escape(data.locationAddress)}</p>` : ''}
                        ${data.contactName || data.contactPhone ? `<p style="margin:10px 0 0; padding-top:10px; border-top:1px solid #ddd;"><strong>üë§ Contact sur place:</strong> ${Utils.escape(data.contactName) || ''} ${data.contactPhone ? 'üìû ' + Utils.escape(data.contactPhone) : ''}</p>` : ''}
                        ${data.locationNotes ? `<p style="margin:5px 0 0; color:#666; font-style:italic;">üìù ${Utils.escape(data.locationNotes)}</p>` : ''}
                    </div>
                    <div style="background:#f5f5f5; padding:15px; border-radius:8px;">
                        <h3 style="margin:0 0 10px; color:#333;">‚è∞ Horaires</h3>
                        <p style="margin:0;"><strong>Convocation √©quipe:</strong> ${Utils.escape(data.crewCall) || '√Ä confirmer'}</p>
                        <p style="margin:5px 0;"><strong>Pr√™t √† tourner:</strong> ${Utils.escape(data.readyToShoot) || '√Ä confirmer'}</p>
                        <p style="margin:5px 0;"><strong>Repas:</strong> ${Utils.escape(data.lunchStart) || '?'} - ${Utils.escape(data.lunchEnd) || '?'}</p>
                        <p style="margin:5px 0 0;"><strong>Fin estim√©e:</strong> ${Utils.escape(data.estimatedWrap) || '√Ä confirmer'}</p>
                    </div>
                </div>`;
            
            // Sc√®nes
            if(data.scenes && data.scenes.length > 0) {
                html += `
                    <div style="margin-bottom:20px;">
                        <h3 style="background:#333; color:white; padding:10px; margin:0;">üé¨ Sc√®nes Pr√©vues</h3>
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th style="padding:10px; border:1px solid #ddd; text-align:left;">Heure</th>
                                    <th style="padding:10px; border:1px solid #ddd; text-align:left;">Sc√®ne</th>
                                    <th style="padding:10px; border:1px solid #ddd; text-align:left;">Personnages</th>
                                    <th style="padding:10px; border:1px solid #ddd; text-align:left;">D√©cor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.scenes.map(s => `
                                    <tr>
                                        <td style="padding:10px; border:1px solid #ddd;">${Utils.escape(s.startTime)}</td>
                                        <td style="padding:10px; border:1px solid #ddd;">${Utils.escape(s.title)}</td>
                                        <td style="padding:10px; border:1px solid #ddd;">${Utils.escape(s.perso)}</td>
                                        <td style="padding:10px; border:1px solid #ddd;">${Utils.escape(s.decor)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }
            
            // √âquipe convoqu√©e
            if(data.callSheet && data.callSheet.length > 0) {
                html += `
                    <div style="margin-bottom:20px;">
                        <h3 style="background:#333; color:white; padding:10px; margin:0;">üë• √âquipe Convoqu√©e</h3>
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th style="padding:10px; border:1px solid #ddd; text-align:left;">Nom</th>
                                    <th style="padding:10px; border:1px solid #ddd; text-align:left;">Fonction</th>
                                    <th style="padding:10px; border:1px solid #ddd; text-align:left;">Convocation</th>
                                    <th style="padding:10px; border:1px solid #ddd; text-align:left;">Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.callSheet.map(c => `
                                    <tr>
                                        <td style="padding:10px; border:1px solid #ddd; font-weight:bold;">${Utils.escape(c.name)}</td>
                                        <td style="padding:10px; border:1px solid #ddd;">${Utils.escape(c.role)}</td>
                                        <td style="padding:10px; border:1px solid #ddd;">${Utils.escape(c.callTime)}</td>
                                        <td style="padding:10px; border:1px solid #ddd;">${Utils.escape(c.notes)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }
            
            // Notes
            if(data.notes) {
                html += `
                    <div style="background:#fff3cd; padding:15px; border-radius:8px; margin-bottom:20px;">
                        <h3 style="margin:0 0 10px; color:#856404;">üìã Notes</h3>
                        <p style="margin:0; white-space:pre-wrap;">${Utils.escape(data.notes)}</p>
                    </div>`;
            }
            
            if(data.customWeather) {
                html += `
                    <div style="background:#d1ecf1; padding:15px; border-radius:8px;">
                        <h3 style="margin:0 0 10px; color:#0c5460;">üå§Ô∏è M√©t√©o / Conditions</h3>
                        <p style="margin:0; white-space:pre-wrap;">${Utils.escape(data.customWeather)}</p>
                    </div>`;
            }
            
            document.getElementById('public-callsheet-content').innerHTML = html;
            document.getElementById('public-callsheet-modal').style.display = 'block';
            
        } catch(e) {
            console.error('Erreur chargement feuille publique:', e);
            document.getElementById('public-callsheet-content').innerHTML = '<p style="text-align:center; color:#c00;">‚ùå Erreur lors du chargement.</p>';
        }
    },
    
    sendCallSheet: async (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) {
            Utils.toast('Jour de tournage introuvable', 'error');
            return;
        }
        
        const projectName = state.data.title || 'Projet';
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'La production';
        const appUrl = 'https://moteur.film'; // URL de l'application
        
        // Construire la liste des sc√®nes
        let scenesText = '';
        if(shootDay.scenes && shootDay.scenes.length > 0) {
            scenesText = '\n\nüé¨ SC√àNES PR√âVUES :\n';
            shootDay.scenes.forEach(ref => {
                const scene = state.data.scenes.find(s => s.id === ref.sceneId);
                if(scene) {
                    scenesText += `‚Ä¢ ${ref.startTime || '--:--'} - ${scene.title || 'Sc√®ne sans titre'}`;
                    if(scene.perso) scenesText += ` (${scene.perso})`;
                    if(scene.decor) scenesText += ` - ${scene.decor}`;
                    scenesText += '\n';
                }
            });
        }
        
        // Collecter toutes les personnes √† notifier
        const recipients = [];
        
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            for(const call of shootDay.callSheet) {
                let person = null;
                
                if(call.type === 'actor') {
                    person = state.data.actors.find(a => a.id === call.personId);
                } else if(call.type === 'crew') {
                    person = state.data.crew.find(c => c.id === call.personId);
                }
                
                if(person && person.email) {
                    recipients.push({
                        name: person.name || 'Inconnu',
                        email: person.email,
                        callTime: call.callTime || shootDay.crewCall || '√Ä confirmer',
                        notes: call.notes || ''
                    });
                }
            }
        }
        
        if(recipients.length === 0) {
            Utils.toast('Aucune personne avec email dans cette feuille de service', 'warning');
            return;
        }
        
        if(!await ConfirmModal.show({ title: `Envoyer la feuille de service J${shootDay.dayNumber} ?`, message: `${recipients.length} destinataire(s) :\n\n${recipients.map(r => '‚Ä¢ ' + r.name).join('\n')}`, icon: 'üìß', confirmText: 'Envoyer' })) {
            return;
        }
        
        // Publier la feuille de service pour g√©n√©rer le lien
        Utils.toast('Publication de la feuille de service...', 'info');
        const token = await Planning.publishCallSheet(shootDay);
        if(!token) {
            Utils.toast('Erreur lors de la publication', 'error');
            return;
        }
        
        const publicLink = window.location.origin + window.location.pathname + '?callsheet=' + token;
        
        let sent = 0;
        let errors = 0;
        
        for(const recipient of recipients) {
            const subject = `üé¨ Feuille de Service J${shootDay.dayNumber} - ${projectName}`;
            const content = `Bonjour ${recipient.name},

Vous avez re√ßu une feuille de service pour le projet "${projectName}".

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìÖ JOUR ${shootDay.dayNumber} - ${dateFormatted.toUpperCase()}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç Lieu : ${shootDay.location || '√Ä confirmer'}${shootDay.locationAddress ? '\nüìå Adresse : ' + shootDay.locationAddress : ''}${shootDay.contactName || shootDay.contactPhone ? '\nüë§ Contact sur place : ' + (shootDay.contactName || '') + (shootDay.contactPhone ? ' üìû ' + shootDay.contactPhone : '') : ''}${shootDay.locationNotes ? '\nüìù Acc√®s : ' + shootDay.locationNotes : ''}

‚è∞ HORAIRES :
- Votre convocation : ${recipient.callTime}
- Pr√™t √† tourner : ${shootDay.readyToShoot || '√Ä confirmer'}
- Repas : ${shootDay.lunchStart || '?'} - ${shootDay.lunchEnd || '?'}
- Fin estim√©e : ${shootDay.estimatedWrap || '√Ä confirmer'}
${scenesText}${recipient.notes ? '\nüìù NOTES VOUS CONCERNANT :\n' + recipient.notes : ''}${shootDay.notes ? '\n\nüìã NOTES G√âN√âRALES :\n' + shootDay.notes : ''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîó VOIR LA FEUILLE DE SERVICE COMPL√àTE :
Cliquez sur le lien ci-dessous pour voir et imprimer votre feuille de service :

üëâ ${publicLink}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Merci de confirmer votre pr√©sence en r√©pondant √† ce message.

Cordialement,
${senderName}
${projectName}`;

            try {
                // Envoyer message interne
                await Messages.send(recipient.email, {
                    subject: subject,
                    content: content,
                    type: 'callsheet',
                    projectId: state.currentProjectId,
                    projectName: projectName,
                    shootDayId: shootDay.id,
                    date: shootDay.date
                });
                
                // Envoyer email avec lien public
                await Messages.sendEmailPing(recipient.email, recipient.name, 'callsheet', {
                    projectName: projectName,
                    shootDate: dateFormatted,
                    location: shootDay.location || '√Ä confirmer',
                    callTime: recipient.callTime,
                    senderName: senderName,
                    publicLink: publicLink
                });
                
                sent++;
                console.log(`‚úÖ Convocation envoy√©e √† ${recipient.name} (${recipient.email})`);
            } catch(e) {
                console.error(`‚ùå Erreur envoi √† ${recipient.name}:`, e);
                errors++;
            }
        }
        
        if(sent > 0) {
            Utils.toast(`‚úÖ ${sent} convocation(s) envoy√©e(s) !`, 'success');
        }
        if(errors > 0) {
            Utils.toast(`‚ö†Ô∏è ${errors} erreur(s) d'envoi`, 'warning');
        }
    },
    
    printCallSheet: (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const projectTitle = document.getElementById('projectTitle')?.value || 'Projet';
        
        let printContent = `
            <html>
            <head>
                <title>Feuille de Service - Jour ${shootDay.dayNumber}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                    h2 { color: #333; margin-top: 25px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
                    .info-item { padding: 8px; background: #f5f5f5; border-radius: 4px; }
                    .info-label { font-weight: bold; color: #666; }
                    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                    th { background: #f0f0f0; }
                    .scene-item { padding: 10px; margin: 5px 0; background: #f9f9f9; border-left: 3px solid #2b6ef6; }
                </style>
            </head>
            <body>
                <h1>üìã FEUILLE DE SERVICE</h1>
                <div style="text-align:center; margin-bottom:20px;">
                    <strong style="font-size:1.2rem;">${projectTitle}</strong><br>
                    <span>Jour ${shootDay.dayNumber} - ${dateFormatted}</span>
                </div>
                
                <h2>üìç Lieu de Tournage</h2>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Lieu:</span> ${shootDay.location || 'Non d√©fini'}</div>
                    <div class="info-item"><span class="info-label">Adresse:</span> ${shootDay.locationAddress || 'Non d√©finie'}</div>
                </div>
                
                <h2>‚è∞ Horaires</h2>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Convocation √©quipe:</span> ${shootDay.crewCall || '--:--'}</div>
                    <div class="info-item"><span class="info-label">Pr√™t √† tourner:</span> ${shootDay.readyToShoot || '--:--'}</div>
                    <div class="info-item"><span class="info-label">Pause d√©jeuner:</span> ${shootDay.lunchStart || '--:--'} - ${shootDay.lunchEnd || '--:--'}</div>
                    <div class="info-item"><span class="info-label">Fin estim√©e:</span> ${shootDay.estimatedWrap || '--:--'}</div>
                </div>
                
                <h2>üé¨ Sc√®nes √† Tourner</h2>`;
        
        if(shootDay.scenes && shootDay.scenes.length > 0) {
            shootDay.scenes.forEach(sceneRef => {
                const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId);
                if(scene) {
                    printContent += `<div class="scene-item">
                        <strong>${scene.title}</strong><br>
                        <span style="color:#666;">Personnages: ${scene.perso || 'N/A'}</span><br>
                        <span style="color:#666;">Heure pr√©vue: ${sceneRef.startTime || 'Non d√©finie'}</span>
                    </div>`;
                }
            });
        } else {
            printContent += '<p style="color:#999;">Aucune sc√®ne planifi√©e</p>';
        }
        
        printContent += '<h2>üë• Convocations</h2>';
        
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            printContent += `<table>
                <thead><tr><th>Nom</th><th>Fonction</th><th>Convocation</th><th>Notes</th></tr></thead>
                <tbody>`;
            
            shootDay.callSheet.forEach(call => {
                let person = null;
                let role = '';
                if(call.type === 'actor') {
                    person = state.data.actors.find(a => a.id === call.personId);
                    role = 'Com√©dien(ne)';
                } else {
                    person = state.data.crew.find(c => c.id === call.personId);
                    role = person?.role || 'Technicien';
                }
                if(person) {
                    printContent += `<tr>
                        <td>${person.name}</td>
                        <td>${role}</td>
                        <td>${call.callTime || '--:--'}</td>
                        <td>${call.notes || ''}</td>
                    </tr>`;
                }
            });
            
            printContent += '</tbody></table>';
        } else {
            printContent += '<p style="color:#999;">Aucune convocation</p>';
        }
        
        // Section "√Ä pr√©voir" bas√©e sur le d√©pouillement
        const scenesIds = (shootDay.scenes || []).map(ref => ref.sceneId);
        if(scenesIds.length > 0 && shootDay.callSheet && shootDay.callSheet.length > 0) {
            let breakdownByPerson = [];
            
            shootDay.callSheet.forEach(call => {
                if(call.type !== 'crew') return;
                
                const member = state.data.crew.find(c => c.id === call.personId);
                if(!member || !member.group_id) return;
                
                const items = Planning.getBreakdownItemsForPerson(member, scenesIds);
                if(items.length > 0) {
                    const groupInfo = state.data.groups.find(g => g.id === member.group_id);
                    breakdownByPerson.push({
                        name: member.name,
                        department: groupInfo ? groupInfo.name : 'Non class√©',
                        items: items
                    });
                }
            });
            
            if(breakdownByPerson.length > 0) {
                printContent += '<h2>üì¶ √Ä Pr√©voir par D√©partement</h2>';
                
                // Regrouper par d√©partement
                const byDepartment = {};
                breakdownByPerson.forEach(person => {
                    if(!byDepartment[person.department]) {
                        byDepartment[person.department] = { names: [], items: [] };
                    }
                    byDepartment[person.department].names.push(person.name);
                    person.items.forEach(item => {
                        // √âviter les doublons
                        const exists = byDepartment[person.department].items.some(
                            i => i.item === item.item && i.sceneNum === item.sceneNum
                        );
                        if(!exists) {
                            byDepartment[person.department].items.push(item);
                        }
                    });
                });
                
                // Afficher par d√©partement
                Object.keys(byDepartment).forEach(dept => {
                    const data = byDepartment[dept];
                    const namesStr = data.names.join(', ');
                    
                    printContent += `<div style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 6px; border-left: 3px solid #ff9800;">
                        <strong>${dept}</strong> <span style="color:#666;">(${namesStr})</span>
                        <ul style="margin: 10px 0 0 20px; padding: 0;">`;
                    
                    data.items.forEach(item => {
                        printContent += `<li>${item.item} <span style="color:#666;">(Sc.${item.sceneNum})</span></li>`;
                    });
                    
                    printContent += '</ul></div>';
                });
            }
        }
        
        if(shootDay.notes) {
            printContent += `<h2>üìù Notes</h2><p>${shootDay.notes}</p>`;
        }
        
        printContent += '</body></html>';
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    },
	
	sendCallSheetEmail: (dayId) => {
        const shootDay = state.data.shootingDays.find(sd => sd.id === dayId);
        if(!shootDay) return;
        
        // Collecter les emails des convoqu√©s
        const emails = [];
        
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            shootDay.callSheet.forEach(call => {
                let person = null;
                if(call.type === 'actor') {
                    person = state.data.actors.find(a => a.id === call.personId);
                } else if(call.type === 'crew') {
                    person = state.data.crew.find(c => c.id === call.personId);
                }
                if(person && person.email) {
                    emails.push(person.email);
                }
            });
        }
        
        // Construire le contenu de l'email
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        
        let body = `FEUILLE DE SERVICE - JOUR ${shootDay.dayNumber}%0D%0A`;
        body += `Date: ${dateFormatted}%0D%0A`;
        body += `Lieu: ${shootDay.location || 'Non d√©fini'}%0D%0A`;
        if(shootDay.locationAddress) body += `Adresse: ${shootDay.locationAddress}%0D%0A`;
        body += `%0D%0A`;
        body += `HORAIRES:%0D%0A`;
        body += `- Convocation √©quipe: ${shootDay.crewCall || '--:--'}%0D%0A`;
        body += `- Pr√™t √† tourner: ${shootDay.readyToShoot || '--:--'}%0D%0A`;
        body += `- Pause d√©jeuner: ${shootDay.lunchStart || '--:--'} - ${shootDay.lunchEnd || '--:--'}%0D%0A`;
        body += `- Fin estim√©e: ${shootDay.estimatedWrap || '--:--'}%0D%0A`;
        body += `%0D%0A`;
        
        if(shootDay.scenes && shootDay.scenes.length > 0) {
            body += `SCENES A TOURNER:%0D%0A`;
            shootDay.scenes.forEach(sceneRef => {
                const scene = state.data.scenes.find(s => s.id === sceneRef.sceneId);
                if(scene) {
                    body += `- ${scene.title}%0D%0A`;
                }
            });
            body += `%0D%0A`;
        }
        
        if(shootDay.notes) {
            body += `NOTES:%0D%0A${shootDay.notes}%0D%0A`;
        }
        
        const subject = `Feuille de service - Jour ${shootDay.dayNumber} - ${dateFormatted}`;
        const mailtoLink = `mailto:${emails.join(',')}?subject=${encodeURIComponent(subject)}&body=${body}`;
        
        if(emails.length === 0) {
            Utils.toast('Aucun email trouv√© parmi les personnes convoqu√©es. Ajoutez les emails dans les fiches Com√©diens et √âquipe.', 'warning');
        }
        
        window.open(mailtoLink, '_blank');
    },
	
    displayWeather: (el, weather, shootDay) => {
        const weatherIcons = {
            0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
            45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
            51: 'üåßÔ∏è', 53: 'üåßÔ∏è', 55: 'üåßÔ∏è',
            61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
            71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è',
            80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',
            95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
        };
        
        const weatherDesc = {
            0: 'Ciel d√©gag√©', 1: 'Principalement d√©gag√©', 2: 'Partiellement nuageux', 3: 'Couvert',
            45: 'Brouillard', 48: 'Brouillard givrant',
            51: 'Bruine l√©g√®re', 53: 'Bruine mod√©r√©e', 55: 'Bruine dense',
            61: 'Pluie l√©g√®re', 63: 'Pluie mod√©r√©e', 65: 'Pluie forte',
            71: 'Neige l√©g√®re', 73: 'Neige mod√©r√©e', 75: 'Neige forte',
            80: 'Averses l√©g√®res', 81: 'Averses mod√©r√©es', 82: 'Averses violentes',
            95: 'Orage', 96: 'Orage avec gr√™le l√©g√®re', 99: 'Orage avec gr√™le forte'
        };
        
        const icon = weatherIcons[weather.code] || 'üå§Ô∏è';
        const desc = weatherDesc[weather.code] || 'Temps variable';
        
        let customNote = '';
        if(shootDay.customWeather) {
            customNote = `<div style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 0.85rem;">üìù ${Utils.escape(shootDay.customWeather)}</div>`;
        }
        
        el.innerHTML = `
            <div class="weather-icon">${icon}</div>
            <div class="weather-info">
                <div class="weather-temp">${weather.tempMin}¬∞C - ${weather.tempMax}¬∞C</div>
                <div class="weather-desc">${desc}</div>
                <div class="weather-details">Probabilit√© de pluie: ${weather.precipitation}%</div>
            </div>
            ${customNote}
        `;
    },
    
    generateFDS: () => {
        // If editing, save first
        Planning.saveShootDay();
        
        // Trouver le jour sauvegard√© par son ID
        const savedDay = state.data.shootingDays.find(sd => sd.id === Planning.editingDayId) 
            || state.data.shootingDays.find(sd => sd.startDate === document.getElementById('edit-startDate').value);
        if(!savedDay) {
            Utils.toast('Jour de tournage non trouv√©', 'error');
            return;
        }
        
        Planning.showFDS(savedDay);
    },
    
    showFDS: async (shootDay) => {
        Planning.currentFDSDay = shootDay;
        
        const modal = document.getElementById('fds-modal');
        const content = document.getElementById('fdsContent');
        
        // Utiliser startDate au lieu de date
        const shootDate = shootDay.startDate || shootDay.date;
        const dateObj = new Date(shootDate);
        const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        
        // Afficher chargement
        content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner dark"></div><p>Chargement m√©t√©o...</p></div>';
        modal.classList.add('active');
        
        // R√©cup√©rer m√©t√©o si coordonn√©es disponibles
        let weatherHTML = '';
        if(shootDay.locationLat && shootDay.locationLng && shootDate) {
            const weather = await Weather.fetch(parseFloat(shootDay.locationLat), parseFloat(shootDay.locationLng), shootDate);
            weatherHTML = Weather.renderCard(weather);
        } else if(!shootDay.locationLat || !shootDay.locationLng) {
            weatherHTML = '<p style="color: var(--text-sec); font-style: italic;">üìç Renseignez une adresse avec GPS pour voir la m√©t√©o</p>';
        }
        
        // Programme du jour avec sc√®nes ET plans s√©lectionn√©s
        let scenesHTML = '';
        (shootDay.scenes || []).forEach(ref => {
            const scene = state.data.scenes.find(s => s.id === ref.sceneId);
            if(scene) {
                const sceneIndex = state.data.scenes.findIndex(s => s.id === ref.sceneId) + 1;
                const selectedShots = ref.selectedShots || [];
                // Utiliser state.data.shots au lieu de storyboard
                const allShots = state.data.shots?.filter(s => s.sceneId === ref.sceneId || String(s.sceneId) === String(ref.sceneId)) || [];
                const totalShots = allShots.length;
                
                // Afficher les num√©ros des plans s√©lectionn√©s
                let shotsInfo = '-';
                if(totalShots > 0) {
                    if(selectedShots.length > 0) {
                        // Trier les plans par ordre
                        const sortedShots = [...allShots].sort((a,b) => (a.order || 0) - (b.order || 0));
                        // R√©cup√©rer les num√©ros des plans s√©lectionn√©s
                        const shotNumbers = selectedShots.map(shotId => {
                            const shotIndex = sortedShots.findIndex(s => s.id === shotId);
                            return shotIndex >= 0 ? shotIndex + 1 : null;
                        }).filter(Boolean).sort((a,b) => a-b);
                        shotsInfo = `Plans: ${shotNumbers.join(', ')} (${selectedShots.length}/${totalShots})`;
                    } else {
                        shotsInfo = `0/${totalShots} plans`;
                    }
                }
                
                scenesHTML += `<tr>
                    <td>${ref.startTime || '--:--'}</td>
                    <td><strong>Sc.${sceneIndex}</strong> - ${Utils.escape(scene.title)}</td>
                    <td>${Utils.escape(scene.perso || '-')}</td>
                    <td>${scene.time || '-'} min</td>
                    <td>${shotsInfo}</td>
                </tr>`;
            }
        });
        
        // Convocations avec transport - group√©es par cat√©gorie
        let callsheetHTML = '';
        const actorCalls = (shootDay.callSheet || []).filter(c => c.type === 'actor');
        const crewCalls = (shootDay.callSheet || []).filter(c => c.type === 'crew');
        
        // Fonction helper pour le transport
        const getTransportInfo = (call) => {
            let transportInfo = '';
            if(call.transport === 'own') transportInfo = 'üöó';
            else if(call.transport === 'own-brings') {
                const withNames = (call.withWho || []).map(id => {
                    const [type, personId] = [id.substring(0, id.indexOf('_')), id.substring(id.indexOf('_') + 1)];
                    const p = type === 'actor' ? state.data.actors.find(a => a.id === personId) : state.data.crew.find(c => c.id === personId);
                    return p ? p.name : '';
                }).filter(Boolean).join(', ');
                transportInfo = withNames ? `üöóüë• ${withNames}` : 'üöóüë•';
            }
            else if(call.transport === 'with') {
                const withNames = (call.withWho || []).map(id => {
                    const [type, personId] = [id.substring(0, id.indexOf('_')), id.substring(id.indexOf('_') + 1)];
                    const p = type === 'actor' ? state.data.actors.find(a => a.id === personId) : state.data.crew.find(c => c.id === personId);
                    return p ? p.name : '';
                }).filter(Boolean).join(', ');
                transportInfo = withNames ? `‚Üí ${withNames}` : 'üöó‚Üí';
            }
            else if(call.transport === 'taxi') transportInfo = 'üöï';
            else if(call.transport === 'public') transportInfo = 'üöá';
            return transportInfo;
        };
        
        // Com√©diens group√©s
        if(actorCalls.length > 0) {
            const actorGroups = state.data.groups.filter(g => g.type === 'actor');
            
            actorGroups.forEach(grp => {
                const groupCalls = actorCalls.filter(call => {
                    const actor = state.data.actors.find(a => a.id === call.personId);
                    return actor && actor.group_id === grp.id;
                });
                
                if(groupCalls.length > 0) {
                    callsheetHTML += `<tr style="background: var(--bg);"><td colspan="5" style="font-weight: bold; padding: 8px; color: var(--primary);">üé≠ ${grp.name}</td></tr>`;
                    groupCalls.forEach(call => {
                        const person = state.data.actors.find(a => a.id === call.personId);
                        if(person) {
                            const character = state.data.characters.find(c => c.actor_id === person.id);
                            const role = character ? character.name : 'Com√©dien(ne)';
                            callsheetHTML += `<tr>
                                <td>${Utils.escape(person.name)}</td>
                                <td>${Utils.escape(role)}</td>
                                <td><strong>${call.callTime || '--:--'}</strong></td>
                                <td>${getTransportInfo(call)}</td>
                                <td>${Utils.escape(call.notes || '-')}</td>
                            </tr>`;
                        }
                    });
                }
            });
            
            // Com√©diens sans groupe
            const noGroupActors = actorCalls.filter(call => {
                const actor = state.data.actors.find(a => a.id === call.personId);
                return actor && (!actor.group_id || !actorGroups.find(g => g.id === actor.group_id));
            });
            
            if(noGroupActors.length > 0) {
                callsheetHTML += `<tr style="background: var(--bg);"><td colspan="5" style="font-weight: bold; padding: 8px; color: var(--primary);">üé≠ Com√©diens</td></tr>`;
                noGroupActors.forEach(call => {
                    const person = state.data.actors.find(a => a.id === call.personId);
                    if(person) {
                        const character = state.data.characters.find(c => c.actor_id === person.id);
                        const role = character ? character.name : 'Com√©dien(ne)';
                        callsheetHTML += `<tr>
                            <td>${Utils.escape(person.name)}</td>
                            <td>${Utils.escape(role)}</td>
                            <td><strong>${call.callTime || '--:--'}</strong></td>
                            <td>${getTransportInfo(call)}</td>
                            <td>${Utils.escape(call.notes || '-')}</td>
                        </tr>`;
                    }
                });
            }
        }
        
        // Techniciens group√©s par d√©partement
        if(crewCalls.length > 0) {
            const crewGroups = state.data.groups.filter(g => g.type === 'crew');
            
            crewGroups.forEach(grp => {
                const groupCalls = crewCalls.filter(call => {
                    const member = state.data.crew.find(c => c.id === call.personId);
                    return member && member.group_id === grp.id;
                });
                
                if(groupCalls.length > 0) {
                    callsheetHTML += `<tr style="background: var(--bg);"><td colspan="5" style="font-weight: bold; padding: 8px; color: var(--primary);">üé• ${grp.name}</td></tr>`;
                    groupCalls.forEach(call => {
                        const person = state.data.crew.find(c => c.id === call.personId);
                        if(person) {
                            callsheetHTML += `<tr>
                                <td>${Utils.escape(person.name)}</td>
                                <td>${Utils.escape(person.role || 'Technicien')}</td>
                                <td><strong>${call.callTime || '--:--'}</strong></td>
                                <td>${getTransportInfo(call)}</td>
                                <td>${Utils.escape(call.notes || '-')}</td>
                            </tr>`;
                        }
                    });
                }
            });
            
            // Techniciens sans groupe
            const noGroupCrew = crewCalls.filter(call => {
                const member = state.data.crew.find(c => c.id === call.personId);
                return member && (!member.group_id || !crewGroups.find(g => g.id === member.group_id));
            });
            
            if(noGroupCrew.length > 0) {
                callsheetHTML += `<tr style="background: var(--bg);"><td colspan="5" style="font-weight: bold; padding: 8px; color: var(--text-sec);">üé• Autres techniciens</td></tr>`;
                noGroupCrew.forEach(call => {
                    const person = state.data.crew.find(c => c.id === call.personId);
                    if(person) {
                        callsheetHTML += `<tr>
                            <td>${Utils.escape(person.name)}</td>
                            <td>${Utils.escape(person.role || 'Technicien')}</td>
                            <td><strong>${call.callTime || '--:--'}</strong></td>
                            <td>${getTransportInfo(call)}</td>
                            <td>${Utils.escape(call.notes || '-')}</td>
                        </tr>`;
                    }
                });
            }
        }
        
        // Section lieu avec contact et notes d'acc√®s
        let locationHTML = `
            <div class="fds-section">
                <div class="fds-section-title">üìç LIEU DE TOURNAGE</div>
                <p><strong>${Utils.escape(shootDay.location || shootDay.locationRealName || 'Non d√©fini')}</strong></p>
                <p>${Utils.escape(shootDay.locationAddress || '')}</p>`;
        
        // Contact et t√©l√©phone
        if(shootDay.contactName || shootDay.contactPhone) {
            locationHTML += `<p style="margin-top: 10px;">üë§ <strong>Contact :</strong> ${Utils.escape(shootDay.contactName || '')} ${shootDay.contactPhone ? 'üìû ' + Utils.escape(shootDay.contactPhone) : ''}</p>`;
        }
        
        // Notes d'acc√®s
        if(shootDay.locationNotes) {
            locationHTML += `<p style="margin-top: 5px; padding: 10px; background: rgba(var(--warning-rgb), 0.1); border-radius: 6px;">üìù ${Utils.escape(shootDay.locationNotes)}</p>`;
        }
        
        if(shootDay.locationLat && shootDay.locationLng) {
            const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=${shootDay.locationLat},${shootDay.locationLng}`;
            locationHTML += `
                <div id="fds-map-container" class="fds-map-container"></div>
                <div class="fds-location-actions">
                    <a href="${gmapsUrl}" target="_blank" class="fds-gmaps-btn">üìç Ouvrir dans Google Maps</a>
                </div>
                <p class="fds-gmaps-link-print" style="display: none; font-size: 10px; color: #666; word-break: break-all; margin-top: 5px;">üó∫Ô∏è ${gmapsUrl}</p>`;
        }
        locationHTML += '</div>';
        
        // D√©pouillement (√©l√©ments n√©cessaires pour les sc√®nes) - stock√© dans scene.breakdown
        // Avec les responsables par d√©partement
        let breakdownHTML = '';
        const allCategories = {};
        (shootDay.scenes || []).forEach(ref => {
            const scene = state.data.scenes.find(s => s.id === ref.sceneId);
            if(scene && scene.breakdown) {
                Object.entries(scene.breakdown).forEach(([category, items]) => {
                    if(Array.isArray(items) && items.length > 0) {
                        if(!allCategories[category]) allCategories[category] = [];
                        items.forEach(item => {
                            if(!allCategories[category].includes(item)) {
                                allCategories[category].push(item);
                            }
                        });
                    }
                });
            }
        });
        
        // Mapping cat√©gorie d√©pouillement -> groupe crew
        const categoryToCrewGroup = {
            'ACCESSOIRES': 'gc5', 'DECORS-LIEUX': 'gc5',
            'COSTUMES': 'gc6',
            'MAQUILLAGE-COIFFURE': 'gc7',
            'VEHICULES': 'gc12', 'LOGISTIQUE': 'gc12',
            'SON-MUSIQUE': 'gc4',
            'LUMIERE': 'gc2',
            'FIGURATION': 'gc9', 'ANIMAUX': 'gc9',
            'EFFETS SPECIAUX (SFX)': 'gc16',
            'EFFETS VISUELS (VFX)': 'gc13'
        };
        
        // Trouver le responsable pour chaque cat√©gorie
        const getResponsibleForCategory = (category) => {
            const groupId = categoryToCrewGroup[category];
            if(!groupId) return null;
            
            // Chercher dans la callSheet du jour les techniciens de ce groupe
            const responsible = (shootDay.callSheet || []).find(call => {
                if(call.type !== 'crew') return false;
                const crew = state.data.crew.find(c => c.id === call.personId);
                return crew && crew.group_id === groupId;
            });
            
            if(responsible) {
                const crew = state.data.crew.find(c => c.id === responsible.personId);
                return crew ? crew.name : null;
            }
            return null;
        };
        
        if(Object.keys(allCategories).length > 0) {
            breakdownHTML = `
                <div class="fds-section">
                    <div class="fds-section-title">üì¶ D√âPOUILLEMENT / BESOINS</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        ${Object.entries(allCategories).map(([cat, items]) => {
                            const responsible = getResponsibleForCategory(cat);
                            const responsibleText = responsible ? ` (${Utils.escape(responsible)})` : '';
                            return `
                            <div style="padding: 10px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                                <strong>${Utils.escape(cat)}${responsibleText}</strong>
                                <ul style="margin: 5px 0 0 15px; padding: 0;">
                                    ${items.map(item => `<li>${Utils.escape(item)}</li>`).join('')}
                                </ul>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        } else {
            breakdownHTML = `
                <div class="fds-section">
                    <div class="fds-section-title">üì¶ D√âPOUILLEMENT / BESOINS</div>
                    <p style="color: var(--text-sec); font-style: italic;">Aucun √©l√©ment de d√©pouillement pour les sc√®nes s√©lectionn√©es</p>
                </div>`;
        }
        
        // Nom du tournage
        const dayName = shootDay.name || `Jour ${shootDay.dayNumber || '?'}`;
        
        content.innerHTML = `
            <div class="fds-preview" id="fds-print-content">
                <div class="fds-header">
                    <div class="fds-title">${Utils.escape(state.data.title)}</div>
                    <div class="fds-subtitle">FEUILLE DE SERVICE</div>
                    <div style="margin-top: 10px;">
                        <strong>${Utils.escape(dayName)}</strong> - ${dateStr}
                    </div>
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">üé¨ PROGRAMME DU JOUR</div>
                    <table class="fds-table">
                        <thead>
                            <tr><th>Heure</th><th>Sc√®ne</th><th>Personnages</th><th>Dur√©e</th><th>Plans</th></tr>
                        </thead>
                        <tbody>
                            ${scenesHTML || '<tr><td colspan="5" style="text-align: center;">Aucune sc√®ne planifi√©e</td></tr>'}
                        </tbody>
                    </table>
                </div>
                
                ${locationHTML}
                
                <div class="fds-section">
                    <div class="fds-section-title">‚è∞ HORAIRES G√âN√âRAUX</div>
                    <table class="fds-table">
                        <tr>
                            <td><strong>Convocation √©quipe</strong></td>
                            <td>${shootDay.crewCall || '--:--'}</td>
                            <td><strong>Pr√™t √† tourner</strong></td>
                            <td>${shootDay.readyToShoot || '--:--'}</td>
                        </tr>
                        <tr>
                            <td><strong>Pause d√©jeuner</strong></td>
                            <td>${shootDay.lunchStart || '--:--'} - ${shootDay.lunchEnd || '--:--'}</td>
                            <td><strong>Fin estim√©e</strong></td>
                            <td>${shootDay.estimatedWrap || '--:--'}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">üìã CONVOCATIONS</div>
                    <table class="fds-table">
                        <thead>
                            <tr><th>Nom</th><th>Fonction</th><th>Convocation</th><th>Transport</th><th>Notes</th></tr>
                        </thead>
                        <tbody>
                            ${callsheetHTML || '<tr><td colspan="5" style="text-align: center;">Aucune convocation</td></tr>'}
                        </tbody>
                    </table>
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">üå§Ô∏è M√âT√âO PR√âVUE</div>
                    ${weatherHTML}
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">üå°Ô∏è M√âT√âO PERSONNALIS√âE / CONSIGNES</div>
                    <p style="white-space: pre-wrap;">${shootDay.customWeather ? Utils.escape(shootDay.customWeather) : '<span style="color: var(--text-sec); font-style: italic;">Vide</span>'}</p>
                </div>
                
                <div class="fds-section">
                    <div class="fds-section-title">üìù NOTES G√âN√âRALES</div>
                    <p style="white-space: pre-wrap;">${shootDay.notes ? Utils.escape(shootDay.notes) : '<span style="color: var(--text-sec); font-style: italic;">Vide</span>'}</p>
                </div>
                
                ${breakdownHTML}
            </div>
        `;
        
        // Initialiser la carte Leaflet
        if(shootDay.locationLat && shootDay.locationLng) {
            setTimeout(() => {
                const mapContainer = document.getElementById('fds-map-container');
                if(mapContainer && typeof L !== 'undefined') {
                    const fdsMap = L.map(mapContainer, { zoomControl: true, attributionControl: false })
                        .setView([parseFloat(shootDay.locationLat), parseFloat(shootDay.locationLng)], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(fdsMap);
                    L.marker([parseFloat(shootDay.locationLat), parseFloat(shootDay.locationLng)]).addTo(fdsMap)
                        .bindPopup(`<strong>${Utils.escape(shootDay.location || 'Lieu')}</strong>`).openPopup();
                    Planning.currentFDSMap = fdsMap;
                }
            }, 100);
        }
    },
    
    printFDS: () => {
        const shootDay = Planning.currentFDSDay;
        if(!shootDay) return;
        
        // G√©n√©rer le nom du fichier
        const projectTitle = state.data.title || 'Projet';
        const dayName = shootDay.name || `J${shootDay.dayNumber || ''}`;
        const dateStr = shootDay.startDate || shootDay.date || '';
        const pdfTitle = `${projectTitle} - FDS ${dayName} - ${dateStr}`.replace(/[\/\\:*?"<>|]/g, '-');
        
        // Pr√©parer le contenu avec le lien Google Maps en texte
        let content = document.getElementById('fds-print-content').innerHTML;
        
        // Ajouter le lien Google Maps en texte visible pour l'impression
        let gmapsTextHTML = '';
        if(shootDay.locationLat && shootDay.locationLng) {
            const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=${shootDay.locationLat},${shootDay.locationLng}`;
            gmapsTextHTML = `<p class="print-only-link" style="font-size: 10px; color: #666; word-break: break-all;">üó∫Ô∏è Google Maps: ${gmapsUrl}</p>`;
        }
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${Utils.escape(pdfTitle)}</title>
                <style>
                    body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.4; margin: 20px; }
                    .fds-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 15px; }
                    .fds-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
                    .fds-subtitle { font-size: 14px; }
                    .fds-section { margin-bottom: 15px; page-break-inside: avoid; }
                    .fds-section-title { font-weight: bold; background: #eee; padding: 5px; margin-bottom: 10px; }
.fds-gmaps-link-print { display: none; }
@media print { .fds-gmaps-link-print { display: block !important; } .fds-map-container, .fds-location-actions { display: none !important; } }
                    .fds-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
                    .fds-table th, .fds-table td { border: 1px solid #333; padding: 5px; text-align: left; }
                    .fds-table th { background: #ddd; }
                    .fds-weather-card { display: flex; gap: 15px; align-items: center; padding: 10px; background: #f0f7ff; border-radius: 8px; margin-bottom: 10px; flex-wrap: wrap; }
                    .fds-weather-icon { font-size: 2rem; }
                    .fds-weather-temp { font-size: 1.5rem; font-weight: bold; }
                    .fds-weather-row { display: flex; gap: 10px; flex-wrap: wrap; }
                    .fds-weather-item { padding: 3px 8px; background: #e0e0e0; border-radius: 10px; font-size: 11px; }
                    .fds-sun-times { display: flex; gap: 15px; font-size: 11px; margin-top: 5px; }
                    .fds-map-container { display: none; }
                    .fds-location-actions { display: none; }
                    .fds-gmaps-btn { display: none; }
                    .print-only-link { display: block; margin-top: 10px; }
                    @media screen {
                        .print-only-link { display: none; }
                    }
                    @page { margin: 15mm; }
                </style>
            </head>
            <body>${content}${gmapsTextHTML}</body>
            </html>
        `);
        printWindow.document.close();
        
        // Petit d√©lai pour que le titre soit bien pris en compte
        setTimeout(() => {
            printWindow.print();
        }, 100);
    },
    
    sendFDS: async () => {
        const shootDay = Planning.currentFDSDay;
        if(!shootDay) {
            Utils.toast('Aucune feuille de service charg√©e', 'error');
            return;
        }
        
        const projectName = state.data.title || 'Projet';
        const dateFormatted = new Date(shootDay.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const senderName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0] || 'La production';
        
        // R√©cup√©rer m√©t√©o et lien GPS
        let weatherInfo = '';
        let gmapsLink = '';
        if(shootDay.locationLat && shootDay.locationLng) {
            gmapsLink = `\nüó∫Ô∏è GPS : https://www.google.com/maps/search/?api=1&query=${shootDay.locationLat},${shootDay.locationLng}`;
            const weather = await Weather.fetch(shootDay.locationLat, shootDay.locationLng, shootDay.date);
            if(weather) {
                weatherInfo = `\n\nüå§Ô∏è M√©t√©o : ${weather.icon} ${weather.description}, ${weather.tempMin}¬∞C - ${weather.tempMax}¬∞C`;
                if(weather.precipitationProb > 30) weatherInfo += ` (${weather.precipitationProb}% pluie)`;
                weatherInfo += `\nüåÖ Soleil : ${weather.sunrise} - ${weather.sunset}`;
            }
        }
        
        // Collecter toutes les personnes √† notifier
        const recipients = [];
        
        // Parcourir la callSheet
        if(shootDay.callSheet && shootDay.callSheet.length > 0) {
            for(const call of shootDay.callSheet) {
                let person = null;
                
                if(call.type === 'actor') {
                    person = state.data.actors.find(a => a.id === call.personId);
                } else if(call.type === 'crew') {
                    person = state.data.crew.find(c => c.id === call.personId);
                }
                
                if(person && person.email) {
                    recipients.push({
                        name: person.name || 'Inconnu',
                        email: person.email,
                        callTime: call.callTime || shootDay.crewCall || '√Ä confirmer',
                        notes: call.notes || ''
                    });
                }
            }
        }
        
        if(recipients.length === 0) {
            Utils.toast('Aucune personne avec email dans cette feuille de service', 'warning');
            return;
        }
        
        if(!await ConfirmModal.show({ title: 'Envoyer la feuille de service ?', message: `${recipients.length} destinataire(s) :\n\n${recipients.map(r => '‚Ä¢ ' + r.name).join('\n')}`, icon: 'üìß', confirmText: 'Envoyer' })) {
            return;
        }
        
        let sent = 0;
        let errors = 0;
        
        for(const recipient of recipients) {
            const subject = `üé¨ Feuille de Service J${shootDay.dayNumber} - ${projectName}`;
            const content = `Bonjour ${recipient.name},

Vous avez re√ßu une feuille de service pour le projet "${projectName}" :

üìÖ Date : ${dateFormatted}
üé¨ Jour de tournage : J${shootDay.dayNumber}
üìç Lieu : ${shootDay.location || '√Ä confirmer'}${shootDay.locationAddress ? '\nüìå Adresse : ' + shootDay.locationAddress : ''}${gmapsLink}${weatherInfo}

‚è∞ Votre convocation : ${recipient.callTime}
üé¨ Pr√™t √† tourner : ${shootDay.readyToShoot || '√Ä confirmer'}
üçΩÔ∏è Repas : ${shootDay.lunchStart || '?'} - ${shootDay.lunchEnd || '?'}
üèÅ Fin estim√©e : ${shootDay.estimatedWrap || '√Ä confirmer'}
${recipient.notes ? '\nüìù Notes vous concernant : ' + recipient.notes : ''}
${shootDay.notes ? '\nüìã Notes g√©n√©rales : ' + shootDay.notes : ''}

Merci de confirmer votre pr√©sence.

Cordialement,
${senderName}
${projectName}`;

            try {
                // Envoyer message interne
                await Messages.send(recipient.email, {
                    subject: subject,
                    content: content,
                    type: 'callsheet',
                    projectId: state.currentProjectId,
                    projectName: projectName,
                    shootDayId: shootDay.id,
                    date: shootDay.date
                });
                
                // Envoyer email
                await Messages.sendEmailPing(recipient.email, recipient.name, 'callsheet', {
                    projectName: projectName,
                    shootDate: dateFormatted,
                    location: shootDay.location || '√Ä confirmer',
                    callTime: recipient.callTime,
                    senderName: senderName
                });
                
                sent++;
                console.log(`‚úÖ Convocation envoy√©e √† ${recipient.name}`);
            } catch(e) {
                console.error(`‚ùå Erreur envoi √† ${recipient.name}:`, e);
                errors++;
            }
        }
        
        if(sent > 0) {
            Utils.toast(`${sent} convocation(s) envoy√©e(s) !`, 'success');
        }
        if(errors > 0) {
            Utils.toast(`${errors} erreur(s) d'envoi`, 'warning');
        }
    },
    
    // ========== CALENDRIER VISUEL V1.4.6 ==========
    availMonth: new Date().getMonth(),
    availYear: new Date().getFullYear(),
    
    // Export ICS pour Google Calendar / Outlook
    exportICS: () => {
        const shootingDays = state.data.shootingDays || [];
        
        if(shootingDays.length === 0) {
            Utils.toast('Aucun jour de tournage √† exporter', 'warning');
            return;
        }
        
        let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Moteur//Calendrier Tournage//FR
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${state.data.title || 'Tournage'}
`;
        
        shootingDays.forEach(day => {
            const startDate = day.startDate || day.date;
            const endDate = day.endDate || startDate;
            if(!startDate) return;
            
            const startDateStr = startDate.replace(/-/g, '');
            // ICS DTEND est exclusif, donc on ajoute 1 jour
            const endDateObj = new Date(endDate);
            endDateObj.setDate(endDateObj.getDate() + 1);
            const endDateStr = Planning.formatDate(endDateObj).replace(/-/g, '');
            
            const sceneTitles = (day.scenes || []).map(s => {
                const scene = state.data.scenes.find(sc => sc.id === s.sceneId);
                return scene ? scene.title : '';
            }).filter(t => t).join(', ');
            
            const uid = `${day.id}@filmmanagerpro`;
            const summary = `${day.name || 'Tournage'} - ${state.data.title || 'Projet'}`;
            const description = sceneTitles ? `Sc√®nes: ${sceneTitles}` : '';
            const location = day.location || '';
            
            icsContent += `BEGIN:VEVENT
UID:${uid}
DTSTART;VALUE=DATE:${startDateStr}
DTEND;VALUE=DATE:${endDateStr}
SUMMARY:${summary}
DESCRIPTION:${description.replace(/\n/g, '\\n')}
LOCATION:${location}
STATUS:CONFIRMED
END:VEVENT
`;
        });
        
        icsContent += 'END:VCALENDAR';
        
        // T√©l√©charger le fichier
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${(state.data.title || 'Tournage').replace(/\s+/g, '_')}_planning.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        Utils.toast(`${shootingDays.length} jour(s) export√©(s) en .ICS`, 'success');
        History.log('ADD', 'Export calendrier ICS');
    },
    
    // Afficher la vue des disponibilit√©s
    showAvailabilityView: () => {
        const modal = document.getElementById('availability-modal');
        modal.style.display = 'flex';
        Planning.renderAvailabilityCalendar();
    },
    
    prevAvailMonth: () => {
        Planning.availMonth--;
        if(Planning.availMonth < 0) {
            Planning.availMonth = 11;
            Planning.availYear--;
        }
        Planning.renderAvailabilityCalendar();
    },
    
    nextAvailMonth: () => {
        Planning.availMonth++;
        if(Planning.availMonth > 11) {
            Planning.availMonth = 0;
            Planning.availYear++;
        }
        Planning.renderAvailabilityCalendar();
    },
    
    renderAvailabilityCalendar: () => {
        const container = document.getElementById('availability-calendar-container');
        const monthYearEl = document.getElementById('avail-month-year');
        
        const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        monthYearEl.textContent = `${monthNames[Planning.availMonth]} ${Planning.availYear}`;
        
        const year = Planning.availYear;
        const month = Planning.availMonth;
        
        // Premier jour du mois et nombre de jours
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        let startWeekDay = firstDay.getDay();
        if(startWeekDay === 0) startWeekDay = 7; // Lundi = 1
        
        // R√©cup√©rer les personnes (acteurs + techniciens)
        const actors = (state.data.actors || []).filter(a => a.name);
        const crew = (state.data.crew || []).filter(c => c.name);
        const people = [
            ...actors.map(a => ({ ...a, _type: 'üé≠', _personType: 'actor' })),
            ...crew.map(c => ({ ...c, _type: 'üé¨', _personType: 'crew' }))
        ];
        
        // Jours de tournage
        const shootingDays = state.data.shootingDays || [];
        const shootingDates = new Set(shootingDays.map(d => d.date));
        
        // Construire le tableau
        let html = `<div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                <thead>
                    <tr style="background: var(--bg);">
                        <th style="padding: 10px; border: 1px solid var(--border); position: sticky; left: 0; background: var(--bg); z-index: 1;">Personne</th>`;
        
        for(let d = 1; d <= daysInMonth; d++) {
            const date = new Date(year, month, d);
            const dayName = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][date.getDay()];
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const isShooting = shootingDates.has(dateStr);
            
            html += `<th style="padding: 8px 5px; border: 1px solid var(--border); text-align: center; min-width: 45px; font-size: 0.8rem; ${isWeekend ? 'background: rgba(0,0,0,0.05);' : ''} ${isShooting ? 'background: rgba(76,175,80,0.3);' : ''}">
                ${dayName}<br><strong>${d}</strong>
                ${isShooting ? '<br>üé¨' : ''}
            </th>`;
        }
        
        html += `</tr></thead><tbody>`;
        
        // Lignes pour chaque personne
        people.forEach(person => {
            html += `<tr>
                <td style="padding: 8px; border: 1px solid var(--border); position: sticky; left: 0; background: var(--panel-bg); z-index: 1; white-space: nowrap;">
                    ${person._type} ${Utils.escape(person.name)}
                </td>`;
            
            const availDates = person.availabilityDates || [];
            const unavailDates = person.unavailabilityDates || [];
            
            for(let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const date = new Date(year, month, d);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isShooting = shootingDates.has(dateStr);
                
                // V√©rifier disponibilit√©
                let isAvailable = false;
                availDates.forEach(range => {
                    if(range.from && range.to) {
                        if(dateStr >= range.from && dateStr <= range.to) {
                            isAvailable = true;
                        }
                    }
                });
                
                // V√©rifier indisponibilit√©
                let isUnavailable = false;
                unavailDates.forEach(range => {
                    if(range.from && range.to) {
                        if(dateStr >= range.from && dateStr <= range.to) {
                            isUnavailable = true;
                        }
                    }
                });
                
                let cellStyle = 'padding: 5px; border: 1px solid var(--border); text-align: center;';
                let cellContent = '';
                
                if(isWeekend) cellStyle += ' background: rgba(0,0,0,0.03);';
                
                // Priorit√© : Indisponible > Disponible > Non renseign√©
                if(isUnavailable) {
                    cellStyle += ' background: rgba(244, 67, 54, 0.3);';
                    cellContent = '‚úó';
                } else if(isAvailable) {
                    cellStyle += ' background: rgba(33, 150, 243, 0.3);';
                    cellContent = '‚úì';
                }
                
                // Jour de tournage
                if(isShooting) {
                    if(isUnavailable) {
                        cellStyle = 'padding: 5px; border: 1px solid var(--border); text-align: center; background: rgba(244, 67, 54, 0.5);';
                        cellContent = '‚ö†Ô∏è';
                    } else if(isAvailable) {
                        cellStyle = 'padding: 5px; border: 1px solid var(--border); text-align: center; background: rgba(76, 175, 80, 0.4);';
                        cellContent = 'üé¨';
                    } else {
                        cellContent = 'üé¨';
                    }
                }
                
                html += `<td style="${cellStyle}">${cellContent}</td>`;
            }
            
            html += `</tr>`;
        });
        
        html += `</tbody></table></div>`;
        
        if(people.length === 0) {
            html = `<div style="text-align: center; padding: 40px; color: var(--text-sec);">
                Ajoutez des com√©dien¬∑ne¬∑s ou technicien¬∑ne¬∑s avec leurs disponibilit√©s pour voir le calendrier.
            </div>`;
        }
        
        container.innerHTML = html;
    }
};
  
const Stats = {
      render: () => {
          const scenes = state.data.scenes;
          document.getElementById('stat-total-scenes').innerText = scenes.length;
          let totalTime = 0; 
          scenes.forEach(s => totalTime += parseFloat(s.time||0));
          document.getElementById('stat-total-time').innerText = Math.round(totalTime) + " min";
          
          let totalDial = 0; 
          const charCounts = {}; 
          const tagCounts = {};
          
          scenes.forEach(s => {
              const tid = s.tag_id || 't1'; 
              tagCounts[tid] = (tagCounts[tid] || 0) + 1;
              const div = document.createElement('div'); 
              div.innerHTML = s.scriptContent;
              const dials = div.querySelectorAll('.sc-dial'); 
              totalDial += dials.length;
              dials.forEach(d => {
                 const text = d.innerText.trim(); 
                 const words = text.split(/\s+/).filter(w => w.length > 0).length;
                 let prev = d.previousElementSibling; 
                 while(prev && !prev.classList.contains('sc-perso')) prev = prev.previousElementSibling;
                 if(prev) { 
                     const name = prev.innerText.trim().replace(/\(.*\)/,'').trim().toUpperCase(); 
                     charCounts[name] = (charCounts[name] || 0) + words; 
                 }
              });
          });
          
          document.getElementById('stat-total-dials').innerText = totalDial;
          Stats.drawBarChart('chart-chars', charCounts, 100);
          
          const tagData = {}; 
          state.data.tags.forEach(t => { 
              if(tagCounts[t.id]) tagData[t.name] = tagCounts[t.id]; 
          });
          Stats.drawBarChart('chart-tags', tagData, 10);
          
          // Lieux stats
          Stats.renderLieuxStats();
          
          // Crew stats
          Stats.renderCrewStats();
          
          // Shots stats
          Stats.renderShotsStats();
          
          // Actor days stats
          Stats.renderActorDaysStats();
          
          // Stats avanc√©es V1.4.3
          Stats.renderAdvanced();
      },
      
      renderCrewStats: () => {
          const container = document.getElementById('chart-crew');
          if(!container) return;
          
          if(!state.data.crew || state.data.crew.length === 0) {
              container.innerHTML = '<div style="text-align:center; color:#999">Aucun technicien</div>';
              document.getElementById('stat-total-crew').innerText = '0';
              document.getElementById('stat-total-budget').innerText = '0 ‚Ç¨';
              return;
          }
          
          document.getElementById('stat-total-crew').innerText = state.data.crew.length;
          
          let totalBudget = 0;
          state.data.crew.forEach(m => {
              if(m.dailyRate) {
                  totalBudget += parseFloat(m.dailyRate) || 0;
              }
          });
          document.getElementById('stat-total-budget').innerText = totalBudget.toLocaleString() + ' ‚Ç¨/jour';
          
          const crewGroups = state.data.groups.filter(g => g.type === 'crew');
          const deptCounts = {};
          
          crewGroups.forEach(grp => {
              const count = state.data.crew.filter(m => m.group_id === grp.id).length;
              if(count > 0) {
                  deptCounts[grp.name] = count;
              }
          });
          
          const unassigned = state.data.crew.filter(m => !m.group_id).length;
          if(unassigned > 0) {
              deptCounts['Non class√©'] = unassigned;
          }
          
          Stats.drawBarChart('chart-crew', deptCounts, 15);
      },
      
	  renderActorDaysStats: () => {
          const container = document.getElementById('chart-actor-days');
          if(!container) return;
          
          const shootingDays = state.data.shootingDays || [];
          const actors = state.data.actors || [];
          
          if(actors.length === 0) {
              container.innerHTML = '<div style="text-align:center; color:#999">Aucun com√©dien</div>';
              return;
          }
          
          if(shootingDays.length === 0) {
              container.innerHTML = '<div style="text-align:center; color:#999">Aucun jour de tournage planifi√©</div>';
              return;
          }
          
          // Compter les jours par com√©dien
          const daysByActor = {};
          
          shootingDays.forEach(day => {
              if(!day.callSheet || day.callSheet.length === 0) return;
              
              day.callSheet.forEach(call => {
                  if(call.type === 'actor') {
                      const actor = actors.find(a => a.id === call.personId);
                      if(actor) {
                          const name = actor.name || 'Sans nom';
                          daysByActor[name] = (daysByActor[name] || 0) + 1;
                      }
                  }
              });
          });
          
          if(Object.keys(daysByActor).length === 0) {
              container.innerHTML = '<div style="text-align:center; color:#999">Aucun com√©dien convoqu√©</div>';
              return;
          }
          
          Stats.drawBarChart('chart-actor-days', daysByActor, 20);
      },
      
	  renderLieuxStats: () => {
          const container = document.getElementById('chart-lieux');
          if(!container) return;
          
          const lieuxCounts = {};
          state.data.scenes.forEach(s => {
              if(!s.title) return;
              const locMatch = s.title.match(/^(?:INT\.|EXT\.|I\/E)\s*([^\-]+)/i);
              if(locMatch && locMatch[1]) {
                  const lieu = locMatch[1].trim().toUpperCase();
                  lieuxCounts[lieu] = (lieuxCounts[lieu] || 0) + 1;
              }
          });
          
          Stats.drawBarChart('chart-lieux', lieuxCounts, 100);
      },
	  
      renderShotsStats: () => {
          const container = document.getElementById('chart-shots');
          if(!container) return;
          
          if(!state.data.shots || state.data.shots.length === 0) {
              container.innerHTML = '<div style="text-align:center; color:#999">Aucun plan</div>';
              document.getElementById('stat-total-shots').innerText = '0';
              return;
          }
          
          document.getElementById('stat-total-shots').innerText = state.data.shots.length;
          
          const shotTypeCounts = {};
          state.data.shots.forEach(s => {
              if(s.shotType) {
                  shotTypeCounts[s.shotType] = (shotTypeCounts[s.shotType] || 0) + 1;
              }
          });
          
          Stats.drawBarChart('chart-shots', shotTypeCounts, 10);
      },
      
      drawBarChart: (id, dataObj, limit) => {
          const container = document.getElementById(id); 
          container.innerHTML = '';
          const sorted = Object.entries(dataObj).sort((a,b) => b[1] - a[1]).slice(0, limit);
          if(sorted.length === 0) { 
              container.innerHTML = '<div style="text-align:center; color:#999">Pas de donn√©es</div>'; 
              return; 
          }
          const max = sorted[0][1];
          sorted.forEach(([label, val]) => {
              const pct = (val / max) * 100; 
              const row = document.createElement('div'); 
              row.className = 'bar-row';
              row.innerHTML = `<div class="bar-label">${label}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div><div class="bar-val">${val}</div>`;
              
              // Rendre cliquable selon le type de chart
              if(id === 'chart-chars') {
                  row.style.cursor = 'pointer';
                  row.title = 'Cliquer pour voir les personnages';
                  row.onclick = () => {
                      app.UI.switchTab('personnages');
                  };
              } else if(id === 'chart-lieux') {
                  row.style.cursor = 'pointer';
                  row.title = 'Cliquer pour voir les lieux';
                  row.onclick = () => {
                      app.UI.switchTab('lieux');
                  };
              } else if(id === 'chart-crew') {
                  row.style.cursor = 'pointer';
                  row.title = 'Cliquer pour voir l\'√©quipe';
                  row.onclick = () => {
                      app.UI.switchTab('equipe');
                  };
              }
              
              container.appendChild(row);
          });
      },
      
      // ===== STATISTIQUES AVANC√âES V1.4.3 =====
      chartInstances: {},
      
      renderAdvanced: () => {
          Stats.renderProgressScenes();
          Stats.renderIntExtChart();
          Stats.renderJourNuitChart();
          Stats.renderBudgetChart();
          Stats.renderTimeTagsChart();
      },
      
      destroyChart: (chartId) => {
          if(Stats.chartInstances[chartId]) {
              Stats.chartInstances[chartId].destroy();
              delete Stats.chartInstances[chartId];
          }
      },
      
      // Barre de progression sc√®nes planifi√©es
      renderProgressScenes: () => {
          const totalScenes = state.data.scenes?.length || 0;
          const shootingDays = state.data.shootingDays || [];
          const plannedSceneIds = new Set();
          shootingDays.forEach(day => {
              (day.scenes || []).forEach(s => plannedSceneIds.add(s.sceneId));
          });
          const plannedCount = plannedSceneIds.size;
          const pct = totalScenes > 0 ? Math.round((plannedCount / totalScenes) * 100) : 0;
          
          const bar = document.getElementById('progress-scenes-planned');
          if(bar) {
              bar.style.width = pct + '%';
              bar.textContent = pct + '%';
          }
          
          const legend = document.getElementById('legend-scenes-planned');
          if(legend) {
              legend.innerHTML = `
                  <div class="stats-legend-item"><span class="stats-legend-color" style="background:#4CAF50"></span> Planifi√©es: ${plannedCount}</div>
                  <div class="stats-legend-item"><span class="stats-legend-color" style="background:#ddd"></span> Total: ${totalScenes}</div>
              `;
          }
      },
      
      // Camembert INT/EXT
      renderIntExtChart: () => {
          const canvas = document.getElementById('chart-int-ext');
          if(!canvas) return;
          
          Stats.destroyChart('intExt');
          
          let intCount = 0, extCount = 0;
          (state.data.scenes || []).forEach(s => {
              const title = (s.title || '').toUpperCase();
              if(title.startsWith('INT')) intCount++;
              else if(title.startsWith('EXT')) extCount++;
          });
          
          if(intCount === 0 && extCount === 0) {
              canvas.parentElement.innerHTML = '<div style="text-align:center; color:#999; padding:50px;">Pas de donn√©es</div>';
              return;
          }
          
          Stats.chartInstances['intExt'] = new Chart(canvas, {
              type: 'doughnut',
              data: {
                  labels: ['Int√©rieur', 'Ext√©rieur'],
                  datasets: [{
                      data: [intCount, extCount],
                      backgroundColor: ['#2196F3', '#FF9800'],
                      borderWidth: 0
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { position: 'bottom' }
                  }
              }
          });
      },
      
      // Camembert JOUR/NUIT
      renderJourNuitChart: () => {
          const canvas = document.getElementById('chart-jour-nuit');
          if(!canvas) return;
          
          Stats.destroyChart('jourNuit');
          
          let jourCount = 0, nuitCount = 0, aubeCount = 0;
          (state.data.scenes || []).forEach(s => {
              const title = (s.title || '').toUpperCase();
              if(title.includes('JOUR')) jourCount++;
              else if(title.includes('NUIT')) nuitCount++;
              else if(title.includes('AUBE') || title.includes('CR√âPUSCULE')) aubeCount++;
          });
          
          if(jourCount === 0 && nuitCount === 0 && aubeCount === 0) {
              canvas.parentElement.innerHTML = '<div style="text-align:center; color:#999; padding:50px;">Pas de donn√©es</div>';
              return;
          }
          
          const labels = ['Jour', 'Nuit'];
          const data = [jourCount, nuitCount];
          const colors = ['#FFC107', '#3F51B5'];
          
          if(aubeCount > 0) {
              labels.push('Aube/Cr√©puscule');
              data.push(aubeCount);
              colors.push('#FF5722');
          }
          
          Stats.chartInstances['jourNuit'] = new Chart(canvas, {
              type: 'doughnut',
              data: {
                  labels: labels,
                  datasets: [{
                      data: data,
                      backgroundColor: colors,
                      borderWidth: 0
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { position: 'bottom' }
                  }
              }
          });
      },
      
      // Budget par cat√©gorie + comparaison
      renderBudgetChart: () => {
          const canvas = document.getElementById('chart-budget-cat');
          if(!canvas) return;
          
          Stats.destroyChart('budgetCat');
          
          const expenses = state.data.expenses || [];
          const categories = {};
          let totalDepense = 0;
          
          expenses.forEach(exp => {
              if(exp.status === 'validated' || exp.status === 'pending') {
                  const cat = exp.category || 'Autre';
                  const amount = parseFloat(exp.amount) || 0;
                  categories[cat] = (categories[cat] || 0) + amount;
                  totalDepense += amount;
              }
          });
          
          // Budget pr√©vu (depuis pr√©sentation ou estim√©)
          const budgetPrevu = parseFloat(state.data.presentation?.budget) || 0;
          const reste = budgetPrevu - totalDepense;
          
          // Mise √† jour des valeurs
          document.getElementById('budget-prevu').textContent = budgetPrevu.toLocaleString('fr-FR') + ' ‚Ç¨';
          document.getElementById('budget-depense').textContent = totalDepense.toLocaleString('fr-FR') + ' ‚Ç¨';
          
          const resteEl = document.getElementById('budget-reste');
          resteEl.textContent = reste.toLocaleString('fr-FR') + ' ‚Ç¨';
          resteEl.className = 'budget-item-value ' + (reste >= 0 ? 'positive' : 'negative');
          
          // Barre de progression budget
          const pctBudget = budgetPrevu > 0 ? Math.min(100, Math.round((totalDepense / budgetPrevu) * 100)) : 0;
          const barBudget = document.getElementById('progress-budget');
          if(barBudget) {
              barBudget.style.width = pctBudget + '%';
              barBudget.textContent = pctBudget + '% utilis√©';
              barBudget.style.background = pctBudget > 90 ? 'linear-gradient(90deg, #f44336, #E91E63)' : 'linear-gradient(90deg, #2196F3, #03A9F4)';
          }
          
          // Camembert cat√©gories
          const catLabels = Object.keys(categories);
          const catData = Object.values(categories);
          
          if(catLabels.length === 0) {
              canvas.parentElement.innerHTML = '<div style="text-align:center; color:#999; padding:50px;">Aucune d√©pense</div>';
              return;
          }
          
          const catColors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#f44336', '#00BCD4', '#795548', '#607D8B'];
          
          Stats.chartInstances['budgetCat'] = new Chart(canvas, {
              type: 'pie',
              data: {
                  labels: catLabels,
                  datasets: [{
                      data: catData,
                      backgroundColor: catColors.slice(0, catLabels.length),
                      borderWidth: 0
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { position: 'bottom' }
                  }
              }
          });
      },
      
      // Temps par tag (barres horizontales)
      renderTimeTagsChart: () => {
          const canvas = document.getElementById('chart-time-tags');
          if(!canvas) return;
          
          Stats.destroyChart('timeTags');
          
          const tagTimes = {};
          const tagColors = {};
          
          (state.data.tags || []).forEach(t => {
              tagTimes[t.name] = 0;
              tagColors[t.name] = t.color || '#999';
          });
          
          (state.data.scenes || []).forEach(s => {
              const tag = (state.data.tags || []).find(t => t.id === s.tag_id);
              if(tag) {
                  tagTimes[tag.name] += parseFloat(s.time) || 0;
              }
          });
          
          const labels = Object.keys(tagTimes).filter(k => tagTimes[k] > 0);
          const data = labels.map(l => Math.round(tagTimes[l]));
          const colors = labels.map(l => tagColors[l]);
          
          if(labels.length === 0) {
              canvas.parentElement.innerHTML = '<div style="text-align:center; color:#999; padding:50px;">Pas de donn√©es</div>';
              return;
          }
          
          Stats.chartInstances['timeTags'] = new Chart(canvas, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Minutes',
                      data: data,
                      backgroundColor: colors,
                      borderWidth: 0,
                      borderRadius: 5
                  }]
              },
              options: {
                  indexAxis: 'y',
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: { display: false }
                  },
                  scales: {
                      x: {
                          beginAtZero: true,
                          title: { display: true, text: 'Minutes' }
                      }
                  }
              }
          });
      }
  };
  
 const Exporter = {
    toPDF: (opts) => { 
        document.body.className = state.currentRole === 'viewer' ? 'read-only' : ''; 
        if(document.body.classList.contains('dark-mode')) document.body.classList.remove('dark-mode'); 
        document.getElementById('pc-title').innerText = state.data.title;
        document.getElementById('pc-author').innerText = opts.author ? `Auteur : ${opts.author}` : "";
        let contactHtml = ""; 
        if(opts.phone) contactHtml += `<p>T√©l : ${opts.phone}</p>`; 
        if(opts.web) contactHtml += `<p>Web : ${opts.web}</p>`; 
        if(opts.reg) contactHtml += `<p>D√©p√¥t : ${opts.reg}</p>`;
        document.getElementById('pc-contact').innerHTML = contactHtml;
        
        if(opts.synop) document.body.classList.add('print-synopsis'); 
        if(opts.board) document.body.classList.add('print-board'); 
        if(opts.script) document.body.classList.add('print-script'); 
        if(opts.chars) document.body.classList.add('print-chars'); 
        if(opts.actors) document.body.classList.add('print-actors');
        if(opts.locs) document.body.classList.add('print-locs'); 
        if(opts.storyboard) {
            document.body.classList.add('print-storyboard');
            // Render print preview before printing
            Storyboard.renderPrintPreview('sbPrintPreview');
        }
        if(opts.crew) document.body.classList.add('print-crew');
        if(opts.breakdown) document.body.classList.add('print-breakdown'); 
        if(opts.stats) document.body.classList.add('print-stats');
        
        window.print(); 
        
        try { if(localStorage.getItem(CONFIG.themeKey) === 'dark') document.body.classList.add('dark-mode'); } catch(e) {} 
        if(state.currentRole === 'viewer') document.body.classList.add('read-only'); 
        document.body.className = document.body.className.replace(/print-\w+/g, "").trim();
    },
    
    // ========== RAPPORT DE PRODUCTION PDF ==========
    productionReport: () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = margin;
        
        const projectTitle = state.data.title || 'Projet sans titre';
        const today = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
        
        // ===== PAGE DE COUVERTURE =====
        doc.setFillColor(43, 110, 246);
        doc.rect(0, 0, pageWidth, 60, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(28);
        doc.setFont('helvetica', 'bold');
        doc.text('RAPPORT DE PRODUCTION', pageWidth / 2, 30, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Document g√©n√©r√© par Moteur', pageWidth / 2, 45, { align: 'center' });
        
        doc.setTextColor(50, 50, 50);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text(projectTitle, pageWidth / 2, 90, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text(`G√©n√©r√© le ${today}`, pageWidth / 2, 105, { align: 'center' });
        
        // Logo/Affiche si disponible
        if(state.data.poster) {
            try {
                doc.addImage(state.data.poster, 'JPEG', pageWidth/2 - 30, 115, 60, 80);
            } catch(e) {}
        }
        
        // ===== FONCTION UTILITAIRES =====
        const addSection = (title, yPos) => {
            if(yPos > pageHeight - 40) {
                doc.addPage();
                yPos = margin;
            }
            doc.setFillColor(43, 110, 246);
            doc.rect(margin, yPos, pageWidth - margin * 2, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(title, margin + 5, yPos + 7);
            doc.setTextColor(50, 50, 50);
            doc.setFont('helvetica', 'normal');
            return yPos + 15;
        };
        
        const addKeyValue = (key, value, yPos) => {
            if(yPos > pageHeight - 20) {
                doc.addPage();
                yPos = margin;
            }
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(key + ' :', margin, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(String(value || '-'), margin + 45, yPos);
            return yPos + 6;
        };
        
        const addTable = (headers, rows, yPos, colWidths) => {
            const totalWidth = pageWidth - margin * 2;
            const rowHeight = 7;
            
            if(yPos > pageHeight - 40) {
                doc.addPage();
                yPos = margin;
            }
            
            // Header
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, yPos, totalWidth, rowHeight, 'F');
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            let xPos = margin + 2;
            headers.forEach((h, i) => {
                doc.text(h, xPos, yPos + 5);
                xPos += colWidths[i];
            });
            yPos += rowHeight;
            
            // Rows
            doc.setFont('helvetica', 'normal');
            rows.forEach((row, idx) => {
                if(yPos > pageHeight - 20) {
                    doc.addPage();
                    yPos = margin;
                }
                if(idx % 2 === 1) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(margin, yPos, totalWidth, rowHeight, 'F');
                }
                xPos = margin + 2;
                row.forEach((cell, i) => {
                    const text = String(cell || '-').substring(0, 40);
                    doc.text(text, xPos, yPos + 5);
                    xPos += colWidths[i];
                });
                yPos += rowHeight;
            });
            
            return yPos + 5;
        };
        
        // ===== PAGE 2 : R√âSUM√â G√âN√âRAL =====
        doc.addPage();
        y = margin;
        
        y = addSection('üìä R√âSUM√â G√âN√âRAL', y);
        
        const scenes = state.data.scenes || [];
        const characters = state.data.characters || [];
        const actors = state.data.actors || [];
        const locations = state.data.locations || [];
        const crew = state.data.crew || [];
        const shots = state.data.shots || [];
        const expenses = state.data.expenses || [];
        const shootingDays = state.data.shootingDays || [];
        
        y = addKeyValue('Titre du projet', projectTitle, y);
        y = addKeyValue('Nombre de sc√®nes', scenes.length, y);
        y = addKeyValue('Nombre de plans (storyboard)', shots.length, y);
        y = addKeyValue('Personnages', characters.length, y);
        y = addKeyValue('Com√©diens', actors.length, y);
        y = addKeyValue('D√©cors', locations.length, y);
        y = addKeyValue('Techniciens', crew.length, y);
        y = addKeyValue('Jours de tournage pr√©vus', shootingDays.length, y);
        
        // Dur√©e estim√©e
        const totalMinutes = scenes.reduce((sum, s) => sum + (parseFloat(s.time) || 0), 0);
        y = addKeyValue('Dur√©e estim√©e', `${Math.floor(totalMinutes)} min`, y);
        
        // Budget
        const budget = state.data.budget || 0;
        const totalExpenses = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
        y = addKeyValue('Budget pr√©vu', `${budget.toLocaleString('fr-FR')} ‚Ç¨`, y);
        y = addKeyValue('D√©penses engag√©es', `${totalExpenses.toLocaleString('fr-FR')} ‚Ç¨`, y);
        y = addKeyValue('Reste disponible', `${(budget - totalExpenses).toLocaleString('fr-FR')} ‚Ç¨`, y);
        
        // Statistiques sc√®nes
        y += 5;
        y = addSection('üé¨ STATISTIQUES SC√àNES', y);
        
        const intScenes = scenes.filter(s => s.title && s.title.toUpperCase().startsWith('INT')).length;
        const extScenes = scenes.filter(s => s.title && s.title.toUpperCase().startsWith('EXT')).length;
        const dayScenes = scenes.filter(s => s.title && s.title.toUpperCase().includes('JOUR')).length;
        const nightScenes = scenes.filter(s => s.title && s.title.toUpperCase().includes('NUIT')).length;
        const finalizedScenes = scenes.filter(s => s.isFinal).length;
        
        y = addKeyValue('Int√©rieur / Ext√©rieur', `${intScenes} INT / ${extScenes} EXT`, y);
        y = addKeyValue('Jour / Nuit', `${dayScenes} JOUR / ${nightScenes} NUIT`, y);
        y = addKeyValue('Sc√®nes finalis√©es', `${finalizedScenes} / ${scenes.length}`, y);
        
        // ===== PERSONNAGES =====
        if(characters.length > 0) {
            y += 5;
            y = addSection('üé≠ PERSONNAGES', y);
            const charRows = characters.map(c => {
                const actor = actors.find(a => a.characterId === c.id);
                return [c.name, c.age || '-', c.gender || '-', actor ? actor.name : '(non cast√©)'];
            });
            y = addTable(['Personnage', '√Çge', 'Genre', 'Com√©dien'], charRows, y, [50, 25, 25, 60]);
        }
        
        // ===== COM√âDIENS =====
        if(actors.length > 0) {
            y += 5;
            y = addSection('üé¨ COM√âDIENS', y);
            const actorRows = actors.map(a => {
                const char = characters.find(c => c.id === a.characterId);
                return [a.name, char ? char.name : '-', a.phone || '-', a.email || '-'];
            });
            y = addTable(['Nom', 'R√¥le', 'T√©l√©phone', 'Email'], actorRows, y, [45, 40, 40, 55]);
        }
        
        // ===== √âQUIPE TECHNIQUE =====
        if(crew.length > 0) {
            y += 5;
            y = addSection('üë• √âQUIPE TECHNIQUE', y);
            const crewRows = crew.map(c => [c.name, c.role || '-', c.department || '-', c.phone || '-']);
            y = addTable(['Nom', 'Poste', 'D√©partement', 'T√©l√©phone'], crewRows, y, [45, 45, 40, 50]);
        }
        
        // ===== D√âCORS =====
        if(locations.length > 0) {
            y += 5;
            y = addSection('üìç D√âCORS', y);
            const locRows = locations.map(l => {
                const sceneCount = scenes.filter(s => s.locationId === l.id || (s.title && s.title.includes(l.name))).length;
                return [l.name, l.realLocation || '-', l.address || '-', sceneCount + ' sc√®ne(s)'];
            });
            y = addTable(['D√©cor', 'Lieu r√©el', 'Adresse', 'Sc√®nes'], locRows, y, [40, 45, 55, 30]);
        }
        
        // ===== PLANNING =====
        if(shootingDays.length > 0) {
            y += 5;
            y = addSection('üìÖ PLANNING DE TOURNAGE', y);
            const planRows = shootingDays.map(d => {
                const date = d.startDate ? new Date(d.startDate).toLocaleDateString('fr-FR') : '-';
                const scenesList = (d.scenes || []).map(sId => {
                    const scene = scenes.find(s => s.id === sId);
                    return scene ? `#${scenes.indexOf(scene) + 1}` : '';
                }).filter(Boolean).join(', ');
                return [d.name || 'Jour', date, d.location || '-', scenesList || '-'];
            });
            y = addTable(['Nom', 'Date', 'Lieu', 'Sc√®nes'], planRows, y, [40, 30, 50, 50]);
        }
        
        // ===== BUDGET D√âTAILL√â =====
        if(expenses.length > 0) {
            y += 5;
            y = addSection('üí∞ BUDGET & D√âPENSES', y);
            
            // Par cat√©gorie
            const byCategory = {};
            expenses.forEach(e => {
                const cat = e.category || 'Autre';
                if(!byCategory[cat]) byCategory[cat] = 0;
                byCategory[cat] += parseFloat(e.amount) || 0;
            });
            
            const budgetRows = Object.entries(byCategory).map(([cat, amount]) => [cat, amount.toLocaleString('fr-FR') + ' ‚Ç¨']);
            budgetRows.push(['TOTAL', totalExpenses.toLocaleString('fr-FR') + ' ‚Ç¨']);
            y = addTable(['Cat√©gorie', 'Montant'], budgetRows, y, [100, 70]);
        }
        
        // ===== PIED DE PAGE SUR CHAQUE PAGE =====
        const totalPages = doc.internal.getNumberOfPages();
        for(let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`${projectTitle} - Rapport de production`, margin, pageHeight - 8);
            doc.text(`Page ${i}/${totalPages}`, pageWidth - margin, pageHeight - 8, { align: 'right' });
        }
        
        // T√©l√©charger
        const filename = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'rapport') + '_production.pdf';
        doc.save(filename);
        
        Utils.toast('Rapport de production export√© !', 'success');
        History.log('EXPORT', 'Rapport de production PDF g√©n√©r√©');
    },
    
    // ========== EXPORT ZIP COMPLET ==========
    exportZIP: async () => {
        Utils.toast('Pr√©paration de l\'export ZIP...', 'info');
        
        // V√©rifier si JSZip est disponible, sinon le charger
        if(typeof JSZip === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.onload = () => Exporter.doExportZIP();
            script.onerror = () => Utils.toast('Erreur de chargement de JSZip', 'error');
            document.head.appendChild(script);
        } else {
            Exporter.doExportZIP();
        }
    },
    
    doExportZIP: async () => {
        try {
            const zip = new JSZip();
            const projectTitle = state.data.title || 'projet';
            const folderName = projectTitle.replace(/[^a-z0-9]/gi, '_');
            const folder = zip.folder(folderName);
            const pdfFolder = folder.folder('PDF');
            const csvFolder = folder.folder('CSV');
            
            Utils.toast('G√©n√©ration des fichiers...', 'info');
            
            // 1. Donn√©es JSON du projet (pour r√©import dans Moteur)
            folder.file('projet_data.json', JSON.stringify(state.data, null, 2));
            
            // ===== G√âN√âRATION DES PDFs =====
            const { jsPDF } = window.jspdf;
            
            // PDF 1 : Sc√©nario
            if(state.data.scenes && state.data.scenes.length > 0) {
                const docScenario = new jsPDF('p', 'mm', 'a4');
                const pw = docScenario.internal.pageSize.getWidth();
                const ph = docScenario.internal.pageSize.getHeight();
                let yPos = 20;
                
                // Page de titre
                docScenario.setFontSize(24);
                docScenario.setFont('helvetica', 'bold');
                docScenario.text(projectTitle, pw/2, 60, { align: 'center' });
                docScenario.setFontSize(12);
                docScenario.setFont('helvetica', 'normal');
                docScenario.text('Sc√©nario', pw/2, 75, { align: 'center' });
                docScenario.addPage();
                
                state.data.scenes.forEach((scene, idx) => {
                    if(yPos > ph - 30) { docScenario.addPage(); yPos = 20; }
                    docScenario.setFontSize(12);
                    docScenario.setFont('helvetica', 'bold');
                    docScenario.text(`${scene.title || 'Sc√®ne ' + (idx+1)}`, 15, yPos);
                    yPos += 8;
                    
                    if(scene.scriptContent) {
                        docScenario.setFontSize(10);
                        docScenario.setFont('helvetica', 'normal');
                        const text = scene.scriptContent.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ');
                        const lines = docScenario.splitTextToSize(text, pw - 30);
                        lines.forEach(line => {
                            if(yPos > ph - 15) { docScenario.addPage(); yPos = 20; }
                            docScenario.text(line, 15, yPos);
                            yPos += 5;
                        });
                    }
                    yPos += 10;
                });
                pdfFolder.file('Scenario.pdf', docScenario.output('blob'));
            }
            
            // PDF 2 : S√©quencier
            if(state.data.scenes && state.data.scenes.length > 0) {
                const docSeq = new jsPDF('l', 'mm', 'a4');
                const pw = docSeq.internal.pageSize.getWidth();
                let yPos = 25;
                
                docSeq.setFillColor(43, 110, 246);
                docSeq.rect(0, 0, pw, 15, 'F');
                docSeq.setTextColor(255, 255, 255);
                docSeq.setFontSize(14);
                docSeq.setFont('helvetica', 'bold');
                docSeq.text(`S√âQUENCIER - ${projectTitle}`, 10, 10);
                
                docSeq.setTextColor(0, 0, 0);
                docSeq.setFontSize(8);
                docSeq.setFont('helvetica', 'bold');
                docSeq.text('N¬∞', 10, yPos);
                docSeq.text('Intitul√©', 25, yPos);
                docSeq.text('Dur√©e', 120, yPos);
                docSeq.text('Personnages', 140, yPos);
                docSeq.text('R√©sum√©', 200, yPos);
                yPos += 6;
                
                docSeq.setFont('helvetica', 'normal');
                state.data.scenes.forEach((scene, idx) => {
                    if(yPos > 190) { docSeq.addPage(); yPos = 20; }
                    docSeq.text(`${idx + 1}`, 10, yPos);
                    docSeq.text((scene.title || '').substring(0, 40), 25, yPos);
                    docSeq.text(scene.time || '-', 120, yPos);
                    docSeq.text((scene.perso || '').substring(0, 25), 140, yPos);
                    docSeq.text((scene.resume || '').substring(0, 50), 200, yPos);
                    yPos += 6;
                });
                pdfFolder.file('Sequencier.pdf', docSeq.output('blob'));
            }
            
            // PDF 3 : √âquipe
            if(state.data.crew && state.data.crew.length > 0) {
                const docCrew = new jsPDF('p', 'mm', 'a4');
                const pw = docCrew.internal.pageSize.getWidth();
                let yPos = 25;
                
                docCrew.setFillColor(43, 110, 246);
                docCrew.rect(0, 0, pw, 15, 'F');
                docCrew.setTextColor(255, 255, 255);
                docCrew.setFontSize(14);
                docCrew.text(`√âQUIPE - ${projectTitle}`, 10, 10);
                
                const depts = {};
                state.data.crew.forEach(c => {
                    const d = c.department || 'Autre';
                    if(!depts[d]) depts[d] = [];
                    depts[d].push(c);
                });
                
                docCrew.setTextColor(0, 0, 0);
                Object.keys(depts).forEach(dept => {
                    if(yPos > 270) { docCrew.addPage(); yPos = 20; }
                    docCrew.setFontSize(11);
                    docCrew.setFont('helvetica', 'bold');
                    docCrew.text(dept.toUpperCase(), 10, yPos);
                    yPos += 6;
                    
                    docCrew.setFontSize(9);
                    docCrew.setFont('helvetica', 'normal');
                    depts[dept].forEach(c => {
                        if(yPos > 280) { docCrew.addPage(); yPos = 20; }
                        docCrew.text(`${c.name || ''} - ${c.role || ''}`, 15, yPos);
                        if(c.phone || c.email) docCrew.text(`${c.phone || ''} ${c.email || ''}`, 100, yPos);
                        yPos += 5;
                    });
                    yPos += 5;
                });
                pdfFolder.file('Equipe.pdf', docCrew.output('blob'));
            }
            
            // PDF 4 : Budget
            if(state.data.expenses && state.data.expenses.length > 0) {
                const docBudget = new jsPDF('p', 'mm', 'a4');
                const pw = docBudget.internal.pageSize.getWidth();
                let yPos = 25;
                
                docBudget.setFillColor(43, 110, 246);
                docBudget.rect(0, 0, pw, 15, 'F');
                docBudget.setTextColor(255, 255, 255);
                docBudget.setFontSize(14);
                docBudget.text(`BUDGET - ${projectTitle}`, 10, 10);
                
                const budget = state.data.budget || 0;
                const totalSpent = state.data.expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
                
                docBudget.setTextColor(0, 0, 0);
                docBudget.setFontSize(11);
                docBudget.text(`Budget total : ${budget.toLocaleString('fr-FR')} ‚Ç¨`, 10, yPos);
                docBudget.text(`D√©pens√© : ${totalSpent.toLocaleString('fr-FR')} ‚Ç¨`, 80, yPos);
                docBudget.text(`Reste : ${(budget - totalSpent).toLocaleString('fr-FR')} ‚Ç¨`, 140, yPos);
                yPos += 10;
                
                docBudget.setFontSize(8);
                docBudget.setFont('helvetica', 'bold');
                docBudget.text('Description', 10, yPos);
                docBudget.text('Cat√©gorie', 80, yPos);
                docBudget.text('Montant', 130, yPos);
                docBudget.text('Statut', 160, yPos);
                yPos += 6;
                
                docBudget.setFont('helvetica', 'normal');
                state.data.expenses.forEach(e => {
                    if(yPos > 280) { docBudget.addPage(); yPos = 20; }
                    docBudget.text((e.description || '').substring(0, 35), 10, yPos);
                    docBudget.text((e.category || '').substring(0, 20), 80, yPos);
                    docBudget.text(`${(e.amount || 0).toLocaleString('fr-FR')} ‚Ç¨`, 130, yPos);
                    docBudget.text(e.status || '', 160, yPos);
                    yPos += 5;
                });
                pdfFolder.file('Budget.pdf', docBudget.output('blob'));
            }
            
            // PDF 5 : Planning
            if(state.data.shootingDays && state.data.shootingDays.length > 0) {
                const docPlanning = new jsPDF('l', 'mm', 'a4');
                const pw = docPlanning.internal.pageSize.getWidth();
                let yPos = 25;
                
                docPlanning.setFillColor(43, 110, 246);
                docPlanning.rect(0, 0, pw, 15, 'F');
                docPlanning.setTextColor(255, 255, 255);
                docPlanning.setFontSize(14);
                docPlanning.text(`PLANNING - ${projectTitle}`, 10, 10);
                
                docPlanning.setTextColor(0, 0, 0);
                docPlanning.setFontSize(8);
                docPlanning.setFont('helvetica', 'bold');
                docPlanning.text('Jour', 10, yPos);
                docPlanning.text('Date', 50, yPos);
                docPlanning.text('Lieu', 90, yPos);
                docPlanning.text('Sc√®nes', 180, yPos);
                yPos += 6;
                
                docPlanning.setFont('helvetica', 'normal');
                state.data.shootingDays.forEach((d, idx) => {
                    if(yPos > 190) { docPlanning.addPage(); yPos = 20; }
                    docPlanning.text(`J${idx + 1} - ${d.name || ''}`, 10, yPos);
                    docPlanning.text(d.startDate || '', 50, yPos);
                    docPlanning.text((d.location || '').substring(0, 40), 90, yPos);
                    const scenesList = (d.scenes || []).map(sId => {
                        const i = state.data.scenes?.findIndex(s => s.id === sId);
                        return i >= 0 ? `#${i + 1}` : '';
                    }).filter(Boolean).join(', ');
                    docPlanning.text(scenesList.substring(0, 50), 180, yPos);
                    yPos += 6;
                });
                pdfFolder.file('Planning.pdf', docPlanning.output('blob'));
            }
            
            // PDF 6 : Personnages & Com√©diens
            if((state.data.characters && state.data.characters.length > 0) || (state.data.actors && state.data.actors.length > 0)) {
                const docCasting = new jsPDF('p', 'mm', 'a4');
                const pw = docCasting.internal.pageSize.getWidth();
                let yPos = 25;
                
                docCasting.setFillColor(43, 110, 246);
                docCasting.rect(0, 0, pw, 15, 'F');
                docCasting.setTextColor(255, 255, 255);
                docCasting.setFontSize(14);
                docCasting.text(`CASTING - ${projectTitle}`, 10, 10);
                
                docCasting.setTextColor(0, 0, 0);
                
                if(state.data.characters && state.data.characters.length > 0) {
                    docCasting.setFontSize(11);
                    docCasting.setFont('helvetica', 'bold');
                    docCasting.text('PERSONNAGES', 10, yPos);
                    yPos += 6;
                    
                    docCasting.setFontSize(9);
                    docCasting.setFont('helvetica', 'normal');
                    state.data.characters.forEach(c => {
                        if(yPos > 280) { docCasting.addPage(); yPos = 20; }
                        const actor = state.data.actors?.find(a => a.characterId === c.id);
                        docCasting.text(`${c.name || 'Sans nom'}${c.age ? ' (' + c.age + ')' : ''}`, 15, yPos);
                        if(actor) docCasting.text(`‚Üí ${actor.name}`, 80, yPos);
                        yPos += 5;
                        if(c.description) {
                            const lines = docCasting.splitTextToSize(c.description, pw - 30);
                            lines.slice(0, 2).forEach(line => {
                                docCasting.text(line, 20, yPos);
                                yPos += 4;
                            });
                        }
                        yPos += 2;
                    });
                }
                pdfFolder.file('Casting.pdf', docCasting.output('blob'));
            }
            
            // PDF 7 : D√©cors
            if(state.data.locations && state.data.locations.length > 0) {
                const docDecors = new jsPDF('p', 'mm', 'a4');
                const pw = docDecors.internal.pageSize.getWidth();
                let yPos = 25;
                
                docDecors.setFillColor(43, 110, 246);
                docDecors.rect(0, 0, pw, 15, 'F');
                docDecors.setTextColor(255, 255, 255);
                docDecors.setFontSize(14);
                docDecors.text(`D√âCORS - ${projectTitle}`, 10, 10);
                
                docDecors.setTextColor(0, 0, 0);
                docDecors.setFontSize(9);
                
                state.data.locations.forEach(loc => {
                    if(yPos > 270) { docDecors.addPage(); yPos = 20; }
                    docDecors.setFont('helvetica', 'bold');
                    docDecors.text(loc.name || 'Sans nom', 10, yPos);
                    yPos += 5;
                    docDecors.setFont('helvetica', 'normal');
                    if(loc.realLocation) { docDecors.text(`Lieu r√©el : ${loc.realLocation}`, 15, yPos); yPos += 4; }
                    if(loc.address) { docDecors.text(`Adresse : ${loc.address}`, 15, yPos); yPos += 4; }
                    if(loc.contact) { docDecors.text(`Contact : ${loc.contact}`, 15, yPos); yPos += 4; }
                    yPos += 4;
                });
                pdfFolder.file('Decors.pdf', docDecors.output('blob'));
            }
            
            // ===== FICHIERS SOURCES (Fountain, CSV) =====
            
            // Fountain du sc√©nario
            if(state.data.scenes && state.data.scenes.length > 0) {
                let fountain = `Title: ${state.data.title || 'Sans titre'}\n`;
                const meta = state.data.scriptMeta || {};
                if(meta.author) fountain += `Author: ${meta.author}\n`;
                if(meta.draft) fountain += `Draft date: ${meta.draft}\n`;
                fountain += '\n';
                
                state.data.scenes.forEach(scene => {
                    fountain += `\n${scene.title}\n\n`;
                    if(scene.scriptContent) {
                        fountain += scene.scriptContent.replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ') + '\n';
                    }
                });
                folder.file('scenario.fountain', fountain);
            }
            
            // CSVs dans sous-dossier
            if(state.data.characters && state.data.characters.length > 0) {
                let csv = 'Nom;Age;Genre;Description\n';
                state.data.characters.forEach(c => {
                    csv += `"${c.name || ''}";"${c.age || ''}";"${c.gender || ''}";"${(c.description || '').replace(/"/g, '""')}"\n`;
                });
                csvFolder.file('personnages.csv', csv);
            }
            
            if(state.data.actors && state.data.actors.length > 0) {
                let csv = 'Nom;Role;Email;Telephone;Adresse\n';
                state.data.actors.forEach(a => {
                    const char = state.data.characters?.find(c => c.id === a.characterId);
                    csv += `"${a.name || ''}";"${char?.name || ''}";"${a.email || ''}";"${a.phone || ''}";"${a.address || ''}"\n`;
                });
                csvFolder.file('comediens.csv', csv);
            }
            
            if(state.data.crew && state.data.crew.length > 0) {
                let csv = 'Nom;Poste;Departement;Email;Telephone\n';
                state.data.crew.forEach(c => {
                    csv += `"${c.name || ''}";"${c.role || ''}";"${c.department || ''}";"${c.email || ''}";"${c.phone || ''}"\n`;
                });
                csvFolder.file('equipe.csv', csv);
            }
            
            if(state.data.locations && state.data.locations.length > 0) {
                let csv = 'Decor;Lieu_Reel;Adresse;Contact;Notes\n';
                state.data.locations.forEach(l => {
                    csv += `"${l.name || ''}";"${l.realLocation || ''}";"${l.address || ''}";"${l.contact || ''}";"${(l.notes || '').replace(/"/g, '""')}"\n`;
                });
                csvFolder.file('decors.csv', csv);
            }
            
            if(state.data.expenses && state.data.expenses.length > 0) {
                let csv = 'Description;Montant;Categorie;Statut;Date\n';
                state.data.expenses.forEach(e => {
                    csv += `"${e.description || ''}";"${e.amount || 0}";"${e.category || ''}";"${e.status || ''}";"${e.date || ''}"\n`;
                });
                csvFolder.file('budget_depenses.csv', csv);
            }
            
            if(state.data.shootingDays && state.data.shootingDays.length > 0) {
                let csv = 'Nom;Date;Lieu;Adresse;Scenes\n';
                state.data.shootingDays.forEach(d => {
                    const scenesList = (d.scenes || []).map(sId => {
                        const idx = state.data.scenes?.findIndex(s => s.id === sId);
                        return idx >= 0 ? `#${idx + 1}` : '';
                    }).filter(Boolean).join(', ');
                    csv += `"${d.name || ''}";"${d.startDate || ''}";"${d.location || ''}";"${d.address || ''}";"${scenesList}"\n`;
                });
                csvFolder.file('planning.csv', csv);
            }
            
            if(state.data.scenes && state.data.scenes.length > 0) {
                let csv = 'Numero;Titre;Duree;Personnages;Resume;Statut\n';
                state.data.scenes.forEach((s, idx) => {
                    csv += `"${idx + 1}";"${s.title || ''}";"${s.time || ''}";"${s.perso || ''}";"${(s.resume || '').replace(/"/g, '""')}";"${s.isFinal ? 'Final' : 'Brouillon'}"\n`;
                });
                csvFolder.file('sequencier.csv', csv);
            }
            
            if(state.data.resources && state.data.resources.length > 0) {
                let csv = 'Nom;Type;Description;Proprietaire\n';
                state.data.resources.forEach(r => {
                    csv += `"${r.name || ''}";"${r.type || ''}";"${(r.description || '').replace(/"/g, '""')}";"${r.owner || ''}"\n`;
                });
                csvFolder.file('ressources.csv', csv);
            }
            
            // README
            const readme = `# ${state.data.title || 'Projet'}

Export g√©n√©r√© par Moteur le ${new Date().toLocaleDateString('fr-FR')}

## üìÇ Structure de l'archive

### Racine
- **projet_data.json** : Donn√©es compl√®tes ‚Üí Pour r√©importer dans Moteur
- **scenario.fountain** : Sc√©nario au format Fountain (Final Draft, Highland...)
- **README.md** : Ce fichier

### üìÑ Dossier PDF/
Documents pr√™ts √† imprimer :
- Scenario.pdf : Sc√©nario complet
- Sequencier.pdf : Tableau des sc√®nes
- Casting.pdf : Personnages et com√©diens
- Equipe.pdf : √âquipe technique par d√©partement
- Decors.pdf : Liste des d√©cors avec adresses
- Budget.pdf : D√©penses et budget
- Planning.pdf : Jours de tournage

### üìä Dossier CSV/
Fichiers tableur (Excel, Calc, Numbers) :
- personnages.csv, comediens.csv, equipe.csv
- decors.csv, budget_depenses.csv
- planning.csv, sequencier.csv, ressources.csv

## üîÑ R√©importer dans Moteur

Menu **Fichier > Importer > Importer un projet (JSON)**
puis s√©lectionner **projet_data.json**

## üìà Statistiques

- Sc√®nes : ${state.data.scenes?.length || 0}
- Personnages : ${state.data.characters?.length || 0}
- Com√©diens : ${state.data.actors?.length || 0}
- Techniciens : ${state.data.crew?.length || 0}
- D√©cors : ${state.data.locations?.length || 0}
- Jours de tournage : ${state.data.shootingDays?.length || 0}

---
G√©n√©r√© par Moteur - moteur.film
`;
            folder.file('README.md', readme);
            
            // G√©n√©rer le ZIP
            const content = await zip.generateAsync({ type: 'blob' });
            
            // T√©l√©charger
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `${folderName}_export.zip`;
            link.click();
            URL.revokeObjectURL(link.href);
            
            Utils.toast('Export ZIP g√©n√©r√© !', 'success');
            History.log('EXPORT', 'Export ZIP complet g√©n√©r√©');
            
        } catch(err) {
            console.error('Erreur export ZIP:', err);
            Utils.toast('Erreur lors de l\'export ZIP', 'error');
        }
    }
};

  const Importer = {
      rawLines: [],
      marginMap: {}, 
      steps: [
          { key: 'sc-heading', label: "1. Surlignez une EN-T√äTE DE SC√àNE (ex: INT. SALON - JOUR)" },
          { key: 'sc-action', label: "2. Surlignez une ligne d'ACTION" },
          { key: 'sc-perso', label: "3. Surlignez un NOM DE PERSONNAGE" },
          { key: 'sc-dial', label: "4. Surlignez un DIALOGUE" },
          { key: 'sc-paren', label: "5. Surlignez une DIDASCALIE" }, 
          { key: 'sc-trans', label: "6. Surlignez une TRANSITION (ex: CUT TO:)" },
          { key: 'cleanup', label: "7. NETTOYAGE : S√©lectionnez du texte ind√©sirable (ex: 'Page 1', '(SUITE)') pour le supprimer partout." }
      ],
      currentStepIndex: 0,
      selectedCleanupText: "", 

      trigger: () => els.importInput.click(),

      handleFileSelect: (e) => {
          const file = e.target.files[0];
          if(!file) return;
          if (file.name.toLowerCase().endsWith('.pdf')) { Importer.parsePDF(file); } 
          else if (file.name.toLowerCase().endsWith('.fdx') || file.name.toLowerCase().endsWith('.xml')) { 
             const reader = new FileReader(); reader.onload = (ev) => Importer.parseFDX(ev.target.result); reader.readAsText(file); 
          } else { Utils.toast("Format non support√©.", "error"); }
          e.target.value = ''; 
      },

      parsePDF: async (file) => {
          try {
              els.projectList.innerHTML = '<div style="padding:20px;">Lecture PDF (Patience, chargement complet)...</div>';
              const arrayBuffer = await file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
              let allLines = [];
              
              for (let i = 1; i <= pdf.numPages; i++) {
                  const page = await pdf.getPage(i);
                  const content = await page.getTextContent();
                  let items = content.items.map(item => ({ str: item.str, x: Math.round(item.transform[4]), y: Math.round(item.transform[5]) }));
                  items.sort((a, b) => (b.y - a.y) || (a.x - b.x));
                  
                  let currentY = null, lineText = [], lineX = 0;
                  items.forEach(item => {
                      if (currentY === null || Math.abs(item.y - currentY) < 4) {
                          lineText.push(item.str);
                          if(lineX === 0) lineX = item.x; 
                      } else {
                          if (lineText.length > 0) allLines.push({ text: lineText.join('').trim(), x: lineX });
                          lineText = [item.str]; lineX = item.x; currentY = item.y;
                      }
                      currentY = item.y;
                  });
                  if (lineText.length > 0) allLines.push({ text: lineText.join('').trim(), x: lineX });
              }
              
              Importer.rawLines = allLines;
              Importer.startVisualWizard();

          } catch (err) { console.error(err); Utils.toast("Erreur PDF : " + err.message, "error"); location.reload(); }
      },

      startVisualWizard: () => {
          els.visualWizard.style.display = 'flex';
          Importer.marginMap = {};
          Importer.currentStepIndex = 0;
          
          if(!window.cleanerListenerAttached) {
             document.addEventListener('mouseup', Importer.handleSelection);
             els.cleanupToast.addEventListener('click', Importer.performCleanup);
             window.cleanerListenerAttached = true;
          }
          
          Importer.renderWizardLines();
          Importer.updateWizardUI();
      },

      renderWizardLines: () => {
          els.wizPageView.innerHTML = '';
          Importer.rawLines.slice(0, 2000).forEach((l, idx) => {
              if(!l.text) return;
              const div = document.createElement('div');
              div.className = 'wiz-line';
              div.innerText = l.text;
              div.style.paddingLeft = (l.x / 2) + 'px';
              div.dataset.x = l.x;
              div.dataset.idx = idx;
              div.onclick = (e) => {
                  const sel = window.getSelection();
                  if(sel.toString().length > 0) return;
                  Importer.handleLineClick(l.x);
              };
              els.wizPageView.appendChild(div);
          });
      },

      handleSelection: () => {
          const step = Importer.steps[Importer.currentStepIndex];
          if (!step || step.key !== 'cleanup') {
              els.cleanupToast.style.display = 'none';
              return;
          }

          const sel = window.getSelection();
          const text = sel.toString().trim();
          const wizard = document.getElementById('visual-wizard');
          
          if (wizard.style.display === 'flex' && text.length > 0 && wizard.contains(sel.anchorNode)) {
              Importer.selectedCleanupText = text;
              els.cleanupToast.innerHTML = `üóëÔ∏è Supprimer partout : "<b>${text.substring(0, 20)}${text.length>20?'...':''}</b>"`;
              els.cleanupToast.style.display = 'block';
          } else {
              els.cleanupToast.style.display = 'none';
          }
      },

      performCleanup: () => {
          if(!Importer.selectedCleanupText) return;
          const target = Importer.selectedCleanupText;
          const escaped = target.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(escaped, 'g');
          
          let count = 0;
          Importer.rawLines = Importer.rawLines.map(line => {
              if(line.text.includes(target)) {
                  const newText = line.text.replace(regex, '').trim();
                  if(newText !== line.text) count++;
                  return { ...line, text: newText };
              }
              return line;
          }).filter(line => line.text.length > 0);
          
          Utils.toast(`${count} occurrences supprim√©es !`, 'success');
          els.cleanupToast.style.display = 'none';
          window.getSelection().removeAllRanges();
          Importer.renderWizardLines();
      },

      updateWizardUI: () => {
          const step = Importer.steps[Importer.currentStepIndex];
          
          if(!step) { Importer.finishImport(); return; }
          
          els.wizTitle.innerText = `√âtape ${Importer.currentStepIndex + 1}/${Importer.steps.length}`;
          els.wizTitle.style.color = "var(--primary)";
          els.wizDesc.innerText = step.label;
          els.wizDesc.style.fontWeight = "bold";
          els.wizDesc.style.fontSize = "1.1rem";
          
          document.querySelectorAll('.wiz-line').forEach(l => l.classList.remove('selected-ref'));

          if (step.key === 'cleanup') {
              els.wizSkip.innerText = "‚úÖ Terminer l'importation";
              els.wizSkip.style.background = "var(--success)";
              els.wizSkip.style.color = "white";
              els.wizSkip.style.fontWeight = "bold";
          } else {
              els.wizSkip.innerText = "Sauter cette √©tape";
              els.wizSkip.style.background = "var(--border)";
              els.wizSkip.style.color = "var(--text-main)";
              els.wizSkip.style.fontWeight = "normal";
          }
      },

      handleLineClick: (xVal) => {
          const step = Importer.steps[Importer.currentStepIndex];
          if(!step) return;

          if(step.key === 'cleanup') return;

          Importer.marginMap[xVal] = step.key;
          const matches = document.querySelectorAll(`.wiz-line[data-x="${xVal}"]`);
          matches.forEach(el => el.classList.add('selected-ref'));
          setTimeout(() => { Importer.nextStep(); }, 400);
      },

      nextStep: (skip = false) => {
          Importer.currentStepIndex++;
          Importer.updateWizardUI();
      },
      
      cancel: () => { els.visualWizard.style.display = 'none'; UI.renderDashboard(); },

      finishImport: () => {
          els.visualWizard.style.display = 'none';
          const newData = Store.getEmpty();
          newData.title = "Import Complet";
          
          let currentScene = null;
          
          const getType = (x) => {
             const definedMargins = Object.keys(Importer.marginMap).map(Number);
             if(definedMargins.length === 0) return 'sc-action'; 
             const closest = definedMargins.reduce((prev, curr) => Math.abs(curr - x) < Math.abs(prev - x) ? curr : prev);
             if(Math.abs(closest - x) > 20) return 'sc-action'; 
             return Importer.marginMap[closest];
          };

          Importer.rawLines.forEach((l, globalIdx) => {
              const text = l.text;
              if(!text) return; 

              let type = getType(l.x);
              
              // Les didascalies sont UNIQUEMENT d√©tect√©es par les parenth√®ses, pas par la marge
              if(type === 'sc-paren' && !/^\(.*\)$/.test(text.trim())) {
                  type = 'sc-dial'; // Si ce n'est pas entre parenth√®ses, c'est probablement un dialogue
              }
              
              if(/^(INT\.|EXT\.|I\/E)/i.test(text)) type = 'sc-heading';

              if (type === 'sc-heading') {
                  if (currentScene) {
                      currentScene.time = Utils.estimateTime(currentScene.scriptContent);
                      newData.scenes.push(currentScene);
                  }
                  
                  let cleanTitle = text.replace(/^\d+[\.\-\s]*/, '').toUpperCase();

						currentScene = { 
					id: Utils.generateUniqueId(),
                      title: cleanTitle, 
                      time: "0", 
                      perso: "", 
                      resume: "", 
                      scriptContent: "", 
                      breakdown: {}, 
                      tag_id: 't1' 
                  };
                  
                  let rawLoc = cleanTitle.replace(/^(\d+)?\s*(INT\.|EXT\.|I\/E)\s*/i, '').split(/[-‚Äì]/)[0].trim();
                  if(rawLoc && !newData.locations.find(x=>x.name===rawLoc)) newData.locations.push({name: rawLoc, desc:"", group_id:""});
                  
              } else if (currentScene) {
                  let htmlClass = type || 'sc-action';

                  // DETECTION AUTOMATIQUE DIDASCALIE V62
                  if (/^\(.*\)$/.test(text.trim())) {
                      htmlClass = 'sc-paren';
                  }
                  
                  if(htmlClass === 'sc-perso') {
                      const rawName = text.replace(/\(.*\)/, '').trim().toUpperCase();
                      if(rawName.length > 1) {
                          if(!newData.characters.find(c=>c.name===rawName)) newData.characters.push({name: rawName, bio:"", group_id:""});
                          
                          const currentPersos = currentScene.perso.split(',').map(s => s.trim()).filter(s => s);
                          if(!currentPersos.includes(rawName)) {
                              currentPersos.push(rawName);
                              currentScene.perso = currentPersos.join(', ');
                          }
                      }
                  }
                  
                  currentScene.scriptContent += `<div class="${htmlClass}">${Utils.escape(text)}</div>`;
              }
          });
          
          if(currentScene) {
              currentScene.time = Utils.estimateTime(currentScene.scriptContent);
              newData.scenes.push(currentScene);
          }
          
          Store.createNewProjectFromImport(newData);
      },

      parseFDX: (xmlText) => {
          const parser = new DOMParser(); const xmlDoc = parser.parseFromString(xmlText, "text/xml"); const newData = Store.getEmpty();
          const titleTag = xmlDoc.querySelector('Title Page Title'); newData.title = (titleTag && titleTag.textContent) ? "Import: " + titleTag.textContent.trim() : "Projet FDX";
          const paragraphs = xmlDoc.getElementsByTagName("Paragraph"); let currentScene = null;
          for (let i = 0; i < paragraphs.length; i++) {
              const p = paragraphs[i]; const type = p.getAttribute("Type");
              let text = ""; const texts = p.getElementsByTagName("Text"); for(let t=0; t<texts.length; t++) text += texts[t].textContent; text = text.trim(); if(!text) continue;
              if (type === "Scene Heading") {
                  if (currentScene) newData.scenes.push(currentScene);
                  let cleanTitle = text.replace(/^\d+[\.\-\s]*/, '').toUpperCase();
                  currentScene = { id: Utils.generateUniqueId(), title: cleanTitle, time: "0", perso: "", resume: "", scriptContent: "", breakdown: {}, tag_id: 't1' };
              } else if (currentScene) {
                  let htmlClass = "sc-action";
                  if (type === "Character") htmlClass = "sc-perso"; else if (type === "Dialogue") htmlClass = "sc-dial"; else if (type === "Parenthetical") htmlClass = "sc-paren"; else if (type === "Transition") htmlClass = "sc-trans";
                  if(htmlClass === "sc-perso") {
                       const charName = text.replace(/\(.*\)/, '').trim().toUpperCase();
                       if (!currentScene.perso.includes(charName)) currentScene.perso = currentScene.perso ? currentScene.perso + ", " + charName : charName;
                  }
                  currentScene.scriptContent += `<div class="${htmlClass}">${Utils.escape(text)}</div>`;
              }
          }
          if (currentScene) newData.scenes.push(currentScene);
          Store.createNewProjectFromImport(newData);
      }
  };

// --- MODULE EXPENSES V88 ---

// ========== HISTORIQUE DES MODIFICATIONS ==========
// ========== GESTION DES CONTRATS ==========
const Contracts = {
    currentType: 'image',
    selectedPerson: null,
    selectedPersonType: null,
    
    // Ouvrir la modale de g√©n√©ration de contrat
    openModal: (personType = null, personIdx = null) => {
        if(!state.currentProjectId) {
            Utils.toast('Ouvrez un projet d\'abord', 'warning');
            return;
        }
        
        // Pr√©-s√©lectionner si on vient d'une fiche
        if(personType && personIdx !== null) {
            Contracts.selectedPersonType = personType;
            const list = personType === 'actor' ? state.data.actors : state.data.crew;
            Contracts.selectedPerson = list[personIdx];
        } else {
            Contracts.selectedPerson = null;
            Contracts.selectedPersonType = null;
        }
        
        const modal = document.createElement('div');
        modal.className = 'contracts-modal';
        modal.id = 'contracts-modal';
        modal.onclick = (e) => { if(e.target === modal) Contracts.closeModal(); };
        
        modal.innerHTML = `
            <div class="contracts-box">
                <div class="contracts-header">
                    <h3>üìù G√©n√©ration de contrat</h3>
                    <button class="history-close-btn" onclick="app.Contracts.closeModal()">‚úï</button>
                </div>
                <div class="contracts-content">
                    <div class="contracts-tabs">
                        <div class="contracts-tab active" data-type="image" onclick="app.Contracts.switchTab('image')">üì∏ Droit √† l'image</div>
                        <div class="contracts-tab" data-type="cddu" onclick="app.Contracts.switchTab('cddu')">üìã CDDU (Intermittent¬∑e)</div>
                        <div class="contracts-tab" data-type="prestation" onclick="app.Contracts.switchTab('prestation')">üìÑ Prestation (Auto-entrepreneur)</div>
                        <div class="contracts-tab" data-type="benevole" onclick="app.Contracts.switchTab('benevole')">‚ù§Ô∏è Accord B√©n√©vole</div>
                    </div>
                    <div id="contract-form-container">
                        ${Contracts.renderForm('image')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    closeModal: () => {
        const modal = document.getElementById('contracts-modal');
        if(modal) modal.remove();
        Contracts.selectedPerson = null;
        Contracts.selectedPersonType = null;
    },
    
    switchTab: (type) => {
        Contracts.currentType = type;
        document.querySelectorAll('.contracts-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.type === type);
        });
        document.getElementById('contract-form-container').innerHTML = Contracts.renderForm(type);
    },
    
    renderForm: (type) => {
        const actors = (state.data.actors || []).filter(a => a.name);
        const crew = (state.data.crew || []).filter(c => c.name);
        const project = state.data.presentation || {};
        
        let personListHTML = '';
        
        if(type === 'cddu') {
            // Filtrer intermittents
            const intermittents = [
                ...actors.filter(a => a.professionalStatus === 'intermittent').map(a => ({...a, _type: 'actor'})),
                ...crew.filter(c => c.professionalStatus === 'intermittent').map(c => ({...c, _type: 'crew'}))
            ];
            personListHTML = Contracts.renderPersonList(intermittents, 'intermittent');
        } else if(type === 'prestation') {
            // Filtrer micro-entrepreneurs
            const micros = [
                ...actors.filter(a => a.professionalStatus === 'micro-entrepreneur').map(a => ({...a, _type: 'actor'})),
                ...crew.filter(c => c.professionalStatus === 'micro-entrepreneur').map(c => ({...c, _type: 'crew'}))
            ];
            personListHTML = Contracts.renderPersonList(micros, 'micro-entrepreneur');
        } else if(type === 'benevole') {
            // Filtrer b√©n√©voles
            const benevoles = [
                ...actors.filter(a => a.collabType === 'benevole').map(a => ({...a, _type: 'actor'})),
                ...crew.filter(c => c.collabType === 'benevole').map(c => ({...c, _type: 'crew'}))
            ];
            personListHTML = Contracts.renderPersonList(benevoles, 'benevole');
        } else {
            // Droit √† l'image - tous
            const all = [
                ...actors.map(a => ({...a, _type: 'actor'})),
                ...crew.map(c => ({...c, _type: 'crew'}))
            ];
            personListHTML = Contracts.renderPersonList(all, 'all');
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        return `
            <div class="contract-form">
                <h4 style="margin:0 0 15px;">1. S√©lectionner la personne</h4>
                <div class="person-select-list">
                    ${personListHTML || '<p style="color:var(--text-sec);text-align:center;padding:20px;">Aucune personne avec ce statut. Configurez le statut dans les fiches Com√©dien¬∑ne¬∑s ou √âquipe.</p>'}
                </div>
                
                <h4 style="margin:20px 0 15px;">2. Informations du contrat</h4>
                <div class="contract-form-row">
                    <div class="contract-form-group">
                        <label>Date de d√©but</label>
                        <input type="date" id="contract-date-start" value="${project.dateShootingStart || today}">
                    </div>
                    <div class="contract-form-group">
                        <label>Date de fin</label>
                        <input type="date" id="contract-date-end" value="${project.dateShootingEnd || today}">
                    </div>
                    <div class="contract-form-group">
                        <label>Lieu de travail</label>
                        <input type="text" id="contract-lieu" value="${project.city || ''}" placeholder="Ville de tournage">
                    </div>
                </div>
                ${type === 'cddu' ? `
                <div class="contract-form-row">
                    <div class="contract-form-group">
                        <label>Convention collective</label>
                        <select id="contract-convention">
                            <option value="Production cin√©matographique">Production cin√©matographique</option>
                            <option value="Production audiovisuelle">Production audiovisuelle</option>
                            <option value="Spectacle vivant">Spectacle vivant</option>
                            <option value="Prestation technique">Prestation technique</option>
                        </select>
                    </div>
                    <div class="contract-form-group">
                        <label>Dur√©e totale estim√©e (heures)</label>
                        <input type="number" id="contract-heures" value="35" placeholder="35">
                    </div>
                </div>
                ` : ''}
                ${type === 'image' ? `
                <div class="contract-form-row">
                    <div class="contract-form-group">
                        <label>Type d'utilisation</label>
                        <select id="contract-usage">
                            <option value="Tous supports">Tous supports (cin√©ma, TV, web, etc.)</option>
                            <option value="Cin√©ma uniquement">Cin√©ma uniquement</option>
                            <option value="Web uniquement">Web uniquement</option>
                            <option value="Usage interne">Usage interne uniquement</option>
                        </select>
                    </div>
                    <div class="contract-form-group">
                        <label>Dur√©e de cession</label>
                        <select id="contract-duree-cession">
                            <option value="illimit√©e">Dur√©e illimit√©e</option>
                            <option value="5 ans">5 ans</option>
                            <option value="10 ans">10 ans</option>
                            <option value="dur√©e du projet">Dur√©e du projet</option>
                        </select>
                    </div>
                </div>
                ` : ''}
                
                <div class="contract-actions">
                    <button class="contract-btn contract-btn-secondary" onclick="app.Contracts.closeModal()">Annuler</button>
                    <button class="contract-btn contract-btn-primary" onclick="app.Contracts.preview()">üëÅÔ∏è Aper√ßu</button>
                    <button class="contract-btn contract-btn-primary" onclick="app.Contracts.generatePDF()">üìÑ G√©n√©rer PDF</button>
                </div>
            </div>
        `;
    },
    
    renderPersonList: (persons, statusFilter) => {
        if(!persons || persons.length === 0) return '';
        
        return persons.map((p, i) => {
            const statusLabel = p.professionalStatus === 'intermittent' ? 'Intermittent¬∑e' : 
                               p.professionalStatus === 'micro-entrepreneur' ? 'Micro-entrepreneur¬∑e' : '';
            const statusClass = p.professionalStatus || '';
            const typeLabel = p._type === 'actor' ? 'üé≠ Com√©dien¬∑ne' : 'üé¨ Technicien¬∑ne';
            const isSelected = Contracts.selectedPerson && Contracts.selectedPerson.id === p.id;
            
            return `
                <div class="person-select-item ${isSelected ? 'selected' : ''}" onclick="app.Contracts.selectPerson('${p._type}', '${p.id}')">
                    <div style="flex:1;">
                        <strong>${Utils.escape(p.name)}</strong>
                        <div style="font-size:0.85rem;color:var(--text-sec);">${typeLabel} ${p.role ? '- ' + p.role : ''}</div>
                    </div>
                    ${statusLabel ? `<span class="status-badge ${statusClass}">${statusLabel}</span>` : ''}
                </div>
            `;
        }).join('');
    },
    
    selectPerson: (type, id) => {
        const list = type === 'actor' ? state.data.actors : state.data.crew;
        Contracts.selectedPerson = list.find(p => p.id === id);
        Contracts.selectedPersonType = type;
        
        document.querySelectorAll('.person-select-item').forEach(item => {
            item.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
    },
    
    preview: () => {
        if(!Contracts.selectedPerson) {
            Utils.toast('Veuillez s√©lectionner une personne', 'warning');
            return;
        }
        
        const html = Contracts.generateContractHTML();
        
        const previewModal = document.createElement('div');
        previewModal.className = 'contracts-modal';
        previewModal.onclick = (e) => { if(e.target === previewModal) previewModal.remove(); };
        
        previewModal.innerHTML = `
            <div class="contracts-box" style="max-width:800px;">
                <div class="contracts-header">
                    <h3>üëÅÔ∏è Aper√ßu du contrat</h3>
                    <button class="history-close-btn" onclick="this.closest('.contracts-modal').remove()">‚úï</button>
                </div>
                <div class="contracts-content">
                    <div class="contract-preview">${html}</div>
                    <div class="contract-actions">
                        <button class="contract-btn contract-btn-secondary" onclick="this.closest('.contracts-modal').remove()">Fermer</button>
                        <button class="contract-btn contract-btn-primary" onclick="app.Contracts.generatePDF()">üìÑ G√©n√©rer PDF</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(previewModal);
    },
    
    generateContractHTML: () => {
        const p = Contracts.selectedPerson;
        const project = state.data.presentation || {};
        const type = Contracts.currentType;
        
        const dateStart = document.getElementById('contract-date-start')?.value || '';
        const dateEnd = document.getElementById('contract-date-end')?.value || '';
        const lieu = document.getElementById('contract-lieu')?.value || '';
        
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '___________';
        
        if(type === 'cddu') {
            const convention = document.getElementById('contract-convention')?.value || 'Production cin√©matographique';
            const heures = document.getElementById('contract-heures')?.value || '35';
            const role = Contracts.selectedPersonType === 'actor' ? 
                (state.data.characters?.find(c => c.actor_id === p.id)?.name || 'Com√©dien¬∑ne') : 
                (p.role || 'Technicien¬∑ne');
            
            return `
                <h1>CONTRAT √Ä DUR√âE D√âTERMIN√âE D'USAGE (CDDU)</h1>
                <p style="text-align:center;font-style:italic;">Conform√©ment aux articles L.1242-2, L.1242-7 et D.1242-1 du Code du travail</p>
                
                <h2>PR√âAMBULE ‚Äì MOTIF DE RECOURS</h2>
                <p>Le pr√©sent contrat est conclu dans le cadre d'un <strong>emploi √† caract√®re temporaire</strong> 
                pour lequel il est d'usage constant, dans le secteur de la production cin√©matographique et audiovisuelle, 
                de ne pas recourir au contrat √† dur√©e ind√©termin√©e en raison de la nature de l'activit√© exerc√©e 
                et du caract√®re par nature temporaire de cet emploi (article D.1242-1 du Code du travail).<br>
                <strong>Ce contrat n'a pas pour objet de pourvoir durablement un emploi li√© √† l'activit√© normale et permanente de l'entreprise.</strong></p>
                
                <h2>ENTRE LES SOUSSIGN√â¬∑E¬∑S</h2>
                <p><strong>L'Employeur :</strong><br>
                Nom / D√©nomination sociale : ${Utils.escape(project.producer) || '___________________'}<br>
                Adresse : ${Utils.escape(project.addressLegal || project.city) || '___________________'}<br>
                SIRET : ${Utils.escape(project.siret) || '___________________'}<br>
                Code APE/NAF : ${Utils.escape(project.ape) || '___________________'}<br>
                N¬∞ Licence entrepreneur spectacle : ${Utils.escape(project.licence) || '___________________'}<br>
                Repr√©sent√©¬∑e par : ${Utils.escape(project.director) || '___________________'}, en qualit√© de ${Utils.escape(project.directorTitle) || '___________________'}</p>
                
                <p style="font-size:0.9em;color:#666;"><em>La D√©claration Pr√©alable √† l'Embauche (DPAE) a √©t√© effectu√©e aupr√®s de l'URSSAF 
                de ${Utils.escape(project.urssaf) || '___________________'} le ___________________.</em></p>
                
                <p><strong>Et le/la Salari√©¬∑e ‚Äì Intermittent¬∑e du spectacle :</strong><br>
                Nom et pr√©nom : ${Utils.escape(p.name)}<br>
                N√©¬∑e le : ___________________ √† ___________________<br>
                Nationalit√© : ___________________<br>
                Adresse : ${Utils.escape(p.address) || '___________________'}<br>
                N¬∞ de S√©curit√© sociale : ${Utils.escape(p.numSecu) || '___________________'}<br>
                N¬∞ Cong√©s Spectacles : ${Utils.escape(p.numCongesSpectacles) || '___________________'}<br>
                N¬∞ d'objet (P√¥le emploi spectacle) : ___________________<br>
                Emploi/m√©tier : ${Utils.escape(role)}</p>
                
                <h2>ARTICLE 1 ‚Äì OBJET DU CONTRAT</h2>
                <p>Le pr√©sent contrat a pour objet d'engager le/la salari√©¬∑e en qualit√© de <strong>${Utils.escape(role)}</strong> 
                pour le projet intitul√© ¬´ <strong>${Utils.escape(state.data.title) || 'Sans titre'}</strong> ¬ª.</p>
                
                <h2>ARTICLE 2 ‚Äì NATURE DU CONTRAT</h2>
                <p>Le/la salari√©¬∑e est engag√©¬∑e dans le cadre d'un contrat √† dur√©e d√©termin√©e d'usage (CDDU), 
                conform√©ment aux articles L.1242-2 et suivants du Code du travail, sp√©cifiques aux professions du spectacle.</p>
                
                <h2>ARTICLE 3 ‚Äì DUR√âE DU CONTRAT</h2>
                <p>Le pr√©sent contrat prend effet le <strong>${formatDate(dateStart)}</strong> et se termine le <strong>${formatDate(dateEnd)}</strong>.<br>
                Dur√©e totale estim√©e : <strong>${heures} heures</strong>.</p>
                
                <h2>ARTICLE 4 ‚Äì LIEU DE TRAVAIL</h2>
                <p>Le lieu de travail principal est fix√© √† : <strong>${Utils.escape(lieu) || '___________________'}</strong>.<br>
                Des d√©placements pourront √™tre n√©cessaires selon les besoins de la production.</p>
                
                <h2>ARTICLE 5 ‚Äì R√âMUN√âRATION</h2>
                <p>Le/la salari√©¬∑e percevra une r√©mun√©ration brute de <strong>${p.dailyRate || '___'} ${p.rateCurrency || '‚Ç¨'}</strong> par ${p.rateType || 'jour'}.<br>
                Cette r√©mun√©ration est soumise aux cotisations sociales en vigueur.</p>
                
                <h2>ARTICLE 6 ‚Äì CONVENTION COLLECTIVE</h2>
                <p>Le pr√©sent contrat est r√©gi par la convention collective de la <strong>${convention}</strong>.</p>
                
                <h2>ARTICLE 7 ‚Äì CAISSE DE RETRAITE ET PR√âVOYANCE</h2>
                <p>Caisse de retraite compl√©mentaire : AUDIENS<br>
                Adresse : 74 rue Jean Bleuzen, 92170 Vanves</p>
                
                <h2>ARTICLE 8 ‚Äì CONG√âS SPECTACLES</h2>
                <p>Les cong√©s pay√©s seront vers√©s par la Caisse des Cong√©s Spectacles.<br>
                N¬∞ d'affiliation employeur : ${Utils.escape(project.congesSpectacles) || '___________________'}</p>
                
                <h2>ARTICLE 9 ‚Äì ABATTEMENT POUR FRAIS PROFESSIONNELS</h2>
                <p>L'emploi occup√© ouvre droit √† la d√©duction forfaitaire sp√©cifique pour frais professionnels 
                pr√©vue par l'arr√™t√© du 20 d√©cembre 2002. Le/la salari√©¬∑e d√©clare :<br>
                ‚òê Accepter l'application de cet abattement<br>
                ‚òê Refuser l'application de cet abattement<br>
                <em style="font-size:0.85em;color:#666;">Note : L'application de cet abattement a pour cons√©quence de minorer l'assiette 
                des cotisations sociales et donc les droits sociaux (retraite, indemnit√©s journali√®res, allocations ch√¥mage).</em></p>
                
                <h2>ARTICLE 10 ‚Äì FIN DE CONTRAT</h2>
                <p>√Ä l'issue du contrat, l'employeur remettra au/√† la salari√©¬∑e :<br>
                ‚Ä¢ Un certificat de travail<br>
                ‚Ä¢ Une attestation P√¥le emploi (AEM ‚Äì Attestation Employeur Mensuelle)<br>
                ‚Ä¢ Un re√ßu pour solde de tout compte<br>
                ‚Ä¢ Le dernier bulletin de salaire<br>
                ‚Ä¢ Un certificat cong√©s spectacles</p>
                
                <h2>ARTICLE 11 ‚Äì JURIDICTION COMP√âTENTE</h2>
                <p>En cas de litige relatif √† l'ex√©cution du pr√©sent contrat, les parties conviennent de rechercher 
                une solution amiable. √Ä d√©faut, le Conseil de Prud'hommes comp√©tent sera celui du lieu de travail 
                ou du domicile du/de la salari√©¬∑e.</p>
                
                <div class="signature-zone">
                    <div class="signature-box">
                        <p>Fait √† ${Utils.escape(lieu) || '___________'}, le ${formatDate(new Date().toISOString())}</p>
                        <p><strong>L'Employeur</strong></p>
                        <p class="signature-line">Signature et cachet</p>
                    </div>
                    <div class="signature-box">
                        <p>Lu et approuv√©,</p>
                        <p><strong>Le/La Salari√©¬∑e</strong></p>
                        <p class="signature-line">${Utils.escape(p.name)}</p>
                    </div>
                </div>
            `;
        } else if(type === 'prestation') {
            return `
                <h1>CONTRAT DE PRESTATION DE SERVICES</h1>
                
                <h2>ENTRE LES SOUSSIGN√â¬∑E¬∑S</h2>
                <p><strong>Le/La Client¬∑e :</strong><br>
                Nom / D√©nomination sociale : ${Utils.escape(project.producer) || '___________________'}<br>
                Adresse : ${Utils.escape(project.addressLegal || project.city) || '___________________'}<br>
                SIRET : ${Utils.escape(project.siret) || '___________________'}<br>
                Repr√©sent√©¬∑e par : ${Utils.escape(project.director) || '___________________'}, en qualit√© de ${Utils.escape(project.directorTitle) || '___________________'}</p>
                
                <p><strong>Et le/la Prestataire (Micro-entrepreneur¬∑e) :</strong><br>
                Nom et pr√©nom : ${Utils.escape(p.name)}<br>
                Adresse : ${Utils.escape(p.address) || '___________________'}<br>
                SIRET : ${Utils.escape(p.siret) || '___________________'}<br>
                Activit√© : ${Utils.escape(p.role) || 'Prestation technique'}</p>
                
                <h2>ARTICLE 1 ‚Äì OBJET DU CONTRAT</h2>
                <p>Le/la prestataire s'engage √† r√©aliser pour le/la client¬∑e la mission suivante :<br>
                <strong>${Utils.escape(p.role) || 'Prestation technique'}</strong> pour le projet ¬´ <strong>${Utils.escape(state.data.title) || 'Sans titre'}</strong> ¬ª.</p>
                
                <h2>ARTICLE 2 ‚Äì DUR√âE DE LA MISSION</h2>
                <p>La mission d√©bute le <strong>${formatDate(dateStart)}</strong> et se termine le <strong>${formatDate(dateEnd)}</strong>.</p>
                
                <h2>ARTICLE 3 ‚Äì LIEU D'EX√âCUTION</h2>
                <p>La prestation sera r√©alis√©e √† : <strong>${Utils.escape(lieu) || '___________________'}</strong>.</p>
                
                <h2>ARTICLE 4 ‚Äì R√âMUN√âRATION</h2>
                <p>En contrepartie de la r√©alisation de la mission, le/la client¬∑e versera au/√† la prestataire la somme de :<br>
                <strong>${p.dailyRate || '___'} ${p.rateCurrency || '‚Ç¨'} HT</strong> par ${p.rateType || 'jour'}.<br>
                TVA non applicable, article 293 B du CGI (si applicable).</p>
                
                <h2>ARTICLE 5 ‚Äì MODALIT√âS DE PAIEMENT</h2>
                <p>Le paiement sera effectu√© par virement bancaire sous 30 jours √† r√©ception de la facture.</p>
                
                <h2>ARTICLE 6 ‚Äì IND√âPENDANCE</h2>
                <p>Le/la prestataire exerce son activit√© de mani√®re ind√©pendante et n'est soumis¬∑e √† aucun lien de subordination. 
                Il/elle organise librement son travail dans le respect des d√©lais convenus.</p>
                
                <h2>ARTICLE 7 ‚Äì ASSURANCE</h2>
                <p>Le/la prestataire d√©clare :<br>
                ‚Ä¢ √ätre assur√©¬∑e au titre de sa responsabilit√© civile professionnelle<br>
                ‚Ä¢ N¬∞ de police : ___________________<br>
                ‚Ä¢ Compagnie d'assurance : ___________________<br>
                Et s'engage √† maintenir cette assurance pendant toute la dur√©e de la mission.</p>
                
                <h2>ARTICLE 8 ‚Äì PROPRI√âT√â INTELLECTUELLE</h2>
                <p>Sauf accord contraire √©crit, les cr√©ations r√©alis√©es dans le cadre de la pr√©sente mission 
                (images, sons, textes, graphismes, etc.) sont la propri√©t√© exclusive du/de la client¬∑e 
                d√®s leur cr√©ation et leur paiement int√©gral.<br><br>
                Le/la prestataire c√®de au/√† la client¬∑e, √† titre exclusif, l'ensemble des droits patrimoniaux 
                attach√©s aux cr√©ations, pour tous supports et tous modes d'exploitation, pour le monde entier 
                et pour toute la dur√©e l√©gale de protection des droits d'auteur.<br><br>
                Cette cession inclut notamment les droits de reproduction, repr√©sentation, adaptation, 
                traduction et exploitation commerciale.</p>
                
                <h2>ARTICLE 9 ‚Äì CONFIDENTIALIT√â</h2>
                <p>Le/la prestataire s'engage √† garder strictement confidentielles toutes les informations 
                relatives au projet et au/√† la client¬∑e dont il/elle pourrait avoir connaissance dans le cadre 
                de l'ex√©cution de la pr√©sente mission.<br>
                Cette obligation de confidentialit√© restera en vigueur pendant une dur√©e de 2 ans apr√®s la fin du contrat.</p>
                
                <h2>ARTICLE 10 ‚Äì R√âSILIATION</h2>
                <p><strong>R√©siliation pour convenance :</strong> Chaque partie peut r√©silier le pr√©sent contrat 
                moyennant un pr√©avis de ___ jours ouvr√©s notifi√© par √©crit (email avec accus√© de r√©ception ou LRAR).<br><br>
                <strong>R√©siliation pour faute :</strong> En cas de manquement grave d'une partie √† ses obligations, 
                l'autre partie pourra r√©silier le contrat de plein droit, 8 jours apr√®s mise en demeure rest√©e infructueuse.<br><br>
                <strong>Cons√©quences :</strong> En cas de r√©siliation, le/la prestataire sera r√©mun√©r√©¬∑e pour les prestations 
                d√©j√† r√©alis√©es et accept√©es par le/la client¬∑e.</p>
                
                <h2>ARTICLE 11 ‚Äì SOUS-TRAITANCE</h2>
                <p>Le/la prestataire ne pourra sous-traiter tout ou partie de la mission sans l'accord pr√©alable 
                et √©crit du/de la client¬∑e.</p>
                
                <h2>ARTICLE 12 ‚Äì LITIGE ET DROIT APPLICABLE</h2>
                <p>Le pr√©sent contrat est soumis au droit fran√ßais.<br>
                En cas de litige, les parties s'engagent √† rechercher une solution amiable. 
                √Ä d√©faut d'accord dans un d√©lai de 30 jours, le litige sera soumis aux tribunaux comp√©tents 
                du ressort du si√®ge social du/de la client¬∑e.</p>
                
                <h2>ARTICLE 13 ‚Äì D√âCLARATIONS DU/DE LA PRESTATAIRE</h2>
                <p>Le/la prestataire d√©clare :<br>
                ‚òê √ätre r√©guli√®rement inscrit¬∑e au Registre du Commerce ou au R√©pertoire des M√©tiers<br>
                ‚òê √ätre √† jour de ses obligations fiscales et sociales<br>
                ‚òê Ne pas √™tre en situation de d√©pendance √©conomique vis-√†-vis du/de la client¬∑e</p>
                
                <p style="margin-top:20px;padding:10px;background:#fff3cd;border:1px solid #ffc107;font-size:0.85em;">
                <strong>‚ö†Ô∏è Attention :</strong> Le recours √† un¬∑e prestataire auto-entrepreneur¬∑e est licite 
                uniquement si celui/celle-ci exerce son activit√© de mani√®re r√©ellement ind√©pendante, 
                sans lien de subordination. √Ä d√©faut, le contrat pourrait √™tre requalifi√© en contrat de travail.</p>
                
                <div class="signature-zone">
                    <div class="signature-box">
                        <p>Fait √† ${Utils.escape(lieu) || '___________'}, le ${formatDate(new Date().toISOString())}</p>
                        <p>En deux exemplaires originaux</p>
                        <p><strong>Le/La Client¬∑e</strong></p>
                        <p class="signature-line">Signature et cachet</p>
                    </div>
                    <div class="signature-box">
                        <p>Lu et approuv√©,</p>
                        <p><strong>Le/La Prestataire</strong></p>
                        <p>${Utils.escape(p.name)}</p>
                        <p class="signature-line">Signature pr√©c√©d√©e de ¬´ Lu et approuv√© ¬ª</p>
                    </div>
                </div>
            `;
        } else if(type === 'benevole') {
            // Accord B√©n√©vole
            return Contracts.generateBenevoleHTML(p, project, dateStart, dateEnd, lieu, formatDate);
        } else {
            // Droit √† l'image
            const usage = document.getElementById('contract-usage')?.value || 'Tous supports';
            const dureeCession = document.getElementById('contract-duree-cession')?.value || 'illimit√©e';
            
            return `
                <h1>AUTORISATION D'EXPLOITATION DU DROIT √Ä L'IMAGE</h1>
                <p style="text-align:center;font-style:italic;">Articles 9 du Code civil et 226-1 du Code p√©nal</p>
                
                <h2>ARTICLE 1 ‚Äì IDENTIT√â DU/DE LA SIGNATAIRE</h2>
                <p>Je soussign√©¬∑e :<br>
                Nom et pr√©nom : ${Utils.escape(p.name)}<br>
                N√©¬∑e le : ___________________ √† ___________________<br>
                Nationalit√© : ___________________<br>
                Adresse : ${Utils.escape(p.address) || '___________________'}<br>
                Email : ${Utils.escape(p.email) || '___________________'}<br>
                T√©l√©phone : ${Utils.escape(p.phone) || '___________________'}</p>
                
                <p style="margin-top:15px;padding:10px;border:1px solid #333;"><strong>‚òê Personne majeure</strong> agissant en mon nom propre<br><br>
                <strong>‚òê Repr√©sentant l√©gal d'un¬∑e mineur¬∑e</strong><br>
                Nom du/de la mineur¬∑e : ___________________<br>
                N√©¬∑e le : ___________________ √† ___________________<br>
                Lien avec le/la mineur¬∑e : ‚òê P√®re ‚òê M√®re ‚òê Tuteur/Tutrice l√©gal¬∑e<br>
                <em style="font-size:0.85em;">L'autorisation des deux parents ou du tuteur l√©gal est requise pour tout¬∑e mineur¬∑e.</em></p>
                
                <h2>ARTICLE 2 ‚Äì B√âN√âFICIAIRE DE L'AUTORISATION</h2>
                <p>J'autorise express√©ment :<br>
                La soci√©t√© / personne : ${Utils.escape(project.producer) || '___________________'}<br>
                Adresse : ${Utils.escape(project.addressLegal || project.city) || '___________________'}<br>
                SIRET : ${Utils.escape(project.siret) || '___________________'}<br>
                Repr√©sent√©e par : ${Utils.escape(project.director) || '___________________'}, en qualit√© de ${Utils.escape(project.directorTitle) || '___________________'}<br>
                Pour le projet intitul√© : ¬´ <strong>${Utils.escape(state.data.title) || 'Sans titre'}</strong> ¬ª</p>
                
                <h2>ARTICLE 3 ‚Äì OBJET DE L'AUTORISATION</h2>
                <p>√Ä fixer, reproduire, repr√©senter et exploiter mon image (et/ou celle du/de la mineur¬∑e que je repr√©sente) 
                capt√©e lors des prises de vues r√©alis√©es :<br>
                Du : <strong>${formatDate(dateStart)}</strong> au <strong>${formatDate(dateEnd)}</strong><br>
                Lieu : <strong>${Utils.escape(lieu) || '___________________'}</strong></p>
                
                <h2>ARTICLE 4 ‚Äì SUPPORTS ET MODES D'EXPLOITATION</h2>
                <p>Cette autorisation est consentie pour les utilisations suivantes :<br>
                <strong>${usage}</strong></p>
                <p>Supports autoris√©s :<br>
                ‚òê Exploitation cin√©matographique (salles)<br>
                ‚òê Diffusion t√©l√©visuelle (hertzienne, c√¢ble, satellite, TNT)<br>
                ‚òê Supports vid√©o (DVD, Blu-ray, VOD, SVOD)<br>
                ‚òê Internet et r√©seaux sociaux<br>
                ‚òê Supports promotionnels (affiches, bandes-annonces, making-of)<br>
                ‚òê Festivals et projections publiques<br>
                ‚òê Usage p√©dagogique et culturel<br>
                ‚òê Tous supports connus ou inconnus √† ce jour</p>
                
                <h2>ARTICLE 5 ‚Äì √âTENDUE TERRITORIALE ET DUR√âE</h2>
                <p><strong>Territoire :</strong> Monde entier / ou limit√© √† : ___________________<br>
                <strong>Dur√©e :</strong> ${dureeCession}<br>
                <em style="font-size:0.85em;">En cas de dur√©e illimit√©e, l'autorisation est consentie pour toute la dur√©e l√©gale de protection 
                des droits de propri√©t√© intellectuelle et de leurs √©ventuelles prolongations.</em></p>
                
                <h2>ARTICLE 6 ‚Äì CONTREPARTIE FINANCI√àRE</h2>
                <p>${p.dailyRate ? `Cette autorisation est consentie moyennant la somme forfaitaire de <strong>${p.dailyRate} ${p.rateCurrency || '‚Ç¨'}</strong> (${p.rateType === 'jour' ? 'par jour' : p.rateType === 'heure' ? 'par heure' : 'forfait global'}).` : 'Cette autorisation est consentie <strong>√† titre gratuit</strong>, le/la signataire reconnaissant avoir √©t√© inform√©¬∑e de la possibilit√© de demander une r√©mun√©ration.'}</p>
                
                <h2>ARTICLE 7 ‚Äì ENGAGEMENTS DU B√âN√âFICIAIRE</h2>
                <p>Le b√©n√©ficiaire s'engage √† ce que l'exploitation de l'image :<br>
                ‚Ä¢ Ne porte pas atteinte √† la dignit√©, √† l'honneur ou √† la r√©putation du/de la signataire<br>
                ‚Ä¢ Ne d√©nature pas le contexte dans lequel les images ont √©t√© capt√©es<br>
                ‚Ä¢ Ne soit pas utilis√©e dans un contexte pornographique, diffamatoire ou contraire aux bonnes m≈ìurs<br>
                ‚Ä¢ Respecte le droit moral du/de la signataire</p>
                
                <h2>ARTICLE 8 ‚Äì DROIT DE RETRAIT</h2>
                <p>Conform√©ment aux articles 9 du Code civil, le/la signataire conserve le droit de retirer 
                son autorisation √† tout moment, par lettre recommand√©e avec accus√© de r√©ception adress√©e au b√©n√©ficiaire.<br>
                Ce retrait ne pourra toutefois pas affecter les exploitations d√©j√† r√©alis√©es ou en cours au moment de la notification, 
                ni ouvrir droit √† indemnisation.</p>
                
                <h2>ARTICLE 9 ‚Äì PROTECTION DES DONN√âES PERSONNELLES (RGPD)</h2>
                <p style="font-size:0.9em;">Conform√©ment au R√®glement G√©n√©ral sur la Protection des Donn√©es (UE 2016/679) et √† la loi Informatique et Libert√©s, 
                le/la signataire dispose d'un droit d'acc√®s, de rectification, d'effacement, de limitation, d'opposition 
                et de portabilit√© des donn√©es le/la concernant.<br>
                Ces droits peuvent √™tre exerc√©s aupr√®s de : ${Utils.escape(project.producer) || '___________________'}<br>
                Email : ___________________<br>
                Les donn√©es collect√©es seront conserv√©es pour la dur√©e n√©cessaire √† l'exploitation autoris√©e.</p>
                
                <h2>ARTICLE 10 ‚Äì D√âCLARATIONS</h2>
                <p>Le/la signataire d√©clare :<br>
                ‚òê Avoir pris connaissance de l'int√©gralit√© du pr√©sent document<br>
                ‚òê Avoir eu la possibilit√© de poser des questions et d'obtenir des r√©ponses<br>
                ‚òê Ne pas √™tre li√©¬∑e par un contrat exclusif relatif √† l'utilisation de son image<br>
                ‚òê Donner son consentement libre, sp√©cifique, √©clair√© et univoque</p>
                
                <div class="signature-zone">
                    <div class="signature-box">
                        <p>Fait √† ${Utils.escape(lieu) || '___________'}, le ${formatDate(new Date().toISOString())}</p>
                        <p>En deux exemplaires originaux</p>
                        <p><strong>Le/La B√©n√©ficiaire</strong></p>
                        <p class="signature-line">Signature et cachet</p>
                    </div>
                    <div class="signature-box">
                        <p>Lu et approuv√©,<br>Mention manuscrite ¬´ Bon pour accord ¬ª</p>
                        <p><strong>Le/La Signataire</strong></p>
                        <p>${Utils.escape(p.name)}</p>
                        <p class="signature-line">Signature pr√©c√©d√©e de la mention<br>¬´ Lu et approuv√©, bon pour accord ¬ª</p>
                    </div>
                </div>
            `;
        }
    },
    
    // G√©n√©rer le HTML pour l'Accord B√©n√©vole
    generateBenevoleHTML: (p, project, dateStart, dateEnd, lieu, formatDate) => {
        const role = p._type === 'actor' ? 
            (state.data.characters?.find(c => c.actor_id === p.id)?.name || 'Com√©dien¬∑ne') : 
            (p.role || 'Technicien¬∑ne b√©n√©vole');
        
        return `
            <h1>ACCORD DE COLLABORATION B√âN√âVOLE</h1>
            <p style="text-align:center;font-style:italic;">Engagement moral et √©thique de collaboration</p>
            
            <h2>PR√âAMBULE</h2>
            <p>Le pr√©sent accord d√©finit les conditions d'une collaboration <strong>b√©n√©vole</strong> dans le cadre 
            d'un projet audiovisuel √† but non lucratif ou √† budget limit√©. Il n'√©tablit aucun lien de subordination 
            et ne constitue pas un contrat de travail. Chaque partie s'engage librement et de bonne foi.</p>
            
            <h2>ENTRE</h2>
            <p><strong>Le/La Porteur¬∑se de projet :</strong><br>
            Nom / Structure : ${Utils.escape(project.producer) || '___________________'}<br>
            Adresse : ${Utils.escape(project.addressLegal || project.city) || '___________________'}<br>
            Repr√©sent√©¬∑e par : ${Utils.escape(project.director) || '___________________'}<br>
            Email : ${Utils.escape(project.emailLegal) || '___________________'}</p>
            
            <p><strong>Et le/la Collaborateur¬∑rice b√©n√©vole :</strong><br>
            Nom et pr√©nom : ${Utils.escape(p.name)}<br>
            Adresse : ${Utils.escape(p.address) || '___________________'}<br>
            Email : ${Utils.escape(p.email) || '___________________'}<br>
            T√©l√©phone : ${Utils.escape(p.phone) || '___________________'}</p>
            
            <h2>ARTICLE 1 ‚Äì OBJET DE LA COLLABORATION</h2>
            <p>Le/la collaborateur¬∑rice b√©n√©vole accepte de participer au projet intitul√© 
            ¬´ <strong>${Utils.escape(state.data.title) || 'Sans titre'}</strong> ¬ª 
            en qualit√© de <strong>${Utils.escape(role)}</strong>.</p>
            
            <h2>ARTICLE 2 ‚Äì P√âRIODE DE COLLABORATION</h2>
            <p>La collaboration est pr√©vue du <strong>${formatDate(dateStart)}</strong> au <strong>${formatDate(dateEnd)}</strong>.<br>
            Lieu principal : <strong>${Utils.escape(lieu) || '___________________'}</strong><br>
            Les horaires et jours de pr√©sence seront d√©finis d'un commun accord.</p>
            
            <h2>ARTICLE 3 ‚Äì NATURE B√âN√âVOLE</h2>
            <p>Les parties reconnaissent express√©ment que cette collaboration est <strong>b√©n√©vole</strong> :<br>
            ‚Ä¢ Aucune r√©mun√©ration ne sera vers√©e<br>
            ‚Ä¢ Aucun lien de subordination n'existe entre les parties<br>
            ‚Ä¢ Le/la collaborateur¬∑rice est libre d'organiser sa participation<br>
            ‚Ä¢ Le/la collaborateur¬∑rice peut mettre fin √† sa participation √† tout moment</p>
            
            <h2>ARTICLE 4 ‚Äì D√âFRAIEMENTS</h2>
            <p>Le/la porteur¬∑se de projet s'engage, dans la mesure du possible, √† prendre en charge :<br>
            ‚òê Les repas sur le lieu de tournage/travail<br>
            ‚òê Les frais de transport (sur justificatifs)<br>
            ‚òê L'h√©bergement si n√©cessaire<br>
            <em style="font-size:0.9em;">Les modalit√©s pr√©cises seront d√©finies avant chaque journ√©e de collaboration.</em></p>
            
            <h2>ARTICLE 5 ‚Äì ENGAGEMENTS MUTUELS</h2>
            <p><strong>Le/la porteur¬∑se de projet s'engage √† :</strong><br>
            ‚Ä¢ Traiter le/la collaborateur¬∑rice avec respect et bienveillance<br>
            ‚Ä¢ Fournir les informations n√©cessaires √† la bonne r√©alisation du projet<br>
            ‚Ä¢ Assurer des conditions de travail s√©curis√©es<br>
            ‚Ä¢ Mentionner le/la collaborateur¬∑rice au g√©n√©rique du projet (sauf demande contraire)</p>
            
            <p><strong>Le/la collaborateur¬∑rice s'engage √† :</strong><br>
            ‚Ä¢ Participer de bonne foi et avec professionnalisme<br>
            ‚Ä¢ Respecter les consignes de s√©curit√© et d'organisation<br>
            ‚Ä¢ Pr√©venir en cas d'absence ou d'emp√™chement<br>
            ‚Ä¢ Respecter la confidentialit√© du projet</p>
            
            <h2>ARTICLE 6 ‚Äì CR√âDITS ET RECONNAISSANCE</h2>
            <p>Le/la collaborateur¬∑rice figurera au g√©n√©rique du projet sous le nom :<br>
            <strong>${Utils.escape(p.name)}</strong><br>
            Fonction/R√¥le : <strong>${Utils.escape(role)}</strong><br><br>
            ‚òê Je souhaite appara√Ætre au g√©n√©rique<br>
            ‚òê Je ne souhaite pas appara√Ætre au g√©n√©rique</p>
            
            <h2>ARTICLE 7 ‚Äì PROPRI√âT√â INTELLECTUELLE</h2>
            <p>Le/la collaborateur¬∑rice accepte que sa contribution soit int√©gr√©e au projet final. 
            En contrepartie de cette collaboration b√©n√©vole et de la mention au g√©n√©rique, 
            il/elle c√®de gracieusement les droits d'exploitation de sa contribution pour ce projet uniquement.</p>
            
            <h2>ARTICLE 8 ‚Äì ASSURANCE</h2>
            <p>Le/la porteur¬∑se de projet d√©clare :<br>
            ‚òê Disposer d'une assurance responsabilit√© civile couvrant les collaborateurs<br>
            ‚òê Ne pas disposer d'assurance sp√©cifique (le/la collaborateur¬∑rice participe √† ses risques)</p>
            
            <h2>ARTICLE 9 ‚Äì ESPRIT DE L'ACCORD</h2>
            <p style="font-style:italic;">Cet accord repose sur la confiance mutuelle, le respect et l'envie commune de r√©aliser 
            un projet cr√©atif. Les parties s'engagent √† communiquer ouvertement et √† r√©soudre tout diff√©rend 
            de mani√®re amiable et constructive. L'aventure humaine compte autant que le r√©sultat final.</p>
            
            <div class="signature-zone">
                <div class="signature-box">
                    <p>Fait √† ${Utils.escape(lieu) || '___________'}, le ${formatDate(new Date().toISOString())}</p>
                    <p>En deux exemplaires</p>
                    <p><strong>Le/La Porteur¬∑se de projet</strong></p>
                    <p class="signature-line">Signature</p>
                </div>
                <div class="signature-box">
                    <p>Lu et approuv√©,<br>¬´ Je m'engage librement ¬ª</p>
                    <p><strong>Le/La Collaborateur¬∑rice</strong></p>
                    <p>${Utils.escape(p.name)}</p>
                    <p class="signature-line">Signature</p>
                </div>
            </div>
        `;
    },
    
    generatePDF: () => {
        if(!Contracts.selectedPerson) {
            Utils.toast('Veuillez s√©lectionner une personne', 'warning');
            return;
        }
        
        // V√©rifier les infos manquantes selon le type de contrat
        const p = Contracts.selectedPerson;
        const type = Contracts.currentType;
        const missing = [];
        
        if(!p.address) missing.push('Adresse');
        
        if(type === 'cddu') {
            if(!p.numSecu) missing.push('N¬∞ S√©curit√© Sociale');
            if(!p.numCongesSpectacles) missing.push('N¬∞ Cong√©s Spectacles');
        }
        
        if(type === 'prestation') {
            if(!p.siret) missing.push('N¬∞ SIRET');
        }
        
        if(missing.length > 0) {
            Contracts.showMissingInfoWarning(missing);
            return;
        }
        
        Contracts.doGeneratePDF();
    },
    
    // Afficher l'avertissement des infos manquantes
    showMissingInfoWarning: (missing) => {
        const p = Contracts.selectedPerson;
        
        const modal = document.createElement('div');
        modal.id = 'contract-missing-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:100000;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:450px; max-width:90%;">
                <h3 style="margin:0 0 20px; color:#FF9800;">‚ö†Ô∏è Informations manquantes</h3>
                <p style="margin-bottom:15px;">Pour g√©n√©rer le contrat de <strong>${Utils.escape(p.name)}</strong>, il manque :</p>
                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px;">
                    ${missing.map(m => `<span style="background:var(--danger); color:white; padding:5px 12px; border-radius:6px; font-size:0.9rem;">‚ùå ${m}</span>`).join('')}
                </div>
                ${p.email ? `<p style="color:var(--text-sec); margin-bottom:15px; font-size:0.9rem;">Vous pouvez envoyer un rappel √† ${p.name} pour qu'il compl√®te son profil.</p>` : `<p style="color:var(--text-sec); margin-bottom:15px; font-size:0.9rem;">Cette personne n'a pas d'email. Compl√©tez sa fiche manuellement.</p>`}
                <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
                    <button onclick="document.getElementById('contract-missing-modal').remove()" style="padding:10px 20px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Annuler</button>
                    ${p.email ? `<button onclick="app.Contracts.sendMissingInfoEmail()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">üìß Envoyer rappel</button>` : ''}
                    <button onclick="app.Contracts.forceGeneratePDF()" style="padding:10px 20px; background:#FF9800; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">üìÑ G√©n√©rer quand m√™me</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Envoyer email de rappel pour contrat
    sendMissingInfoEmail: async () => {
        const p = Contracts.selectedPerson;
        if(!p || !p.email) return;
        
        const type = Contracts.currentType;
        const issues = [];
        
        if(!p.address) issues.push('ton adresse');
        if(type === 'cddu') {
            if(!p.numSecu) issues.push('ton num√©ro de S√©curit√© Sociale');
            if(!p.numCongesSpectacles) issues.push('ton num√©ro Cong√©s Spectacles');
        }
        if(type === 'prestation' && !p.siret) {
            issues.push('ton num√©ro SIRET');
        }
        
        const projectTitle = state.data.title || 'Sans titre';
        const contractType = type === 'cddu' ? 'CDDU' : (type === 'prestation' ? 'contrat de prestation' : 'autorisation droit √† l\'image');
        
        try {
            await emailjs.send('service_3doh6ch', 'template_kcn4svi', {
                to_email: p.email,
                to_name: p.name,
                from_name: state.currentUser?.displayName || state.currentUser?.email || 'L\'√©quipe',
                project_title: projectTitle,
                subject: `üé¨ ${projectTitle} - Infos requises pour ton contrat`,
                message: `Salut ${p.name} ! üëã\n\nLe projet "${projectTitle}" a besoin de quelques informations pour g√©n√©rer ton ${contractType}.\n\nIl manque : ${issues.join(', ')}\n\nPeux-tu mettre √† jour ton profil sur Moteur quand tu as 2 minutes ?\n\nMerci ! üé¨`,
                reply_to: state.currentUser?.email || ''
            });
            
            Utils.toast(`üìß Email envoy√© √† ${p.name}`, 'success');
            document.getElementById('contract-missing-modal')?.remove();
        } catch(e) {
            console.error('Erreur envoi email:', e);
            Utils.toast('Erreur lors de l\'envoi', 'error');
        }
    },
    
    // Forcer la g√©n√©ration malgr√© les infos manquantes
    forceGeneratePDF: () => {
        document.getElementById('contract-missing-modal')?.remove();
        Contracts.doGeneratePDF();
    },
    
    // G√©n√©ration effective du PDF
    doGeneratePDF: () => {
        const html = Contracts.generateContractHTML();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Titre selon le type
        const titles = {
            'cddu': 'CDDU',
            'prestation': 'Contrat_Prestation',
            'image': 'Autorisation_Image',
            'benevole': 'Accord_Benevole'
        };
        
        const fileName = `${titles[Contracts.currentType]}_${Contracts.selectedPerson.name.replace(/\s+/g, '_')}_${state.data.title?.replace(/\s+/g, '_') || 'Projet'}.pdf`;
        
        // Utiliser html2canvas si disponible, sinon m√©thode simple
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = `<div style="font-family: Times New Roman, serif; font-size: 11pt; padding: 20px; max-width: 170mm;">${html}</div>`;
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        document.body.appendChild(tempDiv);
        
        doc.html(tempDiv, {
            callback: function(doc) {
                doc.save(fileName);
                document.body.removeChild(tempDiv);
                Utils.toast('Contrat PDF g√©n√©r√© !', 'success');
                History.log('ADD', `G√©n√©ration contrat ${Contracts.currentType.toUpperCase()} pour ${Contracts.selectedPerson.name}`);
            },
            x: 15,
            y: 15,
            width: 180,
            windowWidth: 700
        });
    }
};

// ========== NOTIFICATIONS ==========
const Notifications = {
    unreadCount: 0,
    items: [],
    listenerAttached: false,
    
    // Initialiser l'√©coute des notifications
    init: () => {
        if(!state.currentUser || Notifications.listenerAttached) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        const notifRef = firebase.database().ref('user_notifications/' + emailKey);
        
        notifRef.orderByChild('timestamp').limitToLast(50).on('value', (snap) => {
            const data = snap.val() || {};
            Notifications.items = Object.entries(data).map(([key, val]) => ({
                id: key,
                ...val
            })).sort((a, b) => b.timestamp - a.timestamp);
            
            Notifications.unreadCount = Notifications.items.filter(n => !n.read).length;
            Notifications.updateBadge();
            Notifications.renderList();
        });
        
        Notifications.listenerAttached = true;
    },
    
    // Mettre √† jour le badge
    updateBadge: () => {
        const badge = document.getElementById('notif-badge');
        if(!badge) return;
        
        if(Notifications.unreadCount > 0) {
            badge.textContent = Notifications.unreadCount > 99 ? '99+' : Notifications.unreadCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    },
    
    // Afficher/masquer le panneau
    togglePanel: () => {
        const panel = document.getElementById('notif-panel');
        if(panel) {
            panel.classList.toggle('visible');
        }
    },
    
    // Fermer le panneau
    closePanel: () => {
        const panel = document.getElementById('notif-panel');
        if(panel) {
            panel.classList.remove('visible');
        }
    },
    
    // Rendre la liste
    renderList: () => {
        const list = document.getElementById('notif-list');
        if(!list) return;
        
        if(Notifications.items.length === 0) {
            list.innerHTML = '<div class="notif-empty">üîï Aucune notification</div>';
            return;
        }
        
        list.innerHTML = Notifications.items.map(n => {
            const date = new Date(n.timestamp);
            const timeAgo = Notifications.getTimeAgo(date);
            const icon = Notifications.getIcon(n.type);
            const unreadClass = n.read ? '' : 'unread';
            
            return `
                <div class="notif-item ${unreadClass}" onclick="app.Notifications.handleClick('${n.id}', '${n.type}', '${n.projectId || ''}')">
                    <span class="notif-icon">${icon}</span>
                    <div class="notif-content">
                        <div class="notif-text">${Utils.escape(n.message)}</div>
                        <div class="notif-time">${timeAgo}</div>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    // Obtenir l'ic√¥ne selon le type
    getIcon: (type) => {
        const icons = {
            'invite': 'üì®',
            'message': 'üí¨',
            'modification': '‚úèÔ∏è',
            'share': 'üë•'
        };
        return icons[type] || 'üîî';
    },
    
    // Calculer "il y a X temps"
    getTimeAgo: (date) => {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if(seconds < 60) return "√Ä l'instant";
        if(seconds < 3600) return `Il y a ${Math.floor(seconds / 60)} min`;
        if(seconds < 86400) return `Il y a ${Math.floor(seconds / 3600)}h`;
        if(seconds < 604800) return `Il y a ${Math.floor(seconds / 86400)}j`;
        return date.toLocaleDateString('fr-FR');
    },
    
    // G√©rer le clic sur une notification
    handleClick: async (notifId, type, projectId) => {
        // Marquer comme lu
        await Notifications.markAsRead(notifId);
        
        // Action selon le type
        if(type === 'invite' && projectId) {
            Notifications.closePanel();
            Store.loadProject(projectId);
        } else if(type === 'message') {
            Notifications.closePanel();
            // Ouvrir les messages si n√©cessaire
        }
    },
    
    // Marquer une notification comme lue
    markAsRead: async (notifId) => {
        if(!state.currentUser) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        try {
            await firebase.database().ref('user_notifications/' + emailKey + '/' + notifId + '/read').set(true);
        } catch(e) {
            console.error('Erreur markAsRead:', e);
        }
    },
    
    // Marquer toutes comme lues
    markAllRead: async () => {
        if(!state.currentUser) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        const updates = {};
        
        Notifications.items.forEach(n => {
            if(!n.read) {
                updates[n.id + '/read'] = true;
            }
        });
        
        if(Object.keys(updates).length > 0) {
            try {
                await firebase.database().ref('user_notifications/' + emailKey).update(updates);
                Utils.toast('Toutes les notifications marqu√©es comme lues', 'success');
            } catch(e) {
                console.error('Erreur markAllRead:', e);
            }
        }
    },
    
    // Envoyer une notification √† un utilisateur
    send: async (toEmail, type, message, projectId = null) => {
        const emailKey = Utils.sanitizeEmail(toEmail);
        
        const notif = {
            type: type,
            message: message,
            projectId: projectId,
            fromEmail: state.currentUser?.email || 'Syst√®me',
            timestamp: Date.now(),
            read: false
        };
        
        try {
            await firebase.database().ref('user_notifications/' + emailKey).push(notif);
        } catch(e) {
            console.error('Erreur envoi notification:', e);
        }
    },
    
    // Toggle panneau (pour le header)
    toggle: () => {
        const panel = document.getElementById('notif-panel');
        if(!panel) return;
        
        const isVisible = panel.style.display === 'block';
        panel.style.display = isVisible ? 'none' : 'block';
        
        if(!isVisible) {
            Notifications.renderList();
        }
    },
    
    // Met √† jour le badge de r√¥le de l'utilisateur dans le header
    updateRoleBadge: () => {
        const badge = document.getElementById('user-role-badge');
        if(!badge) return;
        
        const currentEmail = state.currentUser?.email;
        if(!currentEmail) {
            badge.style.display = 'none';
            return;
        }
        
        let roleText = '';
        let roleClass = '';
        let roleIcon = '';
        
        // V√©rifier si propri√©taire
        if(state.currentRole === 'owner') {
            roleText = 'Propri√©taire';
            roleClass = 'owner';
            roleIcon = 'üëë';
        }
        // V√©rifier si responsable budget global
        else if(state.data?.budget?.manager === currentEmail) {
            roleText = 'Resp. Budget';
            roleClass = 'budget-manager';
            roleIcon = 'üí∞';
        }
        // V√©rifier si responsable d'un d√©partement
        else {
            const deptManagers = state.data?.budget?.deptManagers || {};
            const deptsList = [
                { id: 'image', name: 'Image', icon: 'üìπ' },
                { id: 'lumiere', name: 'Lumi√®re', icon: 'üí°' },
                { id: 'son', name: 'Son', icon: 'üé§' },
                { id: 'realisation', name: 'R√©alisation', icon: 'üé¨' },
                { id: 'decoration', name: 'D√©coration', icon: 'üé®' },
                { id: 'costumes', name: 'Costumes', icon: 'üëó' },
                { id: 'maquillage', name: 'Maquillage', icon: 'üíÑ' },
                { id: 'regie', name: 'R√©gie', icon: 'üé≠' },
                { id: 'production', name: 'Production', icon: 'üíº' },
                { id: 'transport', name: 'Transport', icon: 'üöó' },
                { id: 'catering', name: 'Catering', icon: 'üç¥' },
                { id: 'postprod', name: 'Post-prod', icon: 'üéûÔ∏è' },
                { id: 'location', name: 'Locations', icon: 'üè†' },
                { id: 'assurance', name: 'Assurance', icon: 'üìã' }
            ];
            for(const [deptId, manager] of Object.entries(deptManagers)) {
                if(manager.email === currentEmail) {
                    const dept = deptsList.find(d => d.id === deptId);
                    roleText = `Resp. ${dept?.name || deptId}`;
                    roleClass = 'dept-manager';
                    roleIcon = dept?.icon || 'üìã';
                    break;
                }
            }
        }
        
        // V√©rifier le r√¥le dans l'√©quipe si pas de r√¥le budget
        if(!roleText && state.data?.crew) {
            const crewMember = state.data.crew.find(c => c.email === currentEmail);
            if(crewMember && crewMember.role) {
                roleText = crewMember.role;
                roleIcon = 'üé¨';
            }
        }
        
        if(roleText) {
            badge.innerHTML = `${roleIcon} ${roleText}`;
            badge.className = `user-role-badge ${roleClass}`;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
};

const History = {
    // Types d'actions
    TYPES: {
        ADD: { icon: '‚ûï', label: 'Ajout', class: 'add' },
        EDIT: { icon: '‚úèÔ∏è', label: 'Modification', class: 'edit' },
        DELETE: { icon: 'üóëÔ∏è', label: 'Suppression', class: 'delete' },
        SHARE: { icon: 'üë•', label: 'Partage', class: 'share' }
    },
    
    // Enregistrer une action dans l'historique
    log: async (type, description, details = {}) => {
        if(!state.currentProjectId || !state.currentUser) return;
        
        const entry = {
            type: type,
            description: description,
            details: details,
            user: {
                email: state.currentUser.email,
                name: state.currentUser.displayName || state.currentUser.email.split('@')[0]
            },
            timestamp: Date.now()
        };
        
        try {
            const historyRef = firebase.database().ref('all_projects/' + state.currentProjectId + '/history');
            await historyRef.push(entry);
        } catch(e) {
            console.error('Erreur historique:', e);
        }
    },
    
    // Charger l'historique
    load: async () => {
        if(!state.currentProjectId) return [];
        
        try {
            const snap = await firebase.database().ref('all_projects/' + state.currentProjectId + '/history')
                .orderByChild('timestamp')
                .limitToLast(100)
                .once('value');
            
            const data = snap.val() || {};
            return Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
        } catch(e) {
            console.error('Erreur chargement historique:', e);
            return [];
        }
    },
    
    // Ouvrir la modale
    openModal: async () => {
        if(!state.currentProjectId) {
            Utils.toast('Ouvrez un projet d\'abord', 'warning');
            return;
        }
        
        const entries = await History.load();
        const users = [...new Set(entries.map(e => e.user?.email).filter(Boolean))];
        
        const modal = document.createElement('div');
        modal.className = 'history-modal';
        modal.id = 'history-modal';
        modal.onclick = (e) => { if(e.target === modal) History.closeModal(); };
        
        modal.innerHTML = `
            <div class="history-box">
                <div class="history-header">
                    <h3>üìú Historique des modifications</h3>
                    <button class="history-close-btn" onclick="app.History.closeModal()">‚úï</button>
                </div>
                <div class="history-filters">
                    <select id="history-filter-type" onchange="app.History.applyFilters()">
                        <option value="">Tous les types</option>
                        <option value="ADD">‚ûï Ajouts</option>
                        <option value="EDIT">‚úèÔ∏è Modifications</option>
                        <option value="DELETE">üóëÔ∏è Suppressions</option>
                        <option value="SHARE">üë• Partages</option>
                    </select>
                    <select id="history-filter-user" onchange="app.History.applyFilters()">
                        <option value="">Tous les utilisateurs</option>
                        ${users.map(u => `<option value="${u}">${u}</option>`).join('')}
                    </select>
                </div>
                <div class="history-list" id="history-list">
                    ${History.renderEntries(entries)}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        state.historyEntries = entries;
    },
    
    // Fermer la modale
    closeModal: () => {
        const modal = document.getElementById('history-modal');
        if(modal) modal.remove();
    },
    
    // Appliquer les filtres
    applyFilters: () => {
        const typeFilter = document.getElementById('history-filter-type')?.value || '';
        const userFilter = document.getElementById('history-filter-user')?.value || '';
        
        let filtered = state.historyEntries || [];
        
        if(typeFilter) {
            filtered = filtered.filter(e => e.type === typeFilter);
        }
        if(userFilter) {
            filtered = filtered.filter(e => e.user?.email === userFilter);
        }
        
        const listEl = document.getElementById('history-list');
        if(listEl) {
            listEl.innerHTML = History.renderEntries(filtered);
        }
    },
    
    // Rendre les entr√©es HTML
    renderEntries: (entries) => {
        if(!entries || entries.length === 0) {
            return '<div class="history-empty">üì≠ Aucune modification enregistr√©e</div>';
        }
        
        return entries.map(entry => {
            const typeInfo = History.TYPES[entry.type] || History.TYPES.EDIT;
            const date = new Date(entry.timestamp);
            const dateStr = date.toLocaleDateString('fr-FR');
            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div class="history-item">
                    <div class="history-icon ${typeInfo.class}">${typeInfo.icon}</div>
                    <div class="history-content">
                        <div class="history-action">${Utils.escape(entry.description)}</div>
                        <div class="history-meta">
                            <span>üë§ ${Utils.escape(entry.user?.name || 'Inconnu')}</span>
                            <span>üìÖ ${dateStr} √† ${timeStr}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
};

// ========== MODE PR√âSENTATION PLEIN √âCRAN ==========
const PresentMode = {
    isActive: false,
    currentTabIndex: 0,
    tabs: [],
    
    start: () => {
        if(!state.currentProjectId) {
            Utils.toast('Ouvrez un projet d\'abord', 'warning');
            return;
        }
        
        // Collecter les onglets visibles
        PresentMode.tabs = [];
        document.querySelectorAll('#tabsNav .tab-btn').forEach((btn, idx) => {
            if(btn.style.display !== 'none') {
                PresentMode.tabs.push({
                    id: btn.dataset.tab,
                    name: btn.textContent.trim()
                });
            }
        });
        
        if(PresentMode.tabs.length === 0) {
            Utils.toast('Aucun onglet disponible', 'warning');
            return;
        }
        
        // Trouver l'onglet actuellement actif
        const activeTab = document.querySelector('#tabsNav .tab-btn.active');
        if(activeTab) {
            const activeId = activeTab.dataset.tab;
            const idx = PresentMode.tabs.findIndex(t => t.id === activeId);
            if(idx >= 0) PresentMode.currentTabIndex = idx;
        } else {
            PresentMode.currentTabIndex = 0;
        }
        
        // Activer le mode
        document.body.classList.add('presentation-mode');
        PresentMode.isActive = true;
        PresentMode.updateTabName();
        
        // Plein √©cran si support√©
        if(document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(() => {});
        }
        
        Utils.toast('Mode Pr√©sentation activ√© - √âchap pour quitter', 'info');
    },
    
    exit: () => {
        document.body.classList.remove('presentation-mode');
        PresentMode.isActive = false;
        
        // Quitter le plein √©cran
        if(document.fullscreenElement && document.exitFullscreen) {
            document.exitFullscreen().catch(() => {});
        }
        
        Utils.toast('Mode Pr√©sentation d√©sactiv√©', 'info');
    },
    
    nextTab: () => {
        if(PresentMode.tabs.length === 0) return;
        PresentMode.currentTabIndex = (PresentMode.currentTabIndex + 1) % PresentMode.tabs.length;
        PresentMode.goToCurrentTab();
    },
    
    prevTab: () => {
        if(PresentMode.tabs.length === 0) return;
        PresentMode.currentTabIndex = (PresentMode.currentTabIndex - 1 + PresentMode.tabs.length) % PresentMode.tabs.length;
        PresentMode.goToCurrentTab();
    },
    
    goToCurrentTab: () => {
        const tab = PresentMode.tabs[PresentMode.currentTabIndex];
        if(tab) {
            // Activer l'onglet
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            const content = document.getElementById('tab-' + tab.id);
            const btn = document.querySelector(`.tab-btn[data-tab="${tab.id}"]`);
            if(content) content.classList.add('active');
            if(btn) btn.classList.add('active');
            
            PresentMode.updateTabName();
        }
    },
    
    updateTabName: () => {
        const nameEl = document.getElementById('presTabName');
        const tab = PresentMode.tabs[PresentMode.currentTabIndex];
        if(nameEl && tab) {
            nameEl.textContent = `${PresentMode.currentTabIndex + 1}/${PresentMode.tabs.length} - ${tab.name}`;
        }
    }
};

// --- MODULE PRESENTATION V93 ---
const Presentation = {
    init: () => {
        Presentation.load();
        Presentation.renderCrewNeeds();
        Presentation.renderActorNeeds();
        Presentation.renderPartners();
    },
    
    load: () => {
        const p = state.data.presentation || {};
        
        const imgInput = document.getElementById('project-image-input');
        const imgPreview = document.getElementById('project-image-preview');
        const imgPlaceholder = document.getElementById('project-image-placeholder');
        if(imgInput) imgInput.value = p.image || '';
        if(p.image) {
            if(imgPreview) { imgPreview.src = p.image; imgPreview.style.display = 'block'; }
            if(imgPlaceholder) imgPlaceholder.style.display = 'none';
        }
        
        const titleDisplay = document.getElementById('project-title-display');
        if(titleDisplay) titleDisplay.textContent = state.data.title || 'Sans titre';
        
        if(document.getElementById('project-type')) document.getElementById('project-type').value = p.type || '';
        if(document.getElementById('project-genre')) document.getElementById('project-genre').value = p.genre || '';
        
        if(document.getElementById('project-date-preprod-start')) document.getElementById('project-date-preprod-start').value = p.datePreprodStart || '';
        if(document.getElementById('project-date-preprod-end')) document.getElementById('project-date-preprod-end').value = p.datePreprodEnd || '';
        if(document.getElementById('project-date-shooting-start')) document.getElementById('project-date-shooting-start').value = p.dateShootingStart || '';
        if(document.getElementById('project-date-shooting-end')) document.getElementById('project-date-shooting-end').value = p.dateShootingEnd || '';
        if(document.getElementById('project-date-postprod-start')) document.getElementById('project-date-postprod-start').value = p.datePostprodStart || '';
        if(document.getElementById('project-date-postprod-end')) document.getElementById('project-date-postprod-end').value = p.datePostprodEnd || '';
        if(document.getElementById('project-date-release')) document.getElementById('project-date-release').value = p.dateRelease || '';
        if(document.getElementById('project-date-distribution-end')) document.getElementById('project-date-distribution-end').value = p.dateDistributionEnd || '';
        
        if(document.getElementById('project-city')) document.getElementById('project-city').value = p.city || '';
        if(document.getElementById('project-region')) document.getElementById('project-region').value = p.region || '';
        if(document.getElementById('project-country')) document.getElementById('project-country').value = p.country || 'France';
        
        if(document.getElementById('project-producer')) document.getElementById('project-producer').value = p.producer || '';
        if(document.getElementById('project-director')) document.getElementById('project-director').value = p.director || '';
        if(document.getElementById('project-writer')) document.getElementById('project-writer').value = p.writer || '';
        if(document.getElementById('project-prod-manager')) document.getElementById('project-prod-manager').value = p.prodManager || '';
        if(document.getElementById('project-budget')) document.getElementById('project-budget').value = p.budget || '';
        
        // Informations l√©gales employeur (contrats)
        if(document.getElementById('project-siret')) document.getElementById('project-siret').value = p.siret || '';
        if(document.getElementById('project-ape')) document.getElementById('project-ape').value = p.ape || '';
        if(document.getElementById('project-licence')) document.getElementById('project-licence').value = p.licence || '';
        if(document.getElementById('project-urssaf')) document.getElementById('project-urssaf').value = p.urssaf || '';
        if(document.getElementById('project-conges-spectacles')) document.getElementById('project-conges-spectacles').value = p.congesSpectacles || '';
        if(document.getElementById('project-email-legal')) document.getElementById('project-email-legal').value = p.emailLegal || '';
        if(document.getElementById('project-address-legal')) document.getElementById('project-address-legal').value = p.addressLegal || '';
        if(document.getElementById('project-director-title')) document.getElementById('project-director-title').value = p.directorTitle || '';
        
        if(document.getElementById('project-description')) document.getElementById('project-description').value = p.description || '';
        if(document.getElementById('project-public')) document.getElementById('project-public').checked = p.isPublic || false;
        
        // Type de production
        Presentation.updateProductionTypeUI(p.productionType || '');
        
        // √âquipe actuelle
        Presentation.renderTeamList();
    },
    
    setProductionType: (type) => {
        if(!state.data.presentation) state.data.presentation = {};
        state.data.presentation.productionType = type;
        Presentation.updateProductionTypeUI(type);
        Store.save();
    },
    
    updateProductionTypeUI: (type) => {
        document.querySelectorAll('.project-type-card').forEach(card => {
            card.classList.toggle('selected', card.dataset.type === type);
        });
    },
    
    // === √âQUIPE ACTUELLE ===
    selectedTeamMember: null,
    
    renderTeamList: () => {
        const container = document.getElementById('project-team-list');
        if(!container) return;
        
        const team = state.data.presentation?.team || [];
        
        if(team.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-sec); font-style: italic;">Aucun membre ajout√©</div>';
            return;
        }
        
        container.innerHTML = team.map((member, idx) => `
            <div style="display: flex; align-items: center; gap: 15px; padding: 12px 15px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;">
                <div style="width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem;">
                    ${member.name ? member.name.charAt(0).toUpperCase() : '?'}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--text-main);">${Utils.escape(member.name || 'Sans nom')}</div>
                    <div style="font-size: 0.85rem; color: var(--primary);">${Utils.escape(member.role || 'R√¥le non d√©fini')}</div>
                    ${member.email ? `<div style="font-size: 0.8rem; color: var(--text-sec);">${Utils.escape(member.email)}</div>` : ''}
                </div>
                <button onclick="app.Presentation.removeTeamMember(${idx})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; padding: 5px;" title="Retirer">‚úï</button>
            </div>
        `).join('');
    },
    
    openTeamMemberModal: () => {
        Presentation.selectedTeamMember = null;
        document.getElementById('team-member-role').value = '';
        document.getElementById('team-member-custom-role-div').style.display = 'none';
        document.getElementById('team-member-custom-role').value = '';
        document.getElementById('team-member-search').value = '';
        document.getElementById('team-member-search-results').innerHTML = '';
        document.getElementById('team-member-new-name').value = '';
        document.getElementById('team-member-new-email').value = '';
        document.getElementById('team-member-modal').style.display = 'flex';
        
        // G√©rer le champ r√¥le personnalis√©
        document.getElementById('team-member-role').onchange = function() {
            document.getElementById('team-member-custom-role-div').style.display = this.value === 'Autre' ? 'block' : 'none';
        };
    },
    
    closeTeamMemberModal: () => {
        document.getElementById('team-member-modal').style.display = 'none';
    },
    
    searchTeamMember: async (query) => {
        const resultsDiv = document.getElementById('team-member-search-results');
        if(!query || query.length < 2) {
            resultsDiv.innerHTML = '';
            return;
        }
        
        const q = query.toLowerCase();
        const results = [];
        
        // Chercher dans les techniciens du projet
        (state.data.crew || []).forEach(member => {
            if(member.name?.toLowerCase().includes(q) || member.email?.toLowerCase().includes(q)) {
                results.push({ type: 'crew', id: member.id, name: member.name, email: member.email, photo: member.photo });
            }
        });
        
        // Chercher dans les com√©diens du projet
        (state.data.actors || []).forEach(actor => {
            if(actor.name?.toLowerCase().includes(q) || actor.email?.toLowerCase().includes(q)) {
                results.push({ type: 'actor', id: actor.id, name: actor.name, email: actor.email, photo: actor.photo });
            }
        });
        
        // Chercher dans l'Univers (profils publics)
        try {
            const snap = await firebase.database().ref('public_profiles').orderByChild('name').limitToFirst(50).once('value');
            const profiles = snap.val() || {};
            Object.entries(profiles).forEach(([id, profile]) => {
                if((profile.type === 'comedien' || profile.type === 'technicien') && 
                   (profile.name?.toLowerCase().includes(q) || profile.email?.toLowerCase().includes(q))) {
                    if(!results.find(r => r.email === profile.email)) {
                        results.push({ type: 'universe', id: id, name: profile.name, email: profile.email, photo: profile.photo });
                    }
                }
            });
        } catch(e) { console.warn('Erreur recherche Univers:', e); }
        
        if(results.length === 0) {
            resultsDiv.innerHTML = '<div style="padding: 10px; color: var(--text-sec); font-style: italic;">Aucun r√©sultat</div>';
            return;
        }
        
        resultsDiv.innerHTML = results.slice(0, 10).map(r => `
            <div onclick="app.Presentation.selectTeamMember('${r.type}', '${r.id}', '${Utils.escape(r.name || '')}', '${Utils.escape(r.email || '')}')" 
                 style="display: flex; align-items: center; gap: 10px; padding: 8px 10px; cursor: pointer; border-radius: 6px; transition: background 0.2s;"
                 onmouseover="this.style.background='var(--primary-light)'" onmouseout="this.style.background='transparent'">
                <div style="width: 35px; height: 35px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    ${r.photo ? `<img src="${r.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : r.name?.charAt(0).toUpperCase() || '?'}
                </div>
                <div>
                    <div style="font-weight: 500;">${Utils.escape(r.name || 'Sans nom')}</div>
                    <div style="font-size: 0.8rem; color: var(--text-sec);">${Utils.escape(r.email || '')}</div>
                </div>
            </div>
        `).join('');
    },
    
    selectTeamMember: (type, id, name, email) => {
        Presentation.selectedTeamMember = { type, id, name, email };
        document.getElementById('team-member-search').value = name;
        document.getElementById('team-member-search-results').innerHTML = `
            <div style="padding: 10px; background: var(--success); color: white; border-radius: 6px; text-align: center;">
                ‚úì ${Utils.escape(name)} s√©lectionn√©
            </div>
        `;
        document.getElementById('team-member-new-name').value = '';
        document.getElementById('team-member-new-email').value = '';
    },
    
    addTeamMember: () => {
        const role = document.getElementById('team-member-role').value;
        const customRole = document.getElementById('team-member-custom-role').value;
        const finalRole = role === 'Autre' ? customRole : role;
        
        if(!finalRole) {
            Utils.toast('Veuillez s√©lectionner un r√¥le', 'warning');
            return;
        }
        
        let memberData = null;
        
        if(Presentation.selectedTeamMember) {
            memberData = {
                id: Presentation.selectedTeamMember.id,
                type: Presentation.selectedTeamMember.type,
                name: Presentation.selectedTeamMember.name,
                email: Presentation.selectedTeamMember.email,
                role: finalRole
            };
        } else {
            const newName = document.getElementById('team-member-new-name').value.trim();
            if(!newName) {
                Utils.toast('Veuillez s√©lectionner ou cr√©er une personne', 'warning');
                return;
            }
            memberData = {
                id: 'new_' + Date.now(),
                type: 'new',
                name: newName,
                email: document.getElementById('team-member-new-email').value.trim(),
                role: finalRole
            };
        }
        
        if(!state.data.presentation) state.data.presentation = {};
        if(!state.data.presentation.team) state.data.presentation.team = [];
        
        // V√©rifier si d√©j√† pr√©sent
        const exists = state.data.presentation.team.find(m => m.name === memberData.name && m.role === memberData.role);
        if(exists) {
            Utils.toast('Cette personne a d√©j√† ce r√¥le dans l\'√©quipe', 'warning');
            return;
        }
        
        state.data.presentation.team.push(memberData);
        Store.save();
        Presentation.renderTeamList();
        Presentation.closeTeamMemberModal();
        Utils.toast(`${memberData.name} ajout√© comme ${memberData.role}`, 'success');
    },
    
    removeTeamMember: async (idx) => {
        if(!await ConfirmModal.confirmDelete("Ce membre sera retir√© de l'√©quipe.")) return;
        
        if(state.data.presentation?.team) {
            const member = state.data.presentation.team[idx];
            state.data.presentation.team.splice(idx, 1);
            Store.save();
            Presentation.renderTeamList();
            Utils.toast(`${member?.name || 'Membre'} retir√© de l'√©quipe`, 'success');
        }
    },
    
    save: () => {
        if(!state.data.presentation) state.data.presentation = {};
        const p = state.data.presentation;
        
        p.image = document.getElementById('project-image-input')?.value || '';
        p.type = document.getElementById('project-type')?.value || '';
        p.genre = document.getElementById('project-genre')?.value || '';
        
        p.datePreprodStart = document.getElementById('project-date-preprod-start')?.value || '';
        p.datePreprodEnd = document.getElementById('project-date-preprod-end')?.value || '';
        p.dateShootingStart = document.getElementById('project-date-shooting-start')?.value || '';
        p.dateShootingEnd = document.getElementById('project-date-shooting-end')?.value || '';
        p.datePostprodStart = document.getElementById('project-date-postprod-start')?.value || '';
        p.datePostprodEnd = document.getElementById('project-date-postprod-end')?.value || '';
        p.dateRelease = document.getElementById('project-date-release')?.value || '';
        p.dateDistributionEnd = document.getElementById('project-date-distribution-end')?.value || '';
        
        p.city = document.getElementById('project-city')?.value || '';
        p.region = document.getElementById('project-region')?.value || '';
        p.country = document.getElementById('project-country')?.value || 'France';
        
        p.producer = document.getElementById('project-producer')?.value || '';
        p.director = document.getElementById('project-director')?.value || '';
        p.writer = document.getElementById('project-writer')?.value || '';
        p.prodManager = document.getElementById('project-prod-manager')?.value || '';
        p.budget = document.getElementById('project-budget')?.value || '';
        
        // Informations l√©gales employeur (contrats)
        p.siret = document.getElementById('project-siret')?.value || '';
        p.ape = document.getElementById('project-ape')?.value || '';
        p.licence = document.getElementById('project-licence')?.value || '';
        p.urssaf = document.getElementById('project-urssaf')?.value || '';
        p.congesSpectacles = document.getElementById('project-conges-spectacles')?.value || '';
        p.emailLegal = document.getElementById('project-email-legal')?.value || '';
        p.addressLegal = document.getElementById('project-address-legal')?.value || '';
        p.directorTitle = document.getElementById('project-director-title')?.value || '';
        
        // Synchroniser avec le module D√©penses
        if(!state.data.budget) state.data.budget = { total: 0, currency: '‚Ç¨', manager: '', envelopes: {} };
        state.data.budget.total = parseFloat(p.budget) || 0;
        
        // Mettre √† jour le champ dans les d√©penses si visible
        const expensesBudgetInput = document.getElementById('expenses-budget-total');
        if(expensesBudgetInput) expensesBudgetInput.value = state.data.budget.total || '';
        
        p.description = document.getElementById('project-description')?.value || '';
        
        const wasPublic = p.isPublic || false;
        p.isPublic = document.getElementById('project-public')?.checked || false;
        
        p.updatedAt = new Date().toISOString();
        
        Store.save();
        
        if(p.isPublic) {
            Presentation.publishToUniverse();
        } else if(wasPublic && !p.isPublic) {
            Presentation.unpublishFromUniverse();
        }
    },
    
    publishToUniverse: async () => {
        if(!state.currentProjectId || !state.currentUser) return;
        
        const p = state.data.presentation || {};
        const projectTitle = document.getElementById('projectTitle')?.value || p.title || 'Sans titre';
        
        const publicData = {
            title: projectTitle,
            projectType: p.type || '',
            genre: p.genre || '',
            image: p.image || '',
            city: p.city || '',
            region: p.region || '',
            country: p.country || 'France',
            director: p.director || '',
            producer: p.producer || '',
            writer: p.writer || '',
            description: p.description || '',
            dateShootingStart: p.dateShootingStart || '',
            dateShootingEnd: p.dateShootingEnd || '',
            datePreprodStart: p.datePreprodStart || '',
            actorNeeds: p.actorNeeds || [],
            crewNeeds: p.crewNeeds || {},
            customCrewNeeds: p.customCrewNeeds || [],
            productionType: p.productionType || '',
            isPublic: true,
            ownerEmail: state.currentUser.email,
            ownerId: state.currentUser.uid,
            projectId: state.currentProjectId,
            updatedAt: new Date().toISOString()
        };
        
        try {
            await firebase.database().ref('public_projects/' + state.currentProjectId).set(publicData);
        } catch(e) {
            console.error('Erreur publication projet:', e);
        }
    },
    
    unpublishFromUniverse: async () => {
        if(!state.currentProjectId) return;
        
        try {
            await firebase.database().ref('public_projects/' + state.currentProjectId).remove();
        } catch(e) {
            console.error('Erreur suppression projet public:', e);
        }
    },
    
    crewPositions: [
        { id: 'realisateur', name: 'R√©alisateur¬∑rice', dept: 'R√©alisation' },
        { id: 'assistant_real', name: '1er Assistant R√©alisateur', dept: 'R√©alisation' },
        { id: 'scripte', name: 'Scripte', dept: 'R√©alisation' },
        { id: 'dop', name: 'Chef Op√©rateur / DOP', dept: 'Image' },
        { id: 'cadreur', name: 'Cadreur', dept: 'Image' },
        { id: 'assistant_cam', name: 'Assistant Cam√©ra', dept: 'Image' },
        { id: 'chef_elec', name: 'Chef √âlectricien', dept: 'Lumi√®re' },
        { id: 'electricien', name: '√âlectricien', dept: 'Lumi√®re' },
        { id: 'chef_machino', name: 'Chef Machiniste', dept: 'Machinerie' },
        { id: 'machiniste', name: 'Machiniste', dept: 'Machinerie' },
        { id: 'ingeson', name: 'Ing√©nieur du Son', dept: 'Son' },
        { id: 'perchman', name: 'Perchman', dept: 'Son' },
        { id: 'chef_deco', name: 'Chef D√©corateur', dept: 'D√©coration' },
        { id: 'accessoiriste', name: 'Accessoiriste', dept: 'D√©coration' },
        { id: 'chef_costumes', name: 'Chef Costumier', dept: 'Costumes' },
        { id: 'habilleur', name: 'Habilleur¬∑se', dept: 'Costumes' },
        { id: 'chef_maquillage', name: 'Chef Maquilleur', dept: 'Maquillage' },
        { id: 'maquilleur', name: 'Maquilleur¬∑se', dept: 'Maquillage' },
        { id: 'coiffeur', name: 'Coiffeur¬∑se', dept: 'Maquillage' },
        { id: 'dir_prod', name: 'Directeur de Production', dept: 'Production' },
        { id: 'regisseur', name: 'R√©gisseur G√©n√©ral', dept: 'R√©gie' },
        { id: 'assistant_regie', name: 'Assistant R√©gie', dept: 'R√©gie' },
        { id: 'dir_casting', name: 'Directeur de Casting', dept: 'Casting' },
        { id: 'photographe', name: 'Photographe Plateau', dept: 'Autre' },
        { id: 'monteur', name: 'Monteur', dept: 'Post-production' },
        { id: 'etalonneur', name: '√âtalonneur', dept: 'Post-production' },
        { id: 'mixeur', name: 'Mixeur Son', dept: 'Post-production' }
    ],
    
    renderCrewNeeds: () => {
        const container = document.getElementById('needs-crew-list');
        if(!container) return;
        
        if(!state.data.presentation) state.data.presentation = {};
        if(!state.data.presentation.crewNeeds) state.data.presentation.crewNeeds = {};
        
        const needs = state.data.presentation.crewNeeds;
        
        let html = '';
        Presentation.crewPositions.forEach(pos => {
            const need = needs[pos.id] || { needed: false, count: 1 };
            html += `<div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg); border-radius: 6px;">
                <input type="checkbox" id="need-crew-${pos.id}" ${need.needed ? 'checked' : ''} onchange="app.Presentation.toggleCrewNeed('${pos.id}')" style="width: 18px; height: 18px;">
                <label for="need-crew-${pos.id}" style="flex: 1; cursor: pointer;">${pos.name}</label>
                <input type="number" id="need-crew-count-${pos.id}" value="${need.count}" min="1" max="20" style="width: 50px; padding: 5px; border: 1px solid var(--border); border-radius: 4px; text-align: center; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateCrewNeedCount('${pos.id}', this.value)" ${need.needed ? '' : 'disabled'}>
            </div>`;
        });
        
        const customNeeds = state.data.presentation.customCrewNeeds || [];
        customNeeds.forEach((custom, idx) => {
            html += `<div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--highlight); border-radius: 6px;">
                <input type="checkbox" checked disabled style="width: 18px; height: 18px;">
                <input type="text" value="${Utils.escape(custom.name)}" style="flex: 1; padding: 5px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateCustomCrewNeed(${idx}, 'name', this.value)">
                <input type="number" value="${custom.count}" min="1" max="20" style="width: 50px; padding: 5px; border: 1px solid var(--border); border-radius: 4px; text-align: center; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateCustomCrewNeed(${idx}, 'count', this.value)">
                <button onclick="app.Presentation.removeCustomCrewNeed(${idx})" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚úï</button>
            </div>`;
        });
        
        container.innerHTML = html;
    },
    
    toggleCrewNeed: (posId) => {
        if(!state.data.presentation.crewNeeds) state.data.presentation.crewNeeds = {};
        const checkbox = document.getElementById(`need-crew-${posId}`);
        const countInput = document.getElementById(`need-crew-count-${posId}`);
        
        if(!state.data.presentation.crewNeeds[posId]) {
            state.data.presentation.crewNeeds[posId] = { needed: false, count: 1 };
        }
        
        state.data.presentation.crewNeeds[posId].needed = checkbox.checked;
        countInput.disabled = !checkbox.checked;
        
        Store.save();
    },
    
    updateCrewNeedCount: (posId, count) => {
        if(!state.data.presentation.crewNeeds) state.data.presentation.crewNeeds = {};
        if(!state.data.presentation.crewNeeds[posId]) {
            state.data.presentation.crewNeeds[posId] = { needed: true, count: 1 };
        }
        state.data.presentation.crewNeeds[posId].count = parseInt(count) || 1;
        Store.save();
    },
    
    addCustomCrewNeed: async () => {
        const name = await ConfirmModal.prompt("Entrez le nom du poste.", "Nouveau poste", "Ex: Assistant r√©alisateur...");
        if(!name || !name.trim()) return;
        
        if(!state.data.presentation.customCrewNeeds) state.data.presentation.customCrewNeeds = [];
        state.data.presentation.customCrewNeeds.push({ name: name.trim(), count: 1 });
        Store.save();
        Presentation.renderCrewNeeds();
    },
    
    updateCustomCrewNeed: (idx, field, value) => {
        if(!state.data.presentation.customCrewNeeds) return;
        if(field === 'name') {
            state.data.presentation.customCrewNeeds[idx].name = value;
        } else if(field === 'count') {
            state.data.presentation.customCrewNeeds[idx].count = parseInt(value) || 1;
        }
        Store.save();
    },
    
    removeCustomCrewNeed: (idx) => {
        if(!state.data.presentation.customCrewNeeds) return;
        state.data.presentation.customCrewNeeds.splice(idx, 1);
        Store.save();
        Presentation.renderCrewNeeds();
    },
    
    renderActorNeeds: () => {
        const container = document.getElementById('needs-actors-list');
        if(!container) return;
        
        if(!state.data.presentation) state.data.presentation = {};
        if(!state.data.presentation.actorNeeds) state.data.presentation.actorNeeds = [];
        
        const needs = state.data.presentation.actorNeeds;
        
        if(needs.length === 0) {
            container.innerHTML = '<div style="color: var(--text-sec); text-align: center; padding: 20px; background: var(--bg); border-radius: 8px;">Aucun r√¥le d√©fini. Cliquez sur "Ajouter un r√¥le" pour commencer.</div>';
            return;
        }
        
        let html = '';
        needs.forEach((need, idx) => {
            html += `<div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <input type="text" value="${Utils.escape(need.roleName || '')}" placeholder="Nom du r√¥le (ex: Marie, Inspecteur...)" style="flex: 1; padding: 8px; font-weight: bold; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'roleName', this.value)">
                    <button onclick="app.Presentation.removeActorNeed(${idx})" style="margin-left: 10px; background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Type</label>
                        <select style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'type', this.value)">
                            <option value="principal" ${need.type === 'principal' ? 'selected' : ''}>R√¥le principal</option>
                            <option value="secondaire" ${need.type === 'secondaire' ? 'selected' : ''}>R√¥le secondaire</option>
                            <option value="figurant" ${need.type === 'figurant' ? 'selected' : ''}>Figurant</option>
                            <option value="silhouette" ${need.type === 'silhouette' ? 'selected' : ''}>Silhouette</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Sexe</label>
                        <select style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'gender', this.value)">
                            <option value="" ${!need.gender ? 'selected' : ''}>Peu importe</option>
                            <option value="homme" ${need.gender === 'homme' ? 'selected' : ''}>Homme</option>
                            <option value="femme" ${need.gender === 'femme' ? 'selected' : ''}>Femme</option>
                            <option value="non-binaire" ${need.gender === 'non-binaire' ? 'selected' : ''}>Non-binaire</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">√Çge min</label>
                        <input type="number" value="${need.ageMin || ''}" placeholder="18" min="1" max="100" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'ageMin', this.value)">
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">√Çge max</label>
                        <input type="number" value="${need.ageMax || ''}" placeholder="30" min="1" max="100" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'ageMax', this.value)">
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Origine</label>
                        <select style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'ethnicity', this.value)">
                            <option value="" ${!need.ethnicity ? 'selected' : ''}>Peu importe</option>
                            <option value="caucasien" ${need.ethnicity === 'caucasien' ? 'selected' : ''}>Caucasien</option>
                            <option value="africain" ${need.ethnicity === 'africain' ? 'selected' : ''}>Africain</option>
                            <option value="asiatique" ${need.ethnicity === 'asiatique' ? 'selected' : ''}>Asiatique</option>
                            <option value="latino" ${need.ethnicity === 'latino' ? 'selected' : ''}>Latino</option>
                            <option value="maghrebin" ${need.ethnicity === 'maghrebin' ? 'selected' : ''}>Maghr√©bin</option>
                            <option value="metis" ${need.ethnicity === 'metis' ? 'selected' : ''}>M√©tis</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Cheveux</label>
                        <select style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'hairColor', this.value)">
                            <option value="" ${!need.hairColor ? 'selected' : ''}>Peu importe</option>
                            <option value="noir" ${need.hairColor === 'noir' ? 'selected' : ''}>Noir</option>
                            <option value="brun" ${need.hairColor === 'brun' ? 'selected' : ''}>Brun</option>
                            <option value="chatain" ${need.hairColor === 'chatain' ? 'selected' : ''}>Ch√¢tain</option>
                            <option value="blond" ${need.hairColor === 'blond' ? 'selected' : ''}>Blond</option>
                            <option value="roux" ${need.hairColor === 'roux' ? 'selected' : ''}>Roux</option>
                            <option value="gris" ${need.hairColor === 'gris' ? 'selected' : ''}>Gris/Blanc</option>
                            <option value="chauve" ${need.hairColor === 'chauve' ? 'selected' : ''}>Chauve</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Nombre recherch√©</label>
                        <input type="number" value="${need.count || 1}" min="1" max="100" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main);" onchange="app.Presentation.updateActorNeed(${idx}, 'count', this.value)">
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <label style="font-size: 0.8rem; color: var(--text-sec);">Description du r√¥le</label>
                    <textarea placeholder="D√©crivez le personnage, ses caract√©ristiques, le contexte..." style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: var(--text-main); min-height: 60px; resize: vertical;" onchange="app.Presentation.updateActorNeed(${idx}, 'description', this.value)">${Utils.escape(need.description || '')}</textarea>
                </div>
            </div>`;
        });
        
        container.innerHTML = html;
    },
    
    addActorNeed: () => {
        if(!state.data.presentation.actorNeeds) state.data.presentation.actorNeeds = [];
        state.data.presentation.actorNeeds.push({
            roleName: '',
            type: 'principal',
            gender: '',
            ageMin: '',
            ageMax: '',
            ethnicity: '',
            hairColor: '',
            count: 1,
            description: ''
        });
        Store.save();
        Presentation.renderActorNeeds();
    },
    
    updateActorNeed: (idx, field, value) => {
        if(!state.data.presentation.actorNeeds || !state.data.presentation.actorNeeds[idx]) return;
        state.data.presentation.actorNeeds[idx][field] = value;
        Store.save();
    },
    
    removeActorNeed: async (idx) => {
        if(!await ConfirmModal.confirmDelete("Ce r√¥le sera supprim√©.")) return;
        if(!state.data.presentation.actorNeeds) return;
        state.data.presentation.actorNeeds.splice(idx, 1);
        Store.save();
        Presentation.renderActorNeeds();
    },

    updateImage: (url) => {
        const preview = document.getElementById('project-image-preview');
        const placeholder = document.getElementById('project-image-placeholder');
        
        if(url && url.trim()) {
            if(preview) {
                preview.src = url;
                preview.style.display = 'block';
                preview.onerror = () => {
                    preview.style.display = 'none';
                    if(placeholder) placeholder.style.display = 'block';
                };
            }
            if(placeholder) placeholder.style.display = 'none';
        } else {
            if(preview) preview.style.display = 'none';
            if(placeholder) placeholder.style.display = 'block';
        }
        
        Presentation.save();
    },
    
    // ========== PARTENAIRES (Associations & Entreprises) ==========
    
    // Ouvre le modal de recherche de partenaires
    openPartnerSearch: (type) => {
        const isAssociation = type === 'association';
        const title = isAssociation ? 'üèõÔ∏è Ajouter une Association' : 'üè¢ Ajouter une Entreprise';
        const typeList = isAssociation ? CONFIG.associationTypes : CONFIG.enterpriseTypes;
        
        // Charger les partenaires disponibles depuis Universe
        const partners = Universe.allProfiles.filter(p => p.type === type);
        
        const modal = document.createElement('div');
        modal.id = 'partner-search-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10002;';
        
        let listHtml = '';
        if(partners.length === 0) {
            listHtml = `<div style="text-align: center; padding: 30px; color: var(--text-sec);">
                <div style="font-size: 2rem; margin-bottom: 10px;">${isAssociation ? 'üèõÔ∏è' : 'üè¢'}</div>
                <p>Aucun${isAssociation ? 'e association' : 'e entreprise'} disponible dans l'Univers.</p>
            </div>`;
        } else {
            listHtml = partners.map(p => {
                const name = p.name || p.assoName || p.entName || 'Sans nom';
                const typeInfo = isAssociation 
                    ? CONFIG.associationTypes.find(t => t.id === p.assoType)
                    : CONFIG.enterpriseTypes.find(t => t.id === p.entType);
                const typeName = typeInfo ? typeInfo.name : '';
                const photo = p.photo || '';
                
                return `<div onclick="app.Presentation.addPartner('${type}', '${p.id}', '${Utils.escape(name)}', '${Utils.escape(photo)}')" 
                    style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                    onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="width: 45px; height: 45px; border-radius: 50%; background: var(--panel-bg); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        ${photo ? `<img src="${photo}" style="width: 100%; height: 100%; object-fit: cover;">` : (isAssociation ? 'üèõÔ∏è' : 'üè¢')}
                    </div>
                    <div>
                        <div style="font-weight: 600; color: var(--text-main);">${Utils.escape(name)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-sec);">${typeName}</div>
                        ${p.city ? `<div style="font-size: 0.75rem; color: var(--text-sec);">üìç ${Utils.escape(p.city)}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
        }
        
        modal.innerHTML = `
            <div style="background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
                <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">${title}</h3>
                    <button onclick="document.getElementById('partner-search-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec);">‚úñ</button>
                </div>
                <div style="padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                    ${listHtml}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Ajoute un partenaire au projet
    addPartner: (type, id, name, photo) => {
        if(!state.data.presentation) state.data.presentation = {};
        
        const key = type === 'association' ? 'associations' : 'enterprises';
        if(!state.data.presentation[key]) state.data.presentation[key] = [];
        
        // V√©rifier si d√©j√† ajout√©
        if(state.data.presentation[key].find(p => p.id === id)) {
            Utils.toast('Ce partenaire est d√©j√† ajout√©.', 'warning');
            return;
        }
        
        state.data.presentation[key].push({ id, name, photo });
        Store.save();
        
        Presentation.renderPartners();
        document.getElementById('partner-search-modal')?.remove();
        Utils.toast('Partenaire ajout√© !', 'success');
    },
    
    // Supprime un partenaire
    removePartner: (type, id) => {
        if(!state.data.presentation) return;
        
        const key = type === 'association' ? 'associations' : 'enterprises';
        if(!state.data.presentation[key]) return;
        
        state.data.presentation[key] = state.data.presentation[key].filter(p => p.id !== id);
        Store.save();
        Presentation.renderPartners();
    },
    
    // Affiche les partenaires
    renderPartners: () => {
        const p = state.data.presentation || {};
        
        // Associations
        const assoList = document.getElementById('project-associations-list');
        if(assoList) {
            const associations = p.associations || [];
            if(associations.length === 0) {
                assoList.innerHTML = '<span style="color: var(--text-sec); font-size: 0.85rem;">Aucune association ajout√©e</span>';
            } else {
                assoList.innerHTML = associations.map(a => `
                    <div style="display: inline-flex; align-items: center; gap: 8px; background: var(--bg); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border);">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--panel-bg); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 0.8rem;">
                            ${a.photo ? `<img src="${a.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üèõÔ∏è'}
                        </div>
                        <span style="font-size: 0.9rem;">${Utils.escape(a.name)}</span>
                        <button onclick="app.Presentation.removePartner('association', '${a.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger); font-size: 0.8rem;">‚úñ</button>
                    </div>
                `).join('');
            }
        }
        
        // Entreprises
        const entList = document.getElementById('project-enterprises-list');
        if(entList) {
            const enterprises = p.enterprises || [];
            if(enterprises.length === 0) {
                entList.innerHTML = '<span style="color: var(--text-sec); font-size: 0.85rem;">Aucune entreprise ajout√©e</span>';
            } else {
                entList.innerHTML = enterprises.map(e => `
                    <div style="display: inline-flex; align-items: center; gap: 8px; background: var(--bg); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border);">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--panel-bg); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 0.8rem;">
                            ${e.photo ? `<img src="${e.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üè¢'}
                        </div>
                        <span style="font-size: 0.9rem;">${Utils.escape(e.name)}</span>
                        <button onclick="app.Presentation.removePartner('enterprise', '${e.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger); font-size: 0.8rem;">‚úñ</button>
                    </div>
                `).join('');
            }
        }
    },
    
    // ========== AUTOCOMPL√âTION √âQUIPE ==========
    
    // Recherche dans contacts et univers (filtr√©e par m√©tier)
    autocomplete: (input, field) => {
        const query = input.value.toLowerCase().trim();
        const dropdown = document.getElementById('autocomplete-' + field);
        
        if(!dropdown) return;
        
        // Masquer si moins de 2 caract√®res
        if(query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Mots-cl√©s par champ pour filtrer les m√©tiers
        const fieldKeywords = {
            'producer': ['producteur', 'productrice', 'production', 'producer'],
            'director': ['r√©alisateur', 'r√©alisatrice', 'r√©alisation', 'director', 'metteur en sc√®ne'],
            'writer': ['sc√©nariste', 'auteur', 'autrice', 'writer', 'dialoguiste'],
            'prod-manager': ['directeur de production', 'directrice de production', 'dir. prod', 'dir prod', 'production manager']
        };
        
        const keywords = fieldKeywords[field] || [];
        
        // Fonction pour v√©rifier si un r√¥le correspond au champ
        const matchesField = (role) => {
            if(keywords.length === 0) return true; // Pas de filtre d√©fini
            if(!role) return false; // Pas de r√¥le = pas affich√©
            const roleLower = role.toLowerCase();
            return keywords.some(kw => roleLower.includes(kw));
        };
        
        // Collecter les r√©sultats
        const results = [];
        
        // 1. Chercher dans les contacts (favoris) - SEULEMENT techniciens pour ces champs
        const contacts = state.data.contacts || { actors: [], crew: [] };
        
        // Contacts techniciens (filtr√©s par m√©tier)
        (contacts.crew || []).forEach(c => {
            const name = c.name || '';
            const role = c.role || '';
            if(name.toLowerCase().includes(query) && matchesField(role)) {
                results.push({
                    name: name,
                    photo: c.photo || '',
                    detail: role || 'Technicien',
                    source: '‚≠ê Contact',
                    icon: 'üé•'
                });
            }
        });
        
        // 2. Chercher dans l'Univers (seulement techniciens et entreprises de prod)
        (Universe.allProfiles || []).forEach(p => {
            const name = p.name || p.assoName || p.entName || '';
            const role = p.role || '';
            
            // Ne garder que les techniciens avec le bon m√©tier ou les entreprises de production
            const isMatchingCrew = p.type === 'crew' && matchesField(role);
            const isMatchingEnterprise = p.type === 'enterprise' && field === 'producer' && 
                (p.entType === 'production' || p.entType === 'distribution');
            
            if(name.toLowerCase().includes(query) && (isMatchingCrew || isMatchingEnterprise)) {
                // √âviter les doublons
                if(!results.find(r => r.name.toLowerCase() === name.toLowerCase())) {
                    const icon = p.type === 'crew' ? 'üé•' : 'üè¢';
                    const detail = p.type === 'crew' ? (role || 'Technicien') : 'Entreprise';
                    results.push({
                        name: name,
                        photo: p.photo || '',
                        detail: detail + (p.city ? ' ‚Ä¢ ' + p.city : ''),
                        source: 'üåê Univers',
                        icon: icon
                    });
                }
            }
        });
        
        // Afficher les r√©sultats (max 8)
        if(results.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        
        dropdown.innerHTML = results.slice(0, 8).map(r => `
            <div class="autocomplete-dropdown-item" onclick="app.Presentation.selectAutocomplete('${field}', '${Utils.escape(r.name)}')">
                ${r.photo ? `<img src="${r.photo}" alt="">` : `<div class="ac-icon">${r.icon}</div>`}
                <div class="ac-info">
                    <div class="ac-name">${Utils.escape(r.name)}</div>
                    <div class="ac-detail">${Utils.escape(r.detail)}</div>
                </div>
                <span class="ac-source">${r.source}</span>
            </div>
        `).join('');
        
        dropdown.style.display = 'block';
    },
    
    // S√©lectionner un r√©sultat
    selectAutocomplete: (field, name) => {
        const inputId = field === 'prod-manager' ? 'project-prod-manager' : 'project-' + field;
        const input = document.getElementById(inputId);
        if(input) {
            input.value = name;
            Presentation.save();
        }
        
        const dropdown = document.getElementById('autocomplete-' + field);
        if(dropdown) dropdown.style.display = 'none';
    },
    
    // Fermer les dropdowns au clic ailleurs
    closeAutocompletes: () => {
        document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.style.display = 'none');
    }
};

// Fermer autocomplete au clic ailleurs
document.addEventListener('click', (e) => {
    if(!e.target.closest('.autocomplete-dropdown') && !e.target.matches('input[oninput*="autocomplete"]')) {
        Presentation.closeAutocompletes();
    }
});

const Expenses = {
    currentExpenseId: null,
    expenses: [],
    filterDept: '',
    filterStatus: '',
    filterSearch: '',
    mode: 'simple', // 'simple' ou 'advanced'
    
    // Cat√©gories CNC officielles (nomenclature devis de production)
    CNC_CATEGORIES: [
        { 
            id: 'droits', code: '1', name: 'Droits artistiques', icon: 'üìú',
            subcats: [
                { id: 'droits_scenario', name: 'Sc√©nario / Adaptation' },
                { id: 'droits_musique', name: 'Droits musicaux' },
                { id: 'droits_autres', name: 'Autres droits' }
            ]
        },
        { 
            id: 'personnel', code: '2', name: 'Personnel', icon: 'üë•',
            subcats: [
                { id: 'personnel_realisation', name: 'R√©alisation' },
                { id: 'personnel_technique', name: '√âquipe technique' },
                { id: 'personnel_production', name: 'Production' }
            ]
        },
        { 
            id: 'interpretation', code: '3', name: 'Interpr√©tation', icon: 'üé≠',
            subcats: [
                { id: 'interpretation_principaux', name: 'R√¥les principaux' },
                { id: 'interpretation_secondaires', name: 'R√¥les secondaires' },
                { id: 'interpretation_figuration', name: 'Figuration' }
            ]
        },
        { 
            id: 'charges', code: '4', name: 'Charges sociales', icon: 'üìä',
            subcats: [
                { id: 'charges_artistiques', name: 'Charges artistes' },
                { id: 'charges_techniques', name: 'Charges techniciens' }
            ]
        },
        { 
            id: 'decors', code: '5', name: 'D√©cors & Costumes', icon: 'üé®',
            subcats: [
                { id: 'decors_construction', name: 'Construction d√©cors' },
                { id: 'decors_naturels', name: 'D√©cors naturels' },
                { id: 'costumes', name: 'Costumes' },
                { id: 'maquillage', name: 'Maquillage / Coiffure' }
            ]
        },
        { 
            id: 'transport', code: '6', name: 'Transports & R√©gie', icon: 'üöó',
            subcats: [
                { id: 'transport_voyages', name: 'Voyages' },
                { id: 'transport_vehicules', name: 'V√©hicules' },
                { id: 'regie_defraiements', name: 'D√©fraiements' },
                { id: 'regie_catering', name: 'R√©gie / Catering' }
            ]
        },
        { 
            id: 'moyens_tech', code: '7', name: 'Moyens techniques', icon: 'üé•',
            subcats: [
                { id: 'tech_camera', name: 'Mat√©riel cam√©ra' },
                { id: 'tech_lumiere', name: 'Lumi√®re' },
                { id: 'tech_son', name: 'Son' },
                { id: 'tech_machinerie', name: 'Machinerie' },
                { id: 'tech_effets', name: 'Effets sp√©ciaux plateau' }
            ]
        },
        { 
            id: 'postprod', code: '8', name: 'Post-production', icon: 'üéûÔ∏è',
            subcats: [
                { id: 'postprod_montage', name: 'Montage' },
                { id: 'postprod_son', name: 'Post-prod son / Mixage' },
                { id: 'postprod_image', name: '√âtalonnage' },
                { id: 'postprod_vfx', name: 'Effets visuels' }
            ]
        },
        { 
            id: 'assurances', code: '9', name: 'Assurances & Divers', icon: 'üìã',
            subcats: [
                { id: 'assurances_prod', name: 'Assurances' },
                { id: 'frais_generaux', name: 'Frais g√©n√©raux' },
                { id: 'imprevus', name: 'Impr√©vus' }
            ]
        }
    ],
    
    // Mapping anciennes cat√©gories ‚Üí nouvelles CNC
    MIGRATION_MAP: {
        'production': 'personnel',
        'technique': 'moyens_tech',
        'artistique': 'decors',
        'logistique': 'transport',
        'salaires': 'personnel', // Les salaires acteurs seront remapp√©s vers 'interpretation'
        'divers': 'assurances',
        // Anciens d√©partements d√©taill√©s
        'image': 'moyens_tech',
        'lumiere': 'moyens_tech',
        'son': 'moyens_tech',
        'realisation': 'personnel',
        'decoration': 'decors',
        'costumes': 'decors',
        'maquillage': 'decors',
        'regie': 'transport',
        'transport': 'transport',
        'catering': 'transport',
        'postprod': 'postprod',
        'location': 'decors',
        'assurance': 'assurances'
    },
    
    // Taux de TVA courants
    VAT_RATES: [
        { value: 0, label: '0% (Exon√©r√©)' },
        { value: 5.5, label: '5.5% (R√©duit)' },
        { value: 10, label: '10% (Interm√©diaire)' },
        { value: 20, label: '20% (Normal)' }
    ],
    
    // Migration des donn√©es existantes vers le nouveau format
    migrateData: () => {
        let migrated = false;
        
        // Migrer le budget
        if(!state.data.budget) state.data.budget = {};
        if(!state.data.budget.vatMode) {
            state.data.budget.vatMode = 'HT';
            state.data.budget.defaultVatRate = 20;
            migrated = true;
        }
        if(!state.data.budget.previsionnel) {
            state.data.budget.previsionnel = {};
            // Migrer les anciennes enveloppes vers le pr√©visionnel
            if(state.data.budget.envelopes) {
                Object.entries(state.data.budget.envelopes).forEach(([oldCat, amount]) => {
                    const newCat = Expenses.MIGRATION_MAP[oldCat] || 'assurances';
                    if(!state.data.budget.previsionnel[newCat]) {
                        state.data.budget.previsionnel[newCat] = { budgetHT: 0, budgetTTC: 0 };
                    }
                    state.data.budget.previsionnel[newCat].budgetHT += amount;
                    state.data.budget.previsionnel[newCat].budgetTTC += amount * 1.2;
                });
                migrated = true;
            }
        }
        if(!state.data.budget.alertThresholds) {
            state.data.budget.alertThresholds = { warning: 80, danger: 100 };
        }
        
        // Migrer les d√©penses
        (state.data.expenses || []).forEach(exp => {
            // Migrer la cat√©gorie
            if(exp.department && !exp.category) {
                // Cas sp√©cial : salaires acteurs ‚Üí interpr√©tation
                if(exp.department === 'salaires' && exp.salaryPersonType === 'actor') {
                    exp.category = 'interpretation';
                    exp.subcategory = 'interpretation_principaux';
                } else if(exp.department === 'salaires' && exp.salaryPersonType === 'crew') {
                    exp.category = 'personnel';
                    exp.subcategory = 'personnel_technique';
                } else {
                    exp.category = Expenses.MIGRATION_MAP[exp.department] || 'assurances';
                }
                migrated = true;
            }
            
            // Migrer les montants HT/TTC
            if(exp.amount !== undefined && exp.amountHT === undefined) {
                exp.amountHT = exp.amount;
                exp.vatRate = 0; // Par d√©faut, pas de TVA sur les anciennes
                exp.amountTTC = exp.amount;
                migrated = true;
            }
            
            // Migrer photo vers attachments
            if(exp.photo && (!exp.attachments || exp.attachments.length === 0)) {
                exp.attachments = [{
                    id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    name: 'justificatif.jpg',
                    url: exp.photo,
                    type: 'photo'
                }];
                migrated = true;
            }
        });
        
        if(migrated) {
            console.log('üìä Migration budget/d√©penses effectu√©e');
            Store.save();
        }
        
        return migrated;
    },
    
    // Obtenir une cat√©gorie par ID
    getCategory: (catId) => {
        return Expenses.CNC_CATEGORIES.find(c => c.id === catId);
    },
    
    // Obtenir toutes les sous-cat√©gories √† plat
    getAllSubcategories: () => {
        const result = [];
        Expenses.CNC_CATEGORIES.forEach(cat => {
            cat.subcats.forEach(sub => {
                result.push({ ...sub, parentId: cat.id, parentName: cat.name, parentIcon: cat.icon });
            });
        });
        return result;
    },
    
    // Calculer le montant TTC √† partir du HT
    calculateTTC: (amountHT, vatRate) => {
        return Math.round(amountHT * (1 + vatRate / 100) * 100) / 100;
    },
    
    // Calculer le montant HT √† partir du TTC
    calculateHT: (amountTTC, vatRate) => {
        return Math.round(amountTTC / (1 + vatRate / 100) * 100) / 100;
    },
    
    // Initialise le module
    init: () => {
        if(!state.data.expenses) state.data.expenses = [];
        if(!state.data.budget) state.data.budget = { total: 0, currency: '‚Ç¨', manager: '', envelopes: {}, deptManagers: {}, previsionnel: {}, vatMode: 'HT', defaultVatRate: 20 };
        if(!state.data.budget.envelopes) state.data.budget.envelopes = {};
        if(!state.data.budget.deptManagers) state.data.budget.deptManagers = {};
        if(!state.data.budget.previsionnel) state.data.budget.previsionnel = {};
        
        // Migration des anciennes donn√©es
        Expenses.migrateData();
        
        Expenses.expenses = state.data.expenses;
        
        // Charger le mode depuis localStorage
        const savedMode = localStorage.getItem('moteur_expenses_mode_' + (state.currentUser?.uid || 'guest'));
        Expenses.mode = savedMode || 'simple';
        
        Expenses.populateCategories();
        Expenses.populateManager();
        Expenses.loadBudget();
        Expenses.loadFinanceParams();
        Expenses.loadManagerEmailPref();
        Expenses.renderCategoryManagers();
        Expenses.applyMode();
        Expenses.render();
    },
    
    // Changer de mode Simple/Avanc√©
    setMode: (mode) => {
        Expenses.mode = mode;
        localStorage.setItem('moteur_expenses_mode_' + (state.currentUser?.uid || 'guest'), mode);
        Expenses.applyMode();
        Expenses.render();
    },
    
    // Appliquer le mode visuel
    applyMode: () => {
        const isSimple = Expenses.mode === 'simple';
        
        // Boutons toggle
        const btnSimple = document.getElementById('expenses-mode-simple');
        const btnAdvanced = document.getElementById('expenses-mode-advanced');
        if(btnSimple) {
            btnSimple.style.background = isSimple ? 'var(--primary)' : 'var(--bg)';
            btnSimple.style.color = isSimple ? 'white' : 'var(--text-main)';
            btnSimple.style.borderColor = isSimple ? 'var(--primary)' : 'var(--border)';
        }
        if(btnAdvanced) {
            btnAdvanced.style.background = isSimple ? 'var(--bg)' : 'var(--primary)';
            btnAdvanced.style.color = isSimple ? 'var(--text-main)' : 'white';
            btnAdvanced.style.borderColor = isSimple ? 'var(--border)' : 'var(--primary)';
        }
        
        // Sidebar (avanc√© uniquement)
        const sidebar = document.getElementById('expenses-sidebar-advanced');
        if(sidebar) sidebar.style.display = isSimple ? 'none' : 'block';
        
        // Header simple
        const simpleHeader = document.getElementById('expenses-simple-header');
        if(simpleHeader) simpleHeader.style.display = isSimple ? 'block' : 'none';
        
        // Summary avanc√©
        const advancedSummary = document.getElementById('expenses-summary-advanced');
        if(advancedSummary) advancedSummary.style.display = isSimple ? 'none' : 'flex';
        
        // Filtres
        const advancedFilters = document.getElementById('expenses-filters-advanced');
        const simpleFilters = document.getElementById('expenses-filters-simple');
        if(advancedFilters) advancedFilters.style.display = isSimple ? 'none' : 'flex';
        if(simpleFilters) simpleFilters.style.display = isSimple ? 'block' : 'none';
        
        // Section salaires (avanc√© uniquement)
        const salariesSection = document.getElementById('expenses-salaries-section');
        if(salariesSection) salariesSection.style.display = isSimple ? 'none' : 'block';
        
        // Ajuster la grille container
        const container = document.querySelector('.expenses-container');
        if(container) {
            container.style.gridTemplateColumns = isSimple ? '1fr' : '280px 1fr';
        }
        
        // Synchroniser le budget simple
        const budgetSimple = document.getElementById('expenses-budget-simple');
        if(budgetSimple) {
            budgetSimple.value = state.data.budget?.total || '';
        }
    },
    
    // Sauvegarder budget depuis mode simple
    saveBudgetSimple: () => {
        const value = parseFloat(document.getElementById('expenses-budget-simple')?.value) || 0;
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.total = value;
        
        // Synchroniser avec le champ avanc√©
        const advancedInput = document.getElementById('expenses-budget-total');
        if(advancedInput) advancedInput.value = value;
        
        Store.save();
        Expenses.updateSummary();
    },
    
    // Remplit les selects avec les cat√©gories CNC
    populateCategories: () => {
        const categories = Expenses.CNC_CATEGORIES;
        
        // Remplir les selects de cat√©gorie
        const selects = ['expense-category', 'expenses-filter-dept'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if(!select) return;
            
            const firstOption = select.querySelector('option');
            select.innerHTML = '';
            if(firstOption) select.appendChild(firstOption);
            
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = `${cat.icon} ${cat.code}. ${cat.name}`;
                select.appendChild(opt);
            });
        });
        
        // Liste des cat√©gories CNC dans la sidebar
        const catList = document.getElementById('expenses-dept-list');
        if(catList) {
            catList.innerHTML = '';
            const currency = state.data.budget?.currency || '‚Ç¨';
            const expenses = state.data.expenses || [];
            const previsionnel = state.data.budget?.previsionnel || {};
            const vatMode = state.data.budget?.vatMode || 'HT';
            const thresholds = state.data.budget?.alertThresholds || { warning: 80, danger: 100 };
            
            categories.forEach(cat => {
                const budget = previsionnel[cat.id]?.[vatMode === 'HT' ? 'budgetHT' : 'budgetTTC'] || 0;
                const catManager = state.data.budget?.deptManagers?.[cat.id];
                
                // Trouver le nom du responsable
                let managerName = '';
                if(catManager?.email) {
                    const person = Expenses.findPersonByEmail(catManager.email);
                    managerName = person?.name || catManager.email.split('@')[0];
                }
                
                // Calculer les d√©penses pour cette cat√©gorie
                const catExpenses = expenses.filter(e => e.category === cat.id || e.department === cat.id);
                const spent = catExpenses
                    .filter(e => e.status === 'approved' || e.status === 'done')
                    .reduce((sum, e) => sum + (vatMode === 'HT' ? (e.amountHT || e.amount || 0) : (e.amountTTC || e.amount || 0)), 0);
                
                const countPending = catExpenses.filter(e => e.status === 'pending').length;
                const countApproved = catExpenses.filter(e => e.status === 'approved' || e.status === 'done').length;
                const countMissingRate = catExpenses.filter(e => e.salaryMissingRate).length;
                
                // Calculer le pourcentage et l'√©tat d'alerte
                const percent = budget > 0 ? Math.round((spent / budget) * 100) : 0;
                const alertState = percent >= thresholds.danger ? 'danger' : percent >= thresholds.warning ? 'warning' : 'ok';
                
                // Badges
                let badges = '';
                if(countMissingRate > 0) badges += `<span class="dept-badge red" title="Tarif manquant">${countMissingRate}</span>`;
                if(countPending > 0) badges += `<span class="dept-badge yellow" title="En attente">${countPending}</span>`;
                if(alertState === 'danger') badges += `<span class="dept-badge red" title="Budget d√©pass√© !">üî¥</span>`;
                else if(alertState === 'warning') badges += `<span class="dept-badge orange" title="Attention budget">‚ö†Ô∏è</span>`;
                
                // Barre de progression
                const progressColor = alertState === 'danger' ? 'var(--danger)' : alertState === 'warning' ? '#f59e0b' : 'var(--success)';
                const progressBar = budget > 0 ? `
                    <div style="height:4px; background:var(--border); border-radius:2px; margin-top:4px; overflow:hidden;">
                        <div style="height:100%; width:${Math.min(percent, 100)}%; background:${progressColor}; transition:width 0.3s;"></div>
                    </div>
                ` : '';
                
                const div = document.createElement('div');
                div.className = 'expense-dept-item' + (Expenses.filterDept === cat.id ? ' active' : '');
                div.innerHTML = `
                    <div style="flex:1;">
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span class="dept-name">${cat.icon} ${cat.code}. ${cat.name}</span>
                            <div class="dept-badges">${badges}</div>
                        </div>
                        ${budget > 0 ? `
                            <div style="font-size:0.7rem; color:var(--text-sec);">
                                Pr√©vu: ${budget.toLocaleString()} ${currency} ${vatMode}
                                ${percent > 0 ? `<span style="color:${progressColor}; font-weight:600;">(${percent}%)</span>` : ''}
                            </div>
                            ${progressBar}
                        ` : ''}
                        ${managerName ? `<div style="font-size:0.7rem; color:var(--primary); margin-top:2px;">üë§ ${Utils.escape(managerName)}</div>` : ''}
                    </div>
                    <div style="text-align:right;">
                        <span class="dept-amount" id="cat-total-${cat.id}" style="color:${alertState === 'danger' ? 'var(--danger)' : 'var(--text-main)'}">${spent.toLocaleString()} ${currency}</span>
                        <button onclick="event.stopPropagation(); app.Expenses.editCategoryBudget('${cat.id}')" style="background:none; border:none; cursor:pointer; font-size:0.8rem; padding:2px 5px; margin-left:5px;" title="Param√®tres de la cat√©gorie">‚öôÔ∏è</button>
                    </div>
                `;
                div.onclick = (e) => {
                    if(e.target.tagName === 'BUTTON') return;
                    Expenses.filterDept = Expenses.filterDept === cat.id ? '' : cat.id;
                    const filterSelect = document.getElementById('expenses-filter-dept');
                    if(filterSelect) filterSelect.value = Expenses.filterDept;
                    Expenses.applyFilters();
                    Expenses.populateCategories();
                };
                catList.appendChild(div);
            });
        }
    },
    
    // Alias pour r√©trocompatibilit√©
    populateDepartments: () => {
        Expenses.populateCategories();
    },
    
    // Remplit le select du responsable budget
    populateManager: () => {
        const select = document.getElementById('expenses-manager');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Choisir --</option>';
        
        // Ajouter les membres de l'√©quipe
        if(state.data.crew) {
            state.data.crew.forEach(member => {
                if(member.email) {
                    const opt = document.createElement('option');
                    opt.value = member.email;
                    opt.textContent = member.name + ' (' + (member.role || '√âquipe') + ')';
                    select.appendChild(opt);
                }
            });
        }
        
        // S√©lectionner le manager actuel
        if(state.data.budget?.manager) {
            select.value = state.data.budget.manager;
        }
    },
    
    // Charge le budget
    loadBudget: () => {
        // Synchroniser depuis la pr√©sentation si le budget n'est pas d√©fini
        if(state.data.presentation?.budget && !state.data.budget?.total) {
            if(!state.data.budget) state.data.budget = { total: 0, currency: '‚Ç¨', manager: '', envelopes: {}, previsionnel: {}, vatMode: 'HT', defaultVatRate: 20 };
            state.data.budget.total = parseFloat(state.data.presentation.budget) || 0;
        }
        
        const budget = state.data.budget || { total: 0, currency: '‚Ç¨', vatMode: 'HT', defaultVatRate: 20 };
        const vatMode = budget.vatMode || 'HT';
        
        // Calculer le total depuis le pr√©visionnel
        let totalHT = 0, totalTTC = 0;
        Object.values(budget.previsionnel || {}).forEach(p => {
            totalHT += p.budgetHT || 0;
            totalTTC += p.budgetTTC || 0;
        });
        
        const displayTotal = vatMode === 'HT' ? totalHT : totalTTC;
        const budgetInput = document.getElementById('expenses-budget-total');
        if(budgetInput) budgetInput.value = displayTotal || budget.total || '';
        
        const currencySelect = document.getElementById('expenses-currency');
        if(currencySelect) currencySelect.value = budget.currency || '‚Ç¨';
        
        const managerSelect = document.getElementById('expenses-manager');
        if(managerSelect && budget.manager) managerSelect.value = budget.manager;
        
        // Mode HT/TTC
        const btnHT = document.getElementById('vat-mode-ht');
        const btnTTC = document.getElementById('vat-mode-ttc');
        if(btnHT) {
            btnHT.style.background = vatMode === 'HT' ? 'var(--primary)' : 'var(--bg)';
            btnHT.style.color = vatMode === 'HT' ? 'white' : 'var(--text-main)';
            btnHT.style.borderColor = vatMode === 'HT' ? 'var(--primary)' : 'var(--border)';
        }
        if(btnTTC) {
            btnTTC.style.background = vatMode === 'TTC' ? 'var(--primary)' : 'var(--bg)';
            btnTTC.style.color = vatMode === 'TTC' ? 'white' : 'var(--text-main)';
            btnTTC.style.borderColor = vatMode === 'TTC' ? 'var(--primary)' : 'var(--border)';
        }
        
        // TVA par d√©faut
        const vatSelect = document.getElementById('expenses-default-vat');
        if(vatSelect) vatSelect.value = budget.defaultVatRate || 20;
        
        // Seuils d'alerte
        const thresholds = budget.alertThresholds || { warning: 80, danger: 100 };
        const warnInput = document.getElementById('alert-threshold-warning');
        const dangerInput = document.getElementById('alert-threshold-danger');
        if(warnInput) warnInput.value = thresholds.warning;
        if(dangerInput) dangerInput.value = thresholds.danger;
    },
    
    // Sauvegarde le budget
    saveBudget: () => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.total = parseFloat(document.getElementById('expenses-budget-total').value) || 0;
        state.data.budget.currency = document.getElementById('expenses-currency').value;
        
        // Synchroniser avec la pr√©sentation
        if(!state.data.presentation) state.data.presentation = {};
        state.data.presentation.budget = state.data.budget.total;
        
        // Mettre √† jour le champ dans la pr√©sentation si visible
        const projectBudgetInput = document.getElementById('project-budget');
        if(projectBudgetInput) projectBudgetInput.value = state.data.budget.total || '';
        
        Store.save();
        Expenses.updateSummary();
    },
    
    // Changer le mode HT/TTC
    setVatMode: (mode) => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.vatMode = mode;
        
        // Mettre √† jour les boutons
        const btnHT = document.getElementById('vat-mode-ht');
        const btnTTC = document.getElementById('vat-mode-ttc');
        if(btnHT) {
            btnHT.style.background = mode === 'HT' ? 'var(--primary)' : 'var(--bg)';
            btnHT.style.color = mode === 'HT' ? 'white' : 'var(--text-main)';
            btnHT.style.borderColor = mode === 'HT' ? 'var(--primary)' : 'var(--border)';
        }
        if(btnTTC) {
            btnTTC.style.background = mode === 'TTC' ? 'var(--primary)' : 'var(--bg)';
            btnTTC.style.color = mode === 'TTC' ? 'white' : 'var(--text-main)';
            btnTTC.style.borderColor = mode === 'TTC' ? 'var(--primary)' : 'var(--border)';
        }
        
        Store.save();
        Expenses.loadBudget();
        Expenses.populateCategories();
        Expenses.updateSummary();
    },
    
    // Sauvegarder la TVA par d√©faut
    saveDefaultVat: () => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.defaultVatRate = parseFloat(document.getElementById('expenses-default-vat').value) || 20;
        Store.save();
    },
    
    // Sauvegarder les seuils d'alerte
    saveAlertThresholds: () => {
        if(!state.data.budget) state.data.budget = {};
        if(!state.data.budget.alertThresholds) state.data.budget.alertThresholds = {};
        state.data.budget.alertThresholds.warning = parseFloat(document.getElementById('alert-threshold-warning').value) || 80;
        state.data.budget.alertThresholds.danger = parseFloat(document.getElementById('alert-threshold-danger').value) || 100;
        Store.save();
        Expenses.populateCategories();
    },
    
    // Sauvegarde le manager
    saveManager: () => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.manager = document.getElementById('expenses-manager').value;
        Store.save();
    },
    
    // Sauvegarde la pr√©f√©rence email du manager global
    saveManagerEmailPref: () => {
        if(!state.data.budget) state.data.budget = {};
        state.data.budget.managerEmailNotif = document.getElementById('manager-email-notif').checked;
        Store.save();
    },
    
    // Charge la pr√©f√©rence email du manager global
    loadManagerEmailPref: () => {
        const checkbox = document.getElementById('manager-email-notif');
        if(checkbox) {
            checkbox.checked = state.data.budget?.managerEmailNotif !== false; // true par d√©faut
        }
    },
    
    // Affiche la liste des responsables par cat√©gorie CNC
    renderCategoryManagers: () => {
        const container = document.getElementById('dept-managers-list');
        if(!container) return;
        
        const deptManagers = state.data.budget?.deptManagers || {};
        
        if(Object.keys(deptManagers).length === 0) {
            container.innerHTML = '<div style="color: var(--text-sec); font-size: 0.85rem; padding: 10px; text-align: center;">Aucun responsable assign√©</div>';
            return;
        }
        
        let html = '';
        Object.entries(deptManagers).forEach(([catId, manager]) => {
            const cat = Expenses.getCategory(catId);
            if(!cat || !manager.email) return;
            
            const person = Expenses.findPersonByEmail(manager.email);
            const name = person?.name || manager.email.split('@')[0];
            
            html += `<div class="dept-manager-item">
                <div class="dept-manager-info">
                    <span class="dept-manager-dept">${cat.icon} ${cat.name}</span>
                    <span class="dept-manager-name">${Utils.escape(name)}</span>
                </div>
                <div class="dept-manager-actions">
                    <label title="Recevoir les emails" style="cursor: pointer;">
                        <input type="checkbox" ${manager.emailNotif !== false ? 'checked' : ''} onchange="app.Expenses.toggleDeptManagerEmail('${catId}', this.checked)">
                        üìß
                    </label>
                    <button onclick="app.Expenses.removeDeptManager('${catId}')" title="Retirer" style="background: none; border: none; cursor: pointer; color: var(--danger);">‚úï</button>
                </div>
            </div>`;
        });
        
        container.innerHTML = html;
    },
    
    // Alias pour r√©trocompatibilit√©
    renderDeptManagers: () => {
        Expenses.renderCategoryManagers();
    },
    
    // Trouve une personne par email
    findPersonByEmail: (email) => {
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const allPeople = [...actors, ...crew];
        return allPeople.find(p => p.email === email);
    },
    
    // Supprime un responsable d√©partement
    removeDeptManager: async (deptId) => {
        const dept = Expenses.departments.find(d => d.id === deptId);
        if(!await ConfirmModal.confirmDelete(`Le responsable de ${dept?.name} sera retir√©.`)) return;
        
        if(state.data.budget?.deptManagers) {
            delete state.data.budget.deptManagers[deptId];
            Store.save();
            Expenses.renderDeptManagers();
            Utils.toast('Responsable retir√©', 'success');
        }
    },
    
    // Toggle email notification pour un responsable d√©partement
    toggleDeptManagerEmail: (deptId, enabled) => {
        if(state.data.budget?.deptManagers?.[deptId]) {
            state.data.budget.deptManagers[deptId].emailNotif = enabled;
            Store.save();
        }
    },
    
    // V√©rifie si l'utilisateur est responsable d'un d√©partement
    isDeptManager: (deptId) => {
        const manager = state.data.budget?.deptManagers?.[deptId];
        return manager && manager.email === state.currentUser?.email;
    },
    
    // V√©rifie si l'utilisateur peut valider une d√©pense
    canValidateExpense: (expense) => {
        // Le responsable budget global peut tout valider
        if(Expenses.isBudgetManager()) return true;
        
        // Le responsable du d√©partement peut valider les d√©penses de son d√©partement
        if(expense.department && expense.department !== 'divers') {
            return Expenses.isDeptManager(expense.department);
        }
        
        return false;
    },
    
    // Sauvegarde les param√®tres financiers
    saveFinanceParams: () => {
        if(!state.data.budget) state.data.budget = {};
        
        state.data.budget.kmRate = parseFloat(document.getElementById('param-km-rate').value) || 0.55;
        state.data.budget.perDiemMeal = parseFloat(document.getElementById('param-perdiem-meal').value) || 19;
        state.data.budget.perDiemHotel = parseFloat(document.getElementById('param-perdiem-hotel').value) || 80;
        state.data.budget.overtimeThreshold = parseFloat(document.getElementById('param-overtime-threshold').value) || 8;
        state.data.budget.overtimeRates = {
            first: parseFloat(document.getElementById('param-overtime-1').value) || 25,
            second: parseFloat(document.getElementById('param-overtime-2').value) || 50,
            third: parseFloat(document.getElementById('param-overtime-3').value) || 100
        };
        
        Store.save();
        Utils.toast('Param√®tres financiers enregistr√©s', 'success');
    },
    
    // Charge les param√®tres financiers
    loadFinanceParams: () => {
        const budget = state.data.budget || {};
        
        document.getElementById('param-km-rate').value = budget.kmRate ?? 0.55;
        document.getElementById('param-perdiem-meal').value = budget.perDiemMeal ?? 19;
        document.getElementById('param-perdiem-hotel').value = budget.perDiemHotel ?? 80;
        document.getElementById('param-overtime-threshold').value = budget.overtimeThreshold ?? 8;
        
        const rates = budget.overtimeRates || { first: 25, second: 50, third: 100 };
        document.getElementById('param-overtime-1').value = rates.first ?? 25;
        document.getElementById('param-overtime-2').value = rates.second ?? 50;
        document.getElementById('param-overtime-3').value = rates.third ?? 100;
    },
    
    // √âditer le budget pr√©visionnel d'une cat√©gorie CNC
    editCategoryBudget: (catId) => {
        const cat = Expenses.getCategory(catId);
        if(!cat) return;
        
        // Seul le responsable budget peut modifier
        if(!Expenses.isBudgetManager()) {
            Utils.toast('Seul le responsable budget peut modifier les pr√©visionnels', 'error');
            return;
        }
        
        const currency = state.data.budget?.currency || '‚Ç¨';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const current = state.data.budget?.previsionnel?.[catId] || { budgetHT: 0, budgetTTC: 0 };
        const currentManager = state.data.budget?.deptManagers?.[catId] || {};
        
        // Liste des personnes pour le responsable
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const allPeople = [...actors, ...crew].filter(p => p.email);
        
        let peopleOptions = '<option value="">-- Aucun responsable --</option>';
        allPeople.forEach(p => {
            const selected = currentManager.email === p.email ? 'selected' : '';
            peopleOptions += `<option value="${p.email}" ${selected}>${Utils.escape(p.name)} (${p.email})</option>`;
        });
        
        // Sous-cat√©gories
        let subcatHtml = '<div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);"><label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:8px;">üìÇ Sous-cat√©gories</label>';
        cat.subcats.forEach(sub => {
            subcatHtml += `<div style="font-size:0.85rem; color:var(--text-main); padding:4px 0;">‚Ä¢ ${sub.name}</div>`;
        });
        subcatHtml += '</div>';
        
        const modal = document.createElement('div');
        modal.id = 'category-budget-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:450px; max-width:90%; max-height:90vh; overflow-y:auto;">
                <h3 style="margin:0 0 20px; color:var(--text-main);">${cat.icon} ${cat.code}. ${cat.name}</h3>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:5px;">üí∞ Budget HT (${currency})</label>
                        <input type="number" id="cat-budget-ht" value="${current.budgetHT || ''}" placeholder="0" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); font-size:1rem;" oninput="document.getElementById('cat-budget-ttc').value = Math.round(this.value * 1.2 * 100) / 100">
                    </div>
                    <div>
                        <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:5px;">üí∞ Budget TTC (${currency})</label>
                        <input type="number" id="cat-budget-ttc" value="${current.budgetTTC || ''}" placeholder="0" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); font-size:1rem;" oninput="document.getElementById('cat-budget-ht').value = Math.round(this.value / 1.2 * 100) / 100">
                    </div>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:5px;">üë§ Responsable de la cat√©gorie</label>
                    <select id="cat-manager" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                        ${peopleOptions}
                    </select>
                </div>
                
                <label style="display:flex; align-items:center; gap:8px; margin-bottom:15px; font-size:0.9rem; cursor:pointer; color:var(--text-main);">
                    <input type="checkbox" id="cat-manager-email" ${currentManager.emailNotif !== false ? 'checked' : ''}>
                    üìß Notifier par email
                </label>
                
                ${subcatHtml}
                
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                    <button onclick="document.getElementById('category-budget-modal').remove()" style="padding:10px 20px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Annuler</button>
                    <button onclick="app.Expenses.saveCategoryBudget('${catId}')" style="padding:10px 20px; background:var(--success); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">üíæ Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('cat-budget-ht').focus();
    },
    
    // Sauvegarder le budget d'une cat√©gorie
    saveCategoryBudget: (catId) => {
        const budgetHT = parseFloat(document.getElementById('cat-budget-ht').value) || 0;
        const budgetTTC = parseFloat(document.getElementById('cat-budget-ttc').value) || 0;
        const managerEmail = document.getElementById('cat-manager').value;
        const managerEmailNotif = document.getElementById('cat-manager-email').checked;
        
        if(!state.data.budget) state.data.budget = {};
        if(!state.data.budget.previsionnel) state.data.budget.previsionnel = {};
        if(!state.data.budget.deptManagers) state.data.budget.deptManagers = {};
        
        // Sauvegarder le pr√©visionnel
        state.data.budget.previsionnel[catId] = { budgetHT, budgetTTC };
        
        // Sauvegarder le responsable
        if(managerEmail) {
            state.data.budget.deptManagers[catId] = {
                email: managerEmail,
                emailNotif: managerEmailNotif,
                assignedAt: state.data.budget.deptManagers[catId]?.assignedAt || new Date().toISOString(),
                assignedBy: state.data.budget.deptManagers[catId]?.assignedBy || state.currentUser?.email
            };
        } else {
            delete state.data.budget.deptManagers[catId];
        }
        
        // Recalculer le budget total
        let totalHT = 0;
        Object.values(state.data.budget.previsionnel).forEach(p => {
            totalHT += p.budgetHT || 0;
        });
        state.data.budget.total = totalHT;
        
        Store.save();
        
        document.getElementById('category-budget-modal').remove();
        Expenses.populateCategories();
        Expenses.updateSummary();
        Expenses.loadBudget();
        Utils.toast('Budget de la cat√©gorie mis √† jour !', 'success');
    },
    
    // Renommer pour r√©trocompatibilit√© (ancienne fonction)
    editEnvelope: (deptId, deptName) => {
        // Seul le responsable budget ou le propri√©taire peut modifier les enveloppes
        if(!Expenses.isBudgetManager()) {
            Utils.toast('Seul le responsable budget peut modifier les param√®tres', 'error');
            return;
        }
        
        const currentEnvelope = state.data.budget?.envelopes?.[deptId] || 0;
        const currency = state.data.budget?.currency || '‚Ç¨';
        const currentManager = state.data.budget?.deptManagers?.[deptId] || {};
        
        // Construire la liste des personnes pour le responsable
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const allPeople = [...actors, ...crew].filter(p => p.email);
        
        let peopleOptions = '<option value="">-- Aucun responsable --</option>';
        allPeople.forEach(p => {
            const selected = currentManager.email === p.email ? 'selected' : '';
            peopleOptions += `<option value="${p.email}" ${selected}>${Utils.escape(p.name)} (${p.email})</option>`;
        });
        
        const modal = document.createElement('div');
        modal.id = 'envelope-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:400px; max-width:90%;">
                <h3 style="margin:0 0 20px; color:var(--text-main);">‚öôÔ∏è ${deptName}</h3>
                
                <div style="margin-bottom:20px;">
                    <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:5px;">üí∞ Budget allou√© (${currency})</label>
                    <input type="number" id="envelope-amount" value="${currentEnvelope}" placeholder="0" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); font-size:1.1rem;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:5px;">üë§ Responsable du d√©partement</label>
                    <select id="envelope-manager" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                        ${peopleOptions}
                    </select>
                </div>
                
                <label style="display:flex; align-items:center; gap:8px; margin-bottom:20px; font-size:0.9rem; cursor:pointer; color:var(--text-main);">
                    <input type="checkbox" id="envelope-manager-email" ${currentManager.emailNotif !== false ? 'checked' : ''}>
                    üìß Notifier par email
                </label>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="document.getElementById('envelope-modal').remove()" style="padding:10px 20px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Annuler</button>
                    <button onclick="app.Expenses.saveEnvelope('${deptId}')" style="padding:10px 20px; background:var(--success); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">üíæ Enregistrer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('envelope-amount').focus();
    },
    
    isBudgetManager: () => {
        // Le propri√©taire du projet a toujours acc√®s
        if(state.currentRole === 'owner') return true;
        
        // V√©rifier si l'utilisateur est le responsable budget
        const managerEmail = state.data.budget?.manager;
        if(!managerEmail || !state.currentUser) return false;
        
        return state.currentUser.email === managerEmail;
    },
    
    saveEnvelope: (deptId) => {
        const amount = parseFloat(document.getElementById('envelope-amount').value) || 0;
        const managerEmail = document.getElementById('envelope-manager').value;
        const managerEmailNotif = document.getElementById('envelope-manager-email').checked;
        
        if(!state.data.budget) state.data.budget = {};
        if(!state.data.budget.envelopes) state.data.budget.envelopes = {};
        if(!state.data.budget.deptManagers) state.data.budget.deptManagers = {};
        
        // Sauvegarder l'enveloppe
        state.data.budget.envelopes[deptId] = amount;
        
        // Sauvegarder le responsable d√©partement
        if(managerEmail) {
            state.data.budget.deptManagers[deptId] = {
                email: managerEmail,
                emailNotif: managerEmailNotif,
                assignedAt: state.data.budget.deptManagers[deptId]?.assignedAt || new Date().toISOString(),
                assignedBy: state.data.budget.deptManagers[deptId]?.assignedBy || state.currentUser?.email
            };
        } else {
            // Supprimer le responsable si aucun s√©lectionn√©
            delete state.data.budget.deptManagers[deptId];
        }
        
        Store.save();
        
        document.getElementById('envelope-modal').remove();
        Expenses.populateDepartments();
        Expenses.updateDeptTotals();
        Utils.toast('Param√®tres du d√©partement mis √† jour !', 'success');
    },
    
    // Rendu principal
    render: () => {
        Expenses.updateSummary();
        Expenses.updateDeptTotals();
        Expenses.populateDepartments();
        Expenses.renderExpensesList();
        Expenses.renderSalaries();
        Expenses.updateSalariesVisibility();
    },
    
    // Met √† jour les totaux
    updateSummary: () => {
        const currency = state.data.budget?.currency || '‚Ç¨';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const previsionnel = state.data.budget?.previsionnel || {};
        
        // Calculer le budget total depuis le pr√©visionnel
        let budgetTotal = 0;
        Object.values(previsionnel).forEach(p => {
            budgetTotal += vatMode === 'HT' ? (p.budgetHT || 0) : (p.budgetTTC || 0);
        });
        // Fallback sur l'ancien total si pas de pr√©visionnel
        if(budgetTotal === 0) budgetTotal = state.data.budget?.total || 0;
        
        // Calculer le total d√©pens√© (selon mode HT/TTC)
        let totalSpent = 0;
        state.data.expenses?.forEach(exp => {
            if(exp.status === 'approved' || exp.status === 'done') {
                if(vatMode === 'HT') {
                    totalSpent += parseFloat(exp.amountHT) || parseFloat(exp.amount) || 0;
                } else {
                    totalSpent += parseFloat(exp.amountTTC) || parseFloat(exp.amount) || 0;
                }
            }
        });
        
        // Ajouter les salaires calcul√©s (mode avanc√© uniquement)
        if(Expenses.mode === 'advanced') {
            const salariesTotal = Expenses.calculateSalariesTotal();
            totalSpent += salariesTotal;
        }
        
        const remaining = budgetTotal - totalSpent;
        const percentUsed = budgetTotal > 0 ? Math.round((totalSpent / budgetTotal) * 100) : 0;
        
        // Mode avanc√©
        const budgetEl = document.getElementById('expenses-total-budget');
        const spentEl = document.getElementById('expenses-total-spent');
        const remainingEl = document.getElementById('expenses-total-remaining');
        
        if(budgetEl) budgetEl.textContent = budgetTotal.toLocaleString() + ' ' + currency + ' ' + vatMode;
        if(spentEl) spentEl.innerHTML = totalSpent.toLocaleString() + ' ' + currency + ` <span style="font-size:0.75rem; opacity:0.8;">(${percentUsed}%)</span>`;
        if(remainingEl) remainingEl.textContent = remaining.toLocaleString() + ' ' + currency;
        
        // Changer la couleur si d√©passement (mode avanc√©)
        const remainingCard = remainingEl?.parentElement;
        if(remainingCard) {
            if(remaining < 0) {
                remainingCard.classList.remove('success');
                remainingCard.classList.add('danger');
            } else {
                remainingCard.classList.remove('danger');
                remainingCard.classList.add('success');
            }
        }
        
        // Mode simple
        const spentSimple = document.getElementById('expenses-spent-simple');
        const remainingSimple = document.getElementById('expenses-remaining-simple');
        const remainingSimpleCard = document.getElementById('expenses-remaining-simple-card');
        
        if(spentSimple) spentSimple.textContent = totalSpent.toLocaleString() + ' ' + currency;
        if(remainingSimple) remainingSimple.textContent = remaining.toLocaleString() + ' ' + currency;
        if(remainingSimpleCard) {
            remainingSimpleCard.style.background = remaining < 0 ? 'var(--danger)' : 'var(--success)';
        }
        
        // Mettre √† jour le champ budget total
        const budgetInput = document.getElementById('expenses-budget-total');
        if(budgetInput) budgetInput.value = budgetTotal || '';
    },
    
    // Met √† jour les totaux par cat√©gorie (maintenant g√©r√© par populateCategories)
    updateDeptTotals: () => {
        // Cette fonction est maintenant g√©r√©e par populateCategories()
        // On la garde pour r√©trocompatibilit√© mais elle appelle simplement populateCategories
        Expenses.populateCategories();
    },
    
    // Applique les filtres
    applyFilters: () => {
        // Mode simple ou avanc√©
        if(Expenses.mode === 'simple') {
            const statusFilter = document.getElementById('expenses-filter-status-simple')?.value || '';
            const searchFilter = document.getElementById('expenses-filter-search-simple')?.value?.toLowerCase() || '';
            
            // Convertir les statuts simples
            if(statusFilter === 'paid') {
                Expenses.filterStatus = 'done';
            } else if(statusFilter === 'unpaid') {
                Expenses.filterStatus = 'pending';
            } else {
                Expenses.filterStatus = '';
            }
            
            Expenses.filterDept = '';
            Expenses.filterSearch = searchFilter;
        } else {
            Expenses.filterDept = document.getElementById('expenses-filter-dept')?.value || '';
            Expenses.filterStatus = document.getElementById('expenses-filter-status')?.value || '';
            Expenses.filterSearch = document.getElementById('expenses-filter-search')?.value?.toLowerCase() || '';
        }
        
        Expenses.renderExpensesList();
        Expenses.populateDepartments();
        Expenses.updateSalariesVisibility();
    },
    
    // Afficher/masquer la section salaires selon le mode et le d√©partement
    updateSalariesVisibility: () => {
        const salariesSection = document.getElementById('expenses-salaries-section');
        if(salariesSection) {
            const show = Expenses.mode === 'advanced' && (Expenses.filterDept === 'salaires' || Expenses.filterDept === '');
            salariesSection.style.display = show ? 'block' : 'none';
        }
    },
    
    // V√©rifier les informations manquantes pour les contrats/salaires
    checkMissingInfo: () => {
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        const missing = [];
        
        // V√©rifier les acteurs
        actors.forEach(actor => {
            if(!actor.name) return;
            const issues = [];
            
            if(!actor.email) issues.push('Email');
            if(!actor.address) issues.push('Adresse');
            if(!actor.dailyRate) issues.push('Tarif journalier');
            
            if(actor.professionalStatus === 'intermittent') {
                if(!actor.numSecu) issues.push('N¬∞ S√©curit√© Sociale');
                if(!actor.numCongesSpectacles) issues.push('N¬∞ Cong√©s Spectacles');
            } else if(actor.professionalStatus === 'micro-entrepreneur') {
                if(!actor.siret) issues.push('N¬∞ SIRET');
            } else if(!actor.professionalStatus) {
                issues.push('Statut professionnel');
            }
            
            if(issues.length > 0) {
                missing.push({ type: 'actor', person: actor, issues: issues });
            }
        });
        
        // V√©rifier les techniciens
        crew.forEach(member => {
            if(!member.name) return;
            const issues = [];
            
            if(!member.email) issues.push('Email');
            if(!member.address) issues.push('Adresse');
            if(!member.dailyRate) issues.push('Tarif journalier');
            
            if(member.professionalStatus === 'intermittent') {
                if(!member.numSecu) issues.push('N¬∞ S√©curit√© Sociale');
                if(!member.numCongesSpectacles) issues.push('N¬∞ Cong√©s Spectacles');
            } else if(member.professionalStatus === 'micro-entrepreneur') {
                if(!member.siret) issues.push('N¬∞ SIRET');
            } else if(!member.professionalStatus) {
                issues.push('Statut professionnel');
            }
            
            if(issues.length > 0) {
                missing.push({ type: 'crew', person: member, issues: issues });
            }
        });
        
        Expenses.showMissingInfoModal(missing);
    },
    
    // Afficher la modale des infos manquantes
    showMissingInfoModal: (missing) => {
        const modal = document.createElement('div');
        modal.id = 'missing-info-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        let content = '';
        
        if(missing.length === 0) {
            content = `
                <div style="text-align:center; padding:40px;">
                    <div style="font-size:4rem; margin-bottom:20px;">‚úÖ</div>
                    <h3 style="margin:0 0 10px; color:var(--success);">Tout est complet !</h3>
                    <p style="color:var(--text-sec);">Toutes les fiches ont les informations n√©cessaires.</p>
                </div>
            `;
        } else {
            content = `
                <div style="margin-bottom:20px;">
                    <div style="background:#FF9800; color:white; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <strong>‚ö†Ô∏è ${missing.length} fiche${missing.length > 1 ? 's' : ''} avec des informations manquantes</strong>
                    </div>
                    <div style="max-height:400px; overflow-y:auto;">
                        ${missing.map(m => `
                            <div style="background:var(--bg); border-radius:8px; padding:15px; margin-bottom:10px; border-left:4px solid #FF9800;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <strong>${m.type === 'actor' ? 'üé≠' : 'üé¨'} ${Utils.escape(m.person.name)}</strong>
                                    ${m.person.email ? `<button onclick="app.Expenses.sendReminderEmail('${m.type}', '${m.person.id}')" style="padding:6px 12px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.85rem;">üìß Envoyer rappel</button>` : ''}
                                </div>
                                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                                    ${m.issues.map(issue => `<span style="background:var(--danger); color:white; padding:3px 8px; border-radius:4px; font-size:0.8rem;">‚ùå ${issue}</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="app.Expenses.sendAllReminderEmails()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">üìß Envoyer rappel √† tous</button>
                </div>
            `;
        }
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:600px; max-width:90%; max-height:80vh; overflow:hidden;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0;">üîç V√©rification des informations</h3>
                    <button onclick="document.getElementById('missing-info-modal').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">‚úï</button>
                </div>
                ${content}
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Envoyer un email de rappel
    sendReminderEmail: async (type, personId) => {
        const list = type === 'actor' ? state.data.actors : state.data.crew;
        const person = list?.find(p => p.id === personId);
        
        if(!person || !person.email) {
            Utils.toast('Aucun email disponible', 'error');
            return;
        }
        
        const issues = [];
        if(!person.address) issues.push('ton adresse');
        if(!person.dailyRate) issues.push('ton tarif journalier');
        if(!person.professionalStatus) issues.push('ton statut professionnel');
        if(person.professionalStatus === 'intermittent') {
            if(!person.numSecu) issues.push('ton num√©ro de S√©curit√© Sociale');
            if(!person.numCongesSpectacles) issues.push('ton num√©ro Cong√©s Spectacles');
        }
        if(person.professionalStatus === 'micro-entrepreneur' && !person.siret) {
            issues.push('ton num√©ro SIRET');
        }
        
        const projectTitle = state.data.title || 'Sans titre';
        
        try {
            await emailjs.send('service_3doh6ch', 'template_kcn4svi', {
                to_email: person.email,
                to_name: person.name,
                from_name: state.currentUser?.displayName || state.currentUser?.email || 'L\'√©quipe',
                project_title: projectTitle,
                subject: `üé¨ ${projectTitle} - Informations manquantes sur ton profil`,
                message: `Salut ${person.name} ! üëã\n\nLe projet "${projectTitle}" a besoin de quelques informations pour compl√©ter ta fiche et pr√©parer les contrats/salaires.\n\nIl manque : ${issues.join(', ')}\n\nPeux-tu mettre √† jour ton profil sur Moteur quand tu as 2 minutes ?\n\nMerci ! üé¨`,
                reply_to: state.currentUser?.email || ''
            });
            
            Utils.toast(`üìß Email envoy√© √† ${person.name}`, 'success');
        } catch(e) {
            console.error('Erreur envoi email:', e);
            Utils.toast('Erreur lors de l\'envoi', 'error');
        }
    },
    
    // Envoyer rappel √† tous
    sendAllReminderEmails: async () => {
        const actors = state.data.actors || [];
        const crew = state.data.crew || [];
        let sent = 0;
        
        const check = async (person, type) => {
            if(!person.email) return;
            let hasMissing = !person.address || !person.dailyRate || !person.professionalStatus;
            if(person.professionalStatus === 'intermittent' && (!person.numSecu || !person.numCongesSpectacles)) hasMissing = true;
            if(person.professionalStatus === 'micro-entrepreneur' && !person.siret) hasMissing = true;
            
            if(hasMissing) {
                await Expenses.sendReminderEmail(type, person.id);
                sent++;
            }
        };
        
        for(const actor of actors) { await check(actor, 'actor'); }
        for(const member of crew) { await check(member, 'crew'); }
        
        Utils.toast(sent > 0 ? `üìß ${sent} email${sent > 1 ? 's' : ''} envoy√©${sent > 1 ? 's' : ''}` : 'Aucun email √† envoyer', sent > 0 ? 'success' : 'info');
        document.getElementById('missing-info-modal')?.remove();
    },
    
    // Remplit le select "Pay√© par" avec les membres du projet
    populatePaidBySelect: () => {
        const select = document.getElementById('expense-paid-by');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Production / Non remboursable --</option>';
        
        // Ajouter les com√©diens
        (state.data.actors || []).forEach(actor => {
            if(actor.name) {
                const opt = document.createElement('option');
                opt.value = 'actor_' + actor.id;
                opt.textContent = 'üé≠ ' + actor.name;
                select.appendChild(opt);
            }
        });
        
        // Ajouter les techniciens
        (state.data.crew || []).forEach(member => {
            if(member.name) {
                const opt = document.createElement('option');
                opt.value = 'crew_' + member.id;
                opt.textContent = 'üé¨ ' + member.name;
                select.appendChild(opt);
            }
        });
    },
    
    // Affiche la liste des d√©penses
    renderExpensesList: () => {
        const container = document.getElementById('expenses-list');
        if(!container) return;
        
        let expenses = [...(state.data.expenses || [])];
        
        // Appliquer les filtres (supporte category OU department pour r√©trocompatibilit√©)
        if(Expenses.filterDept) {
            expenses = expenses.filter(e => e.category === Expenses.filterDept || e.department === Expenses.filterDept);
        }
        if(Expenses.filterStatus) {
            expenses = expenses.filter(e => e.status === Expenses.filterStatus);
        }
        if(Expenses.filterSearch) {
            expenses = expenses.filter(e => 
                e.title?.toLowerCase().includes(Expenses.filterSearch) ||
                e.description?.toLowerCase().includes(Expenses.filterSearch)
            );
        }
        
        // Trier par date (plus r√©cent en premier)
        expenses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        if(expenses.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí∞</div>
                    <div class="empty-state-title">Aucune d√©pense</div>
                    <div class="empty-state-desc">Suivez le budget de votre production en enregistrant les d√©penses. Chaque d√©pense peut √™tre valid√©e par un responsable.</div>
                    <button class="empty-state-btn" onclick="app.Expenses.openAddModal()">+ Ajouter une d√©pense</button>
                    <div class="empty-state-tips">üí° <strong>Astuce :</strong> D√©finissez le budget pr√©visionnel par cat√©gorie CNC dans la barre lat√©rale.</div>
                </div>
            `;
            return;
        }
        
        const currency = state.data.budget?.currency || '‚Ç¨';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const currentUserEmail = state.currentUser?.email;
        const isGlobalManager = state.data.budget?.manager === currentUserEmail || state.currentRole === 'owner';
        
        let html = '';
        expenses.forEach(exp => {
            const statusLabels = {
                pending: '‚è≥ En attente',
                approved: '‚úÖ Valid√©',
                rejected: '‚ùå Refus√©',
                done: 'üí∞ Pay√©',
                escalated: '‚¨ÜÔ∏è Remont√©',
                returned: '‚Ü©Ô∏è Renvoy√©'
            };
            
            // Obtenir le label de la cat√©gorie CNC
            const cat = Expenses.getCategory(exp.category || exp.department);
            const catLabel = cat ? `${cat.icon} ${cat.code}. ${cat.name}` : (exp.category || exp.department || 'Non class√©');
            
            // Sous-cat√©gorie si pr√©sente
            let subcatLabel = '';
            if(exp.subcategory && cat) {
                const subcat = cat.subcats?.find(s => s.id === exp.subcategory);
                if(subcat) subcatLabel = subcat.name;
            }
            
            const date = exp.date ? new Date(exp.date).toLocaleDateString('fr-FR') : '';
            const isDeptManager = Expenses.isDeptManager(exp.category || exp.department);
            const isCreator = exp.createdBy === currentUserEmail;
            
            // Permissions
            const canValidateAsGlobal = isGlobalManager && (exp.status === 'pending' || exp.status === 'escalated');
            const canValidateAsDept = isDeptManager && exp.status === 'pending';
            const canValidate = canValidateAsGlobal || canValidateAsDept;
            const canEscalate = isDeptManager && exp.status === 'pending' && !isGlobalManager;
            const canReturn = (isDeptManager || isGlobalManager) && (exp.status === 'pending' || exp.status === 'escalated');
            const canEdit = isCreator || isGlobalManager;
            const canDelete = isCreator || isGlobalManager || isDeptManager;
            
            // Message de renvoi
            const returnedMsg = exp.status === 'returned' && exp.returnedReason ? 
                `<div style="background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; padding: 8px 12px; margin: 10px 0; font-size: 0.85rem;">
                    <strong>‚Ü©Ô∏è Renvoy√© par ${Utils.escape(exp.returnedByName || 'un responsable')}</strong><br>
                    ${Utils.escape(exp.returnedReason)}
                </div>` : '';
            
            // Montants HT/TTC
            const amountHT = exp.amountHT || exp.amount || 0;
            const amountTTC = exp.amountTTC || exp.amount || 0;
            const vatRate = exp.vatRate || 0;
            const displayAmount = vatMode === 'HT' ? amountHT : amountTTC;
            
            // Infos TVA
            const vatInfo = vatRate > 0 ? `<span style="font-size: 0.75rem; color: var(--text-sec); margin-left: 5px;">(${amountHT.toLocaleString()} HT + ${vatRate}% TVA)</span>` : '';
            
            // Pi√®ces jointes
            let attachmentsHtml = '';
            const attachments = exp.attachments || [];
            if(attachments.length > 0 || exp.photo) {
                const allAttachments = attachments.length > 0 ? attachments : (exp.photo ? [{ url: exp.photo, type: 'photo' }] : []);
                attachmentsHtml = `<div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">`;
                allAttachments.slice(0, 4).forEach(att => {
                    const src = att.data || att.url;
                    if(att.type === 'photo' || src?.startsWith('data:image')) {
                        attachmentsHtml += `<img src="${src}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); cursor: pointer;" onclick="window.open('${src}', '_blank')" onerror="this.style.display='none'">`;
                    } else {
                        attachmentsHtml += `<a href="${src}" target="_blank" style="width: 60px; height: 60px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; text-decoration: none;">üìÑ</a>`;
                    }
                });
                if(allAttachments.length > 4) {
                    attachmentsHtml += `<div style="width: 60px; height: 60px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; color: var(--text-sec);">+${allAttachments.length - 4}</div>`;
                }
                attachmentsHtml += `</div>`;
            }
            
            html += `
                <div class="expense-card ${exp.status === 'returned' ? 'returned' : ''} ${exp.salaryMissingRate ? 'missing-rate' : ''}">
                    <div class="expense-card-header">
                        <div>
                            <div class="expense-card-title">${Utils.escape(exp.title)}</div>
                            <div class="expense-card-meta">
                                <span class="expense-card-dept">${catLabel}</span>
                                ${subcatLabel ? `<span style="font-size: 0.7rem; color: var(--text-sec); margin-left: 5px;">‚Ä∫ ${subcatLabel}</span>` : ''}
                                <span class="expense-card-status ${exp.status}">${statusLabels[exp.status] || exp.status}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="expense-card-amount">${parseFloat(displayAmount).toLocaleString()} ${currency} ${vatMode}</div>
                            ${vatRate > 0 ? `<div style="font-size: 0.7rem; color: var(--text-sec);">${amountHT.toLocaleString()} HT + TVA ${vatRate}%</div>` : ''}
                        </div>
                    </div>
                    ${exp.description ? `<div style="font-size: 0.9rem; color: var(--text-sec); margin-bottom: 10px;">${Utils.escape(exp.description)}</div>` : ''}
                    ${returnedMsg}
                    <div class="expense-card-meta">
                        ${date ? `üìÖ ${date} ‚Ä¢ ` : ''}üë§ ${Utils.escape(exp.createdByName || exp.createdBy || 'Inconnu')}
                        ${exp.paidByName ? ` ‚Ä¢ üí≥ Pay√© par ${Utils.escape(exp.paidByName)}` : ''}
                        ${exp.validatedBy ? ` ‚Ä¢ ‚úì Valid√© par ${Utils.escape(exp.validatedByName || exp.validatedBy)}` : ''}
                        ${exp.status === 'escalated' ? ` ‚Ä¢ ‚¨ÜÔ∏è Remont√© au responsable global` : ''}
                        ${exp.salaryMissingRate ? ` ‚Ä¢ <span style="color: var(--danger);">‚ö†Ô∏è Tarif manquant</span>` : ''}
                    </div>
                    ${attachmentsHtml}
                    <div class="expense-card-actions">
                        ${canValidate ? `<button class="expense-btn-approve" onclick="app.Expenses.validateExpense('${exp.id}')">‚úÖ Valider</button>` : ''}
                        ${canEscalate ? `<button class="expense-btn-escalate" onclick="app.Expenses.escalateExpense('${exp.id}')">‚¨ÜÔ∏è Remonter</button>` : ''}
                        ${canReturn ? `<button class="expense-btn-return" onclick="app.Expenses.openReturnModal('${exp.id}')">‚Ü©Ô∏è Renvoyer</button>` : ''}
                        <button class="expense-btn-edit" onclick="app.Expenses.duplicateExpense('${exp.id}')" title="Dupliquer">üìã</button>
                        ${canEdit ? `<button class="expense-btn-edit" onclick="app.Expenses.editExpense('${exp.id}')">‚úèÔ∏è</button>` : ''}
                        ${canDelete ? `<button class="expense-btn-reject" onclick="app.Expenses.deleteExpense('${exp.id}')">üóëÔ∏è</button>` : ''}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    // Calcule le total des salaires bas√© sur les jours de tournage (shootingDays)
    calculateSalariesTotal: () => {
        let total = 0;
        const shootingDays = state.data.shootingDays || [];
        
        // Compter les jours par personne depuis les callSheets
        const daysByPerson = {};
        
        shootingDays.forEach(day => {
            if(!day.callSheet || day.callSheet.length === 0) return;
            
            day.callSheet.forEach(call => {
                const key = `${call.type}_${call.personId}`;
                if(!daysByPerson[key]) {
                    daysByPerson[key] = { type: call.type, personId: call.personId, days: 0 };
                }
                daysByPerson[key].days++;
            });
        });
        
        // Calculer les salaires
        Object.values(daysByPerson).forEach(info => {
            let person = null;
            
            if(info.type === 'actor') {
                person = state.data.actors?.find(a => a.id === info.personId || String(a.id) === String(info.personId));
            } else {
                person = state.data.crew?.find(c => c.id === info.personId || String(c.id) === String(info.personId));
            }
            
            if(person && person.dailyRate) {
                total += parseFloat(person.dailyRate) * info.days;
            }
        });
        
        return total;
    },
    
    // Rendu principal
    render: () => {
        Expenses.updateSummary();
        Expenses.updateDeptTotals();
        Expenses.populateDepartments();
        Expenses.renderExpensesList();
        Expenses.renderSalaries();
        Expenses.updateSalariesVisibility();
    },
    
    // Affiche les salaires calcul√©s bas√©s sur les jours de tournage
    renderSalaries: () => {
        const container = document.getElementById('expenses-salaries-list');
        const totalEl = document.getElementById('expenses-salaries-total');
        if(!container) return;
        
        const currency = state.data.budget?.currency || '‚Ç¨';
        const shootingDays = state.data.shootingDays || [];
        
        // Compter les jours et heures par personne depuis les callSheets
        const daysByPerson = {};
        
        shootingDays.forEach(day => {
            if(!day.callSheet || day.callSheet.length === 0) return;
            
            day.callSheet.forEach(call => {
                const key = `${call.type}_${call.personId}`;
                if(!daysByPerson[key]) {
                    daysByPerson[key] = { type: call.type, personId: call.personId, days: 0, hours: 0 };
                }
                daysByPerson[key].days++;
                
                // Calculer les heures si horaires d√©finis
                if(call.callTime && day.estimatedWrap) {
                    const start = call.callTime.split(':').map(Number);
                    const end = day.estimatedWrap.split(':').map(Number);
                    const hours = (end[0] + end[1]/60) - (start[0] + start[1]/60);
                    if(hours > 0) daysByPerson[key].hours += hours;
                }
            });
        });
        
        let htmlWithRate = '';
        let htmlWithoutRate = '';
        let total = 0;
        
        // Com√©diens
        state.data.actors?.forEach(actor => {
            const key = `actor_${actor.id}`;
            const data = daysByPerson[key];
            if(!data || data.days === 0) return;
            
            const hasRate = actor.dailyRate && parseFloat(actor.dailyRate) > 0;
            const rateType = actor.rateType || 'Jour';
            
            if(hasRate) {
                let salary = 0;
                let detail = '';
                
                if(rateType === 'Heure' && data.hours > 0) {
                    salary = parseFloat(actor.dailyRate) * data.hours;
                    detail = `${data.hours.toFixed(1)}h √ó ${actor.dailyRate} ${currency}/h`;
                } else {
                    salary = parseFloat(actor.dailyRate) * data.days;
                    detail = `${data.days} jour${data.days > 1 ? 's' : ''} √ó ${actor.dailyRate} ${currency}`;
                }
                
                total += salary;
                htmlWithRate += `<div class="salary-item">
                    <div class="salary-info">
                        <span class="salary-name">üé≠ ${Utils.escape(actor.name)}</span>
                        <span class="salary-detail">${detail}</span>
                    </div>
                    <strong class="salary-amount">${salary.toLocaleString()} ${currency}</strong>
                </div>`;
            } else {
                htmlWithoutRate += `<div class="salary-item missing">
                    <div class="salary-info">
                        <span class="salary-name">üé≠ ${Utils.escape(actor.name)}</span>
                        <span class="salary-detail">${data.days} jour${data.days > 1 ? 's' : ''} - ‚ö†Ô∏è Tarif non renseign√©</span>
                    </div>
                    <button onclick="app.UI.switchTab('actors')" class="salary-fix-btn">Compl√©ter</button>
                </div>`;
            }
        });
        
        // Techniciens
        state.data.crew?.forEach(member => {
            const key = `crew_${member.id}`;
            const data = daysByPerson[key];
            if(!data || data.days === 0) return;
            
            const hasRate = member.dailyRate && parseFloat(member.dailyRate) > 0;
            const rateType = member.rateType || 'Jour';
            
            if(hasRate) {
                let salary = 0;
                let detail = '';
                
                if(rateType === 'Heure' && data.hours > 0) {
                    salary = parseFloat(member.dailyRate) * data.hours;
                    detail = `${data.hours.toFixed(1)}h √ó ${member.dailyRate} ${currency}/h`;
                } else {
                    salary = parseFloat(member.dailyRate) * data.days;
                    detail = `${data.days} jour${data.days > 1 ? 's' : ''} √ó ${member.dailyRate} ${currency}`;
                }
                
                total += salary;
                htmlWithRate += `<div class="salary-item">
                    <div class="salary-info">
                        <span class="salary-name">üé¨ ${Utils.escape(member.name)}</span>
                        <span class="salary-detail">${detail}</span>
                    </div>
                    <strong class="salary-amount">${salary.toLocaleString()} ${currency}</strong>
                </div>`;
            } else {
                htmlWithoutRate += `<div class="salary-item missing">
                    <div class="salary-info">
                        <span class="salary-name">üé¨ ${Utils.escape(member.name)}</span>
                        <span class="salary-detail">${data.days} jour${data.days > 1 ? 's' : ''} - ‚ö†Ô∏è Tarif non renseign√©</span>
                    </div>
                    <button onclick="app.UI.switchTab('crew')" class="salary-fix-btn">Compl√©ter</button>
                </div>`;
            }
        });
        
        let html = '';
        
        if(htmlWithRate) {
            html += htmlWithRate;
        }
        
        if(htmlWithoutRate) {
            html += `<div class="salary-section-warning">
                <div style="font-weight:600; margin-bottom:8px;">‚ö†Ô∏è Tarifs manquants</div>
                ${htmlWithoutRate}
            </div>`;
        }
        
        if(!html) {
            html = '<div style="color: var(--text-sec); text-align: center; padding: 10px;">Aucun salaire calcul√©. Ajoutez des tarifs aux com√©diens/techniciens et planifiez des jours de tournage.</div>';
        }
        
        container.innerHTML = html;
        if(totalEl) totalEl.textContent = total.toLocaleString() + ' ' + currency;
    },
    
    // Supprime toutes les d√©penses salaires g√©n√©r√©es
    deleteSalaryExpenses: async () => {
        if(!Expenses.isBudgetManager()) {
            Utils.toast('Seul le responsable budget peut supprimer les d√©penses salaires', 'error');
            return;
        }
        
        const salaryExpenses = state.data.expenses?.filter(e => e.department === 'salaires' && (e.salaryPersonId || e.salaryPersonType)) || [];
        
        if(salaryExpenses.length === 0) {
            Utils.toast('Aucune d√©pense salaire √† supprimer', 'info');
            return;
        }
        
        if(!await ConfirmModal.confirmDelete(`${salaryExpenses.length} d√©pense(s) salaire g√©n√©r√©e(s) seront supprim√©es.`)) return;
        
        state.data.expenses = state.data.expenses.filter(e => !(e.department === 'salaires' && (e.salaryPersonId || e.salaryPersonType)));
        
        Store.save();
        Expenses.render();
        Utils.toast(`${salaryExpenses.length} d√©pense(s) salaire supprim√©e(s)`, 'success');
    },
    
    // G√©n√®re les d√©penses salaires depuis le planning
    generateSalaryExpenses: () => {
        if(!Expenses.isBudgetManager()) {
            Utils.toast('Seul le responsable budget peut g√©n√©rer les d√©penses salaires', 'error');
            return;
        }
        
        const currency = state.data.budget?.currency || '‚Ç¨';
        const shootingDays = state.data.shootingDays || [];
        
        // Compter les jours et heures par personne
        const daysByPerson = {};
        
        shootingDays.forEach(day => {
            if(!day.callSheet || day.callSheet.length === 0) return;
            
            day.callSheet.forEach(call => {
                const key = `${call.type}_${call.personId}`;
                if(!daysByPerson[key]) {
                    daysByPerson[key] = { type: call.type, personId: call.personId, days: 0, hours: 0 };
                }
                daysByPerson[key].days++;
                
                if(call.callTime && day.estimatedWrap) {
                    const start = call.callTime.split(':').map(Number);
                    const end = day.estimatedWrap.split(':').map(Number);
                    const hours = (end[0] + end[1]/60) - (start[0] + start[1]/60);
                    if(hours > 0) daysByPerson[key].hours += hours;
                }
            });
        });
        
        let generated = 0;
        let skipped = 0;
        let pending = 0;
        
        // Traiter les com√©diens
        state.data.actors?.forEach(actor => {
            const key = `actor_${actor.id}`;
            const data = daysByPerson[key];
            if(!data || data.days === 0) return;
            
            // V√©rifier si une d√©pense existe d√©j√† pour cette personne
            const existingExpense = state.data.expenses?.find(e => 
                e.salaryPersonId === actor.id && e.salaryPersonType === 'actor'
            );
            if(existingExpense) {
                skipped++;
                return;
            }
            
            const hasRate = actor.dailyRate && parseFloat(actor.dailyRate) > 0;
            const rateType = actor.rateType || 'Jour';
            
            let amount = 0;
            let description = '';
            
            if(hasRate) {
                if(rateType === 'Heure' && data.hours > 0) {
                    amount = parseFloat(actor.dailyRate) * data.hours;
                    description = `${data.hours.toFixed(1)}h √ó ${actor.dailyRate} ${currency}/h`;
                } else {
                    amount = parseFloat(actor.dailyRate) * data.days;
                    description = `${data.days} jour(s) √ó ${actor.dailyRate} ${currency}/jour`;
                }
            } else {
                description = `${data.days} jour(s) - Tarif √† d√©finir`;
                pending++;
            }
            
            const expense = {
                id: Utils.generateUniqueId(),
                title: `Salaire - ${actor.name}`,
                // Montants avec TVA (salaires g√©n√©ralement sans TVA)
                amountHT: amount,
                vatRate: 0,
                amountTTC: amount,
                amount: amount, // R√©trocompatibilit√©
                // Cat√©gorie CNC : Interpr√©tation pour les acteurs
                category: 'interpretation',
                subcategory: 'interpretation_principaux',
                department: 'interpretation', // R√©trocompatibilit√©
                description: description,
                status: 'pending',
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                createdBy: state.currentUser?.email,
                createdByName: state.userProfile?.displayName || state.currentUser?.email?.split('@')[0],
                salaryPersonId: actor.id,
                salaryPersonType: 'actor',
                salaryMissingRate: !hasRate
            };
            
            if(!state.data.expenses) state.data.expenses = [];
            state.data.expenses.push(expense);
            generated++;
        });
        
        // Traiter les techniciens
        state.data.crew?.forEach(member => {
            const key = `crew_${member.id}`;
            const data = daysByPerson[key];
            if(!data || data.days === 0) return;
            
            // V√©rifier si une d√©pense existe d√©j√†
            const existingExpense = state.data.expenses?.find(e => 
                e.salaryPersonId === member.id && e.salaryPersonType === 'crew'
            );
            if(existingExpense) {
                skipped++;
                return;
            }
            
            const hasRate = member.dailyRate && parseFloat(member.dailyRate) > 0;
            const rateType = member.rateType || 'Jour';
            
            let amount = 0;
            let description = '';
            
            if(hasRate) {
                if(rateType === 'Heure' && data.hours > 0) {
                    amount = parseFloat(member.dailyRate) * data.hours;
                    description = `${data.hours.toFixed(1)}h √ó ${member.dailyRate} ${currency}/h`;
                } else {
                    amount = parseFloat(member.dailyRate) * data.days;
                    description = `${data.days} jour(s) √ó ${member.dailyRate} ${currency}/jour`;
                }
            } else {
                description = `${data.days} jour(s) - Tarif √† d√©finir`;
                pending++;
            }
            
            const expense = {
                id: Utils.generateUniqueId(),
                title: `Salaire - ${member.name}`,
                // Montants avec TVA (salaires g√©n√©ralement sans TVA)
                amountHT: amount,
                vatRate: 0,
                amountTTC: amount,
                amount: amount, // R√©trocompatibilit√©
                // Cat√©gorie CNC : Personnel pour les techniciens
                category: 'personnel',
                subcategory: 'personnel_technique',
                department: 'personnel', // R√©trocompatibilit√©
                description: description,
                status: 'pending',
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                createdBy: state.currentUser?.email,
                createdByName: state.userProfile?.displayName || state.currentUser?.email?.split('@')[0],
                salaryPersonId: member.id,
                salaryPersonType: 'crew',
                salaryMissingRate: !hasRate
            };
            
            if(!state.data.expenses) state.data.expenses = [];
            state.data.expenses.push(expense);
            generated++;
        });
        
        Store.save();
        Expenses.render();
        
        let message = `${generated} d√©pense(s) salaire g√©n√©r√©e(s)`;
        if(skipped > 0) message += `, ${skipped} d√©j√† existante(s)`;
        if(pending > 0) message += `. ‚ö†Ô∏è ${pending} sans tarif (√† compl√©ter)`;
        
        Utils.toast(message, generated > 0 ? 'success' : 'info');
    },
    
    // Stockage temporaire des pi√®ces jointes en cours d'√©dition
    tempAttachments: [],
    
    // Ouvre le modal d'ajout
    openAddModal: () => {
        document.getElementById('expense-modal-title').textContent = '‚ûï Nouvelle D√©pense';
        document.getElementById('expense-edit-id').value = '';
        document.getElementById('expense-title').value = '';
        document.getElementById('expense-amount-ht').value = '';
        document.getElementById('expense-amount-ttc').value = '';
        document.getElementById('expense-vat-rate').value = state.data.budget?.defaultVatRate || 20;
        document.getElementById('expense-category').value = '';
        document.getElementById('expense-subcategory').innerHTML = '<option value="">-- Sous-cat√©gorie --</option>';
        document.getElementById('expense-description').value = '';
        document.getElementById('expense-status').value = 'pending';
        document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('expense-attachment-url').value = '';
        Expenses.tempAttachments = [];
        Expenses.renderAttachmentsList();
        Expenses.populatePaidBySelect();
        Expenses.populateCategories();
        document.getElementById('expense-paid-by').value = '';
        document.getElementById('expense-modal').style.display = 'flex';
    },
    
    // Change de cat√©gorie ‚Üí met √† jour les sous-cat√©gories
    onCategoryChange: () => {
        const catId = document.getElementById('expense-category').value;
        const subcatSelect = document.getElementById('expense-subcategory');
        subcatSelect.innerHTML = '<option value="">-- Sous-cat√©gorie --</option>';
        
        if(catId) {
            const cat = Expenses.getCategory(catId);
            if(cat && cat.subcats) {
                cat.subcats.forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = sub.id;
                    opt.textContent = sub.name;
                    subcatSelect.appendChild(opt);
                });
            }
        }
    },
    
    // Calcul TTC depuis HT
    calculateTTCFromHT: () => {
        const ht = parseFloat(document.getElementById('expense-amount-ht').value) || 0;
        const vatRate = parseFloat(document.getElementById('expense-vat-rate').value) || 0;
        const ttc = Expenses.calculateTTC(ht, vatRate);
        document.getElementById('expense-amount-ttc').value = ttc || '';
    },
    
    // Calcul HT depuis TTC
    calculateHTFromTTC: () => {
        const ttc = parseFloat(document.getElementById('expense-amount-ttc').value) || 0;
        const vatRate = parseFloat(document.getElementById('expense-vat-rate').value) || 0;
        const ht = Expenses.calculateHT(ttc, vatRate);
        document.getElementById('expense-amount-ht').value = ht || '';
    },
    
    // G√©rer l'upload de fichier
    handleFileUpload: (input) => {
        const file = input.files[0];
        if(!file) return;
        
        if(file.size > 5 * 1024 * 1024) {
            Utils.toast('Fichier trop volumineux (max 5 Mo)', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const attachment = {
                id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                name: file.name,
                data: e.target.result,
                type: file.type.startsWith('image/') ? 'photo' : 'document',
                size: file.size
            };
            Expenses.tempAttachments.push(attachment);
            Expenses.renderAttachmentsList();
            Utils.toast('Fichier ajout√©', 'success');
        };
        reader.readAsDataURL(file);
        input.value = '';
    },
    
    // Ajouter une pi√®ce jointe par URL
    addAttachmentUrl: () => {
        const url = document.getElementById('expense-attachment-url').value.trim();
        if(!url) return;
        
        const attachment = {
            id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            name: url.split('/').pop() || 'document',
            url: url,
            type: url.match(/\.(jpg|jpeg|png|gif|webp)$/i) ? 'photo' : 'document'
        };
        Expenses.tempAttachments.push(attachment);
        Expenses.renderAttachmentsList();
        document.getElementById('expense-attachment-url').value = '';
    },
    
    // Supprimer une pi√®ce jointe
    removeAttachment: (attId) => {
        Expenses.tempAttachments = Expenses.tempAttachments.filter(a => a.id !== attId);
        Expenses.renderAttachmentsList();
    },
    
    // Afficher la liste des pi√®ces jointes
    renderAttachmentsList: () => {
        const container = document.getElementById('expense-attachments-list');
        if(!container) return;
        
        if(Expenses.tempAttachments.length === 0) {
            container.innerHTML = '';
            return;
        }
        
        let html = '';
        Expenses.tempAttachments.forEach(att => {
            const isImage = att.type === 'photo' || (att.data && att.data.startsWith('data:image'));
            const src = att.data || att.url;
            
            html += `<div style="position: relative; display: inline-block;">
                ${isImage ? `<img src="${src}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border);">` : 
                `<div style="width: 80px; height: 80px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; color: var(--text-sec); padding: 5px; text-align: center;">
                    üìÑ<br>${att.name.substring(0, 12)}${att.name.length > 12 ? '...' : ''}
                </div>`}
                <button onclick="app.Expenses.removeAttachment('${att.id}')" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: var(--danger); color: white; border: none; cursor: pointer; font-size: 0.7rem; line-height: 1;">‚úï</button>
            </div>`;
        });
        
        container.innerHTML = html;
    },
    
    // √âdite une d√©pense
    editExpense: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        document.getElementById('expense-modal-title').textContent = '‚úèÔ∏è Modifier la D√©pense';
        document.getElementById('expense-edit-id').value = id;
        document.getElementById('expense-title').value = expense.title || '';
        
        // Montants
        document.getElementById('expense-amount-ht').value = expense.amountHT || expense.amount || '';
        document.getElementById('expense-vat-rate').value = expense.vatRate || 0;
        document.getElementById('expense-amount-ttc').value = expense.amountTTC || expense.amount || '';
        
        // Cat√©gorie
        Expenses.populateCategories();
        document.getElementById('expense-category').value = expense.category || expense.department || '';
        Expenses.onCategoryChange();
        if(expense.subcategory) {
            document.getElementById('expense-subcategory').value = expense.subcategory;
        }
        
        document.getElementById('expense-description').value = expense.description || '';
        document.getElementById('expense-status').value = expense.status || 'pending';
        document.getElementById('expense-date').value = expense.date || '';
        
        // Pi√®ces jointes
        Expenses.tempAttachments = expense.attachments ? [...expense.attachments] : [];
        if(expense.photo && Expenses.tempAttachments.length === 0) {
            Expenses.tempAttachments = [{
                id: 'att_migrated',
                name: 'justificatif.jpg',
                url: expense.photo,
                type: 'photo'
            }];
        }
        Expenses.renderAttachmentsList();
        
        Expenses.populatePaidBySelect();
        document.getElementById('expense-paid-by').value = expense.paidBy || '';
        
        document.getElementById('expense-modal').style.display = 'flex';
    },
    
    // Sauvegarde une d√©pense
    saveExpense: () => {
        const title = document.getElementById('expense-title').value.trim();
        const amountHT = parseFloat(document.getElementById('expense-amount-ht').value) || 0;
        const category = document.getElementById('expense-category').value;
        
        if(!title || !amountHT || !category) {
            Utils.toast('Veuillez remplir les champs obligatoires (Titre, Montant HT, Cat√©gorie)', 'warning');
            return;
        }
        
        const editId = document.getElementById('expense-edit-id').value;
        
        if(!state.data.expenses) state.data.expenses = [];
        
        const paidByValue = document.getElementById('expense-paid-by').value;
        const paidBySelect = document.getElementById('expense-paid-by');
        const paidByName = paidByValue ? paidBySelect.options[paidBySelect.selectedIndex].text : '';
        
        const vatRate = parseFloat(document.getElementById('expense-vat-rate').value) || 0;
        const amountTTC = parseFloat(document.getElementById('expense-amount-ttc').value) || Expenses.calculateTTC(amountHT, vatRate);
        
        const expenseData = {
            title: title,
            // Nouveaux champs TVA
            amountHT: amountHT,
            vatRate: vatRate,
            amountTTC: amountTTC,
            // R√©trocompatibilit√©
            amount: amountHT,
            // Cat√©gories CNC
            category: category,
            subcategory: document.getElementById('expense-subcategory').value || '',
            department: category, // Alias pour r√©trocompatibilit√©
            // Autres champs
            description: document.getElementById('expense-description').value.trim(),
            status: document.getElementById('expense-status').value,
            date: document.getElementById('expense-date').value,
            // Pi√®ces jointes
            attachments: [...Expenses.tempAttachments],
            photo: Expenses.tempAttachments.length > 0 ? (Expenses.tempAttachments[0].url || Expenses.tempAttachments[0].data || '') : '',
            paidBy: paidByValue,
            paidByName: paidByName,
            updatedAt: new Date().toISOString()
        };
        
        if(editId) {
            // Modification
            const idx = state.data.expenses.findIndex(e => e.id === editId);
            if(idx > -1) {
                state.data.expenses[idx] = { ...state.data.expenses[idx], ...expenseData };
            }
        } else {
            // Cr√©ation
            expenseData.id = 'exp_' + Date.now();
            expenseData.createdAt = new Date().toISOString();
            expenseData.createdBy = state.currentUser?.email;
            expenseData.createdByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
            state.data.expenses.push(expenseData);
            
            // Notifier le responsable concern√©
            Expenses.notifyExpenseUpdate(expenseData, 'new');
        }
        
        Store.save();
        document.getElementById('expense-modal').style.display = 'none';
        Expenses.render();
        Notifications.updateBadge();
        
        // V√©rifier les alertes de d√©passement
        Expenses.checkBudgetAlerts(category);
    },
    
    // V√©rifier les alertes de d√©passement apr√®s ajout/modif
    checkBudgetAlerts: (catId) => {
        const cat = Expenses.getCategory(catId);
        if(!cat) return;
        
        const budget = state.data.budget?.previsionnel?.[catId];
        if(!budget || !budget.budgetHT) return;
        
        const vatMode = state.data.budget?.vatMode || 'HT';
        const budgetAmount = vatMode === 'HT' ? budget.budgetHT : budget.budgetTTC;
        
        const expenses = state.data.expenses || [];
        const spent = expenses
            .filter(e => (e.category === catId || e.department === catId) && (e.status === 'approved' || e.status === 'done'))
            .reduce((sum, e) => sum + (vatMode === 'HT' ? (e.amountHT || e.amount || 0) : (e.amountTTC || e.amount || 0)), 0);
        
        const percent = Math.round((spent / budgetAmount) * 100);
        const thresholds = state.data.budget?.alertThresholds || { warning: 80, danger: 100 };
        
        if(percent >= thresholds.danger) {
            Utils.toast(`üî¥ Attention ! Le budget "${cat.name}" est d√©pass√© (${percent}%)`, 'error');
        } else if(percent >= thresholds.warning) {
            Utils.toast(`‚ö†Ô∏è Le budget "${cat.name}" atteint ${percent}%`, 'warning');
        }
    },
    
    // Supprime une d√©pense
    deleteExpense: async (id) => {
        if(!await ConfirmModal.confirmDelete("Cette d√©pense sera supprim√©e.")) return;
        
        state.data.expenses = state.data.expenses.filter(e => e.id !== id);
        Store.save();
        Expenses.render();
    },
    
    // Valide directement une d√©pense
    validateExpense: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        expense.status = 'approved';
        expense.validatedAt = new Date().toISOString();
        expense.validatedBy = state.currentUser?.email;
        expense.validatedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        
        Store.save();
        Expenses.render();
        Utils.toast('D√©pense valid√©e !', 'success');
        
        // Notifier le cr√©ateur
        Expenses.notifyExpenseUpdate(expense, 'approved');
    },
    
    // Remonte une d√©pense au responsable budget global
    escalateExpense: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        expense.status = 'escalated';
        expense.escalatedAt = new Date().toISOString();
        expense.escalatedBy = state.currentUser?.email;
        expense.escalatedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        
        Store.save();
        Expenses.render();
        Utils.toast('D√©pense remont√©e au responsable budget global', 'info');
        
        // Notifier le responsable budget global
        Expenses.notifyExpenseUpdate(expense, 'escalated');
    },
    
    // Ouvre le modal de renvoi
    openReturnModal: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        const currency = state.data.budget?.currency || '‚Ç¨';
        
        const modal = document.createElement('div');
        modal.id = 'return-expense-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:99999;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:450px; max-width:90%;">
                <h3 style="margin:0 0 20px; color:var(--text-main);">‚Ü©Ô∏è Renvoyer la d√©pense</h3>
                
                <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-weight: bold; margin-bottom: 5px;">${Utils.escape(expense.title)}</div>
                    <div style="font-size: 1.2rem; color: var(--primary); font-weight: bold;">${parseFloat(expense.amount).toLocaleString()} ${currency}</div>
                    <div style="font-size: 0.85rem; color: var(--text-sec); margin-top: 5px;">Par : ${Utils.escape(expense.createdByName || expense.createdBy)}</div>
                </div>
                
                <label style="font-size:0.85rem; color:var(--text-sec); display:block; margin-bottom:5px;">Raison du renvoi *</label>
                <textarea id="return-reason" placeholder="Expliquez pourquoi cette d√©pense est renvoy√©e (trop ch√®re, mauvais choix, informations manquantes...)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); min-height:100px; resize:vertical; margin-bottom:20px;"></textarea>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="document.getElementById('return-expense-modal').remove()" style="padding:10px 20px; background:var(--bg); color:var(--text-main); border:1px solid var(--border); border-radius:6px; cursor:pointer;">Annuler</button>
                    <button onclick="app.Expenses.returnExpense('${id}')" style="padding:10px 20px; background:#f59e0b; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">‚Ü©Ô∏è Renvoyer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('return-reason').focus();
    },
    
    // Renvoie une d√©pense au cr√©ateur
    returnExpense: (id) => {
        const reason = document.getElementById('return-reason').value.trim();
        if(!reason) {
            Utils.toast('Veuillez indiquer la raison du renvoi', 'warning');
            return;
        }
        
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        expense.status = 'returned';
        expense.returnedAt = new Date().toISOString();
        expense.returnedBy = state.currentUser?.email;
        expense.returnedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        expense.returnedReason = reason;
        
        Store.save();
        document.getElementById('return-expense-modal').remove();
        Expenses.render();
        Utils.toast('D√©pense renvoy√©e au demandeur', 'info');
        
        // Notifier le cr√©ateur
        Expenses.notifyExpenseUpdate(expense, 'returned');
    },
    
    // Notifie les personnes concern√©es lors d'une mise √† jour de d√©pense
    notifyExpenseUpdate: async (expense, action) => {
        const projectName = state.data.title || 'Projet';
        const currency = state.data.budget?.currency || '‚Ç¨';
        
        let recipientEmail = null;
        let recipientName = null;
        let subject = '';
        let content = '';
        
        if(action === 'approved') {
            // Notifier le cr√©ateur que sa d√©pense est valid√©e
            recipientEmail = expense.createdBy;
            recipientName = expense.createdByName;
            subject = `‚úÖ D√©pense valid√©e - ${projectName}`;
            content = `Votre d√©pense "${expense.title}" de ${expense.amount} ${currency} a √©t√© valid√©e par ${expense.validatedByName || 'le responsable budget'}.`;
        } else if(action === 'returned') {
            // Notifier le cr√©ateur que sa d√©pense est renvoy√©e
            recipientEmail = expense.createdBy;
            recipientName = expense.createdByName;
            subject = `‚Ü©Ô∏è D√©pense renvoy√©e - ${projectName}`;
            content = `Votre d√©pense "${expense.title}" de ${expense.amount} ${currency} a √©t√© renvoy√©e par ${expense.returnedByName || 'le responsable'}.\n\nRaison : ${expense.returnedReason}`;
        } else if(action === 'escalated') {
            // Notifier le responsable budget global
            recipientEmail = state.data.budget?.manager;
            const managerPerson = Expenses.findPersonByEmail(recipientEmail);
            recipientName = managerPerson?.name;
            subject = `‚¨ÜÔ∏è D√©pense remont√©e - ${projectName}`;
            content = `Une d√©pense a √©t√© remont√©e pour validation :\n\n"${expense.title}" - ${expense.amount} ${currency}\nDemand√©e par : ${expense.createdByName}\nRemont√©e par : ${expense.escalatedByName}`;
        } else if(action === 'new') {
            // Notifier le responsable concern√© (d√©partement ou global)
            const deptManager = state.data.budget?.deptManagers?.[expense.department];
            if(deptManager && expense.department !== 'divers') {
                recipientEmail = deptManager.email;
                if(!deptManager.emailNotif) recipientEmail = null; // Pas de mail si d√©sactiv√©
            } else {
                recipientEmail = state.data.budget?.manager;
                if(state.data.budget?.managerEmailNotif === false) recipientEmail = null;
            }
            const recipientPerson = Expenses.findPersonByEmail(recipientEmail);
            recipientName = recipientPerson?.name;
            subject = `üí∞ Nouvelle d√©pense √† valider - ${projectName}`;
            content = `Une nouvelle d√©pense attend votre validation :\n\n"${expense.title}" - ${expense.amount} ${currency}\nDemand√©e par : ${expense.createdByName}`;
        }
        
        // Envoyer la notification interne (messagerie du site)
        if(recipientEmail) {
            Expenses.sendInternalNotification(recipientEmail, subject, content, expense.id);
        }
        
        // Envoyer l'email si activ√©
        // Note: L'envoi d'email d√©pend de la configuration Firebase
    },
    
    // Envoie une notification interne via le syst√®me de messagerie
    sendInternalNotification: (recipientEmail, subject, content, expenseId) => {
        // Utiliser le syst√®me de notifications existant ou cr√©er un nouveau
        if(!state.data.notifications) state.data.notifications = [];
        
        state.data.notifications.push({
            id: 'notif_' + Date.now(),
            type: 'expense',
            recipientEmail: recipientEmail,
            subject: subject,
            content: content,
            expenseId: expenseId,
            read: false,
            createdAt: new Date().toISOString(),
            createdBy: state.currentUser?.email
        });
        
        Store.save();
    },
    
    // Ouvre le modal de validation
    openValidateModal: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        Expenses.currentExpenseId = id;
        const currency = state.data.budget?.currency || '‚Ç¨';
        
        document.getElementById('expense-validate-content').innerHTML = `
            <div style="background: var(--bg); padding: 15px; border-radius: 8px;">
                <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 10px;">${Utils.escape(expense.title)}</div>
                <div style="font-size: 1.3rem; color: var(--primary); font-weight: bold;">${parseFloat(expense.amount).toLocaleString()} ${currency}</div>
                ${expense.description ? `<div style="margin-top: 10px; color: var(--text-sec);">${Utils.escape(expense.description)}</div>` : ''}
                <div style="margin-top: 10px; font-size: 0.85rem;">Demand√© par : ${Utils.escape(expense.createdByName || expense.createdBy)}</div>
            </div>
        `;
        document.getElementById('expense-validate-comment').value = '';
        document.getElementById('expense-validate-modal').style.display = 'flex';
    },
    
    // Approuve une d√©pense
    approveExpense: () => {
        const expense = state.data.expenses?.find(e => e.id === Expenses.currentExpenseId);
        if(!expense) return;
        
        expense.status = 'approved';
        expense.validatedAt = new Date().toISOString();
        expense.validatedBy = state.currentUser?.email;
        expense.validatedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        expense.validationComment = document.getElementById('expense-validate-comment').value.trim();
        
        Store.save();
        document.getElementById('expense-validate-modal').style.display = 'none';
        Expenses.render();
    },
    
    // Refuse une d√©pense
    rejectExpense: () => {
        const expense = state.data.expenses?.find(e => e.id === Expenses.currentExpenseId);
        if(!expense) return;
        
        expense.status = 'rejected';
        expense.validatedAt = new Date().toISOString();
        expense.validatedBy = state.currentUser?.email;
        expense.validatedByName = state.userProfile?.displayName || state.currentUser?.email?.split('@')[0];
        expense.validationComment = document.getElementById('expense-validate-comment').value.trim();
        
        Store.save();
        document.getElementById('expense-validate-modal').style.display = 'none';
        Expenses.render();
    },
    
    // Export PDF du budget
    exportPDF: () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const currency = state.data.budget?.currency || '‚Ç¨';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const projectTitle = state.data.title || 'Projet sans titre';
        const previsionnel = state.data.budget?.previsionnel || {};
        
        // Calculer le budget total depuis le pr√©visionnel
        let budgetTotal = 0;
        Object.values(previsionnel).forEach(p => {
            budgetTotal += vatMode === 'HT' ? (p.budgetHT || 0) : (p.budgetTTC || 0);
        });
        if(budgetTotal === 0) budgetTotal = state.data.budget?.total || 0;
        
        // Calcul des totaux par cat√©gorie CNC
        let totalApproved = 0, totalPending = 0, totalRejected = 0;
        const catTotals = {};
        
        // Initialiser toutes les cat√©gories CNC
        Expenses.CNC_CATEGORIES.forEach(cat => {
            const prev = previsionnel[cat.id] || {};
            catTotals[cat.id] = { 
                approved: 0, 
                pending: 0, 
                budget: vatMode === 'HT' ? (prev.budgetHT || 0) : (prev.budgetTTC || 0)
            };
        });
        
        (state.data.expenses || []).forEach(exp => {
            const catId = exp.category || exp.department;
            const amount = vatMode === 'HT' ? (parseFloat(exp.amountHT) || parseFloat(exp.amount) || 0) : (parseFloat(exp.amountTTC) || parseFloat(exp.amount) || 0);
            
            if(exp.status === 'approved' || exp.status === 'done') totalApproved += amount;
            else if(exp.status === 'pending' || exp.status === 'escalated') totalPending += amount;
            else if(exp.status === 'rejected') totalRejected += amount;
            
            // Mapper vers cat√©gorie CNC si ancienne cat√©gorie
            const mappedCat = Expenses.MIGRATION_MAP[catId] || catId;
            if(!catTotals[mappedCat]) catTotals[mappedCat] = { approved: 0, pending: 0, budget: 0 };
            
            if(exp.status === 'approved' || exp.status === 'done') catTotals[mappedCat].approved += amount;
            else if(exp.status === 'pending') catTotals[mappedCat].pending += amount;
        });
        
        // Salaires
        const salariesTotal = Expenses.calculateSalariesTotal();
        totalApproved += salariesTotal;
        
        let y = 20;
        
        // En-t√™te
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('BUDGET - ' + projectTitle.toUpperCase(), 105, y, { align: 'center' });
        y += 10;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} ‚Ä¢ Mode ${vatMode}`, 105, y, { align: 'center' });
        y += 15;
        
        // R√©sum√© global
        doc.setFillColor(240, 240, 240);
        doc.rect(14, y, 182, 30, 'F');
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('R√âSUM√â GLOBAL', 20, y + 8);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        doc.text(`Budget pr√©visionnel ${vatMode} : ${budgetTotal.toLocaleString()} ${currency}`, 20, y + 16);
        doc.text(`D√©pens√© (valid√©) : ${totalApproved.toLocaleString()} ${currency}`, 20, y + 22);
        doc.text(`En attente : ${totalPending.toLocaleString()} ${currency}`, 110, y + 16);
        const reste = budgetTotal - totalApproved;
        doc.setTextColor(reste < 0 ? 200 : 0, reste < 0 ? 0 : 100, 0);
        doc.text(`Reste : ${reste.toLocaleString()} ${currency}`, 110, y + 22);
        doc.setTextColor(0, 0, 0);
        y += 38;
        
        // Tableau par cat√©gorie CNC
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('R√âPARTITION PAR CAT√âGORIE CNC', 14, y);
        y += 8;
        
        // En-t√™tes du tableau
        doc.setFillColor(50, 50, 50);
        doc.setTextColor(255, 255, 255);
        doc.rect(14, y, 182, 8, 'F');
        doc.setFontSize(9);
        doc.text('Cat√©gorie', 16, y + 5.5);
        doc.text('Pr√©visionnel', 75, y + 5.5);
        doc.text('D√©pens√©', 110, y + 5.5);
        doc.text('En attente', 140, y + 5.5);
        doc.text('√âcart', 175, y + 5.5);
        y += 8;
        doc.setTextColor(0, 0, 0);
        
        // Lignes du tableau par cat√©gorie CNC
        let rowIndex = 0;
        Expenses.CNC_CATEGORIES.forEach(cat => {
            const data = catTotals[cat.id];
            if(!data || (data.approved === 0 && data.pending === 0 && data.budget === 0)) return;
            
            if(rowIndex % 2 === 0) {
                doc.setFillColor(248, 248, 248);
                doc.rect(14, y, 182, 7, 'F');
            }
            
            const ecart = data.budget - data.approved;
            doc.setFontSize(9);
            doc.text(`${cat.code}. ${cat.name}`, 16, y + 5);
            doc.text(data.budget > 0 ? data.budget.toLocaleString() + ' ' + currency : '-', 75, y + 5);
            doc.text(data.approved.toLocaleString() + ' ' + currency, 110, y + 5);
            doc.text(data.pending > 0 ? data.pending.toLocaleString() + ' ' + currency : '-', 140, y + 5);
            if(data.budget > 0) {
                doc.setTextColor(ecart < 0 ? 200 : 0, ecart < 0 ? 0 : 100, 0);
                doc.text(ecart.toLocaleString() + ' ' + currency, 175, y + 5);
                doc.setTextColor(0, 0, 0);
            } else {
                doc.text('-', 175, y + 5);
            }
            y += 7;
            rowIndex++;
            
            if(y > 270) { doc.addPage(); y = 20; }
        });
        
        y += 10;
        
        // Liste des d√©penses
        if(y > 220) { doc.addPage(); y = 20; }
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('LISTE DES D√âPENSES', 14, y);
        y += 8;
        
        // En-t√™tes du tableau des d√©penses
        doc.setFillColor(50, 50, 50);
        doc.setTextColor(255, 255, 255);
        doc.rect(14, y, 182, 7, 'F');
        doc.setFontSize(8);
        doc.text('Date', 16, y + 5);
        doc.text('Titre', 35, y + 5);
        doc.text('Cat√©gorie', 90, y + 5);
        doc.text('HT', 125, y + 5);
        doc.text('TVA', 145, y + 5);
        doc.text('TTC', 160, y + 5);
        doc.text('Statut', 180, y + 5);
        y += 7;
        doc.setTextColor(0, 0, 0);
        
        const statusLabels = { pending: 'Attente', approved: 'Valid√©', rejected: 'Refus√©', done: 'Pay√©', escalated: 'Remont√©', returned: 'Renvoy√©' };
        const expenses = [...(state.data.expenses || [])].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        expenses.forEach((exp, idx) => {
            if(y > 275) { 
                doc.addPage(); 
                y = 20;
                // R√©p√©ter les en-t√™tes sur la nouvelle page
                doc.setFillColor(50, 50, 50);
                doc.setTextColor(255, 255, 255);
                doc.rect(14, y, 182, 7, 'F');
                doc.setFontSize(8);
                doc.text('Date', 16, y + 5);
                doc.text('Titre', 35, y + 5);
                doc.text('Cat√©gorie', 90, y + 5);
                doc.text('HT', 125, y + 5);
                doc.text('TVA', 145, y + 5);
                doc.text('TTC', 160, y + 5);
                doc.text('Statut', 180, y + 5);
                y += 7;
                doc.setTextColor(0, 0, 0);
            }
            
            if(idx % 2 === 0) {
                doc.setFillColor(248, 248, 248);
                doc.rect(14, y, 182, 6, 'F');
            }
            
            // Obtenir la cat√©gorie CNC
            const cat = Expenses.getCategory(exp.category || exp.department);
            const catLabel = cat ? `${cat.code}. ${cat.name}` : (exp.category || exp.department || '-');
            
            // Montants
            const amountHT = exp.amountHT || exp.amount || 0;
            const vatRate = exp.vatRate || 0;
            const amountTTC = exp.amountTTC || exp.amount || 0;
            
            doc.setFontSize(8);
            doc.text(exp.date ? new Date(exp.date).toLocaleDateString('fr-FR') : '-', 16, y + 4);
            doc.text((exp.title || 'Sans titre').substring(0, 28), 35, y + 4);
            doc.text(catLabel.substring(0, 18), 90, y + 4);
            doc.text(parseFloat(amountHT).toLocaleString(), 125, y + 4);
            doc.text(vatRate > 0 ? vatRate + '%' : '-', 145, y + 4);
            doc.text(parseFloat(amountTTC).toLocaleString(), 160, y + 4);
            doc.text(statusLabels[exp.status] || exp.status, 180, y + 4);
            
            y += 6;
        });
        
        // Total en bas
        y += 5;
        doc.setFillColor(240, 240, 240);
        doc.rect(14, y, 182, 8, 'F');
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text('TOTAL', 16, y + 5.5);
        
        let totalHT = 0, totalTTC = 0;
        expenses.filter(e => e.status === 'approved' || e.status === 'done').forEach(e => {
            totalHT += parseFloat(e.amountHT) || parseFloat(e.amount) || 0;
            totalTTC += parseFloat(e.amountTTC) || parseFloat(e.amount) || 0;
        });
        doc.text(totalHT.toLocaleString() + ' ' + currency, 125, y + 5.5);
        doc.text(totalTTC.toLocaleString() + ' ' + currency, 160, y + 5.5);
        
        // T√©l√©charger
        const filename = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'budget') + '_budget_CNC.pdf';
        doc.save(filename);
        Utils.toast('Export PDF g√©n√©r√© !', 'success');
    },
    
    // Export Excel du budget (format CNC avec TVA)
    exportExcel: () => {
        const currency = state.data.budget?.currency || '‚Ç¨';
        const vatMode = state.data.budget?.vatMode || 'HT';
        const projectTitle = state.data.title || 'Projet sans titre';
        const previsionnel = state.data.budget?.previsionnel || {};
        
        // Calculer le budget total
        let budgetTotal = 0;
        Object.values(previsionnel).forEach(p => {
            budgetTotal += vatMode === 'HT' ? (p.budgetHT || 0) : (p.budgetTTC || 0);
        });
        if(budgetTotal === 0) budgetTotal = state.data.budget?.total || 0;
        
        const statusLabels = { pending: 'En attente', approved: 'Valid√©', rejected: 'Refus√©', done: 'Pay√©', escalated: 'Remont√©', returned: 'Renvoy√©' };
        
        // Construire le CSV avec BOM UTF-8
        let csv = '\uFEFF';
        
        // En-t√™te projet
        csv += `BUDGET - ${projectTitle}\n`;
        csv += `G√©n√©r√© le;${new Date().toLocaleDateString('fr-FR')}\n`;
        csv += `Mode;${vatMode}\n`;
        csv += `Budget total ${vatMode};${budgetTotal} ${currency}\n\n`;
        
        // R√©sum√© par cat√©gorie CNC
        csv += 'R√âPARTITION PAR CAT√âGORIE CNC\n';
        csv += 'Code;Cat√©gorie;Pr√©visionnel HT;Pr√©visionnel TTC;D√©pens√© HT;D√©pens√© TTC;En attente;√âcart\n';
        
        // Calculer les totaux par cat√©gorie
        const catTotals = {};
        Expenses.CNC_CATEGORIES.forEach(cat => {
            const prev = previsionnel[cat.id] || {};
            catTotals[cat.id] = { 
                approvedHT: 0, 
                approvedTTC: 0,
                pendingHT: 0,
                budgetHT: prev.budgetHT || 0,
                budgetTTC: prev.budgetTTC || 0
            };
        });
        
        (state.data.expenses || []).forEach(exp => {
            const catId = exp.category || exp.department;
            const mappedCat = Expenses.MIGRATION_MAP[catId] || catId;
            
            if(!catTotals[mappedCat]) catTotals[mappedCat] = { approvedHT: 0, approvedTTC: 0, pendingHT: 0, budgetHT: 0, budgetTTC: 0 };
            
            const amountHT = parseFloat(exp.amountHT) || parseFloat(exp.amount) || 0;
            const amountTTC = parseFloat(exp.amountTTC) || parseFloat(exp.amount) || 0;
            
            if(exp.status === 'approved' || exp.status === 'done') {
                catTotals[mappedCat].approvedHT += amountHT;
                catTotals[mappedCat].approvedTTC += amountTTC;
            } else if(exp.status === 'pending' || exp.status === 'escalated') {
                catTotals[mappedCat].pendingHT += amountHT;
            }
        });
        
        // √âcrire les lignes par cat√©gorie CNC
        let totalBudgetHT = 0, totalBudgetTTC = 0, totalApprovedHT = 0, totalApprovedTTC = 0, totalPending = 0;
        
        Expenses.CNC_CATEGORIES.forEach(cat => {
            const data = catTotals[cat.id];
            if(!data || (data.approvedHT === 0 && data.pendingHT === 0 && data.budgetHT === 0)) return;
            
            const ecart = data.budgetHT - data.approvedHT;
            csv += `${cat.code};${cat.name};${data.budgetHT};${data.budgetTTC};${data.approvedHT};${data.approvedTTC};${data.pendingHT};${ecart}\n`;
            
            totalBudgetHT += data.budgetHT;
            totalBudgetTTC += data.budgetTTC;
            totalApprovedHT += data.approvedHT;
            totalApprovedTTC += data.approvedTTC;
            totalPending += data.pendingHT;
        });
        
        // Ligne total
        csv += `;TOTAL;${totalBudgetHT};${totalBudgetTTC};${totalApprovedHT};${totalApprovedTTC};${totalPending};${totalBudgetHT - totalApprovedHT}\n`;
        
        csv += '\n';
        
        // Liste des d√©penses d√©taill√©e
        csv += 'LISTE DES D√âPENSES\n';
        csv += 'Date;Titre;Cat√©gorie CNC;Sous-cat√©gorie;Montant HT;TVA %;Montant TTC;Statut;Description;Cr√©√© par;Valid√© par;Pay√© par\n';
        
        const expenses = [...(state.data.expenses || [])].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        expenses.forEach(exp => {
            const date = exp.date ? new Date(exp.date).toLocaleDateString('fr-FR') : '';
            const title = (exp.title || '').replace(/;/g, ',').replace(/\n/g, ' ');
            const desc = (exp.description || '').replace(/;/g, ',').replace(/\n/g, ' ');
            const createdBy = (exp.createdByName || exp.createdBy || '').replace(/;/g, ',');
            const validatedBy = (exp.validatedByName || '').replace(/;/g, ',');
            const paidBy = (exp.paidByName || '').replace(/;/g, ',');
            
            // Cat√©gorie CNC
            const cat = Expenses.getCategory(exp.category || exp.department);
            const catLabel = cat ? `${cat.code}. ${cat.name}` : (exp.category || exp.department || '');
            
            // Sous-cat√©gorie
            let subcatLabel = '';
            if(exp.subcategory && cat) {
                const subcat = cat.subcats?.find(s => s.id === exp.subcategory);
                if(subcat) subcatLabel = subcat.name;
            }
            
            // Montants
            const amountHT = exp.amountHT || exp.amount || 0;
            const vatRate = exp.vatRate || 0;
            const amountTTC = exp.amountTTC || exp.amount || 0;
            
            csv += `${date};${title};${catLabel};${subcatLabel};${amountHT};${vatRate};${amountTTC};${statusLabels[exp.status] || exp.status};${desc};${createdBy};${validatedBy};${paidBy}\n`;
        });
        
        // T√©l√©charger
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (projectTitle.replace(/[^a-z0-9]/gi, '_') || 'budget') + '_budget_CNC.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        Utils.toast('Export Excel (CSV) g√©n√©r√© !', 'success');
    },
    
    // Dupliquer une d√©pense
    duplicateExpense: (id) => {
        const expense = state.data.expenses?.find(e => e.id === id);
        if(!expense) return;
        
        const newExpense = {
            ...expense,
            id: 'exp_' + Date.now(),
            title: expense.title + ' (copie)',
            status: 'pending',
            date: new Date().toISOString().split('T')[0],
            createdAt: new Date().toISOString(),
            createdBy: state.currentUser?.email,
            createdByName: state.userProfile?.displayName || state.currentUser?.email?.split('@')[0],
            validatedAt: null,
            validatedBy: null,
            validatedByName: null,
            validationComment: null,
            returnedReason: null,
            returnedBy: null,
            returnedByName: null,
            escalatedAt: null,
            escalatedBy: null,
            escalatedByName: null
        };
        
        // Retirer les r√©f√©rences aux salaires si c'√©tait une d√©pense auto
        delete newExpense.salaryPersonId;
        delete newExpense.salaryPersonType;
        delete newExpense.salaryMissingRate;
        
        if(!state.data.expenses) state.data.expenses = [];
        state.data.expenses.push(newExpense);
        
        Store.save();
        Expenses.render();
        Utils.toast('D√©pense dupliqu√©e !', 'success');
    }
};

// --- MODULE MATCHING ENGINE ---
const MatchingEngine = {
    // Poids des crit√®res (sur 100 points total)
    weights: {
        gender: 20,
        age: 15,
        location: 15,
        collabType: 12,
        availability: 12,
        corpulence: 6,
        height: 5,
        hairColor: 4,
        hairLength: 3,
        eyeColor: 3,
        ethnicity: 5,
        languages: 8,
        sports: 5,
        bonnet: 4,
        vehicle: 3
    },
    
    // Profil s√©lectionn√© pour le matching
    selectedProfile: null,
    matchedProjects: [],
    
    // Initialiser le s√©lecteur de profils
    initProfileSelector: () => {
        const select = document.getElementById('universe-my-profile');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- S√©lectionner mon profil --</option>';
        
        // R√©cup√©rer mes profils depuis Universe
        const myProfiles = Universe.myProfiles || [];
        
        if(myProfiles.length === 0) {
            select.innerHTML += '<option value="" disabled>Aucun profil cr√©√©</option>';
            return;
        }
        
        myProfiles.forEach((profile, idx) => {
            const typeEmoji = profile.type === 'actor' ? 'üé≠' : (profile.type === 'crew' ? 'üé•' : 'üë§');
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = `${typeEmoji} ${profile.name || profile.actorName || 'Profil ' + (idx + 1)}`;
            select.appendChild(opt);
        });
    },
    
    // Trouver des projets pour mon profil
    findProjectsForMe: () => {
        const select = document.getElementById('universe-my-profile');
        if(!select || select.value === '') {
            Utils.toast('Veuillez s√©lectionner un profil', 'warning');
            return;
        }
        
        const profileIdx = parseInt(select.value);
        const profile = Universe.myProfiles[profileIdx];
        if(!profile) {
            Utils.toast('Profil introuvable', 'error');
            return;
        }
        
        MatchingEngine.selectedProfile = profile;
        
        // R√©cup√©rer tous les projets
        const projects = Universe.allProjects || [];
        if(projects.length === 0) {
            Utils.toast('Aucun projet disponible', 'info');
            return;
        }
        
        // Calculer le score pour chaque projet
        const scoredProjects = projects.map(project => {
            const score = MatchingEngine.calculateScore(profile, project);
            return { ...project, matchScore: score.total, matchDetails: score.details };
        });
        
        // Trier par score d√©croissant
        scoredProjects.sort((a, b) => b.matchScore - a.matchScore);
        
        // Filtrer les projets avec un score minimum de 10%
        MatchingEngine.matchedProjects = scoredProjects.filter(p => p.matchScore >= 10);
        
        // Afficher les r√©sultats
        MatchingEngine.displayResults();
        
        const countDiv = document.getElementById('matching-results-count');
        if(countDiv) {
            countDiv.style.display = 'block';
            countDiv.innerHTML = `<strong>${MatchingEngine.matchedProjects.length}</strong> projet(s) compatible(s)`;
        }
        
        Utils.toast(`${MatchingEngine.matchedProjects.length} projets trouv√©s !`, 'success');
    },
    
    // Calculer le score de compatibilit√©
    calculateScore: (profile, project) => {
        let totalScore = 0;
        let maxPossible = 0;
        const details = {};
        const profileType = profile.type; // 'actor' ou 'crew'
        
        // V√âRIFICATION PR√âALABLE : Le projet recherche-t-il ce type de profil ?
        if(profileType === 'actor') {
            // V√©rifier si le projet recherche des com√©diens
            const hasActorNeeds = project.actorNeeds && project.actorNeeds.length > 0;
            if(!hasActorNeeds) {
                return { total: 0, details: { noMatch: { score: 0, label: 'Ne recherche pas de com√©diens' } }, maxPossible: 100, totalScore: 0 };
            }
            // Chercher le meilleur r√¥le correspondant
            const bestRole = MatchingEngine.findBestActorRole(profile, project.actorNeeds);
            if(bestRole) {
                // R√¥le correspondant trouv√©
                details.roleMatch = { score: 100, label: `R√¥le : ${bestRole.roleName || 'Non sp√©cifi√©'}` };
                totalScore += 25;
                maxPossible += 25;
            } else {
                // Pas de r√¥le exact mais le projet cherche des com√©diens
                details.roleMatch = { score: 20, label: 'Recherche com√©diens (autre profil)' };
                totalScore += 5;
                maxPossible += 25;
            }
        } else if(profileType === 'crew') {
            // V√©rifier si le projet recherche des techniciens
            const hasCrewNeeds = (project.crewNeeds && Object.values(project.crewNeeds).some(n => n.needed)) || 
                                 (project.customCrewNeeds && project.customCrewNeeds.length > 0);
            if(!hasCrewNeeds) {
                return { total: 0, details: { noMatch: { score: 0, label: 'Ne recherche pas de techniciens' } }, maxPossible: 100, totalScore: 0 };
            }
            // V√©rifier si le m√©tier du profil correspond aux besoins
            const profileRole = (profile.role || profile.crewRole || '').toLowerCase();
            const profileDept = profile.department || profile.group_id || '';
            const matchingNeed = MatchingEngine.findMatchingCrewNeed(profileRole, profileDept, project);
            if(matchingNeed) {
                // Poste correspondant trouv√©
                details.roleMatch = { score: 100, label: `Poste : ${matchingNeed}` };
                totalScore += 25;
                maxPossible += 25;
            } else {
                // Pas de poste exact mais le projet cherche des techniciens
                details.roleMatch = { score: 20, label: 'Recherche techniciens (autre poste)' };
                totalScore += 5;
                maxPossible += 25;
            }
        }
        
        // 1. GENRE (pour com√©diens)
        if(profileType === 'actor' && (project.searchGender || project.castingGender || project.actorNeeds)) {
            maxPossible += MatchingEngine.weights.gender;
            const projectGender = (project.searchGender || project.castingGender || '').toLowerCase();
            const profileGender = (profile.gender || '').toLowerCase();
            if(projectGender && profileGender) {
                if(projectGender === profileGender || projectGender === 'tous' || projectGender === '') {
                    totalScore += MatchingEngine.weights.gender;
                    details.gender = { score: 100, label: 'Genre compatible' };
                } else {
                    details.gender = { score: 0, label: 'Genre diff√©rent' };
                }
            }
        }
        
        // 2. √ÇGE
        if(project.searchAgeMin || project.searchAgeMax || project.castingAgeMin || project.castingAgeMax) {
            maxPossible += MatchingEngine.weights.age;
            const profileAge = parseInt(profile.age) || 0;
            const minAge = parseInt(project.searchAgeMin || project.castingAgeMin) || 0;
            const maxAge = parseInt(project.searchAgeMax || project.castingAgeMax) || 999;
            
            if(profileAge > 0) {
                if(profileAge >= minAge && profileAge <= maxAge) {
                    totalScore += MatchingEngine.weights.age;
                    details.age = { score: 100, label: '√Çge parfait' };
                } else {
                    // Score partiel si proche
                    const diff = profileAge < minAge ? minAge - profileAge : profileAge - maxAge;
                    if(diff <= 5) {
                        totalScore += MatchingEngine.weights.age * 0.5;
                        details.age = { score: 50, label: '√Çge proche (¬±5 ans)' };
                    } else if(diff <= 10) {
                        totalScore += MatchingEngine.weights.age * 0.25;
                        details.age = { score: 25, label: '√Çge √©loign√© (¬±10 ans)' };
                    } else {
                        details.age = { score: 0, label: '√Çge incompatible' };
                    }
                }
            }
        }
        
        // 3. LOCALISATION (distance)
        if(project.location || project.city) {
            maxPossible += MatchingEngine.weights.location;
            const projectCity = (project.location || project.city || '').toLowerCase();
            const profileCity = (profile.city || '').toLowerCase();
            
            if(projectCity && profileCity) {
                if(profileCity.includes(projectCity) || projectCity.includes(profileCity)) {
                    totalScore += MatchingEngine.weights.location;
                    details.location = { score: 100, label: 'M√™me ville' };
                } else {
                    // Bonus partiel si m√™me r√©gion/d√©partement
                    const profileDept = MatchingEngine.extractDepartment(profileCity);
                    const projectDept = MatchingEngine.extractDepartment(projectCity);
                    if(profileDept && projectDept && profileDept === projectDept) {
                        totalScore += MatchingEngine.weights.location * 0.7;
                        details.location = { score: 70, label: 'M√™me r√©gion' };
                    } else {
                        totalScore += MatchingEngine.weights.location * 0.3;
                        details.location = { score: 30, label: 'Lieu diff√©rent' };
                    }
                }
            }
        }
        
        // 4. TYPE DE COLLABORATION (pro/b√©n√©vole)
        if(project.collabType || project.budget) {
            maxPossible += MatchingEngine.weights.collabType;
            const projectCollab = (project.collabType || '').toLowerCase();
            const profileCollab = (profile.collabType || '').toLowerCase();
            
            if(projectCollab && profileCollab) {
                if(projectCollab === profileCollab) {
                    totalScore += MatchingEngine.weights.collabType;
                    details.collabType = { score: 100, label: 'Type collab identique' };
                } else if(profileCollab === 'tous' || profileCollab.includes('flexible')) {
                    totalScore += MatchingEngine.weights.collabType * 0.8;
                    details.collabType = { score: 80, label: 'Flexible' };
                } else {
                    totalScore += MatchingEngine.weights.collabType * 0.3;
                    details.collabType = { score: 30, label: 'Type collab diff√©rent' };
                }
            }
        }
        
        // 5. DISPONIBILIT√âS
        if(project.shootingDates || project.startDate) {
            maxPossible += MatchingEngine.weights.availability;
            const profileDates = profile.availabilityDates || [];
            const projectStart = project.startDate || project.shootingDates;
            
            if(profileDates.length > 0 && projectStart) {
                // V√©rifier si au moins une date correspond
                const hasMatch = profileDates.some(d => {
                    const pDate = new Date(d);
                    const projDate = new Date(projectStart);
                    return Math.abs(pDate - projDate) < 30 * 24 * 60 * 60 * 1000; // 30 jours
                });
                if(hasMatch) {
                    totalScore += MatchingEngine.weights.availability;
                    details.availability = { score: 100, label: 'Disponible' };
                } else {
                    details.availability = { score: 0, label: 'Non disponible' };
                }
            } else {
                // Pas d'info = neutre
                totalScore += MatchingEngine.weights.availability * 0.5;
                details.availability = { score: 50, label: 'Disponibilit√© inconnue' };
            }
        }
        
        // 6. CORPULENCE
        if(project.searchCorpulence || project.castingCorpulence) {
            maxPossible += MatchingEngine.weights.corpulence;
            const projectCorp = (project.searchCorpulence || project.castingCorpulence || '').toLowerCase();
            const profileCorp = (profile.corpulence || '').toLowerCase();
            
            if(projectCorp && profileCorp && projectCorp === profileCorp) {
                totalScore += MatchingEngine.weights.corpulence;
                details.corpulence = { score: 100, label: 'Corpulence OK' };
            }
        }
        
        // 7. TAILLE
        if(project.searchHeightMin || project.searchHeightMax) {
            maxPossible += MatchingEngine.weights.height;
            const profileHeight = parseInt(profile.height) || 0;
            const minH = parseInt(project.searchHeightMin) || 0;
            const maxH = parseInt(project.searchHeightMax) || 999;
            
            if(profileHeight > 0 && profileHeight >= minH && profileHeight <= maxH) {
                totalScore += MatchingEngine.weights.height;
                details.height = { score: 100, label: 'Taille OK' };
            }
        }
        
        // 8. COULEUR CHEVEUX
        if(project.searchHairColor || project.castingHairColor) {
            maxPossible += MatchingEngine.weights.hairColor;
            const projectHair = (project.searchHairColor || project.castingHairColor || '').toLowerCase();
            const profileHair = (profile.hairColor || '').toLowerCase();
            
            if(projectHair && profileHair && projectHair === profileHair) {
                totalScore += MatchingEngine.weights.hairColor;
                details.hairColor = { score: 100, label: 'Cheveux OK' };
            }
        }
        
        // 9. LONGUEUR CHEVEUX
        if(project.searchHairLength) {
            maxPossible += MatchingEngine.weights.hairLength;
            const projectLen = (project.searchHairLength || '').toLowerCase();
            const profileLen = (profile.hairLength || '').toLowerCase();
            
            if(projectLen && profileLen && projectLen === profileLen) {
                totalScore += MatchingEngine.weights.hairLength;
                details.hairLength = { score: 100, label: 'Longueur cheveux OK' };
            }
        }
        
        // 10. COULEUR YEUX
        if(project.searchEyeColor || project.castingEyeColor) {
            maxPossible += MatchingEngine.weights.eyeColor;
            const projectEyes = (project.searchEyeColor || project.castingEyeColor || '').toLowerCase();
            const profileEyes = (profile.eyeColor || '').toLowerCase();
            
            if(projectEyes && profileEyes && projectEyes === profileEyes) {
                totalScore += MatchingEngine.weights.eyeColor;
                details.eyeColor = { score: 100, label: 'Yeux OK' };
            }
        }
        
        // 11. ETHNICIT√â
        if(project.searchEthnicity || project.castingEthnicity) {
            maxPossible += MatchingEngine.weights.ethnicity;
            const projectEth = (project.searchEthnicity || project.castingEthnicity || '').toLowerCase();
            const profileEth = (profile.ethnicity || '').toLowerCase();
            
            if(projectEth && profileEth && (projectEth === profileEth || projectEth === 'tous')) {
                totalScore += MatchingEngine.weights.ethnicity;
                details.ethnicity = { score: 100, label: 'Ethnicit√© OK' };
            }
        }
        
        // 12. LANGUES
        if(project.searchLanguages || project.languages) {
            maxPossible += MatchingEngine.weights.languages;
            const projectLangs = (project.searchLanguages || project.languages || '').toLowerCase().split(/[,;]/);
            const profileLangs = (profile.languages || '').toLowerCase().split(/[,;]/);
            
            const commonLangs = projectLangs.filter(l => 
                profileLangs.some(pl => pl.trim().includes(l.trim()) || l.trim().includes(pl.trim()))
            );
            
            if(commonLangs.length > 0) {
                const ratio = commonLangs.length / projectLangs.length;
                totalScore += MatchingEngine.weights.languages * ratio;
                details.languages = { score: Math.round(ratio * 100), label: `${commonLangs.length} langue(s) commune(s)` };
            }
        }
        
        // 13. SPORTS / COMP√âTENCES
        if(project.searchSports || project.skills) {
            maxPossible += MatchingEngine.weights.sports;
            const projectSports = (project.searchSports || project.skills || '').toLowerCase().split(/[,;]/);
            const profileSports = (profile.sports || '').toLowerCase().split(/[,;]/);
            
            const commonSports = projectSports.filter(s => 
                profileSports.some(ps => ps.trim().includes(s.trim()) || s.trim().includes(ps.trim()))
            );
            
            if(commonSports.length > 0) {
                const ratio = Math.min(1, commonSports.length / projectSports.length);
                totalScore += MatchingEngine.weights.sports * ratio;
                details.sports = { score: Math.round(ratio * 100), label: `${commonSports.length} comp√©tence(s)` };
            }
        }
        
        // 14. BONNET (si applicable)
        if(project.searchBonnet && profile.gender?.toLowerCase() === 'femme') {
            maxPossible += MatchingEngine.weights.bonnet;
            const projectBonnet = (project.searchBonnet || '').toUpperCase();
            const profileBonnet = (profile.bonnet || '').toUpperCase();
            
            if(projectBonnet && profileBonnet) {
                const bonnetOrder = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
                const projIdx = bonnetOrder.indexOf(projectBonnet);
                const profIdx = bonnetOrder.indexOf(profileBonnet);
                
                if(projIdx === profIdx) {
                    totalScore += MatchingEngine.weights.bonnet;
                    details.bonnet = { score: 100, label: 'Bonnet exact' };
                } else if(Math.abs(projIdx - profIdx) === 1) {
                    totalScore += MatchingEngine.weights.bonnet * 0.7;
                    details.bonnet = { score: 70, label: 'Bonnet proche' };
                }
            }
        }
        
        // 15. V√âHICULE
        if(project.needsVehicle || project.requiresVehicle) {
            maxPossible += MatchingEngine.weights.vehicle;
            if(profile.hasVehicle) {
                totalScore += MatchingEngine.weights.vehicle;
                details.vehicle = { score: 100, label: 'V√©hicule disponible' };
            } else {
                details.vehicle = { score: 0, label: 'Pas de v√©hicule' };
            }
        }
        
        // Calcul du pourcentage final
        const finalScore = maxPossible > 0 ? Math.round((totalScore / maxPossible) * 100) : 50;
        
        return {
            total: finalScore,
            details: details,
            maxPossible: maxPossible,
            totalScore: totalScore
        };
    },
    
    // Extraire le d√©partement d'une ville
    extractDepartment: (city) => {
        if(!city) return null;
        const match = city.match(/\b(\d{2})\b/);
        return match ? match[1] : null;
    },
    
    // Trouver le meilleur r√¥le correspondant pour un com√©dien
    findBestActorRole: (profile, actorNeeds) => {
        if(!actorNeeds || actorNeeds.length === 0) return null;
        
        const profileGender = (profile.gender || '').toLowerCase();
        const profileAge = parseInt(profile.age) || 0;
        
        let bestMatch = null;
        let bestScore = -1;
        
        actorNeeds.forEach(need => {
            let score = 0;
            
            // Match genre
            const needGender = (need.gender || '').toLowerCase();
            if(!needGender || needGender === 'tous' || needGender === profileGender) {
                score += 50;
            } else {
                return; // Genre incompatible, passer au suivant
            }
            
            // Match √¢ge
            const minAge = parseInt(need.ageMin) || 0;
            const maxAge = parseInt(need.ageMax) || 999;
            if(profileAge >= minAge && profileAge <= maxAge) {
                score += 50;
            } else if(profileAge > 0) {
                const diff = profileAge < minAge ? minAge - profileAge : profileAge - maxAge;
                if(diff <= 10) score += 25;
            }
            
            if(score > bestScore) {
                bestScore = score;
                bestMatch = need;
            }
        });
        
        return bestMatch;
    },
    
    // Trouver si le m√©tier du technicien correspond aux besoins du projet
    findMatchingCrewNeed: (profileRole, profileDept, project) => {
        const profileRoleLower = profileRole.toLowerCase();
        
        // V√©rifier dans crewNeeds (postes standards)
        if(project.crewNeeds) {
            for(const [posId, need] of Object.entries(project.crewNeeds)) {
                if(need.needed) {
                    const pos = Presentation?.crewPositions?.find(p => p.id === posId);
                    if(pos) {
                        const posName = pos.name.toLowerCase();
                        if(posName.includes(profileRoleLower) || profileRoleLower.includes(posName.split(' ')[0])) {
                            return pos.name;
                        }
                    }
                }
            }
        }
        
        // V√©rifier dans customCrewNeeds (postes personnalis√©s)
        if(project.customCrewNeeds) {
            for(const custom of project.customCrewNeeds) {
                const customName = (custom.name || '').toLowerCase();
                if(customName.includes(profileRoleLower) || profileRoleLower.includes(customName.split(' ')[0])) {
                    return custom.name;
                }
            }
        }
        
        // V√©rifier par d√©partement si pas de match exact
        if(profileDept && project.crewNeeds) {
            const deptMapping = {
                'gc1': ['image', 'cadreur', 'chef op', 'directeur photo'],
                'gc3': ['r√©alisation', 'r√©alisateur', 'assistant r√©al'],
                'gc4': ['son', 'ing√©nieur son', 'perchman', 'mixeur'],
                'gc5': ['lumi√®re', '√©lectro', 'chef √©lectro', 'gaffer'],
                'gc6': ['d√©cor', 'chef d√©cor', 'accessoiriste'],
                'gc7': ['costume', 'costumier', 'habilleur'],
                'gc8': ['maquillage', 'maquilleur', 'coiffeur'],
                'gc9': ['production', 'directeur prod', 'r√©gisseur'],
                'gc10': ['post-prod', 'monteur', '√©talonnage', 'vfx'],
                'gc11': ['scripte', 'script']
            };
            
            const deptKeywords = deptMapping[profileDept] || [];
            for(const [posId, need] of Object.entries(project.crewNeeds)) {
                if(need.needed) {
                    const pos = Presentation?.crewPositions?.find(p => p.id === posId);
                    if(pos && deptKeywords.some(kw => pos.name.toLowerCase().includes(kw))) {
                        return pos.name + ' (d√©partement)';
                    }
                }
            }
        }
        
        return null;
    },
    
    // Afficher les r√©sultats sur la carte
    displayResults: () => {
        if(!Universe.map) return;
        
        // Supprimer l'ancien layer de matching s'il existe
        if(MatchingEngine.matchingLayer) {
            Universe.map.removeLayer(MatchingEngine.matchingLayer);
        }
        
        // Cr√©er un nouveau layer SANS clustering pour les r√©sultats de matching
        MatchingEngine.matchingLayer = L.layerGroup();
        
        // Compteur pour d√©caler les marqueurs √† la m√™me position
        const positionOffsets = {};
        
        // Ajouter les projets match√©s comme marqueurs
        MatchingEngine.matchedProjects.forEach(async (project, index) => {
            const city = project.location || project.city || '';
            if(!city) return;
            
            const coords = await Universe.geocodeCity(city);
            if(!coords) return;
            
            // D√©calage pour √©viter superposition
            const key = `${coords.lat.toFixed(3)},${coords.lng.toFixed(3)}`;
            if(!positionOffsets[key]) positionOffsets[key] = 0;
            const offset = positionOffsets[key] * 0.002;
            positionOffsets[key]++;
            
            const finalLat = coords.lat + offset;
            const finalLng = coords.lng + offset;
            
            // Couleur selon le score
            const scoreColor = project.matchScore >= 70 ? '#22c55e' : 
                              project.matchScore >= 40 ? '#f59e0b' : '#ef4444';
            
            // Cr√©er le marqueur avec l'affiche du projet
            const hasImage = project.image && project.image.length > 5;
            const icon = L.divIcon({
                className: 'match-marker-card',
                html: `
                    <div style="position: relative; cursor: pointer;" onclick="app.MatchingEngine.openMatchedProject('${project.id}')">
                        <div style="width: 70px; height: 95px; border-radius: 6px; overflow: hidden; border: 3px solid ${scoreColor}; box-shadow: 0 4px 12px rgba(0,0,0,0.4); background: #1a1a2e;">
                            ${hasImage 
                                ? `<img src="${project.image}" style="width: 100%; height: 100%; object-fit: cover;">` 
                                : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üé¨</div>`
                            }
                        </div>
                        <div style="position: absolute; top: -8px; right: -8px; background: ${scoreColor}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${project.matchScore}%</div>
                    </div>
                `,
                iconSize: [70, 95],
                iconAnchor: [35, 95]
            });
            
            const marker = L.marker([finalLat, finalLng], { icon });
            MatchingEngine.matchingLayer.addLayer(marker);
        });
        
        Universe.map.addLayer(MatchingEngine.matchingLayer);
        
        // Ajuster la vue pour montrer tous les marqueurs
        if(MatchingEngine.matchedProjects.length > 0) {
            setTimeout(() => {
                try {
                    const bounds = MatchingEngine.matchingLayer.getBounds();
                    if(bounds && bounds.isValid()) {
                        Universe.map.fitBounds(bounds, { padding: [50, 50] });
                    }
                } catch(e) {
                    console.warn('Impossible d\'ajuster la vue:', e);
                }
            }, 500);
        }
    },
    
    // Layer pour les r√©sultats de matching (sans clustering)
    matchingLayer: null,
    
    // Ouvrir un projet match√©
    openMatchedProject: (projectId) => {
        const project = MatchingEngine.matchedProjects.find(p => p.id === projectId);
        if(project) {
            Universe.openProjectModal(project);
        } else {
            Utils.toast('Projet introuvable', 'error');
        }
    }
};

// --- MODULE UNIVERSE V86 ---
const Universe = {
    filteredProfiles: [],
    allProjects: [],
    filteredProjects: [],
    currentProfile: null,
    cards: [],
    animationRunning: false,
    sceneRect: null,
    myProfiles: [], // Profils de l'utilisateur
    myProjects: [], // Projets de l'utilisateur
    
    // Carte Leaflet
    map: null,
    markersLayer: null,
    tileLayer: null,
    viewMode: 'map', // 'map' ou 'fan'
    geoCache: {}, // Cache des g√©olocalisations
    hoverCard: null,
    
    
    // Initialiser la carte
    initMap: () => {
        if(Universe.map) return; // D√©j√† initialis√©e
        
        const mapContainer = document.getElementById('universe-map');
        if(!mapContainer) return;
        
        // Cr√©er la carte centr√©e sur la France
        Universe.map = L.map('universe-map', {
            center: [46.603354, 1.888334],
            zoom: 5,
            minZoom: 2,
            maxZoom: 18,
            zoomControl: true
        });
        
        // Tuiles selon le th√®me
        Universe.updateMapTheme();
        
        // Groupe de marqueurs avec clustering
        Universe.markersLayer = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            disableClusteringAtZoom: 14,
            spiderfyDistanceMultiplier: 1.5,
            iconCreateFunction: (cluster) => {
                const count = cluster.getChildCount();
                let size = 'small';
                if(count > 10) size = 'medium';
                if(count > 50) size = 'large';
                return L.divIcon({
                    html: `<div>${count}</div>`,
                    className: `marker-cluster marker-cluster-${size}`,
                    iconSize: [40, 40]
                });
            }
        });
        
        Universe.map.addLayer(Universe.markersLayer);
        
        // √âv√©nement hover sur cluster
        Universe.markersLayer.on('clustermouseover', (e) => {
            const cluster = e.layer;
            const markers = cluster.getAllChildMarkers();
            if(markers.length > 0) {
                const randomMarker = markers[Math.floor(Math.random() * markers.length)];
                Universe.showHoverCard(randomMarker.options.profileData, e.originalEvent);
            }
        });
        
        Universe.markersLayer.on('clustermouseout', () => {
            Universe.hideHoverCard();
        });
        
        // NOTE: On ne recharge plus les marqueurs au d√©placement/zoom
        // car les positions sont maintenant fixes (d√©terministes)
    },
    
    // Ajoute un l√©ger d√©calage al√©atoire pour √©viter la superposition
    addCoordOffset: (lat, lng) => {
        const offset = 0.002; // ~200m de d√©calage max
        const randomLat = lat + (Math.random() - 0.5) * offset;
        const randomLng = lng + (Math.random() - 0.5) * offset;
        return { lat: randomLat, lng: randomLng };
    },
    
    // G√©n√®re un d√©calage d√©terministe bas√© sur l'ID du profil (toujours le m√™me pour un m√™me profil)
    getDeterministicOffset: (profileId, lat, lng) => {
        // Hash simple bas√© sur l'ID pour g√©n√©rer un nombre pseudo-al√©atoire reproductible
        let hash = 0;
        const str = String(profileId);
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        
        // Utiliser le hash pour g√©n√©rer un d√©calage entre -0.003 et +0.003 (~300m)
        const offsetRange = 0.003;
        const latOffset = ((hash % 1000) / 1000 - 0.5) * offsetRange * 2;
        const lngOffset = (((hash >> 10) % 1000) / 1000 - 0.5) * offsetRange * 2;
        
        return {
            lat: lat + latOffset,
            lng: lng + lngOffset
        };
    },
    
    // D√©termine si l'adresse doit √™tre masqu√©e pour ce profil
    shouldHideAddress: (profile) => {
        // Com√©diens et techniciens : toujours masqu√© dans l'Univers
        if (profile.type === 'actor' || profile.type === 'crew') {
            return true;
        }
        // Associations et entreprises : selon leur choix
        if (profile.type === 'association' || profile.type === 'enterprise') {
            return profile.hideAddress === true;
        }
        // Projets : h√©rite du porteur de projet
        if (profile.type === 'project') {
            return true; // On masque par d√©faut pour les projets
        }
        return false;
    },
    
    // G√©ocoder une ville (avec cache et API Nominatim)
    geocodeCity: async (city) => {
        if(!city) return null;
        
        const cityKey = city.toLowerCase().trim();
        
        // V√©rifier le cache
        if(Universe.geoCache[cityKey]) {
            return Universe.geoCache[cityKey];
        }
        
        // V√©rifier le localStorage
        try {
            const cached = localStorage.getItem('fmp_geocache');
            if(cached) {
                const cacheData = JSON.parse(cached);
                if(cacheData[cityKey]) {
                    Universe.geoCache[cityKey] = cacheData[cityKey];
                    return cacheData[cityKey];
                }
            }
        } catch(e) {}
        
        // Appeler l'API Nominatim
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`, {
                headers: { 'User-Agent': 'Moteur/1.9' }
            });
            const data = await response.json();
            
            if(data && data.length > 0) {
                const result = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                Universe.geoCache[cityKey] = result;
                
                // Sauvegarder dans localStorage
                try {
                    const cached = localStorage.getItem('fmp_geocache');
                    const cacheData = cached ? JSON.parse(cached) : {};
                    cacheData[cityKey] = result;
                    localStorage.setItem('fmp_geocache', JSON.stringify(cacheData));
                } catch(e) {}
                
                return result;
            }
        } catch(e) {
            console.warn('Geocoding error:', e);
        }
        
        return null;
    },
    
    // Cr√©er un marqueur pour un profil
    createMapMarker: (profile, coords) => {
        const isProject = profile.type === 'project';
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        
        let markerClass = 'map-profile-marker';
        if(isProject) markerClass += ' project-marker';
        else if(isActor) markerClass += ' actor-marker';
        else if(isCrew) markerClass += ' crew-marker';
        else if(isAssociation) markerClass += ' association-marker';
        else if(isEnterprise) markerClass += ' enterprise-marker';
        
        const photoUrl = profile.photoURL || profile.mainPhoto || '';
        const defaultIcon = isProject ? 'üé¨' : (isActor ? 'üé≠' : 'üé•');
        const name = profile.displayName || profile.title || profile.name || 'Sans nom';
        
        const iconHtml = `
            <div class="${markerClass}">
                ${photoUrl ? `<img src="${photoUrl}" alt="${name}" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:40px;display:flex;align-items:center;justify-content:center;background:var(--panel-bg);border-radius:6px;font-size:20px;\\'>${defaultIcon}</div>'">` : `<div style="width:100%;height:40px;display:flex;align-items:center;justify-content:center;background:var(--panel-bg);border-radius:6px;border:2px solid var(--primary);font-size:20px;">${defaultIcon}</div>`}
                <div class="marker-label">${name}</div>
            </div>
        `;
        
        const icon = L.divIcon({
            html: iconHtml,
            className: 'map-marker-container',
            iconSize: [40, 50],
            iconAnchor: [20, 50]
        });
        
        // Ajouter un l√©ger d√©calage pour √©viter la superposition
        const offsetCoords = Universe.addCoordOffset(coords.lat, coords.lng);
        const marker = L.marker([offsetCoords.lat, offsetCoords.lng], { 
            icon: icon,
            profileData: profile
        });
        
        // √âv√©nements hover
        marker.on('mouseover', (e) => {
            Universe.showHoverCard(profile, e.originalEvent);
        });
        
        marker.on('mouseout', () => {
            Universe.hideHoverCard();
        });
        
        // Clic pour ouvrir le profil
        marker.on('click', () => {
            Universe.hideHoverCard();
            Universe.openProfileModal(profile);
        });
        
        return marker;
    },
    
    // Afficher la modale de profil (pour tous les profils)
    showProfileModal: async (profile) => {
        const isProject = profile.type === 'project';
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        
        // Charger les donn√©es compl√®tes depuis Firebase
        let fullProfile = profile;
        if(!isProject) {
            try {
                let ref = null;
                if(isActor) ref = firebase.database().ref('public_actors/' + profile.id);
                else if(isCrew) ref = firebase.database().ref('public_crew/' + profile.id);
                else if(isAssociation) ref = firebase.database().ref('public_associations/' + profile.id);
                else if(isEnterprise) ref = firebase.database().ref('public_enterprises/' + profile.id);
                
                if(ref) {
                    const snap = await ref.once('value');
                    if(snap.val()) fullProfile = { ...snap.val(), id: profile.id, type: profile.type };
                }
            } catch(e) { console.warn('Erreur chargement profil:', e); }
        }
        
        // Pour les projets, charger depuis public_projects
        if(isProject) {
            try {
                const snap = await firebase.database().ref('public_projects/' + profile.id).once('value');
                if(snap.val()) fullProfile = { ...snap.val(), id: profile.id, type: 'project' };
            } catch(e) { console.warn('Erreur chargement projet:', e); }
        }
        
        const name = fullProfile.displayName || fullProfile.name || fullProfile.title || fullProfile.assoName || fullProfile.entName || 'Sans nom';
        const city = fullProfile.city || fullProfile.location || 'Non renseign√©';
        const photo = fullProfile.photoURL || fullProfile.mainPhoto || fullProfile.poster || '';
        
        let typeLabel = 'üë§ Profil';
        let typeColor = 'var(--primary)';
        if(isProject) { typeLabel = 'üé¨ Projet'; typeColor = '#e94560'; }
        else if(isActor) { typeLabel = 'üé≠ Com√©dien¬∑ne'; typeColor = '#4CAF50'; }
        else if(isCrew) { typeLabel = 'üé• Technicien¬∑ne'; typeColor = '#2196F3'; }
        else if(isAssociation) { typeLabel = 'üèõÔ∏è Association'; typeColor = '#FF9800'; }
        else if(isEnterprise) { typeLabel = 'üè¢ Entreprise'; typeColor = '#9C27B0'; }
        
        // Construire les d√©tails selon le type
        let detailsHTML = '';
        
        if(isActor) {
            detailsHTML = `
                ${fullProfile.gender ? `<p><strong>Genre:</strong> ${fullProfile.gender}</p>` : ''}
                ${fullProfile.age ? `<p><strong>√Çge:</strong> ${fullProfile.age} ans</p>` : ''}
                ${fullProfile.height ? `<p><strong>Taille:</strong> ${fullProfile.height} cm</p>` : ''}
                ${fullProfile.eyeColor ? `<p><strong>Yeux:</strong> ${fullProfile.eyeColor}</p>` : ''}
                ${fullProfile.hairColor ? `<p><strong>Cheveux:</strong> ${fullProfile.hairColor}${fullProfile.hairLength ? ' (' + fullProfile.hairLength + ')' : ''}</p>` : ''}
                ${fullProfile.ethnicity ? `<p><strong>Origine:</strong> ${fullProfile.ethnicity}</p>` : ''}
                ${fullProfile.sports ? `<p><strong>Sports:</strong> ${fullProfile.sports}</p>` : ''}
                ${fullProfile.languages ? `<p><strong>Langues:</strong> ${fullProfile.languages}</p>` : ''}
            `;
        } else if(isCrew) {
            detailsHTML = `
                ${fullProfile.department ? `<p><strong>D√©partement:</strong> ${fullProfile.department}</p>` : ''}
                ${fullProfile.role ? `<p><strong>Fonction:</strong> ${fullProfile.role}</p>` : ''}
                ${fullProfile.experience ? `<p><strong>Exp√©rience:</strong> ${fullProfile.experience}</p>` : ''}
            `;
        } else if(isProject) {
            detailsHTML = `
                ${fullProfile.projectType ? `<p><strong>Type:</strong> ${fullProfile.projectType}</p>` : ''}
                ${fullProfile.genre ? `<p><strong>Genre:</strong> ${fullProfile.genre}</p>` : ''}
                ${fullProfile.director ? `<p><strong>R√©alisateur:</strong> ${fullProfile.director}</p>` : ''}
                ${fullProfile.producer ? `<p><strong>Producteur:</strong> ${fullProfile.producer}</p>` : ''}
                ${fullProfile.synopsis ? `<p><strong>Synopsis:</strong> ${fullProfile.synopsis}</p>` : ''}
            `;
        } else if(isAssociation) {
            detailsHTML = `
                ${fullProfile.assoType ? `<p><strong>Type:</strong> ${fullProfile.assoType}</p>` : ''}
                ${fullProfile.description ? `<p><strong>Description:</strong> ${fullProfile.description}</p>` : ''}
            `;
        } else if(isEnterprise) {
            detailsHTML = `
                ${fullProfile.entType ? `<p><strong>Type:</strong> ${fullProfile.entType}</p>` : ''}
                ${fullProfile.description ? `<p><strong>Description:</strong> ${fullProfile.description}</p>` : ''}
            `;
        }
        
        // Galerie photos
        let galleryHTML = '';
        const photos = fullProfile.gallery || fullProfile.photos || [];
        if(photos.length > 0) {
            galleryHTML = `
                <div style="margin:15px 0;">
                    <strong>BIO</strong>
                    <div style="display:flex; gap:10px; margin-top:10px; overflow-x:auto; padding:5px 0;">
                        ${photos.slice(0, 5).map(p => `<img src="${p}" style="width:80px; height:80px; object-fit:cover; border-radius:8px; cursor:pointer;" onclick="window.open('${p}', '_blank')">`).join('')}
                    </div>
                </div>
            `;
        }
        
        // Contact
        let contactHTML = '';
        if(fullProfile.email || fullProfile.phone) {
            contactHTML = `
                <div style="background:var(--bg); padding:15px; border-radius:8px; margin:15px 0;">
                    <strong>CONTACT</strong>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                        ${fullProfile.email ? `<div><small style="color:var(--text-sec);">Email</small><br>${fullProfile.email}</div>` : ''}
                        ${fullProfile.phone ? `<div><small style="color:var(--text-sec);">T√©l√©phone</small><br>${fullProfile.phone}</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:20000; padding:20px; box-sizing:border-box;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:16px; max-width:500px; width:100%; max-height:90vh; overflow-y:auto; position:relative; animation:fadeInCard 0.3s ease;">
                ${fullProfile.isFavorite ? '<span style="position:absolute; top:15px; left:15px; font-size:1.5rem;">‚≠ê</span>' : ''}
                <button onclick="this.closest('div[style*=fixed]').remove()" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-main);">‚úï</button>
                
                <div style="text-align:center; padding:30px 20px 20px;">
                    <div style="width:120px; height:120px; border-radius:50%; margin:0 auto 15px; overflow:hidden; border:4px solid ${typeColor}; background:var(--bg); display:flex; align-items:center; justify-content:center;">
                        ${photo ? `<img src="${photo}" style="width:100%; height:100%; object-fit:cover;">` : `<span style="font-size:3rem;">${isProject ? 'üé¨' : (isActor ? 'üé≠' : (isCrew ? 'üé•' : (isAssociation ? 'üèõÔ∏è' : 'üè¢')))}</span>`}
                    </div>
                    <h2 style="margin:0 0 5px; color:var(--text-main);">${Utils.escape(name)}</h2>
                    <span style="color:${typeColor}; font-weight:500;">${typeLabel}</span>
                    <p style="margin:5px 0 0; color:var(--text-sec);">üìç ${city}</p>
                </div>
                
                ${galleryHTML}
                
                ${detailsHTML ? `<div style="padding:0 20px;"><div style="background:var(--bg); padding:15px; border-radius:8px;"><strong>INFORMATIONS</strong><div style="margin-top:10px; color:var(--text-sec); line-height:1.8;">${detailsHTML}</div></div></div>` : ''}
                
                ${contactHTML ? `<div style="padding:0 20px;">${contactHTML}</div>` : ''}
                
                <div style="padding:20px; display:flex; gap:10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1; padding:12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text-main);">Fermer</button>
                    ${!isProject ? `<button onclick="app.Messages.openCompose('${fullProfile.email || ''}'); this.closest('div[style*=fixed]').remove();" style="flex:1; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer;">‚úâÔ∏è Contacter</button>` : ''}
                    ${isProject ? `<button onclick="app.Messages.openCompose('${fullProfile.ownerEmail || ''}'); this.closest('div[style*=fixed]').remove();" style="flex:1; padding:12px; background:#e94560; color:white; border:none; border-radius:8px; cursor:pointer;">‚úâÔ∏è Contacter le projet</button>` : ''}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },

    // Afficher un profil de d√©monstration
    showDemoProfile: (profile) => {
        const isProject = profile.type === 'project';
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        
        let typeLabel = 'üë§ Profil';
        if(isProject) typeLabel = 'üé¨ Projet';
        else if(isActor) typeLabel = 'üé≠ Com√©dien¬∑ne';
        else if(isCrew) typeLabel = 'üé• Technicien¬∑ne';
        else if(isAssociation) typeLabel = 'üèõÔ∏è Association';
        else if(isEnterprise) typeLabel = 'üè¢ Entreprise';
        
        const name = profile.displayName || profile.name || profile.title || 'Sans nom';
        const city = profile.city || 'Non renseign√©';
        
        let details = `<p><strong>Ville :</strong> ${city}</p>`;
        
        if(isActor) {
            details += `<p><strong>Genre :</strong> ${profile.gender === 'homme' ? 'Homme' : 'Femme'}</p>`;
            if(profile.age) details += `<p><strong>√Çge :</strong> ${profile.age} ans</p>`;
        } else if(isCrew) {
            if(profile.role) details += `<p><strong>Fonction :</strong> ${profile.role}</p>`;
        } else if(isProject) {
            if(profile.projectType) details += `<p><strong>Type :</strong> ${profile.projectType}</p>`;
            if(profile.genre) details += `<p><strong>Genre :</strong> ${profile.genre}</p>`;
        } else if(isAssociation) {
            if(profile.assoType) details += `<p><strong>Type :</strong> ${profile.assoType}</p>`;
        } else if(isEnterprise) {
            if(profile.entType) details += `<p><strong>Type :</strong> ${profile.entType}</p>`;
        }
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:20000;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:16px; padding:30px; max-width:400px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.3); animation:fadeInCard 0.3s ease;">
                <div style="text-align:center; margin-bottom:20px;">
                    <div style="font-size:3rem; margin-bottom:10px;">${isProject ? 'üé¨' : (isActor ? 'üé≠' : (isCrew ? 'üé•' : (isAssociation ? 'üèõÔ∏è' : 'üè¢')))}</div>
                    <h2 style="margin:0; color:var(--text-main);">${name}</h2>
                    <span style="color:var(--primary); font-size:0.9rem;">${typeLabel}</span>
                </div>
                <div style="color:var(--text-sec); line-height:1.8;">
                    ${details}
                </div>
                <p style="text-align:center; margin-top:20px; padding:10px; background:var(--bg); border-radius:8px; color:var(--text-sec); font-size:0.85rem;">
                    ‚ö†Ô∏è Ceci est un profil de d√©monstration
                </p>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="width:100%; margin-top:15px; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Fermer</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    },

    // Afficher la carte de survol
    showHoverCard: (profile, event) => {
        const hoverDiv = document.getElementById('map-hover-card');
        if(!hoverDiv) return;
        
        const card = Universe.createFanCard(profile, false);
        hoverDiv.innerHTML = '';
        hoverDiv.appendChild(card);
        
        // Positionner pr√®s de la souris
        const x = event.clientX + 15;
        const y = event.clientY - 100;
        
        hoverDiv.style.left = Math.min(x, window.innerWidth - 220) + 'px';
        hoverDiv.style.top = Math.max(y, 10) + 'px';
        hoverDiv.style.display = 'block';
    },
    
    // Masquer la carte de survol
    hideHoverCard: () => {
        const hoverDiv = document.getElementById('map-hover-card');
        if(hoverDiv) hoverDiv.style.display = 'none';
    },
    
    // Compteur de positions par ville pour la spirale
    cityPositionCounters: {},

    // Charger les marqueurs sur la carte
    loadMapMarkers: async () => {
        // Si des filtres sont actifs, utiliser les r√©sultats filtr√©s
        if(Universe.filteredProfiles.length > 0 || Universe.filteredProjects.length > 0) {
            await Universe.loadFilteredMapMarkers();
        } else {
            await Universe.loadMapMarkersInView();
        }
    },
    
    // Charge max 100 profils visibles dans la zone de la carte
    loadMapMarkersInView: async () => {
        if(!Universe.map || !Universe.markersLayer) return;
        
        Universe.markersLayer.clearLayers();
        Universe.cityPositionCounters = {}; // Reset des compteurs
        
        // R√©cup√©rer le type s√©lectionn√© pour filtrer m√™me sans recherche
        const selectedType = document.getElementById('universe-type')?.value;
        
        let profiles = [...Universe.allProfiles];
        let projects = [...Universe.allProjects];
        
        // Filtrer par type si s√©lectionn√©
        if(selectedType) {
            if(selectedType === 'project') {
                profiles = [];
            } else {
                profiles = profiles.filter(p => p.type === selectedType);
                projects = [];
            }
        }
        
        // Combiner les r√©sultats filtr√©s
        const allItems = [...profiles, ...projects];
        
        // M√©langer al√©atoirement
        const shuffled = Universe.shuffleArray(allItems);
        
        // Limiter √† 100 profils max
        const maxProfiles = 100;
        const limitedItems = shuffled.slice(0, maxProfiles);
        
        // Obtenir les bounds actuels de la carte
        const bounds = Universe.map.getBounds();
        
        // Charger les marqueurs par batch
        const batchSize = 10;
        
        for(let i = 0; i < limitedItems.length; i += batchSize) {
            const batch = limitedItems.slice(i, i + batchSize);
            
            await Promise.all(batch.map(async (item) => {
                const city = item.city || item.location || '';
                if(!city) return;
                
                const coords = await Universe.geocodeCity(city);
                if(coords) {
                    // D√©calage d√©terministe bas√© sur l'ID du profil (fixe, pas al√©atoire)
                    const shouldHide = Universe.shouldHideAddress(item);
                    let finalCoords;
                    if(shouldHide) {
                        finalCoords = Universe.getDeterministicOffset(item.id, coords.lat, coords.lng);
                        item._hasApproximateLocation = true;
                    } else {
                        finalCoords = { lat: coords.lat, lng: coords.lng };
                        item._hasApproximateLocation = false;
                    }
                    
                    const marker = Universe.createMapMarker(item, finalCoords);
                    Universe.markersLayer.addLayer(marker);
                }
            }));
            
            // Petit d√©lai entre les batches pour respecter les limites API
            if(i + batchSize < limitedItems.length) {
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }
    },
    
    // Mettre √† jour le th√®me de la carte
    updateMapTheme: () => {
        if(!Universe.map) return;
        
        const isDark = document.body.classList.contains('dark-mode');
        
        // Supprimer l'ancien layer
        if(Universe.tileLayer) {
            Universe.map.removeLayer(Universe.tileLayer);
        }
        
        // Ajouter le nouveau layer selon le th√®me
        if(isDark) {
            Universe.tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            });
        } else {
            Universe.tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            });
        }
        
        Universe.tileLayer.addTo(Universe.map);
        
        // Mettre √† jour le fond du conteneur
        const mapContainer = document.getElementById('universe-map');
        if(mapContainer) {
            mapContainer.style.background = isDark ? '#1a1a2e' : '#f4f6f8';
        }
    },

    // Changer le mode de vue
    setViewMode: (mode) => {
        Universe.viewMode = mode;
        
        const mapBtn = document.getElementById('view-mode-map');
        const fanBtn = document.getElementById('view-mode-fan');
        let mapContainer = document.getElementById('universe-map');
        const scene = document.getElementById('universe-scene');
        
        if(mode === 'map') {
            mapBtn.style.background = 'var(--primary)';
            mapBtn.style.color = 'white';
            mapBtn.style.border = 'none';
            fanBtn.style.background = 'var(--bg)';
            fanBtn.style.color = 'var(--text-main)';
            fanBtn.style.border = '1px solid var(--border)';
            
            // Retirer le contenu fan s'il existe
            const fanContainer = scene.querySelector('.universe-fan-container');
            if(fanContainer) fanContainer.remove();
            
            // Recr√©er le conteneur de carte s'il n'existe plus
            if(!mapContainer) {
                mapContainer = document.createElement('div');
                mapContainer.id = 'universe-map';
                scene.insertBefore(mapContainer, scene.firstChild);
                
                // R√©initialiser la carte
                Universe.map = null;
                Universe.markersLayer = null;
                Universe.initMap();
            }
            
            mapContainer.style.display = 'block';
            
            // Rafra√Æchir la carte et charger les marqueurs (filtr√©s ou non)
            setTimeout(() => {
                if(Universe.map) {
                    Universe.map.invalidateSize();
                    Universe.loadMapMarkers();
                }
            }, 100);
        } else {
            fanBtn.style.background = 'var(--primary)';
            fanBtn.style.color = 'white';
            fanBtn.style.border = 'none';
            mapBtn.style.background = 'var(--bg)';
            mapBtn.style.color = 'var(--text-main)';
            mapBtn.style.border = '1px solid var(--border)';
            
            mapContainer.style.display = 'none';
            Universe.renderFanView(scene);
        }
    },
    
	// Donn√©es des r√¥les par d√©partement
    crewRolesByDept: {
        'realisation': ['R√©alisateur', '1er Assistant R√©alisateur', '2√®me Assistant R√©alisateur', 'Scripte', 'Dialoguiste'],
        'image': ['Chef Op√©rateur / DOP', 'Cadreur', 'Assistant Cam√©ra', 'Steadicamer', 'DIT'],
        'lumiere': ['Chef √âlectricien', '√âlectricien', 'Pupitreur'],
        'machinerie': ['Chef Machiniste', 'Machiniste'],
        'son': ['Ing√©nieur du Son', 'Perchman', 'Assistant Son'],
        'decoration': ['Chef D√©corateur', 'Ensemblier', 'Accessoiriste', 'Peintre', 'Constructeur'],
        'costumes': ['Chef Costumier', 'Costumier', 'Habilleur'],
        'maquillage': ['Chef Maquilleur', 'Maquilleur', 'Coiffeur', 'Proth√©siste'],
        'regie': ['Directeur de Production', 'R√©gisseur G√©n√©ral', 'R√©gisseur Adjoint', 'Assistant R√©gie'],
        'casting': ['Directeur de Casting', 'Assistant Casting'],
        'postprod': ['Monteur', 'Assistant Monteur', '√âtalonneur', 'Mixeur Son', 'Bruiteur', 'Compositeur', 'VFX Artist'],
        'production': ['Producteur', 'Producteur Ex√©cutif', 'Directeur de Production', 'Comptable de Production']
    },

    // Affiche/masque les filtres selon le type s√©lectionn√©
    onTypeChange: () => {
        const type = document.getElementById('universe-type').value;
        
        document.getElementById('universe-filters-crew').style.display = 'none';
        document.getElementById('universe-filters-actor').style.display = 'none';
        document.getElementById('universe-filters-project').style.display = 'none';
        document.getElementById('universe-filters-collab').style.display = 'none';
        document.getElementById('universe-filters-production-type').style.display = 'none';
        document.getElementById('universe-filters-association').style.display = 'none';
        document.getElementById('universe-filters-enterprise').style.display = 'none';
        
        // R√©initialiser les filtres pour forcer le rechargement par type
        Universe.filteredProfiles = [];
        Universe.filteredProjects = [];
        
        // Mettre √† jour l'affichage selon le type s√©lectionn√©
        if(Universe.viewMode === 'map') {
            Universe.loadMapMarkersInView();
        } else {
            Universe.render();
        }
        
        if(type === 'crew') {
            document.getElementById('universe-filters-crew').style.display = 'flex';
            document.getElementById('universe-filters-collab').style.display = 'flex';
            Universe.populateCrewRoles();
        } else if(type === 'actor') {
            document.getElementById('universe-filters-actor').style.display = 'flex';
            document.getElementById('universe-filters-collab').style.display = 'flex';
        } else if(type === 'project') {
            document.getElementById('universe-filters-project').style.display = 'flex';
            document.getElementById('universe-filters-production-type').style.display = 'flex';
        } else if(type === 'association') {
            document.getElementById('universe-filters-association').style.display = 'flex';
            Universe.populateAssociationTypes();
        } else if(type === 'enterprise') {
            document.getElementById('universe-filters-enterprise').style.display = 'flex';
            Universe.populateEnterpriseTypes();
        }
    },

    // Remplit la liste des fonctions techniciens selon le d√©partement
    populateCrewRoles: (dept) => {
        const select = document.getElementById('universe-crew-role');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Fonction --</option>';
        
        let roles = [];
        
        if(dept && Universe.crewRolesByDept[dept]) {
            roles = Universe.crewRolesByDept[dept];
        } else {
            Object.values(Universe.crewRolesByDept).forEach(deptRoles => {
                roles = roles.concat(deptRoles);
            });
            roles = [...new Set(roles)];
        }
        
        roles.sort().forEach(role => {
            const opt = document.createElement('option');
            opt.value = role.toLowerCase();
            opt.textContent = role;
            select.appendChild(opt);
        });
    },

    // Quand on change le d√©partement
    onDepartmentChange: () => {
        const dept = document.getElementById('universe-department').value;
        Universe.populateCrewRoles(dept);
    },
    
    // Remplit la liste des types d'associations
    populateAssociationTypes: () => {
        const select = document.getElementById('universe-association-type');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Type d\'association --</option>';
        CONFIG.associationTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type.id;
            opt.textContent = type.name;
            select.appendChild(opt);
        });
    },
    
    // Remplit la liste des types d'entreprises
    populateEnterpriseTypes: () => {
        const select = document.getElementById('universe-enterprise-type');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- Type d\'entreprise --</option>';
        CONFIG.enterpriseTypes.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type.id;
            opt.textContent = type.name;
            select.appendChild(opt);
        });
    },
	
    // Initialise l'univers
    init: async () => {
        await Universe.loadAllProfiles();
        Universe.populateDepartments();
        
        // R√©initialiser le type √† "Tous"
        const typeSelect = document.getElementById('universe-type');
        if(typeSelect) typeSelect.value = '';
        
        // Masquer tous les filtres sp√©cifiques
        if(document.getElementById('universe-filters-crew')) document.getElementById('universe-filters-crew').style.display = 'none';
        if(document.getElementById('universe-filters-actor')) document.getElementById('universe-filters-actor').style.display = 'none';
        if(document.getElementById('universe-filters-association')) document.getElementById('universe-filters-association').style.display = 'none';
        if(document.getElementById('universe-filters-enterprise')) document.getElementById('universe-filters-enterprise').style.display = 'none';
        if(document.getElementById('universe-filters-project')) document.getElementById('universe-filters-project').style.display = 'none';
        
        // Initialiser la carte monde
        Universe.initMap();
        Universe.setViewMode('map');
        await Universe.loadMapMarkers();
    },
    
    // Charge tous les profils publics et projets
    loadAllProfiles: async () => {
        Universe.allProfiles = [];
        Universe.allProjects = [];
        
        try {
            // Charger les com√©diens
            const actorsSnap = await firebase.database().ref('public_actors').once('value');
            const actors = actorsSnap.val() || {};
            Object.values(actors).forEach(a => {
                if(a.name && a.profileComplete) {
                    Universe.allProfiles.push({ ...a, type: 'actor' });
                }
            });
            
            // Charger les techniciens
            const crewSnap = await firebase.database().ref('public_crew').once('value');
            const crew = crewSnap.val() || {};
            Object.values(crew).forEach(c => {
                if(c.name && c.profileComplete) {
                    Universe.allProfiles.push({ ...c, type: 'crew' });
                }
            });
            
            // Charger les associations
            const assocSnap = await firebase.database().ref('public_associations').once('value');
            const associations = assocSnap.val() || {};
            Object.values(associations).forEach(a => {
                if(a.assoName) {
                    Universe.allProfiles.push({ ...a, type: 'association', name: a.assoName });
                }
            });
            
            // Charger les entreprises
            const entSnap = await firebase.database().ref('public_enterprises').once('value');
            const enterprises = entSnap.val() || {};
            Object.values(enterprises).forEach(e => {
                if(e.entName) {
                    Universe.allProfiles.push({ ...e, type: 'enterprise', name: e.entName });
                }
            });
            
            // Charger les projets publics
            const projectsSnap = await firebase.database().ref('public_projects').once('value');
            const projects = projectsSnap.val() || {};
            Object.entries(projects).forEach(([id, p]) => {
                if(p.title && p.isPublic) {
                    Universe.allProjects.push({ ...p, id: id, type: 'project' });
                }
            });
            
            // Stocker mes profils pour le matching
            const myEmail = state.currentUser?.email;
            const myEmailKey = myEmail ? Utils.sanitizeEmail(myEmail) : null;
            const myEmailLower = myEmail ? myEmail.toLowerCase() : null;
            Universe.myProfiles = Universe.allProfiles.filter(p => 
                p.ownerEmail === myEmail || 
                p.ownerEmail === myEmailLower ||
                p.email === myEmail ||
                p.email === myEmailLower ||
                p.id === myEmailKey ||
                (p.id && myEmailKey && p.id.toLowerCase() === myEmailKey.toLowerCase())
            );
            console.log('Mes profils trouv√©s:', Universe.myProfiles.length, Universe.myProfiles);
            
            // Initialiser le s√©lecteur de profils pour le matching
            MatchingEngine.initProfileSelector();
            
        } catch(e) {
            console.error('Erreur chargement profils:', e);
        }
        
        },
    
    // Remplit le select des d√©partements
    populateDepartments: () => {
        const select = document.getElementById('universe-department');
        if(!select) return;
        
        select.innerHTML = '<option value="">-- D√©partement --</option>';
        CONFIG.crewGroups.forEach(grp => {
            const opt = document.createElement('option');
            opt.value = grp.id;
            opt.textContent = grp.name;
            select.appendChild(opt);
        });
    },
    
  // Rendu principal
    render: () => {
        const scene = document.getElementById('universe-scene');
        if(!scene) return;
        
        // Si mode carte, mettre √† jour les marqueurs
        if(Universe.viewMode === 'map') {
            Universe.loadMapMarkers();
            return;
        }
        
        // Mode fan/liste
        Universe.renderFanView(scene);
        return;
        
        // === Ancien code mode flottant d√©sactiv√© ===
        // Arr√™ter l'animation pr√©c√©dente
        Universe.animationRunning = false;
        scene.innerHTML = '';
        Universe.cards = [];
        scene.style.overflow = 'hidden';
        
        Universe.sceneRect = scene.getBoundingClientRect();
        const { width, height } = Universe.sceneRect;
        const centerX = width / 2 - 100;
        const centerY = height / 2 - 80;
        
        const myEmail = state.currentUser?.email;
        const myEmailKey = myEmail ? Utils.sanitizeEmail(myEmail) : null;
        
        // Collecter les profils de l'utilisateur (tous ses profils publics)
        const myProfiles = Universe.allProfiles.filter(p => p.ownerEmail === myEmail || p.id === myEmailKey);
        
        // Collecter les projets de l'utilisateur
        const myProjectsList = Universe.allProjects.filter(p => p.ownerEmail === myEmail);
        
        // Nombre total de cartes de l'utilisateur
        const myCardsCount = myProfiles.length + myProjectsList.length;
        const targetTotal = 15;
        const needExtra = Math.max(0, targetTotal - myCardsCount);
        
        // Trouver des profils compl√©mentaires
        let extraProfiles = [];
        if(needExtra > 0 && myProfiles.length > 0) {
            // D'abord les profils qui matchent
            const matchingProfiles = Universe.allProfiles.filter(p => {
                if(p.ownerEmail === myEmail || p.id === myEmailKey) return false;
                // Match par ville ou d√©partement
                return myProfiles.some(mp => 
                    (mp.city && p.city && mp.city.toLowerCase() === p.city.toLowerCase()) ||
                    (mp.department && p.department && mp.department === p.department)
                );
            });
            extraProfiles = Universe.shuffleArray(matchingProfiles).slice(0, needExtra);
        }
        
        // Compl√©ter avec des profils al√©atoires si besoin
        if(extraProfiles.length < needExtra) {
            const usedIds = [...myProfiles, ...extraProfiles].map(p => p.id);
            const randomProfiles = Universe.allProfiles.filter(p => 
                !usedIds.includes(p.id) && p.ownerEmail !== myEmail
            );
            const remaining = needExtra - extraProfiles.length;
            extraProfiles = [...extraProfiles, ...Universe.shuffleArray(randomProfiles).slice(0, remaining)];
        }
        
        // Carte principale au centre (premier profil de l'utilisateur ou placeholder)
        const mainProfile = myProfiles[0];
        if(mainProfile) {
            const myCard = Universe.createCard(mainProfile, true);
            const cardData = {
                el: myCard,
                x: centerX,
                y: centerY,
                vx: (Math.random() - 0.5) * 0.2,
                vy: (Math.random() - 0.5) * 0.2,
                isMain: true,
                rotation: 0,
                rotationSpeed: (Math.random() - 0.5) * 0.1
            };
            myCard.style.left = cardData.x + 'px';
            myCard.style.top = cardData.y + 'px';
            scene.appendChild(myCard);
            Universe.cards.push(cardData);
        } else {
            // Message si pas de profil
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'floating-card main-card';
            emptyDiv.innerHTML = `
                <div class="card-photo">üë§</div>
                <div class="card-name">Votre profil</div>
                <div class="card-role">Non compl√©t√©</div>
                <div class="card-city" style="color: var(--danger);">Cliquez sur "Mon Profil"</div>
            `;
            emptyDiv.onclick = () => PublicProfile.open();
            const cardData = {
                el: emptyDiv,
                x: centerX,
                y: centerY,
                vx: (Math.random() - 0.5) * 0.2,
                vy: (Math.random() - 0.5) * 0.2,
                isMain: true,
                rotation: 0,
                rotationSpeed: (Math.random() - 0.5) * 0.1
            };
            emptyDiv.style.left = cardData.x + 'px';
            emptyDiv.style.top = cardData.y + 'px';
            scene.appendChild(emptyDiv);
            Universe.cards.push(cardData);
        }
        
        // Autres profils de l'utilisateur (non flous, autour du centre)
        myProfiles.slice(1).forEach((profile, idx) => {
            const card = Universe.createCard(profile, false);
            card.classList.remove('blurred');
            card.classList.add('search-result'); // Visible
            
            const angle = ((idx + 1) / (myProfiles.length)) * Math.PI * 2;
            const distance = 120 + Math.random() * 50;
            const x = centerX + Math.cos(angle) * distance;
            const y = centerY + Math.sin(angle) * distance;
            
            const cardData = {
                el: card,
                x: Math.max(10, Math.min(width - 170, x)),
                y: Math.max(10, Math.min(height - 130, y)),
                vx: (Math.random() - 0.5) * 0.3,
                vy: (Math.random() - 0.5) * 0.3,
                isMain: false,
                isBlurred: false,
                rotation: (Math.random() - 0.5) * 4,
                rotationSpeed: (Math.random() - 0.5) * 0.05
            };
            
            card.style.left = cardData.x + 'px';
            card.style.top = cardData.y + 'px';
            card.style.transform = `rotate(${cardData.rotation}deg)`;
            
            scene.appendChild(card);
            Universe.cards.push(cardData);
        });
        
        // Projets de l'utilisateur (non flous)
        myProjectsList.forEach((project, idx) => {
            const card = Universe.createCard(project, false);
            card.classList.remove('blurred');
            card.classList.add('search-result');
            
            const angle = ((idx / Math.max(myProjectsList.length, 1)) * Math.PI) + Math.PI / 4;
            const distance = 150 + Math.random() * 80;
            const x = centerX + Math.cos(angle) * distance + 100;
            const y = centerY + Math.sin(angle) * distance;
            
            const cardData = {
                el: card,
                x: Math.max(10, Math.min(width - 170, x)),
                y: Math.max(10, Math.min(height - 130, y)),
                vx: (Math.random() - 0.5) * 0.3,
                vy: (Math.random() - 0.5) * 0.3,
                isMain: false,
                isBlurred: false,
                isProject: true,
                rotation: (Math.random() - 0.5) * 4,
                rotationSpeed: (Math.random() - 0.5) * 0.03
            };
            
            card.style.left = cardData.x + 'px';
            card.style.top = cardData.y + 'px';
            card.style.transform = `rotate(${cardData.rotation}deg)`;
            
            scene.appendChild(card);
            Universe.cards.push(cardData);
        });
        
        // Profils compl√©mentaires (flous, en arri√®re-plan)
        extraProfiles.forEach((profile, idx) => {
            const card = Universe.createCard(profile, false);
            
            const angle = (idx / Math.max(extraProfiles.length, 1)) * Math.PI * 2;
            const distance = 200 + Math.random() * 150;
            const x = centerX + Math.cos(angle) * distance + (Math.random() - 0.5) * 100;
            const y = centerY + Math.sin(angle) * distance + (Math.random() - 0.5) * 80;
            
            const cardData = {
                el: card,
                x: Math.max(10, Math.min(width - 170, x)),
                y: Math.max(10, Math.min(height - 130, y)),
                vx: (Math.random() - 0.5) * 0.4,
                vy: (Math.random() - 0.5) * 0.4,
                isMain: false,
                isBlurred: true,
                rotation: (Math.random() - 0.5) * 6,
                rotationSpeed: (Math.random() - 0.5) * 0.03
            };
            
            card.style.left = cardData.x + 'px';
            card.style.top = cardData.y + 'px';
            card.style.transform = `rotate(${cardData.rotation}deg)`;
            
            scene.appendChild(card);
            Universe.cards.push(cardData);
        });
        
        // Projets des autres utilisateurs (flous, en arri√®re-plan)
        const otherProjects = Universe.allProjects.filter(p => p.ownerEmail !== myEmail);
        const extraProjects = Universe.shuffleArray(otherProjects).slice(0, 5);
        
        extraProjects.forEach((project, idx) => {
            const card = Universe.createCard(project, false);
            
            const angle = ((idx / Math.max(extraProjects.length, 1)) * Math.PI) + Math.PI;
            const distance = 220 + Math.random() * 120;
            const x = centerX + Math.cos(angle) * distance + (Math.random() - 0.5) * 80;
            const y = centerY + Math.sin(angle) * distance + (Math.random() - 0.5) * 60;
            
            const cardData = {
                el: card,
                x: Math.max(10, Math.min(width - 170, x)),
                y: Math.max(10, Math.min(height - 130, y)),
                vx: (Math.random() - 0.5) * 0.3,
                vy: (Math.random() - 0.5) * 0.3,
                isMain: false,
                isBlurred: true,
                isProject: true,
                rotation: (Math.random() - 0.5) * 5,
                rotationSpeed: (Math.random() - 0.5) * 0.03
            };
            
            card.style.left = cardData.x + 'px';
            card.style.top = cardData.y + 'px';
            card.style.transform = `rotate(${cardData.rotation}deg)`;
            
            scene.appendChild(card);
            Universe.cards.push(cardData);
        });
        
        // D√©marrer l'animation
        Universe.animationRunning = true;
        Universe.animate();
    },
    
    // Boucle d'animation
    animate: () => {
        if(!Universe.animationRunning) return;
        
        const scene = document.getElementById('universe-scene');
        if(!scene) return;
        
        const rect = scene.getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;
        const cardWidth = 170;
        const cardHeight = 130;
        
        // Mettre √† jour chaque carte
        Universe.cards.forEach(card => {
            // Mouvement
            card.x += card.vx;
            card.y += card.vy;
            card.rotation += card.rotationSpeed;
            
            // Limiter la rotation
            if(card.rotation > 8) { card.rotation = 8; card.rotationSpeed *= -0.5; }
            if(card.rotation < -8) { card.rotation = -8; card.rotationSpeed *= -0.5; }
            
            // Rebond sur les bords
            if(card.x <= 5) { card.x = 5; card.vx *= -0.8; card.rotationSpeed += (Math.random() - 0.5) * 0.1; }
            if(card.x >= width - cardWidth - 5) { card.x = width - cardWidth - 5; card.vx *= -0.8; card.rotationSpeed += (Math.random() - 0.5) * 0.1; }
            if(card.y <= 5) { card.y = 5; card.vy *= -0.8; card.rotationSpeed += (Math.random() - 0.5) * 0.1; }
            if(card.y >= height - cardHeight - 5) { card.y = height - cardHeight - 5; card.vy *= -0.8; card.rotationSpeed += (Math.random() - 0.5) * 0.1; }
            
            // Appliquer la position
            card.el.style.left = card.x + 'px';
            card.el.style.top = card.y + 'px';
            card.el.style.transform = `rotate(${card.rotation}deg)`;
        });
        
        // Collision entre cartes nettes (search-result et main)
        const netCards = Universe.cards.filter(c => !c.isBlurred);
        for(let i = 0; i < netCards.length; i++) {
            for(let j = i + 1; j < netCards.length; j++) {
                Universe.handleCollision(netCards[i], netCards[j]);
            }
        }
        
        // L√©g√®re friction pour ralentir progressivement
        Universe.cards.forEach(card => {
            card.vx *= 0.999;
            card.vy *= 0.999;
            
            // Ajouter un peu de mouvement al√©atoire pour garder les cartes en mouvement
            if(Math.random() < 0.01) {
                card.vx += (Math.random() - 0.5) * 0.1;
                card.vy += (Math.random() - 0.5) * 0.1;
            }
            
            // Vitesse max (r√©duite pour mouvement plus calme)
            const maxSpeed = card.isMain ? 0.5 : 0.8;
            const speed = Math.sqrt(card.vx * card.vx + card.vy * card.vy);
            if(speed > maxSpeed) {
                card.vx = (card.vx / speed) * maxSpeed;
                card.vy = (card.vy / speed) * maxSpeed;
            }
            
            // Vitesse min pour √©viter l'arr√™t complet
            if(speed < 0.05) {
                card.vx += (Math.random() - 0.5) * 0.1;
                card.vy += (Math.random() - 0.5) * 0.1;
            }
        });
        
        requestAnimationFrame(Universe.animate);
    },
    
    // Gestion des collisions entre cartes
    handleCollision: (card1, card2) => {
        const dx = card2.x - card1.x;
        const dy = card2.y - card1.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const minDist = 160;
        
        if(dist < minDist && dist > 0) {
            // Repousser les cartes
            const overlap = minDist - dist;
            const nx = dx / dist;
            const ny = dy / dist;
            
            const pushForce = overlap * 0.15;
            
            if(!card1.isMain) {
                card1.x -= nx * pushForce;
                card1.y -= ny * pushForce;
                card1.vx -= nx * 0.2;
                card1.vy -= ny * 0.2;
            }
            
            if(!card2.isMain) {
                card2.x += nx * pushForce;
                card2.y += ny * pushForce;
                card2.vx += nx * 0.2;
                card2.vy += ny * 0.2;
            }
            
            // Petite rotation lors de la collision
            card1.rotationSpeed += (Math.random() - 0.5) * 0.05;
       card2.rotationSpeed += (Math.random() - 0.5) * 0.2;
        }
    },
    
    // Rendu en mode √âventail
    renderFanView: (scene) => {
        scene.innerHTML = '';
        scene.style.overflow = 'auto';
        
        const container = document.createElement('div');
        container.className = 'universe-fan-container';
        
        const myEmail = state.currentUser?.email;
        const myEmailKey = myEmail ? Utils.sanitizeEmail(myEmail) : null;
        
        // Cat√©goriser les profils
        const actors = Universe.allProfiles.filter(p => p.type === 'actor');
        const crew = Universe.allProfiles.filter(p => p.type === 'crew');
        const projects = Universe.allProjects;
        
        // Trouver mon profil
        const myProfile = Universe.allProfiles.find(p => p.id === myEmailKey);
        
        // Ma carte en premier (cat√©gorie sp√©ciale)
        if(myProfile) {
            const myCategory = Universe.createFanCategory('üë§ Mon Profil', [myProfile], true);
            container.appendChild(myCategory);
        }
        
        // Cat√©gorie Com√©diens
        if(actors.length > 0) {
            const actorCategory = Universe.createFanCategory('üé≠ Com√©diens', actors.slice(0, 15), false);
            container.appendChild(actorCategory);
        }
        
        // Cat√©gorie Techniciens
        if(crew.length > 0) {
            const crewCategory = Universe.createFanCategory('üé• Techniciens', crew.slice(0, 15), false);
            container.appendChild(crewCategory);
        }
        
        // Cat√©gorie Projets
        if(projects.length > 0) {
            const projectCategory = Universe.createFanCategory('üé¨ Projets', projects.slice(0, 10), false);
            container.appendChild(projectCategory);
        }
        
        scene.appendChild(container);
    },
    
    // Cr√©e une cat√©gorie avec grille de cartes
    createFanCategory: (label, items, isMyProfile) => {
        const category = document.createElement('div');
        category.className = 'fan-category';
        
        // Header avec label et compteur
        const header = document.createElement('div');
        header.className = 'fan-category-header';
        const labelEl = document.createElement('span');
        labelEl.className = 'fan-category-label';
        labelEl.innerHTML = label;
        header.appendChild(labelEl);
        
        if(items.length > 0) {
            const countEl = document.createElement('span');
            countEl.className = 'fan-category-count';
            countEl.textContent = `${items.length} r√©sultat${items.length > 1 ? 's' : ''}`;
            header.appendChild(countEl);
        }
        category.appendChild(header);
        
        if(items.length === 0) {
            const emptyMsg = document.createElement('div');
            emptyMsg.style.cssText = 'text-align: center; color: var(--text-sec); padding: 40px;';
            emptyMsg.textContent = 'Aucun r√©sultat';
            category.appendChild(emptyMsg);
            return category;
        }
        
        // Grille de cartes
        const grid = document.createElement('div');
        grid.className = 'fan-grid';
        
        // Afficher toutes les cartes (max 20)
        const maxCards = Math.min(items.length, 20);
        
        items.slice(0, maxCards).forEach((item) => {
            const card = Universe.createFanCard(item, isMyProfile);
            grid.appendChild(card);
        });
        
        // Message si plus de r√©sultats
        if(items.length > maxCards) {
            const moreMsg = document.createElement('div');
            moreMsg.style.cssText = 'text-align: center; color: var(--text-sec); padding: 15px; width: 100%;';
            moreMsg.textContent = `+ ${items.length - maxCards} autres r√©sultats. Affinez votre recherche.`;
            grid.appendChild(moreMsg);
        }
        
        category.appendChild(grid);
        
        return category;
    },
    
    // Cr√©e une carte pour la vue √©ventail
    createFanCard: (item, isMain) => {
        const card = document.createElement('div');
        const isProject = item.type === 'project';
        
        card.className = 'fan-card' + (isProject ? ' project-card' : '') + (isMain ? ' main-card' : '');
        card.dataset.profileId = item.id;
        
        if(isProject) {
            const photoHtml = item.image 
                ? `<img src="${item.image}" alt="${Utils.escape(item.title)}" onerror="this.parentElement.innerHTML='üé¨'">`
                : 'üé¨';
            
            card.innerHTML = `
                <div class="card-photo project-photo">${photoHtml}</div>
                <div class="card-name">${Utils.escape(item.title)}</div>
                <div class="card-role project-type">${item.projectType || 'Projet'}</div>
                ${item.city ? `<div class="card-city">üìç ${Utils.escape(item.city)}</div>` : ''}
            `;
            card.onclick = () => Universe.showProjectModal(item);
        } else {
            // Ic√¥ne selon le type
            const defaultIcon = item.type === 'actor' ? 'üé≠' : 
                               item.type === 'crew' ? 'üé•' : 
                               item.type === 'association' ? 'üèõÔ∏è' : 
                               item.type === 'enterprise' ? 'üè¢' : 'üë§';
            
            const photoHtml = item.photo 
                ? `<img src="${item.photo}" alt="${Utils.escape(item.name)}" onerror="this.parentElement.innerHTML='${defaultIcon}'">`
                : defaultIcon;
            
            // R√¥le/description selon le type
            let role = '';
            if(item.type === 'actor') {
                role = item.gender === 'homme' ? 'Com√©dien' : item.gender === 'femme' ? 'Com√©dienne' : 'Com√©dien¬∑ne';
            } else if(item.type === 'crew') {
                role = item.role || item.department || 'Technicien¬∑ne';
            } else if(item.type === 'association') {
                const assoType = CONFIG.associationTypes.find(t => t.id === item.assoType);
                role = assoType ? assoType.name : 'Association';
            } else if(item.type === 'enterprise') {
                const entType = CONFIG.enterpriseTypes.find(t => t.id === item.entType);
                role = entType ? entType.name : 'Entreprise';
            }
            
            // Message si adresse approximative
            const approxMsg = item._hasApproximateLocation ? 
                `<div class="card-approx-location" style="font-size: 0.7rem; color: var(--text-sec); background: var(--bg); padding: 4px 6px; border-radius: 4px; margin-top: 4px;">üìç Position approximative</div>` : '';
            
            card.innerHTML = `
                <div class="card-photo">${photoHtml}</div>
                <div class="card-name">${Utils.escape(item.name)}</div>
                <div class="card-role">${Utils.escape(role)}</div>
                ${item.city ? `<div class="card-city">üìç ${Utils.escape(item.city)}</div>` : ''}
                ${approxMsg}
            `;
            card.onclick = () => Universe.showProfileModal(item);
        }
        
        return card;
    },

    // Cr√©e une carte flottante (profil ou projet)
    createCard: (item, isMain) => {
        const card = document.createElement('div');
        const isProject = item.type === 'project';
        
        card.className = 'floating-card' + (isMain ? ' main-card' : ' blurred') + (isProject ? ' project-card' : '');
        card.dataset.profileId = item.id;
        
        if(isProject) {
            // Carte projet
            const photoHtml = item.image 
                ? `<img src="${item.image}" alt="${Utils.escape(item.title)}" onerror="this.parentElement.innerHTML='üé¨'">`
                : 'üé¨';
            
            const typeLabels = {
                'court-metrage': 'Court-m√©trage',
                'long-metrage': 'Long-m√©trage',
                'serie': 'S√©rie',
                'documentaire': 'Documentaire',
                'clip': 'Clip',
                'pub': 'Publicit√©',
                'corporate': 'Corporate'
            };
            const typeText = typeLabels[item.projectType] || item.projectType || 'Projet';
            
            const actorNeedsCount = (item.actorNeeds || []).length;
            const crewNeedsCount = Object.values(item.crewNeeds || {}).filter(n => n.needed).length + (item.customCrewNeeds || []).length;
            const needsText = [];
            if(actorNeedsCount > 0) needsText.push(`${actorNeedsCount} r√¥le${actorNeedsCount > 1 ? 's' : ''}`);
            if(crewNeedsCount > 0) needsText.push(`${crewNeedsCount} poste${crewNeedsCount > 1 ? 's' : ''}`);
            
            card.innerHTML = `
                <div class="card-photo project-photo">${photoHtml}</div>
                <div class="card-name">${Utils.escape(item.title || 'Sans titre')}</div>
                <div class="project-type">${Utils.escape(typeText)}</div>
                ${item.city ? `<div class="card-city">üìç ${Utils.escape(item.city)}</div>` : ''}
                ${needsText.length > 0 ? `<div class="card-needs">üîé ${needsText.join(', ')}</div>` : ''}
            `;
            
            card.onclick = () => Universe.openProjectModal(item);
        } else {
            // Carte profil (acteur, technicien, association ou entreprise)
            const defaultIcon = item.type === 'actor' ? 'üé≠' : 
                               item.type === 'crew' ? 'üé•' : 
                               item.type === 'association' ? 'üèõÔ∏è' : 
                               item.type === 'enterprise' ? 'üè¢' : 'üë§';
            
            const photoHtml = item.photo 
                ? `<img src="${item.photo}" alt="${Utils.escape(item.name)}" onerror="this.parentElement.innerHTML='${defaultIcon}'">`
                : defaultIcon;
            
            let roleText = '';
            if(item.type === 'actor') {
                roleText = 'Com√©dien.ne';
            } else if(item.type === 'crew') {
                roleText = item.role || 'Technicien.ne';
            } else if(item.type === 'association') {
                const assoType = CONFIG.associationTypes.find(t => t.id === item.assoType);
                roleText = assoType ? assoType.name : 'Association';
            } else if(item.type === 'enterprise') {
                const entType = CONFIG.enterpriseTypes.find(t => t.id === item.entType);
                roleText = entType ? entType.name : 'Entreprise';
            }
            
            card.innerHTML = `
                <div class="card-photo">${photoHtml}</div>
                <div class="card-name">${Utils.escape(item.name)}</div>
                <div class="card-role">${Utils.escape(roleText)}</div>
                ${item.city ? `<div class="card-city">üìç ${Utils.escape(item.city)}</div>` : ''}
            `;
            
            card.onclick = () => Universe.openProfileModal(item);
        }
        
        return card;
    },
    
    // Recherche
    search: async () => {
        const type = document.getElementById('universe-type').value;
        const city = document.getElementById('universe-city').value.trim().toLowerCase();
        
        // Si on cherche des projets
        if(type === 'project') {
            let results = [...Universe.allProjects];
            
            const projectType = document.getElementById('universe-project-type')?.value;
            const projectGenre = document.getElementById('universe-project-genre')?.value;
            const hasActorNeeds = document.getElementById('universe-project-has-actor-needs')?.checked;
            const hasCrewNeeds = document.getElementById('universe-project-has-crew-needs')?.checked;
            
            if(projectType) {
                results = results.filter(p => p.projectType === projectType);
            }
            if(projectGenre) {
                results = results.filter(p => p.genre === projectGenre);
            }
            if(hasActorNeeds) {
                results = results.filter(p => p.actorNeeds && p.actorNeeds.length > 0);
            }
            if(hasCrewNeeds) {
                results = results.filter(p => {
                    const crewCount = Object.values(p.crewNeeds || {}).filter(n => n.needed).length;
                    const customCount = (p.customCrewNeeds || []).length;
                    return crewCount + customCount > 0;
                });
            }
            if(city) {
                results = results.filter(p => p.city && p.city.toLowerCase().includes(city));
            }
            
            // Filtre type de production
            const productionType = document.getElementById('universe-production-type')?.value;
            if(productionType) {
                results = results.filter(p => p.productionType === productionType);
            }
            
            Universe.filteredProjects = results;
            Universe.filteredProfiles = [];
            Universe.renderSearchResults();
            
            // Toast de r√©sultats projets
            const count = results.length;
            if(count === 0) {
                Utils.toast('Aucun projet trouv√©', 'warning');
            } else {
                Utils.toast(`${count} projet${count > 1 ? 's' : ''} trouv√©${count > 1 ? 's' : ''}`, 'success');
            }
            return;
        }
        
        // Sinon on cherche des profils (com√©diens ou techniciens)
        let results = [...Universe.allProfiles];
        
        // Filtrer par type
        if(type) {
            results = results.filter(p => p.type === type || p.accountType === type);
        }
        
        // Filtrer par ville
        if(city) {
            results = results.filter(p => p.city && p.city.toLowerCase().includes(city));
        }
        
        // Filtre v√©hicule (commun)
        const hasVehicle = document.getElementById('universe-has-vehicle')?.checked;
        if(hasVehicle) {
            results = results.filter(p => p.hasVehicle === true);
        }
        
        // Filtre type de collaboration (commun acteurs/techniciens)
        const collabType = document.getElementById('universe-collab-type')?.value;
        if(collabType) {
            results = results.filter(p => {
                // collabTypes est un tableau (ex: ['pro', 'semi-pro', 'benevole'])
                if(Array.isArray(p.collabTypes)) {
                    return p.collabTypes.includes(collabType);
                }
                // Compatibilit√© ancienne structure (collabType string)
                return p.collabType === collabType;
            });
        }
        
        // Filtre statut professionnel (commun acteurs/techniciens)
        const statusType = document.getElementById('universe-status-type')?.value;
        if(statusType) {
            results = results.filter(p => p.professionalStatus === statusType);
        }
        
        // Filtres techniciens
        if(type === 'crew') {
            const dept = document.getElementById('universe-department')?.value;
            const role = document.getElementById('universe-crew-role')?.value;
            
            if(dept) {
                results = results.filter(p => p.department === dept);
            }
            if(role) {
                results = results.filter(p => p.role && p.role.toLowerCase().includes(role));
            }
        }
        
        // Filtres com√©diens
        if(type === 'actor') {
            const gender = document.getElementById('universe-actor-gender')?.value;
            const ageMin = document.getElementById('universe-actor-age-min')?.value;
            const ageMax = document.getElementById('universe-actor-age-max')?.value;
            const heightMin = document.getElementById('universe-actor-height-min')?.value;
            const heightMax = document.getElementById('universe-actor-height-max')?.value;
            const weightMin = document.getElementById('universe-actor-weight-min')?.value;
            const weightMax = document.getElementById('universe-actor-weight-max')?.value;
            const eyes = document.getElementById('universe-actor-eyes')?.value;
            const hair = document.getElementById('universe-actor-hair')?.value;
            const hairLength = document.getElementById('universe-actor-hair-length')?.value;
            const ethnicity = document.getElementById('universe-actor-ethnicity')?.value;
            const corpulence = document.getElementById('universe-actor-corpulence')?.value;
            const sports = document.getElementById('universe-actor-sports')?.value.trim().toLowerCase();
            const languages = document.getElementById('universe-actor-languages')?.value.trim().toLowerCase();
            
            if(gender) results = results.filter(p => p.gender === gender);
            if(ageMin) results = results.filter(p => p.age && parseInt(p.age) >= parseInt(ageMin));
            if(ageMax) results = results.filter(p => p.age && parseInt(p.age) <= parseInt(ageMax));
            if(heightMin) results = results.filter(p => p.height && parseInt(p.height) >= parseInt(heightMin));
            if(heightMax) results = results.filter(p => p.height && parseInt(p.height) <= parseInt(heightMax));
            if(weightMin) results = results.filter(p => p.weight && parseInt(p.weight) >= parseInt(weightMin));
            if(weightMax) results = results.filter(p => p.weight && parseInt(p.weight) <= parseInt(weightMax));
            if(eyes) results = results.filter(p => p.eyeColor === eyes);
            if(hair) results = results.filter(p => p.hairColor === hair);
            if(hairLength) results = results.filter(p => p.hairLength === hairLength);
            if(ethnicity) results = results.filter(p => p.ethnicity === ethnicity);
            if(corpulence) results = results.filter(p => p.corpulence === corpulence);
            if(sports) results = results.filter(p => p.sports && p.sports.toLowerCase().includes(sports));
            if(languages) results = results.filter(p => p.languages && p.languages.toLowerCase().includes(languages));
            
            const bonnet = document.getElementById('universe-actor-bonnet')?.value;
            const bustType = document.getElementById('universe-actor-bust-type')?.value;
            
            if(bonnet) results = results.filter(p => p.bonnet === bonnet);
            if(bustType) results = results.filter(p => p.bustType === bustType);
        }
        
        // Filtres associations
        if(type === 'association') {
            const assoType = document.getElementById('universe-association-type')?.value;
            if(assoType) {
                results = results.filter(p => p.assoType === assoType);
            }
        }
        
        // Filtres entreprises
        if(type === 'enterprise') {
            const entType = document.getElementById('universe-enterprise-type')?.value;
            if(entType) {
                results = results.filter(p => p.entType === entType);
            }
        }
        
        Universe.filteredProfiles = results;
        Universe.filteredProjects = [];
        Universe.renderSearchResults();
        
        // Toast de r√©sultats
        const count = results.length;
        if(count === 0) {
            Utils.toast('Aucun r√©sultat trouv√©', 'warning');
        } else {
            Utils.toast(`${count} profil${count > 1 ? 's' : ''} trouv√©${count > 1 ? 's' : ''}`, 'success');
        }
    },
    
    // Affiche les r√©sultats de recherche
    renderSearchResults: async () => {
        const scene = document.getElementById('universe-scene');
        if(!scene) return;
        
        // Arr√™ter l'animation pr√©c√©dente
        Universe.animationRunning = false;
        Universe.cards = [];
        
        // Si mode carte, mettre √† jour les marqueurs filtr√©s
        if(Universe.viewMode === 'map') {
            await Universe.loadFilteredMapMarkers();
            return;
        }
        
        // Sinon afficher en mode √©ventail
        scene.innerHTML = '';
        Universe.renderSearchResultsFan(scene);
    },
    
    // Charger les marqueurs filtr√©s sur la carte
    loadFilteredMapMarkers: async () => {
        if(!Universe.map || !Universe.markersLayer) return;
        
        Universe.markersLayer.clearLayers();
        Universe.cityPositionCounters = {}; // Reset des compteurs
        
        // Utiliser les r√©sultats filtr√©s
        const items = [...Universe.filteredProfiles, ...Universe.filteredProjects];
        
        if(items.length === 0) {
            Utils.toast('Aucun r√©sultat √† afficher sur la carte', 'info');
            return;
        }
        
        for(let i = 0; i < items.length; i += 10) {
            const batch = items.slice(i, i + 10);
            
            await Promise.all(batch.map(async (item) => {
                const city = item.city || item.location || '';
                if(!city) return;
                
const coords = await Universe.geocodeCity(city);
                if(coords) {
                    // D√©calage d√©terministe bas√© sur l'ID du profil (fixe, pas al√©atoire)
                    const shouldHide = Universe.shouldHideAddress(item);
                    let finalCoords;
                    if(shouldHide) {
                        finalCoords = Universe.getDeterministicOffset(item.id, coords.lat, coords.lng);
                        item._hasApproximateLocation = true;
                    } else {
                        finalCoords = { lat: coords.lat, lng: coords.lng };
                        item._hasApproximateLocation = false;
                    }
                    
                    const marker = Universe.createMapMarker(item, finalCoords);
                    Universe.markersLayer.addLayer(marker);
                }
            }));
            
            if(i + 10 < items.length) {
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }
        
        // Zoomer sur les r√©sultats
        if(Universe.markersLayer.getLayers().length > 0) {
            Universe.map.fitBounds(Universe.markersLayer.getBounds(), { padding: [50, 50] });
        }
    },
    
    // Rendu des r√©sultats de recherche en mode √âventail
    renderSearchResultsFan: (scene) => {
        scene.innerHTML = '';
        scene.style.overflow = 'auto';
        
        const container = document.createElement('div');
        container.className = 'universe-fan-container';
        
        // S√©parer profils et projets des r√©sultats
        const actors = Universe.filteredProfiles.filter(p => p.type === 'actor');
        const crew = Universe.filteredProfiles.filter(p => p.type === 'crew');
        const associations = Universe.filteredProfiles.filter(p => p.type === 'association');
        const enterprises = Universe.filteredProfiles.filter(p => p.type === 'enterprise');
        const projects = Universe.filteredProjects;
        
        // Message si aucun r√©sultat
        if(actors.length === 0 && crew.length === 0 && associations.length === 0 && enterprises.length === 0 && projects.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px; color: var(--text-sec);">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
                    <h3>Aucun r√©sultat</h3>
                    <p>Essayez avec d'autres crit√®res de recherche.</p>
                </div>
            `;
            scene.appendChild(container);
            return;
        }
        
        // Cat√©gorie Com√©diens trouv√©s
        if(actors.length > 0) {
            const actorCategory = Universe.createFanCategory(`üé≠ Com√©diens trouv√©s`, actors.slice(0, 20), false);
            container.appendChild(actorCategory);
        }
        
        // Cat√©gorie Techniciens trouv√©s
        if(crew.length > 0) {
            const crewCategory = Universe.createFanCategory(`üé• Techniciens trouv√©s`, crew.slice(0, 20), false);
            container.appendChild(crewCategory);
        }
        
        // Cat√©gorie Associations trouv√©es
        if(associations.length > 0) {
            const assoCategory = Universe.createFanCategory(`üèõÔ∏è Associations trouv√©es`, associations.slice(0, 20), false);
            container.appendChild(assoCategory);
        }
        
        // Cat√©gorie Entreprises trouv√©es
        if(enterprises.length > 0) {
            const entCategory = Universe.createFanCategory(`üè¢ Entreprises trouv√©es`, enterprises.slice(0, 20), false);
            container.appendChild(entCategory);
        }
        
        // Cat√©gorie Projets trouv√©s
        if(projects.length > 0) {
            const projectCategory = Universe.createFanCategory(`üé¨ Projets trouv√©s`, projects.slice(0, 15), false);
            container.appendChild(projectCategory);
        }
        
        scene.appendChild(container);
    },
    
    // Reset la recherche
    reset: () => {
        document.getElementById('universe-type').value = '';
        document.getElementById('universe-department').value = '';
        document.getElementById('universe-city').value = '';
        document.getElementById('universe-distance').value = '500';
        document.getElementById('universe-distance-label').textContent = '‚àû';
        
        // Reset filtres com√©diens
        if(document.getElementById('universe-actor-gender')) document.getElementById('universe-actor-gender').value = '';
        if(document.getElementById('universe-actor-age-min')) document.getElementById('universe-actor-age-min').value = '';
        if(document.getElementById('universe-actor-age-max')) document.getElementById('universe-actor-age-max').value = '';
        if(document.getElementById('universe-actor-height-min')) document.getElementById('universe-actor-height-min').value = '';
        if(document.getElementById('universe-actor-height-max')) document.getElementById('universe-actor-height-max').value = '';
        if(document.getElementById('universe-actor-weight-min')) document.getElementById('universe-actor-weight-min').value = '';
        if(document.getElementById('universe-actor-weight-max')) document.getElementById('universe-actor-weight-max').value = '';
        if(document.getElementById('universe-actor-eyes')) document.getElementById('universe-actor-eyes').value = '';
        if(document.getElementById('universe-actor-hair')) document.getElementById('universe-actor-hair').value = '';
        if(document.getElementById('universe-actor-hair-length')) document.getElementById('universe-actor-hair-length').value = '';
        if(document.getElementById('universe-actor-ethnicity')) document.getElementById('universe-actor-ethnicity').value = '';
        if(document.getElementById('universe-actor-corpulence')) document.getElementById('universe-actor-corpulence').value = '';
        if(document.getElementById('universe-actor-sports')) document.getElementById('universe-actor-sports').value = '';
        if(document.getElementById('universe-actor-languages')) document.getElementById('universe-actor-languages').value = '';
        if(document.getElementById('universe-actor-bonnet')) document.getElementById('universe-actor-bonnet').value = '';
        if(document.getElementById('universe-actor-bust-type')) document.getElementById('universe-actor-bust-type').value = '';
        
        // Reset filtres techniciens
        if(document.getElementById('universe-crew-role')) document.getElementById('universe-crew-role').value = '';
        
        // Reset filtres projets
        if(document.getElementById('universe-project-type')) document.getElementById('universe-project-type').value = '';
        if(document.getElementById('universe-project-genre')) document.getElementById('universe-project-genre').value = '';
        if(document.getElementById('universe-project-has-actor-needs')) document.getElementById('universe-project-has-actor-needs').checked = false;
        if(document.getElementById('universe-project-has-crew-needs')) document.getElementById('universe-project-has-crew-needs').checked = false;
        
        // Reset filtres associations
        if(document.getElementById('universe-association-type')) document.getElementById('universe-association-type').value = '';
        
        // Reset filtres entreprises
        if(document.getElementById('universe-enterprise-type')) document.getElementById('universe-enterprise-type').value = '';
        
        // Masquer les filtres sp√©cifiques
        document.getElementById('universe-filters-crew').style.display = 'none';
        document.getElementById('universe-filters-actor').style.display = 'none';
        document.getElementById('universe-filters-project').style.display = 'none';
        document.getElementById('universe-filters-association').style.display = 'none';
        document.getElementById('universe-filters-enterprise').style.display = 'none';
        
        Universe.filteredProfiles = [];
        Universe.filteredProjects = [];
        Universe.render();
    },
    
    // Ouvre le modal de profil
	// Ouvre le modal d'un projet
	
	
	
    openProjectModal: (project) => {
        const typeLabels = {
            'court-metrage': 'Court-m√©trage',
            'long-metrage': 'Long-m√©trage',
            'serie': 'S√©rie',
            'documentaire': 'Documentaire',
            'clip': 'Clip',
            'pub': 'Publicit√©',
            'corporate': 'Corporate'
        };
        const genreLabels = {
            'drame': 'Drame', 'comedie': 'Com√©die', 'thriller': 'Thriller',
            'horreur': 'Horreur', 'sf': 'Science-Fiction', 'fantastique': 'Fantastique',
            'action': 'Action', 'romance': 'Romance', 'animation': 'Animation',
            'experimental': 'Exp√©rimental'
        };
        
        const typeText = typeLabels[project.projectType] || project.projectType || '';
        const genreText = genreLabels[project.genre] || project.genre || '';
        
        // Besoins com√©diens
        let actorNeedsHtml = '';
        if(project.actorNeeds && project.actorNeeds.length > 0) {
            actorNeedsHtml = '<div style="margin-top: 15px;"><strong>üé≠ R√¥les recherch√©s :</strong><div style="margin-top: 10px;">';
            project.actorNeeds.forEach(need => {
                const ageRange = (need.ageMin || need.ageMax) ? ` ‚Ä¢ ${need.ageMin || '?'}-${need.ageMax || '?'} ans` : '';
                actorNeedsHtml += `<div style="background: var(--bg); padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                    <strong>${Utils.escape(need.roleName || 'R√¥le')}</strong> (${need.type || 'principal'})
                    ${need.gender ? ' ‚Ä¢ ' + need.gender : ''}${ageRange}
                    ${need.description ? `<div style="font-size: 0.85rem; color: var(--text-sec); margin-top: 5px;">${Utils.escape(need.description)}</div>` : ''}
                </div>`;
            });
            actorNeedsHtml += '</div></div>';
        }
        
        // Besoins techniciens
        let crewNeedsHtml = '';
        const crewNeeded = [];
        if(project.crewNeeds) {
            Object.entries(project.crewNeeds).forEach(([id, need]) => {
                if(need.needed) {
                    const pos = Presentation.crewPositions.find(p => p.id === id);
                    crewNeeded.push(pos ? pos.name : id);
                }
            });
        }
        if(project.customCrewNeeds) {
            project.customCrewNeeds.forEach(c => crewNeeded.push(c.name));
        }
        if(crewNeeded.length > 0) {
            crewNeedsHtml = `<div style="margin-top: 15px;"><strong>üé¨ Postes recherch√©s :</strong><div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                ${crewNeeded.map(n => `<span style="background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;">${Utils.escape(n)}</span>`).join('')}
            </div></div>`;
        }
        
        const modalHtml = `
            <div class="profile-modal-overlay" onclick="if(event.target === this) this.remove();">
                <div class="profile-modal-box">
                    <div class="profile-modal-header" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white;">
                        <button class="profile-modal-close" onclick="this.closest('.profile-modal-overlay').remove()" style="color: white;">‚úï</button>
                        ${project.image ? `<img src="${project.image}" style="width: 150px; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e94560;">` : '<div style="font-size: 4rem; margin-bottom: 15px;">üé¨</div>'}
                        <div class="profile-modal-name">${Utils.escape(project.title || 'Sans titre')}</div>
                        <div style="color: #e94560; font-weight: bold;">${Utils.escape(typeText)}${genreText ? ' ‚Ä¢ ' + genreText : ''}</div>
                        ${project.city ? `<div style="margin-top: 5px; opacity: 0.8;">üìç ${Utils.escape(project.city)}${project.region ? ', ' + project.region : ''}</div>` : ''}
                    </div>
                    <div class="profile-modal-body" style="padding: 20px;">
                        ${project.director || project.producer ? `
                        <div style="margin-bottom: 15px;">
                            ${project.director ? `<div><strong>R√©alisateur :</strong> ${Utils.escape(project.director)}</div>` : ''}
                            ${project.producer ? `<div><strong>Producteur :</strong> ${Utils.escape(project.producer)}</div>` : ''}
                        </div>` : ''}
                        
                        ${project.dateShootingStart ? `<div style="margin-bottom: 15px;"><strong>üìÖ Tournage :</strong> ${project.dateShootingStart}${project.dateShootingEnd ? ' ‚Üí ' + project.dateShootingEnd : ''}</div>` : ''}
                        
                        ${project.description ? `<div style="margin-bottom: 15px;"><strong>üìù Description :</strong><div style="margin-top: 5px; color: var(--text-sec); line-height: 1.5;">${Utils.escape(project.description)}</div></div>` : ''}
                        
                        ${actorNeedsHtml}
                        ${crewNeedsHtml}
                        
                        <div class="profile-modal-actions" style="margin-top: 20px;">
                            <button onclick="app.Universe.contactProject('${project.projectId}', '${Utils.escape(project.title)}', '${Utils.escape(project.ownerEmail)}')" style="flex: 1; padding: 12px; background: #e94560; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">üìß Contacter le projet</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    },
    
    // Contacter un projet
    contactProject: async (projectId, projectTitle, ownerEmail) => {
        const subject = await ConfirmModal.prompt(`Objet du message pour "${projectTitle}"`, "Contacter le projet", "Objet...");
        if(!subject) return;
        
        const content = await ConfirmModal.prompt("√âcrivez votre message.", "Votre message", "Message...");
        if(!content) return;
        
        try {
            await Messages.send(ownerEmail, { subject: `[Projet] ${projectTitle} - ${subject}`, content: content });
            
            // Envoyer un email de notification
            if(typeof emailjs !== 'undefined' && CONFIG.emailJS.publicKey && CONFIG.emailJS.publicKey !== 'VOTRE_PUBLIC_KEY') {
                const myProfile = await PublicProfile.loadProfile(state.currentUser.uid);
                const myName = Messages.sanitizeForEmail(myProfile?.name || state.currentUser.email || 'Un utilisateur');
                const sanitize = Messages.sanitizeForEmail;
                
                emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, {
                    to_email: sanitize(ownerEmail),
                    name: sanitize(ownerEmail.split('@')[0]) || 'Utilisateur',
                    email: sanitize(ownerEmail),
                    project_title: sanitize(projectTitle) || 'Projet',
                    role: 'Message',
                    inviter_name: myName,
                    message: sanitize(myName + ' vous a contacte concernant votre projet ' + projectTitle + '. Sujet: ' + subject + '. Connectez-vous a Moteur pour lire le message.'),
                    app_url: sanitize(window.location.origin + window.location.pathname)
                }, CONFIG.emailJS.publicKey).catch((e) => console.warn('Email non envoye:', e));
            }
            
            Utils.toast('Message envoy√© !', 'success');
            document.querySelector('.profile-modal-overlay')?.remove();
        } catch(e) {
            console.error('Erreur envoi message:', e);
            Utils.toast('Erreur lors de l\'envoi du message.', 'error');
        }
    },
	
	
	
    // V√©rifie si une section est visible selon le contexte (public ou projet)
    isSectionVisible: (profile, section, context = 'public') => {
        if(!profile) return true;
        const hiddenArray = context === 'public' ? (profile.hiddenPublic || []) : (profile.hiddenProject || []);
        return !hiddenArray.includes(section);
    },
    
    openProfileModal: async (profile) => {
        // D√©terminer le type
        const isProject = profile.type === 'project';
        const isActor = profile.type === 'actor';
        const isCrew = profile.type === 'crew';
        const isAssociation = profile.type === 'association';
        const isEnterprise = profile.type === 'enterprise';
        // Charger les donn√©es compl√®tes depuis Firebase si n√©cessaire
        let fullProfile = profile;
        if(true) {
            try {
                let ref = null;
                if(isActor) ref = firebase.database().ref('public_actors/' + profile.id);
                else if(isCrew) ref = firebase.database().ref('public_crew/' + profile.id);
                else if(isAssociation) ref = firebase.database().ref('public_associations/' + profile.id);
                else if(isEnterprise) ref = firebase.database().ref('public_enterprises/' + profile.id);
                else if(isProject) ref = firebase.database().ref('public_projects/' + profile.id);
                
                if(ref) {
                    const snap = await ref.once('value');
                    if(snap.val()) fullProfile = { ...snap.val(), id: profile.id, type: profile.type };
                }
            } catch(e) { console.warn('Erreur chargement profil:', e); }
        }
        
        Universe.currentProfile = fullProfile;
        
        // Photo
        const photoEl = document.getElementById('pm-photo');
        const photo = fullProfile.photo || fullProfile.photoURL || fullProfile.mainPhoto || fullProfile.poster || null;
        let defaultIcon = 'üë§';
        if(isProject) defaultIcon = 'üé¨';
        else if(isActor) defaultIcon = 'üé≠';
        else if(isCrew) defaultIcon = 'üé•';
        else if(isAssociation) defaultIcon = 'üèõÔ∏è';
        else if(isEnterprise) defaultIcon = 'üè¢';
        
        if(photo) {
            photoEl.innerHTML = `<img src="${photo}" alt="${Utils.escape(fullProfile.name || fullProfile.title || '')}" onerror="this.parentElement.innerHTML='${defaultIcon}'">`;
        } else {
            photoEl.innerHTML = defaultIcon;
        }
        
        // Nom
        const name = fullProfile.name || fullProfile.displayName || fullProfile.title || fullProfile.assoName || fullProfile.entName || 'Sans nom';
        document.getElementById('pm-name').textContent = name;
        
        // R√¥le / Type
        let roleText = '';
        if(isProject) roleText = fullProfile.projectType || 'Projet';
        else if(isActor) roleText = fullProfile.role || 'Com√©dien¬∑ne';
        else if(isCrew) roleText = fullProfile.role || 'Technicien¬∑ne';
        else if(isAssociation) roleText = fullProfile.assoType || 'Association';
        else if(isEnterprise) roleText = fullProfile.entType || 'Entreprise';
        document.getElementById('pm-role').textContent = roleText;
        
        // Ville
        const city = fullProfile.city || fullProfile.location || '';
        document.getElementById('pm-city').textContent = city ? 'üìç ' + city : '';
        
        // Galerie photos (v√©rifier visibilit√©)
        let galleryHtml = '';
        const gallerySection = fullProfile.type === 'crew' ? 'crew-gallery' : 'gallery';
        const photos = fullProfile.galleryPhotos || fullProfile.crewGalleryPhotos || fullProfile.gallery || fullProfile.photos || [];
        if(photos.length > 0 && Universe.isSectionVisible(fullProfile, gallerySection, 'public')) {
            galleryHtml = '<div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;">';
            photos.slice(0, 5).forEach(url => {
                if(url) {
                    galleryHtml += `<div style="width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                        <img src="${url}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="window.open('${url}', '_blank')" onerror="this.parentElement.style.display='none'">
                    </div>`;
                }
            });
            galleryHtml += '</div>';
        }
        
        // Bio / Description
        const bioSection = document.getElementById('pm-bio-section');
        const bioEl = document.getElementById('pm-bio');
        const bioText = fullProfile.bio || fullProfile.description || fullProfile.synopsis || '';
        if(bioText || galleryHtml) {
            bioSection.style.display = 'block';
            bioEl.innerHTML = galleryHtml + (bioText ? '<p>' + Utils.escape(bioText) + '</p>' : '');
        } else {
            bioSection.style.display = 'none';
        }
        
        // Infos selon le type
        const infoEl = document.getElementById('pm-info');
        let infoHtml = '';
        
        if(isActor) {
            // Section Identit√© (toujours visible sauf si cach√©e)
            if(fullProfile.gender && Universe.isSectionVisible(fullProfile, 'identity', 'public')) infoHtml += `<div class="profile-modal-info-item"><label>Genre</label><span>${fullProfile.gender}</span></div>`;
            
            // Section Description Physique
            if(Universe.isSectionVisible(fullProfile, 'physical', 'public')) {
                if(fullProfile.age) infoHtml += `<div class="profile-modal-info-item"><label>√Çge</label><span>${fullProfile.age} ans</span></div>`;
                if(fullProfile.height) infoHtml += `<div class="profile-modal-info-item"><label>Taille</label><span>${fullProfile.height} cm</span></div>`;
                if(fullProfile.weight) infoHtml += `<div class="profile-modal-info-item"><label>Poids</label><span>${fullProfile.weight} kg</span></div>`;
                if(fullProfile.eyeColor) infoHtml += `<div class="profile-modal-info-item"><label>Yeux</label><span>${fullProfile.eyeColor}</span></div>`;
                if(fullProfile.hairColor) infoHtml += `<div class="profile-modal-info-item"><label>Cheveux</label><span>${fullProfile.hairColor}${fullProfile.hairLength ? ' (' + fullProfile.hairLength + ')' : ''}</span></div>`;
                if(fullProfile.corpulence) infoHtml += `<div class="profile-modal-info-item"><label>Corpulence</label><span>${fullProfile.corpulence}</span></div>`;
                if(fullProfile.bonnet || fullProfile.bustSize) infoHtml += `<div class="profile-modal-info-item"><label>Poitrine</label><span>${fullProfile.bonnet ? 'Bonnet ' + fullProfile.bonnet : ''}${fullProfile.bustSize ? ' (' + fullProfile.bustSize + ' cm)' : ''}${fullProfile.bustType ? ' - ' + fullProfile.bustType : ''}</span></div>`;
                if(fullProfile.ethnicity) infoHtml += `<div class="profile-modal-info-item"><label>Origine</label><span>${fullProfile.ethnicity}</span></div>`;
            }
            if(fullProfile.languages) infoHtml += `<div class="profile-modal-info-item"><label>Langues</label><span>${fullProfile.languages}</span></div>`;
            if(fullProfile.sports) infoHtml += `<div class="profile-modal-info-item"><label>Sports</label><span>${fullProfile.sports}</span></div>`;
            
            // Section Tarif
            if(Universe.isSectionVisible(fullProfile, 'tarif', 'public')) {
                if(fullProfile.dailyRate) infoHtml += `<div class="profile-modal-info-item"><label>Tarif</label><span>${fullProfile.dailyRate} ${fullProfile.rateCurrency || '‚Ç¨'}/${fullProfile.rateType || 'Jour'}</span></div>`;
            }
            
            // Section V√©hicule
            if(Universe.isSectionVisible(fullProfile, 'vehicle', 'public')) {
                if(fullProfile.hasVehicle) infoHtml += `<div class="profile-modal-info-item"><label>V√©hicule</label><span>üöó ${fullProfile.vehicleType || 'Oui'}${fullProfile.vehicleSeats ? ' (' + fullProfile.vehicleSeats + ' places)' : ''}</span></div>`;
            }
        } else if(isCrew) {
            // Section Identit√©
            if(Universe.isSectionVisible(fullProfile, 'identity', 'public')) {
                if(fullProfile.gender) infoHtml += `<div class="profile-modal-info-item"><label>Genre</label><span>${fullProfile.gender}</span></div>`;
            }
            
            // Section M√©tier & Comp√©tences
            if(Universe.isSectionVisible(fullProfile, 'skills', 'public')) {
                if(fullProfile.department) {
                    const deptName = CONFIG.crewGroups.find(g => g.id === fullProfile.department)?.name || fullProfile.department;
                    infoHtml += `<div class="profile-modal-info-item"><label>D√©partement</label><span>${deptName}</span></div>`;
                }
                if(fullProfile.experience) infoHtml += `<div class="profile-modal-info-item"><label>Exp√©rience</label><span>${fullProfile.experience}</span></div>`;
            }
            
            // Section Tarif
            if(Universe.isSectionVisible(fullProfile, 'tarif', 'public')) {
                if(fullProfile.dailyRate) infoHtml += `<div class="profile-modal-info-item"><label>Tarif</label><span>${fullProfile.dailyRate} ${fullProfile.rateCurrency || '‚Ç¨'}/${fullProfile.rateType || 'Jour'}</span></div>`;
            }
            
            // Section V√©hicule
            if(Universe.isSectionVisible(fullProfile, 'vehicle', 'public')) {
                if(fullProfile.hasVehicle) infoHtml += `<div class="profile-modal-info-item"><label>V√©hicule</label><span>üöó ${fullProfile.vehicleType || 'Oui'}${fullProfile.vehicleSeats ? ' (' + fullProfile.vehicleSeats + ' places)' : ''}</span></div>`;
            }
        } else if(isProject) {
            if(fullProfile.genre) infoHtml += `<div class="profile-modal-info-item"><label>Genre</label><span>${fullProfile.genre}</span></div>`;
            if(fullProfile.director) infoHtml += `<div class="profile-modal-info-item"><label>R√©alisateur</label><span>${fullProfile.director}</span></div>`;
            if(fullProfile.producer) infoHtml += `<div class="profile-modal-info-item"><label>Producteur</label><span>${fullProfile.producer}</span></div>`;
            if(fullProfile.status) infoHtml += `<div class="profile-modal-info-item"><label>Statut</label><span>${fullProfile.status}</span></div>`;
        } else if(isAssociation || isEnterprise) {
            if(fullProfile.siret) infoHtml += `<div class="profile-modal-info-item"><label>SIRET</label><span>${fullProfile.siret}</span></div>`;
            if(fullProfile.services) infoHtml += `<div class="profile-modal-info-item" style="grid-column: span 2;"><label>Services</label><span>${fullProfile.services}</span></div>`;
        }
        
        if(fullProfile.availabilityText) infoHtml += `<div class="profile-modal-info-item" style="grid-column: span 2;"><label>Disponibilit√©</label><span>${fullProfile.availabilityText}</span></div>`;
        
        infoEl.innerHTML = infoHtml || '<p style="color: var(--text-sec);">Pas d\'informations suppl√©mentaires</p>';
        
        // Contact (v√©rifier visibilit√© de la section identit√©)
        const contactEl = document.getElementById('pm-contact');
        let contactHtml = '';
        if(Universe.isSectionVisible(fullProfile, 'identity', 'public')) {
            const email = fullProfile.email || fullProfile.ownerEmail || '';
            const phone = fullProfile.phone || '';
            const website = fullProfile.website || '';
            if(email) contactHtml += `<div class="profile-modal-info-item"><label>Email</label><span>${email}</span></div>`;
            if(phone) contactHtml += `<div class="profile-modal-info-item"><label>T√©l√©phone</label><span>${phone}</span></div>`;
            if(website) contactHtml += `<div class="profile-modal-info-item" style="grid-column: span 2;"><label>Site web</label><span><a href="${website}" target="_blank">${website}</a></span></div>`;
        }
        contactEl.innerHTML = contactHtml || '<p style="color: var(--text-sec);">Pas de contact public</p>';
        
        // Dates de tournage pr√©vues
        const shootingSection = document.getElementById('pm-shooting-section');
        const shootingEl = document.getElementById('pm-shooting-dates');
        const shootingDates = fullProfile.shootingDates || [];
        
        // Filtrer les dates futures uniquement
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const futureDates = shootingDates.filter(sd => new Date(sd.date) >= today).sort((a, b) => new Date(a.date) - new Date(b.date));
        
        if(futureDates.length > 0) {
            shootingSection.style.display = 'block';
            let shootingHtml = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            futureDates.slice(0, 5).forEach(sd => {
                const dateObj = new Date(sd.date);
                const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
                shootingHtml += `<div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; border-radius: 6px;">
                    <span style="font-size: 1.2rem;">üé¨</span>
                    <div style="flex: 1;">
                        <div style="font-weight: bold;">${dateStr}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">${Utils.escape(sd.projectName || 'Projet')}${sd.location ? ' - ' + Utils.escape(sd.location) : ''}</div>
                    </div>
                    ${sd.callTime ? `<div style="font-size: 0.85rem;">‚è∞ ${sd.callTime}</div>` : ''}
                </div>`;
            });
            if(futureDates.length > 5) {
                shootingHtml += `<div style="text-align: center; color: var(--text-sec); font-size: 0.85rem;">+ ${futureDates.length - 5} autre(s) date(s)...</div>`;
            }
            shootingHtml += '</div>';
            shootingEl.innerHTML = shootingHtml;
        } else {
            shootingSection.style.display = 'none';
            shootingEl.innerHTML = '';
        }
        
        // Bande D√©mo (v√©rifier visibilit√©)
        const demoreelSection = document.getElementById('pm-demoreel-section');
        const demoreelEl = document.getElementById('pm-demoreel');
        const demoreelSectionKey = fullProfile.type === 'crew' ? 'crew-demoreel' : 'demoreel';
        if(fullProfile.demoreel && Universe.isSectionVisible(fullProfile, demoreelSectionKey, 'public')) {
            demoreelSection.style.display = 'block';
            const embedUrl = ProfileRenderer.getEmbedUrl(fullProfile.demoreel);
            demoreelEl.innerHTML = `<iframe src="${embedUrl}" width="100%" height="250" frameborder="0" allowfullscreen style="border-radius:8px;"></iframe>`;
        } else {
            demoreelSection.style.display = 'none';
            demoreelEl.innerHTML = '';
        }
        
        document.getElementById('profile-modal-overlay').style.display = 'flex';
        Universe.updateFavoriteButton();
    },
    
    // Ferme le modal
    closeProfileModal: () => {
        document.getElementById('profile-modal-overlay').style.display = 'none';
        Universe.currentProfile = null;
    },
    
    // Export PDF du profil
    exportProfilePDF: () => {
        const profile = Universe.currentProfile;
        if(!profile) return;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let y = 20;
        const leftMargin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        
        // Titre
        doc.setFontSize(22);
        doc.setFont('helvetica', 'bold');
        doc.text(profile.name || 'Sans nom', pageWidth / 2, y, { align: 'center' });
        y += 10;
        
        // M√©tier
        doc.setFontSize(14);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(100);
        const role = profile.role || (profile.type === 'actor' ? 'Com√©dien.ne' : 'Technicien.ne');
        doc.text(role, pageWidth / 2, y, { align: 'center' });
        y += 8;
        
        // Ville
        if(profile.city) {
            doc.setFontSize(11);
            doc.text('üìç ' + profile.city, pageWidth / 2, y, { align: 'center' });
        }
        y += 15;
        
        // Ligne de s√©paration
        doc.setDrawColor(200);
        doc.line(leftMargin, y, pageWidth - leftMargin, y);
        y += 15;
        
        // Reset couleur
        doc.setTextColor(0);
        
        // Bio
        if(profile.bio) {
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('BIO', leftMargin, y);
            y += 8;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const bioLines = doc.splitTextToSize(profile.bio, pageWidth - 40);
            doc.text(bioLines, leftMargin, y);
            y += bioLines.length * 5 + 10;
        }
        
        // Informations
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('INFORMATIONS', leftMargin, y);
        y += 8;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        
        if(profile.type === 'actor') {
            if(profile.height) { doc.text('Taille : ' + profile.height + ' cm', leftMargin, y); y += 6; }
            if(profile.age) { doc.text('√Çge : ' + profile.age + ' ans', leftMargin, y); y += 6; }
            if(profile.eyeColor) { doc.text('Yeux : ' + profile.eyeColor, leftMargin, y); y += 6; }
            if(profile.hairColor) { doc.text('Cheveux : ' + profile.hairColor, leftMargin, y); y += 6; }
            if(profile.languages) { doc.text('Langues : ' + profile.languages, leftMargin, y); y += 6; }
            if(profile.sports) { doc.text('Sports : ' + profile.sports, leftMargin, y); y += 6; }
        } else {
            if(profile.department) {
                const deptName = CONFIG.crewGroups.find(g => g.id === profile.department)?.name || profile.department;
                doc.text('D√©partement : ' + deptName, leftMargin, y); y += 6;
            }
            if(profile.dailyRate) { doc.text('Tarif journalier : ' + profile.dailyRate + ' ' + (profile.rateCurrency || '‚Ç¨'), leftMargin, y); y += 6; }
            if(profile.equipment && profile.equipment.length > 0) {
                doc.text('Mat√©riel : ' + profile.equipment.join(', '), leftMargin, y); y += 6;
            }
        }
        
        if(profile.availabilityText) { doc.text('Disponibilit√© : ' + profile.availabilityText, leftMargin, y); y += 6; }
        
        // V√©hicule
        if(profile.hasVehicle) {
            y += 4;
            doc.text('üöó V√©hicule : ' + (profile.vehicleType || 'Oui'), leftMargin, y); y += 6;
        }
        
        y += 10;
        
        // Contact
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('CONTACT', leftMargin, y);
        y += 8;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        
        if(profile.email) { doc.text('Email : ' + profile.email, leftMargin, y); y += 6; }
        if(profile.phone) { doc.text('T√©l√©phone : ' + profile.phone, leftMargin, y); y += 6; }
        if(profile.website) { doc.text('Site web : ' + profile.website, leftMargin, y); y += 6; }
        
        // Footer
        y = doc.internal.pageSize.getHeight() - 15;
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text('Genere depuis Moteur - ' + new Date().toLocaleDateString('fr-FR'), pageWidth / 2, y, { align: 'center' });
        
        // T√©l√©charger
        const fileName = (profile.name || 'profil').replace(/[^a-zA-Z0-9]/g, '_') + '_CV.pdf';
        doc.save(fileName);
        
        Utils.toast('PDF t√©l√©charg√© !', 'success');
    },
    
    // Favoris (utilise maintenant state.contacts via Contacts.loadAndRender)
    
    isFavorite: (profileId, profileType) => {
        if(!state.contacts) return false;
        const typeMap = {
            actor: 'actors',
            crew: 'crew',
            project: 'projects',
            association: 'associations',
            enterprise: 'enterprises'
        };
        const contactType = typeMap[profileType] || 'actors';
        if(!state.contacts[contactType]) return false;
        return state.contacts[contactType].some(c => c.id === profileId);
    },
    
    toggleFavorite: async () => {
        const profile = Universe.currentProfile;
        if(!profile || !state.currentUser) return;
        
        const btn = document.getElementById('pm-favorite-btn');
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        // D√©terminer le type de contact
        const typeMap = {
            actor: 'actors',
            crew: 'crew',
            project: 'projects',
            association: 'associations',
            enterprise: 'enterprises'
        };
        const contactType = typeMap[profile.type] || 'actors';
        
        // S'assurer que state.contacts existe
        if(!state.contacts) state.contacts = { actors: [], crew: [], projects: [], associations: [], enterprises: [] };
        if(!state.contacts[contactType]) state.contacts[contactType] = [];
        
        // V√©rifier si d√©j√† en favoris
        const existingIndex = state.contacts[contactType].findIndex(c => c.id === profile.id);
        
        if(existingIndex >= 0) {
            // Retirer des favoris
            state.contacts[contactType].splice(existingIndex, 1);
            await firebase.database().ref(`user_contacts/${emailKey}/${contactType}/${profile.id}`).remove();
            btn.textContent = '‚òÜ';
            btn.classList.remove('active');
            Utils.toast('Retir√© des favoris', 'info');
        } else {
            // Ajouter aux favoris
            const contactData = {
                ...profile,
                id: profile.id,
                savedAt: new Date().toISOString()
            };
            state.contacts[contactType].push(contactData);
            await firebase.database().ref(`user_contacts/${emailKey}/${contactType}/${profile.id}`).set(contactData);
            btn.textContent = '‚òÖ';
            btn.classList.add('active');
            Utils.toast('Ajout√© aux favoris !', 'success');
        }
    },
    
    updateFavoriteButton: () => {
        const profile = Universe.currentProfile;
        const btn = document.getElementById('pm-favorite-btn');
        if(!profile || !btn) return;
        
        if(Universe.isFavorite(profile.id, profile.type)) {
            btn.textContent = '‚òÖ';
            btn.classList.add('active');
        } else {
            btn.textContent = '‚òÜ';
            btn.classList.remove('active');
        }
    },
    
    
    
    // Contacter un profil
    contactProfile: () => {
        if(!Universe.currentProfile) return;
        
        const profile = Universe.currentProfile;
        const profileName = profile.name || profile.assoName || profile.entName || 'ce profil';
        
        // Cr√©er le modal de contact
        const modal = document.createElement('div');
        modal.id = 'contact-profile-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 10002;';
        
        modal.innerHTML = `
            <div style="background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 500px; padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">üìß Contacter ${Utils.escape(profileName)}</h3>
                    <button onclick="document.getElementById('contact-profile-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec);">‚úñ</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Objet</label>
                    <input type="text" id="contact-subject" placeholder="Sujet du message" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Message</label>
                    <textarea id="contact-message" placeholder="Votre message..." rows="5" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="document.getElementById('contact-profile-modal').remove()" style="padding: 10px 20px; background: var(--border); color: var(--text-main); border: none; border-radius: 6px; cursor: pointer;">Annuler</button>
                    <button onclick="app.Universe.sendContactMessage()" style="padding: 10px 20px; background: #e94560; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üìß Envoyer</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.getElementById('contact-subject').focus();
    },
    
    // Envoyer le message de contact
    sendContactMessage: async () => {
        const profile = Universe.currentProfile;
        if(!profile) return;
        
        const subject = document.getElementById('contact-subject').value.trim();
        const message = document.getElementById('contact-message').value.trim();
        
        if(!subject || !message) {
            Utils.toast('Veuillez remplir l\'objet et le message.', 'warning');
            return;
        }
        
        try {
            // Envoyer le message au profil destinataire
            await Messages.send(profile.email || profile.ownerId?.replace(/,/g, '.'), {
                type: 'info',
                title: subject,
                content: message
            }, profile.id); // profile.id = profileId du destinataire
            
            Utils.toast('Message envoy√© !', 'success');
            document.getElementById('contact-profile-modal').remove();
        } catch(e) {
            console.error('Erreur envoi message:', e);
            Utils.toast('Erreur lors de l\'envoi du message.', 'error');
        }
    },
    
    // Ajouter √† un projet
    addToProject: async () => {
        if(!Universe.currentProfile) return;
        
        // Charger mes projets o√π je suis owner
        const myEmailKey = Utils.sanitizeEmail(state.currentUser.email);
        const projectsSnap = await firebase.database().ref('user_projects/' + myEmailKey).once('value');
        const projects = projectsSnap.val() || {};
        
        const myProjects = [];
        for(const pid of Object.keys(projects)) {
            if(projects[pid] === 'owner') {
                const metaSnap = await firebase.database().ref('all_projects/' + pid + '/meta').once('value');
                const meta = metaSnap.val();
                if(meta) myProjects.push({ id: pid, title: meta.title });
            }
        }
        
        if(myProjects.length === 0) {
            Utils.toast('Vous n\'avez pas encore de projet. Cr√©ez-en un d\'abord !', 'warning');
            return;
        }
        
        // Afficher la liste des projets
        const listEl = document.getElementById('select-project-list');
        listEl.innerHTML = '';
        
        myProjects.forEach(p => {
            const btn = document.createElement('button');
            btn.style.cssText = 'width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; text-align: left; font-size: 0.95rem;';
            btn.innerHTML = `üìÅ ${Utils.escape(p.title)}`;
            btn.onmouseover = () => btn.style.borderColor = 'var(--primary)';
            btn.onmouseout = () => btn.style.borderColor = 'var(--border)';
            btn.onclick = () => Universe.sendProjectRequest(p);
            listEl.appendChild(btn);
        });
        
        document.getElementById('select-project-modal').style.display = 'flex';
    },
    
    // Envoyer une demande de participation
    sendProjectRequest: async (project) => {
        const profile = Universe.currentProfile;
        if(!profile) return;
        
        try {
            // Envoyer un message interne au profil destinataire
            await Messages.send(profile.email, {
                type: 'invitation',
                title: `Demande de collaboration sur "${project.title}"`,
                content: `${state.userProfile?.displayName || state.currentUser.email.split('@')[0]} souhaite vous ajouter au projet "${project.title}".\n\nSi vous acceptez, vous pourrez collaborer sur ce projet dans Moteur.`,
                projectId: project.id,
                projectTitle: project.title
            }, profile.id); // profile.id = profileId du destinataire
            
            // Ping email
            await Messages.sendEmailPing(profile.email, profile.name, 'invitation', {
                senderName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
                projectTitle: project.title,
                role: 'collaborateur'
            });
            
            document.getElementById('select-project-modal').style.display = 'none';
            Universe.closeProfileModal();
            
            Utils.toast(`Demande envoy√©e √† ${profile.name} !`, 'success');
            
        } catch(e) {
            console.error('Erreur envoi demande:', e);
            Utils.toast('Erreur lors de l\'envoi de la demande', 'error');
        }
    },
    
    // Afficher la vue projets
    showProjects: () => {
        document.getElementById('universe-view').style.display = 'none';
        document.getElementById('projects-view').style.display = 'block';
        UI.renderProjectList();
    },
    
    // Afficher l'univers
    showUniverse: () => {
        document.getElementById('projects-view').style.display = 'none';
        document.getElementById('universe-view').style.display = 'flex';
        Universe.render();
        // Forcer Leaflet √† recalculer la taille de la carte
        setTimeout(() => {
            if(Universe.map) {
                Universe.map.invalidateSize();
            }
        }, 100);
    },
    
    // Utilitaire : m√©langer un tableau
    shuffleArray: (array) => {
        const arr = [...array];
        for(let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }
};

// --- MODULE MESSAGES V85 ---
const Messages = {
    currentMessageId: null,
    messages: [],
    allMessages: [],
    filteredMessages: [],
    
    // Initialise les filtres de profils
    initFilters: () => {
        const select = document.getElementById('messages-filter-profile');
        if(!select) return;
        
        select.innerHTML = '<option value="">üì¨ Tous les profils</option>';
        
        const profiles = PublicProfile.profiles || [];
        profiles.forEach(profile => {
            const opt = document.createElement('option');
            opt.value = profile.id;
            const icon = profile.type === 'actor' ? 'üé≠' : 
                        profile.type === 'crew' ? 'üé•' : 
                        profile.type === 'association' ? 'üèõÔ∏è' : 
                        profile.type === 'enterprise' ? 'üè¢' : 'üë§';
            const name = profile.name || profile.assoName || profile.entName || 'Profil';
            opt.textContent = `${icon} ${name}`;
            select.appendChild(opt);
        });
    },
    
    // Applique les filtres
    applyFilters: () => {
        const profileFilter = document.getElementById('messages-filter-profile')?.value || '';
        const typeFilter = document.getElementById('messages-filter-type')?.value || '';
        const statusFilter = document.getElementById('messages-filter-status')?.value || '';
        
        // ID du premier profil (pour les messages sans profileId)
        const firstProfileId = (PublicProfile.profiles && PublicProfile.profiles.length > 0) 
            ? PublicProfile.profiles[0].id 
            : null;
        
        Messages.filteredMessages = Messages.allMessages.filter(msg => {
            // Filtre par profil - les messages sans profileId sont attribu√©s au premier profil
            if(profileFilter) {
                const msgProfileId = msg.profileId || firstProfileId;
                if(msgProfileId !== profileFilter) return false;
            }
            // Filtre par type
            if(typeFilter && msg.type !== typeFilter) return false;
            // Filtre par statut
            if(statusFilter === 'unread' && msg.read) return false;
            if(statusFilter === 'read' && !msg.read) return false;
            return true;
        });
        
        Messages.render();
    },
    
    // Trouve le nom du profil par son ID
    getProfileName: (profileId) => {
        const profiles = PublicProfile.profiles || [];
        
        // Si pas de profileId, retourner le premier profil ou un d√©faut
        if(!profileId) {
            if(profiles.length > 0) {
                const profile = profiles[0];
                const icon = profile.type === 'actor' ? 'üé≠' : 
                            profile.type === 'crew' ? 'üé•' : 
                            profile.type === 'association' ? 'üèõÔ∏è' : 
                            profile.type === 'enterprise' ? 'üè¢' : 'üë§';
                const name = profile.name || profile.assoName || profile.entName || 'Mon profil';
                return { icon, name, photo: profile.photo };
            }
            return { icon: 'üë§', name: 'Mon compte', photo: null };
        }
        
        const profile = profiles.find(p => p.id === profileId);
        if(!profile) return { icon: 'üë§', name: 'Profil inconnu', photo: null };
        
        const icon = profile.type === 'actor' ? 'üé≠' : 
                    profile.type === 'crew' ? 'üé•' : 
                    profile.type === 'association' ? 'üèõÔ∏è' : 
                    profile.type === 'enterprise' ? 'üè¢' : 'üë§';
        const name = profile.name || profile.assoName || profile.entName || 'Profil';
        return { icon, name, photo: profile.photo };
    },
    
    // Charge les messages de l'utilisateur
    load: async () => {
        if(!state.currentUser) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        Messages.initFilters();
        
        try {
            const snap = await firebase.database().ref('user_messages/' + emailKey).once('value');
            const data = snap.val();
            
            Messages.allMessages = [];
            
            if(data) {
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    if(item.createdAt) {
                        Messages.allMessages.push({ id: key, ...item });
                    }
                });
                
                // Trier par date d√©croissante
                Messages.allMessages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }
            
            Messages.filteredMessages = [...Messages.allMessages];
            Messages.updateBadge();
            Messages.render();
        } catch(e) {
            console.error('Erreur chargement messages:', e);
        }
    },
    
    // Met √† jour le badge de notification
    updateBadge: () => {
        const totalUnread = Messages.allMessages.filter(m => !m.read).length;
        
        const badge = document.getElementById('messages-badge');
        if(badge) {
            if(totalUnread > 0) {
                badge.textContent = totalUnread;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
    },
    
    // Affiche la liste des messages
    render: () => {
        const container = document.getElementById('messages-list');
        if(!container) return;
        
        if(Messages.filteredMessages.length === 0) {
            container.innerHTML = '<div class="message-empty">üì≠ Aucun message.</div>';
            return;
        }
        
        let html = '';
        Messages.filteredMessages.forEach(msg => {
            const date = new Date(msg.createdAt).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            const typeLabel = msg.type === 'invitation' ? 'üé¨ Invitation' : (msg.type === 'convocation' ? 'üìÖ Convocation' : '‚ÑπÔ∏è Information');
            const preview = msg.content ? msg.content.substring(0, 100) + (msg.content.length > 100 ? '...' : '') : '';
            
            // Info du profil destinataire
            const profileInfo = Messages.getProfileName(msg.profileId);
            const defaultAvatar = `<div style="width: 20px; height: 20px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; font-size: 10px;">${profileInfo.icon}</div>`;
            const profileBadge = `<div style="display: inline-flex; align-items: center; gap: 6px; background: var(--bg); padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; border: 1px solid var(--border);">
                    ${profileInfo.photo ? `<img src="${profileInfo.photo}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover;">` : defaultAvatar}
                    <span style="color: var(--text-main); font-weight: 500;">${Utils.escape(profileInfo.name)}</span>
                   </div>`;
            
            html += `
                <div class="message-card ${msg.read ? '' : 'unread'}" onclick="app.Messages.openDetail('${msg.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                        <span class="message-card-type ${msg.type}">${typeLabel}</span>
                        ${profileBadge}
                    </div>
                    <div class="message-card-header">
                        <div class="message-card-title">${Utils.escape(msg.title)}</div>
                        <div class="message-card-date">${date}</div>
                    </div>
                    <div class="message-card-from">De : ${Utils.escape(msg.fromName || msg.fromUser)}</div>
                    ${msg.projectTitle ? `<div style="font-size:0.8rem; color:var(--text-sec); margin-bottom:5px;">üìÅ ${Utils.escape(msg.projectTitle)}</div>` : ''}
                    <div class="message-card-preview">${Utils.escape(preview)}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    // Ouvre le d√©tail d'un message
    openDetail: async (messageId) => {
        const msg = Messages.allMessages.find(m => m.id === messageId);
        if(!msg) return;
        
        Messages.currentMessageId = messageId;
        
        // Marquer comme lu
        if(!msg.read) {
            msg.read = true;
            // Mettre √† jour aussi dans filteredMessages
            const filteredMsg = Messages.filteredMessages.find(m => m.id === messageId);
            if(filteredMsg) filteredMsg.read = true;
            
            const emailKey = Utils.sanitizeEmail(state.currentUser.email);
            await firebase.database().ref('user_messages/' + emailKey + '/' + messageId + '/read').set(true);
            Messages.updateBadge();
            Messages.render();
        }
        
        // Afficher le modal
        const date = new Date(msg.createdAt).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        document.getElementById('message-detail-title').textContent = msg.title;
        document.getElementById('message-detail-meta').innerHTML = `
            <div><strong>De :</strong> ${Utils.escape(msg.fromName || msg.fromUser)}</div>
            <div><strong>Date :</strong> ${date}</div>
            ${msg.projectTitle ? `<div><strong>Projet :</strong> ${Utils.escape(msg.projectTitle)}</div>` : ''}
        `;
        document.getElementById('message-detail-content').textContent = msg.content;
        
        // Afficher les actions selon le type de message
        const quickActions = document.getElementById('message-detail-quick-actions');
        if(msg.type === 'claim') {
            quickActions.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <button onclick="app.PublicProfile.open(); app.Messages.closeDetail();" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ‚ú® Voir / Revendiquer mon profil
                    </button>
                    <button onclick="app.Messages.proposeExistingProfile('${msg.fromUser}', '${msg.projectId || ''}', '${Utils.escape(msg.projectTitle || '')}', '${msg.claimId || ''}')" style="background: var(--warning); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        üì§ J'ai d√©j√† un profil (autre email)
                    </button>
                    <button onclick="app.Messages.replyTo('${msg.fromUser}')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        üí¨ Contacter ${Utils.escape(msg.fromName || 'l\'exp√©diteur')}
                    </button>
                    <button onclick="app.Messages.quickReply('${msg.fromUser}', 'info')" style="background: var(--border); color: var(--text-main); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        ‚ùì Demande d'information
                    </button>
                </div>
            `;
            quickActions.style.display = 'block';
        } else if(msg.type === 'invitation') {
            quickActions.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    ${msg.projectId ? `<button onclick="app.Store.loadProject('${msg.projectId}'); app.Messages.closeDetail();" style="background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ‚úÖ Ouvrir le projet
                    </button>` : ''}
                    <button onclick="app.Messages.replyTo('${msg.fromUser}')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        üí¨ Contacter ${Utils.escape(msg.fromName || 'l\'exp√©diteur')}
                    </button>
                    <button onclick="app.Messages.quickReply('${msg.fromUser}', 'accept')" style="background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        üëç Accepter
                    </button>
                    <button onclick="app.Messages.quickReply('${msg.fromUser}', 'decline')" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        üëé D√©cliner
                    </button>
                    <button onclick="app.Messages.quickReply('${msg.fromUser}', 'info')" style="background: var(--border); color: var(--text-main); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        ‚ùì Demande d'information
                    </button>
                </div>
            `;
            quickActions.style.display = 'block';
        } else if(msg.type === 'profile_proposal' && msg.proposedProfile) {
            const profile = msg.proposedProfile;
            const photoHtml = profile.photo 
                ? `<img src="${profile.photo}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;">` 
                : `<div style="width:60px;height:60px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:white;">${(profile.name || '?')[0].toUpperCase()}</div>`;
            const typeIcon = profile.type === 'actor' ? 'üé≠' : profile.type === 'crew' ? 'üé•' : 'üìÅ';
            
            quickActions.innerHTML = `
                <div style="background:var(--bg);border-radius:10px;padding:15px;margin-bottom:15px;">
                    <div style="display:flex;align-items:center;gap:15px;">
                        ${photoHtml}
                        <div>
                            <div style="font-weight:bold;font-size:1.1rem;color:var(--text-main);">${typeIcon} ${Utils.escape(profile.name)}</div>
                            <div style="color:var(--text-sec);">${Utils.escape(profile.city || '')} ${profile.role ? '‚Ä¢ ' + Utils.escape(profile.role) : ''}</div>
                            <div style="color:var(--primary);font-size:0.9rem;">${Utils.escape(profile.email)}</div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <button onclick="app.Messages.acceptProfileProposal('${msg.id}')" style="background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        ‚úÖ Accepter ce profil
                    </button>
                    <button onclick="app.Messages.replyTo('${msg.fromUser}')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        üí¨ Contacter ${Utils.escape(msg.fromName || 'l\'exp√©diteur')}
                    </button>
                    <button onclick="app.Messages.declineProfileProposal('${msg.fromUser}')" style="background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        ‚ùå Refuser
                    </button>
                </div>
            `;
            quickActions.style.display = 'block';
        } else {
            quickActions.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <button onclick="app.Messages.replyTo('${msg.fromUser}')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                        üí¨ R√©pondre
                    </button>
                </div>
            `;
            quickActions.style.display = 'block';
        }
        
        document.getElementById('message-detail-modal').style.display = 'flex';
    },
    
    // Ferme le d√©tail
    closeDetail: () => {
        document.getElementById('message-detail-modal').style.display = 'none';
        Messages.currentMessageId = null;
    },
    
    // R√©pondre √† un message
    replyTo: (toEmail) => {
        Messages.closeDetail();
        // Ouvrir le modal de nouveau message avec destinataire pr√©-rempli
        const modal = document.createElement('div');
        modal.id = 'reply-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:10002;';
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; max-width:500px; width:90%;">
                <h3 style="margin-bottom:15px;">üí¨ R√©pondre √† ${Utils.escape(toEmail)}</h3>
                <textarea id="reply-message-content" placeholder="Votre message..." style="width:100%; height:150px; padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text-main); resize:vertical; margin-bottom:15px;"></textarea>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="document.getElementById('reply-modal').remove();" style="background:var(--border); color:var(--text-main); border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Annuler</button>
                    <button onclick="app.Messages.sendReply('${toEmail}')" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">üì§ Envoyer</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('reply-message-content').focus();
    },
    
    // Envoyer la r√©ponse
    sendReply: async (toEmail) => {
        const content = document.getElementById('reply-message-content').value.trim();
        if(!content) {
            Utils.toast('Veuillez √©crire un message', 'warning');
            return;
        }
        
        await Messages.send(toEmail, {
            title: 'R√©ponse de ' + (state.userProfile?.displayName || state.currentUser.email.split('@')[0]),
            content: content,
            type: 'message'
        });
        
        document.getElementById('reply-modal').remove();
        Utils.toast('Message envoy√© !', 'success');
    },
    
    // R√©ponse rapide pr√©-d√©finie
    quickReply: async (toEmail, replyType) => {
        let title = '';
        let content = '';
        
        switch(replyType) {
            case 'accept':
                title = '‚úÖ Invitation accept√©e';
                content = 'Bonjour,\n\nJe vous confirme ma participation au projet. Merci pour cette invitation !\n\nCordialement';
                break;
            case 'decline':
                title = '‚ùå Invitation d√©clin√©e';
                content = 'Bonjour,\n\nMalheureusement, je ne pourrai pas participer √† ce projet. Merci quand m√™me pour cette proposition.\n\nCordialement';
                break;
            case 'info':
                title = '‚ùì Demande d\'information';
                content = 'Bonjour,\n\nAvant de donner ma r√©ponse, pourriez-vous me donner plus d\'informations sur :\n- Les dates de tournage\n- Le lieu\n- Les conditions\n\nMerci d\'avance !';
                break;
            default:
                return;
        }
        
        // Ouvrir le modal de r√©ponse avec le contenu pr√©-rempli
        Messages.closeDetail();
        const modal = document.createElement('div');
        modal.id = 'reply-modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:10002;';
        modal.innerHTML = `
            <div style="background:var(--panel-bg); border-radius:12px; padding:25px; max-width:500px; width:90%;">
                <h3 style="margin-bottom:15px;">${title}</h3>
                <textarea id="reply-message-content" style="width:100%; height:150px; padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--bg); color:var(--text-main); resize:vertical; margin-bottom:15px;">${content}</textarea>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="document.getElementById('reply-modal').remove();" style="background:var(--border); color:var(--text-main); border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Annuler</button>
                    <button onclick="app.Messages.sendQuickReply('${toEmail}', '${title}')" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">üì§ Envoyer</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    },
    
    // Envoyer la r√©ponse rapide
    sendQuickReply: async (toEmail, title) => {
        const content = document.getElementById('reply-message-content').value.trim();
        if(!content) {
            Utils.toast('Veuillez √©crire un message', 'warning');
            return;
        }
        
        await Messages.send(toEmail, {
            title: title,
            content: content,
            type: 'message'
        });
        
        document.getElementById('reply-modal').remove();
        Utils.toast('Message envoy√© !', 'success');
    },
    
    // Proposer un profil existant au porteur de projet
    proposeExistingProfile: async (toEmail, projectId, projectTitle, claimId) => {
        Messages.closeDetail();
        
        // Charger les profils de l'utilisateur
        if(!PublicProfile.profiles || PublicProfile.profiles.length === 0) {
            await PublicProfile.loadProfiles();
        }
        
        if(PublicProfile.profiles.length === 0) {
            Utils.toast('Vous n\'avez pas encore de profil. Cr√©ez-en un d\'abord !', 'warning');
            PublicProfile.open();
            return;
        }
        
        // Cr√©er le modal de s√©lection de profil
        const modal = document.createElement('div');
        modal.id = 'propose-profile-modal';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:10002;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        let profilesHtml = '';
        PublicProfile.profiles.forEach((profile, idx) => {
            if(!profile.type) return; // Ignorer les profils incomplets
            
            const icon = profile.type === 'actor' ? 'üé≠' : profile.type === 'crew' ? 'üé•' : profile.type === 'association' ? 'üèõÔ∏è' : 'üè¢';
            const name = profile.name || profile.assoName || profile.entName || 'Sans nom';
            const photoHtml = profile.photo 
                ? `<img src="${profile.photo}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">` 
                : `<div style="width:50px;height:50px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:white;">${name[0].toUpperCase()}</div>`;
            
            profilesHtml += `
                <div onclick="app.Messages.sendProfileProposal('${toEmail}', '${projectId}', '${projectTitle}', '${claimId}', ${idx})" style="display:flex;align-items:center;gap:15px;padding:15px;background:var(--bg);border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                    ${photoHtml}
                    <div style="flex:1;">
                        <div style="font-weight:bold;color:var(--text-main);">${icon} ${Utils.escape(name)}</div>
                        <div style="font-size:0.85rem;color:var(--text-sec);">${Utils.escape(profile.city || '')} ${profile.role ? '‚Ä¢ ' + Utils.escape(profile.role) : ''}</div>
                        <div style="font-size:0.8rem;color:var(--primary);">${profile.email || state.currentUser.email}</div>
                    </div>
                </div>
            `;
        });
        
        modal.innerHTML = `
            <div style="background:var(--panel-bg);border-radius:12px;padding:25px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
                <h3 style="margin:0 0 10px;color:var(--text-main);">üì§ Proposer mon profil existant</h3>
                <p style="color:var(--text-sec);margin-bottom:20px;">S√©lectionnez le profil √† envoyer au porteur de projet :</p>
                
                <div style="display:flex;flex-direction:column;gap:10px;">
                    ${profilesHtml || '<p style="color:var(--text-sec);text-align:center;">Aucun profil disponible</p>'}
                </div>
                
                <div style="margin-top:20px;text-align:center;">
                    <button onclick="document.getElementById('propose-profile-modal').remove()" style="padding:10px 25px;background:var(--border);color:var(--text-main);border:none;border-radius:8px;cursor:pointer;">Annuler</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Envoyer la proposition de profil au porteur
    sendProfileProposal: async (toEmail, projectId, projectTitle, claimId, profileIdx) => {
        const profile = PublicProfile.profiles[profileIdx];
        if(!profile) return;
        
        document.getElementById('propose-profile-modal')?.remove();
        
        const myName = profile.name || profile.assoName || profile.entName || state.currentUser.email.split('@')[0];
        const typeLabel = profile.type === 'actor' ? 'com√©dien' : profile.type === 'crew' ? 'technicien' : profile.type;
        
        try {
            await Messages.send(toEmail, {
                type: 'profile_proposal',
                title: `üì§ ${myName} vous propose son profil ${typeLabel} existant`,
                content: `Bonjour,\n\nVous m'avez ajout√© au projet "${projectTitle}" mais j'ai d√©j√† un profil ${typeLabel} sur Moteur avec une autre adresse email.\n\nJe vous propose d'utiliser mon profil existant pour que mes informations soient √† jour.\n\nCordialement,\n${myName}`,
                projectId: projectId,
                projectTitle: projectTitle,
                claimId: claimId,
                proposedProfile: {
                    id: profile.id,
                    type: profile.type,
                    name: myName,
                    email: profile.email || state.currentUser.email,
                    photo: profile.photo || '',
                    city: profile.city || '',
                    role: profile.role || '',
                    department: profile.department || ''
                }
            });
            
            Utils.toast('Votre profil a √©t√© propos√© au porteur de projet !', 'success');
        } catch(e) {
            console.error('Erreur envoi proposition:', e);
            Utils.toast('Erreur lors de l\'envoi', 'error');
        }
    },
    
    // Accepter une proposition de profil
    acceptProfileProposal: async (messageId) => {
        const msg = Messages.allMessages.find(m => m.id === messageId);
        if(!msg || !msg.proposedProfile || !msg.projectId) {
            Utils.toast('Donn√©es de proposition incompl√®tes', 'error');
            return;
        }
        
        const profile = msg.proposedProfile;
        
        try {
            // Charger le projet
            const projectSnap = await firebase.database().ref('all_projects/' + msg.projectId + '/data').once('value');
            const projectData = projectSnap.val();
            
            if(!projectData) {
                Utils.toast('Projet introuvable', 'error');
                return;
            }
            
            // Trouver et mettre √† jour le membre correspondant
            const dataArray = profile.type === 'actor' ? projectData.actors : projectData.crew;
            const dbPath = profile.type === 'actor' ? 'public_actors' : 'public_crew';
            
            if(dataArray && Array.isArray(dataArray)) {
                // Chercher par claimId ou par ancien email
                let memberIdx = -1;
                
                // D'abord essayer de trouver via le pending claim
                if(msg.claimId) {
                    memberIdx = dataArray.findIndex(m => m.id && msg.claimId.includes(m.id.replace('act_', '').replace('crew_', '')));
                }
                
                // Sinon chercher par email de l'exp√©diteur
                if(memberIdx === -1) {
                    memberIdx = dataArray.findIndex(m => m.email && m.email.toLowerCase() === msg.fromUser.toLowerCase());
                }
                
                if(memberIdx !== -1) {
                    // Charger les donn√©es compl√®tes du profil public
                    const publicSnap = await firebase.database().ref(dbPath + '/' + profile.id).once('value');
                    const publicData = publicSnap.val();
                    
                    if(publicData) {
                        // Mettre √† jour avec les donn√©es du profil public
                        dataArray[memberIdx] = {
                            ...dataArray[memberIdx],
                            ...publicData,
                            id: dataArray[memberIdx].id, // Garder l'ID local
                            publicProfileId: profile.id,
                            email: profile.email
                        };
                        
                        // Sauvegarder dans Firebase
                        const updatePath = profile.type === 'actor' ? 'actors' : 'crew';
                        await firebase.database().ref('all_projects/' + msg.projectId + '/data/' + updatePath).set(dataArray);
                        
                        // Supprimer le pending claim si existant
                        if(msg.claimId) {
                            const claimEmailKey = Utils.sanitizeEmail(msg.fromUser);
                            await firebase.database().ref(`pending_profile_claims/${claimEmailKey}/${msg.claimId}`).remove();
                        }
                        
                        // Notifier la personne
                        await Messages.send(msg.fromUser, {
                            type: 'info',
                            title: '‚úÖ Votre profil a √©t√© accept√© !',
                            content: `Bonne nouvelle ! Votre profil existant a √©t√© li√© au projet "${msg.projectTitle}".\n\nVos informations sont maintenant synchronis√©es.`,
                            projectId: msg.projectId,
                            projectTitle: msg.projectTitle
                        });
                        
                        Messages.closeDetail();
                        Utils.toast('Profil accept√© et li√© au projet !', 'success');
                        
                        // Recharger le projet si on est dessus
                        if(state.currentProjectId === msg.projectId) {
                            Store.loadProject(msg.projectId);
                        }
                        
                        return;
                    }
                }
            }
            
            Utils.toast('Impossible de trouver le membre dans le projet', 'error');
        } catch(e) {
            console.error('Erreur acceptation profil:', e);
            Utils.toast('Erreur lors de l\'acceptation', 'error');
        }
    },
    
    // Refuser une proposition de profil
    declineProfileProposal: async (fromEmail) => {
        if(!await ConfirmModal.show({ title: 'Refuser cette proposition ?', message: 'La proposition de profil sera refus√©e.', icon: '‚ùå', confirmText: 'Refuser', dangerous: true })) return;
        
        await Messages.send(fromEmail, {
            type: 'info',
            title: '‚ùå Proposition de profil d√©clin√©e',
            content: 'Le porteur de projet a d√©clin√© votre proposition de profil. Il souhaite peut-√™tre que vous cr√©iez un nouveau profil sp√©cifique pour ce projet.\n\nN\'h√©sitez pas √† le contacter pour plus d\'informations.'
        });
        
        Messages.closeDetail();
        Utils.toast('Proposition refus√©e', 'info');
    },
    
    // Supprime un message
    deleteMessage: async () => {
        if(!Messages.currentMessageId) return;
        if(!await ConfirmModal.confirmDelete("Ce message sera supprim√©.")) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        await firebase.database().ref('user_messages/' + emailKey + '/' + Messages.currentMessageId).remove();
        
        Messages.messages = Messages.messages.filter(m => m.id !== Messages.currentMessageId);
        Messages.closeDetail();
        Messages.updateBadge();
        Messages.render();
    },
    
    // Envoie un message √† un utilisateur
    send: async (toEmail, message, toProfileId = null) => {
        const emailKey = Utils.sanitizeEmail(toEmail.toLowerCase());
        const messageId = Utils.generateUniqueId();
        
        // Trouver le profil de l'exp√©diteur actuel
        const fromProfileId = Messages.currentProfileId || (PublicProfile.profiles[0]?.id) || null;
        
        const messageData = {
            ...message,
            fromUser: state.currentUser.email,
            fromName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            fromProfileId: fromProfileId,
            profileId: toProfileId, // Profil destinataire
            createdAt: new Date().toISOString(),
            read: false
        };
        
        await firebase.database().ref('user_messages/' + emailKey + '/' + messageId).set(messageData);
        
        // Envoyer une notification pour la cloche
        try {
            await Notifications.send(
                toEmail,
                'message',
                `üí¨ ${messageData.fromName} vous a envoy√© un message : "${message.subject || 'Nouveau message'}"`,
                message.projectId || null
            );
        } catch(e) {
            console.warn('Erreur notification message:', e);
        }
        
        return messageId;
    },
    
    // Envoie une notification par email (ping simple)
    // Nettoie une string pour EmailJS (supprime caract√®res probl√©matiques)
    sanitizeForEmail: (str) => {
        if(str === null || str === undefined) return '';
        return String(str)
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Supprime accents
            .replace(/[\n\r\t]/g, ' ')
            .replace(/[""''¬´¬ª]/g, "'")
            .replace(/[√†√¢√§]/g, 'a').replace(/[√©√®√™√´]/g, 'e').replace(/[√Ø√Æ]/g, 'i')
            .replace(/[√¥√∂]/g, 'o').replace(/[√π√ª√º]/g, 'u').replace(/[√ß]/g, 'c')
            .replace(/[√Ä√Ç√Ñ√Å]/g, 'A').replace(/[√â√à√ä√ã]/g, 'E').replace(/[√è√é]/g, 'I')
            .replace(/[√î√ñ]/g, 'O').replace(/[√ô√õ√ú√ö]/g, 'U').replace(/[√á]/g, 'C')
            .replace(/[^\x20-\x7E]/g, '') // Garde uniquement ASCII imprimable
            .replace(/\s+/g, ' ')
            .trim()
            .substring(0, 500) || 'N/A';
    },
    
    // Templates d'email selon le type
    emailTemplates: {
        'claim': (data) => ({
            title: 'Profil cree pour vous',
            message: `${data.senderName} a cree un profil ${data.typeLabel} a votre nom pour le projet "${data.projectTitle}". Connectez-vous a Moteur pour revendiquer ce profil, le completer et apparaitre dans l'Univers !`
        }),
        'invitation': (data) => ({
            title: 'Invitation projet',
            message: `${data.senderName} vous invite a rejoindre le projet "${data.projectTitle}" en tant que ${data.role}. Connectez-vous a Moteur pour acceder au projet.`
        }),
        'contact': (data) => ({
            title: 'Nouveau message',
            message: `${data.senderName} vous a contacte. Connectez-vous a Moteur pour lire le message et repondre.`
        }),
        'project_contact': (data) => ({
            title: 'Message pour votre projet',
            message: `${data.senderName} vous a contacte concernant votre projet "${data.projectTitle}". Sujet: ${data.subject}. Connectez-vous a Moteur pour lire le message.`
        }),
        'reply': (data) => ({
            title: 'Reponse recue',
            message: `${data.senderName} vous a repondu. Connectez-vous a Moteur pour lire la reponse.`
        }),
        'callsheet': (data) => ({
            title: 'Convocation tournage',
            message: `Vous etes convoque pour le tournage de "${data.projectName}" le ${data.shootDate}. Lieu: ${data.location}. Heure de convocation: ${data.callTime}. Voir et imprimer votre feuille de service: ${data.publicLink || 'https://moteur.film'}`
        }),
        'default': (data) => ({
            title: 'Notification',
            message: data.customMessage || 'Vous avez recu une notification sur Moteur. Connectez-vous pour en savoir plus.'
        })
    },
    
    sendEmailPing: async (toEmail, toName, emailType = 'default', data = {}) => {
        if(!CONFIG.emailJS.publicKey || CONFIG.emailJS.publicKey === 'VOTRE_PUBLIC_KEY') {
            console.warn('EmailJS non configur√© - ping email ignor√©');
            return;
        }
        
        const sanitize = Messages.sanitizeForEmail;
        const safeToEmail = sanitize(toEmail);
        const safeToName = sanitize(toName) || safeToEmail.split('@')[0] || 'Utilisateur';
        
        if(!safeToEmail) {
            console.warn('Email invalide - ping ignor√©');
            return;
        }
        
        // R√©cup√©rer le template appropri√©
        const templateFn = Messages.emailTemplates[emailType] || Messages.emailTemplates['default'];
        const template = templateFn({
            senderName: sanitize(data.senderName) || 'Un utilisateur',
            projectTitle: sanitize(data.projectTitle) || 'Projet',
            typeLabel: sanitize(data.typeLabel) || 'membre',
            role: sanitize(data.role) || 'collaborateur',
            subject: sanitize(data.subject) || 'Sans sujet',
            customMessage: sanitize(data.customMessage) || ''
        });
        
        try {
            const emailData = {
                to_email: safeToEmail,
                name: safeToName,
                email: safeToEmail,
                project_title: sanitize(template.title) || 'Moteur',
                role: 'Notification',
                inviter_name: sanitize(data.senderName) || 'Moteur',
                message: sanitize(template.message),
                app_url: 'https://moteur.film'
            };
            // console.log('EmailJS Data:', emailData);
            await emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, emailData, CONFIG.emailJS.publicKey);
        } catch(e) {
            console.error('Erreur ping email:', e);
        }
    }
};

// --- MODULE INVITATIONS V84 ---
const Invitations = {
    // V√©rifie si l'email existe d√©j√† dans Firebase
    checkEmail: async (email) => {
        const statusEl = document.getElementById('share-email-status');
        const messageSection = document.getElementById('share-message-section');
        
        if(!email || !email.includes('@')) {
            statusEl.style.display = 'none';
            messageSection.style.display = 'none';
            return;
        }
        
        const emailKey = Utils.sanitizeEmail(email);
        
        try {
            const profileSnap = await firebase.database().ref('user_profiles/' + emailKey).once('value');
            
            if(profileSnap.exists()) {
                statusEl.innerHTML = '‚úÖ <strong>Utilisateur existant</strong> - Il aura acc√®s imm√©diatement';
                statusEl.style.background = 'rgba(40,167,69,0.1)';
                statusEl.style.color = 'var(--success)';
                statusEl.style.display = 'block';
                messageSection.style.display = 'none';
            } else {
                statusEl.innerHTML = 'üìß <strong>Nouvel utilisateur</strong> - Une invitation sera envoy√©e par email';
                statusEl.style.background = 'rgba(43,110,246,0.1)';
                statusEl.style.color = 'var(--primary)';
                statusEl.style.display = 'block';
                messageSection.style.display = 'block';
            }
        } catch(e) {
            statusEl.style.display = 'none';
            messageSection.style.display = 'block';
        }
    },
    
    // Envoie l'invitation
    sendInvitation: async () => {
        const email = document.getElementById('share-email').value.trim().toLowerCase();
        const role = document.getElementById('share-role').value;
        const message = document.getElementById('share-message')?.value?.trim() || '';
        
        if(!email || !email.includes('@')) {
            Utils.toast('Veuillez entrer un email valide.', 'warning');
            return;
        }
        
        if(!state.currentProjectId) return;
        
        const btn = document.getElementById('share-confirm-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Envoi...';
        btn.classList.add('btn-loading');
        
        const emailKey = Utils.sanitizeEmail(email);
        const pid = state.currentProjectId;
        const projectTitle = state.data.title || 'Sans titre';
        const inviterEmail = state.currentUser.email;
        const inviterName = state.currentUser.email.split('@')[0];
        
        try {
            // V√©rifier si l'utilisateur existe
            const profileSnap = await firebase.database().ref('user_profiles/' + emailKey).once('value');
            const userExists = profileSnap.exists();
            
            // Ajouter aux ACL et index dans tous les cas
            const updates = {};
            updates['all_projects/' + pid + '/acl/' + emailKey] = role;
            updates['user_projects/' + emailKey + '/' + pid] = role;
            
            if(!userExists) {
                // Cr√©er une invitation en attente
                updates['pending_invitations/' + emailKey + '/' + pid] = {
                    projectId: pid,
                    projectTitle: projectTitle,
                    role: role,
                    invitedBy: inviterEmail,
                    invitedAt: new Date().toISOString(),
                    message: message
                };
            }
            
            await firebase.database().ref().update(updates);
            
            // Envoyer un message interne
            const roleLabel = role === 'editor' ? '√âditeur' : 'Lecteur';
            await Messages.send(email, {
                type: 'invitation',
                title: `Invitation au projet "${projectTitle}"`,
                content: `${inviterName} vous invite √† rejoindre le projet "${projectTitle}" en tant que ${roleLabel}.\n\n${message ? 'Message : ' + message : ''}\n\nVous trouverez ce projet dans votre liste de projets.`,
                projectId: pid,
                projectTitle: projectTitle
            });
            
            // Envoyer un ping email
            if(!userExists) {
                await Invitations.sendEmail(email, projectTitle, role, inviterName, message);
            } else {
                await Messages.sendEmailPing(email, email.split('@')[0], 'invitation', {
                    senderName: inviterName,
                    projectTitle: projectTitle,
                    role: roleLabel
                });
            }
            
            Utils.toast(userExists 
                ? `${email} a maintenant acc√®s au projet !` 
                : `Invitation envoy√©e √† ${email} !`, 'success');
            
            document.getElementById('share-modal').style.display = 'none';
            document.getElementById('share-email').value = '';
            document.getElementById('share-message').value = '';
            document.getElementById('share-email-status').style.display = 'none';
            document.getElementById('share-message-section').style.display = 'none';
            
        } catch(e) {
            Utils.toast('Erreur: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'üìß Inviter';
            btn.classList.remove('btn-loading');
        }
    },
    
    // Envoie l'email via EmailJS
    sendEmail: async (toEmail, projectTitle, role, inviterName, message) => {
        // V√©rifier si EmailJS est configur√©
        if(!CONFIG.emailJS.publicKey || CONFIG.emailJS.publicKey === 'VOTRE_PUBLIC_KEY') {
            console.warn('EmailJS non configur√© - email non envoy√©');
            Invitations.openMailto(toEmail, projectTitle, role, inviterName, message);
            return;
        }
        
        // S'assurer que toutes les variables sont des strings valides
        const safeToEmail = String(toEmail || '').trim();
        const safeProjectTitle = String(projectTitle || 'Projet').trim();
        const safeRole = role === 'editor' ? 'Editeur' : 'Lecteur';
        const safeInviterName = String(inviterName || 'Un utilisateur').trim();
        const safeMessage = String(message || 'Vous √™tes invit√© √† collaborer sur ce projet.').trim();
        const safeAppUrl = String(window.location.origin + window.location.pathname || 'https://moteur.film').trim();
        
        if(!safeToEmail) {
            console.warn('Email invalide - envoi ignor√©');
            return;
        }
        
        try {
            const sanitize = Messages.sanitizeForEmail;
            await emailjs.send(CONFIG.emailJS.serviceId, CONFIG.emailJS.templateId, {
                to_email: sanitize(safeToEmail),
                name: sanitize(safeToEmail.split('@')[0]) || 'Utilisateur',
                email: sanitize(safeToEmail),
                project_title: sanitize(safeProjectTitle) || 'Projet',
                role: sanitize(safeRole) || 'Invite',
                inviter_name: sanitize(safeInviterName) || 'Un utilisateur',
                message: sanitize(safeMessage) || 'Vous etes invite a collaborer.',
                app_url: sanitize(safeAppUrl) || 'https://moteur.film'
            }, CONFIG.emailJS.publicKey);
            
        } catch(e) {
            console.error('Erreur EmailJS:', e);
            // Fallback mailto si EmailJS √©choue
            Invitations.openMailto(toEmail, projectTitle, role, inviterName, message);
        }
    },
    
    // Ouvre le client mail en fallback
    openMailto: (toEmail, projectTitle, role, inviterName, message) => {
        const roleLabel = role === 'editor' ? '√âditeur' : 'Lecteur';
        const subject = encodeURIComponent(`Invitation √† collaborer sur "${projectTitle}" - Moteur`);
        const body = encodeURIComponent(
`Bonjour,

${inviterName} vous invite √† collaborer sur le projet "${projectTitle}" en tant que ${roleLabel}.

${message ? 'Message: ' + message + '\n\n' : ''}Pour acceder au projet, creez votre compte gratuit sur Moteur :
${window.location.origin}${window.location.pathname}

√Ä bient√¥t !`
        );
        window.open(`mailto:${toEmail}?subject=${subject}&body=${body}`, '_blank');
    },

    // V√©rifie les invitations en attente √† la connexion
    checkPendingInvitations: async () => {
        if(!state.currentUser) return;
        
        const emailKey = Utils.sanitizeEmail(state.currentUser.email);
        
        try {
            const snap = await firebase.database().ref('pending_invitations/' + emailKey).once('value');
            const invitations = snap.val();
            
            if(invitations && Object.keys(invitations).length > 0) {
                const count = Object.keys(invitations).length;
                const projects = Object.values(invitations).map(inv => inv.projectTitle).join(', ');
                
                // Notifier l'utilisateur
                setTimeout(() => {
                    Utils.toast(`üéâ ${count} invitation(s) en attente : ${projects}`, 'success', 6000);
                }, 500);
                
                // Supprimer les invitations trait√©es
                await firebase.database().ref('pending_invitations/' + emailKey).remove();
            }
        } catch(e) {
            console.error('Erreur v√©rification invitations:', e);
        }
    }
};

  setTimeout(Auth.init, 50);

  // ===== D√âTECTION FEUILLE DE SERVICE PUBLIQUE =====
  (function checkPublicCallSheet() {
      const urlParams = new URLSearchParams(window.location.search);
      const callsheetToken = urlParams.get('callsheet');
      if(callsheetToken) {
          // Attendre que Firebase soit initialis√©
          setTimeout(() => {
              Planning.loadPublicCallSheet(callsheetToken);
          }, 500);
      }
  })();

  // ===== RACCOURCIS CLAVIER =====
  document.addEventListener('keydown', (e) => {
      // √âchap - Fermer les modales
      if(e.key === 'Escape') {
          // Quitter mode pr√©sentation en priorit√©
          if(PresentMode.isActive) {
              PresentMode.exit();
              return;
          }
          // Fermer modal profil
          const profileModal = document.getElementById('profile-modal-overlay');
          if(profileModal && profileModal.style.display !== 'none') {
              Universe.closeProfileModal();
              return;
          }
          // Fermer modal s√©lection projet
          const selectProjectModal = document.getElementById('select-project-modal');
          if(selectProjectModal && selectProjectModal.style.display !== 'none') {
              selectProjectModal.style.display = 'none';
              return;
          }
          // Fermer modal partage
          const shareModal = document.getElementById('share-modal');
          if(shareModal && shareModal.style.display !== 'none') {
              shareModal.style.display = 'none';
              return;
          }
          // Fermer modal export
          const exportModal = document.getElementById('export-modal');
          if(exportModal && exportModal.style.display !== 'none') {
              exportModal.style.display = 'none';
              return;
          }
          // Fermer modal tag
          const tagModal = document.getElementById('tag-modal');
          if(tagModal && tagModal.style.display !== 'none') {
              tagModal.style.display = 'none';
              return;
          }
          // Fermer menu couleur onglet
          const tabColorMenu = document.getElementById('tab-color-menu');
          if(tabColorMenu && tabColorMenu.classList.contains('visible')) {
              UI.closeTabColorMenu();
              return;
          }
          // Fermer sidebar mobile
          const mobileSidebar = document.querySelector('.board-sidebar.mobile-open');
          if(mobileSidebar) {
              UI.closeMobileSidebar();
              return;
          }
      }
      
      // Ctrl+S - Sauvegarder
      if(e.ctrlKey && e.key === 's') {
          e.preventDefault();
          if(state.currentProjectId && els.appView.style.display !== 'none') {
              Store.save();
              Utils.toast('Projet sauvegard√© !', 'success');
          } else if(document.getElementById('public-profile-view')?.classList.contains('active')) {
              PublicProfile.saveCurrentProfile();
          }
          return;
      }
      
      // Ignorer Shift seul en Vue Script (√©viter perte de focus)
      if(e.key === 'Shift') {
          const continuousContainer = document.getElementById('scriptContinuousContainer');
          if(continuousContainer && continuousContainer.style.display !== 'none') {
              e.preventDefault();
              e.stopPropagation();
              return;
          }
      }
      
      // Ctrl+fl√®ches - Navigation onglets (seulement dans l'app)
      if(e.ctrlKey && els.appView.style.display !== 'none') {
          const tabs = Array.from(document.querySelectorAll('.tab-btn'));
          const activeIndex = tabs.findIndex(t => t.classList.contains('active'));
          
          if(e.key === 'ArrowRight' && activeIndex < tabs.length - 1) {
              e.preventDefault();
              tabs[activeIndex + 1].click();
          } else if(e.key === 'ArrowLeft' && activeIndex > 0) {
              e.preventDefault();
              tabs[activeIndex - 1].click();
          }
      }
  });

  const StoryboardPreview = {
    currentSceneId: null,
    
    open: (sceneId) => {
        StoryboardPreview.currentSceneId = sceneId;
        const scene = state.data.scenes.find(s => s.id === sceneId);
        document.getElementById('storyboard-preview-title').textContent = scene ? `Storyboard - ${scene.title}` : 'Storyboard';
        StoryboardPreview.load();
        document.getElementById('storyboard-preview-panel').classList.add('open');
    },
    
    close: () => {
        document.getElementById('storyboard-preview-panel').classList.remove('open');
        StoryboardPreview.currentSceneId = null;
    },
    
    load: () => {
        const container = document.getElementById('storyboard-preview-list');
        const sceneId = StoryboardPreview.currentSceneId;
        const scene = state.data.scenes.find(s => s.id === sceneId);
        const sceneIndex = state.data.scenes.indexOf(scene) + 1;
        const shots = state.data.shots ? state.data.shots.filter(s => s.sceneId === sceneId).sort((a, b) => a.order - b.order) : [];
        
        if(shots.length === 0) {
            container.innerHTML = '<div class="storyboard-preview-empty">Aucun plan pour cette sc√®ne<br><br><button onclick="app.UI.goToStoryboard(\'' + sceneId + '\'); app.StoryboardPreview.close();" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer;">+ Cr√©er des plans</button></div>';
            return;
        }
        
        container.innerHTML = '';
        const grid = document.createElement('div');
        grid.className = 'sb-print-grid';
        
        shots.forEach((shot, idx) => {
            const card = Storyboard.createPrintShot(shot, sceneIndex, idx + 1);
            card.onclick = () => {
                app.UI.goToStoryboard(sceneId);
                app.StoryboardPreview.close();
            };
            grid.appendChild(card);
        });
        
        container.appendChild(grid);
    }
};

const Comments = {
    currentSceneId: null,
    
    open: (sceneId) => {
        Comments.currentSceneId = sceneId;
        const scene = state.data.scenes.find(s => s.id === sceneId);
        const sceneIndex = state.data.scenes.findIndex(s => s.id === sceneId) + 1;
        document.getElementById('comments-scene-title').innerText = `Sc√®ne ${sceneIndex} - ${scene?.title || ''}`;
        document.getElementById('comments-panel').classList.add('open');
        document.getElementById('comment-input').value = '';
        Comments.load();
    },
    
    close: () => {
        document.getElementById('comments-panel').classList.remove('open');
        Comments.currentSceneId = null;
    },
    
    load: async () => {
        if(!Comments.currentSceneId || !state.currentProjectId) return;
        
        const listEl = document.getElementById('comments-list');
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sec);">Chargement...</div>';
        
        try {
            const snap = await firebase.database().ref(`all_projects/${state.currentProjectId}/comments/${Comments.currentSceneId}`).once('value');
            const comments = snap.val() || {};
            
            const sortedComments = Object.entries(comments)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => b.date - a.date);
            
            if(sortedComments.length === 0) {
                listEl.innerHTML = '<div class="no-comments">Aucun commentaire pour cette sc√®ne.<br>Soyez le premier √† commenter !</div>';
                return;
            }
            
            listEl.innerHTML = sortedComments.map(c => Comments.renderComment(c)).join('');
        } catch(e) {
            console.error('Erreur chargement commentaires:', e);
            listEl.innerHTML = '<div class="no-comments">Erreur de chargement</div>';
        }
    },
    
    renderComment: (comment) => {
        const date = new Date(comment.date).toLocaleString();
        const isOwn = state.currentUser?.email === comment.author;
        const canResolve = state.currentRole === 'owner' || state.currentRole === 'editor';
        const canDelete = isOwn || state.currentRole === 'owner';
        
        const replies = comment.replies ? Object.entries(comment.replies)
            .map(([id, r]) => ({ id, ...r }))
            .sort((a, b) => a.date - b.date)
            .map(r => `
                <div class="comment-item" style="margin-top: 8px; padding: 8px;">
                    <div class="comment-author">
                        <span class="comment-author-name">${Utils.escape(r.authorName || r.author)}</span>
                        <span class="comment-date">${new Date(r.date).toLocaleString()}</span>
                    </div>
                    <div class="comment-text">${Utils.escape(r.text)}</div>
                </div>
            `).join('') : '';
        
        return `
            <div class="comment-item ${comment.resolved ? 'resolved' : ''}" data-id="${comment.id}">
                <div class="comment-author">
                    <span class="comment-author-name">${Utils.escape(comment.authorName || comment.author)}</span>
                    <span class="comment-date">${date} ${comment.resolved ? '‚úÖ R√©solu' : ''}</span>
                </div>
                <div class="comment-text">${Utils.escape(comment.text)}</div>
                <div class="comment-actions">
                    <button class="comment-action-btn" onclick="app.Comments.toggleReply('${comment.id}')">‚Ü©Ô∏è R√©pondre</button>
                    ${canResolve && !comment.resolved ? `<button class="comment-action-btn" onclick="app.Comments.resolve('${comment.id}')">‚úÖ R√©soudre</button>` : ''}
                    ${canDelete ? `<button class="comment-action-btn" onclick="app.Comments.delete('${comment.id}')" style="color: var(--danger);">üóëÔ∏è Supprimer</button>` : ''}
                </div>
                <div class="comment-reply-input" id="reply-${comment.id}">
                    <textarea class="comment-input" rows="2" placeholder="Votre r√©ponse..." id="reply-text-${comment.id}"></textarea>
                    <button class="comment-submit" style="margin-top:5px; padding:8px;" onclick="app.Comments.addReply('${comment.id}')">R√©pondre</button>
                </div>
                ${replies ? `<div class="comment-replies">${replies}</div>` : ''}
            </div>
        `;
    },
    
    add: async () => {
        const text = document.getElementById('comment-input').value.trim();
        if(!text || !Comments.currentSceneId || !state.currentProjectId) return;
        
        const comment = {
            author: state.currentUser.email,
            authorName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            date: Date.now(),
            text: text,
            resolved: false
        };
        
        try {
            await firebase.database().ref(`all_projects/${state.currentProjectId}/comments/${Comments.currentSceneId}`).push(comment);
            document.getElementById('comment-input').value = '';
            Comments.load();
            Comments.updateBadge(Comments.currentSceneId);
            Utils.toast('Commentaire ajout√©', 'success');
        } catch(e) {
            console.error('Erreur ajout commentaire:', e);
            Utils.toast('Erreur lors de l\'ajout', 'error');
        }
    },
    
    toggleReply: (commentId) => {
        const replyDiv = document.getElementById(`reply-${commentId}`);
        replyDiv.classList.toggle('active');
    },
    
    addReply: async (commentId) => {
        const text = document.getElementById(`reply-text-${commentId}`).value.trim();
        if(!text) return;
        
        const reply = {
            author: state.currentUser.email,
            authorName: state.userProfile?.displayName || state.currentUser.email.split('@')[0],
            date: Date.now(),
            text: text
        };
        
        try {
            await firebase.database().ref(`all_projects/${state.currentProjectId}/comments/${Comments.currentSceneId}/${commentId}/replies`).push(reply);
            Comments.load();
            Utils.toast('R√©ponse ajout√©e', 'success');
        } catch(e) {
            Utils.toast('Erreur lors de l\'ajout', 'error');
        }
    },
    
    resolve: async (commentId) => {
        try {
            await firebase.database().ref(`all_projects/${state.currentProjectId}/comments/${Comments.currentSceneId}/${commentId}/resolved`).set(true);
            Comments.load();
            Comments.updateBadge(Comments.currentSceneId);
            Utils.toast('Commentaire marqu√© comme r√©solu', 'success');
        } catch(e) {
            Utils.toast('Erreur', 'error');
        }
    },
    
    delete: async (commentId) => {
        if(!await ConfirmModal.confirmDelete("Ce commentaire sera supprim√©.")) return;
        
        try {
            await firebase.database().ref(`all_projects/${state.currentProjectId}/comments/${Comments.currentSceneId}/${commentId}`).remove();
            Comments.load();
            Comments.updateBadge(Comments.currentSceneId);
            Utils.toast('Commentaire supprim√©', 'success');
        } catch(e) {
            Utils.toast('Erreur', 'error');
        }
    },
    
    getCount: async (sceneId) => {
        if(!state.currentProjectId) return { total: 0, unresolved: 0 };
        
        try {
            const snap = await firebase.database().ref(`all_projects/${state.currentProjectId}/comments/${sceneId}`).once('value');
            const comments = snap.val() || {};
            const list = Object.values(comments);
            return {
                total: list.length,
                unresolved: list.filter(c => !c.resolved).length
            };
        } catch(e) {
            return { total: 0, unresolved: 0 };
        }
    },
    
    updateBadge: async (sceneId) => {
        const count = await Comments.getCount(sceneId);
        const badge = document.querySelector(`.comment-badge[data-scene="${sceneId}"]`);
        if(badge) {
            if(count.total === 0) {
                badge.style.display = 'none';
            } else {
                badge.style.display = 'inline-flex';
                badge.innerText = count.unresolved || '‚úì';
                badge.classList.toggle('resolved', count.unresolved === 0);
            }
        }
    },
    
    updateAllBadges: async () => {
        for(const scene of state.data.scenes) {
            await Comments.updateBadge(scene.id);
        }
    }
};

// ==================== MODULE HELP ====================
const Courses = {
    currentTab: 'scenario',
    
    open: () => {
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'none';
        document.getElementById('contacts-view').classList.remove('active');
        document.getElementById('public-profile-view').classList.remove('active');
        document.getElementById('courses-view').classList.add('active');
        Courses.render();
    },
    
    close: () => {
        document.getElementById('courses-view').classList.remove('active');
        document.getElementById('dashboard-view').style.display = 'flex';
    },
    
    switchTab: (tabName) => {
        Courses.currentTab = tabName;
        document.querySelectorAll('.courses-tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.courses-tab[onclick*="${tabName}"]`).classList.add('active');
        Courses.render();
    },
    
    render: () => {
        const content = document.getElementById('courses-content');
        const courses = Courses.getCourses();
        content.innerHTML = courses[Courses.currentTab] || '<p>Contenu √† venir...</p>';
        Courses.initNotions();
    },
    
    // Syst√®me d'infobulles pour les notions
    initNotions: () => {
        document.querySelectorAll('.notion').forEach(el => {
            el.addEventListener('mouseenter', Courses.showNotion);
            el.addEventListener('mouseleave', Courses.scheduleHideNotion);
        });
    },
    
    scheduleHideNotion: () => {
        // D√©lai pour permettre √† la souris d'aller sur le tooltip
        Courses.hideTimeout = setTimeout(() => {
            const tooltip = document.querySelector('.notion-tooltip');
            if (tooltip && !tooltip.matches(':hover')) {
                tooltip.remove();
            }
        }, 100);
    },
    
    showNotion: (e) => {
        const key = e.target.getAttribute('data-notion');
        const notion = Courses.notions[key];
        if (!notion) return;
        
        // Supprimer tooltip existant
        const existing = document.querySelector('.notion-tooltip');
        if (existing) existing.remove();
        
        // Cr√©er tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'notion-tooltip';
        tooltip.innerHTML = `
            <div class="notion-tooltip-title">${notion.title}</div>
            <div class="notion-tooltip-content">
                ${notion.description}
                ${notion.image ? `<div class="notion-tooltip-image">${notion.image}</div>` : ''}
                ${notion.example ? `<div class="notion-tooltip-example">üé¨ ${notion.example}</div>` : ''}
            </div>
        `;
        document.body.appendChild(tooltip);
        
        // Positionner - d'abord rendre visible pour calculer dimensions
        tooltip.style.visibility = 'hidden';
        tooltip.style.display = 'block';
        
        const rect = e.target.getBoundingClientRect();
        const tooltipWidth = tooltip.offsetWidth;
        const tooltipHeight = tooltip.offsetHeight;
        const margin = 15;
        
        let top = rect.bottom + 10;
        let left = rect.left;
        
        // Ajuster si d√©passe √† droite
        if (left + tooltipWidth > window.innerWidth - margin) {
            left = window.innerWidth - tooltipWidth - margin;
        }
        // Ajuster si d√©passe √† gauche
        if (left < margin) {
            left = margin;
        }
        // Ajuster si d√©passe en bas - mettre au-dessus
        if (top + tooltipHeight > window.innerHeight - margin) {
            top = rect.top - tooltipHeight - 10;
        }
        // Ajuster si d√©passe en haut (apr√®s avoir mis au-dessus)
        if (top < margin) {
            top = margin;
        }
        // Si vraiment trop grand, centrer verticalement
        if (tooltipHeight > window.innerHeight - 2 * margin) {
            top = margin;
            tooltip.style.maxHeight = (window.innerHeight - 2 * margin) + 'px';
            tooltip.style.overflowY = 'auto';
        }
        
        tooltip.style.top = top + 'px';
        tooltip.style.left = left + 'px';
        tooltip.style.visibility = 'visible';
        tooltip.classList.add('visible');
        
        // Garder le tooltip visible quand on le survole
        tooltip.addEventListener('mouseenter', () => {
            if (Courses.hideTimeout) {
                clearTimeout(Courses.hideTimeout);
            }
        });
        tooltip.addEventListener('mouseleave', () => {
            tooltip.remove();
        });
    },
    
    hideNotion: () => {
        const tooltip = document.querySelector('.notion-tooltip');
        if (tooltip) tooltip.remove();
    },
    
    hideTimeout: null,
    
    // Dictionnaire des notions avec descriptions d√©taill√©es
    notions: {
        // === VALEURS DE PLAN ===
        'plan-ensemble': {
            title: 'Plan d\'ensemble (PE)',
            description: `<p>Le plan d'ensemble est le plus large des plans cin√©matographiques. Il embrasse un vaste espace et situe l'action dans son environnement global.</p>
            <p>Ce plan √©tablit la <strong>g√©ographie</strong> d'une sc√®ne et donne au spectateur tous les rep√®res spatiaux n√©cessaires. Il r√©pond aux questions : O√π sommes-nous ? Quelle est l'atmosph√®re du lieu ?</p>
            <p>Souvent utilis√© en ouverture de s√©quence (establishing shot), il permet de "poser le d√©cor" avant de resserrer sur les personnages.</p>`,
            image: `<svg viewBox="0 0 320 200" style="border-radius:8px;">
                <defs>
                    <linearGradient id="sky1" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#1a1a3e"/>
                        <stop offset="100%" style="stop-color:#2d3a5a"/>
                    </linearGradient>
                    <linearGradient id="ground1" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#3d4a3a"/>
                        <stop offset="100%" style="stop-color:#2a332a"/>
                    </linearGradient>
                </defs>
                <rect width="320" height="200" fill="url(#sky1)"/>
                <rect y="140" width="320" height="60" fill="url(#ground1)"/>
                <polygon points="40,140 70,60 100,140" fill="#4a5568" opacity="0.6"/>
                <polygon points="90,140 130,40 170,140" fill="#5a6578" opacity="0.7"/>
                <polygon points="180,140 210,70 240,140" fill="#4a5568" opacity="0.6"/>
                <polygon points="240,140 280,50 320,140" fill="#5a6578" opacity="0.5"/>
                <circle cx="280" cy="40" r="20" fill="#f4d03f" opacity="0.9"/>
                <ellipse cx="160" cy="145" rx="3" ry="6" fill="#e2e8f0"/>
                <circle cx="160" cy="138" r="2" fill="#e2e8f0"/>
                <rect x="10" y="175" width="300" height="20" fill="rgba(0,0,0,0.5)" rx="3"/>
                <text x="160" y="189" text-anchor="middle" fill="#ccc" font-size="11" font-family="Arial">Le personnage est minuscule dans l'immensit√© du d√©cor</text>
            </svg>`,
            example: 'L\'ouverture de "Lawrence d\'Arabie" - le d√©sert immense √©crase le personnage.'
        },
        'plan-large': {
            title: 'Plan large / Plan de demi-ensemble (PL)',
            description: `<p>Le plan large montre les personnages en pied dans leur environnement, mais avec plus de proximit√© que le plan d'ensemble.</p>
            <p>Il permet de voir les <strong>interactions entre les personnages</strong> et leur espace, leurs d√©placements, leur gestuelle corporelle compl√®te.</p>
            <p>C'est le plan id√©al pour les sc√®nes de groupe, les chor√©graphies, ou pour montrer un personnage qui entre dans un lieu.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="0" y="130" width="300" height="50" fill="#2d3a4a"/>
                <rect x="30" y="50" width="60" height="80" fill="#4a5568"/>
                <ellipse cx="100" cy="90" rx="15" ry="40" fill="#e2e8f0"/>
                <circle cx="100" cy="55" r="12" fill="#e2e8f0"/>
                <ellipse cx="200" cy="90" rx="15" ry="40" fill="#e2e8f0"/>
                <circle cx="200" cy="55" r="12" fill="#e2e8f0"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">Personnages en pied + environnement</text>
            </svg>`,
            example: 'Les duels dans les westerns de Sergio Leone.'
        },
        'plan-moyen': {
            title: 'Plan moyen (PM)',
            description: `<p>Le plan moyen cadre le personnage √† mi-cuisse, parfois appel√© "plan italien" car tr√®s utilis√© dans le cin√©ma n√©or√©aliste italien.</p>
            <p>Il √©tablit un <strong>√©quilibre</strong> entre le personnage et son environnement. On voit suffisamment le corps pour percevoir la gestuelle, tout en gardant le contexte spatial.</p>
            <p>C'est un plan de transition, souvent utilis√© pour les dialogues √† plusieurs personnages ou les sc√®nes de mouvement mod√©r√©.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="0" y="160" width="300" height="20" fill="#2d3a4a"/>
                <rect x="90" y="30" width="120" height="150" fill="#2d3a4a" rx="5" opacity="0.3"/>
                <ellipse cx="150" cy="100" rx="35" ry="70" fill="#e2e8f0"/>
                <circle cx="150" cy="50" r="25" fill="#e2e8f0"/>
                <line x1="90" y1="130" x2="210" y2="130" stroke="#ff6b6b" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">Coupe √† mi-cuisse</text>
            </svg>`,
            example: 'Les sc√®nes de marche et discussion dans les films d\'Aaron Sorkin.'
        },
        'plan-americain': {
            title: 'Plan am√©ricain (PA)',
            description: `<p>Le plan am√©ricain cadre le personnage √† mi-cuisse, juste au-dessus des genoux. Son nom vient des westerns hollywoodiens o√π il permettait de voir le colt √† la ceinture.</p>
            <p>Ce plan offre une <strong>proximit√© accrue</strong> avec le personnage tout en conservant une partie de sa gestuelle corporelle. Id√©al pour les confrontations et les dialogues tendus.</p>
            <p>Il est l√©g√®rement plus serr√© que le plan moyen et cr√©e une pr√©sence plus affirm√©e du personnage dans le cadre.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="110" rx="45" ry="80" fill="#e2e8f0"/>
                <circle cx="150" cy="45" r="30" fill="#e2e8f0"/>
                <rect x="130" y="95" width="10" height="20" fill="#8b4513"/>
                <rect x="160" y="95" width="10" height="20" fill="#8b4513"/>
                <line x1="80" y1="150" x2="220" y2="150" stroke="#ff6b6b" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">Coupe au-dessus des genoux (holster visible)</text>
            </svg>`,
            example: 'Les face-√†-face dans "Le Bon, la Brute et le Truand".'
        },
        'plan-rapproche': {
            title: 'Plan rapproch√© (PR)',
            description: `<p>Le plan rapproch√© cadre le personnage √† la poitrine ou aux √©paules. On distingue parfois le "plan rapproch√© taille" et le "plan rapproch√© poitrine".</p>
            <p>Ce plan cr√©e une v√©ritable <strong>intimit√©</strong> avec le personnage. Les expressions du visage deviennent lisibles, les √©motions plus palpables.</p>
            <p>C'est le plan privil√©gi√© pour les dialogues intimes, les r√©v√©lations, les moments d'√©motion. Le spectateur entre dans la sph√®re personnelle du personnage.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="140" rx="70" ry="60" fill="#e2e8f0"/>
                <circle cx="150" cy="70" r="45" fill="#e2e8f0"/>
                <circle cx="135" cy="60" r="5" fill="#1a1a2e"/>
                <circle cx="165" cy="60" r="5" fill="#1a1a2e"/>
                <path d="M 135 80 Q 150 95 165 80" stroke="#1a1a2e" stroke-width="2" fill="none"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">Visage et expressions lisibles</text>
            </svg>`,
            example: 'Les conversations entre Rick et Ilsa dans "Casablanca".'
        },
        'gros-plan': {
            title: 'Gros plan (GP)',
            description: `<p>Le gros plan isole le visage du personnage ou un objet significatif, remplissant la majeure partie du cadre.</p>
            <p>C'est le plan de l'<strong>√©motion pure</strong>. Chaque micro-expression devient visible : un fr√©missement de paupi√®re, une larme naissante, un sourire esquiss√©.</p>
            <p>Le gros plan cr√©e une connexion √©motionnelle intense avec le spectateur. Il est souvent r√©serv√© aux moments cl√©s pour ne pas perdre son impact.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="100" rx="100" ry="85" fill="#e2e8f0"/>
                <ellipse cx="110" cy="80" rx="18" ry="12" fill="white"/>
                <circle cx="110" cy="80" r="8" fill="#4a5568"/>
                <circle cx="112" cy="78" r="3" fill="white"/>
                <ellipse cx="190" cy="80" rx="18" ry="12" fill="white"/>
                <circle cx="190" cy="80" r="8" fill="#4a5568"/>
                <circle cx="192" cy="78" r="3" fill="white"/>
                <ellipse cx="150" cy="105" rx="12" ry="8" fill="#d4a574"/>
                <path d="M 120 130 Q 150 150 180 130" stroke="#c97878" stroke-width="4" fill="none"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">√âmotion pure, connexion intense</text>
            </svg>`,
            example: 'Le regard final d\'Antoine Doinel dans "Les 400 Coups".'
        },
        'tres-gros-plan': {
            title: 'Tr√®s gros plan / Insert (TGP)',
            description: `<p>Le tr√®s gros plan isole un d√©tail : un ≈ìil, une bouche, une main, un objet. Il extrait un fragment de r√©alit√© pour lui donner une importance capitale.</p>
            <p>Ce plan cr√©e un effet de <strong>loupe dramatique</strong>. Il dirige imp√©rativement l'attention du spectateur vers ce d√©tail et lui conf√®re une signification narrative.</p>
            <p>L'insert sur un objet (lettre, arme, cl√©) est une variante narrative qui r√©v√®le une information cruciale.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="90" rx="120" ry="80" fill="white"/>
                <circle cx="150" cy="90" r="50" fill="#4a7c59"/>
                <circle cx="150" cy="90" r="25" fill="#1a1a2e"/>
                <circle cx="160" cy="80" r="10" fill="white" opacity="0.5"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">Un ≈ìil = une √¢me, un univers</text>
            </svg>`,
            example: 'L\'≈ìil en ouverture de "Blade Runner" ou la douille dans "Il faut sauver le soldat Ryan".'
        },
        // === ANGLES ===
        'plongee': {
            title: 'Plong√©e',
            description: `<p>La cam√©ra est plac√©e au-dessus du sujet et regarde vers le bas. Cet angle √©crase le personnage, le diminue visuellement.</p>
            <p>La plong√©e traduit souvent la <strong>vuln√©rabilit√©</strong>, la soumission, l'inf√©riorit√© ou l'√©crasement d'un personnage. Elle peut aussi repr√©senter le point de vue d'un personnage dominant.</p>
            <p>Plus l'angle est prononc√©, plus l'effet est dramatique. La plong√©e totale (90¬∞) est parfois appel√©e "vue de Dieu".</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="120" rx="60" ry="30" fill="#4a5568"/>
                <circle cx="150" cy="90" r="25" fill="#e2e8f0"/>
                <path d="M 150 30 L 130 60 L 170 60 Z" fill="#ff6b6b"/>
                <line x1="150" y1="60" x2="150" y2="90" stroke="#ff6b6b" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">Cam√©ra au-dessus ‚Üí personnage √©cras√©</text>
            </svg>`,
            example: 'Norman Bates vu d\'en haut apr√®s le meurtre dans "Psychose".'
        },
        'contre-plongee': {
            title: 'Contre-plong√©e',
            description: `<p>La cam√©ra est plac√©e en dessous du sujet et regarde vers le haut. Cet angle grandit le personnage, lui conf√®re puissance et autorit√©.</p>
            <p>La contre-plong√©e traduit la <strong>domination</strong>, la menace, l'h√©ro√Øsme ou la sup√©riorit√©. Elle peut cr√©er un sentiment d'intimidation chez le spectateur.</p>
            <p>C'est l'angle classique pour filmer les figures d'autorit√©, les monuments, ou les moments de triomphe.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="140" rx="80" ry="25" fill="#4a5568"/>
                <ellipse cx="150" cy="90" rx="50" ry="60" fill="#e2e8f0"/>
                <circle cx="150" cy="40" r="30" fill="#e2e8f0"/>
                <path d="M 150 180 L 130 150 L 170 150 Z" fill="#ff6b6b"/>
                <line x1="150" y1="150" x2="150" y2="120" stroke="#ff6b6b" stroke-width="2" stroke-dasharray="5,5"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">Cam√©ra en dessous ‚Üí personnage grandi</text>
            </svg>`,
            example: 'Dark Vador dans toutes ses apparitions dans "Star Wars".'
        },
        'dutch-angle': {
            title: 'Dutch Angle (Angle n√©erlandais)',
            description: `<p>La cam√©ra est inclin√©e sur son axe, cr√©ant un horizon pench√©. Le monde semble basculer, perdre son √©quilibre.</p>
            <p>Le dutch angle traduit le <strong>d√©s√©quilibre psychologique</strong>, la folie, le malaise, l'√©tranget√©. Il signale que quelque chose ne va pas.</p>
            <p>Son nom vient d'une d√©formation de "Deutsch" (allemand), car cette technique √©tait populaire dans l'expressionnisme allemand des ann√©es 1920.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <g transform="rotate(-15, 150, 90)">
                    <rect x="60" y="30" width="180" height="120" fill="none" stroke="#ff6b6b" stroke-width="2"/>
                    <ellipse cx="150" cy="90" rx="30" ry="50" fill="#e2e8f0"/>
                    <circle cx="150" cy="50" r="20" fill="#e2e8f0"/>
                </g>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="12">Horizon pench√© = malaise, folie</text>
            </svg>`,
            example: 'Omnipr√©sent dans "Le Troisi√®me Homme" et les films de Tim Burton.'
        },
        // === MOUVEMENTS ===
        'panoramique': {
            title: 'Panoramique',
            description: `<p>La cam√©ra pivote sur son axe (horizontal ou vertical) sans se d√©placer. Elle "balaie" l'espace comme une t√™te qui tourne.</p>
            <p>Le panoramique permet d'<strong>explorer un espace</strong>, de suivre un personnage en mouvement, ou de relier deux √©l√©ments dans le m√™me plan.</p>
            <p>On distingue le panoramique horizontal (gauche-droite), vertical (haut-bas), et le panoramique fil√© (tr√®s rapide, cr√©ant un flou).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="40" y="50" width="50" height="70" fill="#4a5a6a" rx="3"/>
                <rect x="210" y="40" width="60" height="80" fill="#4a5a6a" rx="3"/>
                <circle cx="150" cy="140" r="20" fill="#5a6a7a"/>
                <rect x="145" y="100" width="10" height="40" fill="#4a5a6a"/>
                <path d="M 65 85 Q 150 50 235 80" stroke="#ff6b6b" stroke-width="3" fill="none" marker-end="url(#arrowPano)"/>
                <defs><marker id="arrowPano" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <circle cx="150" cy="140" r="5" fill="#ff6b6b"/>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="11">Rotation sur pied fixe (pivot)</text>
            </svg>`,
            example: 'Les panoramiques contemplatifs sur les paysages dans les films de Terrence Malick.'
        },
        'travelling': {
            title: 'Travelling',
            description: `<p>La cam√©ra se d√©place physiquement dans l'espace, g√©n√©ralement sur des rails, un chariot, ou tout autre support mobile.</p>
            <p>Le travelling cr√©e une <strong>immersion dynamique</strong>. Il peut accompagner un personnage (travelling d'accompagnement), s'en approcher (travelling avant) ou s'en √©loigner (travelling arri√®re).</p>
            <p>Le travelling lat√©ral est particuli√®rement efficace pour les sc√®nes de dialogue en marche ou pour r√©v√©ler progressivement un d√©cor.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="130" width="260" height="10" fill="#5a6a7a" rx="2"/>
                <rect x="25" y="125" width="250" height="5" fill="#6a7a8a"/>
                <circle cx="70" cy="140" r="8" fill="#3a4a5a" stroke="#7a8a9a" stroke-width="2"/>
                <circle cx="130" cy="140" r="8" fill="#3a4a5a" stroke="#7a8a9a" stroke-width="2"/>
                <rect x="50" y="80" width="100" height="50" fill="#4a5a6a" rx="5"/>
                <polygon points="100,70 85,85 115,85" fill="#3a4a5a"/>
                <rect x="85" y="75" width="30" height="15" fill="#2a3a4a" rx="2"/>
                <path d="M 160 100 L 250 100" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowTrav)"/>
                <defs><marker id="arrowTrav" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <ellipse cx="230" cy="90" rx="18" ry="30" fill="#e2e8f0"/>
                <circle cx="230" cy="60" r="12" fill="#e2e8f0"/>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="11">D√©placement physique sur rails</text>
            </svg>`,
            example: 'Le travelling arri√®re infini dans "Les Affranchis" (sc√®ne du Copacabana).'
        },
        'steadicam': {
            title: 'Steadicam',
            description: `<p>Syst√®me de stabilisation port√© par l'op√©rateur, permettant des mouvements fluides et libres impossibles sur rails.</p>
            <p>Le Steadicam offre une <strong>fluidit√© onirique</strong> tout en permettant de suivre les acteurs dans des espaces complexes (escaliers, foules, couloirs).</p>
            <p>Invent√© par Garrett Brown en 1975, il a r√©volutionn√© le cin√©ma en permettant des plans-s√©quences mobiles d'une fluidit√© in√©dite.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="100" cy="140" rx="30" ry="35" fill="#d4a574"/>
                <circle cx="100" cy="95" r="20" fill="#e8d4c4"/>
                <rect x="120" y="100" width="8" height="55" fill="#5a6a7a"/>
                <rect x="110" y="90" width="28" height="18" fill="#4a5a6a" rx="2"/>
                <rect x="135" y="70" width="40" height="28" fill="#3a4a5a" rx="3"/>
                <polygon points="155,65 145,72 165,72" fill="#2a3a4a"/>
                <rect x="125" y="155" width="20" height="10" fill="#5a6a7a" rx="2"/>
                <circle cx="135" cy="170" r="5" fill="#4a5a6a"/>
                <path d="M 190 90 C 210 70 240 90 260 60" stroke="#ff6b6b" stroke-width="2" fill="none" stroke-dasharray="6,3"/>
                <path d="M 190 100 C 210 110 240 95 260 110" stroke="#ff6b6b" stroke-width="2" fill="none" stroke-dasharray="6,3"/>
                <text x="225" y="55" fill="#ff6b6b" font-size="9">Mouvement</text>
                <text x="225" y="125" fill="#ff6b6b" font-size="9">fluide</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="11">Harnais stabilisateur - libert√© totale</text>
            </svg>`,
            example: 'La poursuite dans les couloirs de l\'Overlook Hotel dans "Shining".'
        },
        'zoom': {
            title: 'Zoom',
            description: `<p>Changement de focale optique qui rapproche ou √©loigne le sujet sans d√©placer la cam√©ra. Contrairement au travelling, il modifie la perspective.</p>
            <p>Le zoom est souvent consid√©r√© comme moins "cin√©matographique" que le travelling car il <strong>aplatit l'image</strong>. Mais utilis√© intentionnellement, il peut cr√©er des effets puissants.</p>
            <p>Le zoom rapide √©tait caract√©ristique des ann√©es 70 (films de kung-fu, gialli italiens). Il conna√Æt un renouveau ironique ou stylistique.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="15" y="30" width="110" height="100" fill="#2a3a4a" rx="5" stroke="#4a5a6a" stroke-width="2"/>
                <ellipse cx="70" cy="85" rx="12" ry="20" fill="#e2e8f0"/>
                <circle cx="70" cy="65" r="8" fill="#e2e8f0"/>
                <rect x="30" y="110" width="80" height="8" fill="#3a4a5a"/>
                <text x="70" y="150" text-anchor="middle" fill="#6a8a6a" font-size="10">Plan large</text>
                <rect x="175" y="30" width="110" height="100" fill="#2a3a4a" rx="5" stroke="#4a5a6a" stroke-width="2"/>
                <ellipse cx="230" cy="90" rx="35" ry="45" fill="#e2e8f0"/>
                <circle cx="230" cy="55" r="25" fill="#e2e8f0"/>
                <circle cx="220" cy="50" r="4" fill="#1a1a2e"/>
                <circle cx="240" cy="50" r="4" fill="#1a1a2e"/>
                <path d="M 222 62 Q 230 70 238 62" stroke="#1a1a2e" stroke-width="2" fill="none"/>
                <text x="230" y="150" text-anchor="middle" fill="#8aaa6a" font-size="10">Plan serr√©</text>
                <path d="M 130 80 L 165 80" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowZoom)"/>
                <defs><marker id="arrowZoom" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <text x="147" y="70" fill="#ff6b6b" font-size="9">Zoom</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="11">Changement de focale - cam√©ra fixe</text>
            </svg>`,
            example: 'Les zooms brutaux de Quentin Tarantino en hommage aux films d\'exploitation.'
        },
        'vertigo-effect': {
            title: 'Effet Vertigo (Dolly Zoom)',
            description: `<p>Combinaison d'un travelling et d'un zoom en sens inverse. La cam√©ra avance pendant que l'objectif d√©zoome (ou l'inverse).</p>
            <p>Le sujet garde la m√™me taille mais le fond semble s'√©tirer ou se comprimer, cr√©ant un effet de <strong>vertige et de dissociation</strong>.</p>
            <p>Invent√© par Irmin Roberts pour "Vertigo" d'Hitchcock (1958), il traduit visuellement le malaise, la prise de conscience brutale, ou le choc √©motionnel.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="15" y="25" width="120" height="95" fill="#2a3a4a" rx="5" stroke="#4a5a6a" stroke-width="2"/>
                <rect x="35" y="40" width="80" height="65" fill="#3a4a5a" rx="3"/>
                <ellipse cx="75" cy="80" rx="15" ry="25" fill="#e2e8f0"/>
                <circle cx="75" cy="55" r="10" fill="#e2e8f0"/>
                <text x="75" y="140" text-anchor="middle" fill="#6a8a6a" font-size="9">Fond normal</text>
                <rect x="165" y="25" width="120" height="95" fill="#2a3a4a" rx="5" stroke="#4a5a6a" stroke-width="2"/>
                <rect x="172" y="32" width="106" height="81" fill="#3a4a5a" rx="3"/>
                <line x1="180" y1="40" x2="165" y2="25" stroke="#5a6a7a" stroke-width="1"/>
                <line x1="270" y1="40" x2="285" y2="25" stroke="#5a6a7a" stroke-width="1"/>
                <line x1="180" y1="105" x2="165" y2="120" stroke="#5a6a7a" stroke-width="1"/>
                <line x1="270" y1="105" x2="285" y2="120" stroke="#5a6a7a" stroke-width="1"/>
                <ellipse cx="225" cy="80" rx="15" ry="25" fill="#e2e8f0"/>
                <circle cx="225" cy="55" r="10" fill="#e2e8f0"/>
                <text x="225" y="140" text-anchor="middle" fill="#aa6a6a" font-size="9">Fond √©tir√©</text>
                <path d="M 140 72 L 160 72" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowVert)"/>
                <defs><marker id="arrowVert" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <text x="150" y="160" text-anchor="middle" fill="#888" font-size="10">Sujet identique - perspective d√©form√©e</text>
                <text x="150" y="172" text-anchor="middle" fill="#ff6b6b" font-size="9">Travelling avant + Zoom arri√®re</text>
            </svg>`,
            example: 'La sc√®ne du clocher dans "Vertigo" et la plage dans "Les Dents de la Mer".'
        },
        // === IMAGE - COMPOSITION ===
        'regle-tiers': {
            title: 'R√®gle des tiers',
            description: `<p>Principe de composition divisant l'image en 9 zones √©gales par 2 lignes horizontales et 2 verticales.</p>
            <p>Les √©l√©ments importants (visage, horizon, sujet principal) gagnent en <strong>dynamisme</strong> lorsqu'ils sont plac√©s sur ces lignes ou √† leurs intersections, appel√©es "points forts".</p>
            <p>Centrer le sujet cr√©e une image statique ; le d√©centrer selon la r√®gle des tiers cr√©e tension et mouvement.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="15" width="260" height="150" fill="#2a3a4a" stroke="#4a5a6a" stroke-width="2"/>
                <line x1="107" y1="15" x2="107" y2="165" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="5,3"/>
                <line x1="193" y1="15" x2="193" y2="165" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="5,3"/>
                <line x1="20" y1="65" x2="280" y2="65" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="5,3"/>
                <line x1="20" y1="115" x2="280" y2="115" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="5,3"/>
                <circle cx="107" cy="65" r="8" fill="#ff6b6b" opacity="0.8"/>
                <circle cx="193" cy="65" r="8" fill="#ff6b6b" opacity="0.8"/>
                <circle cx="107" cy="115" r="8" fill="#ff6b6b" opacity="0.8"/>
                <circle cx="193" cy="115" r="8" fill="#ff6b6b" opacity="0.8"/>
                <ellipse cx="193" cy="90" rx="20" ry="35" fill="#e2e8f0"/>
                <circle cx="193" cy="55" r="15" fill="#e2e8f0"/>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Points forts aux intersections</text>
            </svg>`,
            example: 'Quasi tous les grands directeurs photo utilisent cette r√®gle comme base.'
        },
        'profondeur-champ': {
            title: 'Profondeur de champ',
            description: `<p>Zone de nettet√© devant et derri√®re le point de mise au point. Peut √™tre courte (flou d'arri√®re-plan) ou grande (tout net).</p>
            <p>Une <strong>faible profondeur</strong> isole le sujet et cr√©e de l'intimit√©. Une <strong>grande profondeur</strong> permet de voir tous les plans simultan√©ment.</p>
            <p>Contr√¥l√©e par l'ouverture (f/1.4 = faible, f/16 = grande), la focale et la distance au sujet.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="30" width="80" height="100" fill="#3a4a5a" opacity="0.4" rx="5"/>
                <text x="60" y="85" text-anchor="middle" fill="#666" font-size="10">FLOU</text>
                <rect x="110" y="30" width="80" height="100" fill="#4a6a5a" rx="5"/>
                <ellipse cx="150" cy="85" rx="20" ry="35" fill="#e2e8f0"/>
                <circle cx="150" cy="55" r="12" fill="#e2e8f0"/>
                <text x="150" y="145" text-anchor="middle" fill="#8a8" font-size="10">NET</text>
                <rect x="200" y="30" width="80" height="100" fill="#3a4a5a" opacity="0.4" rx="5"/>
                <text x="240" y="85" text-anchor="middle" fill="#666" font-size="10">FLOU</text>
                <path d="M 110 160 L 190 160" stroke="#ff6b6b" stroke-width="3"/>
                <text x="150" y="175" text-anchor="middle" fill="#ff6b6b" font-size="9">Zone de nettet√©</text>
            </svg>`,
            example: 'Wong Kar-wai utilise une tr√®s faible profondeur pour cr√©er l intimit√©.'
        },
        'key-light': {
            title: 'Key Light (Lumi√®re principale)',
            description: `<p>Source lumineuse principale qui d√©finit la direction et la qualit√© de l'√©clairage d'une sc√®ne.</p>
            <p>C'est elle qui cr√©e les <strong>ombres principales</strong> et donne le "caract√®re" √† l'image. Sa position d√©termine le model√© du visage.</p>
            <p>G√©n√©ralement plac√©e √† 45¬∞ du sujet (horizontalement et verticalement), mais peut varier selon l'effet recherch√©.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <defs>
                    <radialGradient id="keyGrad" cx="30%" cy="30%">
                        <stop offset="0%" style="stop-color:#fff4d4"/>
                        <stop offset="100%" style="stop-color:#1a1a2e"/>
                    </radialGradient>
                </defs>
                <circle cx="60" cy="40" r="25" fill="#ffd700"/>
                <path d="M 60 40 L 150 90" stroke="#ffd700" stroke-width="2" stroke-dasharray="8,4" opacity="0.6"/>
                <ellipse cx="150" cy="100" rx="35" ry="45" fill="url(#keyGrad)"/>
                <circle cx="150" cy="60" r="25" fill="url(#keyGrad)"/>
                <ellipse cx="180" cy="100" rx="30" ry="40" fill="#1a1a2e" opacity="0.5"/>
                <text x="60" y="80" text-anchor="middle" fill="#ffd700" font-size="10">KEY</text>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="10">Ombre cr√©√©e par la lumi√®re principale</text>
            </svg>`,
            example: 'Position classique "Rembrandt" √† 45¬∞ pour les portraits.'
        },
        'fill-light': {
            title: 'Fill Light (Lumi√®re de remplissage)',
            description: `<p>Source secondaire qui adoucit les ombres cr√©√©es par la Key Light, sans les √©liminer compl√®tement.</p>
            <p>Contr√¥le le <strong>ratio de contraste</strong> : plus elle est forte, plus l'image est douce. Absente, les ombres sont noires (low-key).</p>
            <p>Souvent plac√©e du c√¥t√© oppos√© √† la Key, peut √™tre un r√©flecteur plut√¥t qu'une vraie source.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="60" cy="50" r="20" fill="#ffd700"/>
                <text x="60" y="85" text-anchor="middle" fill="#ffd700" font-size="9">KEY</text>
                <circle cx="240" cy="50" r="15" fill="#88aaff" opacity="0.7"/>
                <text x="240" y="80" text-anchor="middle" fill="#88aaff" font-size="9">FILL</text>
                <ellipse cx="150" cy="105" rx="35" ry="45" fill="#c4b49a"/>
                <circle cx="150" cy="65" r="25" fill="#d4c4aa"/>
                <ellipse cx="170" cy="105" rx="20" ry="35" fill="#8a7a6a" opacity="0.3"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="10">Ombres adoucies mais visibles</text>
            </svg>`,
            example: 'Un ratio Key:Fill de 2:1 donne un look naturel.'
        },
        'back-light': {
            title: 'Back Light (Contre-jour)',
            description: `<p>Lumi√®re plac√©e derri√®re le sujet qui cr√©e un liser√© lumineux sur les contours, s√©parant le sujet du fond.</p>
            <p>Apporte <strong>profondeur et relief</strong> √† l'image. Sans elle, le sujet peut se "fondre" dans l'arri√®re-plan.</p>
            <p>Aussi appel√©e "rim light" ou "hair light" quand elle √©claire sp√©cifiquement les cheveux.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="20" width="260" height="130" fill="#252535"/>
                <circle cx="150" cy="20" r="20" fill="#ffeedd"/>
                <ellipse cx="150" cy="95" rx="35" ry="50" fill="#3a3a4a"/>
                <circle cx="150" cy="50" r="25" fill="#3a3a4a"/>
                <ellipse cx="150" cy="95" rx="38" ry="53" fill="none" stroke="#ffeedd" stroke-width="3" opacity="0.7"/>
                <circle cx="150" cy="50" r="28" fill="none" stroke="#ffeedd" stroke-width="3" opacity="0.7"/>
                <text x="150" y="15" text-anchor="middle" fill="#ffeedd" font-size="9">BACK</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="10">Liser√© lumineux = s√©paration du fond</text>
            </svg>`,
            example: 'Indispensable dans les interviews pour d√©coller le sujet du fond.'
        },
        'high-key': {
            title: '√âclairage High-Key',
            description: `<p>Style d'√©clairage uniforme et lumineux avec tr√®s peu d'ombres. L'image est globalement claire.</p>
            <p>Cr√©e une atmosph√®re <strong>l√©g√®re, optimiste, accessible</strong>. Associ√© aux com√©dies, sitcoms, publicit√©s, clips pop.</p>
            <p>N√©cessite beaucoup de fill light pour √©liminer les ombres. Ratio Key:Fill proche de 1:1.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#e8e8e8; border-radius:8px;">
                <rect x="20" y="20" width="260" height="130" fill="#f5f5f5"/>
                <circle cx="60" cy="40" r="15" fill="#fff" stroke="#ddd"/>
                <circle cx="240" cy="40" r="15" fill="#fff" stroke="#ddd"/>
                <circle cx="150" cy="30" r="15" fill="#fff" stroke="#ddd"/>
                <ellipse cx="150" cy="95" rx="35" ry="45" fill="#f0e0d0"/>
                <circle cx="150" cy="55" r="25" fill="#f5e5d5"/>
                <circle cx="140" cy="50" r="4" fill="#555"/>
                <circle cx="160" cy="50" r="4" fill="#555"/>
                <path d="M 140 65 Q 150 72 160 65" stroke="#555" stroke-width="2" fill="none"/>
                <text x="150" y="165" text-anchor="middle" fill="#666" font-size="10">Lumi√®re uniforme - pas d ombres</text>
            </svg>`,
            example: 'Les com√©dies romantiques, les pubs de cosm√©tiques.'
        },
        'low-key': {
            title: '√âclairage Low-Key',
            description: `<p>Style d'√©clairage contrast√© avec des ombres profondes et des zones sombres dominantes.</p>
            <p>Cr√©e une atmosph√®re <strong>dramatique, myst√©rieuse, mena√ßante</strong>. Signature du film noir, thriller, horreur.</p>
            <p>Peu ou pas de fill light. Les ombres sont noires, les sources souvent hors-champ.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#0a0a0e; border-radius:8px;">
                <rect x="20" y="20" width="260" height="130" fill="#0f0f15"/>
                <circle cx="50" cy="50" r="15" fill="#ffd700" opacity="0.8"/>
                <defs>
                    <linearGradient id="lowkeyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#c4a47a"/>
                        <stop offset="50%" style="stop-color:#3a3a3a"/>
                        <stop offset="100%" style="stop-color:#0a0a0e"/>
                    </linearGradient>
                </defs>
                <ellipse cx="150" cy="95" rx="35" ry="45" fill="url(#lowkeyGrad)"/>
                <circle cx="150" cy="55" r="25" fill="url(#lowkeyGrad)"/>
                <text x="150" y="165" text-anchor="middle" fill="#666" font-size="10">Forts contrastes - ombres profondes</text>
            </svg>`,
            example: 'Film noir, Se7en, Blade Runner, Le Parrain.'
        },
        'magic-hour': {
            title: 'Magic Hour (Heure dor√©e)',
            description: `<p>P√©riode juste apr√®s le lever ou avant le coucher du soleil o√π la lumi√®re est dor√©e, douce et directionnelle.</p>
            <p>Produit une lumi√®re <strong>naturellement flatteuse</strong> avec des ombres longues et une qualit√© "magique" impossible √† reproduire artificiellement.</p>
            <p>Fen√™tre de tournage tr√®s courte (20-40 min). Demande une pr√©paration minutieuse.</p>`,
            image: `<svg viewBox="0 0 300 180" style="border-radius:8px;">
                <defs>
                    <linearGradient id="magicSky" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#1a1a3e"/>
                        <stop offset="50%" style="stop-color:#ff7b4a"/>
                        <stop offset="100%" style="stop-color:#ffcc66"/>
                    </linearGradient>
                </defs>
                <rect width="300" height="180" fill="url(#magicSky)"/>
                <circle cx="150" cy="145" r="30" fill="#ffdd44"/>
                <rect y="150" width="300" height="30" fill="#2a2a3a"/>
                <ellipse cx="100" cy="130" rx="15" ry="30" fill="#1a1a2a"/>
                <circle cx="100" cy="100" r="10" fill="#1a1a2a"/>
                <ellipse cx="200" cy="125" rx="12" ry="25" fill="#1a1a2a"/>
                <circle cx="200" cy="100" r="8" fill="#1a1a2a"/>
                <text x="150" y="172" text-anchor="middle" fill="#fff" font-size="10">Lumi√®re dor√©e - ombres longues</text>
            </svg>`,
            example: 'Terrence Malick (Days of Heaven, The Tree of Life) tourne quasi exclusivement en magic hour.'
        },
        // === IMAGE - OPTIQUES ===
        'focale-courte': {
            title: 'Focale courte (Grand-angle)',
            description: `<p>Objectif de 16-35mm qui offre un champ de vision large et exag√®re les perspectives.</p>
            <p>Les objets proches paraissent <strong>plus grands</strong>, les distances semblent <strong>√©tir√©es</strong>. D√©forme les bords de l'image.</p>
            <p>Id√©al pour : espaces confin√©s, sentiment d'oppression, immensit√© des paysages, effets comiques (visage d√©form√©).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <path d="M 150 90 L 20 20 L 20 160 Z" fill="#3a5a4a" opacity="0.3"/>
                <path d="M 150 90 L 280 20 L 280 160 Z" fill="#3a5a4a" opacity="0.3"/>
                <rect x="30" y="50" width="40" height="60" fill="#4a5a6a" rx="2"/>
                <rect x="230" y="60" width="30" height="40" fill="#4a5a6a" rx="2"/>
                <ellipse cx="150" cy="100" rx="40" ry="55" fill="#e2e8f0"/>
                <circle cx="150" cy="50" r="30" fill="#e2e8f0"/>
                <circle cx="150" cy="90" r="8" fill="#2a2a3e"/>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Champ large - perspectives exag√©r√©es</text>
            </svg>`,
            example: 'Kubrick dans Orange M√©canique, les sc√®nes de poursuite de Mad Max.'
        },
        'focale-longue': {
            title: 'Focale longue (T√©l√©objectif)',
            description: `<p>Objectif de 85-200mm+ qui compresse les distances et isole le sujet avec un fort flou d'arri√®re-plan.</p>
            <p>Les plans semblent <strong>rapproch√©s</strong> les uns des autres. Cr√©e une sensation d'<strong>intimit√©</strong> ou d'<strong>√©crasement</strong>.</p>
            <p>Id√©al pour : portraits, isoler un sujet dans une foule, cr√©er une sensation de surveillance ou filature.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="30" width="260" height="110" fill="#2a3a4a" opacity="0.4"/>
                <rect x="40" y="45" width="60" height="80" fill="#3a4a5a" opacity="0.5"/>
                <rect x="200" y="50" width="50" height="70" fill="#3a4a5a" opacity="0.5"/>
                <ellipse cx="150" cy="95" rx="45" ry="55" fill="#e2e8f0"/>
                <circle cx="150" cy="45" r="35" fill="#e2e8f0"/>
                <circle cx="137" cy="40" r="5" fill="#2a2a3e"/>
                <circle cx="163" cy="40" r="5" fill="#2a2a3e"/>
                <path d="M 140 55 Q 150 62 160 55" stroke="#2a2a3e" stroke-width="2" fill="none"/>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Compression - sujet isol√© du fond flou</text>
            </svg>`,
            example: 'Les portraits de Gordon Willis dans Le Parrain.'
        },
        'anamorphique': {
            title: 'Objectif anamorphique',
            description: `<p>Optique sp√©ciale qui compresse l'image horizontalement √† la prise de vue, puis l'√©tire √† la projection.</p>
            <p>Produit le format <strong>CinemaScope 2.39:1</strong>, des flares horizontaux caract√©ristiques et un bokeh ovale.</p>
            <p>Consid√©r√© comme le "look cin√©ma" par excellence. Plus co√ªteux et complexe √† utiliser.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="50" width="260" height="80" fill="#2a3a4a" stroke="#4a6a8a" stroke-width="2"/>
                <ellipse cx="80" cy="90" rx="8" ry="20" fill="#4a8aaa" opacity="0.6"/>
                <ellipse cx="220" cy="90" rx="8" ry="20" fill="#aa6a4a" opacity="0.6"/>
                <line x1="40" y1="90" x2="260" y2="90" stroke="#6a9aaa" stroke-width="2" opacity="0.4"/>
                <ellipse cx="150" cy="90" rx="30" ry="25" fill="#e2e8f0"/>
                <circle cx="150" cy="75" r="15" fill="#e2e8f0"/>
                <text x="150" y="55" text-anchor="middle" fill="#6a9aaa" font-size="9">Flares horizontaux</text>
                <text x="150" y="145" text-anchor="middle" fill="#888" font-size="9">Format 2.39:1 - Bokeh ovale</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Le "look cin√©ma" caract√©ristique</text>
            </svg>`,
            example: 'Blade Runner 2049, Star Wars, La La Land.'
        },
        // === IMAGE - RATIOS ===
        'grue-jib': {
            title: 'Grue / Jib',
            description: `<p>Dispositif m√©canique permettant des mouvements de cam√©ra verticaux amples et fluides.</p>
            <p>La <strong>grue</strong> peut porter l'op√©rateur, le <strong>jib</strong> est t√©l√©command√©. Permet des mouvements impossibles autrement.</p>
            <p>Id√©al pour les r√©v√©lations spectaculaires, les survols, les mouvements du sol au ciel.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="140" width="40" height="30" fill="#4a4a4a" rx="3"/>
                <line x1="50" y1="140" x2="50" y2="60" stroke="#6a6a6a" stroke-width="4"/>
                <line x1="50" y1="60" x2="200" y2="40" stroke="#6a6a6a" stroke-width="4"/>
                <circle cx="50" cy="60" r="8" fill="#5a5a5a"/>
                <rect x="190" y="30" width="30" height="25" fill="#3a3a3a" rx="3"/>
                <circle cx="205" cy="42" r="8" fill="#2a2a2a"/>
                <path d="M 205 55 Q 205 100 205 120" stroke="#ff6b6b" stroke-width="2" stroke-dasharray="5,3"/>
                <path d="M 200 120 L 205 130 L 210 120" fill="#ff6b6b"/>
                <text x="220" y="90" fill="#ff6b6b" font-size="8">Mouvement</text>
                <text x="220" y="100" fill="#ff6b6b" font-size="8">vertical</text>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="10">Mouvements amples et fluides</text>
            </svg>`,
            example: 'Le plan final de La Haine, les survols de foule.'
        },
        'chiaroscuro': {
            title: 'Chiaroscuro (Clair-obscur)',
            description: `<p>Technique d'√©clairage inspir√©e de la peinture baroque (Caravage, Rembrandt) utilisant des contrastes extr√™mes.</p>
            <p>Des zones de <strong>lumi√®re intense</strong> c√¥toient des <strong>ombres profondes</strong>, cr√©ant un effet dramatique et sculptural.</p>
            <p>Renforce le myst√®re, la tension, la dimension psychologique des personnages.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#0a0a0e; border-radius:8px;">
                <defs>
                    <linearGradient id="chiaroGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#d4a574"/>
                        <stop offset="40%" style="stop-color:#8a6a4a"/>
                        <stop offset="60%" style="stop-color:#2a1a0a"/>
                        <stop offset="100%" style="stop-color:#0a0a0e"/>
                    </linearGradient>
                </defs>
                <ellipse cx="130" cy="100" rx="50" ry="65" fill="url(#chiaroGrad)"/>
                <circle cx="130" cy="50" r="35" fill="url(#chiaroGrad)"/>
                <circle cx="60" cy="30" r="20" fill="#ffd700" opacity="0.6"/>
                <path d="M 60 30 L 100 50" stroke="#ffd700" stroke-width="1" stroke-dasharray="5,3" opacity="0.4"/>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="10">Contraste extr√™me lumi√®re/ombre</text>
            </svg>`,
            example: 'Le Parrain, Blade Runner, les films de Fincher.'
        },
        'rembrandt-lighting': {
            title: '√âclairage Rembrandt',
            description: `<p>Technique de portrait o√π la lumi√®re cr√©e un triangle lumineux sous l'≈ìil du c√¥t√© ombr√© du visage.</p>
            <p>Nomm√© d'apr√®s le peintre qui utilisait ce motif. Consid√©r√© comme l'<strong>√©clairage portrait classique</strong> par excellence.</p>
            <p>La key light est plac√©e √† 45¬∞ en hauteur et sur le c√¥t√©, cr√©ant ce triangle caract√©ristique.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <defs>
                    <linearGradient id="rembrandtGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#d4a574"/>
                        <stop offset="50%" style="stop-color:#6a4a3a"/>
                        <stop offset="100%" style="stop-color:#2a1a1a"/>
                    </linearGradient>
                </defs>
                <circle cx="150" cy="70" r="50" fill="url(#rembrandtGrad)"/>
                <ellipse cx="150" cy="130" rx="40" ry="35" fill="url(#rembrandtGrad)"/>
                <polygon points="175,75 185,85 175,95" fill="#c4a474" opacity="0.8"/>
                <circle cx="135" cy="60" r="5" fill="#2a2a3e"/>
                <circle cx="165" cy="60" r="5" fill="#2a2a3e" opacity="0.5"/>
                <circle cx="50" cy="30" r="15" fill="#ffd700" opacity="0.7"/>
                <path d="M 65 35 L 120 55" stroke="#ffd700" stroke-width="1" stroke-dasharray="5,3" opacity="0.5"/>
                <text x="175" y="90" fill="#c4a474" font-size="8">Triangle</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Triangle lumineux sous l ≈ìil ombr√©</text>
            </svg>`,
            example: 'Portraits classiques, interviews cin√©ma.'
        },
        'lumiere-pratique': {
            title: 'Lumi√®re pratique',
            description: `<p>Source de lumi√®re visible √† l'√©cran : lampes, bougies, n√©ons, √©crans, phares de voiture.</p>
            <p>Justifie la lumi√®re de la sc√®ne de mani√®re <strong>di√©g√©tique</strong> (dans l'univers du film).</p>
            <p>Souvent renforc√©e par des sources cach√©es car les pratiques seules sont rarement suffisantes.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="50" y="40" width="200" height="110" fill="#2a2a3a" rx="5"/>
                <rect x="135" y="80" width="30" height="50" fill="#4a4a3a"/>
                <ellipse cx="150" cy="75" rx="20" ry="15" fill="#ffeedd"/>
                <ellipse cx="150" cy="75" rx="25" ry="20" fill="#ffd700" opacity="0.3"/>
                <ellipse cx="150" cy="75" rx="35" ry="30" fill="#ffd700" opacity="0.15"/>
                <ellipse cx="100" cy="110" rx="20" ry="30" fill="#8a7a6a"/>
                <circle cx="100" cy="85" r="12" fill="#9a8a7a"/>
                <ellipse cx="200" cy="115" rx="18" ry="28" fill="#7a6a5a"/>
                <circle cx="200" cy="90" r="10" fill="#8a7a6a"/>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="10">Source visible √† l √©cran</text>
            </svg>`,
            example: 'Barry Lyndon (bougies), Taxi Driver (n√©ons).'
        },
        'temperature-couleur': {
            title: 'Temp√©rature de couleur',
            description: `<p>Mesure en Kelvin (K) de la teinte d'une source lumineuse, du chaud (orange) au froid (bleu).</p>
            <p><strong>2700-3200K</strong> = tungst√®ne, bougie (chaud). <strong>5500-6500K</strong> = lumi√®re du jour (neutre √† froid).</p>
            <p>M√©langer des sources de temp√©ratures diff√©rentes cr√©e des dominantes color√©es (voulues ou non).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <defs>
                    <linearGradient id="tempGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#ff6a00"/>
                        <stop offset="30%" style="stop-color:#ffaa44"/>
                        <stop offset="50%" style="stop-color:#ffffff"/>
                        <stop offset="70%" style="stop-color:#aaccff"/>
                        <stop offset="100%" style="stop-color:#4488ff"/>
                    </linearGradient>
                </defs>
                <rect x="30" y="60" width="240" height="40" fill="url(#tempGrad)" rx="5"/>
                <text x="50" y="55" fill="#ff6a00" font-size="9">2700K</text>
                <text x="100" y="55" fill="#ffaa44" font-size="9">3200K</text>
                <text x="150" y="55" text-anchor="middle" fill="#fff" font-size="9">5500K</text>
                <text x="200" y="55" fill="#aaccff" font-size="9">6500K</text>
                <text x="250" y="55" fill="#4488ff" font-size="9">10000K</text>
                <text x="50" y="120" fill="#ff6a00" font-size="8">Bougie</text>
                <text x="100" y="120" fill="#ffaa44" font-size="8">Tungst√®ne</text>
                <text x="150" y="120" text-anchor="middle" fill="#fff" font-size="8">Jour</text>
                <text x="220" y="120" fill="#aaccff" font-size="8">Ciel couvert</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="10">√âchelle Kelvin : chaud ‚Üí froid</text>
            </svg>`,
            example: 'M√©lange tungst√®ne/daylight dans les sc√®nes int√©rieur/fen√™tre.'
        },
        'ratio-scope': {
            title: 'Format Scope (2.39:1)',
            description: `<p>Format cin√©matographique ultra-large, aussi appel√© CinemaScope ou Panavision.</p>
            <p>Id√©al pour les <strong>paysages √©piques</strong>, les westerns, la science-fiction. Permet de composer avec beaucoup d'espace horizontal.</p>
            <p>Peut cr√©er un sentiment d'isolement quand un personnage seul occupe ce format large.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="55" width="260" height="70" fill="#2a3a4a" stroke="#5a7a8a" stroke-width="2"/>
                <polygon points="40,125 70,70 100,125" fill="#4a5a6a"/>
                <polygon points="200,125 240,65 280,125" fill="#4a5a6a"/>
                <circle cx="150" cy="105" r="4" fill="#e2e8f0"/>
                <ellipse cx="150" cy="110" rx="3" ry="8" fill="#e2e8f0"/>
                <text x="150" y="145" text-anchor="middle" fill="#5a7a8a" font-size="11">2.39:1</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">√âpique, paysages, espace horizontal</text>
            </svg>`,
            example: 'Lawrence d Arabie, Dune, les westerns de Leone.'
        },
        'ratio-185': {
            title: 'Format 1.85:1',
            description: `<p>Format standard du cin√©ma am√©ricain depuis les ann√©es 50. Plus large que le 16:9 TV.</p>
            <p>Bon <strong>compromis</strong> entre l'intimit√© du 4:3 et l'ampleur du Scope. Polyvalent pour tous les genres.</p>
            <p>Souvent appel√© "Flat" par opposition au "Scope".</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="35" y="35" width="230" height="110" fill="#2a3a4a" stroke="#5a8a7a" stroke-width="2"/>
                <ellipse cx="150" cy="95" rx="25" ry="40" fill="#e2e8f0"/>
                <circle cx="150" cy="55" r="18" fill="#e2e8f0"/>
                <rect x="60" y="60" width="35" height="55" fill="#3a4a5a"/>
                <rect x="205" y="65" width="30" height="45" fill="#3a4a5a"/>
                <text x="150" y="158" text-anchor="middle" fill="#5a8a7a" font-size="11">1.85:1</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Standard US - polyvalent</text>
            </svg>`,
            example: 'La majorit√© des films am√©ricains : Spielberg, Nolan (hors IMAX).'
        },
        'ratio-imax': {
            title: 'Format IMAX (1.43:1)',
            description: `<p>Format g√©ant d√©velopp√© pour les √©crans IMAX, presque carr√©, offrant une immersion maximale.</p>
            <p>Utilise des pellicules ou capteurs beaucoup plus grands que le 35mm standard. R√©solution et d√©tails exceptionnels.</p>
            <p>Certains films alternent entre IMAX et Scope selon les sc√®nes (Nolan, Villeneuve).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="75" y="20" width="150" height="130" fill="#2a3a4a" stroke="#8a9aaa" stroke-width="3"/>
                <text x="150" y="90" text-anchor="middle" fill="#8a9aaa" font-size="14">IMAX</text>
                <text x="150" y="110" text-anchor="middle" fill="#6a7a8a" font-size="10">1.43:1</text>
                <rect x="40" y="160" width="220" height="3" fill="#4a5a6a"/>
                <ellipse cx="150" cy="160" rx="8" ry="4" fill="#e2e8f0"/>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="9">Format g√©ant - Immersion maximale</text>
            </svg>`,
            example: 'Dunkirk, Oppenheimer, Interstellar (s√©quences IMAX).'
        },
        'cadre-ferme': {
            title: 'Cadre ferm√©',
            description: `<p>Composition o√π des √©l√©ments du d√©cor (portes, fen√™tres, barreaux) encadrent et "emprisonnent" le sujet.</p>
            <p>Cr√©e un sentiment d'<strong>oppression, d'enfermement, de pi√®ge</strong>. Le personnage semble coinc√©.</p>
            <p>Contraste avec le cadre ouvert qui sugg√®re la libert√© et les possibilit√©s.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="50" y="30" width="200" height="120" fill="#1a1a1a"/>
                <rect x="50" y="30" width="15" height="120" fill="#3a3a3a"/>
                <rect x="235" y="30" width="15" height="120" fill="#3a3a3a"/>
                <rect x="50" y="30" width="200" height="15" fill="#3a3a3a"/>
                <rect x="50" y="135" width="200" height="15" fill="#3a3a3a"/>
                <line x1="117" y1="30" x2="117" y2="150" stroke="#3a3a3a" stroke-width="8"/>
                <line x1="183" y1="30" x2="183" y2="150" stroke="#3a3a3a" stroke-width="8"/>
                <ellipse cx="150" cy="95" rx="25" ry="35" fill="#e2e8f0"/>
                <circle cx="150" cy="60" r="18" fill="#e2e8f0"/>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="10">√âl√©ments qui emprisonnent le sujet</text>
            </svg>`,
            example: 'Les plans √† travers les barreaux dans Le Silence des Agneaux.'
        },
        'cadre-ouvert': {
            title: 'Cadre ouvert',
            description: `<p>Composition o√π le personnage dispose d'espace pour "sortir" du cadre, sugg√©rant libert√© et possibilit√©s.</p>
            <p>Le regard ou le mouvement du personnage indique un <strong>hors-champ accessible</strong>.</p>
            <p>Cr√©e une dynamique, une invitation au mouvement, un sentiment d'ouverture.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="30" width="240" height="120" fill="#3a4a5a"/>
                <ellipse cx="100" cy="95" rx="25" ry="40" fill="#e2e8f0"/>
                <circle cx="100" cy="55" r="18" fill="#e2e8f0"/>
                <circle cx="108" cy="52" r="3" fill="#2a2a3e"/>
                <path d="M 115 55 L 200 40" stroke="#5a8a5a" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="210" y="45" fill="#5a8a5a" font-size="9">‚Üí Espace libre</text>
                <path d="M 130 95 L 250 95" stroke="#5a8a5a" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="200" y="110" fill="#5a8a5a" font-size="9">‚Üí Sortie possible</text>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="10">Espace de libert√© - Hors-champ accessible</text>
            </svg>`,
            example: 'Plans larges de westerns, fins ouvertes.'
        },
        'log-raw': {
            title: 'LOG / RAW',
            description: `<p>Profils d'enregistrement qui capturent un maximum d'informations pour l'√©talonnage en post-production.</p>
            <p><strong>LOG</strong> : image plate et d√©satur√©e, pr√©serve les hautes et basses lumi√®res. <strong>RAW</strong> : donn√©es brutes du capteur.</p>
            <p>N√©cessite un √©talonnage obligatoire mais offre une flexibilit√© cr√©ative maximale.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="40" width="100" height="70" fill="#6a6a6a" rx="5"/>
                <ellipse cx="80" cy="75" rx="25" ry="25" fill="#7a7a7a"/>
                <circle cx="80" cy="55" r="15" fill="#8a8a8a"/>
                <text x="80" y="125" text-anchor="middle" fill="#888" font-size="9">LOG (plat)</text>
                <path d="M 140 75 L 160 75" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowLog)"/>
                <defs><marker id="arrowLog" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#ff6b6b"/></marker></defs>
                <rect x="170" y="40" width="100" height="70" fill="#4a6a8a" rx="5"/>
                <defs>
                    <linearGradient id="logGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#d4a574"/>
                        <stop offset="100%" style="stop-color:#4a3a2a"/>
                    </linearGradient>
                </defs>
                <ellipse cx="220" cy="75" rx="25" ry="25" fill="url(#logGrad)"/>
                <circle cx="220" cy="55" r="15" fill="#e8c8a8"/>
                <text x="220" y="125" text-anchor="middle" fill="#888" font-size="9">√âtalonn√©</text>
                <text x="150" y="160" text-anchor="middle" fill="#888" font-size="9">Maximum de flexibilit√© en post</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">√âtalonnage obligatoire</text>
            </svg>`,
            example: 'Standard sur toutes les productions cin√©ma actuelles.'
        },
        'lut': {
            title: 'LUT (Look-Up Table)',
            description: `<p>Fichier de transformation colorim√©trique appliquant un "look" pr√©d√©fini √† l'image.</p>
            <p><strong>LUT technique</strong> : convertit LOG vers un espace standard. <strong>LUT cr√©ative</strong> : applique un style (film, vintage, etc.).</p>
            <p>Permet de pr√©visualiser le rendu final sur le plateau et d'acc√©l√©rer l'√©talonnage.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="50" width="70" height="50" fill="#7a7a7a" rx="3"/>
                <text x="55" y="80" text-anchor="middle" fill="#aaa" font-size="9">LOG</text>
                <rect x="100" y="40" width="60" height="70" fill="#3a4a5a" rx="5" stroke="#5a8a8a" stroke-width="2"/>
                <text x="130" y="70" text-anchor="middle" fill="#8acaca" font-size="10">LUT</text>
                <text x="130" y="85" text-anchor="middle" fill="#6a8a8a" font-size="7">.cube</text>
                <text x="130" y="100" text-anchor="middle" fill="#6a8a8a" font-size="7">.3dl</text>
                <path d="M 90 75 L 100 75" stroke="#5a8a8a" stroke-width="2"/>
                <path d="M 160 75 L 175 75" stroke="#5a8a8a" stroke-width="2" marker-end="url(#arrowLut)"/>
                <defs><marker id="arrowLut" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#5a8a8a"/></marker></defs>
                <rect x="180" y="50" width="70" height="50" fill="#8a6a4a" rx="3"/>
                <text x="215" y="80" text-anchor="middle" fill="#daa" font-size="9">Look final</text>
                <text x="150" y="140" text-anchor="middle" fill="#888" font-size="9">Transformation colorim√©trique</text>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="10">Pr√©visualisation et acc√©l√©ration</text>
            </svg>`,
            example: 'Rec709, Cineon, looks "Teal & Orange".'
        },
        'ratio-43': {
            title: 'Format 4:3 (1.33:1)',
            description: `<p>Format "Academy" classique, aussi format de la t√©l√©vision ancienne. Presque carr√©.</p>
            <p>Ressenti <strong>intime, r√©tro, claustrophobe</strong>. Red√©couvert par des cin√©astes contemporains pour son caract√®re distinctif.</p>
            <p>Force √† des compositions plus verticales, met l'accent sur les visages.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="75" y="20" width="150" height="140" fill="#2a3a4a" stroke="#8a7a5a" stroke-width="2"/>
                <ellipse cx="150" cy="100" rx="30" ry="45" fill="#e2e8f0"/>
                <circle cx="150" cy="55" r="22" fill="#e2e8f0"/>
                <circle cx="140" cy="50" r="4" fill="#2a2a3e"/>
                <circle cx="160" cy="50" r="4" fill="#2a2a3e"/>
                <text x="150" y="172" text-anchor="middle" fill="#8a7a5a" font-size="11">4:3 (1.33:1)</text>
            </svg>`,
            example: 'The Lighthouse, Elephant de Van Sant, First Reformed.'
        },
        // === IMAGE - CADRE NARRATIF ===
        'hors-champ': {
            title: 'Hors-champ',
            description: `<p>Tout ce qui existe dans l'univers du film mais n'est pas visible dans le cadre √† un moment donn√©.</p>
            <p>Outil narratif <strong>puissant</strong> : ce qu'on ne voit pas peut √™tre plus effrayant/intrigant que ce qu'on montre.</p>
            <p>Le regard d'un personnage, un son, une ombre peuvent sugg√©rer une pr√©sence hors-champ.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="60" y="30" width="180" height="120" fill="#2a3a4a" stroke="#5a6a7a" stroke-width="2"/>
                <rect x="0" y="0" width="60" height="180" fill="#1a1a2e" opacity="0.8"/>
                <rect x="240" y="0" width="60" height="180" fill="#1a1a2e" opacity="0.8"/>
                <ellipse cx="150" cy="95" rx="25" ry="40" fill="#e2e8f0"/>
                <circle cx="150" cy="55" r="18" fill="#e2e8f0"/>
                <ellipse cx="150" cy="60" rx="10" ry="5" fill="none"/>
                <circle cx="143" cy="52" r="3" fill="#2a2a3e"/>
                <circle cx="157" cy="52" r="3" fill="#2a2a3e"/>
                <path d="M 160 55 Q 200 55 230 40" stroke="#ff6b6b" stroke-width="2" fill="none" stroke-dasharray="5,3"/>
                <text x="255" y="35" fill="#ff6b6b" font-size="9">?</text>
                <ellipse cx="30" cy="90" rx="15" ry="30" fill="#4a5a6a" opacity="0.5"/>
                <text x="30" y="140" text-anchor="middle" fill="#666" font-size="8">HORS</text>
                <text x="30" y="150" text-anchor="middle" fill="#666" font-size="8">CHAMP</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Le regard sugg√®re une pr√©sence invisible</text>
            </svg>`,
            example: 'Alien - le monstre reste hors-champ la majorit√© du film.'
        },
        'amorce': {
            title: 'Amorce',
            description: `<p>√âl√©ment (souvent flou) plac√© au premier plan du cadre, partiellement visible, qui cr√©e de la profondeur.</p>
            <p>Donne une sensation de <strong>voyeurisme</strong>, d'espionnage, ou simplement de profondeur spatiale.</p>
            <p>Souvent une √©paule, une t√™te, un objet. Fr√©quent dans les champs/contre-champs.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="20" width="260" height="140" fill="#2a3a4a"/>
                <ellipse cx="40" cy="100" rx="35" ry="60" fill="#4a4a5a" opacity="0.6"/>
                <circle cx="45" cy="45" r="25" fill="#4a4a5a" opacity="0.6"/>
                <ellipse cx="190" cy="95" rx="30" ry="45" fill="#e2e8f0"/>
                <circle cx="190" cy="55" r="22" fill="#e2e8f0"/>
                <circle cx="180" cy="50" r="4" fill="#2a2a3e"/>
                <circle cx="200" cy="50" r="4" fill="#2a2a3e"/>
                <text x="40" y="170" fill="#666" font-size="9">Amorce floue</text>
                <text x="190" y="170" text-anchor="middle" fill="#888" font-size="9">Sujet net</text>
            </svg>`,
            example: 'Quasi tous les champs/contre-champs utilisent des amorces.'
        },
        'surcadrage': {
            title: 'Surcadrage',
            description: `<p>Technique de composition o√π un cadre dans l'image (porte, fen√™tre, miroir) encadre le sujet.</p>
            <p>Cr√©e une <strong>mise en abyme</strong>, isole le personnage, peut sugg√©rer l'enfermement ou le voyeurisme.</p>
            <p>Tr√®s utilis√© par John Ford (portes) et Wong Kar-wai (fen√™tres, miroirs).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="20" width="260" height="140" fill="#1a1a1a"/>
                <rect x="80" y="35" width="140" height="110" fill="#3a4a5a"/>
                <rect x="85" y="40" width="130" height="100" fill="#4a5a6a"/>
                <ellipse cx="150" cy="100" rx="25" ry="40" fill="#e2e8f0"/>
                <circle cx="150" cy="60" r="18" fill="#e2e8f0"/>
                <rect x="80" y="35" width="140" height="110" fill="none" stroke="#6a5a4a" stroke-width="8"/>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Cadre dans le cadre - mise en abyme</text>
            </svg>`,
            example: 'In the Mood for Love, La Prisonni√®re du d√©sert (plan final).'
        },
        // === SON - MICROPHONES ===
        'micro-canon': {
            title: 'Micro canon (Shotgun)',
            description: `<p>Microphone tr√®s directionnel en forme de tube, con√ßu pour capter le son dans un angle √©troit devant lui.</p>
            <p>Id√©al pour <strong>isoler une source</strong> (voix d'un acteur) tout en rejetant les sons lat√©raux et arri√®re.</p>
            <p>Mont√© sur une perche tenue par le perchiste, il doit pointer vers la bouche de l'acteur, g√©n√©ralement par-dessus.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="80" y="85" width="140" height="16" fill="#4a4a4a" rx="3"/>
                <rect x="60" y="80" width="25" height="26" fill="#3a3a3a" rx="5"/>
                <line x1="85" y1="75" x2="85" y2="65" stroke="#5a5a5a" stroke-width="2"/>
                <circle cx="85" cy="60" r="5" fill="#5a5a5a"/>
                <path d="M 220 93 L 270 70 L 270 116 Z" fill="#4a8a4a" opacity="0.3"/>
                <path d="M 220 93 L 250 80 L 250 106 Z" fill="#4a8a4a" opacity="0.5"/>
                <ellipse cx="260" cy="130" rx="20" ry="35" fill="#e2e8f0"/>
                <circle cx="260" cy="95" r="15" fill="#e2e8f0"/>
                <text x="150" y="140" text-anchor="middle" fill="#4a8a4a" font-size="9">Zone de captation</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Tr√®s directionnel - rejette les sons lat√©raux</text>
            </svg>`,
            example: 'Standard sur tous les plateaux professionnels.'
        },
        'micro-cravate': {
            title: 'Micro cravate (Lavalier)',
            description: `<p>Microphone miniature omnidirectionnel qui se fixe sur le v√™tement de l'acteur, pr√®s de la poitrine.</p>
            <p>Avantage : <strong>discret et s√©curisant</strong> (toujours √† distance constante). Inconv√©nient : risque de frottements, son moins naturel.</p>
            <p>Souvent utilis√© en backup du micro perche, ou quand la perche ne peut pas atteindre l'acteur (plan large).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="130" rx="50" ry="45" fill="#4a5a6a"/>
                <circle cx="150" cy="70" r="35" fill="#e2e8f0"/>
                <rect x="125" y="100" width="50" height="50" fill="#4a5a6a"/>
                <circle cx="135" cy="115" r="6" fill="#2a2a2a" stroke="#1a1a1a" stroke-width="2"/>
                <line x1="135" y1="121" x2="135" y2="145" stroke="#1a1a1a" stroke-width="1"/>
                <circle cx="135" cy="115" r="10" fill="none" stroke="#6a9a6a" stroke-width="1" stroke-dasharray="3,2" opacity="0.7"/>
                <circle cx="135" cy="115" r="18" fill="none" stroke="#6a9a6a" stroke-width="1" stroke-dasharray="3,2" opacity="0.4"/>
                <text x="135" y="160" text-anchor="middle" fill="#6a9a6a" font-size="8">Omnidirectionnel</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Fix√© sur v√™tement - discret mais risque frottements</text>
            </svg>`,
            example: 'Indispensable pour les interviews et documentaires.'
        },
        // === SON - COUCHES SONORES ===
        'foley': {
            title: 'Foley (Bruitage)',
            description: `<p>Art de recr√©er en studio les sons synchrones du quotidien : pas, v√™tements, manipulations d'objets.</p>
            <p>Nomm√© d'apr√®s <strong>Jack Foley</strong>, pionnier de la technique √† Universal dans les ann√©es 1920.</p>
            <p>Le bruiteur (foley artist) regarde l'image et reproduit les sons en temps r√©el avec des accessoires vari√©s.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="20" width="120" height="90" fill="#2a2a3a" rx="5" stroke="#4a4a5a"/>
                <rect x="30" y="30" width="100" height="70" fill="#1a1a2a"/>
                <ellipse cx="80" cy="70" rx="15" ry="25" fill="#6a6a7a"/>
                <circle cx="80" cy="45" r="10" fill="#7a7a8a"/>
                <rect x="160" y="80" width="60" height="20" fill="#5a4a3a" rx="3"/>
                <ellipse cx="190" cy="60" rx="25" ry="15" fill="#6a5a4a"/>
                <rect x="230" y="50" width="15" height="60" fill="#4a4a5a"/>
                <circle cx="237" cy="45" r="8" fill="#5a5a6a"/>
                <path d="M 70 120 L 90 120 L 90 140 L 70 140 Z" fill="#5a5a6a"/>
                <path d="M 75 140 L 75 160 M 85 140 L 85 160" stroke="#4a4a5a" stroke-width="4"/>
                <text x="80" y="115" text-anchor="middle" fill="#888" font-size="8">√âcran</text>
                <text x="190" y="115" text-anchor="middle" fill="#888" font-size="8">Accessoires</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Bruiteur synchronisant les sons en studio</text>
            </svg>`,
            example: 'Ben Burtt a cr√©√© le son de R2-D2 et le sabre laser.'
        },
        'ambiance-son': {
            title: 'Ambiance sonore (Room Tone)',
            description: `<p>Son continu caract√©ristique d'un lieu : rumeur de ville, vent, for√™t, bourdonnement d'int√©rieur.</p>
            <p>Indispensable pour <strong>cr√©er l'espace sonore</strong> et assurer la continuit√© entre les plans d'une m√™me sc√®ne.</p>
            <p>On enregistre toujours 1-2 minutes de "silence" de chaque lieu pour avoir de l'ambiance de raccord.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="40" width="240" height="100" fill="#2a3a4a" rx="5"/>
                <path d="M 50 90 Q 80 70 110 90 Q 140 110 170 90 Q 200 70 230 90 Q 260 110 280 90" stroke="#5a8a6a" stroke-width="2" fill="none" opacity="0.5"/>
                <path d="M 50 90 Q 80 80 110 90 Q 140 100 170 90 Q 200 80 230 90 Q 260 100 280 90" stroke="#5a8a6a" stroke-width="2" fill="none" opacity="0.7"/>
                <path d="M 50 90 Q 80 85 110 90 Q 140 95 170 90 Q 200 85 230 90 Q 260 95 280 90" stroke="#5a8a6a" stroke-width="2" fill="none"/>
                <text x="150" y="70" text-anchor="middle" fill="#5a8a6a" font-size="10">~~~~ rumeur continue ~~~~</text>
                <text x="150" y="130" text-anchor="middle" fill="#888" font-size="9">For√™t / Ville / Int√©rieur / Vent...</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Cr√©e l espace - assure la continuit√©</text>
            </svg>`,
            example: 'Le bourdonnement oppressant dans No Country for Old Men.'
        },
        // === SON - DI√âG√àSE ===
        'son-diegetique': {
            title: 'Son di√©g√©tique',
            description: `<p>Son dont la source existe dans l'univers du film et que les personnages peuvent entendre.</p>
            <p>Exemples : radio √† l'√©cran, musicien qui joue, dialogue, bruit de pas, klaxon dans la rue.</p>
            <p>Ancre le spectateur dans la <strong>r√©alit√© de la fiction</strong> et renforce l'immersion.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="40" y="30" width="220" height="110" fill="#2a3a4a" rx="5" stroke="#4a5a6a" stroke-width="2"/>
                <text x="150" y="25" text-anchor="middle" fill="#5a6a7a" font-size="9">MONDE DU FILM</text>
                <rect x="70" y="60" width="40" height="50" fill="#5a4a3a" rx="3"/>
                <circle cx="90" cy="75" r="8" fill="#3a3a3a"/>
                <circle cx="90" cy="75" r="4" fill="#6a6a6a"/>
                <ellipse cx="200" cy="90" rx="25" ry="35" fill="#e2e8f0"/>
                <circle cx="200" cy="55" r="18" fill="#e2e8f0"/>
                <path d="M 110 75 Q 140 60 170 75" stroke="#6a9a6a" stroke-width="2" fill="none"/>
                <path d="M 115 80 Q 145 65 175 80" stroke="#6a9a6a" stroke-width="1.5" fill="none" opacity="0.7"/>
                <text x="90" y="125" text-anchor="middle" fill="#888" font-size="8">Radio</text>
                <text x="200" y="135" text-anchor="middle" fill="#888" font-size="8">Entend</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Source visible ou sugg√©r√©e dans la sc√®ne</text>
            </svg>`,
            example: 'La radio dans le taxi de Travis Bickle (Taxi Driver).'
        },
        'son-extra-diegetique': {
            title: 'Son extra-di√©g√©tique',
            description: `<p>Son ajout√© au film que les personnages n'entendent pas : musique de score, voix-off narrative.</p>
            <p>S'adresse <strong>directement au spectateur</strong>, guide ses √©motions, commente l'action.</p>
            <p>Outil puissant mais son usage excessif peut devenir manipulateur ou envahissant.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="40" y="50" width="160" height="90" fill="#2a3a4a" rx="5" stroke="#4a5a6a" stroke-width="2"/>
                <text x="120" y="45" text-anchor="middle" fill="#5a6a7a" font-size="9">MONDE DU FILM</text>
                <ellipse cx="120" cy="100" rx="25" ry="35" fill="#e2e8f0"/>
                <circle cx="120" cy="65" r="18" fill="#e2e8f0"/>
                <text x="120" y="145" text-anchor="middle" fill="#888" font-size="8">N entend pas</text>
                <g transform="translate(230, 70)">
                    <rect x="-20" y="0" width="40" height="50" fill="#5a5a3a" rx="3"/>
                    <path d="M -10 15 L -10 35 M 0 10 L 0 40 M 10 15 L 10 35" stroke="#8a8a5a" stroke-width="3"/>
                </g>
                <path d="M 210 95 Q 180 95 160 100" stroke="#9a6a6a" stroke-width="2" fill="none" stroke-dasharray="5,3"/>
                <text x="230" y="135" text-anchor="middle" fill="#9a6a6a" font-size="8">Musique</text>
                <text x="230" y="145" text-anchor="middle" fill="#9a6a6a" font-size="8">score</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Musique/voix-off pour le spectateur uniquement</text>
            </svg>`,
            example: 'La musique de John Williams dans Star Wars.'
        },
        // === SON - SOUND DESIGN ===
        'worldizing': {
            title: 'Worldizing',
            description: `<p>Technique invent√©e par Walter Murch consistant √† rejouer un son dans un espace r√©el et le r√©enregistrer.</p>
            <p>Donne au son les <strong>caract√©ristiques acoustiques</strong> d'un lieu : r√©verb√©ration, filtrage, coloration.</p>
            <p>Plus organique que les reverbs num√©riques car capture la vraie physique du son dans l'espace.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="40" width="70" height="50" fill="#3a4a5a" rx="3"/>
                <text x="55" y="70" text-anchor="middle" fill="#888" font-size="9">Source</text>
                <path d="M 90 65 L 120 65" stroke="#6a9a9a" stroke-width="2" marker-end="url(#arrowWorld)"/>
                <defs><marker id="arrowWorld" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#6a9a9a"/></marker></defs>
                <rect x="120" y="25" width="90" height="90" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <text x="165" y="50" text-anchor="middle" fill="#5a6a7a" font-size="8">ESPACE R√âEL</text>
                <ellipse cx="145" cy="75" rx="8" ry="12" fill="#6a6a7a"/>
                <path d="M 155 70 Q 175 55 190 70" stroke="#6a9a6a" stroke-width="1" fill="none" opacity="0.5"/>
                <path d="M 155 75 Q 180 60 200 75" stroke="#6a9a6a" stroke-width="1" fill="none" opacity="0.3"/>
                <circle cx="195" cy="80" r="8" fill="#5a5a6a"/>
                <path d="M 210 70 L 240 70" stroke="#9a6a6a" stroke-width="2" marker-end="url(#arrowWorld2)"/>
                <defs><marker id="arrowWorld2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#9a6a6a"/></marker></defs>
                <rect x="240" y="50" width="45" height="40" fill="#4a3a3a" rx="3"/>
                <text x="262" y="75" text-anchor="middle" fill="#888" font-size="8">R√©sultat</text>
                <text x="150" y="140" text-anchor="middle" fill="#888" font-size="9">Son ‚Üí Espace r√©el ‚Üí R√©enregistrement</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Technique de Walter Murch (Apocalypse Now)</text>
            </svg>`,
            example: 'Utilis√© pour les voix radio dans Apocalypse Now.'
        },
        'layering': {
            title: 'Layering (Superposition)',
            description: `<p>Technique de sound design consistant √† superposer plusieurs sons pour en cr√©er un nouveau, unique.</p>
            <p>Un son de monstre peut combiner : cri animal, m√©tal, voix humaine ralentie, grondement...</p>
            <p>Permet de cr√©er des sons <strong>in√©dits et √©vocateurs</strong> qui n'existent pas dans la r√©alit√©.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="30" width="100" height="25" fill="#5a4a4a" rx="3"/>
                <text x="80" y="47" text-anchor="middle" fill="#aaa" font-size="9">Son A (cri animal)</text>
                <rect x="30" y="60" width="100" height="25" fill="#4a5a4a" rx="3"/>
                <text x="80" y="77" text-anchor="middle" fill="#aaa" font-size="9">Son B (m√©tal)</text>
                <rect x="30" y="90" width="100" height="25" fill="#4a4a5a" rx="3"/>
                <text x="80" y="107" text-anchor="middle" fill="#aaa" font-size="9">Son C (voix)</text>
                <rect x="30" y="120" width="100" height="25" fill="#5a5a4a" rx="3"/>
                <text x="80" y="137" text-anchor="middle" fill="#aaa" font-size="9">Son D (rumble)</text>
                <path d="M 140 85 L 170 85" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowLayer)"/>
                <defs><marker id="arrowLayer" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <rect x="180" y="55" width="100" height="60" fill="#6a5a7a" rx="5" stroke="#8a6a9a" stroke-width="2"/>
                <text x="230" y="80" text-anchor="middle" fill="#fff" font-size="10">NOUVEAU</text>
                <text x="230" y="95" text-anchor="middle" fill="#fff" font-size="10">SON</text>
                <text x="230" y="130" text-anchor="middle" fill="#8a6a9a" font-size="9">= Monstre</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Combiner pour cr√©er l in√©dit</text>
            </svg>`,
            example: 'Le T-Rex de Jurassic Park = b√©b√© √©l√©phant + alligator + tigre.'
        },
        // === SON - FORMATS ===
        'surround-51': {
            title: '5.1 Surround',
            description: `<p>Format audio standard du cin√©ma avec 6 canaux : 5 enceintes + 1 caisson de basses (LFE).</p>
            <p>Configuration : Gauche, Centre, Droite (devant) + Surround Gauche, Surround Droite (arri√®re) + Subwoofer.</p>
            <p>Permet de <strong>placer les sons dans l'espace</strong> autour du spectateur pour une immersion totale.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="100" rx="120" ry="70" fill="none" stroke="#3a4a5a" stroke-width="1" stroke-dasharray="5,3"/>
                <rect x="60" y="35" width="20" height="30" fill="#5a7a5a" rx="2"/>
                <text x="70" y="75" text-anchor="middle" fill="#5a7a5a" font-size="8">L</text>
                <rect x="140" y="25" width="20" height="30" fill="#5a7a5a" rx="2"/>
                <text x="150" y="65" text-anchor="middle" fill="#5a7a5a" font-size="8">C</text>
                <rect x="220" y="35" width="20" height="30" fill="#5a7a5a" rx="2"/>
                <text x="230" y="75" text-anchor="middle" fill="#5a7a5a" font-size="8">R</text>
                <rect x="45" y="130" width="20" height="30" fill="#7a5a5a" rx="2"/>
                <text x="55" y="125" text-anchor="middle" fill="#7a5a5a" font-size="8">LS</text>
                <rect x="235" y="130" width="20" height="30" fill="#7a5a5a" rx="2"/>
                <text x="245" y="125" text-anchor="middle" fill="#7a5a5a" font-size="8">RS</text>
                <rect x="130" y="140" width="40" height="25" fill="#5a5a7a" rx="2"/>
                <text x="150" y="157" text-anchor="middle" fill="#fff" font-size="8">LFE</text>
                <circle cx="150" cy="100" r="8" fill="#e2e8f0"/>
                <text x="150" y="104" text-anchor="middle" fill="#1a1a2e" font-size="8">üë§</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">5 canaux + 1 subwoofer = immersion</text>
            </svg>`,
            example: 'Standard depuis Toy Story (1995) et Saving Private Ryan.'
        },
        'surround-51': {
            title: '5.1 Surround',
            description: `<p>Format audio standard du cin√©ma avec 6 canaux : 5 enceintes + 1 caisson de basses (LFE).</p>
            <p>Configuration : Gauche, Centre, Droite (devant) + Surround Gauche, Surround Droite (arri√®re) + Subwoofer.</p>
            <p>Permet de <strong>placer les sons dans l'espace</strong> autour du spectateur pour une immersion totale.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="100" rx="120" ry="70" fill="none" stroke="#3a4a5a" stroke-width="1" stroke-dasharray="5,3"/>
                <rect x="60" y="35" width="20" height="30" fill="#5a7a5a" rx="2"/>
                <text x="70" y="75" text-anchor="middle" fill="#5a7a5a" font-size="8">L</text>
                <rect x="140" y="25" width="20" height="30" fill="#5a7a5a" rx="2"/>
                <text x="150" y="65" text-anchor="middle" fill="#5a7a5a" font-size="8">C</text>
                <rect x="220" y="35" width="20" height="30" fill="#5a7a5a" rx="2"/>
                <text x="230" y="75" text-anchor="middle" fill="#5a7a5a" font-size="8">R</text>
                <rect x="45" y="130" width="20" height="30" fill="#7a5a5a" rx="2"/>
                <text x="55" y="125" text-anchor="middle" fill="#7a5a5a" font-size="8">LS</text>
                <rect x="235" y="130" width="20" height="30" fill="#7a5a5a" rx="2"/>
                <text x="245" y="125" text-anchor="middle" fill="#7a5a5a" font-size="8">RS</text>
                <rect x="130" y="140" width="40" height="25" fill="#5a5a7a" rx="2"/>
                <text x="150" y="157" text-anchor="middle" fill="#fff" font-size="8">LFE</text>
                <circle cx="150" cy="100" r="8" fill="#e2e8f0"/>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">5 canaux + 1 subwoofer = immersion</text>
            </svg>`,
            example: 'Standard depuis Toy Story (1995) et Saving Private Ryan.'
        },
        'meta-diegetique': {
            title: 'Son m√©ta-di√©g√©tique',
            description: `<p>Son subjectif repr√©sentant l'int√©riorit√© d'un personnage : pens√©es, souvenirs, hallucinations.</p>
            <p>Le personnage l'entend mais pas les autres : <strong>acouph√®ne, battement de c≈ìur, voix int√©rieure, flashback sonore</strong>.</p>
            <p>Permet d'acc√©der √† la psychologie du personnage de mani√®re immersive.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="150" cy="80" r="50" fill="#3a4a5a"/>
                <circle cx="150" cy="60" r="30" fill="#e2e8f0"/>
                <ellipse cx="150" cy="100" rx="25" ry="30" fill="#d2d8e0"/>
                <circle cx="150" cy="80" r="60" fill="none" stroke="#8a5a8a" stroke-width="2" stroke-dasharray="5,3"/>
                <circle cx="150" cy="80" r="70" fill="none" stroke="#8a5a8a" stroke-width="1" stroke-dasharray="3,3" opacity="0.5"/>
                <text x="150" y="35" text-anchor="middle" fill="#8a5a8a" font-size="8">‚ô™ Souvenirs ‚ô™</text>
                <text x="80" y="80" fill="#8a5a8a" font-size="7">üí≠</text>
                <text x="215" y="80" fill="#8a5a8a" font-size="7">üí≠</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Son int√©rieur du personnage</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Acouph√®ne, battement, voix int√©rieure</text>
            </svg>`,
            example: 'L acouph√®ne apr√®s l explosion dans Saving Private Ryan.'
        },
        'wild-tracks': {
            title: 'Wild Tracks',
            description: `<p>Enregistrements sonores r√©alis√©s sans image, captant ambiances, effets ou dialogues s√©par√©ment.</p>
            <p>Permet de <strong>compl√©ter la bande-son</strong> en post-production avec des sons propres et isol√©s.</p>
            <p>L'ing√©nieur du son profite des pauses pour enregistrer l'ambiance du lieu, des sons sp√©cifiques.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="40" width="100" height="70" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <rect x="45" y="55" width="70" height="40" fill="#1a1a2a"/>
                <line x1="50" y1="75" x2="60" y2="65" stroke="#5a8a5a" stroke-width="2"/>
                <line x1="60" y1="65" x2="70" y2="80" stroke="#5a8a5a" stroke-width="2"/>
                <line x1="70" y1="80" x2="80" y2="70" stroke="#5a8a5a" stroke-width="2"/>
                <line x1="80" y1="70" x2="90" y2="85" stroke="#5a8a5a" stroke-width="2"/>
                <line x1="90" y1="85" x2="100" y2="72" stroke="#5a8a5a" stroke-width="2"/>
                <line x1="100" y1="72" x2="110" y2="78" stroke="#5a8a5a" stroke-width="2"/>
                <circle cx="80" cy="130" r="6" fill="#ff6b6b"/>
                <text x="80" y="150" text-anchor="middle" fill="#ff6b6b" font-size="8">REC</text>
                <rect x="170" y="50" width="100" height="60" fill="#3a3a3a" rx="3"/>
                <line x1="185" y1="80" x2="255" y2="80" stroke="#4a4a4a" stroke-width="20"/>
                <text x="220" y="85" text-anchor="middle" fill="#666" font-size="8">PAS D IMAGE</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Son seul - sans cam√©ra</text>
            </svg>`,
            example: 'Ambiances de rue, bruits de machines, room tone.'
        },
        'pitch-shifting': {
            title: 'Pitch Shifting',
            description: `<p>Modification de la hauteur (fr√©quence) d'un son sans changer sa dur√©e, ou inversement.</p>
            <p>Ralentir un son le rend plus <strong>grave et mena√ßant</strong>. L'acc√©l√©rer le rend aigu et √©nergique.</p>
            <p>Technique fondamentale du sound design pour cr√©er des sons de cr√©atures, monstres, vaisseaux.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <text x="50" y="50" fill="#5a8a5a" font-size="12">üêï</text>
                <path d="M 70 50 Q 100 50 100 50" stroke="#5a8a5a" stroke-width="2"/>
                <text x="110" y="55" fill="#5a8a5a" font-size="9">Aboiement</text>
                <path d="M 150 60 L 150 90" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowPitch)"/>
                <defs><marker id="arrowPitch" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#ff6b6b"/></marker></defs>
                <text x="165" y="80" fill="#ff6b6b" font-size="8">Ralenti</text>
                <text x="50" y="130" fill="#8a5a5a" font-size="16">üëπ</text>
                <path d="M 75 125 Q 110 125 110 125" stroke="#8a5a5a" stroke-width="2"/>
                <text x="120" y="130" fill="#8a5a5a" font-size="9">Grognement monstre</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Modifier la hauteur du son</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Cri animal ralenti = cr√©ature</text>
            </svg>`,
            example: 'Le T-Rex (b√©b√© √©l√©phant ralenti), Godzilla.'
        },
        'leitmotiv-sonore': {
            title: 'Leitmotiv sonore',
            description: `<p>Son ou motif musical r√©current associ√© √† un personnage, un lieu, une √©motion ou un th√®me.</p>
            <p>Cr√©e une <strong>association pavlovienne</strong> : le spectateur reconna√Æt le motif et anticipe.</p>
            <p>Peut √™tre subtil (texture, fr√©quence) ou √©vident (th√®me musical complet).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="70" cy="70" r="30" fill="#4a5a6a"/>
                <circle cx="70" cy="50" r="18" fill="#e2e8f0"/>
                <text x="70" y="110" text-anchor="middle" fill="#888" font-size="8">Personnage A</text>
                <circle cx="230" cy="70" r="30" fill="#5a4a4a"/>
                <circle cx="230" cy="50" r="18" fill="#d2c8c0"/>
                <text x="230" y="110" text-anchor="middle" fill="#888" font-size="8">Personnage B</text>
                <rect x="50" y="125" width="40" height="25" fill="#5a7a5a" rx="3"/>
                <text x="70" y="142" text-anchor="middle" fill="#fff" font-size="8">‚ô™ A ‚ô™</text>
                <rect x="210" y="125" width="40" height="25" fill="#7a5a5a" rx="3"/>
                <text x="230" y="142" text-anchor="middle" fill="#fff" font-size="8">‚ô™ B ‚ô™</text>
                <path d="M 70 95 L 70 125" stroke="#5a7a5a" stroke-width="2" stroke-dasharray="3,3"/>
                <path d="M 230 95 L 230 125" stroke="#7a5a5a" stroke-width="2" stroke-dasharray="3,3"/>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Motif r√©current = association</text>
            </svg>`,
            example: 'La Marche Imp√©riale (Vader), le th√®me des Dents de la Mer.'
        },
        'micro-omni': {
            title: 'Micro omnidirectionnel',
            description: `<p>Microphone captant le son de mani√®re √©gale dans toutes les directions (360¬∞).</p>
            <p>Id√©al pour les <strong>ambiances</strong>, les enregistrements d'ensemble, ou quand la direction change constamment.</p>
            <p>Moins sensible aux bruits de manipulation mais capte aussi les sons ind√©sirables environnants.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="150" cy="90" r="15" fill="#4a4a4a"/>
                <circle cx="150" cy="90" r="8" fill="#3a3a3a"/>
                <circle cx="150" cy="90" r="40" fill="none" stroke="#5a8a5a" stroke-width="2" stroke-dasharray="5,3"/>
                <circle cx="150" cy="90" r="55" fill="none" stroke="#5a8a5a" stroke-width="1" stroke-dasharray="3,3" opacity="0.6"/>
                <circle cx="150" cy="90" r="70" fill="none" stroke="#5a8a5a" stroke-width="1" stroke-dasharray="3,3" opacity="0.3"/>
                <path d="M 150 50 L 150 35" stroke="#5a8a5a" stroke-width="2" marker-end="url(#arrowOmni)"/>
                <path d="M 190 90 L 205 90" stroke="#5a8a5a" stroke-width="2" marker-end="url(#arrowOmni)"/>
                <path d="M 150 130 L 150 145" stroke="#5a8a5a" stroke-width="2" marker-end="url(#arrowOmni)"/>
                <path d="M 110 90 L 95 90" stroke="#5a8a5a" stroke-width="2" marker-end="url(#arrowOmni)"/>
                <defs><marker id="arrowOmni" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="#5a8a5a"/></marker></defs>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Capte dans toutes les directions</text>
            </svg>`,
            example: 'Enregistrement d ambiances, micros cravate.'
        },
        'double-systeme': {
            title: 'Double syst√®me',
            description: `<p>Enregistrement du son sur un appareil s√©par√© de la cam√©ra (enregistreur externe type Sound Devices).</p>
            <p>Qualit√© <strong>professionnelle sup√©rieure</strong> aux pr√©amplis int√©gr√©s des cam√©ras. Standard sur les tournages pro.</p>
            <p>N√©cessite une synchronisation en post (clap, timecode). Le son cam√©ra sert de r√©f√©rence.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="40" y="50" width="80" height="60" fill="#3a3a3a" rx="5"/>
                <circle cx="80" cy="80" r="15" fill="#2a2a2a"/>
                <circle cx="80" cy="80" r="8" fill="#4a4a4a"/>
                <text x="80" y="125" text-anchor="middle" fill="#888" font-size="8">Cam√©ra</text>
                <text x="80" y="137" text-anchor="middle" fill="#666" font-size="7">(son t√©moin)</text>
                <rect x="180" y="50" width="80" height="60" fill="#4a5a4a" rx="5" stroke="#5a8a5a" stroke-width="2"/>
                <rect x="195" y="65" width="50" height="10" fill="#2a3a2a"/>
                <rect x="195" y="80" width="50" height="10" fill="#2a3a2a"/>
                <circle cx="200" y="70" r="3" fill="#5a8a5a"/>
                <circle cx="200" y="85" r="3" fill="#5a8a5a"/>
                <text x="220" y="125" text-anchor="middle" fill="#5a8a5a" font-size="8">Enregistreur</text>
                <text x="220" y="137" text-anchor="middle" fill="#5a8a5a" font-size="7">(son master)</text>
                <path d="M 125 80 L 175 80" stroke="#ff6b6b" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="150" y="75" text-anchor="middle" fill="#ff6b6b" font-size="7">Sync</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Qualit√© pro - synchronisation en post</text>
            </svg>`,
            example: 'Standard sur tous les tournages cin√©ma.'
        },
        'ducking': {
            title: 'Ducking',
            description: `<p>Technique de mixage o√π un signal audio baisse automatiquement quand un autre est pr√©sent.</p>
            <p>Usage classique : la <strong>musique baisse sous les dialogues</strong> puis remonte quand ils s'arr√™tent.</p>
            <p>Peut √™tre fait manuellement ou via un compresseur side-chain en temps r√©el.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <text x="30" y="30" fill="#5a8a5a" font-size="9">Dialogue</text>
                <rect x="30" y="35" width="240" height="25" fill="#2a3a2a" rx="3"/>
                <rect x="80" y="40" width="60" height="15" fill="#5a8a5a" rx="2"/>
                <rect x="180" y="40" width="40" height="15" fill="#5a8a5a" rx="2"/>
                <text x="30" y="85" fill="#8a5a5a" font-size="9">Musique</text>
                <rect x="30" y="90" width="240" height="25" fill="#3a2a2a" rx="3"/>
                <path d="M 30 102 L 75 102 L 80 110 L 140 110 L 145 102 L 175 102 L 180 110 L 220 110 L 225 102 L 270 102" stroke="#8a5a5a" stroke-width="3" fill="none"/>
                <path d="M 110 60 L 110 90" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="3,2"/>
                <path d="M 200 60 L 200 90" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="3,2"/>
                <text x="150" y="145" text-anchor="middle" fill="#888" font-size="9">La musique baisse sous les dialogues</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Automatique ou manuel au mixage</text>
            </svg>`,
            example: 'Toutes les sc√®nes dialogue + musique au cin√©ma.'
        },
        'stems': {
            title: 'Stems (Pr√©mix)',
            description: `<p>Groupes de pistes audio s√©par√©s par cat√©gorie : Dialogues (DX), Musique (MX), Effets (FX).</p>
            <p>Permet de cr√©er des <strong>versions internationales</strong> (VI) en rempla√ßant uniquement les dialogues.</p>
            <p>Livrables essentiels pour la distribution : le mixage final peut √™tre reconstitu√© depuis les stems.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="30" width="70" height="35" fill="#5a7a5a" rx="5"/>
                <text x="65" y="52" text-anchor="middle" fill="#fff" font-size="10">DX</text>
                <text x="65" y="75" text-anchor="middle" fill="#5a7a5a" font-size="7">Dialogues</text>
                <rect x="115" y="30" width="70" height="35" fill="#7a5a7a" rx="5"/>
                <text x="150" y="52" text-anchor="middle" fill="#fff" font-size="10">MX</text>
                <text x="150" y="75" text-anchor="middle" fill="#7a5a7a" font-size="7">Musique</text>
                <rect x="200" y="30" width="70" height="35" fill="#5a5a7a" rx="5"/>
                <text x="235" y="52" text-anchor="middle" fill="#fff" font-size="10">FX</text>
                <text x="235" y="75" text-anchor="middle" fill="#5a5a7a" font-size="7">Effets</text>
                <path d="M 65 65 L 65 100 L 150 115" stroke="#5a7a5a" stroke-width="2"/>
                <path d="M 150 65 L 150 115" stroke="#7a5a7a" stroke-width="2"/>
                <path d="M 235 65 L 235 100 L 150 115" stroke="#5a5a7a" stroke-width="2"/>
                <rect x="100" y="115" width="100" height="35" fill="#4a4a4a" rx="5" stroke="#8a8a8a" stroke-width="2"/>
                <text x="150" y="137" text-anchor="middle" fill="#fff" font-size="10">MIX FINAL</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">S√©paration pour versions internationales</text>
            </svg>`,
            example: 'Livrable obligatoire pour toute distribution internationale.'
        },
        'dolby-atmos': {
            title: 'Dolby Atmos',
            description: `<p>Format audio immersif bas√© sur des "objets sonores" positionnables en 3D, incluant le plafond.</p>
            <p>Contrairement au 5.1/7.1 bas√© sur des canaux, Atmos place chaque son pr√©cis√©ment dans l'espace <strong>x, y, z</strong>.</p>
            <p>Permet des effets de survol, de pluie tombant du plafond, de son qui se d√©place avec pr√©cision.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="50" y="30" width="200" height="120" fill="none" stroke="#4a5a6a" stroke-width="2" rx="5"/>
                <line x1="50" y1="30" x2="80" y2="10" stroke="#4a5a6a" stroke-width="1"/>
                <line x1="250" y1="30" x2="280" y2="10" stroke="#4a5a6a" stroke-width="1"/>
                <line x1="80" y1="10" x2="280" y2="10" stroke="#4a5a6a" stroke-width="2"/>
                <rect x="120" y="15" width="15" height="10" fill="#7a7a5a" rx="1"/>
                <rect x="165" y="15" width="15" height="10" fill="#7a7a5a" rx="1"/>
                <text x="150" y="8" text-anchor="middle" fill="#7a7a5a" font-size="8">PLAFOND</text>
                <circle cx="100" cy="90" r="5" fill="#ff6b6b"/>
                <path d="M 100 90 Q 150 50 200 90 Q 180 120 120 110 Q 100 100 100 90" stroke="#ff6b6b" stroke-width="1" fill="none" stroke-dasharray="3,2"/>
                <text x="100" y="110" fill="#ff6b6b" font-size="7">Objet</text>
                <circle cx="150" cy="110" r="8" fill="#e2e8f0"/>
                <text x="150" y="114" text-anchor="middle" fill="#1a1a2e" font-size="8">üë§</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Son objet en 3D - incluant hauteur</text>
            </svg>`,
            example: 'Gravity, Blade Runner 2049, Dune.'
        },
        // === MONTAGE - RACCORDS ===
        'raccord-regard': {
            title: 'Raccord regard',
            description: `<p>Technique de montage o√π l'on montre d'abord un personnage qui regarde, puis ce qu'il voit.</p>
            <p>Cr√©e un lien <strong>psychologique</strong> entre le spectateur et le personnage : on partage son point de vue.</p>
            <p>Le regard doit √™tre coh√©rent en direction : s'il regarde √† droite, l'objet doit "venir" de la gauche.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="30" width="110" height="80" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <circle cx="75" cy="60" r="25" fill="#e2e8f0"/>
                <circle cx="85" cy="55" r="5" fill="#2a2a3e"/>
                <path d="M 90 55 L 120 45" stroke="#ff6b6b" stroke-width="2"/>
                <text x="75" y="100" text-anchor="middle" fill="#888" font-size="9">Plan 1: Regard</text>
                <rect x="170" y="30" width="110" height="80" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <circle cx="225" cy="70" r="20" fill="#ffd700"/>
                <text x="225" y="100" text-anchor="middle" fill="#888" font-size="9">Plan 2: Objet vu</text>
                <path d="M 135 70 L 165 70" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowReg)"/>
                <defs><marker id="arrowReg" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <text x="150" y="140" text-anchor="middle" fill="#ff6b6b" font-size="10">CUT</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">On voit ce que le personnage regarde</text>
            </svg>`,
            example: 'Hitchcock √©tait ma√Ætre du raccord regard (Fen√™tre sur cour).'
        },
        'match-cut': {
            title: 'Match Cut',
            description: `<p>Raccord qui relie deux plans par une similarit√© visuelle : forme, mouvement, couleur ou composition.</p>
            <p>Cr√©e une <strong>transition po√©tique</strong> et peut sugg√©rer un lien th√©matique entre deux √©l√©ments distincts.</p>
            <p>Souvent utilis√© pour les ellipses temporelles ou les associations d'id√©es.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="30" width="110" height="80" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <ellipse cx="75" cy="70" rx="35" ry="25" fill="#e2e8f0"/>
                <text x="75" y="75" text-anchor="middle" fill="#2a2a3e" font-size="10">Os</text>
                <rect x="170" y="30" width="110" height="80" fill="#1a1a3e" rx="5" stroke="#4a5a6a"/>
                <ellipse cx="225" cy="70" rx="35" ry="25" fill="#aaaacc"/>
                <text x="225" y="75" text-anchor="middle" fill="#2a2a3e" font-size="8">Station</text>
                <path d="M 135 70 L 165 70" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowMatch)"/>
                <defs><marker id="arrowMatch" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <text x="75" y="115" text-anchor="middle" fill="#888" font-size="8">Pr√©histoire</text>
                <text x="225" y="115" text-anchor="middle" fill="#888" font-size="8">Futur</text>
                <text x="150" y="140" text-anchor="middle" fill="#ff6b6b" font-size="9">M√™me forme = lien</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">2001 : L os devient station spatiale</text>
            </svg>`,
            example: '2001 de Kubrick : l os pr√©historique ‚Üí station spatiale.'
        },
        'jump-cut': {
            title: 'Jump Cut',
            description: `<p>Coupe entre deux plans tr√®s similaires du m√™me sujet, cr√©ant un "saut" visuel perturbant.</p>
            <p>Traditionnellement consid√©r√© comme une <strong>erreur</strong>, il est devenu un outil stylistique depuis la Nouvelle Vague.</p>
            <p>Exprime l'urgence, le passage du temps, l'instabilit√© mentale, ou brise volontairement l'illusion.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="35" width="75" height="60" fill="#2a3a4a" rx="3" stroke="#4a5a6a"/>
                <circle cx="57" cy="55" r="15" fill="#e2e8f0"/>
                <circle cx="57" cy="75" r="10" fill="#e2e8f0"/>
                <rect x="112" y="35" width="75" height="60" fill="#2a3a4a" rx="3" stroke="#4a5a6a"/>
                <circle cx="149" cy="58" r="15" fill="#e2e8f0"/>
                <circle cx="149" cy="78" r="10" fill="#e2e8f0"/>
                <rect x="205" y="35" width="75" height="60" fill="#2a3a4a" rx="3" stroke="#4a5a6a"/>
                <circle cx="242" cy="52" r="15" fill="#e2e8f0"/>
                <circle cx="242" cy="72" r="10" fill="#e2e8f0"/>
                <path d="M 95 65 L 112 65" stroke="#ff6b6b" stroke-width="2"/>
                <path d="M 187 65 L 205 65" stroke="#ff6b6b" stroke-width="2"/>
                <text x="103" y="55" text-anchor="middle" fill="#ff6b6b" font-size="12">‚ö°</text>
                <text x="196" y="55" text-anchor="middle" fill="#ff6b6b" font-size="12">‚ö°</text>
                <text x="150" y="115" text-anchor="middle" fill="#ff6b6b" font-size="9">M√™me sujet, l√©gers changements = saut</text>
                <text x="150" y="145" text-anchor="middle" fill="#888" font-size="9">Erreur classique ‚Üí Style Nouvelle Vague</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">√Ä bout de souffle de Godard (1960)</text>
            </svg>`,
            example: 'Godard dans √Ä bout de souffle - r√©volution stylistique.'
        },
        'champ-contrechamp': {
            title: 'Champ / Contre-champ',
            description: `<p>Alternance entre deux points de vue oppos√©s, typiquement lors d'un dialogue entre deux personnages.</p>
            <p>Technique <strong>fondamentale</strong> du cin√©ma narratif. Chaque personnage est film√© s√©par√©ment regardant vers l'autre.</p>
            <p>Doit respecter la r√®gle des 180¬∞ pour maintenir la coh√©rence spatiale.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="30" width="110" height="70" fill="#2a3a4a" rx="5" stroke="#5a8a5a"/>
                <ellipse cx="85" cy="60" rx="25" ry="30" fill="#e2e8f0"/>
                <circle cx="85" cy="40" r="15" fill="#e2e8f0"/>
                <ellipse cx="40" cy="70" rx="10" ry="15" fill="#8a8a9a" opacity="0.5"/>
                <text x="75" y="110" text-anchor="middle" fill="#5a8a5a" font-size="9">CHAMP (A)</text>
                <rect x="170" y="30" width="110" height="70" fill="#2a3a4a" rx="5" stroke="#8a5a5a"/>
                <ellipse cx="215" cy="60" rx="25" ry="30" fill="#c2c8d0"/>
                <circle cx="215" cy="40" r="15" fill="#c2c8d0"/>
                <ellipse cx="260" cy="70" rx="10" ry="15" fill="#8a8a9a" opacity="0.5"/>
                <text x="225" y="110" text-anchor="middle" fill="#8a5a5a" font-size="9">CONTRE-CHAMP (B)</text>
                <path d="M 130 60 L 145 50 L 145 70 Z" fill="#ff6b6b"/>
                <path d="M 170 60 L 155 50 L 155 70 Z" fill="#ff6b6b"/>
                <text x="150" y="145" text-anchor="middle" fill="#888" font-size="9">Alternance des points de vue</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Base de toute sc√®ne de dialogue</text>
            </svg>`,
            example: 'Pr√©sent dans 90% des sc√®nes de dialogue au cin√©ma.'
        },
        // === MONTAGE - TH√âORIES ===
        'effet-koulechov': {
            title: 'Effet Koulechov',
            description: `<p>Exp√©rience de Lev Koulechov (ann√©es 1920) prouvant que le sens na√Æt du montage, pas des plans isol√©s.</p>
            <p>Un m√™me visage neutre juxtapos√© √† diff√©rentes images (soupe, cercueil, enfant) est per√ßu comme exprimant faim, tristesse ou tendresse.</p>
            <p>D√©montre que le spectateur <strong>cr√©e le sens</strong> en connectant mentalement les plans.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="25" width="60" height="45" fill="#2a3a4a" rx="3"/>
                <circle cx="50" cy="42" r="12" fill="#e2e8f0"/>
                <circle cx="46" cy="39" r="2" fill="#2a2a3e"/>
                <circle cx="54" cy="39" r="2" fill="#2a2a3e"/>
                <line x1="46" y1="48" x2="54" y2="48" stroke="#2a2a3e" stroke-width="1"/>
                <text x="50" y="80" text-anchor="middle" fill="#888" font-size="7">Visage neutre</text>
                <rect x="95" y="25" width="50" height="35" fill="#3a4a3a" rx="3"/>
                <ellipse cx="120" cy="42" rx="15" ry="10" fill="#8a9a7a"/>
                <text x="120" y="70" text-anchor="middle" fill="#5a8a5a" font-size="7">+ Soupe</text>
                <text x="120" y="80" text-anchor="middle" fill="#5a8a5a" font-size="7">= FAIM</text>
                <rect x="160" y="25" width="50" height="35" fill="#4a3a3a" rx="3"/>
                <rect x="175" y="32" width="20" height="20" fill="#5a4a4a"/>
                <text x="185" y="70" text-anchor="middle" fill="#8a5a5a" font-size="7">+ Cercueil</text>
                <text x="185" y="80" text-anchor="middle" fill="#8a5a5a" font-size="7">= TRISTESSE</text>
                <rect x="225" y="25" width="50" height="35" fill="#3a3a4a" rx="3"/>
                <circle cx="250" cy="42" r="10" fill="#e2d8c8"/>
                <text x="250" y="70" text-anchor="middle" fill="#5a5a8a" font-size="7">+ Enfant</text>
                <text x="250" y="80" text-anchor="middle" fill="#5a5a8a" font-size="7">= TENDRESSE</text>
                <text x="150" y="110" text-anchor="middle" fill="#ff6b6b" font-size="10">M√™me visage = √©motions diff√©rentes</text>
                <text x="150" y="140" text-anchor="middle" fill="#888" font-size="9">Le montage CR√âE le sens</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Base th√©orique du cin√©ma sovi√©tique</text>
            </svg>`,
            example: 'Fondement du cin√©ma sovi√©tique (Eisenstein, Poudovkine).'
        },
        'montage-parallele': {
            title: 'Montage parall√®le (Cross-cutting)',
            description: `<p>Alternance entre deux ou plusieurs actions se d√©roulant simultan√©ment dans des lieux diff√©rents.</p>
            <p>Cr√©e la <strong>tension</strong> (course contre la montre), la <strong>comparaison</strong> (riches vs pauvres) ou le <strong>suspense</strong>.</p>
            <p>Invent√© par D.W. Griffith, c'est devenu un outil narratif fondamental.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="25" width="80" height="50" fill="#3a4a3a" rx="3" stroke="#5a8a5a"/>
                <text x="60" y="55" text-anchor="middle" fill="#8a8a8a" font-size="9">Action A</text>
                <rect x="110" y="25" width="80" height="50" fill="#4a3a3a" rx="3" stroke="#8a5a5a"/>
                <text x="150" y="55" text-anchor="middle" fill="#8a8a8a" font-size="9">Action B</text>
                <rect x="200" y="25" width="80" height="50" fill="#3a4a3a" rx="3" stroke="#5a8a5a"/>
                <text x="240" y="55" text-anchor="middle" fill="#8a8a8a" font-size="9">Action A</text>
                <rect x="65" y="85" width="80" height="50" fill="#4a3a3a" rx="3" stroke="#8a5a5a"/>
                <text x="105" y="115" text-anchor="middle" fill="#8a8a8a" font-size="9">Action B</text>
                <rect x="155" y="85" width="80" height="50" fill="#3a4a3a" rx="3" stroke="#5a8a5a"/>
                <text x="195" y="115" text-anchor="middle" fill="#8a8a8a" font-size="9">Action A</text>
                <path d="M 100 50 L 110 50" stroke="#ff6b6b" stroke-width="2"/>
                <path d="M 190 50 L 200 50" stroke="#ff6b6b" stroke-width="2"/>
                <path d="M 145 85 L 155 85" stroke="#ff6b6b" stroke-width="2"/>
                <text x="150" y="155" text-anchor="middle" fill="#888" font-size="9">Alternance = simultan√©it√© + tension</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Course-poursuite, sauvetage in extremis</text>
            </svg>`,
            example: 'Le Parrain : bapt√™me + assassinats. Inception : r√™ves imbriqu√©s.'
        },
        // === MONTAGE - TECHNIQUES ===
        'ellipse': {
            title: 'Ellipse',
            description: `<p>Saut temporel entre deux plans, omettant une partie de l'action jug√©e non essentielle.</p>
            <p>Permet l'<strong>√©conomie narrative</strong> : on ne montre pas le trajet, la nuit de sommeil, les ann√©es qui passent.</p>
            <p>L'ellipse peut √™tre de quelques secondes (sauter une action banale) ou de plusieurs ann√©es.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="40" width="100" height="60" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <circle cx="70" cy="60" r="15" fill="#e2e8f0"/>
                <text x="70" y="65" text-anchor="middle" fill="#2a2a3e" font-size="10">üë∂</text>
                <text x="70" y="90" text-anchor="middle" fill="#888" font-size="8">B√©b√©</text>
                <rect x="180" y="40" width="100" height="60" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <circle cx="230" cy="55" r="12" fill="#e2e8f0"/>
                <ellipse cx="230" cy="75" rx="10" ry="15" fill="#d2d8e0"/>
                <text x="230" y="90" text-anchor="middle" fill="#888" font-size="8">Adulte</text>
                <text x="150" y="70" text-anchor="middle" fill="#ff6b6b" font-size="24">...</text>
                <text x="150" y="95" text-anchor="middle" fill="#ff6b6b" font-size="9">20 ans</text>
                <text x="150" y="130" text-anchor="middle" fill="#888" font-size="9">On saute le non-essentiel</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">√âconomie narrative - le temps passe</text>
            </svg>`,
            example: '2001 : l os lanc√© en l air ‚Üí station spatiale (millions d ann√©es).'
        },
        'l-cut-j-cut': {
            title: 'L-Cut / J-Cut',
            description: `<p>Techniques o√π le son et l'image ne coupent pas au m√™me moment, cr√©ant un chevauchement.</p>
            <p><strong>L-Cut</strong> : l'image change mais le son du plan pr√©c√©dent continue. <strong>J-Cut</strong> : le son du plan suivant commence avant l'image.</p>
            <p>Fluidifie les transitions et cr√©e de l'anticipation ou de la continuit√© √©motionnelle.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <text x="150" y="20" text-anchor="middle" fill="#888" font-size="11">L-CUT</text>
                <rect x="30" y="30" width="100" height="30" fill="#5a7a5a" rx="3"/>
                <text x="80" y="50" text-anchor="middle" fill="#fff" font-size="9">Image A</text>
                <rect x="130" y="30" width="100" height="30" fill="#7a5a5a" rx="3"/>
                <text x="180" y="50" text-anchor="middle" fill="#fff" font-size="9">Image B</text>
                <rect x="30" y="65" width="140" height="20" fill="#3a5a3a" rx="2"/>
                <text x="100" y="79" text-anchor="middle" fill="#aaa" font-size="8">Son A (continue)</text>
                <rect x="170" y="65" width="60" height="20" fill="#5a3a3a" rx="2"/>
                <text x="200" y="79" text-anchor="middle" fill="#aaa" font-size="8">Son B</text>
                <text x="150" y="105" text-anchor="middle" fill="#888" font-size="11">J-CUT</text>
                <rect x="30" y="115" width="100" height="30" fill="#5a7a5a" rx="3"/>
                <text x="80" y="135" text-anchor="middle" fill="#fff" font-size="9">Image A</text>
                <rect x="130" y="115" width="100" height="30" fill="#7a5a5a" rx="3"/>
                <text x="180" y="135" text-anchor="middle" fill="#fff" font-size="9">Image B</text>
                <rect x="30" y="150" width="60" height="20" fill="#3a5a3a" rx="2"/>
                <text x="60" y="164" text-anchor="middle" fill="#aaa" font-size="8">Son A</text>
                <rect x="90" y="150" width="140" height="20" fill="#5a3a3a" rx="2"/>
                <text x="160" y="164" text-anchor="middle" fill="#aaa" font-size="8">Son B (anticipe)</text>
            </svg>`,
            example: 'Omnipr√©sent dans les dialogues de films modernes.'
        },
        // === MONTAGE - WORKFLOW ===
        'picture-lock': {
            title: 'Picture Lock',
            description: `<p>Moment o√π le montage image est d√©finitivement valid√©. Plus aucune modification de dur√©e ou d'ordre des plans.</p>
            <p>√âtape <strong>cruciale</strong> car elle d√©clenche la post-production lourde : √©talonnage, VFX, mixage son.</p>
            <p>Apr√®s le picture lock, tout changement co√ªte tr√®s cher car il impacte tous les d√©partements.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="40" width="50" height="30" fill="#4a5a6a" rx="2"/>
                <rect x="85" y="40" width="40" height="30" fill="#5a6a7a" rx="2"/>
                <rect x="130" y="40" width="60" height="30" fill="#4a5a6a" rx="2"/>
                <rect x="195" y="40" width="45" height="30" fill="#5a6a7a" rx="2"/>
                <rect x="245" y="40" width="35" height="30" fill="#4a5a6a" rx="2"/>
                <rect x="25" y="35" width="260" height="40" fill="none" stroke="#ff6b6b" stroke-width="3" rx="5"/>
                <text x="150" y="58" text-anchor="middle" fill="#ff6b6b" font-size="12">üîí</text>
                <text x="150" y="95" text-anchor="middle" fill="#ff6b6b" font-size="11">VERROUILL√â</text>
                <path d="M 150 105 L 150 125" stroke="#888" stroke-width="2"/>
                <path d="M 80 130 L 150 125 L 220 130" stroke="#888" stroke-width="1"/>
                <text x="60" y="150" text-anchor="middle" fill="#888" font-size="8">√âtalonnage</text>
                <text x="150" y="150" text-anchor="middle" fill="#888" font-size="8">VFX</text>
                <text x="240" y="150" text-anchor="middle" fill="#888" font-size="8">Mixage</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">D√©clenche la post-production finale</text>
            </svg>`,
            example: 'Modifier apr√®s picture lock peut co√ªter des milliers d euros.'
        },
        'etalonnage': {
            title: '√âtalonnage (Color Grading)',
            description: `<p>Correction colorim√©trique et cr√©ation du "look" visuel final du film en post-production.</p>
            <p>Deux √©tapes : <strong>correction primaire</strong> (√©quilibrer les plans) et <strong>secondaire</strong> (cr√©er l'atmosph√®re, styliser).</p>
            <p>Peut transformer radicalement l'ambiance : froid/chaud, d√©satur√©, teal & orange, etc.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="30" width="100" height="70" fill="#5a6a5a" rx="5"/>
                <ellipse cx="70" cy="60" rx="25" ry="20" fill="#8a9a8a"/>
                <circle cx="70" cy="45" r="12" fill="#9aaa9a"/>
                <text x="70" y="115" text-anchor="middle" fill="#888" font-size="9">Brut (LOG/RAW)</text>
                <rect x="180" y="30" width="100" height="70" fill="#4a3a2a" rx="5"/>
                <ellipse cx="230" cy="60" rx="25" ry="20" fill="#d4a060"/>
                <circle cx="230" cy="45" r="12" fill="#e8b878"/>
                <text x="230" y="115" text-anchor="middle" fill="#888" font-size="9">√âtalonn√© (chaud)</text>
                <path d="M 125 65 L 175 65" stroke="#ff6b6b" stroke-width="3" marker-end="url(#arrowEtal)"/>
                <defs><marker id="arrowEtal" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <text x="150" y="55" text-anchor="middle" fill="#ff6b6b" font-size="8">Grade</text>
                <text x="150" y="145" text-anchor="middle" fill="#888" font-size="9">Cr√©e l atmosph√®re et le style visuel</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">DaVinci Resolve = standard industrie</text>
            </svg>`,
            example: 'Le look orange/teal de Mad Max Fury Road. Le d√©satur√© de Saving Private Ryan.'
        },
        // === SC√âNARIO - STRUCTURE ===
        'structure-3-actes': {
            title: 'Structure en 3 Actes',
            description: `<p>Mod√®le dramaturgique fondamental divisant le r√©cit en trois parties : Exposition, Confrontation, R√©solution.</p>
            <p>H√©rit√© de la <strong>Po√©tique d'Aristote</strong> (d√©but, milieu, fin), c'est la structure dominante du cin√©ma narratif classique.</p>
            <p>Proportions classiques : Acte I (25%), Acte II (50%), Acte III (25%).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <line x1="30" y1="140" x2="270" y2="140" stroke="#4a5a6a" stroke-width="2"/>
                <line x1="30" y1="140" x2="30" y2="40" stroke="#4a5a6a" stroke-width="2"/>
                <path d="M 30 130 Q 60 120 90 100 Q 120 80 150 60 Q 180 50 210 45 Q 240 60 270 130" stroke="#ff6b6b" stroke-width="3" fill="none"/>
                <circle cx="90" cy="100" r="5" fill="#5a8a5a"/>
                <circle cx="150" cy="60" r="5" fill="#8a8a5a"/>
                <circle cx="210" cy="45" r="5" fill="#8a5a5a"/>
                <line x1="90" y1="140" x2="90" y2="100" stroke="#5a8a5a" stroke-width="1" stroke-dasharray="3,3"/>
                <line x1="210" y1="140" x2="210" y2="45" stroke="#8a5a5a" stroke-width="1" stroke-dasharray="3,3"/>
                <text x="60" y="155" text-anchor="middle" fill="#5a8a5a" font-size="8">ACTE I</text>
                <text x="150" y="155" text-anchor="middle" fill="#8a8a5a" font-size="8">ACTE II</text>
                <text x="240" y="155" text-anchor="middle" fill="#8a5a5a" font-size="8">ACTE III</text>
                <text x="90" y="95" text-anchor="middle" fill="#5a8a5a" font-size="7">Plot Point 1</text>
                <text x="210" y="38" text-anchor="middle" fill="#8a5a5a" font-size="7">Climax</text>
                <text x="20" y="45" fill="#888" font-size="7">Tension</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">La courbe dramatique classique</text>
            </svg>`,
            example: 'Quasi tous les blockbusters suivent ce mod√®le.'
        },
        'protagoniste': {
            title: 'Protagoniste',
            description: `<p>Personnage principal de l'histoire, celui dont on suit le parcours et √† travers lequel le spectateur vit l'aventure.</p>
            <p>Doit avoir un <strong>objectif clair</strong>, des <strong>obstacles</strong> √† surmonter et des <strong>enjeux</strong> (ce qu'il risque de perdre).</p>
            <p>Son arc transformationnel (comment il change) est souvent le c≈ìur √©motionnel du film.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="150" cy="70" r="40" fill="#e2e8f0"/>
                <circle cx="135" cy="60" r="6" fill="#2a2a3e"/>
                <circle cx="165" cy="60" r="6" fill="#2a2a3e"/>
                <path d="M 135 85 Q 150 95 165 85" stroke="#2a2a3e" stroke-width="2" fill="none"/>
                <ellipse cx="150" cy="130" rx="30" ry="35" fill="#d2d8e0"/>
                <path d="M 200 70 L 250 50" stroke="#5a8a5a" stroke-width="2" marker-end="url(#arrowProt)"/>
                <defs><marker id="arrowProt" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#5a8a5a"/></marker></defs>
                <text x="255" y="45" fill="#5a8a5a" font-size="8">OBJECTIF</text>
                <rect x="240" y="50" width="40" height="25" fill="#5a8a5a" opacity="0.3" rx="3"/>
                <path d="M 200 90 L 230 100" stroke="#8a5a5a" stroke-width="2"/>
                <text x="235" y="95" fill="#8a5a5a" font-size="7">Obstacles</text>
                <text x="200" y="130" fill="#8a8a5a" font-size="7">Enjeux</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Le h√©ros poursuit un but malgr√© les obstacles</text>
            </svg>`,
            example: 'Luke Skywalker, Clarice Starling, Woody dans Toy Story.'
        },
        'antagoniste': {
            title: 'Antagoniste',
            description: `<p>Force qui s'oppose au protagoniste et l'emp√™che d'atteindre son objectif.</p>
            <p>Peut √™tre une <strong>personne</strong> (m√©chant), une <strong>institution</strong>, la <strong>nature</strong>, la <strong>soci√©t√©</strong> ou le protagoniste <strong>lui-m√™me</strong>.</p>
            <p>Un bon antagoniste croit avoir raison et a ses propres motivations compr√©hensibles.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="80" cy="70" r="30" fill="#e2e8f0"/>
                <circle cx="70" cy="65" r="4" fill="#2a2a3e"/>
                <circle cx="90" cy="65" r="4" fill="#2a2a3e"/>
                <text x="80" y="120" text-anchor="middle" fill="#5a8a5a" font-size="9">Protagoniste</text>
                <circle cx="220" cy="70" r="30" fill="#4a4a5a"/>
                <circle cx="210" cy="65" r="4" fill="#aa5a5a"/>
                <circle cx="230" cy="65" r="4" fill="#aa5a5a"/>
                <path d="M 210 80 Q 220 75 230 80" stroke="#aa5a5a" stroke-width="2" fill="none"/>
                <text x="220" y="120" text-anchor="middle" fill="#8a5a5a" font-size="9">Antagoniste</text>
                <path d="M 115 70 L 140 70" stroke="#ff6b6b" stroke-width="3"/>
                <path d="M 185 70 L 160 70" stroke="#ff6b6b" stroke-width="3"/>
                <text x="150" y="65" text-anchor="middle" fill="#ff6b6b" font-size="12">‚ö°</text>
                <text x="150" y="85" text-anchor="middle" fill="#ff6b6b" font-size="8">CONFLIT</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Opposition = moteur de l histoire</text>
            </svg>`,
            example: 'Darth Vader, Hannibal Lecter, le requin dans Les Dents de la Mer.'
        },
        'voyage-heros': {
            title: 'Voyage du H√©ros',
            description: `<p>Structure narrative universelle en 12 √©tapes identifi√©e par Joseph Campbell dans "Le H√©ros aux mille visages" (1949).</p>
            <p>D√©crit le parcours arch√©typal : d√©part du monde ordinaire, √©preuves dans un monde extraordinaire, retour <strong>transform√©</strong>.</p>
            <p>Adapt√© pour Hollywood par Christopher Vogler, c'est le squelette de nombreux blockbusters.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="95" rx="120" ry="70" fill="none" stroke="#4a5a6a" stroke-width="2"/>
                <line x1="150" y1="25" x2="150" y2="165" stroke="#4a5a6a" stroke-width="1" stroke-dasharray="5,3"/>
                <text x="75" y="50" text-anchor="middle" fill="#5a8a5a" font-size="8">MONDE</text>
                <text x="75" y="60" text-anchor="middle" fill="#5a8a5a" font-size="8">ORDINAIRE</text>
                <text x="225" y="50" text-anchor="middle" fill="#8a5a8a" font-size="8">MONDE</text>
                <text x="225" y="60" text-anchor="middle" fill="#8a5a8a" font-size="8">EXTRAORDINAIRE</text>
                <circle cx="40" cy="95" r="8" fill="#5a8a5a"/>
                <text x="40" y="115" text-anchor="middle" fill="#888" font-size="6">D√©part</text>
                <circle cx="150" cy="25" r="8" fill="#ff6b6b"/>
                <text x="170" y="30" fill="#ff6b6b" font-size="6">Seuil</text>
                <circle cx="260" cy="95" r="8" fill="#8a5a8a"/>
                <text x="260" y="115" text-anchor="middle" fill="#888" font-size="6">√âpreuve</text>
                <circle cx="150" cy="165" r="8" fill="#8a8a5a"/>
                <text x="170" y="168" fill="#888" font-size="6">Retour</text>
                <path d="M 48 90 Q 100 30 142 25" stroke="#5a8a5a" stroke-width="2" fill="none" marker-end="url(#arrowHero)"/>
                <defs><marker id="arrowHero" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#5a8a5a"/></marker></defs>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="9">Cycle : D√©part ‚Üí Initiation ‚Üí Retour</text>
            </svg>`,
            example: 'Star Wars, Le Seigneur des Anneaux, Matrix, Le Roi Lion.'
        },
        'plot-point': {
            title: 'Plot Point (Point de basculement)',
            description: `<p>√âv√©nement majeur qui fait basculer l'histoire dans une nouvelle direction, concept cl√© du paradigme de Syd Field.</p>
            <p><strong>Plot Point 1</strong> (fin Acte I) : Lance le protagoniste dans l'aventure. <strong>Plot Point 2</strong> (fin Acte II) : Propulse vers le climax.</p>
            <p>Ces moments sont des "portes" : une fois franchies, le protagoniste ne peut plus revenir en arri√®re.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <line x1="30" y1="130" x2="270" y2="130" stroke="#4a5a6a" stroke-width="2"/>
                <rect x="30" y="80" width="60" height="50" fill="#3a5a3a" rx="3"/>
                <text x="60" y="110" text-anchor="middle" fill="#aaa" font-size="9">ACTE I</text>
                <rect x="100" y="80" width="100" height="50" fill="#5a5a3a" rx="3"/>
                <text x="150" y="110" text-anchor="middle" fill="#aaa" font-size="9">ACTE II</text>
                <rect x="210" y="80" width="60" height="50" fill="#5a3a3a" rx="3"/>
                <text x="240" y="110" text-anchor="middle" fill="#aaa" font-size="9">ACTE III</text>
                <circle cx="95" cy="80" r="12" fill="#ff6b6b"/>
                <text x="95" y="84" text-anchor="middle" fill="#fff" font-size="8">PP1</text>
                <text x="95" y="65" text-anchor="middle" fill="#ff6b6b" font-size="7">p.25-27</text>
                <circle cx="150" cy="60" r="10" fill="#8a8a5a"/>
                <text x="150" y="64" text-anchor="middle" fill="#fff" font-size="7">MID</text>
                <text x="150" y="48" text-anchor="middle" fill="#8a8a5a" font-size="7">p.60</text>
                <circle cx="205" cy="80" r="12" fill="#ff6b6b"/>
                <text x="205" y="84" text-anchor="middle" fill="#fff" font-size="8">PP2</text>
                <text x="205" y="65" text-anchor="middle" fill="#ff6b6b" font-size="7">p.85-90</text>
                <text x="150" y="155" text-anchor="middle" fill="#888" font-size="9">Points de basculement = portes sans retour</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Paradigme de Syd Field (1979)</text>
            </svg>`,
            example: 'Matrix : Neo choisit la pilule rouge (PP1).'
        },
        'midpoint': {
            title: 'Midpoint (Point m√©dian)',
            description: `<p>Moment pivot au centre exact du film (vers la page 60) qui change la dynamique de l'histoire.</p>
            <p>Peut √™tre une <strong>fausse victoire</strong> (tout semble gagn√©, mais...) ou une <strong>fausse d√©faite</strong> (tout semble perdu, mais...).</p>
            <p>Souvent le moment o√π le protagoniste passe de r√©actif √† proactif, ou d√©couvre une v√©rit√© importante.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <line x1="30" y1="140" x2="270" y2="140" stroke="#4a5a6a" stroke-width="2"/>
                <path d="M 30 120 Q 80 100 150 60 Q 220 100 270 120" stroke="#5a8a5a" stroke-width="2" fill="none"/>
                <path d="M 30 120 Q 80 100 150 130 Q 220 100 270 120" stroke="#8a5a5a" stroke-width="2" fill="none" stroke-dasharray="5,3"/>
                <circle cx="150" cy="60" r="15" fill="#5a8a5a"/>
                <text x="150" y="65" text-anchor="middle" fill="#fff" font-size="8">üëç</text>
                <text x="150" y="45" text-anchor="middle" fill="#5a8a5a" font-size="8">Fausse victoire</text>
                <circle cx="150" cy="130" r="15" fill="#8a5a5a"/>
                <text x="150" y="135" text-anchor="middle" fill="#fff" font-size="8">üëé</text>
                <text x="150" y="155" text-anchor="middle" fill="#8a5a5a" font-size="8">Fausse d√©faite</text>
                <line x1="150" y1="140" x2="150" y2="160" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="3,2"/>
                <text x="150" y="175" text-anchor="middle" fill="#ff6b6b" font-size="9">50% du film - Tout bascule</text>
            </svg>`,
            example: 'Titanic : Jack et Rose font l amour (fausse victoire avant le naufrage).'
        },
        'arc-transformationnel': {
            title: 'Arc Transformationnel',
            description: `<p>√âvolution int√©rieure du personnage au cours de l'histoire, sa transformation psychologique ou morale.</p>
            <p>Le personnage commence avec une <strong>croyance limitante</strong> (Lie) n√©e d'une <strong>blessure</strong> (Ghost), et doit d√©couvrir la <strong>v√©rit√©</strong> (Truth).</p>
            <p>Ce qu'il VEUT (d√©sir) ‚â† ce dont il a BESOIN. Le film r√©concilie souvent les deux.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="60" cy="90" r="35" fill="#4a4a5a"/>
                <circle cx="50" cy="82" r="5" fill="#6a6a7a"/>
                <circle cx="70" cy="82" r="5" fill="#6a6a7a"/>
                <path d="M 50 100 Q 60 95 70 100" stroke="#6a6a7a" stroke-width="2" fill="none"/>
                <text x="60" y="140" text-anchor="middle" fill="#8a8a8a" font-size="8">AVANT</text>
                <text x="60" y="152" text-anchor="middle" fill="#8a5a5a" font-size="7">(Lie/Ghost)</text>
                <circle cx="240" cy="90" r="35" fill="#5a6a5a"/>
                <circle cx="230" cy="82" r="5" fill="#8aaa8a"/>
                <circle cx="250" cy="82" r="5" fill="#8aaa8a"/>
                <path d="M 230 100 Q 240 108 250 100" stroke="#8aaa8a" stroke-width="2" fill="none"/>
                <text x="240" y="140" text-anchor="middle" fill="#8a8a8a" font-size="8">APR√àS</text>
                <text x="240" y="152" text-anchor="middle" fill="#5a8a5a" font-size="7">(Truth)</text>
                <path d="M 100 90 L 195 90" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowArc)"/>
                <defs><marker id="arrowArc" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#ff6b6b"/></marker></defs>
                <text x="150" y="85" text-anchor="middle" fill="#ff6b6b" font-size="8">TRANSFORMATION</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Le personnage √©volue int√©rieurement</text>
            </svg>`,
            example: 'Scrooge dans A Christmas Carol, Carl dans L√†-Haut.'
        },
        // === PRODUCTION - √âTAPES ===
        'pre-production': {
            title: 'Pr√©-production',
            description: `<p>Phase de pr√©paration entre le d√©veloppement du projet et le tournage. Dure g√©n√©ralement 8-12 semaines.</p>
            <p>Comprend : casting, rep√©rages, d√©coupage technique, storyboard, constitution de l'√©quipe, planning, budget d√©taill√©.</p>
            <p>Une <strong>bonne pr√©paration</strong> est la cl√© d'un tournage r√©ussi. "Chaque euro investi en pr√©pa en √©conomise dix en tournage."</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="50" width="70" height="40" fill="#3a5a3a" rx="5"/>
                <text x="55" y="75" text-anchor="middle" fill="#aaa" font-size="8">D√©veloppement</text>
                <rect x="100" y="50" width="70" height="40" fill="#5a8a5a" rx="5" stroke="#8aba8a" stroke-width="2"/>
                <text x="135" y="75" text-anchor="middle" fill="#fff" font-size="8">PR√â-PROD</text>
                <rect x="180" y="50" width="50" height="40" fill="#5a5a3a" rx="5"/>
                <text x="205" y="75" text-anchor="middle" fill="#aaa" font-size="8">Tournage</text>
                <rect x="240" y="50" width="50" height="40" fill="#3a3a5a" rx="5"/>
                <text x="265" y="75" text-anchor="middle" fill="#aaa" font-size="8">Post</text>
                <path d="M 90 70 L 100 70" stroke="#8aba8a" stroke-width="2"/>
                <path d="M 170 70 L 180 70" stroke="#8a8a5a" stroke-width="2"/>
                <text x="135" y="110" text-anchor="middle" fill="#8aba8a" font-size="9">Casting</text>
                <text x="135" y="122" text-anchor="middle" fill="#8aba8a" font-size="9">Rep√©rages</text>
                <text x="135" y="134" text-anchor="middle" fill="#8aba8a" font-size="9">Planning</text>
                <text x="135" y="146" text-anchor="middle" fill="#8aba8a" font-size="9">Budget</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Pr√©parer = √©conomiser temps et argent</text>
            </svg>`,
            example: '8-12 semaines de pr√©pa pour un long-m√©trage standard.'
        },
        'post-production': {
            title: 'Post-production',
            description: `<p>Phase finale apr√®s le tournage : montage, √©talonnage, VFX, sound design, mixage, mastering.</p>
            <p>Peut durer de quelques semaines (court-m√©trage) √† plus d'un an (blockbuster avec VFX lourds).</p>
            <p>Le film se "r√©√©crit" souvent au montage. C'est l√† que na√Æt le rythme et l'√©motion finale.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="40" width="50" height="35" fill="#3a5a3a" rx="3"/>
                <text x="45" y="62" text-anchor="middle" fill="#aaa" font-size="7">Tournage</text>
                <rect x="80" y="40" width="50" height="35" fill="#5a5a8a" rx="3" stroke="#8a8aba" stroke-width="2"/>
                <text x="105" y="62" text-anchor="middle" fill="#fff" font-size="7">Montage</text>
                <rect x="140" y="40" width="50" height="35" fill="#5a5a8a" rx="3"/>
                <text x="165" y="62" text-anchor="middle" fill="#aaa" font-size="7">√âtalonnage</text>
                <rect x="200" y="40" width="40" height="35" fill="#5a5a8a" rx="3"/>
                <text x="220" y="62" text-anchor="middle" fill="#aaa" font-size="7">VFX</text>
                <rect x="250" y="40" width="40" height="35" fill="#5a5a8a" rx="3"/>
                <text x="270" y="62" text-anchor="middle" fill="#aaa" font-size="7">Mixage</text>
                <path d="M 70 57 L 80 57" stroke="#6a6a8a" stroke-width="2"/>
                <path d="M 130 57 L 140 57" stroke="#6a6a8a" stroke-width="2"/>
                <path d="M 190 57 L 200 57" stroke="#6a6a8a" stroke-width="2"/>
                <path d="M 240 57 L 250 57" stroke="#6a6a8a" stroke-width="2"/>
                <rect x="80" y="85" width="210" height="50" fill="#3a3a4a" rx="5" stroke="#8a8aba" stroke-width="1"/>
                <text x="185" y="105" text-anchor="middle" fill="#8a8aba" font-size="10">POST-PRODUCTION</text>
                <text x="185" y="125" text-anchor="middle" fill="#888" font-size="8">Le film se r√©√©crit au montage</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">De quelques semaines √† plus d un an</text>
            </svg>`,
            example: 'Avatar 2 : plus de 3 ans de post-production.'
        },
        // === PRODUCTION - DOCUMENTS ===
        'feuille-service': {
            title: 'Feuille de service',
            description: `<p>Document quotidien distribu√© la veille √† toute l'√©quipe, d√©taillant le programme du lendemain.</p>
            <p>Contient : horaires (convocations √©chelonn√©es), lieux, sc√®nes tourn√©es, com√©diens n√©cessaires, besoins sp√©ciaux.</p>
            <p>La "bible" de chaque journ√©e. Pr√©par√©e par le 2√®me assistant r√©alisateur.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="60" y="20" width="180" height="140" fill="#f5f5e8" rx="5"/>
                <text x="150" y="40" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">FEUILLE DE SERVICE</text>
                <text x="150" y="52" text-anchor="middle" fill="#555" font-size="8">Jour 7 - Lundi 15 janvier</text>
                <line x1="70" y1="58" x2="230" y2="58" stroke="#999" stroke-width="1"/>
                <text x="75" y="72" fill="#333" font-size="7">‚è∞ √âquipe: 07h00</text>
                <text x="75" y="84" fill="#333" font-size="7">üé¨ PAT: 08h00</text>
                <text x="75" y="96" fill="#333" font-size="7">üìç Lieu: Caf√© de Flore</text>
                <line x1="70" y1="102" x2="230" y2="102" stroke="#999" stroke-width="1"/>
                <text x="75" y="115" fill="#333" font-size="7">Sc.12 - INT CAF√â - JOUR</text>
                <text x="75" y="127" fill="#333" font-size="7">Sc.14 - INT CAF√â - JOUR</text>
                <text x="75" y="139" fill="#333" font-size="7">Com√©diens: MARIE, PAUL</text>
                <text x="75" y="151" fill="#555" font-size="6">HMC: 06h30 | Costumes pr√™ts</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Programme du jour - distribu√©e la veille</text>
            </svg>`,
            example: 'Envoy√©e chaque soir vers 19h pour le lendemain.'
        },
        'depouillement': {
            title: 'D√©pouillement',
            description: `<p>Analyse d√©taill√©e du sc√©nario pour lister tous les besoins de chaque sc√®ne.</p>
            <p>R√©pertorie : personnages, figurants, d√©cors, accessoires, costumes, maquillages, v√©hicules, effets sp√©ciaux...</p>
            <p>Base essentielle pour √©tablir le budget et le plan de travail. Chaque d√©partement fait son propre d√©pouillement.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="25" width="80" height="100" fill="#e8e8d8" rx="3"/>
                <text x="60" y="45" text-anchor="middle" fill="#333" font-size="8" font-weight="bold">SC√âNARIO</text>
                <text x="30" y="60" fill="#555" font-size="6">Sc.12 - INT CAF√â</text>
                <text x="30" y="72" fill="#555" font-size="6">Marie entre dans</text>
                <text x="30" y="82" fill="#555" font-size="6">le caf√© bond√©...</text>
                <path d="M 100 75 L 130 50" stroke="#ff6b6b" stroke-width="2" marker-end="url(#arrowDep1)"/>
                <path d="M 100 75 L 130 75" stroke="#5a8a5a" stroke-width="2" marker-end="url(#arrowDep2)"/>
                <path d="M 100 75 L 130 100" stroke="#5a5a8a" stroke-width="2" marker-end="url(#arrowDep3)"/>
                <defs>
                    <marker id="arrowDep1" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#ff6b6b"/></marker>
                    <marker id="arrowDep2" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#5a8a5a"/></marker>
                    <marker id="arrowDep3" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#5a5a8a"/></marker>
                </defs>
                <rect x="140" y="35" width="70" height="25" fill="#ff6b6b" rx="3" opacity="0.8"/>
                <text x="175" y="52" text-anchor="middle" fill="#fff" font-size="7">Personnages</text>
                <rect x="140" y="65" width="70" height="25" fill="#5a8a5a" rx="3" opacity="0.8"/>
                <text x="175" y="82" text-anchor="middle" fill="#fff" font-size="7">D√©cors/Access.</text>
                <rect x="140" y="95" width="70" height="25" fill="#5a5a8a" rx="3" opacity="0.8"/>
                <text x="175" y="112" text-anchor="middle" fill="#fff" font-size="7">Costumes/HMC</text>
                <rect x="220" y="50" width="60" height="60" fill="#4a4a3a" rx="3"/>
                <text x="250" y="75" text-anchor="middle" fill="#aaa" font-size="7">BUDGET</text>
                <text x="250" y="90" text-anchor="middle" fill="#aaa" font-size="7">PLANNING</text>
                <text x="150" y="150" text-anchor="middle" fill="#888" font-size="9">Analyser le sc√©nario ‚Üí Lister les besoins</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Base du budget et du plan de travail</text>
            </svg>`,
            example: 'Un bon d√©pouillement √©vite les mauvaises surprises en tournage.'
        },
        // === PRODUCTION - POSTES ===
        'scripte': {
            title: 'Scripte (Script Supervisor)',
            description: `<p>Garant(e) de la continuit√© du film : raccords de gestes, positions, accessoires, costumes, maquillage entre les plans.</p>
            <p>Note chaque prise (dur√©e, commentaires, s√©lection du r√©alisateur) et r√©dige le rapport image pour le montage.</p>
            <p>M√©moire vivante du tournage. Travaille en √©troite collaboration avec le r√©alisateur et le monteur.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="30" width="90" height="60" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <text x="75" y="55" text-anchor="middle" fill="#888" font-size="8">PLAN A</text>
                <circle cx="60" cy="70" r="8" fill="#e2e8f0"/>
                <rect x="80" y="65" width="15" height="10" fill="#8a5a5a"/>
                <rect x="180" y="30" width="90" height="60" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <text x="225" y="55" text-anchor="middle" fill="#888" font-size="8">PLAN B</text>
                <circle cx="210" cy="70" r="8" fill="#e2e8f0"/>
                <rect x="230" y="65" width="15" height="10" fill="#8a5a5a"/>
                <path d="M 125 60 L 175 60" stroke="#5a8a5a" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="150" y="55" text-anchor="middle" fill="#5a8a5a" font-size="8">Raccord ?</text>
                <ellipse cx="150" cy="130" rx="35" ry="25" fill="#4a5a6a"/>
                <circle cx="150" cy="105" r="15" fill="#e2e8f0"/>
                <rect x="130" y="125" width="40" height="20" fill="#e8e8d8" rx="2"/>
                <text x="150" y="138" text-anchor="middle" fill="#333" font-size="6">Notes</text>
                <text x="150" y="100" text-anchor="middle" fill="#2a2a3e" font-size="7">üëÄ</text>
                <path d="M 130 115 L 85 90" stroke="#ff6b6b" stroke-width="1"/>
                <path d="M 170 115 L 215 90" stroke="#ff6b6b" stroke-width="1"/>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Garant de la continuit√© entre les plans</text>
            </svg>`,
            example: 'Le scripte note tout : verre plein ou vide, main gauche ou droite...'
        },
        'chef-op': {
            title: 'Directeur de la Photographie (Chef Op)',
            description: `<p>Responsable de l'image du film : √©clairage, cadrage, choix des optiques, atmosph√®re visuelle.</p>
            <p>Traduit la vision du r√©alisateur en lumi√®re. Supervise les √©quipes cam√©ra et √©lectricit√©.</p>
            <p>Collaboration cr√©ative √©troite avec le r√©alisateur. Peut d√©finir le "look" signature d'un film.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="120" rx="40" ry="30" fill="#4a5a6a"/>
                <circle cx="150" cy="85" r="25" fill="#e2e8f0"/>
                <circle cx="143" cy="80" r="4" fill="#2a2a3e"/>
                <circle cx="157" cy="80" r="4" fill="#2a2a3e"/>
                <rect x="60" y="50" width="40" height="30" fill="#3a3a3a" rx="3"/>
                <circle cx="80" cy="65" r="10" fill="#2a2a2a"/>
                <circle cx="80" cy="65" r="6" fill="#4a4a4a"/>
                <circle cx="40" cy="40" r="15" fill="#ffd700" opacity="0.8"/>
                <path d="M 40 40 L 70 55" stroke="#ffd700" stroke-width="2" stroke-dasharray="5,3" opacity="0.5"/>
                <circle cx="260" cy="45" r="12" fill="#88aaff" opacity="0.6"/>
                <path d="M 260 45 L 230 60" stroke="#88aaff" stroke-width="1" stroke-dasharray="5,3" opacity="0.4"/>
                <text x="40" y="65" fill="#ffd700" font-size="7">Key</text>
                <text x="260" y="65" text-anchor="middle" fill="#88aaff" font-size="7">Fill</text>
                <text x="80" y="90" fill="#888" font-size="7">Cam√©ra</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Cr√©e l atmosph√®re visuelle du film</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="8">Lumi√®re + Cadre + Optiques</text>
            </svg>`,
            example: 'Roger Deakins (Skyfall, Blade Runner 2049), Emmanuel Lubezki (Gravity).'
        },
        // === PRODUCTION - BUDGET ===
        'above-below-line': {
            title: 'Above / Below the Line',
            description: `<p>Division traditionnelle du budget en deux cat√©gories, s√©par√©es par une "ligne" symbolique.</p>
            <p><strong>Above the line</strong> : co√ªts cr√©atifs (droits, sc√©nario, r√©alisateur, producteur, acteurs principaux).</p>
            <p><strong>Below the line</strong> : co√ªts de fabrication (√©quipe technique, mat√©riel, d√©cors, post-production).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="50" y="25" width="200" height="55" fill="#5a5a3a" rx="5"/>
                <text x="150" y="45" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">ABOVE THE LINE</text>
                <text x="80" y="62" fill="#ccc" font-size="7">‚Ä¢ Droits / Sc√©nario</text>
                <text x="80" y="73" fill="#ccc" font-size="7">‚Ä¢ R√©alisateur / Producteur</text>
                <text x="175" y="62" fill="#ccc" font-size="7">‚Ä¢ Acteurs principaux</text>
                <line x1="50" y1="90" x2="250" y2="90" stroke="#ff6b6b" stroke-width="3"/>
                <text x="265" y="94" fill="#ff6b6b" font-size="8">LINE</text>
                <rect x="50" y="100" width="200" height="65" fill="#3a5a5a" rx="5"/>
                <text x="150" y="120" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">BELOW THE LINE</text>
                <text x="80" y="137" fill="#ccc" font-size="7">‚Ä¢ √âquipe technique</text>
                <text x="80" y="148" fill="#ccc" font-size="7">‚Ä¢ Mat√©riel / D√©cors</text>
                <text x="175" y="137" fill="#ccc" font-size="7">‚Ä¢ Post-production</text>
                <text x="175" y="148" fill="#ccc" font-size="7">‚Ä¢ Assurances</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Co√ªts cr√©atifs vs Co√ªts de fabrication</text>
            </svg>`,
            example: 'Un star-syst√®me gonfl√© = Above the line disproportionn√©.'
        },
        // === R√âALISATION - POINTS DE VUE ===
        'plan-subjectif': {
            title: 'Plan subjectif (POV)',
            description: `<p>La cam√©ra prend la place des yeux d'un personnage. Le spectateur voit exactement ce que le personnage voit.</p>
            <p>Cr√©e une <strong>identification forte</strong> et une immersion totale. Souvent pr√©c√©d√© d'un plan sur le personnage qui regarde.</p>
            <p>Peut √™tre troublant si prolong√© (vertige, malaise). Utilis√© pour les sc√®nes de tension, d√©couverte, poursuite.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="40" y="30" width="220" height="120" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <circle cx="150" cy="90" r="35" fill="#ffd700"/>
                <text x="150" y="95" text-anchor="middle" fill="#333" font-size="12">OBJET VU</text>
                <path d="M 20 160 L 50 150 L 250 150 L 280 160 L 250 170 L 50 170 Z" fill="#4a5a6a" opacity="0.5"/>
                <ellipse cx="30" cy="160" rx="15" ry="8" fill="#e2e8f0"/>
                <ellipse cx="270" cy="160" rx="15" ry="8" fill="#e2e8f0"/>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="9">Yeux du personnage = Cam√©ra</text>
            </svg>`,
            example: 'Halloween (Michael Myers), Enter the Void, Strange Days.'
        },
        'plan-objectif': {
            title: 'Plan objectif',
            description: `<p>Point de vue neutre d'un observateur ext√©rieur. La cam√©ra ne repr√©sente les yeux d'aucun personnage.</p>
            <p>Position <strong>omnisciente</strong> classique du cin√©ma narratif. Le spectateur observe la sc√®ne comme un t√©moin invisible.</p>
            <p>Cr√©e une distance analytique, permet de voir ce que les personnages ne voient pas.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="50" y="40" width="200" height="100" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <ellipse cx="120" cy="100" rx="25" ry="35" fill="#e2e8f0"/>
                <circle cx="120" cy="65" r="18" fill="#e2e8f0"/>
                <ellipse cx="200" cy="100" rx="25" ry="35" fill="#c2c8d0"/>
                <circle cx="200" cy="65" r="18" fill="#c2c8d0"/>
                <rect x="130" y="15" width="40" height="25" fill="#4a5a6a" rx="3"/>
                <circle cx="150" cy="27" r="8" fill="#2a2a3a"/>
                <text x="150" y="10" text-anchor="middle" fill="#888" font-size="8">Cam√©ra neutre</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="10">Observateur ext√©rieur - Point de vue omniscient</text>
            </svg>`,
            example: 'La majorit√© des plans dans le cin√©ma classique.'
        },
        'plan-semi-subjectif': {
            title: 'Plan semi-subjectif',
            description: `<p>La cam√©ra est proche d'un personnage, dans son espace, mais ne repr√©sente pas exactement ses yeux.</p>
            <p>Souvent <strong>par-dessus l'√©paule</strong> (over-the-shoulder). Partage l'exp√©rience sans l'identification totale.</p>
            <p>Compromis entre subjectivit√© et objectivit√©. Tr√®s utilis√© dans les dialogues et sc√®nes d'action.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="50" y="30" width="200" height="110" fill="#2a3a4a" rx="5" stroke="#4a5a6a"/>
                <ellipse cx="30" cy="100" rx="30" ry="50" fill="#4a5a6a" opacity="0.7"/>
                <circle cx="35" cy="55" r="25" fill="#5a6a7a" opacity="0.7"/>
                <ellipse cx="180" cy="95" rx="30" ry="40" fill="#e2e8f0"/>
                <circle cx="180" cy="55" r="22" fill="#e2e8f0"/>
                <text x="35" y="160" fill="#888" font-size="8">Amorce</text>
                <text x="180" y="150" text-anchor="middle" fill="#888" font-size="8">Sujet</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Over-the-shoulder - Proche mais pas dedans</text>
            </svg>`,
            example: 'Champs/contre-champs avec amorce d √©paule.'
        },
        'ligne-180': {
            title: 'Ligne des 180¬∞ (R√®gle)',
            description: `<p>Axe imaginaire entre deux sujets qui ne doit pas √™tre franchi sans transition pour maintenir la coh√©rence spatiale.</p>
            <p>Si la cam√©ra passe de l'autre c√¥t√©, les personnages semblent <strong>inverser leurs positions</strong> et le spectateur perd ses rep√®res.</p>
            <p>Peut √™tre franchie volontairement pour cr√©er confusion ou malaise (Kubrick, Ozu).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="80" cy="90" rx="25" ry="35" fill="#5a8a5a"/>
                <circle cx="80" cy="55" r="18" fill="#6a9a6a"/>
                <text x="80" y="140" text-anchor="middle" fill="#5a8a5a" font-size="9">A</text>
                <ellipse cx="220" cy="90" rx="25" ry="35" fill="#8a5a5a"/>
                <circle cx="220" cy="55" r="18" fill="#9a6a6a"/>
                <text x="220" y="140" text-anchor="middle" fill="#8a5a5a" font-size="9">B</text>
                <line x1="80" y1="90" x2="220" y2="90" stroke="#ff6b6b" stroke-width="3"/>
                <text x="150" y="85" text-anchor="middle" fill="#ff6b6b" font-size="8">LIGNE 180¬∞</text>
                <path d="M 80 90 Q 150 30 220 90" stroke="#5a8a5a" stroke-width="1" stroke-dasharray="5,3" fill="none"/>
                <circle cx="120" cy="45" r="10" fill="#4a5a6a"/>
                <circle cx="150" cy="35" r="10" fill="#4a5a6a"/>
                <circle cx="180" cy="45" r="10" fill="#4a5a6a"/>
                <text x="150" y="20" text-anchor="middle" fill="#5a8a5a" font-size="7">Zone autoris√©e ‚úì</text>
                <text x="150" y="160" text-anchor="middle" fill="#ff6b6b" font-size="8">Zone interdite en bas ‚õî</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Ne jamais franchir sans transition</text>
            </svg>`,
            example: 'R√®gle fondamentale du d√©coupage classique hollywoodien.'
        },
        'plan-sequence': {
            title: 'Plan-s√©quence',
            description: `<p>Une sc√®ne enti√®re tourn√©e en un seul plan continu, sans aucune coupe de montage.</p>
            <p>Demande une <strong>chor√©graphie parfaite</strong> des acteurs, de la cam√©ra et de la technique. Tr√®s exigeant mais immersif.</p>
            <p>Cr√©e une tension continue car le spectateur sait qu'il n'y a pas d'√©chappatoire au temps r√©el.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="40" width="240" height="100" fill="#2a3a4a" rx="5" stroke="#5a8a5a" stroke-width="2"/>
                <path d="M 50 90 Q 80 60 110 90 Q 140 120 170 90 Q 200 60 230 90 Q 250 110 260 90" stroke="#ff6b6b" stroke-width="3" fill="none"/>
                <circle cx="50" cy="90" r="8" fill="#5a8a5a"/>
                <text x="50" y="115" text-anchor="middle" fill="#5a8a5a" font-size="7">START</text>
                <circle cx="260" cy="90" r="8" fill="#8a5a5a"/>
                <text x="260" y="115" text-anchor="middle" fill="#8a5a5a" font-size="7">END</text>
                <rect x="100" y="25" width="100" height="20" fill="#5a8a5a" rx="3"/>
                <text x="150" y="39" text-anchor="middle" fill="#fff" font-size="9">UN SEUL PLAN</text>
                <text x="150" y="160" text-anchor="middle" fill="#888" font-size="9">Pas de coupe = temps r√©el = tension</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Chor√©graphie parfaite requise</text>
            </svg>`,
            example: 'La Corde (Hitchcock), Birdman, 1917, Copacabana dans Les Affranchis.'
        },
        'blocking': {
            title: 'Blocking (Mise en place)',
            description: `<p>Placement et d√©placement des acteurs dans le d√©cor. L'art de raconter l'histoire par les positions et mouvements.</p>
            <p>Un bon blocking <strong>exprime les relations</strong> sans dialogue : distance = froideur, rapprochement = intimit√©, dos tourn√© = rejet.</p>
            <p>Le r√©alisateur "chor√©graphie" la sc√®ne avant m√™me de placer la cam√©ra.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="30" width="240" height="120" fill="#2a3a4a" rx="5"/>
                <circle cx="80" cy="70" r="15" fill="#5a8a5a"/>
                <text x="80" y="75" text-anchor="middle" fill="#fff" font-size="10">A</text>
                <circle cx="220" cy="70" r="15" fill="#8a5a5a"/>
                <text x="220" y="75" text-anchor="middle" fill="#fff" font-size="10">B</text>
                <path d="M 95 70 L 130 70" stroke="#5a8a5a" stroke-width="2" marker-end="url(#arrowBlock)"/>
                <defs><marker id="arrowBlock" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto"><path d="M0,0 L0,6 L8,3 z" fill="#5a8a5a"/></marker></defs>
                <circle cx="150" cy="110" r="15" fill="#5a5a8a"/>
                <text x="150" y="115" text-anchor="middle" fill="#fff" font-size="10">C</text>
                <text x="150" y="160" text-anchor="middle" fill="#888" font-size="9">Position = Relation entre personnages</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Raconter sans dialogue</text>
            </svg>`,
            example: 'David Fincher et ses blocking millim√©tr√©s.'
        },
        'staging': {
            title: 'Staging (Mise en cadre)',
            description: `<p>Organisation des √©l√©ments visuels dans le cadre pour guider le regard du spectateur.</p>
            <p>Combine <strong>blocking</strong> (acteurs) + <strong>d√©cor</strong> + <strong>lumi√®re</strong> + <strong>profondeur</strong> pour cr√©er une composition signifiante.</p>
            <p>Chaque √©l√©ment du cadre doit avoir une raison d'√™tre et contribuer √† la narration.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="30" width="240" height="120" fill="#2a3a4a" rx="5"/>
                <rect x="40" y="40" width="50" height="70" fill="#3a4a5a" rx="2"/>
                <rect x="200" y="50" width="40" height="55" fill="#3a4a5a" rx="2"/>
                <ellipse cx="150" cy="100" rx="30" ry="40" fill="#e2e8f0"/>
                <circle cx="150" cy="60" r="20" fill="#e2e8f0"/>
                <circle cx="80" cy="35" r="15" fill="#ffd700" opacity="0.5"/>
                <path d="M 80 35 L 150 60" stroke="#ffd700" stroke-width="1" stroke-dasharray="3,3" opacity="0.4"/>
                <path d="M 50 120 L 150 90" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="3,3"/>
                <path d="M 250 110 L 150 90" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="3,3"/>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Guider le regard vers le sujet</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Tout √©l√©ment a une raison d √™tre</text>
            </svg>`,
            example: 'Les compositions g√©om√©triques de Wes Anderson.'
        },
        'oner': {
            title: 'Oner (Plan-s√©quence virtuose)',
            description: `<p>Plan-s√©quence techniquement complexe, souvent avec mouvements de cam√©ra √©labor√©s et chor√©graphie pr√©cise.</p>
            <p>Diff√©rent du plan-s√©quence simple par son <strong>ambition technique</strong> et sa dur√©e (parfois plusieurs minutes).</p>
            <p>Peut impliquer grues, steadicam, transitions cach√©es, coordination de dizaines de figurants.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <path d="M 30 90 Q 60 40 100 70 Q 140 100 180 50 Q 220 20 270 60" stroke="#ff6b6b" stroke-width="3" fill="none"/>
                <circle cx="30" cy="90" r="8" fill="#5a8a5a"/>
                <circle cx="100" cy="70" r="6" fill="#6a9a6a" opacity="0.7"/>
                <circle cx="180" cy="50" r="6" fill="#7aaa7a" opacity="0.5"/>
                <circle cx="270" cy="60" r="8" fill="#8a5a5a"/>
                <rect x="25" y="95" width="25" height="20" fill="#4a5a6a" rx="2"/>
                <text x="37" y="108" text-anchor="middle" fill="#aaa" font-size="6">CAM</text>
                <ellipse cx="80" cy="120" rx="15" ry="20" fill="#e2e8f0" opacity="0.6"/>
                <ellipse cx="150" cy="110" rx="15" ry="20" fill="#e2e8f0" opacity="0.6"/>
                <ellipse cx="220" cy="125" rx="15" ry="20" fill="#e2e8f0" opacity="0.6"/>
                <text x="150" y="155" text-anchor="middle" fill="#888" font-size="9">Mouvement complexe + chor√©graphie</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Virtuosit√© technique</text>
            </svg>`,
            example: 'Copacabana (Goodfellas), Atonement, 1917, Birdman.'
        },
        'split-focus': {
            title: 'Split Focus (Diopter)',
            description: `<p>Technique optique utilisant une lentille fendue pour avoir deux plans de nettet√© simultan√©s.</p>
            <p>Permet de garder nets √† la fois un sujet <strong>tr√®s proche</strong> et un autre <strong>tr√®s √©loign√©</strong> dans le m√™me plan.</p>
            <p>Signature visuelle de Brian De Palma. Cr√©e une tension entre deux zones d'action.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="40" width="240" height="100" fill="#2a3a4a" rx="5"/>
                <line x1="150" y1="40" x2="150" y2="140" stroke="#ff6b6b" stroke-width="2" stroke-dasharray="5,3"/>
                <ellipse cx="80" cy="95" rx="35" ry="45" fill="#e2e8f0"/>
                <circle cx="80" cy="55" r="25" fill="#e2e8f0"/>
                <circle cx="72" cy="50" r="4" fill="#2a2a3e"/>
                <circle cx="88" cy="50" r="4" fill="#2a2a3e"/>
                <ellipse cx="220" cy="100" rx="20" ry="30" fill="#c2c8d0"/>
                <circle cx="220" cy="75" r="15" fill="#c2c8d0"/>
                <text x="80" y="150" text-anchor="middle" fill="#5a8a5a" font-size="8">NET (proche)</text>
                <text x="220" y="150" text-anchor="middle" fill="#5a8a5a" font-size="8">NET (loin)</text>
                <text x="150" y="35" text-anchor="middle" fill="#ff6b6b" font-size="8">Diopter</text>
                <text x="150" y="170" text-anchor="middle" fill="#888" font-size="10">Deux plans de nettet√© simultan√©s</text>
            </svg>`,
            example: 'Les films de Brian De Palma (Blow Out, Carrie).'
        },
        'camera-epaule': {
            title: 'Cam√©ra √©paule (Handheld)',
            description: `<p>Technique o√π l'op√©rateur porte la cam√©ra sur l'√©paule, cr√©ant une image l√©g√®rement instable.</p>
            <p>Apporte <strong>urgence, r√©alisme, immersion documentaire</strong>. Le spectateur ressent la pr√©sence physique du filmeur.</p>
            <p>Signature des fr√®res Dardenne, Paul Greengrass. √Ä utiliser avec intention, pas par d√©faut.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="120" cy="110" rx="35" ry="50" fill="#4a5a6a"/>
                <circle cx="120" cy="60" r="28" fill="#e2e8f0"/>
                <rect x="140" y="55" width="50" height="35" fill="#3a3a3a" rx="3"/>
                <circle cx="165" cy="72" r="12" fill="#2a2a2a"/>
                <circle cx="165" cy="72" r="6" fill="#4a4a4a"/>
                <path d="M 200 50 Q 220 45 230 55 Q 235 65 225 70 Q 215 60 210 65" stroke="#ff6b6b" stroke-width="2" fill="none"/>
                <path d="M 205 80 Q 225 75 235 85 Q 240 95 230 100 Q 220 90 215 95" stroke="#ff6b6b" stroke-width="2" fill="none"/>
                <text x="240" y="65" fill="#ff6b6b" font-size="8">Trembl√©</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Urgence, r√©alisme, documentaire</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Pr√©sence physique du filmeur</text>
            </svg>`,
            example: 'La Haine, Bourne Identity, films des Dardenne.'
        },
        'storyboard': {
            title: 'Storyboard',
            description: `<p>Suite de dessins repr√©sentant chaque plan du film, comme une bande dessin√©e du d√©coupage.</p>
            <p>Permet de <strong>visualiser</strong> le film avant le tournage et de communiquer la vision du r√©alisateur √† l'√©quipe.</p>
            <p>Indispensable pour les sc√®nes complexes (action, VFX). Peut √™tre simple croquis ou tr√®s d√©taill√©.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="25" width="75" height="55" fill="#e8e8d8" rx="3" stroke="#999"/>
                <rect x="25" y="30" width="65" height="35" fill="#ccc"/>
                <circle cx="45" cy="45" r="8" fill="#888"/>
                <rect x="55" y="40" width="20" height="15" fill="#888"/>
                <text x="57" y="75" fill="#555" font-size="6">Plan 1 - PE</text>
                <rect x="105" y="25" width="75" height="55" fill="#e8e8d8" rx="3" stroke="#999"/>
                <rect x="110" y="30" width="65" height="35" fill="#ccc"/>
                <circle cx="142" cy="47" r="15" fill="#888"/>
                <text x="142" y="75" text-anchor="middle" fill="#555" font-size="6">Plan 2 - GP</text>
                <rect x="190" y="25" width="75" height="55" fill="#e8e8d8" rx="3" stroke="#999"/>
                <rect x="195" y="30" width="65" height="35" fill="#ccc"/>
                <ellipse cx="227" cy="47" rx="25" ry="12" fill="#888"/>
                <text x="227" y="75" text-anchor="middle" fill="#555" font-size="6">Plan 3 - Insert</text>
                <rect x="20" y="95" width="75" height="55" fill="#e8e8d8" rx="3" stroke="#999"/>
                <rect x="105" y="95" width="75" height="55" fill="#e8e8d8" rx="3" stroke="#999"/>
                <rect x="190" y="95" width="75" height="55" fill="#e8e8d8" rx="3" stroke="#999"/>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">BD du film - visualiser avant de tourner</text>
            </svg>`,
            example: 'Hitchcock storyboardait chaque plan. Mad Max Fury Road enti√®rement dessin√©.'
        },
        'reperages': {
            title: 'Rep√©rages (Location Scouting)',
            description: `<p>Recherche et validation des lieux de tournage avant la production.</p>
            <p>√âvalue : <strong>esth√©tique</strong>, lumi√®re naturelle, acoustique, accessibilit√©, contraintes techniques et l√©gales.</p>
            <p>Le r√©alisateur, chef op et r√©gisseur visitent ensemble. Photos et vid√©os pour pr√©parer le d√©coupage.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="40" y="40" width="100" height="70" fill="#3a4a5a" rx="5"/>
                <rect x="55" y="50" width="30" height="40" fill="#2a3a4a"/>
                <rect x="95" y="60" width="20" height="30" fill="#2a3a4a"/>
                <polygon points="40,40 90,15 140,40" fill="#4a5a6a"/>
                <circle cx="200" cy="60" r="25" fill="#4a5a6a"/>
                <circle cx="200" cy="60" r="18" fill="#2a3a4a"/>
                <circle cx="200" cy="60" r="8" fill="#5a6a7a"/>
                <text x="200" y="100" text-anchor="middle" fill="#888" font-size="8">üì∑</text>
                <ellipse cx="90" cy="140" rx="8" ry="12" fill="#e2e8f0"/>
                <circle cx="90" cy="125" r="6" fill="#e2e8f0"/>
                <ellipse cx="130" cy="140" rx="8" ry="12" fill="#d2d8e0"/>
                <circle cx="130" cy="125" r="6" fill="#d2d8e0"/>
                <ellipse cx="170" cy="140" rx="8" ry="12" fill="#c2c8d0"/>
                <circle cx="170" cy="125" r="6" fill="#c2c8d0"/>
                <text x="130" y="165" text-anchor="middle" fill="#888" font-size="7">R√©al + Chef Op + R√©gisseur</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Trouver et valider les d√©cors</text>
            </svg>`,
            example: 'Le Seigneur des Anneaux : 3 ans de rep√©rages en Nouvelle-Z√©lande.'
        },
        'ligne-30': {
            title: 'R√®gle des 30¬∞',
            description: `<p>Entre deux plans cons√©cutifs du m√™me sujet, la cam√©ra doit bouger d'au moins 30¬∞ pour √©viter un jump cut.</p>
            <p>Un changement d'angle insuffisant cr√©e une <strong>saute</strong> visuelle d√©sagr√©able et d√©sorientante.</p>
            <p>Alternative : changer significativement la valeur de plan (passer de PM √† GP par exemple).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="150" cy="90" rx="30" ry="40" fill="#e2e8f0"/>
                <circle cx="150" cy="55" r="22" fill="#e2e8f0"/>
                <circle cx="80" cy="140" r="15" fill="#5a8a5a"/>
                <text x="80" y="145" text-anchor="middle" fill="#fff" font-size="9">A</text>
                <circle cx="130" cy="155" r="15" fill="#8a5a5a"/>
                <text x="130" y="160" text-anchor="middle" fill="#fff" font-size="9">B</text>
                <line x1="80" y1="140" x2="150" y2="90" stroke="#5a8a5a" stroke-width="2"/>
                <line x1="130" y1="155" x2="150" y2="90" stroke="#8a5a5a" stroke-width="2"/>
                <path d="M 95 130 A 40 40 0 0 1 120 140" stroke="#ff6b6b" stroke-width="3" fill="none"/>
                <text x="115" y="125" fill="#ff6b6b" font-size="10">30¬∞</text>
                <text x="60" y="165" fill="#5a8a5a" font-size="8">‚úì OK</text>
                <circle cx="220" cy="145" r="15" fill="#8a5a5a" opacity="0.5"/>
                <text x="220" y="150" text-anchor="middle" fill="#fff" font-size="9">C</text>
                <line x1="220" y1="145" x2="150" y2="90" stroke="#8a5a5a" stroke-width="1" stroke-dasharray="5,3"/>
                <text x="240" y="130" fill="#8a5a5a" font-size="7">< 30¬∞</text>
                <text x="240" y="145" fill="#ff6b6b" font-size="8">‚úó Jump!</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Minimum 30¬∞ entre deux plans similaires</text>
            </svg>`,
            example: 'La Nouvelle Vague a volontairement bris√© cette r√®gle (√Ä bout de souffle).'
        },
        'headroom': {
            title: 'Headroom (Air au-dessus)',
            description: `<p>Espace entre le haut de la t√™te du sujet et le bord sup√©rieur du cadre.</p>
            <p><strong>Trop de headroom</strong> = sujet √©cras√©, perdu. <strong>Pas assez</strong> = sujet √©touff√©, t√™te coup√©e.</p>
            <p>Varie selon la valeur de plan : plus serr√© = moins de headroom n√©cessaire.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="20" width="70" height="100" fill="#2a3a4a" stroke="#4a5a6a"/>
                <ellipse cx="65" cy="90" rx="20" ry="30" fill="#e2e8f0"/>
                <circle cx="65" cy="60" r="15" fill="#e2e8f0"/>
                <line x1="35" y1="45" x2="95" y2="45" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="3,2"/>
                <path d="M 65 20 L 65 45" stroke="#ff6b6b" stroke-width="2"/>
                <text x="75" y="35" fill="#ff6b6b" font-size="8">Trop!</text>
                <rect x="115" y="20" width="70" height="100" fill="#2a3a4a" stroke="#5a8a5a" stroke-width="2"/>
                <ellipse cx="150" cy="85" rx="20" ry="30" fill="#e2e8f0"/>
                <circle cx="150" cy="55" r="15" fill="#e2e8f0"/>
                <line x1="120" y1="35" x2="180" y2="35" stroke="#5a8a5a" stroke-width="1" stroke-dasharray="3,2"/>
                <path d="M 150 20 L 150 35" stroke="#5a8a5a" stroke-width="2"/>
                <text x="160" y="30" fill="#5a8a5a" font-size="8">‚úì OK</text>
                <rect x="200" y="20" width="70" height="100" fill="#2a3a4a" stroke="#4a5a6a"/>
                <ellipse cx="235" cy="80" rx="20" ry="30" fill="#e2e8f0"/>
                <circle cx="235" cy="48" r="15" fill="#e2e8f0"/>
                <line x1="205" y1="25" x2="265" y2="25" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="3,2"/>
                <text x="245" y="18" fill="#ff6b6b" font-size="8">Coup√©!</text>
                <text x="150" y="145" text-anchor="middle" fill="#888" font-size="10">Espace t√™te-bord du cadre</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Ni trop, ni pas assez</text>
            </svg>`,
            example: 'Erreur fr√©quente des d√©butants : trop ou pas assez d air.'
        },
        'looking-room': {
            title: 'Looking Room (Regard)',
            description: `<p>Espace laiss√© devant le regard ou la direction du mouvement d'un sujet.</p>
            <p>Si le personnage regarde √† droite, laisser de l'espace √† droite. Sinon, il semble <strong>coinc√©</strong> contre le bord.</p>
            <p>Cr√©e une composition √©quilibr√©e et sugg√®re ce que le personnage regarde (hors-champ).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="30" width="100" height="80" fill="#2a3a4a" stroke="#5a8a5a" stroke-width="2"/>
                <ellipse cx="55" cy="80" rx="18" ry="28" fill="#e2e8f0"/>
                <circle cx="55" cy="52" r="14" fill="#e2e8f0"/>
                <circle cx="60" cy="50" r="3" fill="#2a2a3e"/>
                <path d="M 75 55 L 120 55" stroke="#5a8a5a" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="100" y="50" fill="#5a8a5a" font-size="8">Espace ‚Üí</text>
                <text x="80" y="125" text-anchor="middle" fill="#5a8a5a" font-size="9">‚úì Correct</text>
                <rect x="170" y="30" width="100" height="80" fill="#2a3a4a" stroke="#8a5a5a" stroke-width="2"/>
                <ellipse cx="245" cy="80" rx="18" ry="28" fill="#e2e8f0"/>
                <circle cx="245" cy="52" r="14" fill="#e2e8f0"/>
                <circle cx="240" cy="50" r="3" fill="#2a2a3e"/>
                <path d="M 225 55 L 180 55" stroke="#8a5a5a" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="195" y="50" fill="#8a5a5a" font-size="8">‚Üê Bloqu√©</text>
                <text x="220" y="125" text-anchor="middle" fill="#8a5a5a" font-size="9">‚úó √âtouff√©</text>
                <text x="150" y="155" text-anchor="middle" fill="#888" font-size="9">Laisser de l espace devant le regard</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">Sinon le sujet semble coinc√©</text>
            </svg>`,
            example: 'R√®gle de base pour les interviews et dialogues.'
        },
        // === SC√âNARIO - √âL√âMENTS DRAMATIQUES ===
        'enjeu': {
            title: 'Enjeu (Stakes)',
            description: `<p>Ce que le protagoniste risque de <strong>perdre</strong> s'il √©choue dans sa qu√™te.</p>
            <p>Plus l'enjeu est √©lev√© (vie, amour, humanit√©), plus le spectateur est investi √©motionnellement.</p>
            <p>Peut √™tre externe (sauver le monde) ou interne (trouver sa place, se pardonner).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="150" cy="70" r="35" fill="#e2e8f0"/>
                <circle cx="140" cy="62" r="5" fill="#2a2a3e"/>
                <circle cx="160" cy="62" r="5" fill="#2a2a3e"/>
                <ellipse cx="150" cy="110" rx="25" ry="30" fill="#d2d8e0"/>
                <rect x="60" y="130" width="80" height="35" fill="#5a8a5a" rx="5"/>
                <text x="100" y="152" text-anchor="middle" fill="#fff" font-size="9">R√âUSSITE</text>
                <rect x="160" y="130" width="80" height="35" fill="#8a5a5a" rx="5"/>
                <text x="200" y="152" text-anchor="middle" fill="#fff" font-size="9">√âCHEC</text>
                <text x="100" y="172" text-anchor="middle" fill="#5a8a5a" font-size="7">üèÜ Gain</text>
                <text x="200" y="172" text-anchor="middle" fill="#8a5a5a" font-size="7">üíÄ Perte</text>
                <path d="M 130 105 L 100 130" stroke="#5a8a5a" stroke-width="2"/>
                <path d="M 170 105 L 200 130" stroke="#8a5a5a" stroke-width="2"/>
                <text x="150" y="30" text-anchor="middle" fill="#888" font-size="10">Qu'est-ce qui est en jeu ?</text>
            </svg>`,
            example: 'Titanic : l amour et la vie. Le Parrain : l √¢me de Michael.'
        },
        'conflit': {
            title: 'Conflit',
            description: `<p>Opposition fondamentale qui cr√©e la <strong>tension dramatique</strong> et fait avancer l'histoire.</p>
            <p>Types : Homme vs Homme, Homme vs Nature, Homme vs Soci√©t√©, Homme vs Lui-m√™me, Homme vs Technologie.</p>
            <p>Sans conflit, pas d'histoire. Le conflit r√©v√®le le vrai caract√®re des personnages.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="80" cy="80" r="35" fill="#5a8a5a"/>
                <circle cx="80" cy="55" r="20" fill="#6a9a6a"/>
                <text x="80" y="120" text-anchor="middle" fill="#5a8a5a" font-size="9">PROTAGONISTE</text>
                <circle cx="220" cy="80" r="35" fill="#8a5a5a"/>
                <circle cx="220" cy="55" r="20" fill="#9a6a6a"/>
                <text x="220" y="120" text-anchor="middle" fill="#8a5a5a" font-size="9">ANTAGONISTE</text>
                <path d="M 115 80 L 135 70 L 135 75 L 165 75 L 165 70 L 185 80 L 165 90 L 165 85 L 135 85 L 135 90 Z" fill="#ff6b6b"/>
                <text x="150" y="83" text-anchor="middle" fill="#fff" font-size="8">‚ö°</text>
                <text x="150" y="145" text-anchor="middle" fill="#ff6b6b" font-size="10">CONFLIT = MOTEUR</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Opposition qui cr√©e la tension</text>
            </svg>`,
            example: 'Les Dents de la Mer : Homme vs Nature. Fight Club : Homme vs Lui-m√™me.'
        },
        // === R√âALISATION - STYLES ===
        'casting': {
            title: 'Casting (Direction de casting)',
            description: `<p>Processus de s√©lection des com√©diens pour les r√¥les du film.</p>
            <p>Comprend : lecture du sc√©nario, auditions, essais cam√©ra, chemistry reads (alchimie entre acteurs).</p>
            <p>Le directeur de casting propose, le r√©alisateur et producteur d√©cident. Un bon casting = 90% du travail.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="40" y="30" width="220" height="110" fill="#2a3a4a" rx="5"/>
                <circle cx="80" cy="75" r="25" fill="#e2e8f0" opacity="0.5"/>
                <circle cx="80" cy="55" r="15" fill="#d2d8e0" opacity="0.5"/>
                <circle cx="150" cy="75" r="25" fill="#e2e8f0"/>
                <circle cx="150" cy="55" r="15" fill="#e2e8f0"/>
                <circle cx="150" cy="75" r="28" stroke="#5a8a5a" stroke-width="3" fill="none"/>
                <text x="150" y="110" text-anchor="middle" fill="#5a8a5a" font-size="8">‚úì CHOISI</text>
                <circle cx="220" cy="75" r="25" fill="#e2e8f0" opacity="0.5"/>
                <circle cx="220" cy="55" r="15" fill="#d2d8e0" opacity="0.5"/>
                <rect x="100" y="145" width="100" height="25" fill="#4a5a6a" rx="3"/>
                <text x="150" y="162" text-anchor="middle" fill="#aaa" font-size="9">üé¨ Auditions</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Trouver le bon acteur pour le r√¥le</text>
            </svg>`,
            example: 'Heath Ledger choisi pour le Joker malgr√© les doutes initiaux.'
        },
        'decoupage-classique': {
            title: 'D√©coupage classique (Hollywood)',
            description: `<p>M√©thode de tournage standard : un <strong>master shot</strong> (plan large de toute la sc√®ne) + coverage (plans rapproch√©s).</p>
            <p>Permet un montage fluide et "invisible". Le spectateur ne remarque pas les coupes.</p>
            <p>S√©curit√© maximale en post-production : toutes les options de montage sont couvertes.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="25" width="120" height="70" fill="#3a5a3a" rx="5" stroke="#5a8a5a" stroke-width="2"/>
                <text x="80" y="55" text-anchor="middle" fill="#5a8a5a" font-size="9">MASTER SHOT</text>
                <ellipse cx="55" cy="75" rx="12" ry="18" fill="#e2e8f0" opacity="0.7"/>
                <ellipse cx="105" cy="75" rx="12" ry="18" fill="#e2e8f0" opacity="0.7"/>
                <text x="80" y="110" text-anchor="middle" fill="#888" font-size="8">Plan large</text>
                <rect x="160" y="25" width="55" height="45" fill="#5a5a3a" rx="3"/>
                <circle cx="187" cy="47" r="15" fill="#e2e8f0"/>
                <text x="187" y="80" text-anchor="middle" fill="#888" font-size="7">Close-up A</text>
                <rect x="225" y="25" width="55" height="45" fill="#5a5a3a" rx="3"/>
                <circle cx="252" cy="47" r="15" fill="#d2d8e0"/>
                <text x="252" y="80" text-anchor="middle" fill="#888" font-size="7">Close-up B</text>
                <rect x="160" y="95" width="55" height="45" fill="#5a5a3a" rx="3"/>
                <text x="187" y="122" text-anchor="middle" fill="#aaa" font-size="7">Insert</text>
                <rect x="225" y="95" width="55" height="45" fill="#5a5a3a" rx="3"/>
                <text x="252" y="122" text-anchor="middle" fill="#aaa" font-size="7">Reaction</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Master + Coverage = S√©curit√© montage</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Montage invisible, fluide</text>
            </svg>`,
            example: 'Standard hollywoodien depuis les ann√©es 30.'
        },
        'decoupage-europeen': {
            title: 'D√©coupage europ√©en',
            description: `<p>Approche privil√©giant les <strong>plans longs</strong>, moins de coupes, laissant "respirer" les sc√®nes.</p>
            <p>Fait confiance au jeu des acteurs et √† la mise en sc√®ne plut√¥t qu'au montage.</p>
            <p>Moins de coverage, plus de risques, mais authenticit√© et immersion accrues.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="40" width="240" height="90" fill="#3a4a5a" rx="5" stroke="#5a7a8a" stroke-width="2"/>
                <ellipse cx="100" cy="90" rx="25" ry="35" fill="#e2e8f0"/>
                <circle cx="100" cy="55" r="18" fill="#e2e8f0"/>
                <ellipse cx="200" cy="90" rx="25" ry="35" fill="#d2d8e0"/>
                <circle cx="200" cy="55" r="18" fill="#d2d8e0"/>
                <rect x="30" y="140" width="240" height="8" fill="#2a3a4a" rx="2"/>
                <rect x="30" y="140" width="200" height="8" fill="#5a7a8a" rx="2"/>
                <text x="130" y="155" text-anchor="middle" fill="#5a7a8a" font-size="8">Plan long continu</text>
                <text x="150" y="30" text-anchor="middle" fill="#5a7a8a" font-size="10">UN SEUL PLAN - Respiration</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Moins de coupes, plus d authenticit√©</text>
            </svg>`,
            example: 'Bergman, Tarkovski, Haneke, les fr√®res Dardenne.'
        },
        'minimalisme': {
            title: 'Minimalisme cin√©matographique',
            description: `<p>√âconomie de moyens : cadres fixes, peu de mouvements, temps r√©el, peu de musique.</p>
            <p>Laisse l'<strong>espace et le temps</strong> aux spectateurs pour observer et r√©fl√©chir.</p>
            <p>Souvent associ√© au cin√©ma d'auteur iranien, japonais, ou europ√©en contemplatif.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="50" y="40" width="200" height="100" fill="#2a2a3a" rx="5" stroke="#4a4a5a" stroke-width="1"/>
                <ellipse cx="150" cy="100" rx="20" ry="30" fill="#e2e8f0"/>
                <circle cx="150" cy="70" r="15" fill="#e2e8f0"/>
                <text x="150" y="155" text-anchor="middle" fill="#4a4a5a" font-size="9">Cadre fixe - Temps r√©el</text>
                <text x="150" y="25" text-anchor="middle" fill="#888" font-size="10">√âconomie de moyens</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Laisser respirer, observer, r√©fl√©chir</text>
            </svg>`,
            example: 'Kiarostami, Ozu, Haneke, Tsai Ming-liang.'
        },
        // === IMAGE - OPTIQUES ===
        'focale-normale': {
            title: 'Focale normale (50mm)',
            description: `<p>Objectif dont l'angle de champ est proche de la <strong>vision humaine</strong> (environ 46¬∞).</p>
            <p>Rendu naturel, sans distorsion ni compression. Consid√©r√©e comme "neutre" et polyvalente.</p>
            <p>La focale de r√©f√©rence, souvent recommand√©e pour apprendre la composition.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <ellipse cx="80" cy="90" rx="20" ry="25" fill="#e2e8f0"/>
                <circle cx="80" cy="65" r="15" fill="#e2e8f0"/>
                <circle cx="75" cy="62" r="3" fill="#2a2a3e"/>
                <circle cx="85" cy="62" r="3" fill="#2a2a3e"/>
                <rect x="130" y="50" width="80" height="80" fill="#3a4a5a" rx="5"/>
                <circle cx="170" cy="90" r="30" fill="#2a3a4a"/>
                <circle cx="170" cy="90" r="20" fill="#4a5a6a"/>
                <text x="170" y="95" text-anchor="middle" fill="#aaa" font-size="10">50mm</text>
                <path d="M 100 90 L 130 90" stroke="#5a8a5a" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="115" y="85" fill="#5a8a5a" font-size="7">‚âà ≈ìil</text>
                <text x="150" y="155" text-anchor="middle" fill="#888" font-size="9">Angle ‚âà vision humaine (46¬∞)</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Neutre, naturel, polyvalent</text>
            </svg>`,
            example: 'Kubrick adorait le 50mm. Id√©al pour les portraits naturels.'
        },
        'macro': {
            title: 'Objectif Macro',
            description: `<p>Optique permettant des <strong>tr√®s gros plans</strong> sur de petits objets (ratio 1:1 ou plus).</p>
            <p>R√©v√®le des d√©tails invisibles √† l'≈ìil nu : textures, insectes, gouttes d'eau, m√©canismes.</p>
            <p>Profondeur de champ extr√™mement r√©duite. Demande stabilisation et √©clairage pr√©cis.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <circle cx="150" cy="80" r="60" fill="#2a3a4a" stroke="#4a5a6a" stroke-width="2"/>
                <ellipse cx="150" cy="75" rx="35" ry="25" fill="#5a6a3a"/>
                <ellipse cx="135" cy="70" rx="12" ry="8" fill="#2a2a2a"/>
                <ellipse cx="165" cy="70" rx="12" ry="8" fill="#2a2a2a"/>
                <path d="M 120 90 Q 150 100 180 90" stroke="#3a4a2a" stroke-width="3" fill="none"/>
                <line x1="130" y1="55" x2="120" y2="40" stroke="#4a5a3a" stroke-width="2"/>
                <line x1="170" y1="55" x2="180" y2="40" stroke="#4a5a3a" stroke-width="2"/>
                <circle cx="150" cy="80" r="65" fill="none" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="5,3"/>
                <text x="220" y="50" fill="#ff6b6b" font-size="8">Focus</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Tr√®s gros plan - D√©tails invisibles</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Ratio 1:1 ou sup√©rieur</text>
            </svg>`,
            example: 'Microcosmos, les inserts de Se7en, Planet Earth.'
        },
        'balance-blancs': {
            title: 'Balance des blancs',
            description: `<p>R√©glage de la cam√©ra pour que le <strong>blanc apparaisse neutre</strong> quelle que soit la source lumineuse.</p>
            <p>Compense la temp√©rature de couleur de la lumi√®re (tungst√®ne = chaud, daylight = froid).</p>
            <p>Peut √™tre r√©gl√©e manuellement (Kelvin) ou avec des presets (Daylight, Tungsten, Cloudy...).</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="40" width="70" height="50" fill="#ffa500" rx="5"/>
                <rect x="45" y="55" width="40" height="20" fill="#ffcc88"/>
                <text x="65" y="110" text-anchor="middle" fill="#ffa500" font-size="8">Tungst√®ne</text>
                <text x="65" y="122" text-anchor="middle" fill="#888" font-size="7">Trop chaud</text>
                <rect x="115" y="40" width="70" height="50" fill="#ffffff" rx="5" stroke="#5a8a5a" stroke-width="2"/>
                <rect x="130" y="55" width="40" height="20" fill="#f5f5f5"/>
                <text x="150" y="110" text-anchor="middle" fill="#5a8a5a" font-size="8">√âquilibr√© ‚úì</text>
                <text x="150" y="122" text-anchor="middle" fill="#5a8a5a" font-size="7">Blanc = blanc</text>
                <rect x="200" y="40" width="70" height="50" fill="#88aaff" rx="5"/>
                <rect x="215" y="55" width="40" height="20" fill="#aaccff"/>
                <text x="235" y="110" text-anchor="middle" fill="#88aaff" font-size="8">Daylight</text>
                <text x="235" y="122" text-anchor="middle" fill="#888" font-size="7">Trop froid</text>
                <text x="150" y="155" text-anchor="middle" fill="#888" font-size="9">Calibrer pour que le blanc soit neutre</text>
                <text x="150" y="175" text-anchor="middle" fill="#888" font-size="10">Kelvin ou presets (AWB)</text>
            </svg>`,
            example: 'Erreur fr√©quente : peau orange en int√©rieur tungst√®ne.'
        },
        // === SON - COUCHES SONORES ===
        'silence-cinematographique': {
            title: 'Silence (outil dramatique)',
            description: `<p>Absence volontaire de son, utilis√©e comme <strong>outil narratif puissant</strong>.</p>
            <p>Cr√©e tension, malaise, suspension. Amplifie l'impact du son qui suit.</p>
            <p>Souvent sous-estim√©. Le silence avant un moment fort d√©cuple son effet.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="70" width="240" height="40" fill="#2a3a4a" rx="5"/>
                <rect x="40" y="80" width="40" height="20" fill="#5a8a5a" rx="2"/>
                <text x="60" y="94" text-anchor="middle" fill="#fff" font-size="7">SON</text>
                <rect x="90" y="85" width="80" height="10" fill="#1a1a2e" rx="2" stroke="#ff6b6b" stroke-width="1" stroke-dasharray="3,2"/>
                <text x="130" y="75" text-anchor="middle" fill="#ff6b6b" font-size="9">SILENCE</text>
                <rect x="180" y="75" width="80" height="30" fill="#8a5a5a" rx="2"/>
                <text x="220" y="94" text-anchor="middle" fill="#fff" font-size="8">IMPACT!</text>
                <path d="M 130 110 L 130 130 L 140 120 L 130 110" fill="#ff6b6b"/>
                <text x="150" y="145" text-anchor="middle" fill="#888" font-size="9">Le silence amplifie ce qui suit</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="10">Tension, suspension, malaise</text>
            </svg>`,
            example: 'No Country for Old Men, A Quiet Place, 2001 l Odyss√©e.'
        },
        // === SC√âNARIO - FORMAT ===
        'entete-scene': {
            title: 'En-t√™te de sc√®ne (Slugline)',
            description: `<p>Premi√®re ligne de chaque sc√®ne indiquant : <strong>INT./EXT.</strong> (int√©rieur/ext√©rieur) - <strong>LIEU</strong> - <strong>MOMENT</strong> (JOUR/NUIT).</p>
            <p>Exemple : INT. APPARTEMENT DE MARIE - CUISINE - NUIT</p>
            <p>Permet √† l'√©quipe de production de planifier les d√©cors, l'√©clairage et le planning. Toujours en MAJUSCULES.</p>`,
            example: 'Standard universel dans tous les sc√©narios professionnels.'
        },
        'action-scenario': {
            title: 'Action (Description)',
            description: `<p>Paragraphes d√©crivant ce qu'on <strong>voit et entend</strong> √† l'√©cran. Toujours au pr√©sent, style concis et visuel.</p>
            <p>√âviter : pens√©es des personnages, explications, adverbes inutiles. √âcrire uniquement ce que la cam√©ra peut capter.</p>
            <p>Maximum 4 lignes par paragraphe. A√©rer pour faciliter la lecture et le rythme.</p>`,
            example: '"Marie entre. Elle pose ses cl√©s. Regarde le r√©pondeur. Trois messages."'
        },
        'dialogue-scenario': {
            title: 'Dialogue',
            description: `<p>Ce que dit le personnage. Pr√©c√©d√© du nom du personnage en MAJUSCULES, centr√©.</p>
            <p>Un bon dialogue : r√©v√®le le caract√®re, fait avancer l'intrigue, semble naturel mais est travaill√©.</p>
            <p>√âviter l'exposition maladroite ("Comme tu sais, nous sommes fr√®res depuis 30 ans...").</p>`,
            example: 'Tarantino, Sorkin et Mamet sont ma√Ætres du dialogue m√©morable.'
        },
        'didascalie': {
            title: 'Didascalie (Parenthetical)',
            description: `<p>Indication de jeu entre parenth√®ses, plac√©e entre le nom du personnage et son dialogue.</p>
            <p>Utilis√©e avec parcimonie pour : ton particulier (ironique), action pendant le dialogue (versant le caf√©), ou destinataire (√† Marie).</p>
            <p>√âviter de surcharger : faire confiance aux acteurs et au r√©alisateur pour l'interpr√©tation.</p>`,
            example: '(murmurant) ou (sans lever les yeux) ou (√† lui-m√™me)'
        },
        // === SC√âNARIO - ARC PERSONNAGE ===
        'ghost': {
            title: 'Ghost (Blessure)',
            description: `<p>Trauma ou √©v√©nement du pass√© qui <strong>d√©finit les peurs</strong> et comportements actuels du personnage.</p>
            <p>Souvent r√©v√©l√© progressivement. Explique pourquoi le personnage est "cass√©" au d√©but de l'histoire.</p>
            <p>Le climax force g√©n√©ralement le personnage √† affronter ce Ghost pour √©voluer.</p>`,
            example: 'Bruce Wayne et le meurtre de ses parents. Will Hunting et la maltraitance.'
        },
        'lie': {
            title: 'Lie (Croyance limitante)',
            description: `<p>Ce que le personnage <strong>croit √† tort</strong> sur lui-m√™me ou le monde, cons√©quence du Ghost.</p>
            <p>"Je ne m√©rite pas d'√™tre aim√©", "Le monde est cruel", "Je dois tout contr√¥ler pour survivre".</p>
            <p>L'arc transformationnel consiste √† d√©construire cette croyance pour la remplacer par la V√©rit√©.</p>`,
            example: 'Carl (L√†-haut) croit que s aventurer seul trahit Ellie.'
        },
        'verite-personnage': {
            title: 'Truth (V√©rit√©)',
            description: `<p>Ce que le personnage doit <strong>apprendre</strong> pour compl√©ter son arc et trouver la paix/r√©ussite.</p>
            <p>Oppos√©e √† la Lie. Souvent th√©matiquement li√©e au message du film.</p>
            <p>Le personnage l'accepte g√©n√©ralement au climax, ce qui lui permet de triompher (ou de tragiquement √©chouer s'il la refuse).</p>`,
            example: 'Marlin (Nemo) : "Je dois faire confiance √† mon fils et le laisser grandir."'
        },
        'besoin-vs-desir': {
            title: 'Besoin vs D√©sir (Need vs Want)',
            description: `<p><strong>D√©sir (Want)</strong> : ce que le personnage poursuit consciemment (objectif externe visible).</p>
            <p><strong>Besoin (Need)</strong> : ce dont il a vraiment besoin pour √™tre complet (souvent inconscient, interne).</p>
            <p>Les meilleures histoires cr√©ent une tension entre les deux. Le personnage obtient ce dont il a besoin, pas toujours ce qu'il veut.</p>`,
            example: 'Michael Corleone veut prot√©ger sa famille, mais a besoin de ne pas devenir son p√®re.'
        },
        // === R√âALISATION - DIRECTION D'ACTEURS ===
        'stanislavski': {
            title: 'M√©thode Stanislavski',
            description: `<p>Syst√®me de jeu d√©velopp√© par Constantin Stanislavski, fondement du jeu moderne.</p>
            <p>Principes cl√©s : <strong>m√©moire affective</strong> (puiser dans ses √©motions v√©cues), <strong>objectif</strong> (que veut le personnage ?), <strong>circonstances donn√©es</strong> (contexte complet).</p>
            <p>Recherche de la "v√©rit√©" du personnage plut√¥t que la simple imitation externe.</p>`,
            example: 'Base de formation de la plupart des √©coles de th√©√¢tre mondiales.'
        },
        'actors-studio': {
            title: 'Actors Studio (M√©thode)',
            description: `<p>√âcole new-yorkaise fond√©e en 1947, c√©l√®bre pour la "Method Acting" de Lee Strasberg.</p>
            <p>Pousse le Stanislavski plus loin : <strong>immersion totale</strong> dans le personnage, parfois pendant des mois hors plateau.</p>
            <p>Critiqu√©e pour ses exc√®s mais a produit des performances iconiques.</p>`,
            example: 'De Niro (Taxi Driver), Day-Lewis, Brando, Pacino, Hoffman.'
        },
        'meisner': {
            title: 'Technique Meisner',
            description: `<p>M√©thode d√©velopp√©e par Sanford Meisner, ax√©e sur la <strong>r√©action instinctive</strong> et l'√©coute du partenaire.</p>
            <p>Exercice cl√© : la r√©p√©tition. Deux acteurs r√©p√®tent une phrase en variant selon les r√©actions de l'autre.</p>
            <p>Moins d'introspection que Stanislavski, plus d'attention √† l'instant pr√©sent et au partenaire.</p>`,
            example: 'Robert Duvall, Diane Keaton, Grace Kelly, Tom Cruise.'
        },
        'approche-bresson': {
            title: 'Approche Bresson',
            description: `<p>Philosophie radicale de Robert Bresson : utiliser des "mod√®les" (non-acteurs) plut√¥t que des acteurs professionnels.</p>
            <p>R√©p√©ter chaque prise jusqu'√† <strong>√©puisement du jeu conscient</strong>. Ce qui reste est authentique, d√©pouill√©.</p>
            <p>Refus de la psychologie, de l'expressivit√©. Laisser le montage et le contexte cr√©er l'√©motion.</p>`,
            example: 'Pickpocket, Au hasard Balthazar, L Argent.'
        },
        'improvisation-dirigee': {
            title: 'Improvisation dirig√©e',
            description: `<p>Le r√©alisateur d√©finit un <strong>cadre</strong> (situation, objectifs, enjeux) mais laisse les acteurs improviser le dialogue et les actions.</p>
            <p>Cr√©e une spontan√©it√© et un naturel impossibles √† sc√©nariser. Demande des acteurs tr√®s pr√©par√©s et un r√©alisateur r√©actif.</p>
            <p>Le sc√©nario final est parfois √©crit apr√®s le tournage, √† partir des rushes.</p>`,
            example: 'Cassavetes, Mike Leigh, Kechiche, les fr√®res Dardenne.'
        },
        // === IMAGE - COMPOSITION ===
        'lignes-directrices': {
            title: 'Lignes directrices (Leading Lines)',
            description: `<p>√âl√©ments visuels naturels (routes, rampes, regards, architecture) qui <strong>guident l'≈ìil du spectateur</strong> vers le sujet principal.</p>
            <p>Peuvent converger vers un point (perspective), encadrer le sujet, ou cr√©er une dynamique de mouvement.</p>
            <p>Outil fondamental de composition pour contr√¥ler o√π le spectateur regarde dans le cadre.</p>`,
            example: 'Les couloirs de Kubrick, les rails dans Il √©tait une fois dans l Ouest.'
        },
        // === SON - AVANC√â ===
        'trans-diegetique': {
            title: 'Son trans-di√©g√©tique',
            description: `<p>Son qui <strong>passe d'un √©tat √† l'autre</strong> : de di√©g√©tique √† extra-di√©g√©tique ou inversement.</p>
            <p>Exemple : une musique de film (extra-di√©g√©tique) qui devient la radio d'une voiture (di√©g√©tique), ou l'inverse.</p>
            <p>Cr√©e des transitions √©l√©gantes et joue avec la fronti√®re entre le monde du film et sa narration.</p>`,
            example: 'Apocalypse Now : "The End" passe de la bande-son √† la radio de l h√©lico.'
        },
        'sound-metaphor': {
            title: 'M√©taphore sonore',
            description: `<p>Son utilis√© pour <strong>repr√©senter une id√©e, une √©motion ou un concept</strong> au-del√† de sa source r√©elle.</p>
            <p>Le battement de c≈ìur = tension/peur. Le tic-tac = temps qui presse. Le vent = solitude ou changement.</p>
            <p>Permet d'exprimer l'int√©riorit√© des personnages ou les th√®mes du film de mani√®re subtile.</p>`,
            example: 'Le battement de c≈ìur r√©v√©lateur dans The Tell-Tale Heart (Poe).'
        },
        // === SON - COUCHES ET TECHNIQUES ===
        'dialogues-son': {
            title: 'Dialogues',
            description: `<p>Voix des personnages, √©l√©ment <strong>le plus important</strong> de la bande-son narrative.</p>
            <p>Doivent toujours √™tre intelligibles sauf choix artistique d√©lib√©r√©. Priorit√© absolue lors de l'enregistrement et du mixage.</p>
            <p>Enregistr√©s sur le plateau (son direct) et/ou en post-synchronisation (ADR/doublage).</p>`,
            example: 'Un dialogue inaudible = spectateur perdu. Toujours prot√©ger les voix.'
        },
        'musique-film': {
            title: 'Musique de film (Score)',
            description: `<p>Composition originale ou morceaux existants accompagnant l'image pour renforcer l'√©motion.</p>
            <p><strong>Score</strong> = musique originale compos√©e pour le film. <strong>Soundtrack</strong> = compilation de morceaux existants.</p>
            <p>Peut √™tre di√©g√©tique (radio dans la sc√®ne) ou extra-di√©g√©tique (que le spectateur entend).</p>`,
            example: 'John Williams (Star Wars), Hans Zimmer (Inception), Ennio Morricone.'
        },
        'multi-pistes': {
            title: 'Enregistrement multi-pistes',
            description: `<p>Chaque source sonore (micro) enregistr√©e sur une <strong>piste s√©par√©e</strong> pour flexibilit√© au mixage.</p>
            <p>Permet d'ajuster individuellement chaque micro en post : niveau, √©galisation, effets.</p>
            <p>Standard professionnel. Enregistreurs 4, 8 ou 16 pistes (Sound Devices, Zoom F8, etc.).</p>`,
            example: 'Un acteur avec cravate + perche = 2 pistes s√©par√©es pour choisir au mix.'
        },
        'ms-stereo': {
            title: 'MS (Mid-Side)',
            description: `<p>Configuration st√©r√©o utilisant un micro cardio√Øde (Mid) et un micro bidirectionnel (Side).</p>
            <p>Avantage : la <strong>largeur st√©r√©o est ajustable en post</strong>-production. Compatible mono parfait.</p>
            <p>Id√©al pour les ambiances quand on ne conna√Æt pas encore les besoins du mixage final.</p>`,
            example: 'Technique pris√©e des preneurs de son documentaire.'
        },
        'boom-vs-lav': {
            title: 'Boom vs Lavallier',
            description: `<p><strong>Perche (boom)</strong> : son naturel, perspective coh√©rente avec l'image, mais risque d'entrer dans le cadre.</p>
            <p><strong>Cravate (lav)</strong> : s√©curit√©, toujours proche de la source, mais son moins naturel et risque de frottements.</p>
            <p>Id√©alement : les deux en m√™me temps pour avoir le choix au mixage.</p>`,
            example: 'Plan large = cravate en s√©curit√©. Plan serr√© = perche privil√©gi√©e.'
        },
        'plant-mic': {
            title: 'Plant mic (Micro plant√©)',
            description: `<p>Micro <strong>cach√© dans le d√©cor</strong>, fixe, pour capter le son quand la perche ne peut pas approcher.</p>
            <p>Utilis√© pour les plans tr√®s larges, les sc√®nes avec mouvement complexe, ou les d√©cors difficiles.</p>
            <p>Plac√© strat√©giquement : dans un bouquet, sous une table, derri√®re un objet.</p>`,
            example: 'Sc√®ne de d√Æner film√©e en plan large avec plusieurs convives.'
        },
        'panning': {
            title: 'Panoramique audio (Panning)',
            description: `<p>Placement d'un son dans l'espace st√©r√©o ou surround, de gauche √† droite (et avant/arri√®re en surround).</p>
            <p>Doit g√©n√©ralement <strong>suivre l'image</strong> : un personnage √† gauche de l'√©cran = voix l√©g√®rement √† gauche.</p>
            <p>Les dialogues restent souvent centr√©s pour stabilit√©, les ambiances et effets sont spatialis√©s.</p>`,
            example: 'Une voiture traverse l √©cran : le son passe de gauche √† droite.'
        },
        'formats-audio': {
            title: 'Formats audio (Mono/St√©r√©o/Surround)',
            description: `<p><strong>Mono</strong> : 1 canal, historique, encore utilis√© pour dialogues centr√©s.</p>
            <p><strong>St√©r√©o (2.0)</strong> : Gauche/Droite, standard minimal TV et web.</p>
            <p><strong>5.1/7.1</strong> : Surround cin√©ma avec canaux arri√®re. <strong>Atmos</strong> : son 3D avec canaux au plafond.</p>`,
            example: 'Cin√©ma = minimum 5.1. Streaming = souvent st√©r√©o avec option 5.1.'
        },
        'lfe': {
            title: 'LFE (Low Frequency Effects)',
            description: `<p>Canal d√©di√© aux <strong>basses fr√©quences</strong> (20-120 Hz) dans les syst√®mes surround (le ".1" de 5.1).</p>
            <p>Reproduit par le caisson de basses (subwoofer). Utilis√© pour les explosions, impacts, grondements, tension physique.</p>
            <p>Ressenti autant que entendu. Cr√©e une exp√©rience visc√©rale, physique.</p>`,
            example: 'Les explosions de Nolan, le rugissement du T-Rex dans Jurassic Park.'
        },
        // === MONTAGE - RACCORDS ===
        'raccord-axe': {
            title: 'Raccord dans l\'axe',
            description: `<p>Changement de valeur de plan (PE ‚Üí PM ‚Üí GP) en restant sur le <strong>m√™me axe de cam√©ra</strong>.</p>
            <p>Permet de se rapprocher ou s'√©loigner du sujet sans changer d'angle, cr√©ant une intensification ou un recul √©motionnel.</p>
            <p>Doit respecter la r√®gle des 30¬∞ implicitement : le changement de valeur doit √™tre suffisamment significatif.</p>`,
            example: 'Les zooms avant de Spielberg sur les visages en r√©action.'
        },
        'raccord-mouvement': {
            title: 'Raccord mouvement',
            description: `<p>Coupe effectu√©e <strong>pendant une action</strong> (un geste, un d√©placement) pour fluidifier la transition.</p>
            <p>Le mouvement commenc√© dans le plan A se poursuit dans le plan B. L'≈ìil suit l'action et "oublie" la coupe.</p>
            <p>Technique fondamentale du montage invisible hollywoodien.</p>`,
            example: 'Un personnage se l√®ve : coupe pendant le mouvement, pas avant ni apr√®s.'
        },
        'franchissement-axe': {
            title: 'Franchissement d\'axe',
            description: `<p>Passage de la cam√©ra de l'autre c√¥t√© de la <strong>ligne des 180¬∞</strong>, inversant les positions apparentes des sujets.</p>
            <p>G√©n√©ralement consid√©r√© comme une erreur d√©sorientante. Mais peut √™tre volontaire pour cr√©er confusion, rupture ou malaise.</p>
            <p>Pour franchir proprement : plan neutre (sur la ligne), plan de coupe, ou mouvement de cam√©ra visible.</p>`,
            example: 'Kubrick franchit volontairement dans Shining pour d√©sorienter.'
        },
        'faux-raccord': {
            title: 'Faux raccord',
            description: `<p>Incoh√©rence visuelle entre deux plans : accessoire qui change de place, niveau de verre diff√©rent, lumi√®re incoh√©rente.</p>
            <p>Erreur de <strong>continuit√©</strong> (script supervisor). Peut sortir le spectateur du film s'il est visible.</p>
            <p>Parfois in√©vitable (tourn√© sur plusieurs jours), le monteur essaie de les masquer ou les minimiser.</p>`,
            example: 'Les compilations de "movie mistakes" sur YouTube.'
        },
        // === MONTAGE - TH√âORIES ===
        'montage-intellectuel': {
            title: 'Montage intellectuel (Eisenstein)',
            description: `<p>Th√©orie de Sergei Eisenstein : la <strong>collision</strong> de deux plans cr√©e une id√©e nouvelle absente des deux.</p>
            <p>Plan A + Plan B = Concept C (th√®se + antith√®se = synth√®se). Le sens √©merge du choc, pas des images individuelles.</p>
            <p>Montage comme outil de pens√©e et d'argumentation, pas seulement de narration.</p>`,
            example: 'La s√©quence des escaliers d Odessa dans Le Cuirass√© Potemkine.'
        },
        'montage-invisible': {
            title: 'Montage invisible (Classique)',
            description: `<p>Style hollywoodien classique o√π les coupes sont si <strong>fluides</strong> que le spectateur oublie qu'il regarde un film mont√©.</p>
            <p>Utilise : raccords regard, raccords mouvement, r√®gle des 180¬∞, continuit√© parfaite. Le montage sert l'histoire, pas lui-m√™me.</p>
            <p>Objectif : immersion totale, suspension d'incr√©dulit√© maximale.</p>`,
            example: 'Les films de Spielberg, la plupart des blockbusters modernes.'
        },
        'montage-visible': {
            title: 'Montage visible (Moderne)',
            description: `<p>Style qui <strong>assume et exhibe</strong> les coupes : jump cuts, faux raccords volontaires, ruptures de rythme.</p>
            <p>Rappelle constamment au spectateur qu'il regarde un film. Associ√© √† la Nouvelle Vague, au cin√©ma d'auteur.</p>
            <p>Peut cr√©er √©nergie, malaise, modernit√© ou distanciation brechtienne.</p>`,
            example: '√Ä bout de souffle (Godard), les films de Wong Kar-wai.'
        },
        // === MONTAGE - M√âTHODES EISENSTEIN ===
        'montage-metrique': {
            title: 'Montage m√©trique',
            description: `<p>Coupes √† <strong>intervalles r√©guliers</strong>, ind√©pendamment du contenu des plans.</p>
            <p>Cr√©e un rythme m√©canique, hypnotique ou oppressant. La dur√©e des plans est math√©matiquement d√©termin√©e.</p>
            <p>Premi√®re des 5 m√©thodes de montage th√©oris√©es par Eisenstein.</p>`,
            example: 'S√©quences de tension avec acc√©l√©ration progressive des coupes.'
        },
        'montage-rythmique': {
            title: 'Montage rythmique',
            description: `<p>Coupes dict√©es par le <strong>mouvement dans le plan</strong>, pas par une dur√©e fixe.</p>
            <p>Le contenu visuel d√©termine le rythme : action rapide = coupe rapide, contemplation = plan long.</p>
            <p>Plus organique que le montage m√©trique, suit l'√©nergie interne des images.</p>`,
            example: 'Les poursuites en voiture, les sc√®nes de combat.'
        },
        'montage-tonal': {
            title: 'Montage tonal',
            description: `<p>Coupes bas√©es sur l'<strong>√©motion dominante</strong> du plan : lumi√®re, atmosph√®re, texture.</p>
            <p>Cr√©e une continuit√© √©motionnelle plut√¥t que narrative. Les plans "sonnent" ensemble.</p>
            <p>Utilis√© pour les s√©quences po√©tiques, contemplatives ou expressionnistes.</p>`,
            example: 'Les s√©quences oniriques, les montages atmosph√©riques.'
        },
        // === MONTAGE - TECHNIQUES ===
        'montage-alterne': {
            title: 'Montage altern√© (Cross-cutting)',
            description: `<p>Alternance entre <strong>deux actions simultan√©es</strong> dans des lieux diff√©rents.</p>
            <p>Cr√©e suspense et tension : "Arrivera-t-il √† temps ?" Les deux lignes convergent vers un climax commun.</p>
            <p>Invent√© par D.W. Griffith. Outil fondamental du suspense cin√©matographique.</p>`,
            example: 'Le sauvetage de derni√®re minute, la course contre la montre.'
        },
        'flashback': {
            title: 'Flashback / Flash-forward',
            description: `<p><strong>Flashback</strong> : retour dans le pass√© pour r√©v√©ler information, trauma ou souvenir.</p>
            <p><strong>Flash-forward</strong> : saut dans le futur, plus rare, cr√©e anticipation ou ironie dramatique.</p>
            <p>Signal√© visuellement (fondu, couleur diff√©rente) ou par le son (√©cho, musique sp√©cifique).</p>`,
            example: 'Citizen Kane, Memento (structure invers√©e), Arrival.'
        },
        'sequence-montage': {
            title: 'S√©quence de montage',
            description: `<p>Suite de plans courts <strong>condensant le temps</strong> : entra√Ænement, transformation, passage des saisons.</p>
            <p>Souvent accompagn√©e de musique. Montre une √©volution qui prendrait trop de temps en temps r√©el.</p>
            <p>Clich√© quand mal utilis√©e, puissante quand justifi√©e narrativement.</p>`,
            example: 'Rocky (entra√Ænement), Scarface (ascension), tout film de sport.'
        },
        'split-screen': {
            title: 'Split screen (√âcran divis√©)',
            description: `<p>√âcran divis√© en plusieurs zones montrant des <strong>actions simultan√©es</strong> visibles en m√™me temps.</p>
            <p>Alternative au montage altern√© : le spectateur voit tout sans coupe. Cr√©e comparaison ou tension.</p>
            <p>Peut diviser en 2, 3, 4 zones ou plus. Signature de Brian De Palma.</p>`,
            example: 'Requiem for a Dream, 24 (s√©rie TV), Conversations secr√®tes.'
        },
        'smash-cut': {
            title: 'Smash cut',
            description: `<p>Coupe <strong>brutale et inattendue</strong>, souvent d'une sc√®ne calme vers une sc√®ne intense (ou l'inverse).</p>
            <p>Cr√©e un effet de choc, de surprise, de rupture. Aucune transition, aucun avertissement.</p>
            <p>Souvent utilis√© pour les r√©veils brutaux, les contrastes comiques ou dramatiques.</p>`,
            example: '"C est impossible !" SMASH CUT vers la sc√®ne o√π c est fait.'
        },
        // === MONTAGE - WORKFLOW ===
        'bout-a-bout': {
            title: 'Bout-√†-bout (Assembly)',
            description: `<p>Premier assemblage chronologique des <strong>meilleures prises</strong> retenues.</p>
            <p>Pas encore du montage artistique : juste mettre les sc√®nes dans l'ordre. Peut durer 3-4h pour un film de 2h.</p>
            <p>Permet de voir l'ensemble du mat√©riel et d'identifier les probl√®mes majeurs.</p>`,
            example: 'Premi√®re √©tape apr√®s le d√©rushage et la synchronisation.'
        },
        'rough-cut': {
            title: 'Ours / Rough cut',
            description: `<p>Premier <strong>montage complet</strong> du film, encore long et imparfait.</p>
            <p>Structure narrative en place, mais rythme pas encore affin√©. Contient souvent des sc√®nes qui seront coup√©es.</p>
            <p>Base de travail pour les retours du r√©alisateur et des producteurs.</p>`,
            example: 'G√©n√©ralement 20-30% plus long que le film final.'
        },
        'fine-cut': {
            title: 'Fine cut',
            description: `<p>Montage <strong>affin√©</strong> : rythme ajust√©, sc√®nes inutiles supprim√©es, timing pr√©cis.</p>
            <p>Le film approche sa dur√©e finale. Les choix majeurs sont faits, on peaufine les d√©tails.</p>
            <p>Pr√©c√®de le picture lock (verrouillage image) apr√®s lequel on ne touche plus au montage.</p>`,
            example: '√âtape cruciale o√π chaque frame compte.'
        },
        // === PRODUCTION - √âTAPES ===
        'developpement': {
            title: 'D√©veloppement',
            description: `<p>Premi√®re phase d'un projet : <strong>√©criture du sc√©nario</strong>, recherche de financements, montage du projet.</p>
            <p>Peut durer des mois ou des ann√©es. Inclut : traitement, versions du script, recherche de producteur, casting pr√©liminaire.</p>
            <p>Phase la plus incertaine : beaucoup de projets ne d√©passent jamais ce stade.</p>`,
            example: 'Certains scripts passent 10+ ans en d√©veloppement avant d √™tre tourn√©s.'
        },
        'pre-production': {
            title: 'Pr√©-production',
            description: `<p>Phase de <strong>pr√©paration</strong> entre le feu vert et le premier jour de tournage.</p>
            <p>Inclut : d√©coupage technique, storyboard, casting, rep√©rages, constitution de l'√©quipe, plan de travail, budget d√©taill√©.</p>
            <p>Dur√©e typique : 2-6 mois selon l'ampleur du projet. Une bonne pr√©pa = un tournage serein.</p>`,
            example: '"Un film se gagne ou se perd en pr√©-production."'
        },
        'production-tournage': {
            title: 'Production (Tournage)',
            description: `<p>Phase de <strong>r√©alisation effective</strong> : cam√©ra qui tourne, acteurs qui jouent.</p>
            <p>P√©riode la plus intense et la plus co√ªteuse (√©quipe compl√®te sur le terrain chaque jour).</p>
            <p>Dur√©e typique : 4-12 semaines pour un long-m√©trage. Chaque jour de retard co√ªte tr√®s cher.</p>`,
            example: 'On dit "tourner un film" mais le tournage n est qu une phase parmi d autres.'
        },
        'post-production': {
            title: 'Post-production',
            description: `<p>Tout ce qui se passe <strong>apr√®s le tournage</strong> : montage, √©talonnage, mixage, VFX, musique.</p>
            <p>Souvent plus longue que le tournage lui-m√™me. C'est l√† que le film prend vraiment forme.</p>
            <p>Dur√©e typique : 3-12 mois selon complexit√© (VFX lourds = plus long).</p>`,
            example: 'Un film Marvel peut passer 18 mois en post-production pour les VFX.'
        },
        'distribution': {
            title: 'Distribution',
            description: `<p>Phase de <strong>commercialisation</strong> : festivals, ventes internationales, sortie en salles, VOD, TV.</p>
            <p>Le distributeur ach√®te les droits et g√®re : copies, marketing, programmation, relations presse.</p>
            <p>Un bon film mal distribu√© peut passer inaper√ßu. La distribution est cruciale pour le succ√®s.</p>`,
            example: 'Cannes, Venise, Toronto = vitrines pour trouver des distributeurs.'
        },
        // === PRODUCTION - DOCUMENTS ===
        'budget-film': {
            title: 'Budget',
            description: `<p>Estimation d√©taill√©e de <strong>tous les co√ªts</strong> du film, divis√©e en postes et sous-postes.</p>
            <p><strong>Above the line</strong> : droits, sc√©nario, r√©alisateur, producteur, acteurs principaux (co√ªts cr√©atifs).</p>
            <p><strong>Below the line</strong> : √©quipe technique, mat√©riel, d√©cors, post-production (co√ªts de fabrication).</p>`,
            example: 'Un budget bien fait pr√©voit 10% de contingence pour les impr√©vus.'
        },
        'contrats-film': {
            title: 'Contrats',
            description: `<p>Documents juridiques <strong>encadrant les relations</strong> entre la production et tous les intervenants.</p>
            <p>Types : contrats d'engagement (√©quipe, acteurs), cession de droits (musique, sc√©nario), accord de coproduction.</p>
            <p>Doivent pr√©ciser : r√©mun√©ration, droits c√©d√©s, cr√©dits, dur√©e, territoire, obligations.</p>`,
            example: 'CDDU (intermittents), contrats de cession de droits d auteur.'
        },
        // === PRODUCTION - POSTES CL√âS ===
        'producteur': {
            title: 'Producteur',
            description: `<p>Responsable <strong>global du projet</strong> : financement, supervision cr√©ative et logistique.</p>
            <p>Trouve l'argent, engage le r√©alisateur, supervise la production, prend les d√©cisions strat√©giques.</p>
            <p>Plusieurs types : producteur d√©l√©gu√© (patron), ex√©cutif (supervise), associ√© (apporte quelque chose).</p>`,
            example: 'Le producteur a le final cut aux USA, le r√©alisateur en France (souvent).'
        },
        'directeur-production': {
            title: 'Directeur de production',
            description: `<p>Bras droit du producteur, g√®re le <strong>budget et la logistique</strong> au quotidien.</p>
            <p>√âtablit le budget d√©taill√©, n√©gocie les contrats, surveille les d√©penses, r√©sout les probl√®mes concrets.</p>
            <p>Interface entre les besoins artistiques et les contraintes financi√®res.</p>`,
            example: 'C est lui qui dit "on n a pas le budget pour √ßa" (ou trouve comment l avoir).'
        },
        'premier-assistant': {
            title: '1er Assistant r√©alisateur',
            description: `<p><strong>Chef d'orchestre du plateau</strong> : g√®re le planning, le timing, la coordination de toute l'√©quipe.</p>
            <p>√âtablit le plan de travail, organise chaque journ√©e, annonce les ordres ("Silence, on tourne !").</p>
            <p>Lib√®re le r√©alisateur des contraintes logistiques pour qu'il se concentre sur l'artistique.</p>`,
            example: 'Le 1er AD conna√Æt le plan de travail par c≈ìur et anticipe tout.'
        },
        'regisseur': {
            title: 'R√©gisseur',
            description: `<p>Responsable de la <strong>logistique quotidienne</strong> : lieux, transports, repas, h√©bergement.</p>
            <p>N√©gocie les autorisations de tournage, organise les d√©cors, g√®re les impr√©vus pratiques.</p>
            <p>Le "couteau suisse" de la production, doit r√©soudre tous les probl√®mes concrets.</p>`,
            example: 'Trouver 50 figurants pour demain, un camion de pompiers, et un repas v√©gan.'
        },
        // === IMAGE - FORMAT ===
        'ratio-169': {
            title: 'Format 16:9 (1.78:1)',
            description: `<p>Ratio <strong>standard actuel</strong> pour la t√©l√©vision HD, le streaming et la plupart des √©crans.</p>
            <p>Compromis entre le 4:3 t√©l√©visuel historique et le 1.85:1 cin√©ma. Adopt√© mondialement depuis les ann√©es 2000.</p>
            <p>Format natif des capteurs HD, 4K, des √©crans TV et ordinateurs modernes.</p>`,
            example: 'Netflix, YouTube, t√©l√©vision HD, la majorit√© du contenu actuel.'
        },
        // === SC√âNARIO - FORMAT ===
        'personnage-scenario': {
            title: 'Personnage (Character cue)',
            description: `<p>Nom du personnage en <strong>MAJUSCULES</strong>, centr√©, avant chaque r√©plique de dialogue.</p>
            <p>Premi√®re apparition : nom suivi de (√¢ge) et br√®ve description. Ensuite : juste le nom.</p>
            <p>Coh√©rence obligatoire : toujours le m√™me nom (pas "MARIE" puis "LA FEMME" pour le m√™me personnage).</p>`,
            example: 'MARIE (30 ans, nerveuse, √©l√©gante malgr√© elle) entre dans le caf√©.'
        },
        'sfx': {
            title: 'Effets sonores (SFX)',
            description: `<p>Sons ponctuels synchronis√©s √† l'image : portes, pas, coups, v√©hicules, explosions.</p>
            <p>Peuvent √™tre <strong>r√©alistes</strong> (enregistr√©s) ou <strong>stylis√©s</strong> (cr√©√©s pour l'effet dramatique).</p>
            <p>Diff√©rent du Foley (bruitage en studio) : SFX = sons pr√©-enregistr√©s en biblioth√®que ou cr√©√©s en sound design.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="30" y="30" width="100" height="70" fill="#2a3a4a" rx="5"/>
                <rect x="50" y="50" width="30" height="40" fill="#4a3a2a" rx="2"/>
                <circle cx="65" cy="60" r="5" fill="#3a2a1a"/>
                <text x="80" y="115" text-anchor="middle" fill="#888" font-size="8">üö™ Porte</text>
                <rect x="170" y="30" width="100" height="70" fill="#2a3a4a" rx="5"/>
                <circle cx="220" cy="65" r="20" fill="#4a4a4a"/>
                <circle cx="220" cy="65" r="12" fill="#3a3a3a"/>
                <path d="M 210 55 L 230 75" stroke="#ff6b6b" stroke-width="3"/>
                <path d="M 230 55 L 210 75" stroke="#ff6b6b" stroke-width="3"/>
                <text x="220" y="115" text-anchor="middle" fill="#888" font-size="8">üí• Explosion</text>
                <rect x="100" y="130" width="100" height="30" fill="#3a4a5a" rx="5"/>
                <text x="150" y="150" text-anchor="middle" fill="#aaa" font-size="9">SFX Library</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Sons ponctuels synchronis√©s</text>
            </svg>`,
            example: 'Le sabre laser de Star Wars (SFX cr√©√© par Ben Burtt).'
        },
        'lumiere-naturelle': {
            title: 'Lumi√®re naturelle',
            description: `<p>Utilisation exclusive ou principale du soleil comme source de lumi√®re, sans √©clairage artificiel.</p>
            <p>Cr√©e un <strong>r√©alisme</strong> et une authenticit√© uniques. Demande une grande ma√Ætrise des horaires et de la m√©t√©o.</p>
            <p>Signature de Terrence Malick et Emmanuel Lubezki. Contraignant mais r√©sultats organiques.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:linear-gradient(180deg, #5a7a9a 0%, #8aaaca 50%, #daa 100%); border-radius:8px;">
                <circle cx="250" cy="40" r="30" fill="#ffd700"/>
                <circle cx="250" cy="40" r="35" fill="#ffd700" opacity="0.3"/>
                <path d="M 250 40 L 150 100" stroke="#ffd700" stroke-width="2" stroke-dasharray="10,5" opacity="0.5"/>
                <path d="M 250 40 L 100 120" stroke="#ffd700" stroke-width="2" stroke-dasharray="10,5" opacity="0.3"/>
                <rect x="30" y="100" width="80" height="60" fill="#4a5a4a"/>
                <rect x="45" y="110" width="20" height="25" fill="#3a4a3a"/>
                <rect x="75" y="115" width="15" height="20" fill="#3a4a3a"/>
                <ellipse cx="180" cy="130" rx="25" ry="35" fill="#e2e8f0"/>
                <circle cx="180" cy="95" r="18" fill="#e2e8f0"/>
                <rect x="0" y="160" width="300" height="20" fill="#5a6a4a"/>
                <text x="150" y="178" text-anchor="middle" fill="#333" font-size="10">Soleil = seule source (Malick, Lubezki)</text>
            </svg>`,
            example: 'The Tree of Life, The Revenant, Days of Heaven.'
        },
        'decoupage-technique': {
            title: 'D√©coupage technique',
            description: `<p>Document d√©taillant plan par plan comment le sc√©nario sera film√© : valeurs de plan, mouvements, axes.</p>
            <p>√âtabli par le r√©alisateur en pr√©-production, c'est la <strong>partition</strong> du tournage.</p>
            <p>Peut √™tre accompagn√© d'un storyboard pour visualiser les plans complexes.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="40" y="25" width="220" height="130" fill="#e8e8d8" rx="5"/>
                <text x="150" y="45" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">D√âCOUPAGE TECHNIQUE</text>
                <line x1="50" y1="52" x2="250" y2="52" stroke="#999"/>
                <text x="60" y="68" fill="#333" font-size="7">Sc.12 | Plan 1 | PM | Marie</text>
                <text x="60" y="80" fill="#555" font-size="6">Travelling avant, Marie entre dans le caf√©</text>
                <line x1="50" y1="85" x2="250" y2="85" stroke="#ddd"/>
                <text x="60" y="98" fill="#333" font-size="7">Sc.12 | Plan 2 | GP | Marie</text>
                <text x="60" y="110" fill="#555" font-size="6">Insert sur le visage, r√©action</text>
                <line x1="50" y1="115" x2="250" y2="115" stroke="#ddd"/>
                <text x="60" y="128" fill="#333" font-size="7">Sc.12 | Plan 3 | Subj. | POV Marie</text>
                <text x="60" y="140" fill="#555" font-size="6">Elle voit Paul au comptoir</text>
                <text x="150" y="172" text-anchor="middle" fill="#888" font-size="10">La partition du tournage</text>
            </svg>`,
            example: 'Pr√©par√© par le r√©alisateur avec le 1er assistant.'
        },
        'plan-travail': {
            title: 'Plan de travail',
            description: `<p>Calendrier d√©taill√© du tournage, jour par jour, r√©partissant les sc√®nes du sc√©nario.</p>
            <p>Optimis√© par d√©cor, disponibilit√© des com√©diens, contraintes jour/nuit, m√©t√©o, difficult√©s techniques.</p>
            <p>Document √©volutif, constamment ajust√© par le 1er assistant r√©alisateur. La colonne vert√©brale du tournage.</p>`,
            image: `<svg viewBox="0 0 300 180" style="background:#1a1a2e; border-radius:8px;">
                <rect x="20" y="30" width="260" height="120" fill="#e8e8d8" rx="5"/>
                <text x="150" y="50" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">PLAN DE TRAVAIL</text>
                <line x1="30" y1="58" x2="270" y2="58" stroke="#999" stroke-width="1"/>
                <text x="50" y="72" text-anchor="middle" fill="#555" font-size="7">J1</text>
                <text x="90" y="72" text-anchor="middle" fill="#555" font-size="7">J2</text>
                <text x="130" y="72" text-anchor="middle" fill="#555" font-size="7">J3</text>
                <text x="170" y="72" text-anchor="middle" fill="#555" font-size="7">J4</text>
                <text x="210" y="72" text-anchor="middle" fill="#555" font-size="7">J5</text>
                <text x="250" y="72" text-anchor="middle" fill="#555" font-size="7">J6</text>
                <rect x="35" y="78" width="30" height="20" fill="#5a8a5a" rx="2"/>
                <rect x="35" y="100" width="30" height="15" fill="#5a8a5a" rx="2"/>
                <rect x="75" y="78" width="30" height="30" fill="#5a8a5a" rx="2"/>
                <rect x="115" y="78" width="30" height="25" fill="#8a5a5a" rx="2"/>
                <rect x="115" y="105" width="30" height="15" fill="#8a5a5a" rx="2"/>
                <rect x="155" y="78" width="30" height="35" fill="#8a5a5a" rx="2"/>
                <rect x="195" y="78" width="30" height="20" fill="#5a5a8a" rx="2"/>
                <rect x="195" y="100" width="30" height="18" fill="#5a5a8a" rx="2"/>
                <rect x="235" y="78" width="30" height="40" fill="#5a5a8a" rx="2"/>
                <text x="50" y="135" fill="#5a8a5a" font-size="6">‚ñ† D√©cor A</text>
                <text x="130" y="135" fill="#8a5a5a" font-size="6">‚ñ† D√©cor B</text>
                <text x="210" y="135" fill="#5a5a8a" font-size="6">‚ñ† D√©cor C</text>
                <text x="150" y="165" text-anchor="middle" fill="#888" font-size="9">Regrouper par d√©cor = optimiser</text>
                <text x="150" y="178" text-anchor="middle" fill="#888" font-size="10">Colonne vert√©brale du tournage</text>
            </svg>`,
            example: 'On ne tourne JAMAIS dans l ordre du sc√©nario.'
        }
    },
    
    getCourses: () => ({
        scenario: `
            <div class="courses-section">
                <h2>üìù Les Fondamentaux du Sc√©nario</h2>
                
                <h3><span class="notion" data-notion="structure-3-actes">La Structure en 3 Actes</span></h3>
                <p>La structure classique d'un sc√©nario se divise en trois actes :</p>
                <ul>
                    <li><strong>Acte I - L'Exposition (25%)</strong> : Pr√©sentation du personnage, de son monde et de l'√©l√©ment d√©clencheur qui lance l'histoire.</li>
                    <li><strong>Acte II - La Confrontation (50%)</strong> : Le personnage fait face √† des obstacles croissants. Contient le <span class="notion" data-notion="midpoint">point m√©dian</span> et la crise.</li>
                    <li><strong>Acte III - La R√©solution (25%)</strong> : Climax et d√©nouement. Le personnage atteint (ou non) son objectif.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Astuce :</strong> Une page de sc√©nario = environ 1 minute de film. Un long-m√©trage fait g√©n√©ralement 90-120 pages.
                </div>
                
                <h3>Les √âl√©ments Cl√©s</h3>
                <ul>
                    <li><span class="notion" data-notion="protagoniste">Le protagoniste</span> : Personnage principal avec un objectif clair et des obstacles √† surmonter.</li>
                    <li><span class="notion" data-notion="antagoniste">L'antagoniste</span> : Force qui s'oppose au protagoniste (personne, institution, nature, lui-m√™me).</li>
                    <li><span class="notion" data-notion="enjeu">L'enjeu</span> : Ce que le protagoniste risque de perdre s'il √©choue.</li>
                    <li><span class="notion" data-notion="conflit">Le conflit</span> : Moteur de l'histoire, cr√©e la tension dramatique.</li>
                </ul>
                
                <h3>Le Format du Sc√©nario</h3>
                <ul>
                    <li><span class="notion" data-notion="entete-scene">En-t√™te de sc√®ne</span> : INT./EXT. - LIEU - MOMENT (ex: INT. APPARTEMENT - JOUR)</li>
                    <li><span class="notion" data-notion="action-scenario">Action</span> : Description au pr√©sent, ce qu'on voit et entend.</li>
                    <li><span class="notion" data-notion="personnage-scenario">Personnage</span> : Nom en majuscules centr√© avant chaque dialogue.</li>
                    <li><span class="notion" data-notion="dialogue-scenario">Dialogue</span> : Ce que dit le personnage.</li>
                    <li><span class="notion" data-notion="didascalie">Didascalie</span> : Indication de jeu entre parenth√®ses.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>‚ö†Ô∏è Attention :</strong> N'√©crivez jamais ce qu'on ne peut pas voir ou entendre (pens√©es, backstory non montr√©e).
                </div>
            </div>
            
            <div class="courses-section">
                <h2>üéì Pour Aller Plus Loin</h2>
                
                <h3><span class="notion" data-notion="voyage-heros">Le Voyage du H√©ros</span> (Joseph Campbell)</h3>
                <p>Th√©oris√© dans <em>"Le H√©ros aux mille visages"</em> (1949), ce mod√®le universel d√©crit le parcours arch√©typal du h√©ros en 12 √©tapes :</p>
                <ul>
                    <li><strong>1. Le monde ordinaire</strong> : Le h√©ros dans son quotidien avant l'aventure.</li>
                    <li><strong>2. L'appel de l'aventure</strong> : Un √©v√©nement perturbe l'√©quilibre.</li>
                    <li><strong>3. Le refus de l'appel</strong> : H√©sitation, peur de l'inconnu.</li>
                    <li><strong>4. La rencontre avec le mentor</strong> : Un guide apporte sagesse ou outils.</li>
                    <li><strong>5. Le passage du premier seuil</strong> : Entr√©e dans le monde extraordinaire.</li>
                    <li><strong>6. √âpreuves, alli√©s et ennemis</strong> : Apprentissage des nouvelles r√®gles.</li>
                    <li><strong>7. L'approche de la caverne</strong> : Pr√©paration √† l'√©preuve centrale.</li>
                    <li><strong>8. L'√©preuve supr√™me</strong> : Confrontation avec la plus grande peur.</li>
                    <li><strong>9. La r√©compense</strong> : Le h√©ros s'empare du tr√©sor.</li>
                    <li><strong>10. Le chemin du retour</strong> : Course-poursuite vers le monde ordinaire.</li>
                    <li><strong>11. La r√©surrection</strong> : Derni√®re √©preuve, transformation finale.</li>
                    <li><strong>12. Le retour avec l'√©lixir</strong> : Le h√©ros revient chang√© avec un don pour les siens.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Application :</strong> Christopher Vogler a adapt√© ce mod√®le pour Hollywood dans <em>"The Writer's Journey"</em> (1992), devenu une r√©f√©rence dans les studios.
                </div>
                
                <h3>Le Paradigme de Syd Field</h3>
                <p>Dans <em>"Screenplay"</em> (1979), Syd Field formalise la structure en 3 actes avec des points pr√©cis :</p>
                <ul>
                    <li><span class="notion" data-notion="plot-point">Plot Point 1 (page 25-27)</span> : √âv√©nement qui fait basculer l'histoire vers l'Acte II.</li>
                    <li><span class="notion" data-notion="midpoint">Midpoint (page 60)</span> : R√©v√©lation ou retournement au milieu de l'Acte II.</li>
                    <li><span class="notion" data-notion="plot-point">Plot Point 2 (page 85-90)</span> : Lance le h√©ros vers le climax de l'Acte III.</li>
                </ul>
                
                <h3>Save the Cat! (Blake Snyder)</h3>
                <p><em>"Save the Cat!"</em> (2005) propose une structure ultra-pr√©cise en 15 "beats" :</p>
                <ul>
                    <li><strong>Opening Image</strong> (p.1) : Ton et atmosph√®re du film.</li>
                    <li><strong>Theme Stated</strong> (p.5) : Le th√®me √©nonc√© (souvent dans un dialogue).</li>
                    <li><strong>Set-Up</strong> (p.1-10) : Pr√©sentation du monde et des personnages.</li>
                    <li><strong>Catalyst</strong> (p.12) : L'√©l√©ment d√©clencheur.</li>
                    <li><strong>Debate</strong> (p.12-25) : H√©sitation du h√©ros.</li>
                    <li><strong>Break into Two</strong> (p.25) : Choix d'entrer dans l'aventure.</li>
                    <li><strong>B Story</strong> (p.30) : Histoire secondaire (souvent l'amour).</li>
                    <li><strong>Fun and Games</strong> (p.30-55) : La "promesse du pitch".</li>
                    <li><strong>Midpoint</strong> (p.55) : Fausse victoire ou fausse d√©faite.</li>
                    <li><strong>Bad Guys Close In</strong> (p.55-75) : Pression croissante.</li>
                    <li><strong>All Is Lost</strong> (p.75) : Le point le plus bas.</li>
                    <li><strong>Dark Night of the Soul</strong> (p.75-85) : D√©sespoir avant la renaissance.</li>
                    <li><strong>Break into Three</strong> (p.85) : Solution trouv√©e.</li>
                    <li><strong>Finale</strong> (p.85-110) : Ex√©cution du plan, climax.</li>
                    <li><strong>Final Image</strong> (p.110) : Miroir de l'image d'ouverture, preuve du changement.</li>
                </ul>
                
                <h3><span class="notion" data-notion="arc-transformationnel">L'Arc Transformationnel</span> du Personnage</h3>
                <p>Un personnage m√©morable subit une transformation int√©rieure :</p>
                <ul>
                    <li><span class="notion" data-notion="ghost">La Blessure (Ghost)</span> : Trauma du pass√© qui d√©finit ses peurs.</li>
                    <li><span class="notion" data-notion="lie">La Croyance limitante (Lie)</span> : Ce que le personnage croit √† tort.</li>
                    <li><span class="notion" data-notion="besoin-vs-desir">Le Besoin vs le D√©sir</span> : Ce qu'il veut ‚â† ce dont il a vraiment besoin.</li>
                    <li><span class="notion" data-notion="verite-personnage">La V√©rit√© (Truth)</span> : Ce qu'il doit apprendre pour √©voluer.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>‚ö†Ô∏è Attention :</strong> Certains films utilisent des arcs "n√©gatifs" (le personnage empire) ou "plats" (il reste fid√®le √† ses valeurs malgr√© tout). Ces variations sont volontaires et puissantes.
                </div>
                
                <h3>Th√©ories Alternatives</h3>
                <ul>
                    <li><strong>Structure en 4 Actes</strong> (Kristin Thompson) : Divise l'Acte II en deux parties distinctes.</li>
                    <li><strong>S√©quences de 8</strong> (Frank Daniel) : 8 s√©quences de 12-15 minutes chacune.</li>
                    <li><strong>Story Circle</strong> (Dan Harmon) : Version simplifi√©e du voyage du h√©ros en 8 √©tapes.</li>
                    <li><strong>Kishotenketsu</strong> : Structure japonaise en 4 parties sans conflit central.</li>
                    <li><strong>Anti-structure</strong> (Robert McKee) : Films d'auteur qui d√©construisent les conventions.</li>
                </ul>
                
                <h3>üìö Ouvrages de R√©f√©rence</h3>
                <ul>
                    <li><strong>"Story"</strong> - Robert McKee (1997) : La bible de la narration, analyse approfondie des principes dramatiques.</li>
                    <li><strong>"Screenplay"</strong> - Syd Field (1979) : Le livre fondateur de la structure moderne.</li>
                    <li><strong>"Save the Cat!"</strong> - Blake Snyder (2005) : Approche pragmatique et commerciale.</li>
                    <li><strong>"The Writer's Journey"</strong> - Christopher Vogler (1992) : Adaptation du voyage du h√©ros.</li>
                    <li><strong>"Into the Woods"</strong> - John Yorke (2013) : Pourquoi les histoires fonctionnent.</li>
                    <li><strong>"L'anatomie du sc√©nario"</strong> - John Truby (2010) : 22 √©tapes pour une histoire organique.</li>
                    <li><strong>"Le H√©ros aux mille visages"</strong> - Joseph Campbell (1949) : L'≈ìuvre mythologique originelle.</li>
                    <li><strong>"Po√©tique"</strong> - Aristote (~335 av. J.-C.) : Les fondements mill√©naires de la dramaturgie.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Conseil :</strong> √âtudiez ces th√©ories, puis oubliez-les en √©crivant. Elles servent √† analyser et r√©√©crire, pas √† brider la cr√©ativit√© du premier jet.
                </div>
            </div>
        `,
        
        realisation: `
            <div class="courses-section">
                <h2>üé¨ Les Bases de la R√©alisation</h2>
                
                <h3>La Pr√©paration (Pr√©-production)</h3>
                <ul>
                    <li><span class="notion" data-notion="decoupage-technique">D√©coupage technique</span> : Transformer le sc√©nario en plans √† tourner.</li>
                    <li><span class="notion" data-notion="storyboard">Storyboard</span> : Dessiner chaque plan pour visualiser le film.</li>
                    <li><span class="notion" data-notion="reperages">Rep√©rages</span> : Trouver et valider les lieux de tournage.</li>
                    <li><span class="notion" data-notion="casting">Casting</span> : S√©lectionner les com√©diens.</li>
                    <li><span class="notion" data-notion="plan-travail">Plan de travail</span> : Organiser les journ√©es de tournage.</li>
                </ul>
                
                <h3>Les Valeurs de Plan</h3>
                <ul>
                    <li><span class="notion" data-notion="plan-ensemble">Plan d'ensemble (PE)</span> : Situe l'action dans un d√©cor large.</li>
                    <li><span class="notion" data-notion="plan-large">Plan large (PL)</span> : Montre les personnages en pied dans leur environnement.</li>
                    <li><span class="notion" data-notion="plan-moyen">Plan moyen (PM)</span> : Personnage cadr√© √† mi-cuisse.</li>
                    <li><span class="notion" data-notion="plan-americain">Plan am√©ricain (PA)</span> : Personnage cadr√© au niveau des genoux.</li>
                    <li><span class="notion" data-notion="plan-rapproche">Plan rapproch√© (PR)</span> : Cadr√© √† la poitrine ou aux √©paules.</li>
                    <li><span class="notion" data-notion="gros-plan">Gros plan (GP)</span> : Visage ou objet en entier.</li>
                    <li><span class="notion" data-notion="tres-gros-plan">Tr√®s gros plan (TGP)</span> : D√©tail (≈ìil, main, objet).</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° R√®gle des 180¬∞</strong> : Imaginez une ligne entre deux personnages. Restez toujours du m√™me c√¥t√© pour maintenir la coh√©rence spatiale.
                </div>
                
                <h3>Diriger les Com√©diens</h3>
                <ul>
                    <li>Donnez des <strong>objectifs</strong> plut√¥t que des √©motions ("tu veux le convaincre" vs "sois triste").</li>
                    <li>Cr√©ez un <strong>climat de confiance</strong> sur le plateau.</li>
                    <li>Faites des <strong>r√©p√©titions</strong> avant le tournage.</li>
                    <li>Laissez les acteurs <strong>proposer</strong> et ajustez.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>üéì Pour Aller Plus Loin</h2>
                
                <h3>La Grammaire Cin√©matographique</h3>
                <p>Chaque choix de plan est un mot, chaque s√©quence une phrase. Le r√©alisateur construit un langage visuel :</p>
                <ul>
                    <li><span class="notion" data-notion="plan-subjectif">Plan subjectif (POV)</span> : La cam√©ra devient les yeux du personnage. Cr√©e identification et immersion.</li>
                    <li><span class="notion" data-notion="plan-objectif">Plan objectif</span> : Point de vue neutre, observateur ext√©rieur.</li>
                    <li><span class="notion" data-notion="plan-semi-subjectif">Plan semi-subjectif</span> : Cam√©ra proche du personnage, partage son espace sans √™tre ses yeux.</li>
                    <li><span class="notion" data-notion="plongee">Plong√©e</span> : Cam√©ra au-dessus du sujet. √âcrase, diminue, rend vuln√©rable.</li>
                    <li><span class="notion" data-notion="contre-plongee">Contre-plong√©e</span> : Cam√©ra en dessous. Grandit, h√©ro√Øse, menace.</li>
                    <li><span class="notion" data-notion="dutch-angle">Dutch angle</span> : Cam√©ra inclin√©e. Malaise, d√©s√©quilibre, folie.</li>
                </ul>
                
                <h3>Les Axes de Regard et la G√©ographie</h3>
                <ul>
                    <li><span class="notion" data-notion="ligne-180">Ligne des 180¬∞</span> : Axe imaginaire entre deux sujets. Ne jamais la franchir sans transition.</li>
                    <li><span class="notion" data-notion="ligne-30">Ligne des 30¬∞</span> : Entre deux plans, changez au minimum de 30¬∞ pour √©viter le jump cut.</li>
                    <li><span class="notion" data-notion="raccord-regard">Raccord regard</span> : Si A regarde √† droite, B doit regarder √† gauche au plan suivant.</li>
                    <li><span class="notion" data-notion="champ-contrechamp">Champ/Contre-champ</span> : Alterner entre deux points de vue oppos√©s (dialogue).</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>‚ö†Ô∏è Franchissement volontaire :</strong> Certains r√©alisateurs franchissent la ligne intentionnellement pour cr√©er confusion ou rupture (ex: Kubrick dans Shining).
                </div>
                
                <h3>Les Techniques de Mise en Sc√®ne</h3>
                <ul>
                    <li><span class="notion" data-notion="blocking">Blocking</span> : Placement et d√©placement des acteurs dans le d√©cor. Un bon blocking raconte sans dialogue.</li>
                    <li><span class="notion" data-notion="staging">Staging</span> : Organisation des √©l√©ments dans le cadre pour guider le regard.</li>
                    <li><span class="notion" data-notion="plan-sequence">Plan-s√©quence</span> : Toute une sc√®ne en un seul plan. Demande chor√©graphie parfaite.</li>
                    <li><span class="notion" data-notion="oner">Oner</span> : Plan-s√©quence virtuose souvent en travelling complexe.</li>
                    <li><span class="notion" data-notion="split-focus">Split focus (diopter)</span> : Deux plans de nettet√© simultan√©s (De Palma).</li>
                </ul>
                
                <h3>Styles et Approches de R√©alisation</h3>
                <ul>
                    <li><span class="notion" data-notion="decoupage-classique">D√©coupage classique (Hollywood)</span> : Master shot + coverage. Montage fluide, invisible.</li>
                    <li><span class="notion" data-notion="decoupage-europeen">D√©coupage europ√©en</span> : Plans plus longs, moins de coupes, respiration.</li>
                    <li><span class="notion" data-notion="camera-epaule">Cam√©ra-√©paule</span> : Immersion documentaire, urgence, r√©alisme (Dardenne, Greengrass).</li>
                    <li><span class="notion" data-notion="steadicam">Steadicam</span> : Fluidit√© onirique, exploration spatiale (Kubrick, Scorsese).</li>
                    <li><span class="notion" data-notion="oner">Style "oner"</span> : Tout ou partie du film en faux plan-s√©quence (Birdman, 1917).</li>
                    <li><span class="notion" data-notion="minimalisme">Minimalisme</span> : √âconomie de moyens, cadres fixes, temps r√©el (Kiarostami, Haneke).</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Citation :</strong> "Un film se fait trois fois : √† l√©criture, au tournage et au montage." - Robert Bresson
                </div>
                
                <h3>Direction dActeurs : M√©thodes Avanc√©es</h3>
                <ul>
                    <li><span class="notion" data-notion="stanislavski">M√©thode Stanislavski</span> : Recherche de la v√©rit√© √©motionnelle, m√©moire affective.</li>
                    <li><span class="notion" data-notion="actors-studio">Actors Studio (Lee Strasberg)</span> : Immersion totale dans le personnage.</li>
                    <li><span class="notion" data-notion="meisner">Technique Meisner</span> : R√©action instinctive, √©coute du partenaire.</li>
                    <li><span class="notion" data-notion="approche-bresson">Approche Bresson</span> : "Mod√®les" non-acteurs, r√©p√©tition jusqu√† √©puisement du jeu.</li>
                    <li><span class="notion" data-notion="improvisation-dirigee">Improvisation dirig√©e</span> : Cadre d√©fini, libert√© dans lex√©cution (Cassavetes, Leigh).</li>
                </ul>
                
                <h3>üìö Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"Hitchcock/Truffaut"</strong> - Fran√ßois Truffaut (1966) : Masterclass du ma√Ætre du suspense.</li>
                    <li><strong>"Notes sur le cin√©matographe"</strong> - Robert Bresson (1975) : Aphorismes dun puriste.</li>
                    <li><strong>"Faire un film"</strong> - Sidney Lumet (1995) : Guide pratique dun v√©t√©ran.</li>
                    <li><strong>"In the Blink of an Eye"</strong> - Walter Murch (2001) : R√©flexions sur le montage.</li>
                    <li><strong>"Rebel Without a Crew"</strong> - Robert Rodriguez (1995) : Cin√©ma gu√©rilla et d√©brouille.</li>
                    <li><strong>"On Directing Film"</strong> - David Mamet (1991) : Approche minimaliste et efficace.</li>
                    <li><strong>"Le Plaisir des yeux"</strong> - Fran√ßois Truffaut : √âcrits sur le cin√©ma.</li>
                </ul>
                
                <h3>üé¨ Films √† √âtudier (Mise en Sc√®ne)</h3>
                <ul>
                    <li><strong>Citizen Kane</strong> (Welles, 1941) : Profondeur de champ, plong√©es, narration √©clat√©e.</li>
                    <li><strong>Vertigo</strong> (Hitchcock, 1958) : Effet vertigo (zoom/travelling oppos√©s), obsession visuelle.</li>
                    <li><strong>Les Affranchis</strong> (Scorsese, 1990) : Steadicam l√©gendaire du Copacabana.</li>
                    <li><strong>Oldboy</strong> (Park Chan-wook, 2003) : Plan-s√©quence de combat lat√©ral.</li>
                    <li><strong>Children of Men</strong> (Cuar√≥n, 2006) : Longs plans-s√©quences immersifs.</li>
                    <li><strong>Birdman</strong> (I√±√°rritu, 2014) : Faux plan-s√©quence int√©gral.</li>
                </ul>
            </div>
        `,
        
        image: `
            <div class="courses-section">
                <h2>üì∑ L'Image Cin√©matographique</h2>
                <h2>üì∑ L'Image Cin√©matographique</h2>
                
                <h3>La Composition</h3>
                <ul>
                    <li><span class="notion" data-notion="regle-tiers">R√®gle des tiers</span> : Placez les √©l√©ments importants sur les intersections d'une grille 3√ó3.</li>
                    <li><span class="notion" data-notion="lignes-directrices">Lignes directrices</span> : Utilisez les lignes naturelles pour guider le regard.</li>
                    <li><span class="notion" data-notion="profondeur-champ">Profondeur de champ</span> : Jouez avec le flou pour isoler le sujet.</li>
                    <li><span class="notion" data-notion="headroom">Headroom</span> : Espace au-dessus de la t√™te du sujet.</li>
                    <li><span class="notion" data-notion="looking-room">Looking room</span> : Espace devant le regard du personnage.</li>
                </ul>
                
                <h3>L'√âclairage - Le Triangle de Base</h3>
                <ul>
                    <li><span class="notion" data-notion="key-light">Key Light (lumi√®re principale)</span> : Source principale, d√©finit les ombres.</li>
                    <li><span class="notion" data-notion="fill-light">Fill Light (lumi√®re de remplissage)</span> : Adoucit les ombres cr√©√©es par la key.</li>
                    <li><span class="notion" data-notion="back-light">Back Light (contre-jour)</span> : S√©pare le sujet du fond, cr√©e du relief.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Ratio d'√©clairage :</strong> Pour un look naturel, la fill light est 2 stops en dessous de la key. Pour un look dramatique, augmentez l'√©cart.
                </div>
                
                <h3>Les Mouvements de Cam√©ra</h3>
                <ul>
                    <li><span class="notion" data-notion="panoramique">Panoramique</span> : Rotation horizontale ou verticale sur pied fixe.</li>
                    <li><span class="notion" data-notion="travelling">Travelling</span> : D√©placement physique de la cam√©ra (avant, arri√®re, lat√©ral).</li>
                    <li><span class="notion" data-notion="zoom">Zoom</span> : Changement de focale (diff√©rent du travelling !).</li>
                    <li><span class="notion" data-notion="steadicam">Steadicam</span> : Travelling fluide avec harnais stabilisateur.</li>
                    <li><span class="notion" data-notion="grue-jib">Grue/Jib</span> : Mouvements verticaux amples.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>üéì Pour Aller Plus Loin</h2>
                
                <h3>Les Optiques et Leurs Effets</h3>
                <ul>
                    <li><span class="notion" data-notion="focale-courte">Focale courte (grand-angle, 16-35mm)</span> : Exag√®re les perspectives, d√©forme les bords, agrandit les espaces. Id√©al pour oppression ou immensit√©.</li>
                    <li><span class="notion" data-notion="focale-normale">Focale normale (50mm)</span> : Proche de la vision humaine, naturelle et neutre.</li>
                    <li><span class="notion" data-notion="focale-longue">Focale longue (85-200mm)</span> : Compresse les distances, isole le sujet, flou darri√®re-plan prononc√©. Portrait, intimit√©.</li>
                    <li><span class="notion" data-notion="anamorphique">Objectifs anamorphiques</span> : Ratio 2.39:1, flares horizontaux caract√©ristiques, bokeh ovale. Look "cin√©ma".</li>
                    <li><span class="notion" data-notion="macro">Macro</span> : Tr√®s gros plans sur petits objets (insectes, textures).</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Astuce focale :</strong> Spielberg utilise souvent des focales courtes pr√®s des visages pour cr√©er malaise. Kubrick pr√©f√©rait les focales tr√®s courtes (9.8mm dans Barry Lyndon).
                </div>
                
                <h3>Techniques d√âclairage Avanc√©es</h3>
                <ul>
                    <li><span class="notion" data-notion="high-key">High-key</span> : √âclairage uniforme, peu dombres. Com√©dies, sitcoms, publicit√©.</li>
                    <li><span class="notion" data-notion="low-key">Low-key</span> : Forts contrastes, ombres marqu√©es. Film noir, thriller, horreur.</li>
                    <li><span class="notion" data-notion="chiaroscuro">Chiaroscuro</span> : Clair-obscur inspir√© de la peinture (Caravage). Drame intense.</li>
                    <li><span class="notion" data-notion="rembrandt-lighting">Rembrandt lighting</span> : Triangle de lumi√®re sous un ≈ìil. Portrait classique.</li>
                    <li><span class="notion" data-notion="lumiere-pratique">Lumi√®re pratique</span> : Sources visibles √† l√©cran (lampes, bougies, √©crans).</li>
                    <li><span class="notion" data-notion="lumiere-naturelle">Lumi√®re naturelle</span> : Utilisation exclusive du soleil (Malick, Lubezki).</li>
                    <li><span class="notion" data-notion="magic-hour">Magic hour</span> : Tournage √† laube ou au cr√©puscule pour lumi√®re dor√©e.</li>
                </ul>
                
                <h3>La Colorim√©trie</h3>
                <ul>
                    <li><span class="notion" data-notion="temperature-couleur">Temp√©rature de couleur</span> : Kelvin (K). 3200K = tungst√®ne chaud, 5600K = lumi√®re du jour.</li>
                    <li><span class="notion" data-notion="balance-blancs">Balance des blancs</span> : Calibrer la cam√©ra pour que le blanc soit neutre.</li>
                    <li><span class="notion" data-notion="lut">LUT (Look-Up Table)</span> : Pr√©r√©glage de correction colorim√©trique.</li>
                    <li><span class="notion" data-notion="log-raw">LOG / RAW</span> : Profils plats qui conservent maximum dinformations pour l√©talonnage.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>‚ö†Ô∏è M√©lange de sources :</strong> Attention aux m√©langes tungst√®ne/daylight non voulus. Utilisez des g√©latines (CTO/CTB) pour harmoniser.
                </div>
                
                <h3>Formats et Ratios dImage</h3>
                <ul>
                    <li><span class="notion" data-notion="ratio-43">1.33:1 (4:3)</span> : Format classique, t√©l√©vision ancienne, intimiste.</li>
                    <li><span class="notion" data-notion="ratio-185">1.85:1</span> : Standard cin√©ma am√©ricain.</li>
                    <li><span class="notion" data-notion="ratio-scope">2.39:1 (Scope)</span> : Cin√©mascope, √©pique, paysages.</li>
                    <li><span class="notion" data-notion="ratio-169">16:9 (1.78:1)</span> : Standard HD/TV actuel.</li>
                    <li><span class="notion" data-notion="ratio-imax">IMAX (1.43:1)</span> : Format g√©ant immersif.</li>
                </ul>
                
                <h3>Le Cadre comme Outil Narratif</h3>
                <ul>
                    <li><span class="notion" data-notion="cadre-ferme">Cadre ferm√©</span> : √âl√©ments qui emprisonnent (portes, fen√™tres). Oppression.</li>
                    <li><span class="notion" data-notion="cadre-ouvert">Cadre ouvert</span> : Espace libre, personnage peut sortir du champ. Libert√©.</li>
                    <li><span class="notion" data-notion="surcadrage">Surcadrage</span> : Cadre dans le cadre (miroir, √©cran, porte). Mise en abyme.</li>
                    <li><span class="notion" data-notion="amorce">Amorce</span> : √âl√©ment flou au premier plan. Profondeur, voyeurisme.</li>
                    <li><span class="notion" data-notion="hors-champ">Hors-champ</span> : Ce quon ne voit pas mais devine. Suggestion puissante.</li>
                </ul>
                
                <h3>üìö Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"Painting with Light"</strong> - John Alton (1949) : Bible de l√©clairage hollywoodien.</li>
                    <li><strong>"Cinematography: Theory and Practice"</strong> - Blain Brown : Manuel technique complet.</li>
                    <li><strong>"Masters of Light"</strong> - Dennis Schaefer : Interviews de grands directeurs photo.</li>
                    <li><strong>"FilmCraft: Cinematography"</strong> - Mike Goodridge : T√©moignages contemporains.</li>
                    <li><strong>"The Visual Story"</strong> - Bruce Block : Narration visuelle et composition.</li>
                </ul>
                
                <h3>üé¨ Films √† √âtudier (Direction Photo)</h3>
                <ul>
                    <li><strong>Blade Runner</strong> (Jordan Cronenweth, 1982) : N√©ons, fum√©e, low-key futuriste.</li>
                    <li><strong>Barry Lyndon</strong> (John Alcott, 1975) : √âclairage √† la bougie, lumi√®re naturelle.</li>
                    <li><strong>The Revenant</strong> (Emmanuel Lubezki, 2015) : Lumi√®re naturelle exclusive.</li>
                    <li><strong>In the Mood for Love</strong> (Christopher Doyle, 2000) : Couleurs satur√©es, surcadrages.</li>
                    <li><strong>Skyfall</strong> (Roger Deakins, 2012) : Silhouettes, contre-jours, couleurs symboliques.</li>
                    <li><strong>Am√©lie Poulain</strong> (Bruno Delbonnel, 2001) : Palette verte/rouge distinctive.</li>
                </ul>
            </div>
        `,
        
        son: `
            <div class="courses-section">
                <h2>üé§ La Prise de Son</h2>
                
                <h3>Les Types de Microphones</h3>
                <ul>
                    <li><span class="notion" data-notion="micro-canon">Canon (shotgun)</span> : Directionnel, id√©al pour isoler une source. Utilis√© sur perche.</li>
                    <li><span class="notion" data-notion="micro-cravate">Cravate (lavalier)</span> : Micro miniature fix√© sur le com√©dien. Discret mais risque de frottements.</li>
                    <li><span class="notion" data-notion="micro-omni">Omnidirectionnel</span> : Capte dans toutes les directions. Bon pour les ambiances.</li>
                </ul>
                
                <h3>R√®gles de Base</h3>
                <ul>
                    <li><strong>Proximit√©</strong> : Plus le micro est proche, meilleur est le son (sans entrer dans le cadre !).</li>
                    <li><strong>Orientation</strong> : Le micro canon doit pointer vers la bouche de l'acteur.</li>
                    <li><strong>Ambiance</strong> : Toujours enregistrer 1-2 min de "silence" de chaque lieu.</li>
                    <li><strong>Son t√©moin</strong> : Le son de la cam√©ra sert uniquement √† la synchronisation.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>‚ö†Ô∏è Ennemis du son :</strong> Climatisation, frigos, n√©ons, avions, circulation, vent, v√™tements synth√©tiques.
                </div>
                
                <h3>Les Niveaux</h3>
                <ul>
                    <li>Dialogues : viser <strong>-12 dB √† -6 dB</strong> en cr√™te.</li>
                    <li>Ne jamais d√©passer <strong>0 dB</strong> (saturation = irr√©cup√©rable).</li>
                    <li>Toujours surveiller au <strong>casque</strong> pendant l'enregistrement.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>üéì Pour Aller Plus Loin</h2>
                
                <h3>Les Couches Sonores dun Film</h3>
                <p>Le son au cin√©ma se compose de plusieurs √©l√©ments superpos√©s :</p>
                <ul>
                    <li><span class="notion" data-notion="dialogues-son">Dialogues</span> : Voix des personnages, √©l√©ment principal √† prot√©ger.</li>
                    <li><span class="notion" data-notion="ambiance-son">Ambiances</span> : Son continu dun lieu (ville, for√™t, int√©rieur). Cr√©e lespace.</li>
                    <li><span class="notion" data-notion="sfx">Effets sonores (SFX)</span> : Sons ponctuels synchronis√©s (portes, pas, objets).</li>
                    <li><span class="notion" data-notion="foley">Foley</span> : Bruitages recr√©√©s en studio (pas, v√™tements, manipulations).</li>
                    <li><span class="notion" data-notion="musique-film">Musique</span> : Score original ou morceaux existants.</li>
                    <li><span class="notion" data-notion="silence-cinematographique">Silence</span> : Outil dramatique puissant, souvent sous-estim√©.</li>
                </ul>
                
                <h3>Son Di√©g√©tique vs Extra-di√©g√©tique</h3>
                <ul>
                    <li><span class="notion" data-notion="son-diegetique">Di√©g√©tique</span> : Source sonore pr√©sente dans lunivers du film (radio, musicien √† l√©cran).</li>
                    <li><span class="notion" data-notion="son-extra-diegetique">Extra-di√©g√©tique</span> : Son ajout√© que les personnages nentendent pas (musique de film, voix-off).</li>
                    <li><span class="notion" data-notion="meta-diegetique">Meta-di√©g√©tique</span> : Son subjectif (acouph√®ne, battement de c≈ìur, souvenir sonore).</li>
                    <li><span class="notion" data-notion="trans-diegetique">Trans-di√©g√©tique</span> : Passage dun √©tat √† lautre (musique qui devient di√©g√©tique).</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Exemple :</strong> Dans Apocalypse Now, "The End" des Doors passe de musique extra-di√©g√©tique √† la radio de lh√©licopt√®re (di√©g√©tique).
                </div>
                
                <h3>Techniques de Prise de Son Avanc√©es</h3>
                <ul>
                    <li><span class="notion" data-notion="double-systeme">Double syst√®me</span> : Enregistrement s√©par√© cam√©ra/enregistreur. Qualit√© professionnelle.</li>
                    <li><span class="notion" data-notion="multi-pistes">Multi-pistes</span> : Chaque micro sur une piste s√©par√©e pour flexibilit√© au mixage.</li>
                    <li><span class="notion" data-notion="ms-stereo">MS (Mid-Side)</span> : Configuration st√©r√©o avec contr√¥le de largeur en post.</li>
                    <li><span class="notion" data-notion="boom-vs-lav">Boom vs Lav</span> : Perche = naturel mais risqu√© / Cravate = s√©curit√© mais moins naturel.</li>
                    <li><span class="notion" data-notion="plant-mic">Plant mic</span> : Micro cach√© dans le d√©cor pour plans larges.</li>
                    <li><span class="notion" data-notion="wild-tracks">Wild tracks</span> : Enregistrements sonores sans image (ambiances, effets).</li>
                </ul>
                
                <h3>Le Sound Design</h3>
                <ul>
                    <li><span class="notion" data-notion="worldizing">Worldizing</span> : Rejouer un son dans un espace r√©el et le r√©enregistrer (Walter Murch).</li>
                    <li><span class="notion" data-notion="layering">Layering</span> : Superposer plusieurs sons pour en cr√©er un nouveau.</li>
                    <li><span class="notion" data-notion="pitch-shifting">Pitch shifting</span> : Modifier la hauteur (ralentir un cri animal = monstre).</li>
                    <li><span class="notion" data-notion="sound-metaphor">Sound metaphor</span> : Son qui repr√©sente une id√©e (battement = tension).</li>
                    <li><span class="notion" data-notion="leitmotiv-sonore">Leitmotiv sonore</span> : Son r√©current associ√© √† un personnage ou th√®me.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>‚ö†Ô∏è Pi√®ge fr√©quent :</strong> Trop de musique tue l√©motion. Le silence avant un moment fort amplifie limpact.
                </div>
                
                <h3>Le Mixage - √âquilibrer les √âl√©ments</h3>
                <ul>
                    <li><span class="notion" data-notion="dialogues-son">Priorit√© dialogues</span> : Toujours intelligibles sauf choix artistique.</li>
                    <li><span class="notion" data-notion="ducking">Ducking</span> : Baisser automatiquement la musique sous les dialogues.</li>
                    <li><span class="notion" data-notion="panning">Panoramique (panning)</span> : Placer les sons dans lespace st√©r√©o/surround.</li>
                    <li><span class="notion" data-notion="lfe">LFE (caisson de basses)</span> : Canal d√©di√© aux basses fr√©quences (explosions, impacts).</li>
                    <li><span class="notion" data-notion="stems">Stems</span> : Groupes s√©par√©s (DX, MX, FX) pour versions internationales.</li>
                </ul>
                
                <h3>Formats Audio au Cin√©ma</h3>
                <ul>
                    <li><span class="notion" data-notion="formats-audio">Mono</span> : Un seul canal. Historique.</li>
                    <li><span class="notion" data-notion="formats-audio">St√©r√©o (2.0)</span> : Gauche/Droite. Standard minimal.</li>
                    <li><span class="notion" data-notion="surround-51">5.1 Surround</span> : 5 canaux + 1 LFE. Standard cin√©ma actuel.</li>
                    <li><span class="notion" data-notion="formats-audio">7.1</span> : Ajout de surrounds lat√©raux.</li>
                    <li><span class="notion" data-notion="dolby-atmos">Dolby Atmos</span> : Son objet, placement 3D pr√©cis, plafond.</li>
                </ul>
                
                <h3>üìö Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"Sound Design"</strong> - David Sonnenschein : Th√©orie et pratique du design sonore.</li>
                    <li><strong>"The Filmmaker Handbook"</strong> - Ascher & Pincus : Chapitre son tr√®s complet.</li>
                    <li><strong>"Audio-Vision"</strong> - Michel Chion (1990) : Th√©orie du son au cin√©ma, r√©f√©rence acad√©mique.</li>
                    <li><strong>"Sound for Film and Television"</strong> - Tomlinson Holman : Manuel technique.</li>
                    <li><strong>"Practical Art of Motion Picture Sound"</strong> - David Yewdall : Exp√©rience de terrain.</li>
                </ul>
                
                <h3>üé¨ Films √† √âtudier (Sound Design)</h3>
                <ul>
                    <li><strong>Apocalypse Now</strong> (Walter Murch, 1979) : R√©volution du sound design, premier 5.1.</li>
                    <li><strong>Gravity</strong> (Glenn Freemantle, 2013) : Son dans le vide, vibrations par contact.</li>
                    <li><strong>A Quiet Place</strong> (2018) : Le silence comme tension, son subjectif.</li>
                    <li><strong>No Country for Old Men</strong> (Skip Lievsay, 2007) : Absence quasi-totale de musique.</li>
                    <li><strong>WALL-E</strong> (Ben Burtt, 2008) : Personnages d√©finis par leurs sons.</li>
                    <li><strong>Dunkirk</strong> (Richard King, 2017) : Son immersif, Shepard tone.</li>
                </ul>
            </div>
        `,
        
        montage: `
            <div class="courses-section">
                <h2>‚úÇÔ∏è Le Montage</h2>
                
                <h3>Les Types de Raccords</h3>
                <ul>
                    <li><span class="notion" data-notion="raccord-axe">Raccord dans l'axe</span> : Changement de valeur sur le m√™me axe (PE ‚Üí GP).</li>
                    <li><span class="notion" data-notion="raccord-regard">Raccord regard</span> : On montre ce que voit le personnage.</li>
                    <li><span class="notion" data-notion="raccord-mouvement">Raccord mouvement</span> : Coupe pendant une action pour fluidifier.</li>
                    <li><span class="notion" data-notion="champ-contrechamp">Champ/Contre-champ</span> : Alternance entre deux personnages qui dialoguent.</li>
                    <li><span class="notion" data-notion="match-cut">Match cut</span> : Raccord sur une forme ou mouvement similaire.</li>
                </ul>
                
                <h3>Erreurs √† √âviter</h3>
                <ul>
                    <li><span class="notion" data-notion="jump-cut">Jump cut</span> : Saute dans le temps sur le m√™me plan (sauf effet voulu).</li>
                    <li><span class="notion" data-notion="franchissement-axe">Franchissement d'axe</span> : Passer de l'autre c√¥t√© de la ligne des 180¬∞.</li>
                    <li><span class="notion" data-notion="faux-raccord">Faux raccord</span> : Incoh√©rence d'accessoire, position, lumi√®re entre deux plans.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° R√®gle du 30¬∞</strong> : Entre deux plans de la m√™me sc√®ne, changez l'angle d'au moins 30¬∞ pour √©viter le jump cut.
                </div>
                
                <h3>Le Rythme</h3>
                <ul>
                    <li>Coupez sur l'<strong>action</strong>, pas avant ni apr√®s.</li>
                    <li>Laissez les plans <strong>respirer</strong> - ne coupez pas trop vite.</li>
                    <li>Le rythme suit l'<strong>√©motion</strong> : rapide = tension, lent = contemplation.</li>
                    <li>Utilisez les <strong>r√©actions</strong> autant que les actions.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>üéì Pour Aller Plus Loin</h2>
                
                <h3>Les Th√©ories du Montage</h3>
                <p>Le montage nest pas quune technique, cest un langage avec ses th√©oriciens :</p>
                <ul>
                    <li><span class="notion" data-notion="effet-koulechov">Effet Koulechov</span> : Un m√™me visage neutre + images diff√©rentes = √©motions diff√©rentes per√ßues. Le montage cr√©e le sens.</li>
                    <li><span class="notion" data-notion="montage-intellectuel">Montage intellectuel (Eisenstein)</span> : La collision de deux plans cr√©e une id√©e nouvelle (th√®se + antith√®se = synth√®se).</li>
                    <li><span class="notion" data-notion="montage-invisible">Montage invisible (Hollywood classique)</span> : Coupes fluides, le spectateur oublie quil regarde un film.</li>
                    <li><span class="notion" data-notion="montage-visible">Montage visible (Godard, Nouvelle Vague)</span> : Jump cuts assum√©s, rappel constant du m√©dium.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Citation :</strong> "Le cin√©ma, cest 24 fois la v√©rit√© par seconde" - Jean-Luc Godard. Mais le montage choisit quelles v√©rit√©s.
                </div>
                
                <h3>Les 5 Types de Montage selon Eisenstein</h3>
                <ul>
                    <li><span class="notion" data-notion="montage-metrique">M√©trique</span> : Coupe √† intervalles r√©guliers, ind√©pendamment du contenu. Cr√©e un rythme m√©canique.</li>
                    <li><span class="notion" data-notion="montage-rythmique">Rythmique</span> : Coupe selon le mouvement dans le plan. Le contenu dicte le rythme.</li>
                    <li><span class="notion" data-notion="montage-tonal">Tonal</span> : Coupe selon l√©motion dominante du plan (lumi√®re, atmosph√®re).</li>
                    <li><strong>Harmonique</strong> : Combinaison de tous les √©l√©ments (rythme, ton, mouvement).</li>
                    <li><span class="notion" data-notion="montage-intellectuel">Intellectuel</span> : Juxtaposition pour cr√©er une m√©taphore ou une id√©e abstraite.</li>
                </ul>
                
                <h3>Techniques de Montage Avanc√©es</h3>
                <ul>
                    <li><span class="notion" data-notion="montage-parallele">Montage parall√®le (cross-cutting)</span> : Alterner entre deux actions simultan√©es. Tension, comparaison.</li>
                    <li><span class="notion" data-notion="montage-alterne">Montage altern√©</span> : Deux temporalit√©s diff√©rentes entrelac√©es.</li>
                    <li><span class="notion" data-notion="flashback">Flashback / Flash-forward</span> : Rupture temporelle vers le pass√© ou le futur.</li>
                    <li><span class="notion" data-notion="ellipse">Ellipse</span> : Saut dans le temps. √âconomie narrative.</li>
                    <li><span class="notion" data-notion="sequence-montage">S√©quence de montage</span> : Condensation du temps (entra√Ænement, transformation).</li>
                    <li><span class="notion" data-notion="split-screen">Split screen</span> : √âcran divis√©, actions simultan√©es visibles.</li>
                    <li><span class="notion" data-notion="smash-cut">Smash cut</span> : Coupe brutale et inattendue pour effet de choc.</li>
                    <li><span class="notion" data-notion="l-cut-j-cut">L-cut / J-cut</span> : Le son pr√©c√®de ou suit limage. Fluidit√©, anticipation.</li>
                </ul>
                
                <h3>Le Workflow de Post-production</h3>
                <ul>
                    <li><strong>Synchro/D√©rushage</strong> : Synchroniser son et image, organiser les m√©dias.</li>
                    <li><span class="notion" data-notion="bout-a-bout">Bout-√†-bout</span> : Premier assemblage chronologique des prises retenues.</li>
                    <li><span class="notion" data-notion="rough-cut">Ours (rough cut)</span> : Premier montage complet, encore long.</li>
                    <li><span class="notion" data-notion="fine-cut">Fine cut</span> : Montage affin√©, rythme ajust√©.</li>
                    <li><span class="notion" data-notion="picture-lock">Picture lock</span> : Montage image valid√©, plus de modifications.</li>
                    <li><strong>Conformation</strong> : Remplacement des proxies par les fichiers haute qualit√©.</li>
                    <li><span class="notion" data-notion="etalonnage">√âtalonnage</span> : Correction colorim√©trique et cr√©ation du look.</li>
                    <li><strong>Mixage</strong> : √âquilibrage final de toutes les pistes audio.</li>
                    <li><strong>Mastering</strong> : Export final dans les formats de diffusion.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>‚ö†Ô∏è Kill your darlings :</strong> Parfois les meilleures sc√®nes doivent √™tre coup√©es pour le bien du film. Le monteur doit √™tre objectif.
                </div>
                
                <h3>Psychologie du Montage</h3>
                <ul>
                    <li><strong>Point de coupe id√©al</strong> : Souvent sur un clignement dyeux ou un mouvement de t√™te.</li>
                    <li><strong>Regard du spectateur</strong> : Guider l≈ìil dun plan √† lautre (eye trace).</li>
                    <li><strong>R√®gle des 6 (Walter Murch)</strong> : √âmotion (51%) > Histoire (23%) > Rythme (10%) > Eye trace (7%) > Plan√©it√© 2D (5%) > Espace 3D (4%).</li>
                    <li><strong>Dur√©e des plans</strong> : Plus le plan est complexe visuellement, plus il peut durer.</li>
                </ul>
                
                <h3>Outils et Logiciels</h3>
                <ul>
                    <li><strong>Adobe Premiere Pro</strong> : Standard industrie, int√©gration Creative Cloud.</li>
                    <li><strong>DaVinci Resolve</strong> : Gratuit et pro, excellent √©talonnage int√©gr√©.</li>
                    <li><strong>Final Cut Pro X</strong> : √âcosyst√®me Apple, timeline magn√©tique.</li>
                    <li><strong>Avid Media Composer</strong> : Standard cin√©ma/TV haut de gamme.</li>
                </ul>
                
                <h3>üìö Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"In the Blink of an Eye"</strong> - Walter Murch (2001) : Philosophie du montage par un ma√Ætre.</li>
                    <li><strong>"The Technique of Film Editing"</strong> - Karel Reisz (1953) : Classique technique britannique.</li>
                    <li><strong>"Film Editing: Theory and Practice"</strong> - Christopher Llewellyn Reed : Manuel contemporain.</li>
                    <li><strong>"The Conversations"</strong> - Michael Ondaatje & Walter Murch : Dialogue fascinant sur le m√©tier.</li>
                    <li><strong>"Cut by Cut"</strong> - Gael Chandler : Guide pratique moderne.</li>
                </ul>
                
                <h3>üé¨ Films √† √âtudier (Montage)</h3>
                <ul>
                    <li><strong>Le Cuirass√© Potemkine</strong> (Eisenstein, 1925) : Escalier dOdessa, montage intellectuel.</li>
                    <li><strong>√Ä bout de souffle</strong> (Godard, 1960) : Jump cuts r√©volutionnaires.</li>
                    <li><strong>Apocalypse Now</strong> (Walter Murch, 1979) : Montage et son visionnaires.</li>
                    <li><strong>Requiem for a Dream</strong> (2000) : Montage hip-hop, split screens.</li>
                    <li><strong>Mad Max: Fury Road</strong> (2015) : Centre du cadre constant, rythme effr√©n√©.</li>
                    <li><strong>Whiplash</strong> (2014) : Montage musical, tension rythmique.</li>
                </ul>
            </div>
        `,
        
        production: `
            <div class="courses-section">
                <h2>üíº La Production</h2>
                
                <h3>Les √âtapes d'un Film</h3>
                <ul>
                    <li><span class="notion" data-notion="developpement">D√©veloppement</span> : √âcriture, recherche de financements, montage du projet.</li>
                    <li><span class="notion" data-notion="pre-production">Pr√©-production</span> : Casting, rep√©rages, planning, constitution de l'√©quipe.</li>
                    <li><span class="notion" data-notion="production-tournage">Production (tournage)</span> : R√©alisation effective du film.</li>
                    <li><span class="notion" data-notion="post-production">Post-production</span> : Montage, √©talonnage, mixage, VFX.</li>
                    <li><span class="notion" data-notion="distribution">Distribution</span> : Festivals, vente, diffusion.</li>
                </ul>
                
                <h3>Documents Essentiels</h3>
                <ul>
                    <li><span class="notion" data-notion="plan-travail">Plan de travail</span> : Calendrier d√©taill√© du tournage jour par jour.</li>
                    <li><span class="notion" data-notion="feuille-service">Feuille de service</span> : Programme quotidien (horaires, lieux, sc√®nes, √©quipe).</li>
                    <li><span class="notion" data-notion="depouillement">D√©pouillement</span> : Liste des besoins par sc√®ne (d√©cors, costumes, accessoires).</li>
                    <li><span class="notion" data-notion="budget-film">Budget</span> : Estimation d√©taill√©e des co√ªts.</li>
                    <li><span class="notion" data-notion="contrats-film">Contrats</span> : Engagements avec l'√©quipe et les com√©diens.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Ordre de tournage :</strong> On ne tourne pas dans l'ordre du sc√©nario ! On regroupe par lieu, disponibilit√© des acteurs, et conditions (jour/nuit).
                </div>
                
                <h3>Postes Cl√©s</h3>
                <ul>
                    <li><span class="notion" data-notion="producteur">Producteur</span> : Finance et supervise l'ensemble du projet.</li>
                    <li><span class="notion" data-notion="directeur-production">Directeur de production</span> : G√®re le budget et la logistique.</li>
                    <li><span class="notion" data-notion="premier-assistant">1er assistant r√©alisateur</span> : Organise le tournage, g√®re le planning.</li>
                    <li><span class="notion" data-notion="regisseur">R√©gisseur</span> : Logistique quotidienne (lieux, repas, transport).</li>
                    <li><span class="notion" data-notion="scripte">Scripte</span> : Garant de la continuit√© entre les plans.</li>
                </ul>
            </div>
            
            <div class="courses-section">
                <h2>üéì Pour Aller Plus Loin</h2>
                
                <h3>Organigramme Complet dun Tournage</h3>
                <p><strong>D√©partement R√©alisation :</strong></p>
                <ul>
                    <li><strong>R√©alisateur</strong> : Vision artistique, direction des acteurs et de l√©quipe.</li>
                    <li><strong>1er Assistant R√©alisateur</strong> : Planning, organisation plateau, annonces.</li>
                    <li><strong>2√®me Assistant R√©alisateur</strong> : Feuilles de service, coordination com√©diens.</li>
                    <li><strong>3√®me Assistant / Stagiaire</strong> : Appui logistique, clap.</li>
                    <li><strong>Scripte</strong> : Continuit√©, raccords, chronom√©trage, rapport image.</li>
                </ul>
                
                <p><strong>D√©partement Image :</strong></p>
                <ul>
                    <li><span class="notion" data-notion="chef-op">Directeur de la Photographie (Chef Op)</span> : √âclairage, cadre, look.</li>
                    <li><strong>Cadreur</strong> : Op√®re la cam√©ra selon les directives.</li>
                    <li><strong>1er Assistant Cam√©ra (Pointeur)</strong> : Mise au point, gestion optiques.</li>
                    <li><strong>2√®me Assistant Cam√©ra</strong> : Clap, rapport cam√©ra, m√©dias.</li>
                    <li><strong>Chef √âlectricien</strong> : Installation et r√©glage des √©clairages.</li>
                    <li><strong>Chef Machiniste</strong> : Mouvements de cam√©ra, grip.</li>
                    <li><strong>DIT (Digital Imaging Technician)</strong> : Gestion des m√©dias, backups, LUTs.</li>
                </ul>
                
                <p><strong>D√©partement Son :</strong></p>
                <ul>
                    <li><strong>Chef Op√©rateur Son</strong> : Mixage plateau, choix des micros.</li>
                    <li><strong>Perchiste</strong> : Manipulation de la perche.</li>
                </ul>
                
                <p><strong>D√©partement Artistique :</strong></p>
                <ul>
                    <li><strong>Chef D√©corateur</strong> : Conception et r√©alisation des d√©cors.</li>
                    <li><strong>Accessoiriste</strong> : Objets manipul√©s par les acteurs.</li>
                    <li><strong>Chef Costumier</strong> : Conception et gestion des costumes.</li>
                    <li><strong>Habilleur</strong> : Aide les com√©diens, entretien costumes.</li>
                    <li><strong>Chef Maquilleur</strong> : Maquillage beaut√© et effets.</li>
                    <li><strong>Chef Coiffeur</strong> : Coiffures et perruques.</li>
                </ul>
                
                <div class="courses-tip">
                    <strong>üí° Hi√©rarchie :</strong> Sur un plateau, on sadresse toujours au chef de d√©partement, jamais directement √† son √©quipe (sauf urgence).
                </div>
                
                <h3>Le Financement en France</h3>
                <ul>
                    <li><strong>Apport producteur</strong> : Fonds propres de la soci√©t√© de production.</li>
                    <li><strong>Avance sur recettes (CNC)</strong> : Aide s√©lective sur sc√©nario et r√©alisateur.</li>
                    <li><strong>Aides r√©gionales</strong> : Fonds des r√©gions (tournage local requis).</li>
                    <li><strong>SOFICA</strong> : Soci√©t√©s dinvestissement d√©fiscalis√©es.</li>
                    <li><strong>Cr√©dit dimp√¥t cin√©ma</strong> : 30% des d√©penses fran√ßaises √©ligibles.</li>
                    <li><strong>Pr√©ventes TV</strong> : Cha√Ænes qui pr√©ach√®tent les droits de diffusion.</li>
                    <li><strong>Minimum garanti distributeur</strong> : Avance du distributeur salle.</li>
                    <li><strong>Coproduction internationale</strong> : Partenaires √©trangers (acc√®s √† leurs aides).</li>
                    <li><strong>Crowdfunding</strong> : Financement participatif (courts-m√©trages, documentaires).</li>
                </ul>
                
                <h3>Les Conventions Collectives</h3>
                <ul>
                    <li><strong>Convention Production Cin√©ma</strong> : Salaires minimums, heures suppl√©mentaires.</li>
                    <li><strong>Convention Production Audiovisuelle</strong> : TV, publicit√©, clips.</li>
                    <li><strong>Heures de travail</strong> : Base 8h/jour, 39h/semaine. Au-del√† = heures sup major√©es.</li>
                    <li><strong>Repos</strong> : 11h minimum entre deux journ√©es de travail.</li>
                    <li><strong>Repas</strong> : Obligatoires, max 6h entre deux repas.</li>
                </ul>
                
                <div class="courses-warning">
                    <strong>‚ö†Ô∏è Assurances obligatoires :</strong> Responsabilit√© civile, accidents du travail, mat√©riel, n√©gatif/m√©dias, interruption de tournage.
                </div>
                
                <h3>Gestion du Budget</h3>
                <ul>
                    <li><span class="notion" data-notion="above-below-line">Above the line</span> : Droits, sc√©nario, r√©alisateur, acteurs principaux (co√ªts cr√©atifs).</li>
                    <li><span class="notion" data-notion="above-below-line">Below the line</span> : √âquipe technique, mat√©riel, d√©cors, post-prod (co√ªts de fabrication).</li>
                    <li><strong>Contingence</strong> : R√©serve de 5-10% pour impr√©vus.</li>
                    <li><strong>Frais g√©n√©raux</strong> : 5-7% pour la structure de production.</li>
                    <li><strong>Completion bond</strong> : Garantie de bonne fin (gros budgets).</li>
                </ul>
                
                <h3>Le Plan de Travail - Principes dOptimisation</h3>
                <ul>
                    <li><strong>Regrouper par d√©cor</strong> : Minimiser les d√©m√©nagements.</li>
                    <li><strong>Disponibilit√© acteurs</strong> : Concentrer les sc√®nes dun m√™me com√©dien.</li>
                    <li><strong>Jour/Nuit</strong> : Regrouper les nuits (√©viter alternances √©puisantes).</li>
                    <li><strong>Ordre de difficult√©</strong> : Sc√®nes complexes en milieu de tournage (√©quipe rod√©e).</li>
                    <li><strong>M√©t√©o</strong> : Pr√©voir des sc√®nes de repli en int√©rieur.</li>
                    <li><strong>Enfants</strong> : Restrictions horaires l√©gales strictes.</li>
                </ul>
                
                <h3>Distribution et Exploitation</h3>
                <ul>
                    <li><strong>Agent de ventes (Sales Agent)</strong> : Vend le film √† linternational.</li>
                    <li><strong>Distributeur</strong> : Commercialise le film sur un territoire.</li>
                    <li><strong>Exploitant</strong> : Propri√©taire des salles de cin√©ma.</li>
                    <li><strong>Chronologie des m√©dias</strong> : Salle ‚Üí VOD ‚Üí TV payante ‚Üí TV gratuite ‚Üí SVOD.</li>
                    <li><strong>P&A (Prints and Advertising)</strong> : Budget copies et publicit√©.</li>
                </ul>
                
                <h3>üìö Ouvrages et Ressources</h3>
                <ul>
                    <li><strong>"Producing for the Screen"</strong> - Kathi Lipman : Guide pratique de production.</li>
                    <li><strong>"The Independent Film Producers Survival Guide"</strong> - Gunnar Erickson : Juridique et financier.</li>
                    <li><strong>"Film Production Management"</strong> - Bastian Cleve : Organisation et logistique.</li>
                    <li><strong>"Le Guide du producteur"</strong> - CNC : R√©f√©rence fran√ßaise (t√©l√©chargeable).</li>
                    <li><strong>"Movie Money"</strong> - Bill Daniels : Comprendre l√©conomie du cin√©ma.</li>
                </ul>
                
                <h3>üîó Ressources Utiles</h3>
                <ul>
                    <li><strong>CNC (cnc.fr)</strong> : Aides, r√©glementations, statistiques France.</li>
                    <li><strong>Film France</strong> : Commission du film nationale, autorisations.</li>
                    <li><strong>Commissions du film r√©gionales</strong> : Aides locales, rep√©rages.</li>
                    <li><strong>CST (Commission Sup√©rieure Technique)</strong> : Normes techniques.</li>
                    <li><strong>SACD / SCAM</strong> : Droits dauteur sc√©naristes/r√©alisateurs.</li>
                </ul>
            </div>
        `,
        
        glossaire: `
            <div class="courses-section">
                <h2>üìñ Glossaire du Cin√©ma</h2>
                
                <div class="courses-term"><dt>Axe</dt><dd>Direction dans laquelle la cam√©ra regarde le sujet.</dd></div>
                <div class="courses-term"><dt>Champ</dt><dd>Ce qui est visible dans le cadre.</dd></div>
                <div class="courses-term"><dt>Hors-champ</dt><dd>Ce qui est en dehors du cadre mais fait partie de la sc√®ne.</dd></div>
                <div class="courses-term"><dt>Di√©g√®se</dt><dd>L'univers fictif du film, tout ce qui "existe" dans l'histoire.</dd></div>
                <div class="courses-term"><dt>Di√©g√©tique</dt><dd>Son ou musique dont la source est dans l'univers du film (radio, personnage qui chante).</dd></div>
                <div class="courses-term"><dt>Extra-di√©g√©tique</dt><dd>Son ajout√© (musique de film, voix-off narrative).</dd></div>
                <div class="courses-term"><dt>Clap</dt><dd>Ardoise identifiant chaque prise. Le claquement permet la synchronisation son/image.</dd></div>
                <div class="courses-term"><dt>Rushes</dt><dd>Images brutes tourn√©es, non mont√©es.</dd></div>
                <div class="courses-term"><dt>Bout-√†-bout</dt><dd>Premier assemblage chronologique des rushes s√©lectionn√©s.</dd></div>
                <div class="courses-term"><dt>Ours</dt><dd>Premier montage complet mais non finalis√©.</dd></div>
                <div class="courses-term"><dt>√âtalonnage</dt><dd>Correction colorim√©trique pour harmoniser l'image et cr√©er une ambiance.</dd></div>
                <div class="courses-term"><dt>Mixage</dt><dd>√âquilibrage final de toutes les pistes audio.</dd></div>
                <div class="courses-term"><dt>DCP</dt><dd>Digital Cinema Package - Format de diffusion en salle.</dd></div>
                <div class="courses-term"><dt>Ratio</dt><dd>Rapport largeur/hauteur de l'image (1.85:1, 2.39:1 Scope, 16:9...).</dd></div>
                <div class="courses-term"><dt>Amorce</dt><dd>Partie d'un personnage ou objet au premier plan, partiellement visible.</dd></div>
                <div class="courses-term"><dt>Insert</dt><dd>Gros plan sur un d√©tail significatif (objet, main, texte).</dd></div>
                <div class="courses-term"><dt>Plan-s√©quence</dt><dd>Sc√®ne tourn√©e en un seul plan sans coupe.</dd></div>
                <div class="courses-term"><dt>Raccord</dt><dd>Coh√©rence visuelle et sonore entre deux plans cons√©cutifs.</dd></div>
            </div>
        `
    })
};

// --- MODULE CARD MODAL (Vue compacte + √©dition) ---
const CardModal = {
    currentType: null,
    currentIdx: null,
    viewMode: {}, // Stocke le mode de vue par type: 'compact' ou 'detailed'
    
    init: () => {
        // Charger les pr√©f√©rences de vue
        try {
            CardModal.viewMode = JSON.parse(localStorage.getItem('fmp_card_view_mode') || '{}');
        } catch(e) {
            CardModal.viewMode = {};
        }
    },
    
    getViewMode: (type) => {
        return CardModal.viewMode[type] || 'compact';
    },
    
    setViewMode: (type, mode) => {
        CardModal.viewMode[type] = mode;
        try {
            localStorage.setItem('fmp_card_view_mode', JSON.stringify(CardModal.viewMode));
        } catch(e) {}
        // Re-render
        if(type === 'characters') UI.renderDataTab('characters', els.charContainer);
        else if(type === 'actors') UI.renderDataTab('actors', els.actorContainer);
        else if(type === 'locations') UI.renderDataTab('locations', els.locContainer);
        else if(type === 'crew') UI.renderCrewTab();
    },
    
    open: (type, idx) => {
        CardModal.currentType = type;
        CardModal.currentIdx = idx;
        const item = state.data[type][idx];
        if(!item) return;
        
        const modal = document.getElementById('card-edit-modal');
        const title = document.getElementById('card-edit-modal-title');
        const body = document.getElementById('card-edit-modal-body');
        
        const typeLabels = { characters: 'üé≠ Personnage', actors: 'üé¨ Com√©dien¬∑ne', locations: 'üè† D√©cor' };
        title.textContent = typeLabels[type] + ' : ' + (item.name || 'Sans nom');
        
        // R√©utiliser le m√™me code que les fiches d√©taill√©es
        const tempContainer = document.createElement('div');
        tempContainer.className = 'data-grid';
        
        let groupType = '';
        if(type === 'characters') groupType = 'perso';
        else if(type === 'actors') groupType = 'actor';
        else if(type === 'locations') groupType = 'lieu';
        const relevantGroups = state.data.groups.filter(g => g.type === groupType);
        
        // Utiliser exactement le m√™me rendu que le mode d√©taill√©
        UI.renderDataCards([item], type, tempContainer, relevantGroups);
        
        // Extraire et adapter la carte pour le modal
        const cardContent = tempContainer.querySelector('.data-card');
        body.innerHTML = '';
        if(cardContent) {
            cardContent.style.border = 'none';
            cardContent.style.boxShadow = 'none';
            cardContent.style.maxWidth = 'none';
            cardContent.style.margin = '0';
            body.appendChild(cardContent);
        }
        
        modal.classList.add('visible');
        
        // Initialiser les calendriers si n√©cessaire
        if(type === 'actors') {
            setTimeout(() => {
                const calContainer = document.getElementById('actor-calendar-' + idx);
                if(calContainer && state.currentRole !== 'viewer') {
                    UI.renderAvailabilityCalendar('actor-calendar-' + idx, 'actor', idx);
                }
            }, 100);
        }
    },
    
    close: () => {
        const modal = document.getElementById('card-edit-modal');
        modal.classList.remove('visible');
        CardModal.currentType = null;
        CardModal.currentIdx = null;
        // Rafra√Æchir les vues compactes apr√®s fermeture
        const activeTab = document.querySelector('.tab-content.active');
        if(activeTab) {
            const tabId = activeTab.id;
            if(tabId === 'tab-chars') UI.renderDataTab('characters', els.charContainer);
            else if(tabId === 'tab-actors') UI.renderDataTab('actors', els.actorContainer);
            else if(tabId === 'tab-locs') UI.renderDataTab('locations', els.locContainer);
            else if(tabId === 'tab-crew') UI.renderCrewTab();
        }
    },
    
    // Rendu des cartes compactes pour l'√©quipe
    renderCompactCrewCards: (members, container, isView) => {
        members.forEach((member) => {
            const idx = state.data.crew.indexOf(member);
            const card = document.createElement('div');
            card.className = 'compact-card';
            card.onclick = () => CardModal.openCrew(idx);
            
            const photoContent = member.photo ? `<img src="${member.photo}">` : 'üë§';
            const roleInfo = member.role || '<em style="opacity:0.6">Fonction non d√©finie</em>';
            const badge = member.publicProfileId ? 'üîí' : '';
            
            card.innerHTML = `
                ${!isView ? `
                <div class="compact-card-actions">
                    <button class="edit-btn" onclick="event.stopPropagation(); app.CardModal.openCrew(${idx})" title="Modifier">‚úèÔ∏è</button>
                    <button class="delete-btn" onclick="event.stopPropagation(); app.Crew.deleteMember(${idx})" title="Supprimer">üóëÔ∏è</button>
                </div>
                ` : ''}
                ${badge ? `<div class="compact-card-badge">${badge}</div>` : ''}
                <div class="compact-card-photo">${photoContent}</div>
                <div class="compact-card-name">${Utils.escape(member.name || 'Sans nom')}</div>
                <div class="compact-card-role">${roleInfo}</div>
            `;
            
            container.appendChild(card);
        });
    },
    
    // Ouvrir le modal pour un membre de l'√©quipe
    openCrew: (idx) => {
        CardModal.currentType = 'crew';
        CardModal.currentIdx = idx;
        const member = state.data.crew[idx];
        if(!member) return;
        
        const modal = document.getElementById('card-edit-modal');
        const title = document.getElementById('card-edit-modal-title');
        const body = document.getElementById('card-edit-modal-body');
        
        title.textContent = 'üé• Technicien : ' + (member.name || 'Sans nom');
        
        // R√©utiliser le m√™me code que les fiches d√©taill√©es
        const isView = state.currentRole === 'viewer' || !Permissions.canEdit('equipe');
        const crewGroups = state.data.groups.filter(g => g.type === 'crew');
        const cardElement = UI.createCrewCard(member, idx, crewGroups, isView);
        
        // Adapter le style pour le modal
        cardElement.style.border = 'none';
        cardElement.style.boxShadow = 'none';
        cardElement.style.maxWidth = 'none';
        cardElement.style.margin = '0';
        
        body.innerHTML = '';
        body.appendChild(cardElement);
        
        modal.classList.add('visible');
        
        // Initialiser le calendrier
        setTimeout(() => {
            const calContainer = document.getElementById('crew-calendar-' + idx);
            if(calContainer && state.currentRole !== 'viewer') {
                UI.renderAvailabilityCalendar('crew-calendar-' + idx, 'crew', idx);
            }
        }, 100);
    },
    
    // Formulaire Personnage
    renderCharacterForm: (item, idx) => {
        const isView = state.currentRole === 'viewer' || !Permissions.canEdit('personnages');
        const linkedActor = state.data.actors.find(a => a.id === item.actor_id);
        
        let actorOptions = '<option value="">-- Aucun com√©dien --</option>';
        state.data.actors.forEach(a => {
            actorOptions += `<option value="${a.id}" ${item.actor_id === a.id ? 'selected' : ''}>${Utils.escape(a.name)}</option>`;
        });
        
        return `
            <div style="display: grid; gap: 20px;">
                <div style="display: flex; gap: 20px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; margin-bottom: 10px; overflow: hidden; border: 3px solid var(--border);">
                            ${item.photo ? `<img src="${item.photo}" style="width:100%; height:100%; object-fit:cover;">` : 'üé≠'}
                        </div>
                        <input type="text" class="actor-input" placeholder="URL photo" value="${item.photo || ''}" onchange="app.CardModal.updateField('photo', this.value)" style="width: 100px; font-size: 0.75rem;" ${isView ? 'disabled' : ''}>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Nom du personnage</label>
                        <input type="text" class="actor-input" value="${Utils.escape(item.name || '')}" onchange="app.CardModal.updateField('name', this.value)" style="font-size: 1.1rem; font-weight: 600;" ${isView ? 'disabled' : ''}>
                        
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec); margin-top: 15px; display: block;">Interpr√©t√© par</label>
                        <select class="actor-input" onchange="app.CardModal.updateField('actor_id', this.value)" ${isView ? 'disabled' : ''}>
                            ${actorOptions}
                        </select>
                        ${linkedActor ? `<div style="color: var(--success); font-size: 0.85rem; margin-top: 5px;">‚úì ${Utils.escape(linkedActor.name)}</div>` : ''}
                    </div>
                </div>
                
                <div>
                    <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Description / Biographie</label>
                    <textarea class="data-desc" style="min-height: 120px;" placeholder="Description du personnage, son histoire, sa personnalit√©..." onchange="app.CardModal.updateField('desc', this.value)" ${isView ? 'disabled' : ''}>${item.desc || ''}</textarea>
                </div>
            </div>
        `;
    },
    
    // Formulaire Com√©dien
    renderActorForm: (item, idx) => {
        const isLocked = !!item.publicProfileId;
        const isView = state.currentRole === 'viewer' || isLocked;
        const linkedCharacter = state.data.characters.find(c => c.actor_id === item.id);
        
        return `
            <div style="display: grid; gap: 20px;">
                <div style="display: flex; gap: 20px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; margin-bottom: 10px; overflow: hidden; border: 3px solid var(--border);">
                            ${item.photo ? `<img src="${item.photo}" style="width:100%; height:100%; object-fit:cover;">` : 'üé¨'}
                        </div>
                        ${!isView ? `<input type="text" class="actor-input" placeholder="URL photo" value="${item.photo || ''}" onchange="app.CardModal.updateField('photo', this.value)" style="width: 100px; font-size: 0.75rem;">` : ''}
                        ${isLocked ? '<div style="font-size:0.7rem; color:var(--primary); margin-top:5px;">üîí Profil revendiqu√©</div>' : ''}
                    </div>
                    <div style="flex: 1;">
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Nom</label>
                        <input type="text" class="actor-input" value="${Utils.escape(item.name || '')}" onchange="app.CardModal.updateField('name', this.value)" style="font-size: 1.1rem; font-weight: 600;" ${isView ? 'disabled' : ''}>
                        
                        ${linkedCharacter ? `<div style="color: var(--primary); font-size: 0.9rem; margin-top: 10px;">üé≠ Joue : <strong>${Utils.escape(linkedCharacter.name)}</strong></div>` : '<div style="color: var(--text-sec); font-size: 0.85rem; margin-top: 10px; font-style: italic;">Aucun personnage li√©</div>'}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-sec);">Email</label>
                                <input type="email" class="actor-input" value="${item.email || ''}" onchange="app.CardModal.updateField('email', this.value)" ${isView ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-sec);">T√©l√©phone</label>
                                <input type="tel" class="actor-input" value="${item.phone || ''}" onchange="app.CardModal.updateField('phone', this.value)" ${isView ? 'disabled' : ''}>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Ville / R√©gion</label>
                        <input type="text" class="actor-input" value="${item.city || ''}" onchange="app.CardModal.updateField('city', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Site Web</label>
                        <input type="url" class="actor-input" value="${item.website || ''}" onchange="app.CardModal.updateField('website', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div>
                    <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Bio</label>
                    <textarea class="data-desc" style="min-height: 80px;" placeholder="Biographie..." onchange="app.CardModal.updateField('bio', this.value)" ${isView ? 'disabled' : ''}>${item.bio || ''}</textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Taille (cm)</label>
                        <input type="number" class="actor-input" value="${item.height || ''}" onchange="app.CardModal.updateField('height', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">√Çge</label>
                        <input type="number" class="actor-input" value="${item.age || ''}" onchange="app.CardModal.updateField('age', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-sec);">Tarif jour</label>
                        <input type="number" class="actor-input" value="${item.dailyRate || ''}" onchange="app.CardModal.updateField('dailyRate', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div style="padding: 15px; background: var(--bg); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">ü§ù Type de collaboration</div>
                    <div style="display: flex; gap: 10px;">
                        <label style="flex:1; padding: 10px; border: 2px solid ${item.collabType === 'pro' ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; text-align: center; background: ${item.collabType === 'pro' ? 'rgba(43,110,246,0.1)' : 'transparent'};">
                            <input type="radio" name="modal-collab" value="pro" ${item.collabType === 'pro' ? 'checked' : ''} onchange="app.CardModal.updateField('collabType', 'pro')" style="display:none;" ${isView ? 'disabled' : ''}>
                            üé¨ Pro
                        </label>
                        <label style="flex:1; padding: 10px; border: 2px solid ${item.collabType === 'semi-pro' ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; text-align: center; background: ${item.collabType === 'semi-pro' ? 'rgba(43,110,246,0.1)' : 'transparent'};">
                            <input type="radio" name="modal-collab" value="semi-pro" ${item.collabType === 'semi-pro' ? 'checked' : ''} onchange="app.CardModal.updateField('collabType', 'semi-pro')" style="display:none;" ${isView ? 'disabled' : ''}>
                            ‚ö° Semi-pro
                        </label>
                        <label style="flex:1; padding: 10px; border: 2px solid ${item.collabType === 'benevole' ? 'var(--primary)' : 'var(--border)'}; border-radius: 8px; cursor: pointer; text-align: center; background: ${item.collabType === 'benevole' ? 'rgba(43,110,246,0.1)' : 'transparent'};">
                            <input type="radio" name="modal-collab" value="benevole" ${item.collabType === 'benevole' ? 'checked' : ''} onchange="app.CardModal.updateField('collabType', 'benevole')" style="display:none;" ${isView ? 'disabled' : ''}>
                            ‚ù§Ô∏è B√©n√©vole
                        </label>
                    </div>
                </div>
            </div>
        `;
    },
    
    // Formulaire D√©cor
    renderLocationForm: (item, idx) => {
        const isView = state.currentRole === 'viewer' || !Permissions.canEdit('lieux');
        const scenesInLocation = state.data.scenes.filter(s => s.title && s.title.toLowerCase().includes(item.name.toLowerCase()));
        
        return `
            <div style="display: grid; gap: 20px;">
                <div style="display: flex; gap: 20px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div style="width: 100px; height: 100px; border-radius: 12px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 3rem; overflow: hidden; border: 3px solid var(--border);">
                            ${item.photo ? `<img src="${item.photo}" style="width:100%; height:100%; object-fit:cover;">` : 'üè†'}
                        </div>
                        <input type="text" class="actor-input" placeholder="URL photo" value="${item.photo || ''}" onchange="app.CardModal.updateField('photo', this.value)" style="width: 100px; font-size: 0.75rem; margin-top: 10px;" ${isView ? 'disabled' : ''}>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Nom du d√©cor (sc√©nario)</label>
                        <input type="text" class="actor-input" value="${Utils.escape(item.name || '')}" onchange="app.CardModal.updateField('name', this.value)" style="font-size: 1.1rem; font-weight: 600;" ${isView ? 'disabled' : ''}>
                        
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec); margin-top: 15px; display: block;">Lieu r√©el de tournage</label>
                        <input type="text" class="actor-input" value="${Utils.escape(item.realLocationName || '')}" placeholder="Ex: Ch√¢teau de Versailles" onchange="app.CardModal.updateField('realLocationName', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div>
                    <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Adresse</label>
                    <input type="text" class="actor-input" value="${Utils.escape(item.address || '')}" placeholder="Adresse compl√®te..." onchange="app.CardModal.updateField('address', this.value)" ${isView ? 'disabled' : ''}>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Contact sur place</label>
                        <input type="text" class="actor-input" value="${item.contactName || ''}" placeholder="Nom du contact" onchange="app.CardModal.updateField('contactName', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">T√©l√©phone</label>
                        <input type="tel" class="actor-input" value="${item.contactPhone || ''}" onchange="app.CardModal.updateField('contactPhone', this.value)" ${isView ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div>
                    <label style="font-weight: 600; font-size: 0.85rem; color: var(--text-sec);">Description / Notes d'acc√®s</label>
                    <textarea class="data-desc" style="min-height: 80px;" placeholder="Description du lieu, notes d'acc√®s, parking..." onchange="app.CardModal.updateField('desc', this.value)" ${isView ? 'disabled' : ''}>${item.desc || ''}</textarea>
                </div>
                
                ${scenesInLocation.length > 0 ? `
                <div style="padding: 15px; background: var(--bg); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">üé¨ Sc√®nes dans ce d√©cor (${scenesInLocation.length})</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${scenesInLocation.slice(0, 10).map(s => `<span style="padding: 4px 10px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 15px; font-size: 0.8rem;">${Utils.escape(s.title)}</span>`).join('')}
                        ${scenesInLocation.length > 10 ? `<span style="padding: 4px 10px; color: var(--text-sec); font-size: 0.8rem;">+${scenesInLocation.length - 10} autres</span>` : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    },
    
    updateField: (field, value) => {
        if(CardModal.currentType && CardModal.currentIdx !== null) {
            const item = state.data[CardModal.currentType][CardModal.currentIdx];
            if(item) {
                item[field] = value;
                Store.save();
                // Mettre √† jour le titre du modal si c'est le nom
                if(field === 'name') {
                    const typeLabels = { characters: 'üé≠ Personnage', actors: 'üé¨ Com√©dien¬∑ne', locations: 'üè† D√©cor' };
                    document.getElementById('card-edit-modal-title').textContent = typeLabels[CardModal.currentType] + ' : ' + (value || 'Sans nom');
                }
            }
        }
    },
    
    // Rendu des cartes compactes
    renderCompactCards: (items, type, container) => {
        const isView = state.currentRole === 'viewer';
        
        items.forEach((item) => {
            const idx = state.data[type].indexOf(item);
            const card = document.createElement('div');
            card.className = 'compact-card';
            card.onclick = () => CardModal.open(type, idx);
            
            let photoContent = '';
            let roleInfo = '';
            let badge = '';
            
            if(type === 'characters') {
                photoContent = item.photo ? `<img src="${item.photo}">` : 'üé≠';
                const linkedActor = state.data.actors.find(a => a.id === item.actor_id);
                roleInfo = linkedActor ? Utils.escape(linkedActor.name) : '<em style="opacity:0.5">Non cast√©</em>';
            } else if(type === 'actors') {
                photoContent = item.photo ? `<img src="${item.photo}">` : 'üé¨';
                const linkedChar = state.data.characters.find(c => c.actor_id === item.id);
                roleInfo = linkedChar ? 'üé≠ ' + Utils.escape(linkedChar.name) : '<em style="opacity:0.5">Pas de r√¥le</em>';
                if(item.publicProfileId) badge = 'üîí';
            } else if(type === 'locations') {
                photoContent = item.photo ? `<img src="${item.photo}">` : 'üè†';
                roleInfo = item.realLocationName ? Utils.escape(item.realLocationName) : '<em style="opacity:0.5">Lieu non d√©fini</em>';
            }
            
            card.innerHTML = `
                ${!isView ? `
                <div class="compact-card-actions">
                    <button class="edit-btn" onclick="event.stopPropagation(); app.CardModal.open('${type}', ${idx})" title="Modifier">‚úèÔ∏è</button>
                    <button class="delete-btn" onclick="event.stopPropagation(); app.Actions.deleteDataItem('${type}', ${idx})" title="Supprimer">üóëÔ∏è</button>
                </div>
                ` : ''}
                ${badge ? `<div class="compact-card-badge">${badge}</div>` : ''}
                <div class="compact-card-photo">${photoContent}</div>
                <div class="compact-card-name">${Utils.escape(item.name || 'Sans nom')}</div>
                <div class="compact-card-role">${roleInfo}</div>
            `;
            
            container.appendChild(card);
        });
    }
};

const TitlePage = {
    load: () => {
        const tp = state.data.titlePage || {};
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('tp-title', tp.title);
        setVal('tp-author', tp.author);
        setVal('tp-coauthor', tp.coauthor);
        setVal('tp-contact', tp.contact);
        setVal('tp-draft', tp.draft);
        setVal('tp-date', tp.date);
        setVal('tp-source', tp.source);
        setVal('tp-copyright', tp.copyright);
        setVal('tp-notes', tp.notes);
    },
    save: () => {
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
        state.data.titlePage = {
            title: getVal('tp-title'),
            author: getVal('tp-author'),
            coauthor: getVal('tp-coauthor'),
            contact: getVal('tp-contact'),
            draft: getVal('tp-draft'),
            date: getVal('tp-date'),
            source: getVal('tp-source'),
            copyright: getVal('tp-copyright'),
            notes: getVal('tp-notes')
        };
        Store.save();
    }
};

const SceneVersions = {
    maxVersions: 10,
    
    // Sauvegarder une version de la sc√®ne
    save: (sceneId) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene) return;
        
        if(!scene.versions) scene.versions = [];
        
        // Cr√©er la version
        const version = {
            id: 'v_' + Date.now(),
            date: new Date().toISOString(),
            dateDisplay: new Date().toLocaleString('fr-FR'),
            title: scene.title,
            scriptContent: scene.scriptContent,
            resume: scene.resume,
            perso: scene.perso,
            time: scene.time,
            savedBy: state.currentUser?.email?.split('@')[0] || 'Inconnu'
        };
        
        // Ajouter au d√©but
        scene.versions.unshift(version);
        
        // Limiter √† maxVersions
        if(scene.versions.length > SceneVersions.maxVersions) {
            scene.versions = scene.versions.slice(0, SceneVersions.maxVersions);
        }
        
        Store.save();
        UI.renderScript();
        Utils.toast(`Version sauvegard√©e (${scene.versions.length}/${SceneVersions.maxVersions})`, 'success');
    },
    
    // Ouvrir la modale des versions
    openModal: (sceneId) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene) return;
        
        const versions = scene.versions || [];
        
        let versionsHtml = '';
        
        if(versions.length === 0) {
            versionsHtml = `
                <div style="text-align: center; padding: 40px; color: var(--text-sec);">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üìú</div>
                    <p>Aucune version sauvegard√©e</p>
                    <p style="font-size: 0.85rem;">Cliquez sur üì∏ pour sauvegarder une version</p>
                </div>
            `;
        } else {
            versions.forEach((v, idx) => {
                const preview = SceneVersions.getTextPreview(v.scriptContent);
                versionsHtml += `
                    <div class="scene-version-item">
                        <div class="scene-version-info">
                            <div class="scene-version-date">
                                ${v.dateDisplay || new Date(v.date).toLocaleString('fr-FR')}
                                <span style="font-weight: normal; color: var(--text-sec); font-size: 0.85rem;">par ${v.savedBy || 'Inconnu'}</span>
                            </div>
                            <div class="scene-version-preview">${Utils.escape(preview)}</div>
                        </div>
                        <div class="scene-version-actions">
                            <button class="scene-version-btn preview" onclick="app.SceneVersions.preview('${sceneId}', ${idx})">üëÅÔ∏è</button>
                            <button class="scene-version-btn restore" onclick="app.SceneVersions.restore('${sceneId}', ${idx})">‚Ü©Ô∏è Restaurer</button>
                            <button class="scene-version-btn delete" onclick="app.SceneVersions.delete('${sceneId}', ${idx})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }
        
        const sceneIdx = state.data.scenes.findIndex(s => s.id === sceneId);
        
        const modal = document.createElement('div');
        modal.className = 'scene-versions-modal';
        modal.id = 'scene-versions-modal';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div class="scene-versions-box">
                <div class="scene-versions-header">
                    <h3>üìú Versions - Sc√®ne #${sceneIdx + 1}</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 0.85rem; color: var(--text-sec);">${versions.length}/${SceneVersions.maxVersions}</span>
                        <button onclick="app.SceneVersions.save('${sceneId}'); document.getElementById('scene-versions-modal').remove(); app.SceneVersions.openModal('${sceneId}');" style="padding: 8px 15px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üì∏ Nouvelle version</button>
                        <button onclick="this.closest('.scene-versions-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-sec);">‚úï</button>
                    </div>
                </div>
                <div class="scene-versions-content">
                    ${versionsHtml}
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Extraire un aper√ßu texte du contenu HTML
    getTextPreview: (html) => {
        if(!html) return '(vide)';
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const text = temp.innerText.trim();
        return text.length > 100 ? text.substring(0, 100) + '...' : text;
    },
    
    // Pr√©visualiser une version
    preview: (sceneId, versionIdx) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene || !scene.versions || !scene.versions[versionIdx]) return;
        
        const v = scene.versions[versionIdx];
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:10002;';
        modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
        
        modal.innerHTML = `
            <div style="background: var(--panel-bg); border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">üëÅÔ∏è Aper√ßu - ${v.dateDisplay}</h3>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
                </div>
                <div style="padding: 20px; overflow-y: auto; flex: 1;">
                    <div style="margin-bottom: 15px; padding: 10px; background: var(--bg); border-radius: 8px;">
                        <strong>${Utils.escape(v.title)}</strong><br>
                        <span style="font-size: 0.85rem; color: var(--text-sec);">${Utils.escape(v.perso)} ‚Ä¢ ${v.time} min</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>R√©sum√© :</strong><br>
                        <p style="color: var(--text-sec);">${Utils.escape(v.resume) || '(vide)'}</p>
                    </div>
                    <div style="background: white; color: #333; padding: 20px; border-radius: 8px; font-family: 'Courier Prime', monospace;">
                        ${v.scriptContent || '<em style="color:#999">(vide)</em>'}
                    </div>
                </div>
                <div style="padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 10px 20px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">Fermer</button>
                    <button onclick="this.closest('div[style*=fixed]').remove(); app.SceneVersions.restore('${sceneId}', ${versionIdx})" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚Ü©Ô∏è Restaurer cette version</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    // Restaurer une version
    restore: async (sceneId, versionIdx) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene || !scene.versions || !scene.versions[versionIdx]) return;
        
        if(!await ConfirmModal.show({ title: 'Restaurer cette version ?', message: 'Le contenu actuel de la sc√®ne sera remplac√©.', icon: 'üìú', confirmText: 'Restaurer' })) return;
        
        const v = scene.versions[versionIdx];
        
        // Sauvegarder l'√©tat actuel avant restauration
        const currentVersion = {
            id: 'v_' + Date.now(),
            date: new Date().toISOString(),
            dateDisplay: new Date().toLocaleString('fr-FR'),
            title: scene.title,
            scriptContent: scene.scriptContent,
            resume: scene.resume,
            perso: scene.perso,
            time: scene.time,
            savedBy: state.currentUser?.email?.split('@')[0] || 'Inconnu',
            autoSave: true
        };
        scene.versions.unshift(currentVersion);
        
        // Restaurer
        scene.title = v.title;
        scene.scriptContent = v.scriptContent;
        scene.resume = v.resume;
        scene.perso = v.perso;
        scene.time = v.time;
        
        // Limiter les versions
        if(scene.versions.length > SceneVersions.maxVersions) {
            scene.versions = scene.versions.slice(0, SceneVersions.maxVersions);
        }
        
        Store.save();
        UI.renderScript();
        UI.renderBoard();
        
        // Fermer la modale
        const modal = document.getElementById('scene-versions-modal');
        if(modal) modal.remove();
        
        Utils.toast('Version restaur√©e !', 'success');
        Utils.notifyImpact('script', ['board', 'breakdown'], 'restaur√©');
    },
    
    // Supprimer une version
    delete: async (sceneId, versionIdx) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene || !scene.versions || !scene.versions[versionIdx]) return;
        
        if(!await ConfirmModal.confirmDelete("Cette version sera supprim√©e.")) return;
        
        scene.versions.splice(versionIdx, 1);
        
        Store.save();
        
        // Rafra√Æchir la modale
        const modal = document.getElementById('scene-versions-modal');
        if(modal) {
            modal.remove();
            SceneVersions.openModal(sceneId);
        }
        
        Utils.toast('Version supprim√©e', 'success');
    }
};

const Synopsis = {
    getEditor: (type) => {
        const id = type === 'synopsis' ? 'synopsisEditor' : (type === 'short' ? 'shortEditor' : 'longEditor');
        return document.getElementById(id);
    },
    
    save: (type, notify = false) => {
        const editor = Synopsis.getEditor(type);
        if(!editor) return;
        
        const key = type === 'synopsis' ? 'synopsis' : (type === 'short' ? 'synopsisShort' : 'synopsisLong');
        state.data[key] = editor.value;
        
        // Mettre √† jour la sidebar du s√©quencier
        Synopsis.updateBoard();
        
        Store.saveProject();
        
        if(notify) Utils.notifyImpact('synopsis', 'board');
    },
    
    load: (type) => {
        const editor = Synopsis.getEditor(type);
        if(!editor) return;
        
        const key = type === 'synopsis' ? 'synopsis' : (type === 'short' ? 'synopsisShort' : 'synopsisLong');
        const content = state.data[key] || '';
        
        // Nettoyer le HTML si ancien format
        if(content.includes('<div')) {
            const temp = document.createElement('div');
            temp.innerHTML = content;
            editor.value = temp.innerText;
        } else {
            editor.value = content;
        }
    },
    
    render: (type) => {
        Synopsis.load(type);
    },
    
    renderTree: (type) => {
        Synopsis.load(type);
    },
    
    updateBoard: () => {
        if(els.boardSynopsis) els.boardSynopsis.innerText = state.data.synopsis || "(Vide)";
        if(els.boardShort) els.boardShort.innerText = state.data.synopsisShort || "(Vide)";
        if(els.boardLong) els.boardLong.innerText = state.data.synopsisLong || "(Vide)";
    },
    
    getFullText: (type) => {
        const editor = Synopsis.getEditor(type);
        return editor ? editor.value : '';
    },
    
    init: () => {
        // Attacher les √©v√©nements oninput aux textarea
        const types = ['synopsis', 'short', 'long'];
        types.forEach(type => {
            const editor = Synopsis.getEditor(type);
            if(editor) {
                editor.addEventListener('input', () => Synopsis.save(type));
            }
        });
    }
};
    
const Help = {
    currentSection: 'intro',
    
    sections: {
        intro: {
            title: 'üè† Bienvenue sur Moteur',
            content: `
                <p><strong>Moteur</strong> est une application compl√®te de gestion de production audiovisuelle. Elle vous permet de g√©rer tous les aspects de vos projets de films, s√©ries, clips ou publicit√©s.</p>
                
                <h3>üéØ Fonctionnalit√©s principales</h3>
                <ul>
                    <li><strong>Sc√©nario</strong> - √âcriture et formatage professionnel</li>
                    <li><strong>S√©quencier</strong> - Organisation visuelle des sc√®nes</li>
                    <li><strong>D√©pouillement</strong> - Extraction des besoins techniques</li>
                    <li><strong>Storyboard</strong> - Visualisation des plans</li>
                    <li><strong>Planning</strong> - Calendrier de tournage</li>
                    <li><strong>√âquipe</strong> - Gestion des com√©diens et techniciens</li>
                    <li><strong>D√©penses</strong> - Budget avec validation hi√©rarchique</li>
                    <li><strong>Univers</strong> - R√©seau de professionnels</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.8</h3>
                <ul>
                    <li><strong>üëë Profils √† la cr√©ation</strong> - Choisissez vos r√¥les sur chaque projet</li>
                    <li><strong>üí∞ Budget hi√©rarchique</strong> - Responsables global et par d√©partement</li>
                    <li><strong>üîÑ Workflow validation</strong> - Valider, remonter ou renvoyer les d√©penses</li>
                    <li><strong>üîî Notifications</strong> - Restez inform√© des actions en temps r√©el</li>
                    <li><strong>üè∑Ô∏è Badges avatars</strong> - Voyez les r√¥les de chacun d'un coup d'≈ìil</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.8.1</h3>
                <ul>
                    <li><strong>üé¨ Badges projets</strong> - Voyez sur quels projets vos profils sont utilis√©s</li>
                    <li><strong>üîó Liaison automatique</strong> - Les profils existants sont d√©tect√©s par email</li>
                    <li><strong>üì§ Profil alternatif</strong> - Proposez votre profil si vous utilisez une autre adresse</li>
                    <li><strong>üíæ Sauvegardes fiables</strong> - Protection contre la perte de donn√©es</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.8.2</h3>
                <ul>
                    <li><strong>üìú Export Fountain</strong> - Format universel compatible avec 20+ logiciels</li>
                    <li><strong>üé¨ Export Final Draft</strong> - Format .fdx natif pour Final Draft</li>
                    <li><strong>üìù Page de titre</strong> - Auteur, contact, version, copyright</li>
                    <li><strong>‚¨õ Bloc Centr√©</strong> - Nouveau type pour cartons et titres</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.8.7</h3>
                <ul>
                    <li><strong>üìÅ Navigation par cat√©gories</strong> - 4 groupes : √âcriture, Casting, Production, Admin</li>
                    <li><strong>üî≤ Vue Compact / D√©taill√©</strong> - Basculez entre cartes compactes et fiches compl√®tes</li>
                    <li><strong>üé® Personnalisation</strong> - Clic droit pour colorer ou masquer cat√©gories et onglets</li>
                    <li><strong>‚äï √âl√©ments masqu√©s</strong> - Restaurez facilement les onglets cach√©s</li>
                    <li><strong>‚ú® √âtats vides engageants</strong> - Boutons d'action et astuces pour d√©marrer</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.8.8</h3>
                <ul>
                    <li><strong>üé® Configuration UI par projet</strong> - Couleurs, ordre et onglets masqu√©s sauvegard√©s par projet</li>
                    <li><strong>üó∫Ô∏è Adresses s√©curis√©es</strong> - Position stable sur la carte, sans rechargement al√©atoire</li>
                    <li><strong>üîí Confidentialit√© adresses</strong> - Option pour masquer l'adresse exacte dans l'Univers</li>
                    <li><strong>üìç Autocompl√©tion adresse</strong> - Suggestions via API adresse.data.gouv.fr</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.9</h3>
                <ul>
                    <li><strong>üì∏ Versioning des sc√®nes</strong> - Sauvegardez jusqu'√† 10 versions par sc√®ne (üì∏ sauvegarder, üìú historique)</li>
                    <li><strong>üìÑ Page de titre</strong> - Auteur, co-auteur, contact, version, copyright</li>
                    <li><strong>üîî Notifications inter-onglets</strong> - Alertes lors des modifications qui impactent d'autres modules</li>
                    <li><strong>üìä Stats enrichies</strong> - Jours de tournage par com√©dien</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.9.1</h3>
                <ul>
                    <li><strong>üéØ Matching intelligent</strong> - Trouvez les projets compatibles avec votre profil (score 0-100%)</li>
                    <li><strong>üìú Vue Script Continue</strong> - √âditez toutes vos sc√®nes dans un seul √©diteur fluide</li>
                    <li><strong>üé¨ Sidebar sticky</strong> - Infos de la sc√®ne active qui suivent le scroll</li>
                    <li><strong>‚ÜïÔ∏è Drag & drop</strong> - R√©ordonnez les sc√®nes depuis le titre en Vue Continue</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.9.2</h3>
                <ul>
                    <li><strong>üßπ Nettoyage du code</strong> - Suppression du code mort et des doublons</li>
                    <li><strong>üè∑Ô∏è Renommage complet</strong> - Tous les anciens noms remplac√©s par "Moteur"</li>
                    <li><strong>üîß Corrections diverses</strong> - M√©thodes d√©pr√©ci√©es mises √† jour</li>
                </ul>
                
				                <h3>‚ú® Nouveaut√©s V1.9.5</h3>
                <ul>
                    <li><strong>üì¶ Onglet Ressources</strong> - G√©rez vos accessoires, costumes et v√©hicules avec fiches d√©taill√©es</li>
                    <li><strong>üìù Brouillon / ‚úÖ Finale</strong> - Syst√®me de validation des sc√®nes avant d√©pouillement</li>
                    <li><strong>üîó Liaison visuelle</strong> - Fl√®ches SVG reliant texte et d√©pouillement au survol</li>
                    <li><strong>‚ÜïÔ∏è Drag & drop sous-onglets</strong> - R√©organisez les onglets entre cat√©gories</li>
                    <li><strong>üîÄ Fusion de ressources</strong> - Combinez les fiches en doublon automatiquement</li>
                </ul>
				
                <h3>‚ú® Nouveaut√©s V1.9.7</h3>
                <ul>
                    <li><strong>üé® Roue chromatique</strong> - G√©n√©rateur de palettes style Adobe Color avec 8 harmonies</li>
                    <li><strong>‚¨° 30+ formes</strong> - Rectangles, cercles, fl√®ches, bulles, symboles, cadres vides</li>
                    <li><strong>‚Üª Rotation</strong> - Tournez les formes/images avec le handle (Shift = snap 15¬∞)</li>
                    <li><strong>üé® Couleur des formes</strong> - Clic droit pour changer la couleur</li>
                    <li><strong>‚úèÔ∏è Renommer palettes</strong> - Personnalisez le nom de vos palettes</li>
                    <li><strong>üìê Formats A4/A3/A2/A0</strong> - Canvas portrait et paysage fonctionnels</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.9.7</h3>
                <ul>
                    <li><strong>üé® Roue chromatique</strong> - G√©n√©rateur de palettes style Adobe Color avec 8 harmonies</li>
                    <li><strong>‚¨° 30+ formes</strong> - Rectangles, cercles, fl√®ches, bulles, symboles, cadres vides</li>
                    <li><strong>‚Üª Rotation</strong> - Tournez les formes/images avec le handle (Shift = snap 15¬∞)</li>
                    <li><strong>üé® Couleur des formes</strong> - Clic droit pour changer la couleur</li>
                    <li><strong>‚úèÔ∏è Renommer palettes</strong> - Personnalisez le nom de vos palettes</li>
                    <li><strong>üìê Formats A4/A3/A2/A0</strong> - Canvas portrait et paysage fonctionnels</li>
                </ul>
                
                <h3>‚ú® Nouveaut√©s V1.9.9</h3>
                <ul>
                    <li><strong>üìê Menu d'affichage unifi√©</strong> - Navigation, Position et Mode regroup√©s dans un seul bouton</li>
                    <li><strong>‚ÜîÔ∏è Position des onglets</strong> - Placez vos onglets en Haut, Bas, Gauche ou Droite</li>
                    <li><strong>üñ±Ô∏è Effet hover adaptatif</strong> - Survolez un onglet pour lire son nom complet</li>
                    <li><strong>üé® 12 th√®mes visuels</strong> - Glassmorphism, Cyberpunk, Cin√©ma, N√©on, et plus</li>
                    <li><strong>üîß Menus contextuels am√©lior√©s</strong> - Ne sortent plus de l'√©cran</li>
                </ul>
                
				<h3>‚ú® Nouveaut√©s V1.9.9.1</h3>
                <ul>
                    <li><strong>üìã Rapport de Script</strong> - Nouvel onglet dans Production pour documenter chaque prise</li>
                    <li><strong>üé¨ Fiche par plan</strong> - Navigation intuitive sc√®ne/plan avec auto-remplissage intelligent</li>
                    <li><strong>‚≠ê Notation des prises</strong> - Qualit√© Son/Image/Acting (1-5) + √©toiles Or et Argent</li>
                    <li><strong>üí¨ Dialogues automatiques</strong> - Extraction depuis le sc√©nario de la sc√®ne</li>
                    <li><strong>üìÑ Export PDF pro</strong> - Mise en page soign√©e avec √©toiles graphiques color√©es</li>
                    <li><strong>üë• Planning am√©lior√©</strong> - Acteurs group√©s par type dans les feuilles de service</li>
                </ul>
				

                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Utilisez les onglets √† gauche pour naviguer dans ce guide et d√©couvrir toutes les fonctionnalit√©s.
                </div>
            `
        },
        dashboard: {
            title: 'üìä Dashboard',
            content: `
                <p>Le Dashboard est votre page d'accueil. Il affiche vos projets et donne acc√®s √† toutes les fonctionnalit√©s.</p>
                
                <h3>üé¨ Cr√©er un projet</h3>
                <p>Cliquez sur la carte <strong>"+ Nouveau Projet"</strong> pour cr√©er un nouveau film.</p>
                <ol>
                    <li>Un modal s'ouvre avec vos profils existants</li>
                    <li>S√©lectionnez le(s) r√¥le(s) que vous aurez sur ce projet</li>
                    <li>Vos profils seront automatiquement ajout√©s √† l'√©quipe</li>
                    <li>Ces profils sont <strong>üîí revendiqu√©s</strong> et non modifiables par les autres</li>
                </ol>
                
                <h3>üëë Propri√©taire du projet</h3>
                <p>En tant que cr√©ateur, vous √™tes <strong>propri√©taire</strong> du projet avec tous les droits :</p>
                <ul>
                    <li>Gestion des acc√®s et des collaborateurs</li>
                    <li>Suppression du projet</li>
                    <li>Badge üëë sur votre avatar</li>
                </ul>
                
                <h3>üìÅ Vos projets</h3>
                <p>Tous vos projets apparaissent sous forme de cartes. Cliquez sur une carte pour ouvrir le projet.</p>
                
                <h3>üîò Boutons du header</h3>
                <table class="help-table">
                    <tr><th>Bouton</th><th>Action</th></tr>
                    <tr><td>üë§ Mon Profil</td><td>G√©rer vos profils publics (com√©dien, technicien...)</td></tr>
                    <tr><td>üìÅ Mes Projets</td><td>Revenir √† la liste des projets</td></tr>
                    <tr><td>üìá Contacts</td><td>Acc√©der √† vos favoris et √† l'annuaire</td></tr>
                    <tr><td>üåì Mode</td><td>Basculer entre th√®me clair et sombre</td></tr>
                    <tr><td>‚ùì Guide</td><td>Ouvrir cette aide</td></tr>
                </table>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Cr√©ez plusieurs profils (com√©dien + technicien) dans "Mon Profil" pour pouvoir choisir vos r√¥les lors de la cr√©ation de projets.
                </div>
            `
        },
        scenario: {
            title: 'üìù Sc√©nario',
            content: `
                <p>L'√©diteur de sc√©nario permet d'√©crire vos sc√®nes au format professionnel am√©ricain.</p>
                
                <h3>‚úçÔ∏è √âcriture</h3>
                <p>S√©lectionnez une sc√®ne dans le s√©quencier, puis utilisez l'√©diteur √† droite pour √©crire.</p>
                
                <h3>üìù Brouillon / ‚úÖ Finale</h3>
                <p>Chaque sc√®ne a un statut qui contr√¥le l'acc√®s au d√©pouillement :</p>
                <ul>
                    <li><strong>üìù Brouillon</strong> - Le texte peut √™tre modifi√© librement, mais le d√©pouillement est bloqu√©</li>
                    <li><strong>‚úÖ Finale</strong> - Le texte est consid√©r√© comme d√©finitif, le d√©pouillement est accessible</li>
                </ul>
                <p>Utilisez le bouton <strong>"Finaliser"</strong> dans la sidebar pour passer une sc√®ne en finale. Si vous devez modifier une sc√®ne finale, cliquez sur <strong>"Repasser en brouillon"</strong> (le d√©pouillement sera r√©initialis√©).</p>
                
                <h3>üè∑Ô∏è Types de blocs</h3>
                <p>Utilisez les <strong>raccourcis directs</strong> ou <span class="help-shortcut">Tab</span> intelligent :</p>
                <table class="help-table">
                    <tr><th>Raccourci</th><th>Type</th></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">1</span></td><td>Action</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">2</span></td><td>Personnage</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">3</span></td><td>Dialogue</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">4</span></td><td>Didascalie</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">5</span></td><td>Transition</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">6</span></td><td>Centr√©</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">7</span></td><td>Note</td></tr>
                    <tr><td><span class="help-shortcut">Tab</span></td><td>Type suivant logique</td></tr>
                    <tr><td><span class="help-shortcut">Shift</span>+<span class="help-shortcut">Tab</span></td><td>Type pr√©c√©dent</td></tr>
                </table>
                <p style="margin-top:10px"><strong>Tab intelligent :</strong> Action‚ÜîPerso, Dial‚ÜîDidas (toggle)</p>
                <table class="help-table">
                    <tr><th>Type</th><th>Description</th></tr>
                    <tr><td>Action</td><td>Description de l'action, du d√©cor, des mouvements</td></tr>
                    <tr><td>Personnage</td><td>Nom du personnage qui parle (en majuscules)</td></tr>
                    <tr><td>Dialogue</td><td>Ce que dit le personnage</td></tr>
                    <tr><td>Didascalie</td><td>Indication de jeu entre parenth√®ses (ton, geste...) - les ( ) s'ajoutent automatiquement</td></tr>
                    <tr><td>Transition</td><td>Transition entre sc√®nes (CUT TO, FONDU...)</td></tr>
                    <tr><td>Centr√©</td><td>Texte centr√© pour cartons, titres, intercalaires</td></tr>
                    <tr><td>Note</td><td>Note de l'auteur {entre accolades} - non imprim√©e</td></tr>
                    <tr><td>Inconnu</td><td>Bloc non cat√©goris√© (utilis√© lors d'imports)</td></tr>
                </table>
                
                <h3>üîß Outils de la barre</h3>
                <table class="help-table">
                    <tr><th>Bouton</th><th>Fonction</th></tr>
                    <tr><td>üîç</td><td>Rechercher / Remplacer dans le sc√©nario</td></tr>
                    <tr><td>üìÑ</td><td>Importer un sc√©nario PDF ou Final Draft</td></tr>
                    <tr><td>üìù</td><td>Configurer la page de titre (auteur, contact...)</td></tr>
                </table>
                
                <h3>üîÄ Navigation entre sc√®nes</h3>
                <table class="help-table">
                    <tr><th>Raccourci</th><th>Action</th></tr>
                    <tr><td><span class="help-shortcut">Ctrl/‚åò</span> + <span class="help-shortcut">‚Üê</span></td><td>Aller √† la sc√®ne pr√©c√©dente</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/‚åò</span> + <span class="help-shortcut">‚Üí</span></td><td>Aller √† la sc√®ne suivante</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/‚åò</span> + <span class="help-shortcut">Entr√©e</span></td><td>Ins√©rer une nouvelle sc√®ne apr√®s</td></tr>
                </table>
                
                <h3>üîÑ Auto-compl√©tion</h3>
                <p>Les noms de personnages sont auto-compl√©t√©s. Commencez √† taper et s√©lectionnez dans la liste.</p>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Apr√®s un nom de personnage, le bloc suivant passe automatiquement en Dialogue.
                </div>
            `
        },
        focusmode: {
            title: 'üñ•Ô∏è Mode Focus',
            content: `
                <p>Le Mode Focus vous permet de travailler en plein √©cran sur un onglet, sans distraction.</p>
                
                <h3>üöÄ Activer le Mode Focus</h3>
                <ul>
                    <li>Appuyez sur <strong>F11</strong> sur votre clavier</li>
                    <li>Ou cliquez sur le menu <strong>üìê</strong> puis <strong>üñ•Ô∏è Mode Focus</strong></li>
                </ul>
                
                <h3>üéõÔ∏è Barre d'outils Focus</h3>
                <p>En mode Focus, une barre minimaliste appara√Æt en haut :</p>
                <ul>
                    <li><strong>‚úï Quitter</strong> - Revenir √† la vue normale</li>
                    <li><strong>‚óÄ ‚ñ∂</strong> - Naviguer entre les onglets</li>
                    <li><strong>Nom de l'onglet</strong> - Indique o√π vous √™tes</li>
                </ul>
                
                <h3>‚å®Ô∏è Raccourcis clavier</h3>
                <ul>
                    <li><strong>F11</strong> - Activer/D√©sactiver le mode Focus</li>
                    <li><strong>√âchap</strong> - Quitter le mode Focus</li>
                    <li><strong>‚Üê Fl√®che gauche</strong> - Onglet pr√©c√©dent</li>
                    <li><strong>‚Üí Fl√®che droite</strong> - Onglet suivant</li>
                </ul>
                
                <h3>üí° Astuce</h3>
                <p>Le mode Focus est id√©al pour l'√©criture du sc√©nario, le storyboard ou toute t√¢che n√©cessitant de la concentration.</p>
            `
        },
        sequencier: {
            title: 'üé¨ S√©quencier / BB',
            content: `
                <p>Le s√©quencier affiche toutes vos sc√®nes sous forme de cartes. Deux vues disponibles : <strong>S√©quencier</strong> (liste) et <strong>Beat Board</strong> (canvas libre).</p>
                
                <h3>üîÑ Changer de vue</h3>
                <p>Dans la barre lat√©rale, cliquez sur <strong>üìã S√©quencier</strong> ou <strong>üéØ Beat Board</strong> pour basculer.</p>
                
                <h3>‚ûï Cr√©er une sc√®ne</h3>
                <p>Cliquez sur <strong>"+ Nouvelle sc√®ne"</strong> en bas du s√©quencier ou dans le Beat Board.</p>
                
                <h3>üé® Informations d'une sc√®ne</h3>
                <ul>
                    <li><strong>Intitul√©</strong> - INT./EXT., lieu, moment (JOUR/NUIT)</li>
                    <li><strong>R√©sum√©</strong> - Courte description de l'action</li>
                    <li><strong>Dur√©e estim√©e</strong> - En minutes</li>
                    <li><strong>Couleur</strong> - Pour organiser visuellement par groupe</li>
                </ul>
                
                <h3>üìù Brouillon / ‚úÖ Finale</h3>
                <p>Chaque carte affiche un badge indiquant le statut de la sc√®ne :</p>
                <ul>
                    <li><strong>üìù Brouillon</strong> - Sc√®ne en cours d'√©criture (bordure orange)</li>
                    <li><strong>‚úÖ Finale</strong> - Sc√®ne finalis√©e, pr√™te pour le d√©pouillement (bordure verte)</li>
                </ul>
                
                <h3>üéØ Beat Board</h3>
                <p>Le Beat Board est un canvas infini pour visualiser et r√©organiser vos sc√®nes :</p>
                <ul>
                    <li><strong>Fil rouge</strong> - Connecte les sc√®nes dans l'ordre du s√©quencier</li>
                    <li><strong>Drag normal</strong> - D√©place visuellement la fiche</li>
                    <li><strong>Shift + Drag</strong> - Mode snap : ins√®re dans le fil rouge</li>
                    <li><strong>Ctrl + Clic</strong> - S√©lection multiple</li>
                    <li><strong>Molette</strong> - Zoom avant/arri√®re</li>
                    <li><strong>Clic droit + glisser</strong> - Pan (d√©placer la vue)</li>
                </ul>
                
                <h3>üìå Sc√®nes hors timeline</h3>
                <p>Les sc√®nes cr√©√©es dans le Beat Board sont "hors timeline" (pointill√©s). Pour les int√©grer au fil rouge, faites <strong>Shift + Drag</strong> vers une zone d'insertion.</p>
                
                <h3>üìä Statistiques</h3>
                <p>En haut du s√©quencier, vous voyez : nombre de sc√®nes, dur√©e totale, nombre de pages.</p>
            `
        },
        breakdown: {
            title: 'üìã D√©pouillement',
            content: `
                <p>Le d√©pouillement permet d'extraire tous les besoins techniques de chaque sc√®ne.</p>
                
                <h3>‚úÖ Sc√®nes finalis√©es uniquement</h3>
                <p><strong>Important :</strong> Le d√©pouillement n'est accessible que pour les sc√®nes marqu√©es comme <strong>‚úÖ Finale</strong>. Les sc√®nes en <strong>üìù Brouillon</strong> affichent un message de blocage. Finalisez d'abord la sc√®ne dans le Sc√©nario ou le S√©quencier.</p>
                
                <h3>üìÇ Cat√©gories</h3>
                <p>Les √©l√©ments sont organis√©s par cat√©gorie :</p>
                <ul>
                    <li>üë• Personnages</li>
                    <li>üè† D√©cors-Lieux</li>
                    <li>üëî Costumes</li>
                    <li>üé≠ Maquillage</li>
                    <li>üöó V√©hicules</li>
                    <li>üîß Accessoires</li>
                    <li>üêï Animaux</li>
                    <li>‚ú® Effets sp√©ciaux</li>
                    <li>Et plus...</li>
                </ul>
                
                <h3>‚ûï Ajouter un √©l√©ment</h3>
                <p>S√©lectionnez du texte dans le script √† gauche, puis faites un <strong>clic-droit</strong> pour choisir la cat√©gorie. L'√©l√©ment sera ajout√© et surlign√©.</p>
                
                <h3>üîó Liaison visuelle</h3>
                <p>Survolez un mot surlign√© dans le texte ou un tag dans le d√©pouillement : les deux s'illuminent en jaune et une <strong>fl√®che SVG</strong> les relie visuellement.</p>
                
                <h3>üì¶ Cr√©ation automatique de ressources</h3>
                <p>Les √©l√©ments ajout√©s en <strong>ACCESSOIRES</strong>, <strong>COSTUMES</strong> ou <strong>V√âHICULES</strong> cr√©ent automatiquement une fiche dans l'onglet <strong>Ressources</strong>.</p>
            `
        },
        moodboard: {
            title: 'üé® Mood Board',
            content: `
                <p>Le Mood Board permet de cr√©er des planches d'ambiance visuelles pour votre projet.</p>
                
                <h3>üñºÔ∏è Ajouter des images</h3>
                <p>Cliquez sur <strong>"+ Image"</strong> pour ajouter des photos d'inspiration. Les images sont redimensionnables et d√©pla√ßables.</p>
                
                <h3>üé® Roue Chromatique</h3>
                <p>G√©n√©rez des palettes de couleurs harmonieuses :</p>
                <ul>
                    <li><strong>8 types d'harmonies</strong> - Compl√©mentaire, Triade, Carr√©, Analogique...</li>
                    <li><strong>Contr√¥le de saturation</strong> - Glissez vers le centre ou l'ext√©rieur</li>
                    <li><strong>5 couleurs g√©n√©r√©es</strong> - Codes hex copiables au clic</li>
                </ul>
                
                <h3>üìê Formes g√©om√©triques</h3>
                <p>Biblioth√®que de <strong>30+ formes</strong> : rectangles, cercles, triangles, √©toiles, fl√®ches, bulles de dialogue, symboles...</p>
                
                <h3>‚úèÔ∏è Texte</h3>
                <p>Ajoutez du texte avec choix de police, taille et couleur.</p>
                
                <h3>üì§ Export</h3>
                <p>Exportez votre planche en <strong>PNG</strong> ou <strong>PDF</strong> haute qualit√©.</p>
            `
        },
        synopsis: {
            title: 'üìù Synopsis',
            content: `
                <p>R√©digez le synopsis de votre film avec un √©diteur structur√©.</p>
                
                <h3>üìÑ Structure</h3>
                <p>Utilisez les boutons de formatage pour structurer votre texte :</p>
                <ul>
                    <li><strong>T1, T2, T3</strong> - Titres de diff√©rents niveaux</li>
                    <li><strong>Texte</strong> - Paragraphes normaux</li>
                </ul>
                
                <h3>üíæ Sauvegarde automatique</h3>
                <p>Votre synopsis est sauvegard√© automatiquement √† chaque modification.</p>
            `
        },
        titlepage: {
            title: 'üéûÔ∏è Page de Titre',
            content: `
                <p>Configurez la page de titre de votre sc√©nario.</p>
                
                <h3>üìã Informations</h3>
                <ul>
                    <li><strong>Titre</strong> - Le titre de votre film</li>
                    <li><strong>Auteur(s)</strong> - Sc√©naristes</li>
                    <li><strong>Contact</strong> - Email, t√©l√©phone, adresse</li>
                    <li><strong>Copyright</strong> - Ann√©e et mention l√©gale</li>
                    <li><strong>Version</strong> - Num√©ro de version du sc√©nario</li>
                </ul>
                
                <h3>üñ®Ô∏è Export</h3>
                <p>La page de titre appara√Æt automatiquement lors de l'export PDF du sc√©nario.</p>
            `
        },
        chat: {
            title: 'üí¨ Chat',
            content: `
                <p>Communiquez avec votre √©quipe en temps r√©el.</p>
                
                <h3>üí¨ Messages</h3>
                <p>Envoyez des messages texte √† tous les collaborateurs du projet.</p>
                
                <h3>üë• Participants</h3>
                <p>Tous les membres ayant acc√®s au projet peuvent participer au chat.</p>
                
                <h3>üîî Notifications</h3>
                <p>Recevez des notifications pour les nouveaux messages.</p>
            `
        },
        scriptreport: {
            title: 'üìù Rapport de Script',
            content: `
                <p>Cr√©ez des fiches de script professionnelles pour chaque plan tourn√©.</p>
                
                <h3>üìã Fiche par plan</h3>
                <p>Chaque fiche contient :</p>
                <ul>
                    <li><strong>Infos auto-remplies</strong> - Film, d√©cor, date, effet (jour/nuit)</li>
                    <li><strong>Cam√©ra</strong> - Type, objectif (depuis l'√©quipe/storyboard)</li>
                    <li><strong>Dialogues</strong> - Extraits automatiquement du sc√©nario</li>
                </ul>
                
                <h3>üé¨ Gestion des prises</h3>
                <ul>
                    <li><strong>N¬∞ de prise, Son, Image</strong></li>
                    <li><strong>Notation 1-5 √©toiles</strong> - Qualit√© Son/Image/Acting</li>
                    <li><strong>‚òÖ √âtoile Or / ‚òÜ Argent</strong> - Marquer les meilleures prises</li>
                    <li><strong>Notes libres</strong> par prise</li>
                </ul>
                
                <h3>üì§ Export PDF</h3>
                <p>Exportez les fiches individuellement ou toutes en un seul PDF.</p>
            `
        },
        storyboard: {
            title: 'üé® Storyboard',
            content: `
                <p>Le storyboard permet de visualiser chaque plan de votre film.</p>
                
                <h3>üì∑ Cr√©er un plan</h3>
                <p>Dans l'onglet Storyboard, cliquez sur <strong>"+ Nouveau plan"</strong>.</p>
                
                <h3>üñºÔ∏è Informations d'un plan</h3>
                <ul>
                    <li><strong>Type de plan</strong> - GP, PM, PL, etc.</li>
                    <li><strong>Mouvement cam√©ra</strong> - Travelling, panoramique, etc.</li>
                    <li><strong>Mode cam√©ra</strong> - √âpaule, steadicam, drone, etc.</li>
                    <li><strong>Description</strong> - Ce qu'on voit dans le plan</li>
                    <li><strong>Dialogue</strong> - Ce qu'on entend</li>
                </ul>
                
                <h3>‚úèÔ∏è Dessiner</h3>
                <p>Cliquez sur le cadre pour ouvrir l'√©diteur de dessin et cr√©er votre croquis.</p>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Utilisez le bouton üé• Mode pr√©sentation pour visualiser votre storyboard en plein √©cran.
                </div>
            `
        },
        resources: {
            title: 'üì¶ Ressources',
            content: `
                <p>L'onglet Ressources centralise tous les accessoires, costumes et v√©hicules de votre production.</p>
                
                <h3>üìÇ Cat√©gories</h3>
                <ul>
                    <li><strong>üîß Accessoires</strong> - Objets manipul√©s par les com√©diens (t√©l√©phone, arme, sac...)</li>
                    <li><strong>üëî Costumes</strong> - V√™tements et tenues des personnages</li>
                    <li><strong>üöó V√©hicules</strong> - Voitures, motos, v√©los n√©cessaires au tournage</li>
                </ul>
                
                <h3>üîÑ Cr√©ation automatique</h3>
                <p>Lorsque vous ajoutez un √©l√©ment dans le <strong>d√©pouillement</strong> (cat√©gorie ACCESSOIRES, COSTUMES ou V√âHICULES), une fiche est automatiquement cr√©√©e dans Ressources.</p>
                
                <h3>‚úèÔ∏è Enrichir une fiche</h3>
                <p>Cliquez sur <strong>‚úèÔ∏è Modifier</strong> pour compl√©ter la fiche :</p>
                <ul>
                    <li><strong>Photo</strong> - Image de r√©f√©rence</li>
                    <li><strong>Description</strong> - D√©tails et sp√©cifications</li>
                    <li><strong>Propri√©taire</strong> - Com√©dien, technicien ou location externe</li>
                    <li><strong>Note</strong> - Informations suppl√©mentaires</li>
                </ul>
                
                <h3>üîÄ Fusionner des fiches</h3>
                <p>Si vous avez des doublons (ex: "robe" et "Robe rouge"), utilisez le bouton <strong>üîÄ Fusionner</strong> pour les combiner. Le syst√®me garde la fiche la plus compl√®te et renomme automatiquement les occurrences dans le d√©pouillement.</p>
                
                <h3>üóëÔ∏è Suppression li√©e</h3>
                <p>Supprimer une ressource propose de la retirer aussi du d√©pouillement de toutes les sc√®nes. Inversement, supprimer la derni√®re occurrence dans le d√©pouillement propose de supprimer la fiche.</p>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Utilisez les filtres en haut pour afficher uniquement les Accessoires, Costumes ou V√©hicules.
                </div>
            `
        },
        planning: {
            title: 'üìÖ Planning',
            content: `
                <p>Le planning vous permet d'organiser votre calendrier de tournage.</p>
                
                <h3>üìÜ Vues disponibles</h3>
                <ul>
                    <li><strong>Mois</strong> - Vue mensuelle classique</li>
                    <li><strong>Semaine</strong> - Vue d√©taill√©e par semaine avec horaires</li>
                    <li><strong>Liste</strong> - Liste de tous les jours de tournage</li>
                </ul>
                
                <h3>‚ûï Cr√©er un jour de tournage</h3>
                <ol>
                    <li>Cliquez sur une date dans le calendrier</li>
                    <li>S√©lectionnez les sc√®nes √† tourner</li>
                    <li>D√©finissez les horaires (convocation, d√©but, fin estim√©e)</li>
                    <li>Ajoutez le lieu et les notes</li>
                </ol>
                
                <h3>üìÑ Feuille de service</h3>
                <p>Cliquez sur un jour de tournage puis sur <strong>"üìÑ Feuille de service"</strong> pour g√©n√©rer le document officiel.</p>
                
                <h3>üìß Envoi des convocations</h3>
                <p>Depuis la feuille de service, vous pouvez envoyer les convocations par email √† toute l'√©quipe.</p>
            `
        },
        equipe: {
            title: 'üë• √âquipe',
            content: `
                <p>G√©rez les com√©diens et techniciens de votre projet.</p>
                
                <h3>üé≠ Com√©diens</h3>
                <p>Ajoutez vos com√©diens avec leurs informations :</p>
                <ul>
                    <li>Photo, nom, coordonn√©es</li>
                    <li>Personnage interpr√©t√©</li>
                    <li>Mensurations (pour les costumes)</li>
                    <li>Disponibilit√©s</li>
                </ul>
                
                <h3>üé• Techniciens</h3>
                <p>Organis√©s par d√©partement :</p>
                <ul>
                    <li>üìπ Image (chef op, cadreur...)</li>
                    <li>üí° Lumi√®re (chef √©lectro, √©lectricien...)</li>
                    <li>üé§ Son (ing√© son, perchman...)</li>
                    <li>üé¨ R√©alisation (r√©al, 1er AD...)</li>
                    <li>Et tous les autres d√©partements...</li>
                </ul>
                
                <h3>üîí Profils revendiqu√©s</h3>
                <p>Certains profils sont <strong>revendiqu√©s</strong> par leur propri√©taire :</p>
                <ul>
                    <li>Badge <strong>üîí Profil revendiqu√©</strong> affich√©</li>
                    <li>Champs non modifiables (lecture seule)</li>
                    <li>Seul le propri√©taire peut modifier via "Mon Profil"</li>
                    <li>Les modifications se synchronisent automatiquement</li>
                </ul>
                
                <h3>üîó Liaison automatique des profils</h3>
                <p>Quand vous ajoutez un email √† un com√©dien ou technicien :</p>
                <ul>
                    <li>Le syst√®me v√©rifie si un profil public existe √† cette adresse</li>
                    <li>Si oui, un modal s'affiche avec la fiche (photo, nom, infos)</li>
                    <li>Confirmez "Oui, lier ce profil" pour r√©cup√©rer toutes les donn√©es</li>
                    <li>Le profil devient automatiquement üîí revendiqu√©</li>
                </ul>
                <p>Si aucun profil n'existe, vous pouvez envoyer une invitation √† la personne.</p>
                
                <h3>üè∑Ô∏è Badges sur les avatars</h3>
                <p>Les avatars en haut de l'√©cran affichent des badges :</p>
                <table class="help-table">
                    <tr><th>Badge</th><th>Signification</th></tr>
                    <tr><td>üëë</td><td>Propri√©taire du projet</td></tr>
                    <tr><td>üí∞</td><td>Responsable budget global</td></tr>
                    <tr><td>üìπ üé§ üí°...</td><td>Responsable d'un d√©partement</td></tr>
                    <tr><td>üé¨ üé≠...</td><td>R√¥le sur le projet (r√©alisateur, com√©dien...)</td></tr>
                </table>
                <p>Survolez un avatar pour voir le nom complet et tous les r√¥les de la personne.</p>
                
                <h3>‚≠ê Favoris</h3>
                <p>Cliquez sur ‚≠ê √† c√¥t√© d'un nom pour l'ajouter √† vos contacts personnels.</p>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Les personnes connect√©es apparaissent en temps r√©el dans la barre d'avatars en haut du projet.
                </div>
            `
        },
        univers: {
            title: 'üåç Univers',
            content: `
                <p>L'Univers est le r√©seau social professionnel de Moteur. Trouvez des collaborateurs !</p>
                
                <h3>üéØ Matching Intelligent</h3>
                <p>Le <strong>Matching</strong> trouve automatiquement les projets qui correspondent √† votre profil :</p>
                <ol>
                    <li>S√©lectionnez votre profil dans le menu d√©roulant</li>
                    <li>Cliquez sur <strong>"üéØ Matcher"</strong></li>
                    <li>Les projets compatibles s'affichent avec un <strong>score de compatibilit√©</strong></li>
                </ol>
                <p>L'algorithme analyse : sexe, √¢ge, localisation, type de collaboration, disponibilit√©, comp√©tences, langues, etc.</p>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Plus votre profil est complet, plus le matching est pr√©cis !
                </div>
                
                <h3>üîç Recherche par cat√©gorie</h3>
                <p>S√©lectionnez une cat√©gorie dans le menu d√©roulant pour filtrer instantan√©ment :</p>
                <ul>
                    <li>üé≠ <strong>Com√©diens</strong> - Affiche uniquement les com√©dien.nes</li>
                    <li>üé• <strong>Techniciens</strong> - Affiche uniquement les technicien.nes</li>
                    <li>üèõÔ∏è <strong>Associations</strong> - Structures associatives</li>
                    <li>üè¢ <strong>Entreprises</strong> - Loueurs, studios, soci√©t√©s de prod</li>
                    <li>üé¨ <strong>Projets</strong> - Projets en recherche de collaborateurs</li>
                </ul>
                
                <h3>üéØ Filtres avanc√©s</h3>
                <p>Affinez votre recherche avec les crit√®res d√©taill√©s, puis cliquez sur <strong>"üîç Rechercher"</strong> :</p>
                <ul>
                    <li><strong>Com√©diens :</strong> sexe, √¢ge, taille, poids, couleur des yeux/cheveux, corpulence, sports, langues...</li>
                    <li><strong>Techniciens :</strong> d√©partement, fonction</li>
                    <li><strong>Commun :</strong> ville, v√©hicule, type de collaboration, statut professionnel</li>
                    <li><strong>Projets :</strong> type, genre, besoins en com√©diens/techniciens</li>
                </ul>
                
                <h3>üó∫Ô∏è Vue Carte / üìá Vue Liste</h3>
                <p>Basculez entre les deux vues avec les boutons en haut. Vos filtres sont conserv√©s.</p>
                
                <h3>‚≠ê Ajouter aux favoris</h3>
                <p>Cliquez sur ‚òÜ dans un profil pour l'ajouter √† vos contacts.</p>
                
                <h3>üìß Contacter</h3>
                <p>Cliquez sur "Contacter" pour envoyer un message directement √† un profil.</p>
            `
        },
        contacts: {
            title: 'üìá Contacts',
            content: `
                <p>Vos contacts personnels, ind√©pendants de vos projets.</p>
                
                <h3>‚≠ê Mes Favoris</h3>
                <p>Les profils que vous avez ajout√©s en favoris depuis l'Univers ou l'Annuaire. Organis√©s par type :</p>
                <ul>
                    <li>üé≠ Com√©dien.nes</li>
                    <li>üé• Technicien.nes</li>
                    <li>üé¨ Projets</li>
                    <li>üèõÔ∏è Associations</li>
                    <li>üè¢ Entreprises</li>
                </ul>
                
                <h3>üåê Annuaire</h3>
                <p>Recherchez dans tous les profils publics avec des filtres avanc√©s.</p>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Vos favoris sont synchronis√©s et disponibles sur tous vos appareils.
                </div>
            `
        },
        profil: {
            title: 'üë§ Mon Profil',
            content: `
                <p>G√©rez vos profils publics visibles dans l'Univers par les autres utilisateurs.</p>
                
                <h3>üìã Profils multiples</h3>
                <p>Vous pouvez cr√©er <strong>plusieurs profils</strong> selon vos comp√©tences :</p>
                <ul>
                    <li><strong>üé≠ Com√©dien.ne</strong> - Avec mensurations, photos, d√©mo</li>
                    <li><strong>üé• Technicien.ne</strong> - Avec d√©partement, mat√©riel</li>
                    <li><strong>üèõÔ∏è Association</strong> - Structure associative</li>
                    <li><strong>üè¢ Entreprise</strong> - Soci√©t√© de production, loueur, etc.</li>
                </ul>
                <p>Cliquez sur <strong>"+ Nouveau profil"</strong> pour en ajouter un.</p>
                
                <h3>üé¨ Utilisation dans les projets</h3>
                <p>Quand vous cr√©ez un projet, vous pouvez choisir quel(s) profil(s) utiliser :</p>
                <ul>
                    <li>Les profils s√©lectionn√©s sont ajout√©s automatiquement √† l'√©quipe</li>
                    <li>Ils sont marqu√©s <strong>üîí revendiqu√©s</strong> (non modifiables par les autres)</li>
                    <li>Vos infos sont synchronis√©es depuis "Mon Profil"</li>
                </ul>
                
                <h3>üëÅÔ∏è Visibilit√©</h3>
                <p>Chaque section peut √™tre :</p>
                <ul>
                    <li>üåç <strong>Publique</strong> - Visible par tous dans l'Univers</li>
                    <li>üé¨ <strong>Projet</strong> - Visible uniquement par vos collaborateurs</li>
                    <li>üîí <strong>Priv√©e</strong> - Visible par vous seul</li>
                </ul>
                
                <h3>‚úÖ Profil complet</h3>
                <p>Remplissez toutes les sections obligatoires pour appara√Ætre dans l'Univers.</p>
                
                <h3>üé¨ Badges de projets</h3>
                <p>Sous chaque profil, vous voyez les projets auxquels il est li√© :</p>
                <ul>
                    <li>Badges üé¨ cliquables pour ouvrir directement le projet</li>
                    <li>Visualisez rapidement o√π vos profils sont utilis√©s</li>
                </ul>
                
                <h3>üì§ Profil avec autre adresse email</h3>
                <p>Si quelqu'un vous ajoute √† un projet avec une adresse email diff√©rente :</p>
                <ol>
                    <li>Vous recevez un message "Un profil a √©t√© cr√©√© √† votre nom"</li>
                    <li>Cliquez sur <strong>"üì§ J'ai d√©j√† un profil (autre email)"</strong></li>
                    <li>S√©lectionnez votre profil existant</li>
                    <li>Le porteur de projet re√ßoit votre proposition et peut l'accepter</li>
                </ol>
                <p>Cela √©vite les doublons de profils !</p>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Exemple : Cr√©ez un profil "R√©alisateur" et un profil "Com√©dien". √Ä chaque nouveau projet, choisissez les r√¥les que vous occuperez !
                </div>
            `
        },
        collaboration: {
            title: 'ü§ù Collaboration',
            content: `
                <p>Travaillez √† plusieurs sur vos projets en temps r√©el.</p>
                
                <h3>üë• Partager un projet</h3>
                <ol>
                    <li>Ouvrez votre projet</li>
                    <li>Cliquez sur <strong>üë• Collaboration ‚Üí Partager</strong></li>
                    <li>Entrez l'email du collaborateur</li>
                    <li>Choisissez son r√¥le (Admin, √âditeur, Lecteur)</li>
                </ol>
                
                <h3>üîê Niveaux d'acc√®s</h3>
                <table class="help-table">
                    <tr><th>R√¥le</th><th>Droits</th></tr>
                    <tr><td>üëë Propri√©taire</td><td>Tout (cr√©ation, suppression, partage)</td></tr>
                    <tr><td>‚öôÔ∏è Admin</td><td>Modification + gestion des acc√®s</td></tr>
                    <tr><td>‚úèÔ∏è √âditeur</td><td>Modification du contenu</td></tr>
                    <tr><td>üëÅÔ∏è Lecteur</td><td>Consultation uniquement</td></tr>
                </table>
                
                <h3>üîî Notifications</h3>
                <p>Cliquez sur la cloche üîî dans le header pour voir vos notifications :</p>
                <ul>
                    <li>Nouvelles d√©penses √† valider</li>
                    <li>D√©penses valid√©es ou renvoy√©es</li>
                    <li>Messages re√ßus</li>
                    <li>Invitations √† des projets</li>
                </ul>
                <p>Le badge rouge indique le nombre de notifications non lues.</p>
                
                <h3>üë§ Pr√©sence en temps r√©el</h3>
                <p>Les avatars en haut du projet montrent qui est connect√© :</p>
                <ul>
                    <li>Survolez un avatar pour voir le nom et les r√¥les</li>
                    <li>Les badges indiquent les responsabilit√©s (üëë üí∞ üìπ...)</li>
                    <li>L'avatar s'agrandit au survol</li>
                </ul>
                
                <h3>üí¨ Chat</h3>
                <p>Utilisez le chat int√©gr√© pour communiquer avec votre √©quipe en temps r√©el.</p>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Les responsables de d√©partement peuvent activer les notifications email dans les param√®tres ‚öôÔ∏è de leur d√©partement.
                </div>
            `
        },
        export: {
            title: 'üìÑ Exports',
            content: `
                <p>Exportez vos documents dans diff√©rents formats.</p>
                
                <h3>üé¨ Export Sc√©nario Pro</h3>
                <p>Depuis l'onglet Sc√©nario, cliquez sur <strong>"üì§ Exporter"</strong> pour acc√©der aux formats :</p>
                <table class="help-table">
                    <tr><th>Format</th><th>Compatibilit√©</th></tr>
                    <tr><td>üìú Fountain (.fountain)</td><td>Highland, Slugline, WriterDuet, Fade In, Final Draft (import)</td></tr>
                    <tr><td>üé¨ Final Draft (.fdx)</td><td>Final Draft 8, 9, 10, 11, 12</td></tr>
                    <tr><td>üñ®Ô∏è PDF</td><td>Universel (via impression)</td></tr>
                </table>
                
                <h3>üìù Page de titre</h3>
                <p>Avant d'exporter, configurez votre page de titre via <strong>"üìù Page de titre"</strong> :</p>
                <ul>
                    <li>Auteur et co-auteur</li>
                    <li>Contact (email, t√©l√©phone)</li>
                    <li>Version / Draft avec date</li>
                    <li>Source ("Bas√© sur...")</li>
                    <li>Copyright</li>
                </ul>
                
                <h3>üìÑ Autres documents</h3>
                <ul>
                    <li><strong>S√©quencier</strong> - Liste des sc√®nes</li>
                    <li><strong>D√©pouillement</strong> - Tableau des besoins</li>
                    <li><strong>Storyboard</strong> - Planche de tous les plans</li>
                    <li><strong>Feuille de service</strong> - Document de tournage</li>
                    <li><strong>Feuille de pr√©sence</strong> - Pour les signatures</li>
                </ul>
                
                <h3>üìù Contrats</h3>
                <p>G√©n√©rez automatiquement des <strong>contrats conformes au droit fran√ßais</strong> via le menu <strong>üì§ Export ‚Üí üìù Contrats</strong> :</p>
                
                <h4>üì∏ Autorisation Droit √† l'image</h4>
                <ul>
                    <li>Conforme aux articles 9 du Code civil et 226-1 du Code p√©nal</li>
                    <li>Gestion des mineurs (repr√©sentant l√©gal)</li>
                    <li>Clause RGPD compl√®te</li>
                    <li>Supports d'exploitation d√©taill√©s</li>
                    <li>Dur√©e et territoire de cession</li>
                </ul>
                
                <h4>üìã CDDU (Intermittent¬∑e¬∑s du spectacle)</h4>
                <ul>
                    <li>Conforme aux articles L.1242-2 et D.1242-1 du Code du travail</li>
                    <li>Motif de recours obligatoire inclus</li>
                    <li>Mention DPAE (D√©claration Pr√©alable √† l'Embauche)</li>
                    <li>Clause abattement frais professionnels</li>
                    <li>Documents de fin de contrat list√©s</li>
                    <li>R√©f√©rence AUDIENS et Cong√©s Spectacles</li>
                </ul>
                
                <h4>üìÑ Contrat de Prestation (Auto-entrepreneur¬∑e¬∑s)</h4>
                <ul>
                    <li>Clause propri√©t√© intellectuelle</li>
                    <li>Clause confidentialit√© (2 ans)</li>
                    <li>Conditions de r√©siliation</li>
                    <li>Avertissement sur la requalification en contrat de travail</li>
                </ul>
                
                <div class="help-tip">
                    <strong>‚ö†Ô∏è Important :</strong> Ces mod√®les sont fournis √† titre indicatif. Pour des situations complexes, consultez un avocat sp√©cialis√© en droit du travail ou de la propri√©t√© intellectuelle.
                </div>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Renseignez le statut professionnel (intermittent, auto-entrepreneur) dans les fiches √âquipe pour que Moteur propose automatiquement le bon type de contrat !
                </div>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Le format Fountain est un simple fichier texte. Vous pouvez l'ouvrir avec n'importe quel √©diteur de texte !
                </div>
            `
        },
        depenses: {
            title: 'üí∞ D√©penses & Budget',
            content: `
                <p>G√©rez le budget de votre production avec un syst√®me de validation hi√©rarchique.</p>
                
                <h3>üìä Organisation</h3>
                <p>Les d√©penses sont organis√©es par d√©partement :</p>
                <ul>
                    <li>üìπ Image, üí° Lumi√®re, üé§ Son</li>
                    <li>üé¨ R√©alisation, üé® D√©coration, üëó Costumes</li>
                    <li>üíÑ Maquillage, üé≠ R√©gie, üíº Production</li>
                    <li>üöó Transport, üç¥ Catering, üéûÔ∏è Post-prod</li>
                    <li>üè† Locations, üìã Assurance, üì¶ Divers</li>
                </ul>
                
                <h3>üë• Responsables</h3>
                <p>Deux niveaux de responsabilit√© :</p>
                <table class="help-table">
                    <tr><th>R√¥le</th><th>Permissions</th></tr>
                    <tr><td>üí∞ Resp. Budget Global</td><td>Valide toutes les d√©penses, g√®re les responsables</td></tr>
                    <tr><td>üìã Resp. D√©partement</td><td>Valide les d√©penses de son d√©partement ou les remonte</td></tr>
                </table>
                
                <h3>üîÑ Workflow de validation</h3>
                <ol>
                    <li><strong>Cr√©ation</strong> - Toute personne peut cr√©er une d√©pense</li>
                    <li><strong>En attente</strong> - La d√©pense attend validation</li>
                    <li><strong>Actions possibles :</strong>
                        <ul>
                            <li>‚úÖ <strong>Valider</strong> - Approuver la d√©pense</li>
                            <li>‚¨ÜÔ∏è <strong>Remonter</strong> - Transf√©rer au responsable global</li>
                            <li>‚Ü©Ô∏è <strong>Renvoyer</strong> - Demander des modifications</li>
                        </ul>
                    </li>
                </ol>
                
                <h3>‚öôÔ∏è Param√®tres d√©partement</h3>
                <p>Cliquez sur ‚öôÔ∏è √† c√¥t√© d'un d√©partement pour :</p>
                <ul>
                    <li>Assigner un responsable d√©partement</li>
                    <li>D√©finir le budget allou√©</li>
                    <li>Activer/d√©sactiver les notifications email</li>
                </ul>
                
                <h3>üîî Notifications</h3>
                <p>Les responsables re√ßoivent des notifications :</p>
                <ul>
                    <li>Nouvelle d√©pense dans leur d√©partement</li>
                    <li>D√©pense remont√©e (pour le responsable global)</li>
                    <li>D√©pense valid√©e ou renvoy√©e (pour le cr√©ateur)</li>
                </ul>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Les d√©penses "Divers" sont automatiquement remont√©es au responsable budget global.
                </div>
            `
        },
        raccourcis: {
            title: '‚å®Ô∏è Raccourcis clavier',
            content: `
                <div class="help-tip"><strong>üí° Mac :</strong> Remplacez <span class="help-shortcut">Ctrl</span> par <span class="help-shortcut">‚åò Cmd</span></div>
                
                <h3>üìù √âditeur de sc√©nario</h3>
                <table class="help-table">
                    <tr><th>Raccourci</th><th>Action</th></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">1</span></td><td>Action</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">2</span></td><td>Personnage</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">3</span></td><td>Dialogue</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">4</span></td><td>Didascalie (parenth√®ses)</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">5</span></td><td>Transition</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">6</span></td><td>Centr√©</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl/Alt</span>+<span class="help-shortcut">7</span></td><td>Note {accolades}</td></tr>
                    <tr><td><span class="help-shortcut">Tab</span></td><td>Type suivant intelligent (contextuel)</td></tr>
                    <tr><td><span class="help-shortcut">Shift</span>+<span class="help-shortcut">Tab</span></td><td>Type pr√©c√©dent</td></tr>
                    <tr><td><span class="help-shortcut">Entr√©e</span></td><td>Nouveau bloc / Valider</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl</span> + <span class="help-shortcut">‚Üê</span></td><td>Aller √† la sc√®ne pr√©c√©dente</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl</span> + <span class="help-shortcut">‚Üí</span></td><td>Aller √† la sc√®ne suivante</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl</span> + <span class="help-shortcut">Entr√©e</span></td><td>Ins√©rer une nouvelle sc√®ne apr√®s</td></tr>
                    <tr><td><span class="help-shortcut">√âchap</span></td><td>Fermer les menus / modales</td></tr>
                </table>
                
                <h3>üé® √âditeur de dessin (Storyboard)</h3>
                <table class="help-table">
                    <tr><th>Raccourci</th><th>Action</th></tr>
                    <tr><td><span class="help-shortcut">Ctrl</span> + <span class="help-shortcut">Z</span></td><td>Annuler</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl</span> + <span class="help-shortcut">Y</span></td><td>Refaire</td></tr>
                    <tr><td><span class="help-shortcut">Suppr</span></td><td>Effacer la s√©lection</td></tr>
                </table>
                
                <h3>üîÄ Navigation</h3>
                <table class="help-table">
                    <tr><th>Raccourci</th><th>Action</th></tr>
                    <tr><td><span class="help-shortcut">Ctrl</span> + <span class="help-shortcut">F</span></td><td>Recherche globale</td></tr>
                    <tr><td><span class="help-shortcut">Ctrl</span> + <span class="help-shortcut">S</span></td><td>Sauvegarder</td></tr>
                    <tr><td><span class="help-shortcut">?</span></td><td>Afficher les raccourcis clavier</td></tr>
                </table>
                
                <h3>üñ±Ô∏è Clic droit</h3>
                <table class="help-table">
                    <tr><th>√âl√©ment</th><th>Action</th></tr>
                    <tr><td>Onglet / Cat√©gorie</td><td>Changer la couleur ou acc√©der √† l'aide</td></tr>
                    <tr><td>Carte du s√©quencier</td><td>G√©rer les tags et couleurs</td></tr>
                </table>
                
                <h3>üî≤ Mode Compact (V1.8.7)</h3>
                <p>Dans les onglets Personnages, Com√©diens, D√©cors et √âquipes :</p>
                <ul>
                    <li>Cliquez sur <strong>üî≤ Compact</strong> pour afficher des cartes miniatures</li>
                    <li>Cliquez sur une carte pour ouvrir la fiche compl√®te en modal</li>
                    <li>Utilisez <strong>√ó</strong> pour masquer des onglets</li>
                    <li>Cliquez sur <strong>‚äï Masqu√©s</strong> pour les restaurer</li>
                </ul>
            `
        },
        interface: {
            title: 'üìê Interface & Affichage',
            content: `
                <p>Personnalisez l'affichage de Moteur selon vos pr√©f√©rences.</p>
                
                <h3>üìê Menu d'affichage</h3>
                <p>Cliquez sur le bouton <strong>üìê</strong> dans le header pour acc√©der aux options :</p>
                
                <h4>Navigation</h4>
                <table class="help-table">
                    <tr><th>Mode</th><th>Description</th></tr>
                    <tr><td>üìã Classique</td><td>Tous les onglets sur une seule ligne, num√©rot√©s</td></tr>
                    <tr><td>üìÅ Cat√©gories</td><td>Onglets regroup√©s par th√®me (√âcriture, Casting, Production, Admin)</td></tr>
                </table>
                
                <h4>Position des onglets</h4>
                <p>En mode <strong>Classique uniquement</strong>, choisissez o√π placer la barre d'onglets :</p>
                <table class="help-table">
                    <tr><th>Position</th><th>Description</th></tr>
                    <tr><td>‚¨ÜÔ∏è Haut</td><td>Position classique, sous le header</td></tr>
                    <tr><td>‚¨áÔ∏è Bas</td><td>Barre fix√©e en bas de l'√©cran</td></tr>
                    <tr><td>‚¨ÖÔ∏è Gauche</td><td>Barre verticale √† gauche (mode d√©filant)</td></tr>
                    <tr><td>‚û°Ô∏è Droite</td><td>Barre verticale √† droite (mode d√©filant)</td></tr>
                </table>
                
                <h4>Mode d'affichage</h4>
                <p>Disponible uniquement en position <strong>Haut</strong> ou <strong>Bas</strong> :</p>
                <table class="help-table">
                    <tr><th>Mode</th><th>Description</th></tr>
                    <tr><td>‚ÜîÔ∏è D√©filant</td><td>Les onglets gardent leur taille, scroll horizontal si n√©cessaire</td></tr>
                    <tr><td>‚öñÔ∏è Adaptatif</td><td>Les onglets se compressent pour tenir sur une ligne. Survolez pour lire le nom complet.</td></tr>
                </table>
                
                <h3>üé® Th√®mes visuels</h3>
                <p>Cliquez sur <strong>üé®</strong> pour changer le design :</p>
                <ul>
                    <li><strong>Default</strong> - Interface classique</li>
                    <li><strong>Glassmorphism</strong> - Effet verre d√©poli</li>
                    <li><strong>Neumorphism</strong> - Ombres douces</li>
                    <li><strong>Cin√©ma</strong> - Ambiance sombre professionnelle</li>
                    <li><strong>Neon</strong> - Couleurs vives cyberpunk</li>
                    <li><strong>Sunset / Ocean</strong> - D√©grad√©s color√©s</li>
                    <li><strong>Minimal / Terminal</strong> - Interfaces √©pur√©es</li>
                </ul>
                
                <h3>üåì Mode sombre</h3>
                <p>Cliquez sur <strong>üåì</strong> pour basculer entre th√®me clair et sombre.</p>
                
                <h3>üé® Couleurs des onglets</h3>
                <p>Faites un <strong>clic droit</strong> sur un onglet ou une cat√©gorie pour :</p>
                <ul>
                    <li>Changer sa couleur (10 couleurs disponibles)</li>
                    <li>R√©initialiser la couleur</li>
                    <li>Acc√©der √† l'aide de cet onglet</li>
                </ul>
                
                <div class="help-tip">
                    <strong>üí° Astuce :</strong> Les positions Gauche et Droite sont id√©ales sur les grands √©crans. La colonne de navigation rapide des sc√®nes se d√©place automatiquement pour rester visible.
                </div>
            `
        }
    },
    
    open: () => {
        document.getElementById('help-modal').style.display = 'flex';
        Help.showSection('intro');
    },
    
    close: () => {
        document.getElementById('help-modal').style.display = 'none';
    },
    
    showSection: (sectionId) => {
        Help.currentSection = sectionId;
        
        // Mettre √† jour la sidebar
        document.querySelectorAll('.help-category').forEach(cat => cat.classList.remove('active'));
        const activeTab = document.querySelector(`.help-category[onclick*="${sectionId}"]`);
        if(activeTab) activeTab.classList.add('active');
        
        // Afficher le contenu
        const section = Help.sections[sectionId];
        if(section) {
            document.getElementById('help-content').innerHTML = `
                <h2>${section.title}</h2>
                ${section.content}
            `;
        }
    }
};

// ========== MODULE EXPORT SC√âNARIO ==========
const ScriptExport = {
    // Toggle menu export
    toggleExportMenu: () => {
        const menu = document.getElementById('script-export-menu');
        if(menu.style.display === 'none') {
            menu.style.display = 'block';
            // Fermer au clic ext√©rieur
            setTimeout(() => {
                document.addEventListener('click', ScriptExport.closeExportMenu, { once: true });
            }, 10);
        } else {
            menu.style.display = 'none';
        }
    },
    
    closeExportMenu: (e) => {
        const menu = document.getElementById('script-export-menu');
        if(menu && !menu.contains(e?.target)) {
            menu.style.display = 'none';
        }
    },
    
    // Modal page de titre
    openTitlePageModal: () => {
        const modal = document.getElementById('title-page-modal');
        if(!state.data.scriptMeta) {
            state.data.scriptMeta = { author: '', coAuthor: '', contact: '', copyright: '', draft: 'Premier jet', draftDate: '', source: '', notes: '' };
        }
        
        // Remplir les champs
        document.getElementById('script-meta-title').value = state.data.title || '';
        document.getElementById('script-meta-author').value = state.data.scriptMeta.author || '';
        document.getElementById('script-meta-coauthor').value = state.data.scriptMeta.coAuthor || '';
        document.getElementById('script-meta-contact').value = state.data.scriptMeta.contact || '';
        document.getElementById('script-meta-draft').value = state.data.scriptMeta.draft || 'Premier jet';
        document.getElementById('script-meta-date').value = state.data.scriptMeta.draftDate || '';
        document.getElementById('script-meta-source').value = state.data.scriptMeta.source || '';
        document.getElementById('script-meta-copyright').value = state.data.scriptMeta.copyright || '';
        document.getElementById('script-meta-notes').value = state.data.scriptMeta.notes || '';
        
        modal.style.display = 'flex';
    },
    
    closeTitlePageModal: () => {
        document.getElementById('title-page-modal').style.display = 'none';
    },
    
    saveTitlePage: () => {
        if(!state.data.scriptMeta) state.data.scriptMeta = {};
        
        state.data.title = document.getElementById('script-meta-title').value;
        state.data.scriptMeta.author = document.getElementById('script-meta-author').value;
        state.data.scriptMeta.coAuthor = document.getElementById('script-meta-coauthor').value;
        state.data.scriptMeta.contact = document.getElementById('script-meta-contact').value;
        state.data.scriptMeta.draft = document.getElementById('script-meta-draft').value;
        state.data.scriptMeta.draftDate = document.getElementById('script-meta-date').value;
        state.data.scriptMeta.source = document.getElementById('script-meta-source').value;
        state.data.scriptMeta.copyright = document.getElementById('script-meta-copyright').value;
        state.data.scriptMeta.notes = document.getElementById('script-meta-notes').value;
        
        Store.save();
        ScriptExport.closeTitlePageModal();
        Utils.toast('Page de titre enregistr√©e !', 'success');
    },
    
    // Convertit le HTML du sc√©nario en texte brut avec type de bloc
    parseScriptContent: (html) => {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const blocks = [];
        
        temp.querySelectorAll('div, p').forEach(el => {
            const text = el.innerText.trim();
            if(!text) return;
            
            let type = 'action';
            if(el.classList.contains('sc-action')) type = 'action';
            else if(el.classList.contains('sc-perso')) type = 'character';
            else if(el.classList.contains('sc-dial')) type = 'dialogue';
            else if(el.classList.contains('sc-paren')) type = 'parenthetical';
            else if(el.classList.contains('sc-trans')) type = 'transition';
            else if(el.classList.contains('sc-centered')) type = 'centered';
            else if(el.classList.contains('sc-note')) type = 'note';
            else if(el.classList.contains('sc-general')) type = 'general';
            
            blocks.push({ type, text });
        });
        
        return blocks;
    },
    
    // ========== EXPORT FOUNTAIN ==========
    toFountain: () => {
        if(!state.data.scenes || state.data.scenes.length === 0) {
            Utils.toast('Aucune sc√®ne √† exporter', 'warning');
            return;
        }
        
        let fountain = '';
        const meta = state.data.scriptMeta || {};
        
        // Page de titre (format Fountain)
        fountain += `Title: ${state.data.title || 'Sans titre'}\n`;
        if(meta.author) {
            fountain += `Author: ${meta.author}`;
            if(meta.coAuthor) fountain += ` & ${meta.coAuthor}`;
            fountain += '\n';
        }
        if(meta.draft) fountain += `Draft date: ${meta.draft}${meta.draftDate ? ' - ' + meta.draftDate : ''}\n`;
        if(meta.contact) fountain += `Contact: ${meta.contact}\n`;
        if(meta.copyright) fountain += `Copyright: ${meta.copyright}\n`;
        if(meta.source) fountain += `Credit: Bas√© sur ${meta.source}\n`;
        if(meta.notes) fountain += `Notes: ${meta.notes}\n`;
        fountain += '\n';
        
        // Sc√®nes
        state.data.scenes.forEach((scene, idx) => {
            // Scene heading (forcer avec .)
            const heading = scene.title.toUpperCase();
            if(heading.match(/^(INT|EXT|I\/E|INT\.\/EXT)/)) {
                fountain += `\n${heading}\n\n`;
            } else {
                fountain += `\n.${heading}\n\n`;
            }
            
            // Contenu de la sc√®ne
            const blocks = ScriptExport.parseScriptContent(scene.scriptContent || '');
            
            blocks.forEach(block => {
                switch(block.type) {
                    case 'action':
                        fountain += `${block.text}\n\n`;
                        break;
                    case 'character':
                        fountain += `${block.text.toUpperCase()}\n`;
                        break;
                    case 'dialogue':
                        fountain += `${block.text}\n\n`;
                        break;
                    case 'parenthetical':
                        const paren = block.text.startsWith('(') ? block.text : `(${block.text})`;
                        fountain += `${paren}\n`;
                        break;
                    case 'transition':
                        fountain += `> ${block.text.toUpperCase()}\n\n`;
                        break;
                    case 'centered':
                        fountain += `> ${block.text} <\n\n`;
                        break;
                    case 'note':
                        fountain += `[[${block.text}]]\n\n`;
                        break;
                    case 'general':
                        fountain += `/* ${block.text} */\n\n`;
                        break;
                }
            });
        });
        
        // T√©l√©charger le fichier
        const filename = (state.data.title || 'scenario').replace(/[^a-z0-9]/gi, '_') + '.fountain';
        ScriptExport.downloadFile(fountain, filename, 'text/plain');
        Utils.toast('Export Fountain r√©ussi !', 'success');
    },
    
    // ========== EXPORT FDX (Final Draft) ==========
    toFDX: () => {
        if(!state.data.scenes || state.data.scenes.length === 0) {
            Utils.toast('Aucune sc√®ne √† exporter', 'warning');
            return;
        }
        
        const meta = state.data.scriptMeta || {};
        
        // Construire le XML FDX
        let fdx = `<?xml version="1.0" encoding="UTF-8"?>
<FinalDraft DocumentType="Script" Template="No" Version="5">
  <Content>
    <TitlePage>
      <Content>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text>${ScriptExport.escapeXml(state.data.title || 'Sans titre')}</Text>
        </Paragraph>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text></Text>
        </Paragraph>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text>√©crit par</Text>
        </Paragraph>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text>${ScriptExport.escapeXml(meta.author || '')}${meta.coAuthor ? ' & ' + ScriptExport.escapeXml(meta.coAuthor) : ''}</Text>
        </Paragraph>`;
        
        if(meta.source) {
            fdx += `
        <Paragraph Alignment="Center" Type="Title Page">
          <Text></Text>
        </Paragraph>
        <Paragraph Alignment="Center" Type="Title Page">
          <Text>Bas√© sur ${ScriptExport.escapeXml(meta.source)}</Text>
        </Paragraph>`;
        }
        
        fdx += `
        <Paragraph Alignment="Left" Type="Title Page">
          <Text></Text>
        </Paragraph>
        <Paragraph Alignment="Left" Type="Title Page">
          <Text>${ScriptExport.escapeXml(meta.draft || '')}${meta.draftDate ? ' - ' + meta.draftDate : ''}</Text>
        </Paragraph>
        <Paragraph Alignment="Left" Type="Title Page">
          <Text>${ScriptExport.escapeXml(meta.contact || '')}</Text>
        </Paragraph>`;
        
        if(meta.copyright) {
            fdx += `
        <Paragraph Alignment="Left" Type="Title Page">
          <Text>${ScriptExport.escapeXml(meta.copyright)}</Text>
        </Paragraph>`;
        }
        
        fdx += `
      </Content>
    </TitlePage>
`;
        
        // Sc√®nes
        state.data.scenes.forEach((scene, idx) => {
            // Scene Heading
            fdx += `    <Paragraph Type="Scene Heading" Number="${idx + 1}">
      <Text>${ScriptExport.escapeXml(scene.title.toUpperCase())}</Text>
    </Paragraph>\n`;
            
            // Contenu
            const blocks = ScriptExport.parseScriptContent(scene.scriptContent || '');
            
            blocks.forEach(block => {
                let fdxType = 'Action';
                switch(block.type) {
                    case 'action': fdxType = 'Action'; break;
                    case 'character': fdxType = 'Character'; break;
                    case 'dialogue': fdxType = 'Dialogue'; break;
                    case 'parenthetical': fdxType = 'Parenthetical'; break;
                    case 'transition': fdxType = 'Transition'; break;
                    case 'centered': fdxType = 'Action'; break; // FDX n'a pas de type centr√© natif
                    case 'note': fdxType = 'Action'; break;
                    case 'general': fdxType = 'General'; break;
                }
                
                let text = block.text;
                if(block.type === 'note') text = `[NOTE: ${text}]`;
                
                fdx += `    <Paragraph Type="${fdxType}"${block.type === 'centered' ? ' Alignment="Center"' : ''}>
      <Text>${ScriptExport.escapeXml(text)}</Text>
    </Paragraph>\n`;
            });
        });
        
        fdx += `  </Content>
</FinalDraft>`;
        
        // T√©l√©charger le fichier
        const filename = (state.data.title || 'scenario').replace(/[^a-z0-9]/gi, '_') + '.fdx';
        ScriptExport.downloadFile(fdx, filename, 'application/xml');
        Utils.toast('Export Final Draft r√©ussi !', 'success');
    },
    
    // Utilitaires
    escapeXml: (str) => {
        if(!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&apos;');
    },
    
    downloadFile: (content, filename, mimeType) => {
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
};

// ========== MODULE RAPPORT DE SCRIPT / CONTINUIT√â ==========
const ScriptReport = {
    currentSceneId: null,
    currentShotId: null,
    currentReportIdx: 0,
    
    init: () => {
        ScriptReport.renderScenesList();
    },
    
    // Rendu de la liste des sc√®nes et plans (sidebar gauche)
    renderScenesList: () => {
        const container = document.getElementById('sr-scenes-list');
        if(!container) return;
        
        const scenes = state.data.scenes || [];
        if(scenes.length === 0) {
            container.innerHTML = '<div style="padding: 20px; color: var(--text-sec); text-align: center;">Aucune sc√®ne cr√©√©e</div>';
            return;
        }
        
        let html = '';
        scenes.forEach((scene, idx) => {
            const sceneNum = idx + 1;
            const shots = (state.data.shots || []).filter(s => s.sceneId === scene.id);
            const isActive = ScriptReport.currentSceneId === scene.id && !ScriptReport.currentShotId;
            
            html += `
                <div class="sr-scene-item ${isActive ? 'active' : ''}" onclick="app.ScriptReport.selectScene('${scene.id}')">
                    <div class="sr-scene-title">Sc.${sceneNum} - ${Utils.escape(scene.title || 'Sans titre')}</div>
                    <div style="font-size: 0.8rem; opacity: 0.7;">${shots.length} plan(s)</div>
                </div>
                <div class="sr-shot-list" id="sr-shots-${scene.id}">
                    ${shots.map((shot, shotIdx) => {
                        const hasReport = ScriptReport.hasReport(scene.id, shot.id);
                        const isActiveShot = ScriptReport.currentShotId === shot.id;
                        return `<div class="sr-shot-item ${isActiveShot ? 'active' : ''} ${hasReport ? 'has-report' : ''}" onclick="event.stopPropagation(); app.ScriptReport.selectShot('${scene.id}', '${shot.id}')">
                            Plan ${shotIdx + 1}${shot.name ? ' - ' + Utils.escape(shot.name) : ''}
                        </div>`;
                    }).join('')}
                </div>
            `;
        });
        
        container.innerHTML = html;
    },
    
    hasReport: (sceneId, shotId) => {
        if(!state.data.scriptReports) return false;
        const key = `${sceneId}_${shotId}`;
        return state.data.scriptReports[key] && state.data.scriptReports[key].length > 0;
    },
    
    selectScene: (sceneId) => {
        ScriptReport.currentSceneId = sceneId;
        ScriptReport.currentShotId = null;
        ScriptReport.renderScenesList();
        ScriptReport.showSceneOverview(sceneId);
    },
    
    selectShot: (sceneId, shotId) => {
        ScriptReport.currentSceneId = sceneId;
        ScriptReport.currentShotId = shotId;
        ScriptReport.currentReportIdx = 0;
        ScriptReport.renderScenesList();
        ScriptReport.renderSheet(sceneId, shotId);
    },
    
    showSceneOverview: (sceneId) => {
        const container = document.getElementById('sr-sheet-container');
        const scene = state.data.scenes.find(s => s.id === sceneId);
        if(!scene) return;
        
        const sceneIdx = state.data.scenes.indexOf(scene) + 1;
        const shots = (state.data.shots || []).filter(s => s.sceneId === sceneId);
        
        container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <h2 style="margin-bottom: 10px;">Sc√®ne ${sceneIdx} - ${Utils.escape(scene.title || 'Sans titre')}</h2>
                <p style="color: var(--text-sec); margin-bottom: 20px;">${Utils.escape(scene.perso || 'Personnages non d√©finis')}</p>
                <p style="margin-bottom: 30px;">${shots.length} plan(s) dans cette sc√®ne</p>
                ${shots.length > 0 ? '<p style="color: var(--text-sec);">Cliquez sur un plan dans la liste pour remplir sa fiche.</p>' : '<p style="color: var(--warning);">Ajoutez des plans dans le Storyboard pour cr√©er des fiches de script.</p>'}
            </div>
        `;
    },
    
    // R√©cup√©rer les infos auto-remplies
    getAutoFillData: (sceneId, shotId) => {
        const scene = state.data.scenes.find(s => s.id === sceneId);
        const shot = (state.data.shots || []).find(s => s.id === shotId);
        const sceneIdx = state.data.scenes.indexOf(scene) + 1;
        const shots = (state.data.shots || []).filter(s => s.sceneId === sceneId);
        const shotIdx = shots.indexOf(shot) + 1;
        
        // Trouver le jour de tournage li√© √† cette sc√®ne
        let shootDay = null;
        (state.data.shootingDays || []).forEach(day => {
            if((day.scenes || []).some(s => s.sceneId === sceneId)) {
                shootDay = day;
            }
        });
        
        // Chercher le cadreur (groupe cam√©ra gc3 ou chercher "cadreur" dans le r√¥le)
        let cadreur = '';
        const crew = state.data.crew || [];
        const cadreurMember = crew.find(c => c.group_id === 'gc3' || (c.role || '').toLowerCase().includes('cadreur') || (c.role || '').toLowerCase().includes('camera'));
        if(cadreurMember) cadreur = cadreurMember.name;
        
        // Parser le titre de la sc√®ne pour INT/EXT et JOUR/NUIT
        const title = scene?.title || '';
        const isInt = /\bINT\b/i.test(title);
        const isExt = /\bEXT\b/i.test(title);
        const isJour = /\bJOUR\b/i.test(title);
        const isNuit = /\bNUIT\b/i.test(title);
        
        // R√©cup√©rer les dialogues depuis le contenu de la sc√®ne (personnages + dialogues + didascalies)
        // Le contenu est dans scriptContent sous forme HTML avec classes sc-perso, sc-dial, sc-paren
        let dialogues = '';
        if(scene?.scriptContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = scene.scriptContent;
            const dialogueLines = [];
            
            // Parcourir tous les √©l√©ments du script
            tempDiv.querySelectorAll('.sc-perso, .sc-dial, .sc-paren').forEach(el => {
                const text = el.textContent.trim();
                if(!text) return;
                
                if(el.classList.contains('sc-perso')) {
                    // Nom du personnage
                    dialogueLines.push('');
                    dialogueLines.push(text.toUpperCase());
                } else if(el.classList.contains('sc-paren')) {
                    // Didascalie
                    dialogueLines.push('  (' + text.replace(/^\(|\)$/g, '') + ')');
                } else if(el.classList.contains('sc-dial')) {
                    // Dialogue
                    dialogueLines.push('  ' + text);
                }
            });
            
            dialogues = dialogueLines.join('\n').trim();
        }
        
        // D√©terminer effet jour/nuit et int/ext
        const effet = isJour ? 'jour' : (isNuit ? 'nuit' : '');
        const lieu = isInt ? 'int' : (isExt ? 'ext' : '');
        
        return {
            film: state.data.title || '',
            decor: scene?.location || title.split('-')[0]?.replace(/INT|EXT/gi, '').trim() || '',
            date: shootDay?.startDate ? new Date(shootDay.startDate).toLocaleDateString('fr-FR') : '',
            plan: `${sceneIdx}-${shotIdx}`,
            planNom: shot?.name || '',
            camera: cadreur,
            objectif: shot?.lens || '',
            effet: effet,
            lieu: lieu,
            description: shot?.description || shot?.notes || '',
            dialogues: dialogues
        };
    },
    
    // Rendu de la fiche de script
    renderSheet: (sceneId, shotId) => {
        const container = document.getElementById('sr-sheet-container');
        if(!container) return;
        
        // Initialiser le stockage si n√©cessaire
        if(!state.data.scriptReports) state.data.scriptReports = {};
        const key = `${sceneId}_${shotId}`;
        if(!state.data.scriptReports[key]) state.data.scriptReports[key] = [];
        
        const reports = state.data.scriptReports[key];
        const autoFill = ScriptReport.getAutoFillData(sceneId, shotId);
        
        // Si aucun rapport, en cr√©er un nouveau
        if(reports.length === 0) {
            reports.push(ScriptReport.createNewReport(autoFill));
            Store.save();
        }
        
        const idx = Math.min(ScriptReport.currentReportIdx, reports.length - 1);
        const report = reports[idx] || {};
        
        // Navigation entre les fiches
        let navHtml = '';
        if(reports.length > 1 || true) {
            navHtml = `<div class="sr-nav-reports">
                ${reports.map((r, i) => `<button class="sr-nav-btn ${i === idx ? 'active' : ''}" onclick="app.ScriptReport.switchReport(${i})">Fiche ${i + 1}</button>`).join('')}
                <button class="sr-nav-btn" onclick="app.ScriptReport.addReport('${sceneId}', '${shotId}')" style="background: var(--success); color: white;">+ Nouvelle fiche</button>
                ${reports.length > 1 ? `<button class="sr-nav-btn" onclick="app.ScriptReport.deleteReport('${sceneId}', '${shotId}', ${idx})" style="background: var(--danger); color: white;">üóëÔ∏è</button>` : ''}
            </div>`;
        }
        
        container.innerHTML = `
            ${navHtml}
            <div class="sr-sheet">
                <!-- Ligne 1: FILM / D√âCOR / DATE / PLAN / EFFET -->
                <div class="sr-sheet-row" style="grid-template-columns: 1fr 1fr 120px 100px 180px;">
                    <div class="sr-sheet-cell"><strong>FILM :</strong><br><input type="text" value="${Utils.escape(report.film || autoFill.film)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'film', this.value)" style="width: 100%;"></div>
                    <div class="sr-sheet-cell"><strong>D√âCOR :</strong><br><input type="text" value="${Utils.escape(report.decor || autoFill.decor)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'decor', this.value)" style="width: 100%;"></div>
                    <div class="sr-sheet-cell"><strong>DATE :</strong><br><input type="text" value="${Utils.escape(report.date || autoFill.date)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'date', this.value)" style="width: 100%;"></div>
                    <div class="sr-sheet-cell"><strong>PLAN :</strong><br>${Utils.escape(report.plan || autoFill.plan)}</div>
                    <div class="sr-sheet-cell">
                        <strong>EFFET :</strong><br>
                        <select style="padding: 4px;" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'effet', this.value)">
                            <option value="" ${!(report.effet || autoFill.effet) ? 'selected' : ''}>-</option>
                            <option value="jour" ${(report.effet || autoFill.effet) === 'jour' ? 'selected' : ''}>JOUR</option>
                            <option value="nuit" ${(report.effet || autoFill.effet) === 'nuit' ? 'selected' : ''}>NUIT</option>
                        </select>
                        <select style="padding: 4px;" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'lieu', this.value)">
                            <option value="" ${!(report.lieu || autoFill.lieu) ? 'selected' : ''}>-</option>
                            <option value="int" ${(report.lieu || autoFill.lieu) === 'int' ? 'selected' : ''}>INT</option>
                            <option value="ext" ${(report.lieu || autoFill.lieu) === 'ext' ? 'selected' : ''}>EXT</option>
                        </select>
                    </div>
                </div>
                
                <!-- Ligne 2: SON / SUPPORTS / CAM√âRA / OBJECTIF -->
                <div class="sr-sheet-row" style="grid-template-columns: 100px 1fr 150px 150px;">
                    <div class="sr-sheet-cell">
                        <strong>SON :</strong><br>
                        <select style="padding: 4px; width: 100%;" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'son', this.value)">
                            <option value="sonore" ${report.son !== 'muet' ? 'selected' : ''}>SONORE</option>
                            <option value="muet" ${report.son === 'muet' ? 'selected' : ''}>MUET</option>
                        </select>
                    </div>
                    <div class="sr-sheet-cell"><strong>Supports :</strong><br><input type="text" value="${Utils.escape(report.supports || '')}" placeholder="Noms des supports..." onchange="app.ScriptReport.updateField('${key}', ${idx}, 'supports', this.value)" style="width: 100%;"></div>
                    <div class="sr-sheet-cell"><strong>CAM√âRA :</strong><br><input type="text" value="${Utils.escape(report.camera || autoFill.camera)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'camera', this.value)" style="width: 100%;"></div>
                    <div class="sr-sheet-cell"><strong>OBJECTIF :</strong><br><input type="text" value="${Utils.escape(report.objectif || autoFill.objectif)}" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'objectif', this.value)" style="width: 100%;"></div>
                </div>
                
                <!-- Ligne 3: NOTE (texte libre) -->
                <div class="sr-sheet-row" style="grid-template-columns: 1fr;">
                    <div class="sr-sheet-cell"><strong>NOTE :</strong><br><textarea style="width: 100%; height: 50px; border: none; resize: vertical;" placeholder="Notes libres..." onchange="app.ScriptReport.updateField('${key}', ${idx}, 'note', this.value)">${Utils.escape(report.note || '')}</textarea></div>
                </div>
                
                <!-- Tableau des prises -->
                <div style="padding: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>PRISES</strong>
                        <button onclick="app.ScriptReport.addTake('${key}', ${idx})" style="padding: 5px 10px; background: var(--success); color: white; border: none; border-radius: 4px; cursor: pointer;">+ Prise</button>
                    </div>
                    <table class="sr-takes-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Prise</th>
                                <th style="width: 70px;">N¬∞ Son</th>
                                <th style="width: 70px;">N¬∞ Image</th>
                                <th style="width: 200px;">Qualit√©</th>
                                <th>Notes</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(report.takes || []).map((take, tIdx) => `
                                <tr>
                                    <td style="text-align: center; vertical-align: top; padding-top: 10px;">
                                        <div style="font-weight: bold;">${tIdx + 1}</div>
                                        <div style="margin-top: 5px;">
                                            <span style="font-size: 1.3rem; color: ${take.star === 'gold' ? '#FFD700' : take.star === 'silver' ? '#A0A0A0' : '#CCC'}; cursor: pointer;" onclick="app.ScriptReport.showStarMenu(event, '${key}', ${idx}, ${tIdx})" title="Marquer cette prise">${take.star ? '‚òÖ' : '‚òÜ'}</span>
                                        </div>
                                    </td>
                                    <td style="vertical-align: top; padding-top: 8px;"><input type="text" value="${Utils.escape(take.numSon || '')}" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'numSon', this.value)" style="width: 100%; border: none; text-align: center;"></td>
                                    <td style="vertical-align: top; padding-top: 8px;"><input type="text" value="${Utils.escape(take.numImage || '')}" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'numImage', this.value)" style="width: 100%; border: none; text-align: center;"></td>
                                    <td style="padding: 5px; vertical-align: top;">
                                        <div class="sr-quality-row">
                                            <span class="sr-quality-label">Son</span>
                                            <select class="sr-quality-select" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'qualitySon', this.value)">
                                                <option value="" ${!take.qualitySon ? 'selected' : ''}>-</option>
                                                <option value="5" ${take.qualitySon === '5' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Excellent</option>
                                                <option value="4" ${take.qualitySon === '4' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ Tr√®s bien</option>
                                                <option value="3" ${take.qualitySon === '3' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ Bien</option>
                                                <option value="2" ${take.qualitySon === '2' ? 'selected' : ''}>‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ Moyen</option>
                                                <option value="1" ${take.qualitySon === '1' ? 'selected' : ''}>‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ Pas bien</option>
                                            </select>
                                        </div>
                                        <div class="sr-quality-row">
                                            <span class="sr-quality-label">Image</span>
                                            <select class="sr-quality-select" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'qualityImage', this.value)">
                                                <option value="" ${!take.qualityImage ? 'selected' : ''}>-</option>
                                                <option value="5" ${take.qualityImage === '5' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Excellent</option>
                                                <option value="4" ${take.qualityImage === '4' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ Tr√®s bien</option>
                                                <option value="3" ${take.qualityImage === '3' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ Bien</option>
                                                <option value="2" ${take.qualityImage === '2' ? 'selected' : ''}>‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ Moyen</option>
                                                <option value="1" ${take.qualityImage === '1' ? 'selected' : ''}>‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ Pas bien</option>
                                            </select>
                                        </div>
                                        <div class="sr-quality-row">
                                            <span class="sr-quality-label">Acting</span>
                                            <select class="sr-quality-select" onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'qualityActing', this.value)">
                                                <option value="" ${!take.qualityActing ? 'selected' : ''}>-</option>
                                                <option value="5" ${take.qualityActing === '5' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Excellent</option>
                                                <option value="4" ${take.qualityActing === '4' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ Tr√®s bien</option>
                                                <option value="3" ${take.qualityActing === '3' ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ Bien</option>
                                                <option value="2" ${take.qualityActing === '2' ? 'selected' : ''}>‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ Moyen</option>
                                                <option value="1" ${take.qualityActing === '1' ? 'selected' : ''}>‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ Pas bien</option>
                                            </select>
                                        </div>
                                    </td>
                                    <td style="vertical-align: top;"><textarea placeholder="Notes, raccords, remarques..." onchange="app.ScriptReport.updateTake('${key}', ${idx}, ${tIdx}, 'notes', this.value)" style="width: 100%; min-height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; font-size: 0.85rem;">${Utils.escape(take.notes || '')}</textarea></td>
                                    <td style="vertical-align: top; padding-top: 8px;"><button onclick="app.ScriptReport.removeTake('${key}', ${idx}, ${tIdx})" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">√ó</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Description du plan et Dialogues -->
                <div class="sr-sheet-row" style="grid-template-columns: 1fr 1fr;">
                    <div class="sr-sheet-cell" style="padding: 10px;">
                        <strong>Description du Plan</strong>
                        <textarea style="width: 100%; min-height: 120px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; padding: 8px;" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'description', this.value)">${Utils.escape(report.description || autoFill.description)}</textarea>
                    </div>
                    <div class="sr-sheet-cell" style="padding: 10px;">
                        <strong>Dialogues</strong>
                        <textarea style="width: 100%; min-height: 120px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; padding: 8px;" onchange="app.ScriptReport.updateField('${key}', ${idx}, 'dialogues', this.value)">${Utils.escape(report.dialogues || autoFill.dialogues)}</textarea>
                    </div>
                </div>
            </div>
        `;
    },
    
    createNewReport: (autoFill = {}) => ({
        film: autoFill.film || '',
        date: autoFill.date || '',
        plan: autoFill.plan || '',
        decor: autoFill.decor || '',
        camera: autoFill.camera || '',
        objectif: autoFill.objectif || '',
        effet: autoFill.effet || '',
        lieu: autoFill.lieu || '',
        bobine: '',
        son: 'sonore',
        supports: '',
        description: autoFill.description || '',
        dialogues: autoFill.dialogues || '',
        takes: [],
        createdAt: Date.now()
    }),
    
    updateField: (key, idx, field, value) => {
        if(!state.data.scriptReports[key]) return;
        if(!state.data.scriptReports[key][idx]) return;
        state.data.scriptReports[key][idx][field] = value;
        Store.save();
    },
    
    addTake: (key, reportIdx) => {
        if(!state.data.scriptReports[key]) return;
        if(!state.data.scriptReports[key][reportIdx]) return;
        if(!state.data.scriptReports[key][reportIdx].takes) state.data.scriptReports[key][reportIdx].takes = [];
        
        state.data.scriptReports[key][reportIdx].takes.push({
            numSon: '',
            numImage: '',
            qualitySon: '',
            qualityImage: '',
            qualityActing: '',
            notes: ''
        });
        
        Store.save();
        const [sceneId, shotId] = key.split('_');
        ScriptReport.renderSheet(sceneId, shotId);
    },
    
    updateTake: (key, reportIdx, takeIdx, field, value) => {
        if(!state.data.scriptReports[key]?.[reportIdx]?.takes?.[takeIdx]) return;
        state.data.scriptReports[key][reportIdx].takes[takeIdx][field] = value;
        Store.save();
    },
    
    setTakeStar: (key, reportIdx, takeIdx, value) => {
        if(!state.data.scriptReports[key]?.[reportIdx]?.takes?.[takeIdx]) return;
        state.data.scriptReports[key][reportIdx].takes[takeIdx].star = value;
        Store.save();
        const [sceneId, shotId] = key.split('_');
        ScriptReport.renderSheet(sceneId, shotId);
    },
    
    showStarMenu: (event, key, reportIdx, takeIdx) => {
        event.stopPropagation();
        // Fermer tout menu existant
        document.querySelectorAll('.sr-star-menu').forEach(m => m.remove());
        
        const menu = document.createElement('div');
        menu.className = 'sr-star-menu';
        menu.style.cssText = 'position: absolute; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; padding: 5px 0;';
        menu.innerHTML = `
            <div style="padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="app.ScriptReport.setTakeStar('${key}', ${reportIdx}, ${takeIdx}, 'gold'); this.parentElement.remove();">
                <span style="font-size: 1.3rem; color: #FFD700;">‚òÖ</span> <span>Or</span>
            </div>
            <div style="padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="app.ScriptReport.setTakeStar('${key}', ${reportIdx}, ${takeIdx}, 'silver'); this.parentElement.remove();">
                <span style="font-size: 1.3rem; color: #A0A0A0;">‚òÖ</span> <span>Argent</span>
            </div>
            <div style="padding: 8px 15px; cursor: pointer; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'" onclick="app.ScriptReport.setTakeStar('${key}', ${reportIdx}, ${takeIdx}, ''); this.parentElement.remove();">
                <span style="font-size: 1.3rem; color: #CCC;">‚òÜ</span> <span>Aucune</span>
            </div>
        `;
        
        document.body.appendChild(menu);
        
        // Positionner le menu
        const rect = event.target.getBoundingClientRect();
        menu.style.left = rect.left + 'px';
        menu.style.top = (rect.bottom + 5) + 'px';
        
        // Fermer au clic ailleurs
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }, { once: true });
        }, 10);
    },
    
    removeTake: async (key, reportIdx, takeIdx) => {
        if(!await ConfirmModal.confirmDelete('Supprimer cette prise ?')) return;
        if(!state.data.scriptReports[key]?.[reportIdx]?.takes) return;
        state.data.scriptReports[key][reportIdx].takes.splice(takeIdx, 1);
        Store.save();
        const [sceneId, shotId] = key.split('_');
        ScriptReport.renderSheet(sceneId, shotId);
    },
    
       
    switchReport: (idx) => {
        ScriptReport.currentReportIdx = idx;
        if(ScriptReport.currentSceneId && ScriptReport.currentShotId) {
            ScriptReport.renderSheet(ScriptReport.currentSceneId, ScriptReport.currentShotId);
        }
    },
    
    addReport: (sceneId, shotId) => {
        const key = `${sceneId}_${shotId}`;
        if(!state.data.scriptReports[key]) state.data.scriptReports[key] = [];
        const autoFill = ScriptReport.getAutoFillData(sceneId, shotId);
        state.data.scriptReports[key].push(ScriptReport.createNewReport(autoFill));
        ScriptReport.currentReportIdx = state.data.scriptReports[key].length - 1;
        Store.save();
        ScriptReport.renderScenesList();
        ScriptReport.renderSheet(sceneId, shotId);
        Utils.toast('Nouvelle fiche cr√©√©e', 'success');
    },
    
    deleteReport: async (sceneId, shotId, idx) => {
        if(!await ConfirmModal.confirmDelete('Supprimer cette fiche de script ?')) return;
        const key = `${sceneId}_${shotId}`;
        if(!state.data.scriptReports[key]) return;
        state.data.scriptReports[key].splice(idx, 1);
        ScriptReport.currentReportIdx = Math.max(0, idx - 1);
        Store.save();
        ScriptReport.renderScenesList();
        ScriptReport.renderSheet(sceneId, shotId);
        Utils.toast('Fiche supprim√©e', 'success');
    },
    
    exportCurrentPDF: () => {
        if(!ScriptReport.currentSceneId || !ScriptReport.currentShotId) {
            Utils.toast('S√©lectionnez d\'abord un plan', 'warning');
            return;
        }
        ScriptReport.generatePDF(ScriptReport.currentSceneId, ScriptReport.currentShotId, ScriptReport.currentReportIdx);
    },
    
    exportAllPDF: () => {
        Utils.toast('Export de toutes les fiches...', 'info');
        // Export toutes les fiches dans un seul PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        let firstPage = true;
        
        Object.entries(state.data.scriptReports || {}).forEach(([key, reports]) => {
            reports.forEach((report, idx) => {
                if(!firstPage) doc.addPage();
                firstPage = false;
                ScriptReport.renderPDFPage(doc, report, key);
            });
        });
        
        if(firstPage) {
            Utils.toast('Aucune fiche √† exporter', 'warning');
            return;
        }
        
        const filename = `${state.data.title || 'Projet'}_Rapports_Script.pdf`;
        doc.save(filename.replace(/[^a-z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß_-]/gi, '_'));
        Utils.toast('PDF export√© !', 'success');
    },
    
    generatePDF: (sceneId, shotId, reportIdx) => {
        const key = `${sceneId}_${shotId}`;
        const report = state.data.scriptReports?.[key]?.[reportIdx];
        if(!report) return;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        ScriptReport.renderPDFPage(doc, report, key);
        
        const filename = `Fiche_Script_${report.plan || 'Plan'}.pdf`;
        doc.save(filename.replace(/[^a-z0-9√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß_-]/gi, '_'));
        Utils.toast('PDF export√© !', 'success');
    },
    
    renderPDFPage: (doc, report, key) => {
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let y = margin;
        
        // R√©cup√©rer les dialogues depuis autoFill si report.dialogues est vide
        let dialoguesText = report.dialogues || '';
        if(!dialoguesText && key) {
            const [sceneId, shotId] = key.split('_');
            const autoFill = ScriptReport.getAutoFillData(sceneId, shotId);
            dialoguesText = autoFill.dialogues || '';
        }
        
        doc.setDrawColor(50, 50, 50);
        doc.setLineWidth(0.4);
        
        // === TITRE / EN-T√äTE ===
        doc.setFillColor(51, 51, 51);
        doc.rect(margin, y, pageWidth - 2*margin, 12, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('FICHE DE SCRIPT', pageWidth / 2, y + 8, { align: 'center' });
        doc.setTextColor(0, 0, 0);
        y += 15;
        
        // === LIGNE 1 : FILM / DATE / PLAN ===
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        const row1Height = 12;
        doc.rect(margin, y, pageWidth - 2*margin, row1Height);
        doc.line(margin + 90, y, margin + 90, y + row1Height);
        doc.line(pageWidth - margin - 60, y, pageWidth - margin - 60, y + row1Height);
        
        doc.text('FILM :', margin + 3, y + 5);
        doc.text('DATE :', margin + 93, y + 5);
        doc.text('PLAN :', pageWidth - margin - 57, y + 5);
        
        doc.setFont('helvetica', 'normal');
        doc.text(report.film || '', margin + 3, y + 10);
        doc.text(report.date || '', margin + 93, y + 10);
        doc.text(report.plan || '', pageWidth - margin - 57, y + 10);
        y += row1Height;
        
        // === LIGNE 2 : D√âCOR / EFFET ===
        doc.rect(margin, y, pageWidth - 2*margin, row1Height);
        doc.line(pageWidth - margin - 70, y, pageWidth - margin - 70, y + row1Height);
        
        doc.setFont('helvetica', 'bold');
        doc.text('D√âCOR :', margin + 3, y + 5);
        doc.text('EFFET :', pageWidth - margin - 67, y + 5);
        
        doc.setFont('helvetica', 'normal');
        doc.text(report.decor || '', margin + 3, y + 10);
        const effetStr = [(report.effet || '').toUpperCase(), (report.lieu || '').toUpperCase()].filter(Boolean).join(' - ');
        doc.text(effetStr, pageWidth - margin - 67, y + 10);
        y += row1Height;
        
        // === LIGNE 3 : SON / SUPPORTS / CAM / OBJ ===
        doc.rect(margin, y, pageWidth - 2*margin, row1Height);
        doc.line(margin + 30, y, margin + 30, y + row1Height);
        doc.line(margin + 90, y, margin + 90, y + row1Height);
        doc.line(pageWidth - margin - 45, y, pageWidth - margin - 45, y + row1Height);
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.text('SON', margin + 3, y + 4);
        doc.text('SUPPORTS', margin + 33, y + 4);
        doc.text('CAMERA', margin + 93, y + 4);
        doc.text('OBJECTIF', pageWidth - margin - 42, y + 4);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text(report.son === 'muet' ? 'MUET' : 'SONORE', margin + 3, y + 10);
        doc.text(report.supports || '-', margin + 33, y + 10);
        doc.text(report.camera || '-', margin + 93, y + 10);
        doc.text(report.objectif || '-', pageWidth - margin - 42, y + 10);
        y += row1Height;
        
        // === LIGNE 4 : NOTE (si pr√©sente) ===
        if(report.note) {
            doc.setFontSize(9);
            const noteLines = doc.splitTextToSize(report.note, pageWidth - 2*margin - 25);
            const noteHeight = Math.max(10, noteLines.length * 4 + 6);
            doc.rect(margin, y, pageWidth - 2*margin, noteHeight);
            doc.setFont('helvetica', 'bold');
            doc.text('NOTE :', margin + 3, y + 5);
            doc.setFont('helvetica', 'normal');
            noteLines.forEach((line, i) => doc.text(line, margin + 22, y + 5 + i*4));
            y += noteHeight;
        }
        
        y += 5;
        
        // === TABLEAU DES PRISES ===
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('PRISES', margin, y + 4);
        y += 7;
        
        doc.setFontSize(8);
        const tableWidth = pageWidth - 2*margin;
        const col1 = 18; // Prise
        const col2 = 25; // N¬∞ Son
        const col3 = 28; // N¬∞ Image
        const col4 = tableWidth - col1 - col2 - col3; // Qualit√© & Notes
        
        // En-t√™te tableau
        doc.setFillColor(230, 230, 230);
        doc.rect(margin, y, tableWidth, 8, 'FD');
        doc.setFont('helvetica', 'bold');
        doc.text('Prise', margin + 2, y + 5);
        doc.text('N¬∞ Son', margin + col1 + 2, y + 5);
        doc.text('N¬∞ Image', margin + col1 + col2 + 2, y + 5);
        doc.text('Qualit√© & Notes', margin + col1 + col2 + col3 + 2, y + 5);
        y += 8;
        
        // Lignes de prises
        doc.setFont('helvetica', 'normal');
        (report.takes || []).forEach((take, idx) => {
            const hasStar = take.star === 'gold' || take.star === 'silver';
            const qualArr = [];
            if(take.qualitySon) qualArr.push('Son:' + take.qualitySon + '/5');
            if(take.qualityImage) qualArr.push('Img:' + take.qualityImage + '/5');
            if(take.qualityActing) qualArr.push('Act:' + take.qualityActing + '/5');
            const qualStr = qualArr.length > 0 ? qualArr.join(' | ') : '';
            const notesStr = take.notes || '';
            const fullDesc = qualStr + (qualStr && notesStr ? ' - ' : '') + notesStr;
            
            const descLines = doc.splitTextToSize(fullDesc, col4 - 6);
            const rowHeight = Math.max(8, descLines.length * 4 + 3);
            
            if(y + rowHeight > pageHeight - 70) {
                doc.addPage();
                y = margin;
            }
            
            doc.rect(margin, y, tableWidth, rowHeight);
            doc.line(margin + col1, y, margin + col1, y + rowHeight);
            doc.line(margin + col1 + col2, y, margin + col1 + col2, y + rowHeight);
            doc.line(margin + col1 + col2 + col3, y, margin + col1 + col2 + col3, y + rowHeight);
            
            doc.setFont('helvetica', 'bold');
            doc.text(`${idx + 1}`, margin + 2, y + 5);
            
            // Dessiner une √©toile si n√©cessaire
            if(hasStar) {
                const starX = margin + 12;
                const starY = y + 3;
                const starSize = 2.5;
                
                // Couleur de l'√©toile
                if(take.star === 'gold') {
                    doc.setFillColor(255, 215, 0); // Or
                } else {
                    doc.setFillColor(180, 180, 180); // Argent
                }
                
                // Dessiner une √©toile √† 5 branches
                const points = [];
                for(let i = 0; i < 10; i++) {
                    const radius = i % 2 === 0 ? starSize : starSize * 0.4;
                    const angle = (i * 36 - 90) * Math.PI / 180;
                    points.push({
                        x: starX + radius * Math.cos(angle),
                        y: starY + radius * Math.sin(angle)
                    });
                }
                
                doc.setDrawColor(150, 150, 150);
                doc.setLineWidth(0.1);
                doc.moveTo(points[0].x, points[0].y);
                for(let i = 1; i < points.length; i++) {
                    doc.lineTo(points[i].x, points[i].y);
                }
                doc.lineTo(points[0].x, points[0].y);
                doc.fillStroke();
                
                // Reset couleurs
                doc.setDrawColor(50, 50, 50);
                doc.setLineWidth(0.4);
            }
            doc.setFont('helvetica', 'normal');
            doc.text(take.numSon || '', margin + col1 + 2, y + 5);
            doc.text(take.numImage || '', margin + col1 + col2 + 2, y + 5);
            descLines.forEach((line, i) => doc.text(line, margin + col1 + col2 + col3 + 2, y + 5 + i*4));
            
            y += rowHeight;
        });
        
        if((report.takes || []).length === 0) {
            doc.rect(margin, y, tableWidth, 10);
            doc.setTextColor(150, 150, 150);
            doc.text('Aucune prise enregistr√©e', margin + tableWidth/2, y + 6, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            y += 10;
        }
        
        y += 8;
        
        // === DESCRIPTION ET DIALOGUES ===
        if(y > pageHeight - 80) {
            doc.addPage();
            y = margin;
        }
        
        const halfWidth = (pageWidth - 2*margin - 5) / 2;
        const boxHeight = Math.min(70, pageHeight - y - 15);
        
        // Description
        doc.rect(margin, y, halfWidth, boxHeight);
        doc.setFillColor(245, 245, 245);
        doc.rect(margin, y, halfWidth, 8, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text('Description du Plan', margin + 3, y + 6);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        const descLines2 = doc.splitTextToSize(report.description || '', halfWidth - 6);
        descLines2.slice(0, 15).forEach((line, i) => doc.text(line, margin + 3, y + 14 + i*4));
        
        // Dialogues
        doc.rect(margin + halfWidth + 5, y, halfWidth, boxHeight);
        doc.setFillColor(245, 245, 245);
        doc.rect(margin + halfWidth + 5, y, halfWidth, 8, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9);
        doc.text('Dialogues', margin + halfWidth + 8, y + 6);
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        const dialLines2 = doc.splitTextToSize(dialoguesText, halfWidth - 6);
        dialLines2.slice(0, 15).forEach((line, i) => doc.text(line, margin + halfWidth + 8, y + 14 + i*4));
    }
};

// ========== MODULE M√âT√âO (Open-Meteo API - 100% gratuit) ==========
const Weather = {
    cache: {},
    
    weatherCodes: {
        0: { icon: '‚òÄÔ∏è', desc: 'Ciel d√©gag√©' },
        1: { icon: 'üå§Ô∏è', desc: 'Principalement d√©gag√©' },
        2: { icon: '‚õÖ', desc: 'Partiellement nuageux' },
        3: { icon: '‚òÅÔ∏è', desc: 'Couvert' },
        45: { icon: 'üå´Ô∏è', desc: 'Brouillard' },
        48: { icon: 'üå´Ô∏è', desc: 'Brouillard givrant' },
        51: { icon: 'üåßÔ∏è', desc: 'Bruine l√©g√®re' },
        53: { icon: 'üåßÔ∏è', desc: 'Bruine mod√©r√©e' },
        55: { icon: 'üåßÔ∏è', desc: 'Bruine dense' },
        61: { icon: 'üåßÔ∏è', desc: 'Pluie l√©g√®re' },
        63: { icon: 'üåßÔ∏è', desc: 'Pluie mod√©r√©e' },
        65: { icon: 'üåßÔ∏è', desc: 'Pluie forte' },
        71: { icon: 'üå®Ô∏è', desc: 'Neige l√©g√®re' },
        73: { icon: 'üå®Ô∏è', desc: 'Neige mod√©r√©e' },
        75: { icon: 'üå®Ô∏è', desc: 'Neige forte' },
        80: { icon: 'üå¶Ô∏è', desc: 'Averses l√©g√®res' },
        81: { icon: 'üå¶Ô∏è', desc: 'Averses mod√©r√©es' },
        82: { icon: 'üå¶Ô∏è', desc: 'Averses violentes' },
        85: { icon: 'üå®Ô∏è', desc: 'Averses de neige' },
        95: { icon: '‚õàÔ∏è', desc: 'Orage' },
        96: { icon: '‚õàÔ∏è', desc: 'Orage avec gr√™le' },
        99: { icon: '‚õàÔ∏è', desc: 'Orage violent' }
    },
    
    getWindDirection: (degrees) => {
        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
        return directions[Math.round(degrees / 45) % 8];
    },
    
    fetch: async (lat, lng, date) => {
        if(!lat || !lng || !date) return null;
        
        const cacheKey = `${lat.toFixed(2)}_${lng.toFixed(2)}_${date}`;
        if(Weather.cache[cacheKey]) return Weather.cache[cacheKey];
        
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,precipitation_sum,precipitation_probability_max,windspeed_10m_max,winddirection_10m_dominant,sunrise,sunset&timezone=Europe/Paris&start_date=${date}&end_date=${date}`;
            
            const response = await fetch(url);
            if(!response.ok) throw new Error('Erreur API m√©t√©o');
            
            const data = await response.json();
            if(!data.daily || !data.daily.time?.length) return null;
            
            const weatherCode = data.daily.weathercode[0];
            const weatherInfo = Weather.weatherCodes[weatherCode] || { icon: '‚ùì', desc: 'Inconnu' };
            
            const result = {
                icon: weatherInfo.icon,
                description: weatherInfo.desc,
                tempMax: Math.round(data.daily.temperature_2m_max[0]),
                tempMin: Math.round(data.daily.temperature_2m_min[0]),
                feelsLike: Math.round(data.daily.apparent_temperature_max[0]),
                precipitation: data.daily.precipitation_sum[0],
                precipitationProb: data.daily.precipitation_probability_max[0],
                windSpeed: Math.round(data.daily.windspeed_10m_max[0]),
                windDirection: Weather.getWindDirection(data.daily.winddirection_10m_dominant[0]),
                sunrise: data.daily.sunrise[0]?.split('T')[1] || '--:--',
                sunset: data.daily.sunset[0]?.split('T')[1] || '--:--'
            };
            
            Weather.cache[cacheKey] = result;
            return result;
        } catch(e) {
            console.error('Erreur m√©t√©o:', e);
            return null;
        }
    },
    
    renderCard: (weather) => {
        if(!weather) return `<div class="fds-weather-loading">üå§Ô∏è M√©t√©o non disponible</div>`;
        
        return `
            <div class="fds-weather-card">
                <div class="fds-weather-icon">${weather.icon}</div>
                <div class="fds-weather-main">
                    <div class="fds-weather-temp">${weather.tempMax}¬∞C</div>
                    <div class="fds-weather-desc">${weather.description}</div>
                    <div class="fds-sun-times">
                        <span class="fds-sun-item">üåÖ ${weather.sunrise}</span>
                        <span class="fds-sun-item">üåá ${weather.sunset}</span>
                    </div>
                </div>
                <div class="fds-weather-details">
                    <span>Min: ${weather.tempMin}¬∞C</span>
                    <span>Ressenti: ${weather.feelsLike}¬∞C</span>
                </div>
            </div>
            <div class="fds-weather-row">
                <div class="fds-weather-item">üíß ${weather.precipitationProb}% pluie</div>
                ${weather.precipitation > 0 ? `<div class="fds-weather-item">üåßÔ∏è ${weather.precipitation}mm</div>` : ''}
                <div class="fds-weather-item">üí® ${weather.windSpeed} km/h ${weather.windDirection}</div>
            </div>
        `;
    }
};

  window.ColorWheel = ColorWheel;
  // ==================== MODULE BEAT BOARD ====================
  // ========== MODE FOCUS (Plein √©cran onglet) ==========
  const FocusMode = {
      isActive: false,
      tabOrder: ['presentation', 'synopsis', 'board', 'titlepage', 'script', 'moodboard', 'storyboard', 'chars', 'actors', 'locs', 'resources', 'crew', 'breakdown', 'stats', 'planning', 'scriptreport', 'expenses', 'chat'],
      tabNames: {
          'presentation': 'üìã Pr√©sentation',
          'synopsis': 'üìù Synopsis', 
          'board': 'üé¨ S√©quencier / BB',
          'titlepage': 'üéûÔ∏è Page de Titre',
          'script': 'üìÑ Sc√©nario',
          'moodboard': 'üé® Mood Board',
          'storyboard': 'üñºÔ∏è Storyboard',
          'chars': 'üë§ Personnages',
          'actors': 'üé≠ Com√©diens',
          'locs': 'üè† D√©cors',
          'resources': 'üì¶ Ressources',
          'crew': 'üë• √âquipes',
          'breakdown': 'üìã D√©pouillement',
          'stats': 'üìä Statistiques',
          'planning': 'üìÖ Planning',
          'scriptreport': 'üìù Rapport',
          'expenses': 'üí∞ D√©penses',
          'chat': 'üí¨ Chat'
      },
      
      toggle: () => {
          if(FocusMode.isActive) {
              FocusMode.exit();
          } else {
              FocusMode.enter();
          }
      },
      
      enter: () => {
          FocusMode.isActive = true;
          document.body.classList.add('focus-mode');
          document.getElementById('focus-toolbar').style.display = 'flex';
          FocusMode.updateTitle();
          document.getElementById('focus-project-title').textContent = state.data.title || 'Mon Film';
          Utils.toast('Mode Focus activ√© (√âchap pour quitter)', 'info');
      },
      
      exit: () => {
          FocusMode.isActive = false;
          document.body.classList.remove('focus-mode');
          document.getElementById('focus-toolbar').style.display = 'none';
      },
      
      updateTitle: () => {
          const activeTab = document.querySelector('.tab-content.active');
          if(activeTab) {
              const tabId = activeTab.id.replace('tab-', '');
              document.getElementById('focus-tab-title').textContent = FocusMode.tabNames[tabId] || tabId;
          }
      },
      
      getCurrentIndex: () => {
          const activeTab = document.querySelector('.tab-content.active');
          if(activeTab) {
              const tabId = activeTab.id.replace('tab-', '');
              return FocusMode.tabOrder.indexOf(tabId);
          }
          return 0;
      },
      
      nextTab: () => {
          const currentIdx = FocusMode.getCurrentIndex();
          const nextIdx = (currentIdx + 1) % FocusMode.tabOrder.length;
          app.UI.switchTab(FocusMode.tabOrder[nextIdx]);
          FocusMode.updateTitle();
      },
      
      prevTab: () => {
          const currentIdx = FocusMode.getCurrentIndex();
          const prevIdx = (currentIdx - 1 + FocusMode.tabOrder.length) % FocusMode.tabOrder.length;
          app.UI.switchTab(FocusMode.tabOrder[prevIdx]);
          FocusMode.updateTitle();
      }
  };

  const BeatBoard = {
      viewMode: 'sequencer', // 'sequencer' ou 'beatboard'
      zoom: 1,
      panX: 0,
      panY: 0,
      isPanning: false,
      panStartX: 0,
      panStartY: 0,
      draggedCard: null,
      showLine: true,
      selectedCards: [], // IDs des cartes s√©lectionn√©es
      
      setViewMode: (mode) => {
          BeatBoard.viewMode = mode;
          const seqView = document.getElementById('sequencer-view');
          const bbView = document.getElementById('beatboard-view');
          const seqOpts = document.getElementById('sequencer-options');
          const bbOpts = document.getElementById('beatboard-options');
          const btnSeq = document.getElementById('view-mode-sequencer');
          const btnBB = document.getElementById('view-mode-beatboard');
          
          if(mode === 'sequencer') {
              seqView.style.display = 'block';
              bbView.style.display = 'none';
              seqOpts.style.display = 'block';
              bbOpts.style.display = 'none';
              btnSeq.style.background = 'var(--primary)';
              btnSeq.style.color = 'white';
              btnBB.style.background = 'var(--bg)';
              btnBB.style.color = 'var(--text-main)';
          } else {
              seqView.style.display = 'none';
              bbView.style.display = 'block';
              seqOpts.style.display = 'none';
              bbOpts.style.display = 'block';
              btnSeq.style.background = 'var(--bg)';
              btnSeq.style.color = 'var(--text-main)';
              btnBB.style.background = 'var(--primary)';
              btnBB.style.color = 'white';
              BeatBoard.render();
          }
      },
      
      render: () => {
          const canvas = document.getElementById('beatboardCanvas');
          if(!canvas) return;
          
          // Supprimer les anciennes cartes et zones
          canvas.querySelectorAll('.beatboard-card, .beatboard-out-timeline-zone').forEach(c => c.remove());
          
          // S√©parer les sc√®nes in/out timeline
          const inTimeline = state.data.scenes.filter(s => s.inTimeline !== false);
          const outTimeline = state.data.scenes.filter(s => s.inTimeline === false);
          
          // Initialiser positions si n√©cessaire
          inTimeline.forEach((scene, idx) => {
              if(!scene.beatboardX || !scene.beatboardY) {
                  scene.beatboardX = 50 + (idx % 6) * 220;
                  scene.beatboardY = 50 + Math.floor(idx / 6) * 160;
              }
          });
          
          // Positionner les sc√®nes hors timeline en bas
          outTimeline.forEach((scene, idx) => {
              if(!scene.beatboardX || !scene.beatboardY) {
                  scene.beatboardX = 50 + (idx % 8) * 200;
                  scene.beatboardY = 800 + Math.floor(idx / 8) * 140;
              }
          });
          
          // Cr√©er les cartes in timeline avec num√©ros
          inTimeline.forEach((scene, idx) => {
              const card = BeatBoard.createCard(scene, idx, true);
              canvas.appendChild(card);
          });
          
          // Cr√©er les cartes out timeline sans num√©ros
          outTimeline.forEach((scene) => {
              const card = BeatBoard.createCard(scene, null, false);
              canvas.appendChild(card);
          });
          
          // Zone visuelle "Hors timeline" si il y a des sc√®nes dedans
          if(outTimeline.length > 0) {
              const zone = document.createElement('div');
              zone.className = 'beatboard-out-timeline-zone';
              zone.innerHTML = '<span class="beatboard-out-timeline-label">üìå Hors timeline</span>';
              zone.style.bottom = '20px';
              zone.style.left = '20px';
              zone.style.transform = 'none';
              zone.style.position = 'absolute';
              zone.style.top = '750px';
              canvas.appendChild(zone);
          }
          
          // Dessiner le fil rouge (seulement les sc√®nes in timeline)
          BeatBoard.drawLine();
          
          // Mettre √† jour la liste des tags
          BeatBoard.renderTagList();
          
          // Mettre √† jour la minimap
          BeatBoard.updateMinimap();
          
          // Initialiser le pan
          BeatBoard.initPan();
      },
      
      createCard: (scene, idx, isInTimeline = true) => {
          const card = document.createElement('div');
          card.className = 'beatboard-card' + (isInTimeline ? '' : ' out-of-timeline');
          card.dataset.id = scene.id;
          card.dataset.inTimeline = isInTimeline;
          if(idx !== null) card.dataset.index = idx;
          card.style.left = scene.beatboardX + 'px';
          card.style.top = scene.beatboardY + 'px';
          
          // Marquer comme s√©lectionn√© si dans la liste
          if(BeatBoard.selectedCards.includes(scene.id)) {
              card.classList.add('selected');
          }
          
          const tag = state.data.tags.find(t => t.id === scene.tag_id) || {name:'', color: 'transparent'};
          const statusLabels = { 'not-verified': 'üî¥', 'to-work': 'üü°', 'verified': 'üü¢' };
          const status = scene.status || 'not-verified';
          
          const numberBadge = isInTimeline ? `<div class="beatboard-card-number">${idx + 1}</div>` : '';
          const timelineIcon = isInTimeline ? '' : '<span style="position:absolute;top:8px;right:8px;font-size:0.7rem;color:var(--text-sec);">üìå</span>';
          
          card.innerHTML = `
              <div class="beatboard-card-tag" style="background: ${tag.color !== 'transparent' ? tag.color : 'var(--border)'}"></div>
              ${numberBadge}
              ${timelineIcon}
              <div class="beatboard-card-connector in"></div>
              <div class="beatboard-card-connector out"></div>
              <div class="beatboard-card-title">${Utils.escape(scene.title)}</div>
              <div class="beatboard-card-meta">${Utils.escape(scene.perso || '-')} ‚Ä¢ ${scene.time || '?'} min</div>
              <div class="beatboard-card-resume">${Utils.escape(scene.resume || '')}</div>
              <div class="beatboard-card-status">${statusLabels[status]}</div>
          `;
          
          // Clic avec Ctrl = s√©lection multiple
          card.addEventListener('click', (e) => {
              if(e.ctrlKey || e.metaKey) {
                  e.preventDefault();
                  e.stopPropagation();
                  BeatBoard.toggleSelection(scene.id);
              }
          });
          
          // Drag & Drop
          card.addEventListener('mousedown', (e) => {
              if(e.ctrlKey || e.metaKey) return; // Ctrl = s√©lection, pas drag
              BeatBoard.startDrag(e, card, scene);
          });
          card.addEventListener('dblclick', () => Actions.editScene(scene.id));
          card.addEventListener('contextmenu', (e) => Actions.openTagMenu(e, scene.id));
          
          return card;
      },
      
      toggleSelection: (sceneId) => {
          const idx = BeatBoard.selectedCards.indexOf(sceneId);
          if(idx === -1) {
              BeatBoard.selectedCards.push(sceneId);
          } else {
              BeatBoard.selectedCards.splice(idx, 1);
          }
          // Mettre √† jour visuellement
          const card = document.querySelector(`.beatboard-card[data-id="${sceneId}"]`);
          if(card) card.classList.toggle('selected');
      },
      
      clearSelection: () => {
          BeatBoard.selectedCards = [];
          document.querySelectorAll('.beatboard-card.selected').forEach(c => c.classList.remove('selected'));
      },
      
      createScene: () => {
          // Ouvrir le formulaire de cr√©ation de sc√®ne
          const form = document.getElementById('edit-scene-form');
          if(form) {
              // R√©initialiser le formulaire
              document.getElementById('inpPre').value = 'INT';
              document.getElementById('inpLoc').value = '';
              document.getElementById('inpSuff').value = 'JOUR';
              document.getElementById('inpTime').value = '';
              document.getElementById('inpPerso').value = '';
              document.getElementById('inpResume').value = '';
          }
          
          // Cr√©er un modal pour le formulaire dans le beatboard
          const existingModal = document.getElementById('beatboard-scene-modal');
          if(existingModal) existingModal.remove();
          
          const modal = document.createElement('div');
          modal.id = 'beatboard-scene-modal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:10001;';
          modal.innerHTML = `
              <div style="background:var(--panel-bg); border-radius:12px; padding:25px; width:90%; max-width:500px; border:1px solid var(--border);">
                  <h3 style="margin:0 0 20px; display:flex; justify-content:space-between; align-items:center;">
                      ‚ûï Nouvelle sc√®ne (hors timeline)
                      <button onclick="document.getElementById('beatboard-scene-modal').remove()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-sec);">√ó</button>
                  </h3>
                  <div style="display:flex; gap:8px; margin-bottom:15px;">
                      <input id="bb-inpPre" placeholder="INT" value="INT" style="width:60px; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                      <span style="display:flex; align-items:center;">.</span>
                      <input id="bb-inpLoc" placeholder="LIEU" style="flex:1; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                      <span style="display:flex; align-items:center;">-</span>
                      <input id="bb-inpSuff" placeholder="JOUR" value="JOUR" style="width:80px; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main);">
                  </div>
                  <input id="bb-inpTime" placeholder="Dur√©e (min)" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); margin-bottom:15px;">
                  <input id="bb-inpPerso" placeholder="Personnages..." style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); margin-bottom:15px;">
                  <textarea id="bb-inpResume" rows="3" placeholder="R√©sum√©..." style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px; background:var(--input-bg); color:var(--text-main); resize:vertical; margin-bottom:20px;"></textarea>
                  <div style="display:flex; gap:10px; justify-content:flex-end;">
                      <button onclick="document.getElementById('beatboard-scene-modal').remove()" style="padding:10px 20px; background:var(--border); color:var(--text-main); border:none; border-radius:6px; cursor:pointer;">Annuler</button>
                      <button onclick="app.BeatBoard.addScene()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">‚ûï Cr√©er</button>
                  </div>
              </div>
          `;
          document.body.appendChild(modal);
          document.getElementById('bb-inpLoc').focus();
      },
      
      addScene: () => {
          const pre = document.getElementById('bb-inpPre').value.trim() || 'INT';
          const loc = document.getElementById('bb-inpLoc').value.trim();
          const suff = document.getElementById('bb-inpSuff').value.trim() || 'JOUR';
          
          if(!loc) {
              Utils.toast('Entrez un lieu', 'warning');
              return;
          }
          
          const title = `${pre}. ${loc} - ${suff}`;
          
          const newScene = {
              id: Utils.generateUniqueId(),
              title: title,
              perso: document.getElementById('bb-inpPerso').value.trim(),
              time: document.getElementById('bb-inpTime').value.trim(),
              resume: document.getElementById('bb-inpResume').value.trim(),
              scriptContent: "<div class='sc-action'><br></div>",
              breakdown: {},
              tag_id: 't1',
              inTimeline: false, // Hors timeline par d√©faut
              beatboardX: 50 + Math.random() * 200,
              beatboardY: 800 + Math.random() * 100,
              lastModified: Date.now(),
              lastModifiedBy: state.currentUser?.email || 'unknown'
          };
          
          state.data.scenes.push(newScene);
          Store.save();
          
          document.getElementById('beatboard-scene-modal').remove();
          BeatBoard.render();
          UI.renderBoard();
          
          Utils.toast('Sc√®ne cr√©√©e (hors timeline)', 'success');
      },
      
      startDrag: (e, card, scene) => {
          if(e.button !== 0) return;
          e.preventDefault();
          
          const isReorderMode = e.shiftKey;
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          const sceneIndex = inTimelineScenes.findIndex(s => s.id === scene.id);
          const isCurrentlyInTimeline = scene.inTimeline !== false;
          
          // Multi-s√©lection : si la sc√®ne dragg√©e est dans la s√©lection, on d√©place tout le groupe
          const isMultiDrag = BeatBoard.selectedCards.length > 1 && BeatBoard.selectedCards.includes(scene.id);
          const selectedScenes = isMultiDrag 
              ? state.data.scenes.filter(s => BeatBoard.selectedCards.includes(s.id))
              : [scene];
          
          // Stocker les positions originales de toutes les cartes s√©lectionn√©es
          const originalPositions = selectedScenes.map(s => ({
              scene: s,
              origX: s.beatboardX,
              origY: s.beatboardY,
              card: document.querySelector(`.beatboard-card[data-id="${s.id}"]`)
          }));
          
          BeatBoard.draggedCard = { 
              card, 
              scene, 
              sceneIndex,
              startX: e.clientX, 
              startY: e.clientY, 
              origX: scene.beatboardX, 
              origY: scene.beatboardY,
              isReorderMode,
              isMultiDrag,
              originalPositions
          };
          
          // Ajouter la classe dragging √† toutes les cartes s√©lectionn√©es
          originalPositions.forEach(p => {
              if(p.card) p.card.classList.add('dragging');
          });
          
          if(isReorderMode) {
              card.style.zIndex = '2000';
              card.style.boxShadow = '0 20px 60px rgba(231, 76, 60, 0.4)';
              card.style.border = '3px solid #e74c3c';
              BeatBoard.showDropZones();
          }
          
          const onMove = (ev) => {
              const dx = (ev.clientX - BeatBoard.draggedCard.startX) / BeatBoard.zoom;
              const dy = (ev.clientY - BeatBoard.draggedCard.startY) / BeatBoard.zoom;
              
              // D√©placer toutes les cartes s√©lectionn√©es
              BeatBoard.draggedCard.originalPositions.forEach(p => {
                  const newX = Math.max(0, p.origX + dx);
                  const newY = Math.max(0, p.origY + dy);
                  if(p.card) {
                      p.card.style.left = newX + 'px';
                      p.card.style.top = newY + 'px';
                  }
                  if(!isReorderMode) {
                      p.scene.beatboardX = newX;
                      p.scene.beatboardY = newY;
                  }
              });
              
              BeatBoard.drawLine();
              BeatBoard.updateMinimap();
              
              if(isReorderMode) {
                  BeatBoard.highlightDropZone(ev.clientX, ev.clientY);
              }
          };
          
          const onUp = (ev) => {
              // Retirer la classe dragging de toutes les cartes
              BeatBoard.draggedCard.originalPositions.forEach(p => {
                  if(p.card) {
                      p.card.classList.remove('dragging');
                      p.card.style.zIndex = '';
                      p.card.style.boxShadow = '';
                      p.card.style.border = '';
                  }
              });
              
              if(isReorderMode) {
                  const dropResult = BeatBoard.getDropIndex(ev.clientX, ev.clientY);
                  BeatBoard.hideDropZones();
                  
                  // Remettre toutes les fiches √† leur position d'origine en mode reorder
                  BeatBoard.draggedCard.originalPositions.forEach(p => {
                      p.scene.beatboardX = p.origX;
                      p.scene.beatboardY = p.origY;
                  });
                  
                  if(dropResult.type === 'remove') {
                      BeatBoard.removeFromTimeline(scene);
                  } else if(dropResult.type === 'insert') {
                      const dropIndex = dropResult.index;
                      if(!isCurrentlyInTimeline || (dropIndex !== sceneIndex && dropIndex !== sceneIndex + 1)) {
                          BeatBoard.reorderScene(sceneIndex, dropIndex, scene);
                      } else {
                          BeatBoard.render();
                      }
                  } else {
                      BeatBoard.render();
                  }
              } else {
                  // Appliquer les nouvelles positions √† toutes les cartes
                  BeatBoard.draggedCard.originalPositions.forEach(p => {
                      if(p.card) {
                          p.scene.beatboardX = parseFloat(p.card.style.left);
                          p.scene.beatboardY = parseFloat(p.card.style.top);
                      }
                  });
                  BeatBoard.checkReorder();
              }
              
              BeatBoard.draggedCard = null;
              document.removeEventListener('mousemove', onMove);
              document.removeEventListener('mouseup', onUp);
              Store.save();
          };
          
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
      },
      
      showDropZones: () => {
          const canvas = document.getElementById('beatboardCanvas');
          if(!canvas) return;
          
          // Supprimer les anciennes zones
          canvas.querySelectorAll('.beatboard-dropzone').forEach(z => z.remove());
          
          // Ne consid√©rer que les sc√®nes in timeline
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          const draggedScene = BeatBoard.draggedCard?.scene;
          const draggedIndex = BeatBoard.draggedCard?.sceneIndex;
          const isCurrentlyInTimeline = draggedScene?.inTimeline !== false;
          
          // Cr√©er une zone avant la premi√®re carte (si on n'est pas la premi√®re)
          if(inTimelineScenes.length > 0 && draggedIndex !== 0) {
              const firstScene = inTimelineScenes[0];
              const zone = BeatBoard.createDropZone(0, firstScene.beatboardX - 50, firstScene.beatboardY);
              canvas.appendChild(zone);
          }
          
          // Si aucune sc√®ne in timeline, cr√©er une zone de d√©part
          if(inTimelineScenes.length === 0) {
              const zone = BeatBoard.createDropZone(0, 100, 100);
              canvas.appendChild(zone);
          }
          
          // Cr√©er une zone apr√®s chaque carte in timeline
          inTimelineScenes.forEach((scene, idx) => {
              // Ne pas cr√©er de zone autour de la carte qu'on d√©place
              if(isCurrentlyInTimeline && (idx === draggedIndex || idx === draggedIndex - 1)) return;
              
              const nextScene = inTimelineScenes[idx + 1];
              let zoneX, zoneY;
              
              if(nextScene) {
                  zoneX = (scene.beatboardX + nextScene.beatboardX + 180) / 2 - 20;
                  zoneY = (scene.beatboardY + nextScene.beatboardY) / 2;
              } else {
                  zoneX = scene.beatboardX + 200;
                  zoneY = scene.beatboardY;
              }
              
              const zone = BeatBoard.createDropZone(idx + 1, zoneX, zoneY);
              canvas.appendChild(zone);
          });
          
          // Ajouter une zone "Retirer du fil rouge" si la sc√®ne est in timeline
          if(isCurrentlyInTimeline) {
              const removeZone = document.createElement('div');
              removeZone.className = 'beatboard-dropzone beatboard-dropzone-remove';
              removeZone.dataset.action = 'remove-from-timeline';
              removeZone.style.cssText = `
                  position: absolute;
                  left: 20px;
                  top: 700px;
                  width: 200px;
                  height: 80px;
                  background: rgba(150, 150, 150, 0.3);
                  border: 3px dashed #999;
                  border-radius: 10px;
                  z-index: 500;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 0.85rem;
                  color: var(--text-sec);
                  transition: all 0.2s;
              `;
              removeZone.innerHTML = 'üìå Retirer du fil rouge';
              canvas.appendChild(removeZone);
          }
      },
      
      createDropZone: (insertIndex, x, y) => {
          const zone = document.createElement('div');
          zone.className = 'beatboard-dropzone';
          zone.dataset.insertIndex = insertIndex;
          zone.style.cssText = `
              position: absolute;
              left: ${x}px;
              top: ${y}px;
              width: 40px;
              height: 100px;
              background: rgba(231, 76, 60, 0.2);
              border: 3px dashed #e74c3c;
              border-radius: 10px;
              z-index: 500;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.5rem;
              color: #e74c3c;
              transition: all 0.2s;
          `;
          zone.innerHTML = '‚Üì';
          return zone;
      },
      
      highlightDropZone: (clientX, clientY) => {
          const container = document.getElementById('beatboardContainer');
          const rect = container.getBoundingClientRect();
          const x = (clientX - rect.left - BeatBoard.panX) / BeatBoard.zoom;
          const y = (clientY - rect.top - BeatBoard.panY) / BeatBoard.zoom;
          
          document.querySelectorAll('.beatboard-dropzone').forEach(zone => {
              const zoneX = parseFloat(zone.style.left);
              const zoneY = parseFloat(zone.style.top);
              const zoneW = parseFloat(zone.style.width) || 40;
              const zoneH = parseFloat(zone.style.height) || 100;
              const dist = Math.sqrt(Math.pow(x - zoneX - zoneW/2, 2) + Math.pow(y - zoneY - zoneH/2, 2));
              
              const isRemoveZone = zone.dataset.action === 'remove-from-timeline';
              
              if(dist < 100) {
                  if(isRemoveZone) {
                      zone.style.background = 'rgba(150, 150, 150, 0.6)';
                      zone.style.borderColor = '#666';
                  } else {
                      zone.style.background = 'rgba(231, 76, 60, 0.5)';
                  }
                  zone.style.transform = 'scale(1.1)';
                  zone.style.borderStyle = 'solid';
              } else {
                  if(isRemoveZone) {
                      zone.style.background = 'rgba(150, 150, 150, 0.3)';
                      zone.style.borderColor = '#999';
                  } else {
                      zone.style.background = 'rgba(231, 76, 60, 0.2)';
                  }
                  zone.style.transform = 'scale(1)';
                  zone.style.borderStyle = 'dashed';
              }
          });
      },
      
      getDropIndex: (clientX, clientY) => {
          const container = document.getElementById('beatboardContainer');
          const rect = container.getBoundingClientRect();
          const x = (clientX - rect.left - BeatBoard.panX) / BeatBoard.zoom;
          const y = (clientY - rect.top - BeatBoard.panY) / BeatBoard.zoom;
          
          let closestZone = null;
          let closestDist = Infinity;
          
          document.querySelectorAll('.beatboard-dropzone').forEach(zone => {
              const zoneX = parseFloat(zone.style.left);
              const zoneY = parseFloat(zone.style.top);
              const zoneW = parseFloat(zone.style.width) || 40;
              const zoneH = parseFloat(zone.style.height) || 100;
              const dist = Math.sqrt(Math.pow(x - zoneX - zoneW/2, 2) + Math.pow(y - zoneY - zoneH/2, 2));
              
              if(dist < 120 && dist < closestDist) {
                  closestDist = dist;
                  closestZone = zone;
              }
          });
          
          if(!closestZone) return { type: null };
          
          if(closestZone.dataset.action === 'remove-from-timeline') {
              return { type: 'remove' };
          }
          
          return { type: 'insert', index: parseInt(closestZone.dataset.insertIndex) };
      },
      
      hideDropZones: () => {
          document.querySelectorAll('.beatboard-dropzone').forEach(z => z.remove());
      },
      
      reorderScene: (fromIndex, toIndex, scene) => {
          // R√©cup√©rer les sc√®nes in timeline
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          const wasInTimeline = scene.inTimeline !== false;
          
          if(wasInTimeline && fromIndex !== -1) {
              // Retirer de sa position actuelle dans le tableau global
              // On doit trouver l'index global de cette sc√®ne
              const globalIndex = state.data.scenes.findIndex(s => s.id === scene.id);
              if(globalIndex !== -1) {
                  state.data.scenes.splice(globalIndex, 1);
              }
          }
          
          // Marquer comme in timeline
          scene.inTimeline = true;
          
          // Trouver o√π ins√©rer dans le tableau global
          // On veut ins√©rer apr√®s la sc√®ne qui est √† toIndex-1 dans inTimeline
          if(toIndex === 0) {
              // Ins√©rer au tout d√©but
              state.data.scenes.unshift(scene);
          } else {
              const sceneBeforeInTimeline = inTimelineScenes[toIndex - 1];
              if(sceneBeforeInTimeline) {
                  const globalIndexBefore = state.data.scenes.findIndex(s => s.id === sceneBeforeInTimeline.id);
                  state.data.scenes.splice(globalIndexBefore + 1, 0, scene);
              } else {
                  state.data.scenes.push(scene);
              }
          }
          
          BeatBoard.render();
          Utils.toast(`Sc√®ne ins√©r√©e en position ${toIndex + 1}`, 'success');
          UI.renderBoard();
      },
      
      removeFromTimeline: (scene) => {
          scene.inTimeline = false;
          // D√©placer visuellement vers la zone hors timeline
          scene.beatboardY = 800 + Math.random() * 50;
          Store.save();
          BeatBoard.render();
          UI.renderBoard();
          Utils.toast('Sc√®ne retir√©e du fil rouge', 'info');
      },
      
      checkReorder: () => {
          // R√©ordonner les sc√®nes selon leur position X puis Y
          const cards = Array.from(document.querySelectorAll('.beatboard-card'));
          if(cards.length === 0) return;
          
          const sorted = cards.map(c => ({
              id: c.dataset.id,
              x: parseFloat(c.style.left) || 0,
              y: parseFloat(c.style.top) || 0
          })).sort((a, b) => {
              const rowA = Math.floor(a.y / 140);
              const rowB = Math.floor(b.y / 140);
              if(rowA !== rowB) return rowA - rowB;
              return a.x - b.x;
          });
          
          const newOrder = sorted.map(s => s.id);
          const currentOrder = state.data.scenes.map(s => s.id);
          
          // V√©rifier si l'ordre a chang√©
          if(JSON.stringify(newOrder) !== JSON.stringify(currentOrder)) {
              // Cr√©er le nouveau tableau en s'assurant que toutes les sc√®nes existent
              const reorderedScenes = [];
              for(const id of newOrder) {
                  const scene = state.data.scenes.find(s => s.id === id);
                  if(scene) reorderedScenes.push(scene);
              }
              
              // Ne mettre √† jour que si on a toutes les sc√®nes
              if(reorderedScenes.length === state.data.scenes.length) {
                  state.data.scenes = reorderedScenes;
                  Utils.toast('Ordre mis √† jour', 'success');
                  BeatBoard.render();
                  UI.renderBoard();
              }
          }
      },
      
      drawLine: () => {
          const svg = document.getElementById('beatboardSvg');
          if(!svg) return;
          svg.innerHTML = '';
          
          const inTimelineScenes = state.data.scenes.filter(s => s.inTimeline !== false);
          
          if(!BeatBoard.showLine || inTimelineScenes.length < 2) return;
          
          const points = inTimelineScenes.map(scene => {
              const card = document.querySelector(`.beatboard-card[data-id="${scene.id}"]`);
              if(!card) return null;
              return {
                  x: parseFloat(card.style.left) + 90,
                  y: parseFloat(card.style.top) + 50
              };
          }).filter(p => p);
          
          if(points.length < 2) return;
          
          // Cr√©er le path avec courbes de B√©zier
          let pathD = `M ${points[0].x} ${points[0].y}`;
          for(let i = 1; i < points.length; i++) {
              const prev = points[i-1];
              const curr = points[i];
              const midX = (prev.x + curr.x) / 2;
              pathD += ` C ${midX} ${prev.y}, ${midX} ${curr.y}, ${curr.x} ${curr.y}`;
          }
          
          // Ligne de fond (ombre)
          const bgLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          bgLine.setAttribute('d', pathD);
          bgLine.setAttribute('class', 'beatboard-line-bg');
          svg.appendChild(bgLine);
          
          // Ligne principale
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          line.setAttribute('d', pathD);
          line.setAttribute('class', 'beatboard-line');
          svg.appendChild(line);
      },
      
      toggleLine: () => {
          BeatBoard.showLine = document.getElementById('beatboard-show-line').checked;
          BeatBoard.drawLine();
      },
      
      autoLayout: (type) => {
          const scenes = state.data.scenes;
          const cardW = 200, cardH = 140, gap = 30;
          
          if(type === 'horizontal') {
              scenes.forEach((s, i) => {
                  s.beatboardX = 50 + i * (cardW + gap);
                  s.beatboardY = 100;
              });
          } else if(type === 'grid') {
              const cols = Math.ceil(Math.sqrt(scenes.length));
              scenes.forEach((s, i) => {
                  s.beatboardX = 50 + (i % cols) * (cardW + gap);
                  s.beatboardY = 50 + Math.floor(i / cols) * (cardH + gap);
              });
          } else if(type === 'byTag') {
              const tagGroups = {};
              scenes.forEach(s => {
                  const tid = s.tag_id || 't1';
                  if(!tagGroups[tid]) tagGroups[tid] = [];
                  tagGroups[tid].push(s);
              });
              let row = 0;
              Object.keys(tagGroups).forEach(tid => {
                  tagGroups[tid].forEach((s, i) => {
                      s.beatboardX = 50 + i * (cardW + gap);
                      s.beatboardY = 50 + row * (cardH + gap + 50);
                  });
                  row++;
              });
          }
          
          Store.save();
          BeatBoard.render();
          Utils.toast('Disposition appliqu√©e', 'success');
      },
      
      renderTagList: () => {
          const container = document.getElementById('beatboard-tag-list');
          if(!container) return;
          
          const usedTags = [...new Set(state.data.scenes.map(s => s.tag_id || 't1'))];
          container.innerHTML = state.data.tags
              .filter(t => usedTags.includes(t.id))
              .map(t => `
                  <div class="beatboard-group-label">
                      <span class="beatboard-group-dot" style="background: ${t.color !== 'transparent' ? t.color : 'var(--text-sec)'}"></span>
                      ${Utils.escape(t.name)} (${state.data.scenes.filter(s => (s.tag_id || 't1') === t.id).length})
                  </div>
              `).join('');
      },
      
      initPan: () => {
          const container = document.getElementById('beatboardContainer');
          const canvas = document.getElementById('beatboardCanvas');
          if(!container || !canvas) return;
          
          container.onmousedown = (e) => {
              if(e.target.closest('.beatboard-card')) return;
              BeatBoard.isPanning = true;
              BeatBoard.panStartX = e.clientX - BeatBoard.panX;
              BeatBoard.panStartY = e.clientY - BeatBoard.panY;
              canvas.classList.add('dragging');
          };
          
          container.onmousemove = (e) => {
              if(!BeatBoard.isPanning) return;
              BeatBoard.panX = e.clientX - BeatBoard.panStartX;
              BeatBoard.panY = e.clientY - BeatBoard.panStartY;
              BeatBoard.applyTransform();
          };
          
          container.onmouseup = () => {
              BeatBoard.isPanning = false;
              canvas.classList.remove('dragging');
          };
          
          container.onmouseleave = () => {
              BeatBoard.isPanning = false;
              canvas.classList.remove('dragging');
          };
          
          container.onwheel = (e) => {
              e.preventDefault();
              const delta = e.deltaY > 0 ? -0.1 : 0.1;
              BeatBoard.zoom = Math.max(0.3, Math.min(2, BeatBoard.zoom + delta));
              BeatBoard.applyTransform();
              document.getElementById('beatboardZoomLevel').textContent = Math.round(BeatBoard.zoom * 100) + '%';
          };
      },
      
      applyTransform: () => {
          const canvas = document.getElementById('beatboardCanvas');
          if(canvas) {
              canvas.style.transform = `translate(${BeatBoard.panX}px, ${BeatBoard.panY}px) scale(${BeatBoard.zoom})`;
          }
          BeatBoard.updateMinimap();
      },
      
      zoomIn: () => {
          BeatBoard.zoom = Math.min(2, BeatBoard.zoom + 0.1);
          BeatBoard.applyTransform();
          document.getElementById('beatboardZoomLevel').textContent = Math.round(BeatBoard.zoom * 100) + '%';
      },
      
      zoomOut: () => {
          BeatBoard.zoom = Math.max(0.3, BeatBoard.zoom - 0.1);
          BeatBoard.applyTransform();
          document.getElementById('beatboardZoomLevel').textContent = Math.round(BeatBoard.zoom * 100) + '%';
      },
      
      zoomReset: () => {
          BeatBoard.zoom = 1;
          BeatBoard.panX = 0;
          BeatBoard.panY = 0;
          BeatBoard.applyTransform();
          document.getElementById('beatboardZoomLevel').textContent = '100%';
      },
      
      fitToView: () => {
          const container = document.getElementById('beatboardContainer');
          if(!container || state.data.scenes.length === 0) return;
          
          const bounds = state.data.scenes.reduce((acc, s) => ({
              minX: Math.min(acc.minX, s.beatboardX || 0),
              maxX: Math.max(acc.maxX, (s.beatboardX || 0) + 180),
              minY: Math.min(acc.minY, s.beatboardY || 0),
              maxY: Math.max(acc.maxY, (s.beatboardY || 0) + 100)
          }), { minX: Infinity, maxX: 0, minY: Infinity, maxY: 0 });
          
          const contentW = bounds.maxX - bounds.minX + 100;
          const contentH = bounds.maxY - bounds.minY + 100;
          const containerW = container.clientWidth;
          const containerH = container.clientHeight;
          
          BeatBoard.zoom = Math.min(containerW / contentW, containerH / contentH, 1);
          BeatBoard.panX = -bounds.minX * BeatBoard.zoom + 20;
          BeatBoard.panY = -bounds.minY * BeatBoard.zoom + 20;
          BeatBoard.applyTransform();
          document.getElementById('beatboardZoomLevel').textContent = Math.round(BeatBoard.zoom * 100) + '%';
      },
      
      updateMinimap: () => {
          const minimap = document.getElementById('beatboardMinimap');
          const viewport = document.getElementById('beatboardMinimapViewport');
          const container = document.getElementById('beatboardContainer');
          if(!minimap || !viewport || !container) return;
          
          const scale = 0.05;
          const containerW = container.clientWidth;
          const containerH = container.clientHeight;
          
          viewport.style.width = (containerW * scale / BeatBoard.zoom) + 'px';
          viewport.style.height = (containerH * scale / BeatBoard.zoom) + 'px';
          viewport.style.left = (-BeatBoard.panX * scale / BeatBoard.zoom) + 'px';
          viewport.style.top = (-BeatBoard.panY * scale / BeatBoard.zoom) + 'px';
      }
  };

  return { Store, UI, Actions, Breakdown, ScriptEditor, ScriptImport, ScriptExport, Auth, Stats, Exporter, Importer, MoodBoard, Storyboard, DrawingEditor, Crew, Planning, Contacts, ActorSearch, PublicProfile, GlobalSearch, Permissions, Chat, Messages, Invitations, Universe, Expenses, Utils, Presentation, PresentMode, History, Notifications, Contracts, StoryboardPreview, Comments, Courses, Help, CardModal, Synopsis, TitlePage, SceneVersions, MatchingEngine, SessionManager, Pricing, Resources, ScriptReport, Weather, ColorWheel, BeatBoard, FocusMode };
})();
</script>

<!-- Panneau Storyboard Preview -->
<div id="storyboard-preview-panel" class="storyboard-preview-panel">
    <div class="storyboard-preview-header">
        <h3>üì∑ <span id="storyboard-preview-title">Storyboard</span></h3>
        <button class="storyboard-preview-close" onclick="app.StoryboardPreview.close()">‚úï</button>
    </div>
    <div class="storyboard-preview-body" id="storyboard-preview-list">
        <div class="storyboard-preview-empty">Aucun plan pour cette sc√®ne</div>
    </div>
</div>

<!-- Panneau Commentaires -->
<div id="comments-panel" class="comments-panel">
    <div class="comments-header">
        <h3>üí¨ <span id="comments-scene-title">Commentaires</span></h3>
        <button class="comments-close" onclick="app.Comments.close()">‚úï</button>
    </div>
    <div class="comments-body" id="comments-list">
        <div class="no-comments">Aucun commentaire pour cette sc√®ne</div>
    </div>
    <div class="comments-footer">
        <textarea id="comment-input" class="comment-input" rows="3" placeholder="Ajouter un commentaire..."></textarea>
        <button class="comment-submit" onclick="app.Comments.add()">üí¨ Envoyer</button>
    </div>
</div>

<!-- Modal Page de Titre Sc√©nario -->
<div id="title-page-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:600px; background: var(--panel-bg);">
    <div class="modal-header">
      <h2>üìù Page de titre du sc√©nario</h2>
      <button onclick="app.ScriptExport.closeTitlePageModal()" class="modal-close">‚úñ</button>
    </div>
    <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
      <p style="color: var(--text-sec); margin-bottom: 20px;">Ces informations appara√Ætront sur la page de titre lors de l'export Fountain ou Final Draft.</p>
      
      <div style="display: grid; gap: 15px;">
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Titre du sc√©nario</label>
          <input type="text" id="script-meta-title" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" placeholder="Titre du film">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Auteur</label>
            <input type="text" id="script-meta-author" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" placeholder="Pr√©nom Nom">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Co-auteur (optionnel)</label>
            <input type="text" id="script-meta-coauthor" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" placeholder="Pr√©nom Nom">
          </div>
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Contact (email ou t√©l√©phone)</label>
          <input type="text" id="script-meta-contact" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" placeholder="email@exemple.com">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Version / Draft</label>
            <select id="script-meta-draft" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
              <option value="Premier jet">Premier jet</option>
              <option value="Deuxi√®me jet">Deuxi√®me jet</option>
              <option value="Troisi√®me jet">Troisi√®me jet</option>
              <option value="Version de tournage">Version de tournage</option>
              <option value="Version finale">Version finale</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Date</label>
            <input type="date" id="script-meta-date" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);">
          </div>
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Bas√© sur (optionnel)</label>
          <input type="text" id="script-meta-source" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" placeholder="Ex: le roman de Victor Hugo">
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Copyright (optionnel)</label>
          <input type="text" id="script-meta-copyright" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main);" placeholder="¬© 2026 Nom ou Soci√©t√©">
        </div>
        
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes (optionnel)</label>
          <textarea id="script-meta-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--input-bg); color: var(--text-main); resize: vertical;" placeholder="Notes suppl√©mentaires..."></textarea>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border);">
        <button onclick="app.ScriptExport.closeTitlePageModal()" style="padding: 10px 20px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">Annuler</button>
        <button onclick="app.ScriptExport.saveTitlePage()" style="padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üíæ Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal √©dition fiche compacte -->
<div id="card-edit-modal" class="card-edit-modal">
    <div class="card-edit-modal-content">
        <div class="card-edit-modal-header">
            <h3 id="card-edit-modal-title">üìù √âditer</h3>
            <button class="card-edit-modal-close" onclick="app.CardModal.close()">‚úï</button>
        </div>
        <div class="card-edit-modal-body" id="card-edit-modal-body">
            <!-- Contenu dynamique -->
        </div>
        <div class="card-edit-modal-footer">
            <button onclick="app.CardModal.close()" style="padding: 10px 20px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">Fermer</button>
        </div>
    </div>
</div>

<!-- Modal Guide / Aide -->
<div id="help-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:900px; height:85vh; display:flex; flex-direction:column;">
    <div class="modal-header">
      <h2>‚ùì Guide - Moteur</h2>
      <button onclick="app.Help.close()" class="modal-close">‚úñ</button>
    </div>
    <div style="display:flex; flex:1; overflow:hidden;">
      <!-- Sidebar cat√©gories -->
      <div id="help-sidebar" style="width:220px; background:var(--bg); border-right:1px solid var(--border); padding:15px; overflow-y:auto;">
        <div class="help-category active" onclick="app.Help.showSection('intro')">üè† Introduction</div>
        <div class="help-category" onclick="app.Help.showSection('dashboard')">üìä Dashboard</div>
        <div class="help-category" onclick="app.Help.showSection('scenario')">üìù Sc√©nario</div>
        <div class="help-category" onclick="app.Help.showSection('focusmode')">üñ•Ô∏è Mode Focus</div>
        <div class="help-category" onclick="app.Help.showSection('synopsis')">üìù Synopsis</div>
        <div class="help-category" onclick="app.Help.showSection('sequencier')">üé¨ S√©quencier</div>
        <div class="help-category" onclick="app.Help.showSection('titlepage')">üéûÔ∏è Page de Titre</div>
        <div class="help-category" onclick="app.Help.showSection('moodboard')">üé® Mood Board</div>
        <div class="help-category" onclick="app.Help.showSection('breakdown')">üìã D√©pouillement</div>
        <div class="help-category" onclick="app.Help.showSection('storyboard')">üé® Storyboard</div>
        <div class="help-category" onclick="app.Help.showSection('resources')">üì¶ Ressources</div>
        <div class="help-category" onclick="app.Help.showSection('planning')">üìÖ Planning</div>
        <div class="help-category" onclick="app.Help.showSection('depenses')">üí∞ D√©penses</div>
        <div class="help-category" onclick="app.Help.showSection('equipe')">üë• √âquipe</div>
        <div class="help-category" onclick="app.Help.showSection('univers')">üåç Univers</div>
        <div class="help-category" onclick="app.Help.showSection('contacts')">üìá Contacts</div>
        <div class="help-category" onclick="app.Help.showSection('profil')">üë§ Mon Profil</div>
        <div class="help-category" onclick="app.Help.showSection('collaboration')">ü§ù Collaboration</div>
        <div class="help-category" onclick="app.Help.showSection('chat')">üí¨ Chat</div>
        <div class="help-category" onclick="app.Help.showSection('scriptreport')">üìù Rapport de Script</div>
        <div class="help-category" onclick="app.Help.showSection('export')">üìÑ Exports</div>
        <div class="help-category" onclick="app.Help.showSection('raccourcis')">‚å®Ô∏è Raccourcis</div>
        <div class="help-category" onclick="app.Help.showSection('interface')">üìê Interface</div>
      </div>
      <!-- Contenu -->
      <div id="help-content" style="flex:1; padding:25px; overflow-y:auto; background:var(--panel-bg);">
        <!-- Contenu dynamique -->
      </div>
    </div>
  </div>
</div>

</body>
</html>